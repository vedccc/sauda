VERSION 5.00
Object = "{C4847593-972C-11D0-9567-00A0C9273C2A}#8.0#0"; "crviewer.dll"
Object = "{F0D2F211-CCB0-11D0-A316-00AA00688B10}#1.0#0"; "MSDATLST.OCX"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.2#0"; "mscomctl.ocx"
Object = "{0102BD99-4A7D-11D3-AC0E-00C026A22F30}#5.1#0"; "DATECTL.OCX"
Begin VB.Form NRPTCONA 
   BackColor       =   &H00C0C0C0&
   ClientHeight    =   10215
   ClientLeft      =   -5520
   ClientTop       =   570
   ClientWidth     =   11100
   KeyPreview      =   -1  'True
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   MDIChild        =   -1  'True
   ScaleHeight     =   10215
   ScaleWidth      =   11100
   Visible         =   0   'False
   Begin VB.TextBox unqucc 
      Height          =   375
      Left            =   1440
      TabIndex        =   96
      Top             =   2040
      Visible         =   0   'False
      Width           =   1575
   End
   Begin VB.Frame Frame10 
      BackColor       =   &H00FF8080&
      BorderStyle     =   0  'None
      Caption         =   "Frame10"
      Height          =   855
      Left            =   7485
      TabIndex        =   74
      Top             =   1680
      Visible         =   0   'False
      Width           =   15015
      Begin VB.CommandButton Command1 
         Caption         =   "Show Trades"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   7320
         TabIndex        =   78
         Top             =   120
         Width           =   1335
      End
      Begin VB.CommandButton Command2 
         Caption         =   "Cancel"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   13800
         TabIndex        =   77
         Top             =   120
         Width           =   1095
      End
      Begin VB.CommandButton Command3 
         Caption         =   "Save"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   12600
         TabIndex        =   76
         Top             =   120
         Width           =   1095
      End
      Begin VB.CheckBox Check6 
         BackColor       =   &H00FF80FF&
         Caption         =   "Update Brokerage and Bills"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   9480
         TabIndex        =   75
         Top             =   120
         Visible         =   0   'False
         Width           =   2895
      End
      Begin MSDataListLib.DataCombo DataCombo1 
         Height          =   390
         Left            =   1200
         TabIndex        =   79
         Top             =   120
         Width           =   2535
         _ExtentX        =   4471
         _ExtentY        =   688
         _Version        =   393216
         Text            =   ""
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin MSDataListLib.DataCombo DataCombo2 
         Height          =   390
         Left            =   4680
         TabIndex        =   80
         Top             =   120
         Width           =   2535
         _ExtentX        =   4471
         _ExtentY        =   688
         _Version        =   393216
         Text            =   ""
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin VB.Label Label6 
         BackStyle       =   0  'Transparent
         Caption         =   "From Party"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   120
         TabIndex        =   82
         Top             =   195
         Width           =   1095
      End
      Begin VB.Label Label7 
         BackStyle       =   0  'Transparent
         Caption         =   "To Party"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   3840
         TabIndex        =   81
         Top             =   195
         Width           =   855
      End
   End
   Begin VB.Frame ContFram 
      BackColor       =   &H00FF8080&
      BorderStyle     =   0  'None
      Caption         =   "Buy Contracts"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   6855
      Left            =   120
      TabIndex        =   50
      Top             =   3360
      Visible         =   0   'False
      Width           =   15555
      Begin VB.CheckBox Check7 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Select All"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   120
         TabIndex        =   69
         Top             =   5760
         Width           =   1335
      End
      Begin VB.CheckBox Check8 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Select All"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   7920
         TabIndex        =   68
         Top             =   5760
         Width           =   1455
      End
      Begin VB.Frame Frame11 
         BackColor       =   &H00FFC0C0&
         BorderStyle     =   0  'None
         Caption         =   "Frame5"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   615
         Left            =   120
         TabIndex        =   51
         Top             =   6120
         Width           =   15255
         Begin VB.TextBox Text7 
            Alignment       =   1  'Right Justify
            BackColor       =   &H00C0E0FF&
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   9840
            Locked          =   -1  'True
            TabIndex        =   59
            Text            =   " "
            Top             =   120
            Width           =   1440
         End
         Begin VB.TextBox Text8 
            Alignment       =   1  'Right Justify
            BackColor       =   &H00C0E0FF&
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   8100
            Locked          =   -1  'True
            TabIndex        =   58
            Text            =   " "
            Top             =   120
            Width           =   1020
         End
         Begin VB.TextBox Text9 
            Alignment       =   1  'Right Justify
            BackColor       =   &H00C0E0FF&
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   6120
            Locked          =   -1  'True
            TabIndex        =   57
            Text            =   " "
            Top             =   120
            Width           =   1020
         End
         Begin VB.TextBox Text10 
            Alignment       =   1  'Right Justify
            BackColor       =   &H00FFFFC0&
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   4200
            Locked          =   -1  'True
            TabIndex        =   56
            Text            =   " "
            Top             =   120
            Width           =   1440
         End
         Begin VB.TextBox Text11 
            Alignment       =   1  'Right Justify
            BackColor       =   &H00FFFFC0&
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   2505
            Locked          =   -1  'True
            TabIndex        =   55
            Text            =   " "
            Top             =   120
            Width           =   1020
         End
         Begin VB.TextBox Text12 
            Alignment       =   1  'Right Justify
            BackColor       =   &H00FFFFC0&
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   570
            Locked          =   -1  'True
            TabIndex        =   54
            Text            =   " "
            Top             =   120
            Width           =   900
         End
         Begin VB.TextBox Text6 
            Alignment       =   1  'Right Justify
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   12120
            Locked          =   -1  'True
            TabIndex        =   53
            Text            =   " "
            Top             =   120
            Width           =   1020
         End
         Begin VB.TextBox Text4 
            Alignment       =   1  'Right Justify
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   13560
            Locked          =   -1  'True
            TabIndex        =   52
            Text            =   " "
            Top             =   120
            Width           =   1560
         End
         Begin VB.Label Label13 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Avg.Rate"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   7200
            TabIndex        =   67
            Top             =   180
            Width           =   855
         End
         Begin VB.Label Label12 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   9240
            TabIndex        =   66
            Top             =   180
            Width           =   450
         End
         Begin VB.Label Label11 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Qty."
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   5760
            TabIndex        =   65
            Top             =   180
            Width           =   390
         End
         Begin VB.Label Label10 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Avg.Rate"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   1560
            TabIndex        =   64
            Top             =   180
            Width           =   855
         End
         Begin VB.Label Label9 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   3600
            TabIndex        =   63
            Top             =   180
            Width           =   450
         End
         Begin VB.Label Label8 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Qty."
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   120
            TabIndex        =   62
            Top             =   180
            Width           =   390
         End
         Begin VB.Label Label20 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Qty.Diff."
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00C00000&
            Height          =   255
            Left            =   11280
            TabIndex        =   61
            Top             =   180
            Width           =   810
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Diff"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00C00000&
            Height          =   255
            Left            =   13200
            TabIndex        =   60
            Top             =   180
            Width           =   360
         End
      End
      Begin MSComctlLib.ListView ContBFram 
         Height          =   5175
         Left            =   240
         TabIndex        =   70
         Top             =   600
         Width           =   7455
         _ExtentX        =   13150
         _ExtentY        =   9128
         View            =   3
         LabelEdit       =   1
         LabelWrap       =   0   'False
         HideSelection   =   0   'False
         Checkboxes      =   -1  'True
         FullRowSelect   =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483643
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   7
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "Contract"
            Object.Width           =   2540
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "Date"
            Object.Width           =   2188
         EndProperty
         BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   2
            Text            =   "Qty."
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(4) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   3
            Text            =   "Rate"
            Object.Width           =   2293
         EndProperty
         BeginProperty ColumnHeader(5) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   4
            Text            =   "Sauda"
            Object.Width           =   5292
         EndProperty
         BeginProperty ColumnHeader(6) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   5
            Text            =   "Calval"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(7) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   6
            Text            =   "ConCode"
            Object.Width           =   2540
         EndProperty
      End
      Begin MSComctlLib.ListView ContSFram 
         Height          =   5175
         Left            =   7920
         TabIndex        =   71
         Top             =   600
         Width           =   7455
         _ExtentX        =   13150
         _ExtentY        =   9128
         View            =   3
         LabelEdit       =   1
         LabelWrap       =   0   'False
         HideSelection   =   0   'False
         Checkboxes      =   -1  'True
         FullRowSelect   =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483643
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   7
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "Contract"
            Object.Width           =   1834
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "Date"
            Object.Width           =   2188
         EndProperty
         BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   2
            Text            =   "Qty."
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(4) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   3
            Text            =   "Rate"
            Object.Width           =   2293
         EndProperty
         BeginProperty ColumnHeader(5) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   4
            Text            =   "Sauda"
            Object.Width           =   5292
         EndProperty
         BeginProperty ColumnHeader(6) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   5
            Text            =   "Calval"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(7) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   6
            Text            =   "ConCode"
            Object.Width           =   2540
         EndProperty
      End
      Begin VB.Label Label15 
         Alignment       =   2  'Center
         AutoSize        =   -1  'True
         BackColor       =   &H00FFFFC0&
         Caption         =   "Buy Trade"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   14.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   240
         TabIndex        =   73
         Top             =   120
         Width           =   7455
      End
      Begin VB.Label Label14 
         Alignment       =   2  'Center
         AutoSize        =   -1  'True
         BackColor       =   &H00FFFFC0&
         Caption         =   "Sell Trade"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   14.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   7980
         TabIndex        =   72
         Top             =   120
         Width           =   7380
      End
   End
   Begin VB.Frame Frame5 
      BackColor       =   &H00FFC0C0&
      BorderStyle     =   0  'None
      Caption         =   "Frame5"
      Height          =   6855
      Left            =   0
      TabIndex        =   35
      Top             =   2640
      Width           =   15495
      Begin VB.CheckBox ChkTelegram 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Send Telegram"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   4200
         TabIndex        =   94
         Top             =   120
         Visible         =   0   'False
         Width           =   1575
      End
      Begin VB.TextBox TxtReport 
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   405
         Left            =   120
         TabIndex        =   93
         Top             =   120
         Width           =   3975
      End
      Begin VB.CommandButton FilterCmd 
         Caption         =   "Filter"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   495
         Left            =   12480
         TabIndex        =   89
         Top             =   120
         Visible         =   0   'False
         Width           =   1095
      End
      Begin MSDataListLib.DataCombo ItemCombo 
         Height          =   420
         Left            =   9840
         TabIndex        =   88
         Top             =   120
         Visible         =   0   'False
         Width           =   2535
         _ExtentX        =   4471
         _ExtentY        =   741
         _Version        =   393216
         Text            =   ""
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin VB.CheckBox BrokerChk 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Select All"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   13680
         TabIndex        =   49
         Top             =   0
         Visible         =   0   'False
         Width           =   1215
      End
      Begin VB.CheckBox SaudaChk 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Select All"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   13680
         TabIndex        =   41
         Top             =   240
         Width           =   1215
      End
      Begin VB.CheckBox PartyChk 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Select All"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   13680
         TabIndex        =   39
         Top             =   0
         Width           =   1215
      End
      Begin VB.CheckBox FmlyChk 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Select All"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   13680
         TabIndex        =   38
         Top             =   240
         Width           =   1215
      End
      Begin MSComctlLib.ListView FmlyList 
         Height          =   5655
         Left            =   240
         TabIndex        =   40
         Top             =   720
         Visible         =   0   'False
         Width           =   14775
         _ExtentX        =   26061
         _ExtentY        =   9975
         View            =   3
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         Checkboxes      =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483643
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   3
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "BrCode"
            Object.Width           =   2540
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "BranchName"
            Object.Width           =   10583
         EndProperty
         BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   2
            Text            =   "FmlyCodes"
            Object.Width           =   0
         EndProperty
      End
      Begin MSComctlLib.ListView ExList 
         Height          =   5415
         Left            =   240
         TabIndex        =   25
         Top             =   720
         Visible         =   0   'False
         Width           =   14775
         _ExtentX        =   26061
         _ExtentY        =   9551
         View            =   3
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         Checkboxes      =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483643
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   3
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "ExcCode"
            Object.Width           =   2540
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "Name"
            Object.Width           =   10583
         EndProperty
         BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   2
            Text            =   "ExID"
            Object.Width           =   1411
         EndProperty
      End
      Begin VB.CheckBox ExChk 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Select All"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   13680
         TabIndex        =   24
         Top             =   240
         Width           =   1215
      End
      Begin MSComctlLib.ListView PartyList 
         Height          =   5535
         Left            =   240
         TabIndex        =   42
         ToolTipText     =   "Press : F2 to select all, F3 to unselect, F4 to select members, F5 to select non members."
         Top             =   720
         Visible         =   0   'False
         Width           =   14775
         _ExtentX        =   26061
         _ExtentY        =   9763
         View            =   3
         MultiSelect     =   -1  'True
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         Checkboxes      =   -1  'True
         FullRowSelect   =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         ForeColor       =   4194304
         BackColor       =   16777215
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   8
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "Parties"
            Object.Width           =   7673
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "Code"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   2
            Text            =   "PartyType"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(4) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   3
            Text            =   "Op_Bal"
            Object.Width           =   3528
         EndProperty
         BeginProperty ColumnHeader(5) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   4
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(6) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   5
            Text            =   "OpBal"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(7) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   6
            Text            =   "FmlyId"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(8) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   7
            Text            =   "SRVTAXAPP"
            Object.Width           =   0
         EndProperty
      End
      Begin MSComctlLib.ListView SaudaList 
         Height          =   5655
         Left            =   240
         TabIndex        =   44
         ToolTipText     =   "Press : F2 to select all, F3 to unselect, F4 to select item specific."
         Top             =   720
         Visible         =   0   'False
         Width           =   14775
         _ExtentX        =   26061
         _ExtentY        =   9975
         View            =   3
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         Checkboxes      =   -1  'True
         FullRowSelect   =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         ForeColor       =   4194304
         BackColor       =   16777215
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   8
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "Code"
            Object.Width           =   6174
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "Name"
            Object.Width           =   6722
         EndProperty
         BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   2
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(4) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   3
            Text            =   "Lot"
            Object.Width           =   1411
         EndProperty
         BeginProperty ColumnHeader(5) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   4
            Text            =   "ExCode"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(6) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   5
            Text            =   "InstType"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(7) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   6
            Text            =   "StrikePrice"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(8) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   7
            Text            =   "Maturity"
            Object.Width           =   2540
         EndProperty
      End
      Begin MSComctlLib.ListView BrokerLst 
         Height          =   5655
         Left            =   240
         TabIndex        =   48
         ToolTipText     =   "Press : F2 to select all, F3 to unselect, F4 to select members, F5 to select non members."
         Top             =   720
         Visible         =   0   'False
         Width           =   14775
         _ExtentX        =   26061
         _ExtentY        =   9975
         View            =   3
         MultiSelect     =   -1  'True
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         Checkboxes      =   -1  'True
         FullRowSelect   =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         ForeColor       =   4194304
         BackColor       =   16777215
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   8
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "Parties"
            Object.Width           =   7673
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "Code"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   2
            Text            =   "PartyType"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(4) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            SubItemIndex    =   3
            Text            =   "Op_Bal"
            Object.Width           =   3528
         EndProperty
         BeginProperty ColumnHeader(5) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   4
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(6) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   5
            Text            =   "OpBal"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(7) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   6
            Text            =   "FmlyId"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(8) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   7
            Text            =   "SRVTAXAPP"
            Object.Width           =   0
         EndProperty
      End
      Begin vcDateTimePicker.vcDTP vcDTP3 
         Height          =   375
         Left            =   5760
         TabIndex        =   86
         Top             =   120
         Visible         =   0   'False
         Width           =   1500
         _ExtentX        =   2646
         _ExtentY        =   661
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Value           =   42079.7973611111
      End
      Begin vcDateTimePicker.vcDTP vcDTP4 
         Height          =   375
         Left            =   7680
         TabIndex        =   87
         Top             =   120
         Visible         =   0   'False
         Width           =   1500
         _ExtentX        =   2646
         _ExtentY        =   661
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Value           =   42079.7973611111
      End
      Begin VB.Label Label17 
         BackStyle       =   0  'Transparent
         Caption         =   "Item"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   9360
         TabIndex        =   92
         Top             =   210
         Visible         =   0   'False
         Width           =   375
      End
      Begin VB.Label Label16 
         BackStyle       =   0  'Transparent
         Caption         =   "To"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   7320
         TabIndex        =   91
         Top             =   180
         Visible         =   0   'False
         Width           =   375
      End
      Begin VB.Label Label2 
         BackStyle       =   0  'Transparent
         Caption         =   "Maturity From"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   4200
         TabIndex        =   90
         Top             =   180
         Visible         =   0   'False
         Width           =   1335
      End
      Begin VB.Label Label5 
         Alignment       =   2  'Center
         BackColor       =   &H00FFFFC0&
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   14.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   240
         TabIndex        =   37
         Top             =   120
         Width           =   3855
      End
   End
   Begin VB.Frame Frame3 
      BackColor       =   &H00FFFFC0&
      BorderStyle     =   0  'None
      Height          =   495
      Left            =   15480
      TabIndex        =   30
      Top             =   360
      Visible         =   0   'False
      Width           =   3855
      Begin VB.CheckBox Check2 
         BackColor       =   &H00C0FFFF&
         Caption         =   "Without Op. Bal"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   1800
         TabIndex        =   32
         Top             =   120
         Visible         =   0   'False
         Width           =   1935
      End
      Begin VB.CheckBox Check1 
         BackColor       =   &H00C0FFFF&
         Caption         =   "With Op. Bal"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   120
         TabIndex        =   31
         Top             =   120
         Visible         =   0   'False
         Width           =   1575
      End
   End
   Begin VB.Frame Frame2 
      BackColor       =   &H00C0E0FF&
      BorderStyle     =   0  'None
      Caption         =   "Frame2"
      Height          =   1575
      Left            =   0
      TabIndex        =   27
      Top             =   960
      Width           =   15495
      Begin VB.CheckBox Check13 
         BackColor       =   &H00FFC0C0&
         Caption         =   "With Inr"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   540
         Left            =   4080
         TabIndex        =   98
         Top             =   600
         Visible         =   0   'False
         Width           =   975
      End
      Begin VB.CheckBox Check11 
         BackColor       =   &H00FFC0C0&
         Caption         =   "Interest"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   420
         Left            =   9960
         TabIndex        =   95
         Top             =   1080
         Visible         =   0   'False
         Width           =   1095
      End
      Begin VB.CheckBox Check10 
         BackColor       =   &H00FFC0C0&
         Caption         =   "Show Trade Conf"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   420
         Left            =   6585
         TabIndex        =   84
         Top             =   1080
         Visible         =   0   'False
         Width           =   1695
      End
      Begin VB.CheckBox Check9 
         BackColor       =   &H00FFC0C0&
         Caption         =   "With Summary"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   420
         Left            =   1590
         TabIndex        =   83
         Top             =   1080
         Visible         =   0   'False
         Width           =   1575
      End
      Begin VB.CommandButton BrokerCmd 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Broker"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   9120
         Style           =   1  'Graphical
         TabIndex        =   6
         Top             =   600
         Visible         =   0   'False
         Width           =   1215
      End
      Begin VB.CheckBox CreateChk 
         BackColor       =   &H00FFC0C0&
         Caption         =   "Create PDF"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   420
         Left            =   120
         TabIndex        =   17
         Top             =   1080
         Visible         =   0   'False
         Width           =   1335
      End
      Begin VB.CheckBox Check5 
         BackColor       =   &H00FFC0C0&
         Caption         =   "With Standing"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   420
         Left            =   3300
         TabIndex        =   18
         Top             =   1080
         Visible         =   0   'False
         Width           =   1575
      End
      Begin VB.CheckBox Check4 
         BackColor       =   &H00FFC0C0&
         Caption         =   "With Sharing"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   420
         Left            =   8415
         TabIndex        =   47
         Top             =   1080
         Visible         =   0   'False
         Width           =   1455
      End
      Begin VB.CheckBox CshMTMchk 
         BackColor       =   &H00FFC0C0&
         Caption         =   "Show Cash MTM"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   420
         Left            =   11685
         TabIndex        =   20
         Top             =   1080
         Visible         =   0   'False
         Width           =   1815
      End
      Begin VB.CheckBox OptMTMChk 
         BackColor       =   &H00FFC0C0&
         Caption         =   "Show Opt MTM "
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   420
         Left            =   13635
         TabIndex        =   19
         Top             =   1080
         Visible         =   0   'False
         Width           =   1695
      End
      Begin VB.ComboBox Combo2 
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         ItemData        =   "NRPTCONA.frx":0000
         Left            =   2160
         List            =   "NRPTCONA.frx":0002
         TabIndex        =   11
         Top             =   600
         Visible         =   0   'False
         Width           =   1815
      End
      Begin VB.CheckBox Check3 
         BackColor       =   &H00FFC0C0&
         Caption         =   "With Sharing"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   420
         Left            =   4995
         TabIndex        =   21
         Top             =   1080
         Visible         =   0   'False
         Width           =   1455
      End
      Begin VB.ComboBox Combo1 
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   11.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         ItemData        =   "NRPTCONA.frx":0004
         Left            =   45
         List            =   "NRPTCONA.frx":000E
         TabIndex        =   10
         Top             =   600
         Visible         =   0   'False
         Width           =   1935
      End
      Begin VB.Frame Frame9 
         BackColor       =   &H00FFFFC0&
         BorderStyle     =   0  'None
         Caption         =   "Frame7"
         Height          =   495
         Left            =   5160
         TabIndex        =   46
         Top             =   600
         Visible         =   0   'False
         Width           =   5295
         Begin VB.OptionButton Option5 
            BackColor       =   &H00FFFFC0&
            Caption         =   "All"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   3600
            TabIndex        =   14
            Top             =   80
            Width           =   1675
         End
         Begin VB.OptionButton Option4 
            BackColor       =   &H00FFFFC0&
            Caption         =   "Confirmed"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   120
            TabIndex        =   12
            Top             =   80
            Value           =   -1  'True
            Width           =   1560
         End
         Begin VB.OptionButton Option3 
            BackColor       =   &H00FFFFC0&
            Caption         =   "UnConfirmed"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   1740
            TabIndex        =   13
            Top             =   80
            Width           =   1800
         End
      End
      Begin VB.Frame Frame7 
         BackColor       =   &H00FFFFC0&
         BorderStyle     =   0  'None
         Caption         =   "Frame7"
         Height          =   495
         Left            =   10560
         TabIndex        =   45
         Top             =   600
         Visible         =   0   'False
         Width           =   4695
         Begin VB.OptionButton Option6 
            BackColor       =   &H00FFFFC0&
            Caption         =   "Net Rate"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   3600
            TabIndex        =   85
            Top             =   120
            Value           =   -1  'True
            Visible         =   0   'False
            Width           =   1155
         End
         Begin VB.OptionButton Option2 
            BackColor       =   &H00FFFFC0&
            Caption         =   "Contract Wise"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   1680
            TabIndex        =   16
            Top             =   120
            Width           =   1750
         End
         Begin VB.OptionButton Option1 
            BackColor       =   &H00FFFF80&
            Caption         =   "DateWise"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   120
            TabIndex        =   15
            Top             =   120
            Width           =   1750
         End
      End
      Begin VB.Frame Frame6 
         BackColor       =   &H00FFC0C0&
         BorderStyle     =   0  'None
         Caption         =   "Frame6"
         Height          =   495
         Left            =   9720
         TabIndex        =   36
         Top             =   120
         Width           =   3615
         Begin VB.CheckBox Check12 
            BackColor       =   &H00FFC0C0&
            Caption         =   "CF"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   225
            Left            =   3000
            TabIndex        =   97
            Top             =   120
            Visible         =   0   'False
            Width           =   615
         End
         Begin VB.CheckBox ChkCsh 
            BackColor       =   &H00FFC0C0&
            Caption         =   "Cash"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   2040
            TabIndex        =   9
            Top             =   80
            Width           =   975
         End
         Begin VB.CheckBox ChkOpt 
            BackColor       =   &H00FFC0C0&
            Caption         =   "Option"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   1080
            TabIndex        =   8
            Top             =   80
            Width           =   975
         End
         Begin VB.CheckBox ChkFut 
            BackColor       =   &H00FFC0C0&
            Caption         =   "Future"
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   120
            TabIndex        =   7
            Top             =   80
            Value           =   1  'Checked
            Width           =   975
         End
      End
      Begin VB.CommandButton CancelCmd 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Cancel"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   14400
         Style           =   1  'Graphical
         TabIndex        =   23
         Top             =   120
         Width           =   855
      End
      Begin VB.CommandButton OkCmd 
         BackColor       =   &H00FFFFC0&
         Caption         =   "&Ok"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   13440
         Style           =   1  'Graphical
         TabIndex        =   22
         Top             =   120
         Width           =   855
      End
      Begin VB.CommandButton FmlyCmd 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Branch"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   5520
         Style           =   1  'Graphical
         TabIndex        =   3
         Top             =   120
         Width           =   1215
      End
      Begin VB.CommandButton SaudaCmd 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Contracts"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   8400
         Style           =   1  'Graphical
         TabIndex        =   5
         Top             =   120
         Width           =   1215
      End
      Begin VB.CommandButton PartyCmd 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Parties"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   6960
         Style           =   1  'Graphical
         TabIndex        =   4
         Top             =   120
         Width           =   1215
      End
      Begin VB.CommandButton ExCmd 
         BackColor       =   &H00FFFFC0&
         Caption         =   "Exchange"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   4080
         Style           =   1  'Graphical
         TabIndex        =   2
         Top             =   120
         Width           =   1215
      End
      Begin vcDateTimePicker.vcDTP vcDTP1 
         Height          =   375
         Left            =   600
         TabIndex        =   0
         Top             =   120
         Width           =   1500
         _ExtentX        =   2646
         _ExtentY        =   661
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Value           =   42079.7973611111
      End
      Begin vcDateTimePicker.vcDTP vcDTP2 
         Height          =   375
         Left            =   2520
         TabIndex        =   1
         Top             =   120
         Width           =   1500
         _ExtentX        =   2646
         _ExtentY        =   661
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Value           =   42079.7973611111
      End
      Begin VB.Label Label3 
         BackColor       =   &H00C0E0FF&
         Caption         =   "To"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   2160
         TabIndex        =   29
         Top             =   180
         Width           =   255
      End
      Begin VB.Label Label1 
         BackColor       =   &H00C0E0FF&
         Caption         =   "From"
         BeginProperty Font 
            Name            =   "Times New Roman"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   0
         TabIndex        =   28
         Top             =   180
         Width           =   615
      End
   End
   Begin VB.Frame Frame1 
      BackColor       =   &H00FFFFC0&
      BorderStyle     =   0  'None
      Height          =   855
      Left            =   0
      TabIndex        =   26
      Top             =   0
      Width           =   15495
      Begin VB.Frame Frame4 
         BackColor       =   &H00FFFFC0&
         BorderStyle     =   0  'None
         Height          =   855
         Left            =   0
         TabIndex        =   33
         Top             =   0
         Width           =   15495
         Begin VB.Label Label4 
            Alignment       =   2  'Center
            BackColor       =   &H00FFC0C0&
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   20.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00400000&
            Height          =   615
            Left            =   120
            TabIndex        =   34
            Top             =   120
            Width           =   15255
         End
      End
   End
   Begin CRVIEWERLibCtl.CRViewer CRViewer1 
      Height          =   6135
      Left            =   15360
      TabIndex        =   43
      Top             =   3480
      Visible         =   0   'False
      Width           =   11055
      DisplayGroupTree=   -1  'True
      DisplayToolbar  =   -1  'True
      EnableGroupTree =   -1  'True
      EnableNavigationControls=   -1  'True
      EnableStopButton=   -1  'True
      EnablePrintButton=   -1  'True
      EnableZoomControl=   -1  'True
      EnableCloseButton=   -1  'True
      EnableProgressControl=   -1  'True
      EnableSearchControl=   -1  'True
      EnableRefreshButton=   -1  'True
      EnableDrillDown =   -1  'True
      EnableAnimationControl=   -1  'True
      EnableSelectExpertButton=   -1  'True
      EnableToolbar   =   -1  'True
      DisplayBorder   =   -1  'True
      DisplayTabs     =   -1  'True
      DisplayBackgroundEdge=   -1  'True
      SelectionFormula=   ""
      EnablePopupMenu =   -1  'True
      EnableExportButton=   -1  'True
      EnableSearchExpertButton=   -1  'True
      EnableHelpButton=   -1  'True
   End
   Begin VB.Line Line1 
      BorderColor     =   &H00400000&
      BorderWidth     =   5
      X1              =   0
      X2              =   15480
      Y1              =   960
      Y2              =   960
   End
End
Attribute VB_Name = "NRPTCONA"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Dim ExRec As ADODB.Recordset:       Dim FmlyRec As ADODB.Recordset:     Dim PartyRec As ADODB.Recordset:    Dim AccRecSet As ADODB.Recordset:
Dim AccRec As ADODB.Recordset:      Dim RecRpt As ADODB.Recordset:      Dim Rec_ExMast As ADODB.Recordset:  Dim LSPartyRec As ADODB.Recordset:  Dim LFSaudaRec As ADODB.Recordset
Dim AllExcodes As Boolean:          Dim AllFmly As Boolean:             Dim AllParties As Boolean:          Dim AllSaudas As Boolean
Dim AllBrokers As Boolean:          Dim AllInst As Boolean:             Public Fb_Press As Byte:            Dim LSInst As String
Dim LSExCodes As String:            Dim LSFmlyIDs As String:          Dim LSParties As String:            Dim LSSaudas As String:
Dim LSBrokers As String:            Dim LFromParty As String:           Dim LToParty As String:             Dim RptAccSmr As ADODB.Recordset
Dim LCURR  As String:               Dim LCurrCRate As Double:           Dim LCurrDRate As Double:           Dim LClientCode As String:
Dim GFBroktype As String:           Dim FilterChk As Boolean:           Dim LExIDS  As String:              Dim LSaudaIDS As String
Dim LCurrFRate As Double:
Dim A As Integer:                   Const LCTTDate As Date = "01/07/2013": Dim CFlag As Boolean
Dim LGBrokRate As String
Dim LGBrokName  As String: Dim CF_BALANCE As Double

Private Sub BrokerCmd_Click()
LSExCodes = Get_ExCodes:    LSFmlyIDs = Get_FmlyCodes:     LSParties = Get_Parties:    LSSaudas = Get_Saudas
If BrokerLst.Visible = True Then
    LSBrokers = Get_Brokers:         BrokerLst.Visible = False
    BrokerChk.Visible = False:       Label5.Caption = vbNullString:    OkCmd.SetFocus
Else
    If ExList.Visible = True Then Call ExCmd_Click
    If FmlyList.Visible = True Then Call FmlyCmd_Click
    If PartyList.Visible = True Then Call PartyCmd_Click
    If SaudaList.Visible = True Then Call SaudaCmd_Click
    
    Label5.Caption = "Please Select Brokers"
    BrokerChk.Visible = True:    BrokerLst.Visible = True:    BrokerChk.SetFocus
End If
End Sub
Private Sub BrokerLst_Click()
AllBrokers = False
End Sub

Private Sub Command1_Click()
vcDTP1.Enabled = False:         vcDTP2.Enabled = False:         PartyCmd.Enabled = False
ExCmd.Enabled = False:          FmlyCmd.Enabled = False:        SaudaCmd.Enabled = False
Frame6.Enabled = False:         OkCmd.Enabled = False:          CancelCmd.Enabled = False

If MFormat = "Sauda Transfer DD" Then 'date to date
        Call ContList
        ContFram.Visible = True
Else
    If LenB(LFromParty) <> 0 Then
        If LenB(LToParty) <> 0 Then
            Call ContList
            ContFram.Visible = True
        Else
            MsgBox "Please Select To Party"
            DataCombo2.SetFocus
        End If
    Else
        MsgBox "Please Select From Party"
        DataCombo1.SetFocus
    End If
End If
End Sub

Private Sub Command2_Click()
    vcDTP1.Enabled = True: vcDTP2.Enabled = True
    DataCombo1.Enabled = True: DataCombo2.Enabled = True
    ContBFram.ListItems.Clear: ContSFram.ListItems.Clear
    Check7.Value = 0: Check8.Value = 0
    vcDTP1.SetFocus
End Sub

Private Sub Command3_Click()
Call SaudaTrf
Call Command1_Click
End Sub
Private Sub ContBFram_Click()
    Call GetTotQty("B")
End Sub
Private Sub ContBFram_KeyPress(KeyAscii As Integer)
If KeyAscii = 32 Then Call GetTotQty("B")
End Sub
Private Sub ContSFram_Click()
    Call GetTotQty("S")
End Sub
Private Sub ContSFram_KeyPress(KeyAscii As Integer)
If KeyAscii = 32 Then Call GetTotQty("S")
End Sub

Private Sub CreateChk_Click()
If CreateChk.Value = 1 Then
    TxtReport.Visible = True
    ChkTelegram.Visible = True
Else
    TxtReport.Visible = False
    ChkTelegram.Visible = True
End If
End Sub

Private Sub CRViewer1_ZoomLevelChanged(ByVal ZoomLevel As Integer)
If ZoomLevel = 75 Then
    ZoomLevel = 90
End If
End Sub

Private Sub DataCombo1_GotFocus()
    LSExCodes = Get_ExCodes
    Call vcDTP1_Validate(False)
    Sendkeys "%{DOWN}"
End Sub
Private Sub DataCombo1_LostFocus()
    LFromParty = DataCombo1.BoundText
End Sub

Private Sub DataCombo1_Validate(Cancel As Boolean)

If LenB(DataCombo1.BoundText) = 0 And MFormat <> "Sauda Transfer DD" Then
    MsgBox "Please Select From Party "
    Cancel = True
Else
    LFromParty = DataCombo1.BoundText
End If
End Sub
Private Sub DataCombo2_GotFocus()
    Sendkeys "%{DOWN}"
End Sub
Private Sub DataCombo2_LostFocus()
    LToParty = DataCombo2.BoundText
End Sub

Private Sub DataCombo2_Validate(Cancel As Boolean)
If LenB(DataCombo2.BoundText) = 0 And MFormat <> "Sauda Transfer DD" Then
    MsgBox "Please Select To Party "
    Cancel = True
Else
    LToParty = DataCombo2.BoundText
End If
End Sub
Private Sub EXChk_Click()
Dim I As Integer
    For I = 1 To ExList.ListItems.Count
        If ExChk.Value = 1 Then
            ExList.ListItems.Item(I).Checked = True
        Else
            ExList.ListItems.Item(I).Checked = False
        End If
    Next I
End Sub

Private Sub ExList_Click()
    
    AllExcodes = False

    If MFormat = "Sauda Transfer DD" Then
        Call FILL_PARTY
    End If

End Sub
Private Sub ExList_KeyPress(KeyAscii As Integer)
    Call ExList_Click
    If KeyAscii = 13 Then
        Call ExCmd_Click
    End If
    
End Sub
Private Sub FilterCmd_Click()
FilterChk = True
Call Fill_Saudas
End Sub
Private Sub fmlychk_Click()
Dim I As Integer
    For I = 1 To FmlyList.ListItems.Count
        If FmlyChk.Value = 1 Then
            FmlyList.ListItems.Item(I).Checked = True
        Else
            FmlyList.ListItems.Item(I).Checked = False
        End If
    Next I
End Sub
Private Sub FmlyList_Click()
AllFmly = False
'Call Fill_Parties
End Sub

Private Sub FmlyList_KeyPress(KeyAscii As Integer)
    Call FmlyList_Click
    If KeyAscii = 13 Then Call FmlyCmd_Click
End Sub

Private Sub Form_Activate()
'If LenB(Label4.Caption) > 0 Then MFormat = Label4.Caption
End Sub

Private Sub Form_Click()
'If LenB(Label4.Caption) > 0 Then MFormat = Label4.Caption
End Sub

Private Sub Form_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then Sendkeys "{TAB}"
    'If LenB(Label4.Caption) > 0 Then MFormat = Label4.Caption
End Sub

Private Sub Form_KeyUp(KeyCode As Integer, Shift As Integer)
    'If LenB(Label4.Caption) > 0 Then MFormat = Label4.Caption
    If KeyCode = 13 Then
        On Error Resume Next
        If Me.ActiveControl.NAME = "vcDTP1" Then
            Sendkeys "{tab}"
        ElseIf Me.ActiveControl.NAME = "vcDTP2" Then
            Sendkeys "{tab}"
        End If
    End If
End Sub

Private Sub Partychk_Click()
Dim I As Integer
    For I = 1 To PartyList.ListItems.Count
        If PartyChk.Value = 1 Then
            PartyList.ListItems.Item(I).Checked = True
        Else
            PartyList.ListItems.Item(I).Checked = False
        End If
    Next I
End Sub
Private Sub PartyList_Click()
AllParties = False
End Sub

Private Sub PartyList_KeyPress(KeyAscii As Integer)
    PartyList_Click
    If KeyAscii = 13 Then Call PartyCmd_Click
End Sub
Private Sub SaudaChk_Click()
Dim I As Integer
    For I = 1 To SaudaList.ListItems.Count
        If SaudaChk.Value = 1 Then
            SaudaList.ListItems.Item(I).Checked = True
        Else
            SaudaList.ListItems.Item(I).Checked = False
        End If
    Next I
End Sub
Private Sub ExCmd_Click()
If ExList.Visible = True Then
    LSExCodes = Get_ExCodes:    ExList.Visible = False
    ExChk.Visible = False:      Label5.Caption = vbNullString
    
    If FmlyCmd.Enabled = True Then
        FmlyCmd.SetFocus
    ElseIf PartyCmd.Enabled = True Then
        PartyCmd.SetFocus
    ElseIf SaudaCmd.Enabled = True Then
        SaudaCmd.SetFocus
    Else
        OkCmd.SetFocus
    End If
Else
    If SaudaList.Visible = True Then Call SaudaCmd_Click
    If FmlyList.Visible = True Then Call FmlyCmd_Click
    If PartyList.Visible = True Then Call PartyCmd_Click
    If MFormat = "Contract Note" Or MFormat = "Turnover Report" Or MFormat = "Daily Margin File Upload" Then
        Label5.Caption = "Please Select only One Exchange"
    Else
        Label5.Caption = "Please Select Exchange"
    End If
    ExChk.Visible = True:    ExList.Visible = True:    ExChk.SetFocus
End If
    vcDTP3.Visible = False
    vcDTP4.Visible = False
    Label2.Visible = False
    Label16.Visible = False
    Label17.Visible = False
    FilterCmd.Visible = False
End Sub
Private Sub FmlyCmd_Click()
If FmlyList.Visible = True Then
    LSFmlyIDs = Get_FmlyCodes:     FmlyList.Visible = False:    FmlyChk.Visible = False:
    'Call Fill_Parties
    'Call Fill_Saudas:
    Label5.Caption = vbNullString
    If PartyCmd.Enabled = True Then
        PartyCmd.SetFocus
    ElseIf SaudaCmd.Enabled = True Then
        SaudaCmd.SetFocus
    Else
        OkCmd.SetFocus
    End If
Else
    If ExList.Visible = True Then Call ExCmd_Click
    If SaudaList.Visible = True Then Call SaudaCmd_Click
    If PartyList.Visible = True Then Call PartyCmd_Click
    Label5.Caption = "Please Select Branch"
    FmlyChk.Visible = True:    FmlyList.Visible = True:    FmlyChk.SetFocus
    
End If
vcDTP3.Visible = False
    vcDTP4.Visible = False
    Label2.Visible = False
    Label16.Visible = False
    Label17.Visible = False
    FilterCmd.Visible = False
End Sub

Private Sub Form_Unload(Cancel As Integer)
 If CRViewer1.Visible = True Then
        CRViewer1.Visible = False
        Cancel = 1
    Else
        Unload Me
        Unload NRPTCONA
    End If
End Sub

Private Sub OkCmd_Click()
If vcDTP1.Value > vcDTP2.Value Then
    MsgBox " Invalid Date To Date Should br greater than or equal to FromDate  "
    vcDTP2.SetFocus
    Exit Sub
End If
'If EXLIST.Visible = True Then Call ExCmd_Click
'If FmlyList.Visible = True Then Call FmlyCmd_Click
'If PartyList.Visible = True Then Call PartyCmd_Click
'If SaudaList.Visible = True Then Call SaudaCmd_Click
Frame2.Enabled = False

Select Case MFormat
    Case "Contract Note"
        If DateValue(vcDTP1.Value) <= DateValue("30/06/2017") Then
            Call Contract_Note
        Else
            Call Contract_Note_all
        End If
    Case "Annual Global Transaction Statement"
        Call Annual_Report
    Case "Contract Register"
        Call Contract_Register
    Case "Trade Register"
        Call Trade_Register
    Case "Billwise Summary"
        If Check3.Value = 1 Then
            Call InvDWise_Report
        Else
            Call BillWise_Report
        End If
    
    Case "Sub Brokerage && Sharing List"
        Call BROKERAGE_LIST
    Case "Date wise Contract"
        Call DATE_WS_CONT_REG
    Case "Trade Deletion"
        Call Trade_Delete
    Case "Turnover Report"
        Call TURNOVER_REPORT
    Case "Standing Statement"
        If Option5.Value = True Then
            If Check11.Value = 0 Then
                Call Sauda_Wise_Standing2
            Else
                'If GUniqClientId <> "MANI-IND" Then
                    Call Sauda_Wise_Standing2
                'Else
                    'Call Sauda_Wise_Standing_Consolidated
                'End If
            End If
        Else
            'If GUniqClientId <> "MANI-IND" Or Check11.Value <> 1 Then
                Call Sauda_Wise_Standing2
            'Else
                'Call Sauda_Wise_Standing_Consolidated
            'End If
        End If
    Case "Maturitywise Standing Report"
        Call MSTwise_Standing
    Case "Date wise Standing"
        Call DatewiseStanding
    Case "Trade File Generation"
        Call CreateFile
    Case "ODIN Deposit Upload File Generation"
        Call Create_Deposit_file
    Case "Daily Margin File Upload"
        Call Create_Margin_File
    Case "Margin Rate List"
        Call MarginRateList
    Case "Daily Client Wise Margin"
        Call Daily_ClientMGn
    Case "Date wise Margin Report"
        Call DTMarginList
    Case "Margin Report"
        Call MarginList
    Case "Invoice Generation Settlement Wise"
        Call INV_SET_GENERATION
    Case "Account Statement"
        Call ACC_STT
    Case "TradeWise Statement"
        Call TradeWise_STM
    'Case "Activity Summary"
    '    Call Activity_Summary
    Case "Invoice List"
        Call INV_LIST
    Case "Invoice GST Report"
        Call INV_LIST
    Case "Invoice Printing"
        Call Invoice_Print
    Case "Invoice Summary"
        Call INVOICE_Summary
    Case "Account Statement Summary"
        Call ACC_STT_SMRY
    Case "Billwise Account Statement Summary"
        Billwise_ACC_STT_SMRY
    Case "Rate List"
        Call ClosingRateList
    Case "Brokerage List"
        Call BROKERAGE_LIST
    Case "Daily Activity Statement"
        Call Daily_Activity_Statement
    Case "Billwise Account Statement"
        Call Bill_Acstt
    Case "Brokerage Summary"
        Call BROKERAGE_SUMMARY
    Case "Branch Wise Brokerage Report"
        Call BRANCH_BROK
    Case "Branch Wise Sharing Report"
        Call Branch_Share
    Case "Bill Summary"
        Call BILLSMRY
    Case "Bill Summary With Sharing"
        If Check11.Value = 0 Then
            Call BillSummary
        Else
            Call BillSummary
        End If
    Case "Sauda wise missing rate"
       SWMRates
End Select
Frame2.Enabled = True
End Sub

Private Sub PartyCmd_Click()
LSExCodes = Get_ExCodes
LSFmlyIDs = Get_FmlyCodes

If PartyChk.Visible = True Then
    LSParties = Get_Parties:            PartyList.Visible = False
    PartyChk.Visible = False:           Label5.Caption = vbNullString
    'Fill_Saudas
    If SaudaCmd.Enabled = True Then
        SaudaCmd.SetFocus
    Else
        OkCmd.SetFocus
    End If
Else
    Call Fill_Parties
    If ExList.Visible = True Then Call ExCmd_Click
    If FmlyList.Visible = True Then Call FmlyCmd_Click
    If SaudaList.Visible = True Then Call SaudaCmd_Click
    Label5.Caption = "Please Select Parties"
    'Call Fill_Saudas
    PartyChk.Visible = True:    PartyList.Visible = True
    
    PartyChk.SetFocus
    
End If
    vcDTP3.Visible = False:    vcDTP4.Visible = False
    Label2.Visible = False:    Label16.Visible = False:
    Label17.Visible = False:   FilterCmd.Visible = False
    
End Sub
Private Sub SaudaCmd_Click()
LSExCodes = Get_ExCodes:    LSFmlyIDs = Get_FmlyCodes:    LSParties = Get_Parties
If vcDTP3.Visible = True Then
    
    LSSaudas = Get_Saudas:          SaudaList.Visible = False
    SaudaChk.Visible = False:       Label5.Caption = vbNullString:
    If MFormat <> "Sauda Transfer" Then
        OkCmd.SetFocus
    End If
    
    vcDTP3.Visible = False:         vcDTP4.Visible = False:         Label2.Visible = False
    Label16.Visible = False:        Label17.Visible = False:        FilterCmd.Visible = False
Else
    Call Fill_Saudas
    If ExList.Visible = True Then Call ExCmd_Click
    If FmlyList.Visible = True Then Call FmlyCmd_Click
    If PartyList.Visible = True Then Call PartyCmd_Click
    Label5.Caption = "Please Select Contracts"
    SaudaChk.Visible = True:    SaudaList.Visible = True:    SaudaChk.SetFocus
    ItemCombo.Visible = True:   vcDTP3.Visible = True:       vcDTP4.Visible = True
    Label2.Visible = True:      Label16.Visible = True:      Label17.Visible = True
    FilterCmd.Visible = True
End If
End Sub
Private Sub Form_Load()

    Dim LNo As Integer
    Dim TRec As ADODB.Recordset
    Me.Caption = MFormat:       Combo1.ListIndex = 0:           AllExcodes = True:          AllFmly = True
    AllBrokers = True:          AllParties = True:              AllSaudas = True:           ExChk.Visible = False:
    FmlyChk.Visible = False:    PartyChk.Visible = False:       SaudaChk.Visible = False:
    
    If MFormat = "Sauda Transfer" Then
        Label4.Caption = "Sauda Transfer ( Party to Party )"
    ElseIf MFormat = "Sauda Transfer DD" Then
        Label4.Caption = "Sauda Transfer ( Date to Date )"
    Else
        Label4.Caption = MFormat
    End If
    
    vcDTP1.Value = Date:        FilterChk = False:
    vcDTP2.MaxDate = GFinEnd:
    TxtReport.Visible = False
    TxtReport.text = App.Path & "\RPT\"
    LCURR = "N"
    vcDTP2.Value = GFinEnd:     vcDTP1.MinDate = GFinBegin:     vcDTP3.Value = GFinBegin:
    vcDTP4.Value = DateValue(GFinEnd + 365)
  Option1.Value = True
    Dim lcrusdinr As Double, ldrusdinr As Double
    
    If Date >= GFinEnd Then
        vcDTP1.Value = GFinBegin
    Else
        vcDTP1.Value = Date
    End If
    
    If Date <= GFinEnd Then vcDTP2.Value = Date
    
    Call Get_Selection(12)
    ChkFut.Value = 1:    ChkOpt.Value = 1:    ChkCsh.Value = 1
    ChkFut.Visible = False: ChkOpt.Visible = False: ChkCsh.Visible = False
    mysql = "SELECT DISTINCT INSTTYPE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " "
    LNo = 0
    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then
        Do While Not TRec.EOF
            If TRec!INSTTYPE = "FUT" Then
                ChkFut.Visible = True
                LNo = LNo + 1
            ElseIf TRec!INSTTYPE = "OPT" Then
                ChkOpt.Visible = True
                LNo = LNo + 1
            ElseIf TRec!INSTTYPE = "CSH" Then
                ChkCsh.Visible = True
                LNo = LNo + 1
            End If
            TRec.MoveNext
        Loop
    End If
    Set TRec = Nothing
    
    If LNo = 1 Then Frame6.Enabled = False
    Set ExRec = Nothing:    Set ExRec = New ADODB.Recordset
    mysql = "SELECT EXID,EXCODE,EXNAME,CURR FROM EXMAST WHERE COMPCODE =" & GCompCode & " ORDER BY EXNAME"
    ExRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not ExRec.EOF Then
        If ExRec.RecordCount = 1 Then
            LSExCodes = str(ExRec!EXID)
            LExIDS = str(ExRec!EXID)
            ExCmd.Enabled = False
            ExCmd.Caption = ExRec!excode
            AllExcodes = True
            LCURR = ExRec!CURR
        Else
            Call Fill_Exchanges
        End If
    End If
    Set FmlyRec = Nothing: Set FmlyRec = New ADODB.Recordset
    mysql = "SELECT FMLYID,FMLYCODE,FMLYNAME FROM ACCFMLY WHERE COMPCODE=" & GCompCode & " ORDER BY FMLYNAME  "
    FmlyRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not FmlyRec.EOF Then
        FmlyList.Enabled = True: FmlyChk.Enabled = True: FmlyCmd.Enabled = True
        Call Fill_Fmly
    Else
        FmlyList.Enabled = False: FmlyChk.Enabled = False
        FmlyCmd.Enabled = False
    End If
    'Call Fill_Parties:    Call Fill_Saudas:    Call Fill_Brokers
    
    If MFormat = "Contract Register" Then
        Option1.Caption = "Date Wise":        Option2.Caption = "Contract Wise":        Option3.Caption = "UnConfirmed"
        Option4.Caption = "Confirmed":        Option5.Caption = "All":                  Combo1.Clear
        Combo1.AddItem ("Detail"):            Combo1.AddItem ("Summary"):               Combo1.ListIndex = 0
        Combo1.Visible = True:                Combo2.Clear:                             Combo2.AddItem ("All Trades")
        Combo2.AddItem ("Data Import"):       Combo2.AddItem ("Manual"):                Combo2.ListIndex = 0
        Combo2.Visible = True:                Frame9.Visible = True:                    Frame7.Visible = True
        Check4.Visible = True:                Check4.Caption = "Net Position"
        Option2.Value = True
        Option5.Value = True
        CreateChk.Visible = True
        
    ElseIf MFormat = "Brokerage List" Then
        Check3.Visible = True
        Check3.Caption = "Show Only Zero Brokerage Account"
        Check3.Width = 4000
        
    ElseIf MFormat = "Invoice Generation Settlement Wise" Then
        Label3.Visible = False:        vcDTP2.Visible = False:        SaudaCmd.Enabled = False
        Call Ask_Var("TFTFFTFF"):      Frame2.Enabled = False
    ElseIf MFormat = "Sauda Transfer" Then
        OkCmd.Enabled = False:        CancelCmd.Enabled = False:        PartyCmd.Enabled = False
        Set LSPartyRec = Nothing:     Set LSPartyRec = New ADODB.Recordset
        
        mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " "
        mysql = mysql & " AND AC_CODE IN (SELECT DISTINCT PARTY FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
        mysql = mysql & " AND CONDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "')"
        mysql = mysql & " ORDER BY NAME "
        LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not LSPartyRec.EOF Then
            Set DataCombo1.RowSource = LSPartyRec
            DataCombo1.BoundColumn = "AC_CODE"
            DataCombo1.ListField = "NAME"
        End If
        mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " ORDER BY NAME "
        Set LSPartyRec = Nothing:        Set LSPartyRec = New ADODB.Recordset
        LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not LSPartyRec.EOF Then
            Set DataCombo2.RowSource = LSPartyRec
            DataCombo2.ListField = "NAME"
            DataCombo2.BoundColumn = "AC_CODE"
            
        End If
        vcDTP1.MinDate = GSysLockDt + 1
        vcDTP2.MinDate = GSysLockDt + 1
        Frame10.Visible = True
        Frame10.Left = 360
        Text4.text = "0.00":    Text6.text = "0"
        Text7.text = "0.00":    Text8.text = "0.00"
        Text9.text = "0":       Text10.text = "0.00"
        Text11.text = "0.00":   Text12.text = "0"
    ElseIf MFormat = "Sauda Transfer DD" Then 'date to date
        OkCmd.Enabled = False:        CancelCmd.Enabled = False:        PartyCmd.Enabled = False
        Set LSPartyRec = Nothing:     Set LSPartyRec = New ADODB.Recordset
        FmlyCmd.Visible = False: ExCmd.Visible = True: PartyCmd.Visible = False: SaudaCmd.Visible = False

       ' mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " "
       ' mysql = mysql & " AND AC_CODE IN (SELECT DISTINCT PARTY FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
       ' mysql = mysql & " AND CONDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "') "
       ' mysql = mysql & " ORDER BY NAME "
       ' LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
       ' If Not LSPartyRec.EOF Then
       '     Set DataCombo1.RowSource = LSPartyRec
       '     DataCombo1.BoundColumn = "AC_CODE"
       '     DataCombo1.ListField = "NAME"
       ' End If
    
'        mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " ORDER BY NAME "
'        Set LSPartyRec = Nothing:        Set LSPartyRec = New ADODB.Recordset
'        LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
'        If Not LSPartyRec.EOF Then
'            Set DataCombo2.RowSource = LSPartyRec
'            DataCombo2.ListField = "NAME"
'            DataCombo2.BoundColumn = "AC_CODE"
'        End If
        vcDTP1.MinDate = GSysLockDt + 1
        vcDTP2.MinDate = GSysLockDt + 1
        Frame10.Visible = True
        Frame10.Left = 360: Label6.Caption = "Party": Label7.Caption = "Sauda"
        Text4.text = "0.00":    Text6.text = "0"
        Text7.text = "0.00":    Text8.text = "0.00"
        Text9.text = "0":       Text10.text = "0.00"
        Text11.text = "0.00":   Text12.text = "0"
    ElseIf MFormat = "Rate List" Then
        FmlyCmd.Enabled = False
        PartyCmd.Enabled = False
    ElseIf MFormat = "Contract Note" Then
        Option1.Value = True
        Option1.Caption = "Plain Paper"
        Option2.Caption = "Pre Printed "
        Frame7.Visible = True
    ElseIf MFormat = "Trade Register" Then
        Combo1.Clear
        Combo1.AddItem "Trade Wise":        Combo1.AddItem "Rate Wise"
        Combo1.AddItem "Time Wise":         Combo1.AddItem "Party Wise"
        Combo1.ListIndex = 0:               Combo1.Visible = True
    ElseIf MFormat = "Date wise Contract" Then
        Combo1.Clear
        Combo1.AddItem ("Detail"):          Combo1.AddItem ("Summary")
        Combo1.ListIndex = 0:               Combo1.Visible = True
    ElseIf MFormat = "Turnover Report" Then
        Combo1.Clear
        Combo1.AddItem ("Item Wise"):       Combo1.AddItem ("Party Wise")
        Combo1.AddItem ("Contract Wise"):   Combo1.AddItem ("Date Wise")
        Combo1.ListIndex = 0:               Combo1.Visible = True
    ElseIf MFormat = "Billwise Summary" Then
        Frame7.Visible = True
        Option1.Caption = "Party Wise"
        Option1.Value = True
        Option2.Caption = "Branch Wise"
        Check4.Visible = True
        Check3.Visible = True
        Check3.Caption = "Summary"
        Check9.Visible = True
        Check9.Caption = "Only NetValue"
        unqucc.Visible = True
    ElseIf MFormat = "Standing Statement" Then
        Label1.Caption = "Upto Date":        Label3.Visible = False
        vcDTP2.Visible = False:              Check3.Visible = True
        Frame7.Visible = True:               Option4.Caption = "Party Wise"
        Option3.Caption = "Sauda Wise":      Option5.Caption = "Branch Wise"
        Frame9.Visible = True:               Option1.Caption = "Without Avg."
        Option2.Caption = "With Avg.":       Option1.Value = True
        Option4.Value = True:                Option6.Visible = True
        Option6.Left = 3400:                 Option6.Width = 1150
        Option2.Left = 1850:                 Option2.Width = 1300
        Option1.Width = 1500:                Check3.Caption = "Settlement Wise"
        Check3.Width = 1700:                 Check4.Visible = True
        Check9.Visible = True:               Check9.Caption = "Broker Wise"
        CreateChk.Visible = True
        Check11.Visible = True: Check11.Caption = "Consolidated"
        Check10.Visible = True: Check10.Caption = "Reflot"

    ElseIf MFormat = "Trade File Generation" Then
        Frame7.Visible = True:              Option1.Caption = "Trades"
        Option2.Caption = "Position":       Option1.Value = True
        Frame9.Visible = True
        Option4.Caption = "Excel 2"
        Option3.Caption = "Excel 7"
        Option5.Visible = False
        Option4.Value = True
        BrokerCmd.Visible = True:
        'Check5.Caption = "Excel 7 Format"
        'Check5.Visible = True
    ElseIf MFormat = "Margin Rate List" Then
        FmlyCmd.Enabled = False:        PartyCmd.Enabled = False
        Frame7.Visible = True:          Option1.Caption = "Rates"
        Option2.Caption = "Values":     Option1.Value = True
    ElseIf MFormat = "Date wise Margin Report" Then
        Frame7.Visible = True:              Option1.Caption = "Detail"
        Option2.Caption = "Summary":        Option1.Value = True
        Frame9.Visible = True:              Option4.Caption = "Client Wise"
        Option5.Caption = "Sauda Wise":     Option3.Caption = "Branch Wise"
        Option5.Value = True
    ElseIf MFormat = "Activity Summary" Then
        Combo2.Clear:                       Combo2.AddItem ("Detail")
        Combo2.AddItem ("Summary"):         Combo2.ListIndex = 0
        Combo2.Visible = True
    ElseIf MFormat = "Account Statement" Or MFormat = "Invoice Printing" Or MFormat = "Invoice List" Or MFormat = "Invoice Summary" Or MFormat = "Daily Activity Statement" Or MFormat = "Billwise Account Statement" Then
        Frame9.Visible = True:              Combo1.Clear:                        Combo1.AddItem "PDF":                  Combo1.AddItem "Excel"
        Combo1.AddItem "Rich Text":         Combo1.Visible = True:               Combo1.ListIndex = 0:                  Check5.Visible = True
        Check10.Visible = True
        Option4.Caption = "With Op.Bal":    Option3.Caption = "Without Op.Bal":  Option5.Caption = "Ledger Entries":    CreateChk.Visible = True
        Option3.Value = True:               Frame7.Visible = True:               Option1.Caption = "With Margin":       Option2.Caption = "Without Margin"
        Option2.Value = True:               Check3.Visible = True:               Check3.Caption = "Hide Brok.":         Check4.Visible = True
        Option3.Value = True
        Check4.Caption = " With Sharing"
        Check11.Visible = True: Check11.Caption = "Interest"
        Check13.Visible = True:
        If MFormat = "Billwise Account Statement" Then Check3.Caption = "Trade Wise Statement"
        If MFormat = "Invoice Printing" Or MFormat = "Invoice List" Then
            SaudaCmd.Enabled = False
            If MFormat = "Invoice List" Then
                Combo2.Clear
                Combo2.AddItem ("Detail"):           Combo2.AddItem ("Summary")
                Combo2.ListIndex = 0:                Combo2.Visible = True
            End If
        End If
        Check9.Visible = True
        mysql = "SELECT DISTINCT INSTTYPE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " "
        Set TRec = Nothing:    Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec.EOF Then
            Do While Not TRec.EOF
                If TRec!INSTTYPE = "OPT" Then OptMTMChk.Visible = True
                If GAutoBrok = True Then OptMTMChk.Value = 1
                If TRec!INSTTYPE = "CSH" Then CshMTMchk.Visible = True
                If GEqBill = True Then CshMTMchk.Value = 1
                TRec.MoveNext
            Loop
        End If
    ElseIf MFormat = "Account Statement Summary" Or MFormat = "Billwise Account Statement Summary" Then
        Frame9.Visible = True:              Combo1.Clear:                       Combo1.AddItem "PDF":               Combo1.AddItem "Excel"
        Combo1.AddItem "Rich Text":         Combo1.Visible = True:              Combo1.ListIndex = 0:
        
        Combo2.Clear
        Combo2.AddItem ("Detail Party wise"):
        Combo2.AddItem ("Detail Item wise"):
        Combo2.AddItem ("Summary"):
        Combo2.ListIndex = 2:
        Combo2.Visible = True
        
        
        Check5.Visible = True:              Option4.Caption = "With Op.Bal":    Option3.Caption = "Without Op.Bal": Option5.Caption = "Ledger Entries"
        CreateChk.Visible = True:           Option3.Value = True:               Frame7.Visible = True:              Option1.Caption = "With Margin"
        Option2.Caption = "Without Margin": Option2.Value = True:               Check3.Visible = False:             Check4.Visible = True
        Check4.Caption = " With Sharing"
        mysql = "SELECT DISTINCT INSTTYPE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " "
        Set TRec = Nothing:    Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec.EOF Then
            Do While Not TRec.EOF
                If TRec!INSTTYPE = "OPT" Then OptMTMChk.Visible = True
                If GAutoBrok = True Then OptMTMChk.Value = 1
                If TRec!INSTTYPE = "CSH" Then CshMTMchk.Visible = True
                If GEqBill = True Then CshMTMchk.Value = 1
                TRec.MoveNext
            Loop
        End If
        Option3.Value = True
    ElseIf MFormat = "Bill Summary" Or MFormat = "Bill Summary With Sharing" Then
        mysql = "SELECT DISTINCT INSTTYPE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " "
        Set TRec = Nothing:    Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec.EOF Then
            Do While Not TRec.EOF
                If TRec!INSTTYPE = "OPT" Then OptMTMChk.Visible = True
                If GAutoBrok = True Then OptMTMChk.Value = 1
                If TRec!INSTTYPE = "CSH" Then CshMTMchk.Visible = True
                If GEqBill = True Then CshMTMchk.Value = 1
                TRec.MoveNext
            Loop
        End If
        Frame9.Visible = True:        Option4.Caption = "With Op.Bal":        Option3.Caption = "Without Op.Bal"
        Option5.Visible = False:      Option3.Value = True
        'If GCurr = "Y" Then
            Check4.Visible = True
            Check4.Value = 0: Check4.Caption = "Convert Currency"
        'End If
        Option4.Value = False
        Check11.Visible = True: Check11.Caption = "Consolidated"
        If MFormat = "Bill Summary With Sharing" Then
            Check10.Visible = True: Check10.Caption = "Clientwise Sharing"
        End If
        Check3.Visible = True: Check3.Caption = "Include Contra"
        Check3.Value = 1
        unqucc.Visible = True
    ElseIf MFormat = "Brokerage Summary" Or MFormat = "Branch Wise Brokerage Report" Or MFormat = "Branch Wise Sharing Report" Then
        Combo1.Visible = True
        Combo1.AddItem ("Consolidated")
        Check5.Visible = False
        Check5.Caption = "With INR"
        Check3.Visible = True
        Check3.Caption = "Contra Consolidated"
        Check10.Value = 0
        Check10.Visible = False
        Check10.Caption = "With Client Share "
        If GUniqClientId = "2656AHM" Then
            Check10.Value = 1
        End If
        Combo1.ListIndex = 1
        Check11.Visible = False
        Check4.Visible = True
        Check4.Value = 0: Check4.Caption = "Convert Currency"
        CreateChk.Visible = True
    ElseIf MFormat = "Sauda wise missing rate" Then
        FmlyCmd.Enabled = False
        PartyCmd.Enabled = False
    ElseIf MFormat = "Margin Report" Then
        Label1.Caption = "On Date":        Label3.Visible = False:          vcDTP2.Visible = False
        Frame7.Visible = True:             Option1.Caption = "Detail":      Option2.Caption = "Summary"
        Option1.Value = True:              Frame9.Visible = True:           Option4.Caption = "Client Wise"
        Option5.Caption = "Sauda Wise":    Option3.Caption = "Branch Wise": Option5.Value = True
    End If
    
    If MFormat = "Account Statement" Then
        Check12.Visible = True
    End If
End Sub

Public Sub Fill_Exchanges()
    Label5.Caption = "Getting Exchnages"
    Me.MousePointer = 11: ExList.ListItems.Clear
    ExList.Visible = False
    If Not ExRec.EOF Then
        ExRec.MoveFirst
        ExList.Enabled = True: ExChk.Enabled = True
        Do While Not ExRec.EOF
            ExList.ListItems.Add , , ExRec!excode
            ExList.ListItems(ExList.ListItems.Count).ListSubItems.Add , , ExRec!EXNAME
            ExList.ListItems(ExList.ListItems.Count).ListSubItems.Add , , ExRec!EXID
            If ExRec!CURR = "Y" Then LCURR = "Y"
            ExRec.MoveNext
        Loop
    Else
        ExList.Enabled = False: ExChk.Enabled = False
    End If
    Me.MousePointer = 0

    Label5.Caption = vbNullString

End Sub

Public Sub Fill_Fmly()

Label5.Caption = "Getting Branches"
    
    Me.MousePointer = 11: FmlyList.ListItems.Clear
    FmlyList.Visible = False
    If Not FmlyRec.EOF Then
        FmlyList.Enabled = True: FmlyChk.Enabled = True
        Do While Not FmlyRec.EOF
            FmlyList.ListItems.Add , , FmlyRec!FMLYCODE
            FmlyList.ListItems(FmlyList.ListItems.Count).ListSubItems.Add , , FmlyRec!FmlyNAME
            FmlyList.ListItems(FmlyList.ListItems.Count).ListSubItems.Add , , FmlyRec!FMLYID
            FmlyRec.MoveNext
        Loop
    Else
        FmlyList.Enabled = False: FmlyChk.Enabled = False
    End If
    Me.MousePointer = 0

Label5.Caption = vbNullString

End Sub


Public Function Get_ExCodes() As String
Dim LFExCode  As String:    Dim LCount As Integer:  Dim I As Integer
LFExCode = vbNullString
If AllExcodes = False Then
    LCount = ExList.ListItems.Count
    For I = 1 To ExList.ListItems.Count
        If ExList.ListItems(I).Checked = True Then
            LCount = LCount - 1
            If LenB(LFExCode) <> 0 Then LFExCode = LFExCode & ", "
            LFExCode = LFExCode & ExList.ListItems(I).ListSubItems(2) & ""
            If MFormat = "Contract Note" Or MFormat = "Daily Margin File Upload" Then LFExCode = "" & ExList.ListItems(I).ListSubItems(2) & ""
        End If
    Next
    If MFormat = "Contract Note" Or MFormat = "Daily Margin File Upload" Then
        If LCount <> ExList.ListItems.Count - 1 And ExList.ListItems.Count <> 0 Then MsgBox "Please Select Only One Exchange"
    End If

    If LCount <> 0 Then
        If LCount <> ExList.ListItems.Count Then AllExcodes = False
    Else
        AllExcodes = True
    End If
    If MFormat = "Contract Note" Or MFormat = "Daily Margin File Upload" Or MFormat = "Turnover Report" Then
        If ExRec.RecordCount = 1 Then
            ExRec.MoveFirst
            LFExCode = "" & ExRec!EXID & ""
        End If
    End If
End If
If LenB(LFExCode) < 1 Then AllExcodes = True
Get_ExCodes = LFExCode
End Function

Public Function Get_FmlyCodes() As String
Dim LFFmlyids   As String
Dim LCount As Integer
Dim I As Integer
LFFmlyids = vbNullString

'If AllFmly = False Then
    LCount = FmlyList.ListItems.Count
    For I = 1 To FmlyList.ListItems.Count
        If FmlyList.ListItems(I).Checked = True Then
            LCount = LCount - 1
            If LenB(LFFmlyids) <> 0 Then LFFmlyids = LFFmlyids & ", "
            LFFmlyids = LFFmlyids & "" & FmlyList.ListItems(I).ListSubItems(2) & ""
        End If
    Next
    If LCount <> 0 Then
        If LCount <> FmlyList.ListItems.Count Then AllFmly = False
    Else
        AllFmly = True
    End If
'End If

If LenB(LFFmlyids) < 1 Then AllFmly = True
Get_FmlyCodes = LFFmlyids

End Function
Public Function Get_ALL_Parties() As String
    Dim LFParties   As String
    Dim LCount As Integer
    Dim I As Integer
    Dim CRec As ADODB.Recordset
    LSFmlyIDs = Get_FmlyCodes
    LFParties = vbNullString
    LCount = PartyList.ListItems.Count
    
        For I = 1 To PartyList.ListItems.Count
            If PartyList.ListItems(I).Checked = True Then
                LCount = LCount - 1
                If LenB(LFParties) <> 0 Then LFParties = LFParties & ", "
                LFParties = LFParties & "'" & PartyList.ListItems(I).ListSubItems(1) & "'"
            End If
        Next
        'If LCount = PartyList.ListItems.Count Then
            AllParties = True
        'End If
    
    Get_ALL_Parties = LFParties
End Function
Public Function Get_Parties() As String
    Dim LFParties   As String
    Dim LCount As Integer
    Dim I As Integer
    Dim CRec As ADODB.Recordset
    LSFmlyIDs = Get_FmlyCodes
    'If Len(LSFmlyIDs) > 0 Then
    '    Call Fill_Parties
    'End If
    LFParties = vbNullString
    LCount = PartyList.ListItems.Count
    If AllParties = False Or Len(LSFmlyIDs) > 0 Then
        For I = 1 To PartyList.ListItems.Count
            If PartyList.ListItems(I).Checked = True Then
                LCount = LCount - 1
                If LenB(LFParties) <> 0 Then LFParties = LFParties & ", "
                LFParties = LFParties & "'" & PartyList.ListItems(I).ListSubItems(1) & "'"
            End If
        Next
        If LCount = PartyList.ListItems.Count Then
            AllParties = True
        End If
    End If
    Get_Parties = LFParties
End Function

Public Function Get_Brokers() As String
Dim LFBrokers As String:        Dim LCount As Integer:      Dim I As Integer
LFBrokers = vbNullString
If AllBrokers = False Then
    LCount = BrokerLst.ListItems.Count
    For I = 1 To BrokerLst.ListItems.Count
        If BrokerLst.ListItems(I).Checked = True Then
            LCount = LCount - 1
            If LenB(LFBrokers) <> 0 Then LFBrokers = LFBrokers & ", "
            LFBrokers = LFBrokers & "'" & BrokerLst.ListItems(I).ListSubItems(1) & "'"
        End If
    Next
    If LCount <> 0 Then
        If LCount <> BrokerLst.ListItems.Count Then AllBrokers = False
    End If
End If
Get_Brokers = LFBrokers
End Function

Public Function Get_Inst() As String
LSInst = vbNullString
AllInst = True
OkCmd.Enabled = True
If ChkFut.Visible = True Then
    If ChkFut.Value = 1 Then
        LSInst = "'FUT'"
    Else
        AllInst = False
    End If
End If
If ChkOpt.Visible = True Then
    If ChkOpt.Value = 1 Then
        If Len(LSInst) < 1 Then
            LSInst = "'OPT'"
        Else
            LSInst = LSInst & ",'OPT'"
        End If
    Else
        AllInst = False
    End If
End If
If ChkCsh.Visible = True Then
    If ChkCsh.Value = 1 Then
        If Len(LSInst) < 1 Then
            LSInst = "'CSH'"
        Else
            LSInst = LSInst & ",'CSH'"
        End If
    Else
        AllInst = False
    End If
End If
If LenB(LSInst) = 0 Then
    MsgBox "Please Select at Least One Instrument"
    OkCmd.Enabled = False
End If
Get_Inst = LSInst
End Function
Public Function Get_Saudas() As String
Dim LFSaudas   As String: Dim LCount As Integer: Dim I As Integer

LFSaudas = vbNullString
LCount = SaudaList.ListItems.Count
If AllSaudas = False Then
    For I = 1 To SaudaList.ListItems.Count
        If SaudaList.ListItems(I).Checked = True Then
            LCount = LCount - 1
            If LenB(LFSaudas) <> 0 Then LFSaudas = LFSaudas & ", "
            LFSaudas = LFSaudas & SaudaList.ListItems(I).SubItems(2) & ""
        End If
    Next
    If LCount <> 0 Then
        If LCount <> SaudaList.ListItems.Count Then AllSaudas = False
    Else
        AllSaudas = True
    End If
End If
If FilterChk = True Then AllSaudas = False
Get_Saudas = LFSaudas
End Function

Sub Fill_Parties()
Dim MBal As Double
Dim TRec As ADODB.Recordset
LSExCodes = Get_ExCodes
Label5.Caption = "Getting Parties"
DoEvents
Me.MousePointer = 11: PartyList.TabStop = False: PartyChk.TabStop = False
PartyList.ListItems.Clear
LSFmlyIDs = Get_FmlyCodes
Set TRec = Nothing
Set TRec = New ADODB.Recordset
If AllFmly = False Or LenB(LSFmlyIDs) > 0 Then
    mysql = "SELECT DISTINCT AM.ACCID,AM.OP_BAL,AD.AC_CODE,AD.NAME,AD.PARTYTYPE "
    mysql = mysql & " FROM ACCOUNTM AS AM ,ACCOUNTD AS AD, ACCFMLYD AS ACAD WHERE AM.COMPCODE=" & GCompCode & " "
    mysql = mysql & " AND AM.ACCID = AD.ACCID AND AM.ACCID =ACAD.ACCID  "
    mysql = mysql & " AND ACAD.FMLYID IN (" & LSFmlyIDs & ") "
    If vcDTP2.Visible = True Then
        mysql = mysql & " AND AM.ACCID IN (SELECT DISTINCT ACCID  FROM CTR_D WHERE COMPCODE = " & GCompCode & " AND CONDATE<='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    Else
        mysql = mysql & " AND AM.ACCID IN (SELECT DISTINCT ACCID  FROM CTR_D WHERE COMPCODE = " & GCompCode & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    End If
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND EXID IN (" & LSExCodes & ") "
    mysql = mysql & ")"
    mysql = mysql & " ORDER BY AD.NAME"
Else
    If vcDTP2.Visible = True Then
        mysql = "EXEC FILL_PARTIES " & GCompCode & ",'" & Format(vcDTP1.Value, "YYYY/MM/DD") & "','" & Format(vcDTP2.Value, "YYYY/MM/DD") & "','" & LSExCodes & "','" & "2" & "'"
    Else
        mysql = "EXEC FILL_PARTIES " & GCompCode & ",'" & Format(vcDTP1.Value, "YYYY/MM/DD") & "','" & Format(vcDTP2.Value, "YYYY/MM/DD") & "','" & LSExCodes & "','" & "1" & "'"
    End If
End If
TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
Dim A As Integer
PartyList.Visible = False
Label5.Caption = "Filling Parties"
DoEvents
If Not TRec.EOF Then
    A = TRec.RecordCount
    PartyList.Visible = False
    Do While Not TRec.EOF
        MBal = TRec!OP_BAL
        PartyList.ListItems.Add , , TRec!NAME
        PartyList.ListItems(PartyList.ListItems.Count).ListSubItems.Add , , TRec!AC_CODE
        PartyList.ListItems(PartyList.ListItems.Count).ListSubItems.Add , , IIf(IsNull(TRec!PARTYTYPE), 1, TRec!PARTYTYPE)
        PartyList.ListItems(PartyList.ListItems.Count).ListSubItems.Add , , Format(Val(MBal), "0.00")
        
        TRec.MoveNext
    Loop
End If
Label5.Caption = vbNullString
Set TRec = Nothing
PartyList.TabStop = True: Check2.TabStop = True
Me.MousePointer = 0
End Sub
Sub Fill_Saudas()
Dim TRec As ADODB.Recordset

Label5.Caption = "Getting Contracts "
DoEvents
Me.MousePointer = 11
SaudaList.ListItems.Clear
Set TRec = Nothing
Set TRec = New ADODB.Recordset
LSInst = vbNullString
If MFormat = "Brokerage List" Then
    mysql = "SELECT DISTINCT I.ITEMCODE,I.ITEMNAME,I.EXCHANGECODE,I.LOT "
    mysql = mysql & " FROM ITEMMAST AS I WHERE I.COMPCODE=" & GCompCode & "  "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ") "
    mysql = mysql & " ORDER BY I.EXCHANGECODE,I.ITEMCODE"
Else
    mysql = "SELECT DISTINCT S.SAUDAID,S.SAUDACODE,S.SAUDANAME,S.MATURITY,S.INSTTYPE,S.STRIKEPRICE,S.TRADEABLELOT,S.ITEMCODE,I.EXCHANGECODE,I.LOT "
    mysql = mysql & " FROM SAUDAMAST AS S ,ITEMMAST AS I WHERE S.COMPCODE=" & GCompCode & "  "
    mysql = mysql & " AND S.ITEMID = I.ITEMID  AND S.MATURITY>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
    mysql = mysql & " AND S.SAUDAID IN (SELECT DISTINCT SAUDAID FROM CTR_D WHERE COMPCODE = " & GCompCode & ""
    If vcDTP2.Visible = True Then
        mysql = mysql & " AND CONDATE<='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    Else
        mysql = mysql & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    End If
    If LenB(ItemCombo.BoundText) > 0 Then mysql = mysql & " AND S.ITEMCODE='" & ItemCombo.BoundText & "'"
    If FilterChk Then mysql = mysql & " AND S.MATURITY>='" & Format(vcDTP3.Value, "YYYY/MM/DD") & "' AND S.MATURITY<='" & Format(vcDTP4.Value, "YYYY/MM/DD") & "'"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND PARTY IN (" & LSParties & ")"
    mysql = mysql & " )"
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ") "
    mysql = mysql & " ORDER BY S.ITEMCODE,S.MATURITY"
End If
TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
Set ItemCombo.RowSource = TRec
ItemCombo.ListField = "ITEMCODE"
ItemCombo.BoundColumn = "ITEMCODE"
SaudaList.Visible = False
If Not TRec.EOF Then
    Label5.Caption = "Filling Contracts "
    DoEvents
    Do While Not TRec.EOF
        If MFormat = "Brokerage List" Then
            SaudaList.ListItems.Add , , TRec!ITEMCODE
            SaudaList.ListItems(SaudaList.ListItems.Count).ListSubItems.Add , , TRec!ITEMName
            SaudaList.ListItems(SaudaList.ListItems.Count).ListSubItems.Add , , TRec!lot
            SaudaList.ListItems(SaudaList.ListItems.Count).ListSubItems.Add , , TRec!EXCHANGECODE
        Else
            SaudaList.ListItems.Add , , TRec!saudacode
            SaudaList.ListItems(SaudaList.ListItems.Count).ListSubItems.Add , , TRec!SAUDANAME
            SaudaList.ListItems(SaudaList.ListItems.Count).ListSubItems.Add , , TRec!SAUDAID
        End If
        TRec.MoveNext
    Loop
End If
Label5.Caption = vbNullString

If vcDTP3.Visible = True Then SaudaList.Visible = True
Set TRec = Nothing
Me.MousePointer = 0
End Sub

Private Sub SaudaList_Click()
AllSaudas = False
End Sub

Private Sub SaudaList_KeyPress(KeyAscii As Integer)
Call SaudaList_Click

'If KeyAscii = 13 Then Call SaudaCmd_Click
End Sub

Private Sub Text1_Change()

End Sub

Private Sub vcDTP1_LostFocus()
Call vcDTP1_Validate(False)
End Sub

Private Sub vcDTP1_Validate(Cancel As Boolean)
    If MFormat = "Sauda Transfer" Then
        Set LSPartyRec = Nothing
        Set LSPartyRec = New ADODB.Recordset
        mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " AND  AC_CODE IN "
        mysql = mysql & " (SELECT DISTINCT PARTY FROM CTR_D WHERE COMPCODE =" & GCompCode & "  AND CONDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' "
        mysql = mysql & " AND CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "') ORDER BY NAME "
        LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not LSPartyRec.EOF Then
            Set DataCombo1.RowSource = LSPartyRec
            DataCombo1.BoundColumn = "AC_CODE"
            DataCombo1.ListField = "NAME"
        End If
        mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " ORDER BY NAME "
        Set LSPartyRec = Nothing
        Set LSPartyRec = New ADODB.Recordset
        LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not LSPartyRec.EOF Then
            Set DataCombo2.RowSource = LSPartyRec
            DataCombo2.ListField = "NAME"
            DataCombo2.BoundColumn = "AC_CODE"
            Frame10.Visible = True
        End If
    ElseIf MFormat = "Sauda Transfer DD" Then
        Call FILL_PARTY
    End If
End Sub
Sub FILL_PARTY()

    LSExCodes = Get_ExCodes
    
    Set LSPartyRec = Nothing
    Set LSPartyRec = New ADODB.Recordset
    mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " AND  AC_CODE IN "
    mysql = mysql & " (SELECT DISTINCT PARTY FROM CTR_D WHERE COMPCODE =" & GCompCode & "  "
    If Len(LSExCodes) > 0 Then
        mysql = mysql & " AND CTR_D.EXID IN (" & LSExCodes & ") "
    End If
    mysql = mysql & "  and CONDATE = '" & Format(vcDTP1.Value, "YYYY/MM/DD") & "') "
    mysql = mysql & " ORDER BY NAME "
    LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not LSPartyRec.EOF Then
        Set DataCombo1.RowSource = LSPartyRec
        DataCombo1.BoundColumn = "AC_CODE"
        DataCombo1.ListField = "NAME"
    End If
    
    Set LFSaudaRec = Nothing
    Set LFSaudaRec = New ADODB.Recordset
    mysql = "SELECT DISTINCT A.SAUDAID,A.SAUDANAME FROM SAUDAMAST AS A, CTR_D AS B WHERE A.COMPCODE =" & GCompCode & " AND A.COMPCODE =B.COMPCODE  AND A.SAUDAID =B.SAUDAID "
    If Len(LSExCodes) > 0 Then
        mysql = mysql & " AND B.EXID IN (" & LSExCodes & ") "
    End If
    mysql = mysql & "and B.CONDATE ='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'  ORDER BY A.SAUDANAME "

    LFSaudaRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not LFSaudaRec.EOF Then
        Set DataCombo2.RowSource = LFSaudaRec
        DataCombo2.BoundColumn = "SAUDAID":
        DataCombo2.ListField = "SAUDANAME"
    Else
        DataCombo2.Enabled = False
    End If
End Sub

Private Sub vcDTP2_Validate(Cancel As Boolean)
    If MFormat <> "Sauda Transfer DD" Then
        If vcDTP2.Value < vcDTP1.Value Then MsgBox "Invalid Date,To Date Should be Greater than or Equal to From Date "
    End If
'vcDTP2.SetFocus
If MFormat = "Sauda Transfer" Then
    Set LSPartyRec = Nothing
    Set LSPartyRec = New ADODB.Recordset
    mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " AND  AC_CODE IN (SELECT DISTINCT PARTY FROM CTR_D WHERE COMPCODE =" & GCompCode & "  AND CONDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "') ORDER BY NAME "
    LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not LSPartyRec.EOF Then
        Set DataCombo1.RowSource = LSPartyRec
        DataCombo1.BoundColumn = "AC_CODE"
        DataCombo1.ListField = "NAME"
    End If
    mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " ORDER BY NAME "
    Set LSPartyRec = Nothing
    Set LSPartyRec = New ADODB.Recordset
    LSPartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not LSPartyRec.EOF Then
        Set DataCombo2.RowSource = LSPartyRec
        DataCombo2.ListField = "NAME"
        DataCombo2.BoundColumn = "AC_CODE"
        Frame10.Visible = True
    End If
End If
    vcDTP3.Visible = False
    vcDTP4.Visible = False
    Label2.Visible = False
    Label16.Visible = False
    Label17.Visible = False
    FilterCmd.Visible = False
    'vcDTP2.SetFocus
End Sub
Sub Contract_Register()
    Dim SrNo As Long:           Dim TRec As ADODB.Recordset:    Dim LAcCode As String:      Dim LSauda As String
    Dim lOpQty As Double:       Dim LBalQty As Double:          Dim LCondate As Date:       Dim LCalval As Double
    Dim LBrokType As String:    Dim LBrokLot As Double:         Dim LBrokQty As Double:     Dim LBrokQty2 As Double
    Dim LBrokAmt As Double:     Dim LSaudaID As Long:           Dim LPartyName As String:   Dim LBrokRate As Double
    Dim LBrokRate2 As Double:   Dim LACCID As Long
    
    On Error GoTo err1
    SrNo = 0
    Me.MousePointer = 11: OkCmd.Enabled = False
    LSExCodes = Get_ExCodes:    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSInst = Get_Inst
    If AllInst = False And LenB(LSInst) = 0 Then
        MsgBox "Please Select at least one Instrument"
        If ChkFut.Visible = True Then
            ChkFut.SetFocus
        ElseIf ChkOpt.Visible = True Then
            ChkOpt.SetFocus
        Else
            ChkCsh.SetFocus
        End If
        Exit Sub
    End If
    If Check4.Value = 1 Then
        Call CreateRec_Cont
        'OPENING
        mysql = "SELECT I.ITEMID,I.STDATE, A.AC_CODE,A.NAME, I.SAUDA,S.SAUDAID,E.EXCODE,E.LOTWISE,IM.LOT,S.REFLOT,S.TRADEABLELOT,I.OPQTY,OPRATE "
        mysql = mysql & " FROM INV_D AS I, ACCOUNTD AS A, SAUDAMAST AS S,ITEMMAST AS IM, EXMAST AS E "
        mysql = mysql & " WHERE I.COMPCODE =" & GCompCode & " AND I.STDATE ='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
        mysql = mysql & " AND A.ACCID =I.ACCID AND S.SAUDAID =I.SAUDAID "
        mysql = mysql & " AND S.MATURITY >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND IM.ITEMID =I.ITEMID AND E.EXID =I.EXID"
        If AllSaudas = False Then mysql = mysql & "  AND I.SAUDAID IN (" & LSSaudas & ") "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND A.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE  IN (" & LSParties & ") "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND IM.EXID IN  (" & LSExCodes & ") "
        If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
        mysql = mysql & " ORDER BY A.NAME,I.EXCODE,I.ITEMCODE,S.MATURITY"
        Set TRec = Nothing:  Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not TRec.EOF Then
            With TRec
                Do While Not .EOF
                    If !OpQty <> 0 Then
                        RecRpt.AddNew
                        RecRpt!saudacode = !Sauda
                        RecRpt!PARTYCODE = !AC_CODE
                        RecRpt!PARTYNAME = !NAME
                        RecRpt!BREFLOT = !REFLOT
                        RecRpt!SREFLOT = !REFLOT
                        If !LOTWISE = "N" Then
                            RecRpt!CALVAL = !lot
                        Else
                            RecRpt!CALVAL = !TRADEABLELOT
                        End If
                        If !OpQty > 0 Then
                            RecRpt!BQnty = !OpQty
                            RecRpt!BRate = Abs(!OpQty) * !OPRATE * RecRpt!CALVAL
                            RecRpt!SQnty = 0
                        Else
                            RecRpt!SQnty = Abs(!OpQty)
                            RecRpt!SRate = Abs(!OpQty) * !OPRATE * RecRpt!CALVAL
                            RecRpt!BQnty = 0
                        End If
                        RecRpt.Update
                    End If
                    .MoveNext
                Loop
            End With
        End If
        Set TRec = Nothing
        ' TRADE
        mysql = "SELECT A.AC_CODE,A.NAME, IM.ITEMCODE,IM.ITEMID,IM.LOT,I.SAUDA,I.SAUDAID,S.MATURITY,S.TRADEABLELOT,S.REFLOT,I.EXCODE,E.LOTWISE,SUM(TOTBQTY) AS TBQTY, "
        mysql = mysql & " SUM(TOTBAMT) AS TBAMT,SUM(TOTSQTY) AS TSQTY, SUM(TOTSAMT) AS TSAMT,SUM(CUTQTY) AS CQTY, SUM(CUTRATE) AS CRATE"
        mysql = mysql & " FROM INV_D AS I, ACCOUNTD AS A, SAUDAMAST AS S,EXMAST AS E,ITEMMAST AS IM "
        mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND I.STDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND I.STDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
        mysql = mysql & " AND A.ACCID =I.ACCID AND  S.SAUDAID =I.SAUDAID AND S.MATURITY >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
        mysql = mysql & " AND IM.ITEMID =I.ITEMID AND E.EXID=I.EXID"
        If AllSaudas = False Then mysql = mysql & "  AND S.SAUDAID IN (" & LSSaudas & ") "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND A.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE  IN (" & LSParties & ") "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND IM.EXID IN  (" & LSExCodes & ") "
        If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
        mysql = mysql & " GROUP BY A.AC_CODE,A.NAME, IM.ITEMCODE,IM.ITEMID,IM.LOT,I.SAUDA,S.MATURITY,S.TRADEABLELOT,I.EXCODE,E.LOTWISE"
        mysql = mysql & " ORDER BY A.NAME, I.EXCODE,IM.ITEMCODE,S.MATURITY"
        Set TRec = Nothing:        Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not TRec.EOF Then
            With TRec
                Do While Not .EOF
                    If !TBQTY + !TSQTY + !CQTY <> 0 Then
                        RecRpt.Filter = adFilterNone
                        If RecRpt.RecordCount <> 0 Then
                            RecRpt.MoveFirst
                            RecRpt.Filter = "PARTYCODE ='" & !AC_CODE & "' AND SAUDACODE= '" & !Sauda & "'"
                            If RecRpt.EOF Then
                                RecRpt.AddNew
                                RecRpt!saudacode = !Sauda:                                RecRpt!PARTYCODE = !AC_CODE
                                RecRpt!PARTYNAME = !NAME
                                RecRpt!BQnty = !TBQTY:                                RecRpt!SQnty = !TSQTY
                                RecRpt!BRate = !TBAMT:                                RecRpt!SRate = !TSAMT
                                RecRpt!BREFLOT = !REFLOT
                                RecRpt!SREFLOT = !REFLOT
                                If TRec!EXCHANGECODE = "NSE" And TRec!LOTWISE = "Y" Then
                                    RecRpt!CALVAL = !TRADEABLELOT
                                Else
                                    RecRpt!CALVAL = !lot
                                End If
                                
                                If !CQTY <> 0 Then
                                    If !CQTY > 0 Then
                                        RecRpt!BQnty = RecRpt!BQnty + !CQTY
                                    Else
                                        RecRpt!SQnty = RecRpt!SQnty + !CQTY
                                    End If
                                End If
                                RecRpt.Update
                            Else
                                RecRpt!BQnty = Val(RecRpt!BQnty & vbNullString) + !TBQTY
                                RecRpt!SQnty = Val(RecRpt!SQnty & vbNullString) + !TSQTY
                                RecRpt!BRate = Val(RecRpt!BRate & vbNullString) + !TBAMT
                                RecRpt!SRate = Val(RecRpt!SRate & vbNullString) + !TSAMT
                                RecRpt.Update
                            End If
                        Else
                            RecRpt.AddNew:                            RecRpt!saudacode = !Sauda
                            RecRpt!PARTYCODE = !AC_CODE:              RecRpt!PARTYNAME = !NAME
                            RecRpt!BQnty = !TBQTY:                    RecRpt!SQnty = !TSQTY
                            RecRpt!BRate = !TBAMT:                    RecRpt!SRate = !TSAMT
                            RecRpt!BREFLOT = !REFLOT
                            RecRpt!SREFLOT = !REFLOT
                            If TRec!EXCHANGECODE = "NSE" And TRec!LOTWISE = "Y" Then
                                RecRpt!CALVAL = !TRADEABLELOT
                            Else
                                RecRpt!CALVAL = !lot
                            End If
                            RecRpt.Update
                        End If
                    End If
                    .MoveNext
                Loop
            End With
        End If
        Set TRec = Nothing
        RecRpt.Sort = "PARTYNAME,SAUDACODE"
        'CLOSING
    Else
        Call CreateRec_Cont
        Dim LPartyRec As ADODB.Recordset
        Set LPartyRec = Nothing
        mysql = "SELECT ACCID,AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID  IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  AC_CODE IN (" & LSParties & ") "
        mysql = mysql & " AND  ACCID  IN (SELECT DISTINCT ACCID  FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
        mysql = mysql & " AND CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "')"
        mysql = mysql & " ORDER BY NAME"
        Set LPartyRec = New ADODB.Recordset
        LPartyRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not LPartyRec.EOF
            If CreateChk.Value = 1 Then Call CreateRec_Cont
            LAcCode = LPartyRec!AC_CODE
            LACCID = LPartyRec!ACCID
            LPartyName = LPartyRec!NAME
            mysql = "SELECT CD.ORDNO,CD.CONNO,CD.ROWNO1,CD.CONTIME,CD.CONDATE,CD.SAUDA,SU.SAUDAID,SU.MATURITY,I.ITEMCODE,I.ITEMID,I.LOT,I.EXCHANGECODE,I.QTYUNIT,I.PRICEUNIT,"
            mysql = mysql & " I.REGULARLOT,CD.QTY,CD.RATE,CD.CONTYPE,CD.BROKRATE,CD.BROKRATE2,CD.TRANRATE,CD.BROKTYPE,CD.BROKQTY,CD.SRVTAX,SU.TRADEABLELOT,SU.REFLOT,SU.BROKLOT,SU.STRIKEPRICE,SU.INSTTYPE, "
            mysql = mysql & " AC.AC_CODE,AC.NAME,AC.ADD1,AC.CITY,AC.PHONEO,AC.PHONER ,AC.PANNO,AC.MOBILE,AC.FAX,AC.PIN,E.LOTWISE "
            mysql = mysql & " FROM  CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC,EXMAST AS E "
            mysql = mysql & " WHERE AC.COMPCODE  =" & GCompCode & " AND CD.SAUDAID=SU.SAUDAID AND CD.ITEMID =I.ITEMID AND CD.ACCID =AC.ACCID AND AC.ACCID  =" & LACCID & ""
            mysql = mysql & " AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND CD.CONTYPE='B' "
            mysql = mysql & " AND E.EXID =I.EXID"
            If AllSaudas = False And LenB(LSSaudas) Then mysql = mysql & " AND CD.SAUDAID IN (" & LSSaudas & ") "
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  E.EXID IN (" & LSExCodes & ") "
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND SU.INSTTYPE  IN  (" & LSInst & ") "
            If Combo2.ListIndex = 1 Then
                mysql = mysql & " AND CD.DATAIMPORT = 1 "
            ElseIf Combo2.ListIndex = 2 Then
                mysql = mysql & " AND CD.DATAIMPORT = 0 "
            End If
            If Option4.Value = True Then
                mysql = mysql & " AND CD.CONFIRM  = 1 "
            ElseIf Option3.Value = True Then
                mysql = mysql & " AND CD.CONFIRM  = 0 "
            End If
            mysql = mysql & " ORDER BY AC.NAME"
            If Option1.Value = True Then
                mysql = mysql & " , CD.CONDATE,I.EXCHANGECODE,I.ITEMCODE,SU.MATURITY, CD.CONNO"
            ElseIf Option2.Value = True Then
                mysql = mysql & " , I.EXCHANGECODE,I.ITEMCODE,SU.MATURITY,CD.CONDATE,CD.CONNO"
            End If
            Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
            Do While Not TRec.EOF
                LCondate = TRec!Condate
                LSauda = TRec!Sauda
                LSaudaID = TRec!SAUDAID
                lOpQty = Get_CloseQty(LACCID, LSaudaID, LCondate - 1)
                LBalQty = lOpQty
                Do While LSauda = TRec!Sauda
                    RecRpt.AddNew
                    SrNo = SrNo + 1
                    RecRpt!CONTDATE = TRec!Condate:     RecRpt!saudacode = TRec!Sauda
                    RecRpt!SAUDANAME = TRec!Sauda:      RecRpt!ITEMCODE = TRec!ITEMCODE
                    RecRpt!ITEMName = TRec!ITEMCODE:    RecRpt!PARTYCODE = TRec!AC_CODE
                    RecRpt!PARTYNAME = TRec!NAME:       RecRpt!PRTYADD = TRec!ADD1
                    RecRpt!PrtyCity = TRec!City:        RecRpt!PRTYPHN = TRec!PhoneO
                    RecRpt!PhoneR = TRec!PhoneR:        RecRpt!Mobile = TRec!Mobile
                    RecRpt!Fax = TRec!Fax:              RecRpt!Pin = TRec!Pin
                    RecRpt!PANNO = TRec!PANNO:          RecRpt!ctype = TRec!CONTYPE
                    RecRpt!PATTAN = "C":                RecRpt!BQnty = TRec!QTY
                    RecRpt!SQnty = 0
                    RecRpt!BRate = TRec!Rate:           RecRpt!bbrokrate = TRec!brokrate
                    RecRpt!BTRANRATE = TRec!TRANRATE:   RecRpt!bbroktype = TRec!broktype
                    RecRpt!SBROKRATE = IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY):  RecRpt!STRANRATE = TRec!SRVTAX
                    RecRpt!SBROKTYPE = "P":             RecRpt!SrNo = SrNo
                    RecRpt!BCONNO = TRec!CONNO:
                    RecRpt!BCONTIME = TRec!contime:     RecRpt!SCONNO = vbNullString
                    RecRpt!SCONTIME = vbNullString:     RecRpt!exchange = TRec!EXCHANGECODE
                    RecRpt!PRICEUNIT = TRec!PRICEUNIT:  RecRpt!QTYUNIT = TRec!QTYUNIT
                    RecRpt!BORDNO = TRec!ORDNO:         RecRpt!BREGLOT = IIf(IsNull(TRec!REFLOT), 1, TRec!REFLOT)
                    RecRpt!SREGLOT = IIf(IsNull(TRec!REFLOT), 1, TRec!REFLOT)
                    RecRpt!BTRDNO = (TRec!ROWNO1 & vbNullString)
                    RecRpt!STRDNO = vbNullString
                    LBrokQty = TRec!BROKQTY
                    LBrokLot = TRec!BROKLOT
                    LBrokQty2 = 0
                    LBrokType = IIf(IsNull(TRec!broktype), "P", TRec!broktype)
                    LBrokRate = IIf(IsNull(TRec!brokrate), 0, TRec!brokrate)
                    LBrokRate2 = IIf(IsNull(TRec!BROKRATE2), 0, TRec!BROKRATE2)
                    If TRec!EXCHANGECODE = "NSE" And TRec!LOTWISE = "Y" Then
                        RecRpt!CALVAL = TRec!TRADEABLELOT
                    Else
                        RecRpt!CALVAL = TRec!lot
                    End If
                    LCalval = RecRpt!CALVAL
                    If LBrokType = "Z" Then LBrokQty = LBrokLot
                    If LBrokType = "A" Then LBrokQty2 = LBrokLot
                    If LBrokType = "R" Then LBrokQty2 = LBrokLot
                    If (LBrokType = "O" Or LBrokType = "C" Or LBrokType = "A") Then LBrokQty = Get_BrokQty(LBrokType, LBalQty, "B", TRec!QTY)
                    LBalQty = LBalQty + TRec!QTY
                    LBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, LBrokQty, TRec!QTY, TRec!Rate, LCalval, TRec!INSTTYPE, TRec!STRIKEPRICE, LBrokQty2, TRec!TRADEABLELOT, TRec!CONTYPE, "2", TRec!itemid)
                    RecRpt!BROKAMT = LBrokAmt
                    RecRpt!STampamt = 0
                    RecRpt.Update
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
                If TRec.EOF Then Exit Do
            Loop
            ''FOR SOLD QUANTITY
            mysql = "SELECT CD.ORDNO,CD.CONNO,CD.ROWNO1,CD.CONTIME,CD.CONDATE,CD.SAUDAID,CD.SAUDA,SU.MATURITY,I.ITEMCODE,I.ITEMID,I.LOT,I.EXCHANGECODE,I.QTYUNIT,I.PRICEUNIT,"
            mysql = mysql & " I.REGULARLOT,CD.QTY,CD.RATE,CD.BROKRATE,CD.TRANRATE,CD.BROKTYPE,CD.BROKRATE2,CD.CONTYPE,CD.BROKQTY,CD.SRVTAX,SU.TRADEABLELOT,SU.REFLOT, SU.BROKLOT,SU.STRIKEPRICE,SU.INSTTYPE,"
            mysql = mysql & " AC.AC_CODE,AC.NAME,AC.ADD1,AC.CITY,AC.PHONEO ,AC.MOBILE,AC.FAX,AC.PIN,AC.PHONER,AC.PANNO,E.LOTWISE"
            mysql = mysql & " FROM  CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC,EXMAST AS E "
            mysql = mysql & " WHERE AC.COMPCODE =" & GCompCode & "  AND CD.SAUDAID=SU.SAUDAID  AND CD.ITEMID =I.ITEMID  AND AC.ACCID  =" & LACCID & ""
            mysql = mysql & " AND CD.ACCID =AC.ACCID AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
            mysql = mysql & " AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND CD.CONTYPE='S' "
            mysql = mysql & " AND E.EXID =I.EXID"
            If LenB(LSSaudas) > 0 Then mysql = mysql & " AND CD.SAUDAID IN (" & LSSaudas & ") "
            If LenB(LSExCodes) > 0 Then mysql = mysql & " AND  I.EXID IN  (" & LSExCodes & ") "
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
            If Combo2.ListIndex = 1 Then
                mysql = mysql & " AND CD.DATAIMPORT = 1 "
            ElseIf Combo2.ListIndex = 2 Then
                mysql = mysql & " AND CD.DATAIMPORT = 2 "
            End If
            If Option4.Value = True Then
                mysql = mysql & " AND CD.CONFIRM  = 1 "
            ElseIf Option3.Value = True Then
                mysql = mysql & " AND CD.CONFIRM  = 0 "
            End If
            mysql = mysql & " ORDER BY AC.NAME"
            If Option1.Value = True Then
                mysql = mysql & " , CD.CONDATE,I.EXCHANGECODE,I.ITEMCODE,SU.MATURITY,CD.CONNO"
            ElseIf Option2.Value = True Then
                mysql = mysql & " , I.EXCHANGECODE,I.ITEMCODE,SU.MATURITY,CD.CONDATE,CD.CONNO"
            End If
            Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
            Do While Not TRec.EOF
                LCondate = TRec!Condate
                LSauda = TRec!Sauda
                LSaudaID = TRec!SAUDAID
                lOpQty = Get_CloseQty(LACCID, LSaudaID, LCondate - 1)
                LBalQty = lOpQty
                LBrokQty = TRec!BROKQTY
                LBrokLot = TRec!BROKLOT
                LBrokQty2 = 0
                
                Do While LSauda = TRec!Sauda
                    RecRpt.Filter = adFilterNone
                    RecRpt.Filter = "SAUDACODE='" & TRec!Sauda & "' AND PARTYCODE='" & TRec!AC_CODE & "'AND CONTDATE='" & Format(TRec!Condate, "YYYY/MM/DD") & "'"
                    Do While Not RecRpt.EOF
                        LSaudaID = TRec!SAUDAID
                        lOpQty = Get_CloseQty(LACCID, LSaudaID, LCondate - 1)
                        LBalQty = lOpQty
                        LBrokQty = TRec!BROKQTY
                        LBrokLot = TRec!BROKLOT
                        LBrokQty2 = 0
                        LBrokType = TRec!broktype
                        LBrokRate = IIf(IsNull(TRec!brokrate), 0, TRec!brokrate)
                        If Val(RecRpt!SQnty & vbNullString) = 0 Then
                            RecRpt!CONTDATE1 = TRec!Condate:             RecRpt!SQnty = TRec!QTY
                            RecRpt!SRate = TRec!Rate:                    RecRpt!SCONNO = TRec!CONNO
                            RecRpt!SCONTIME = TRec!contime:              RecRpt!SBROKRATE = TRec!brokrate
                            RecRpt!STRANRATE = TRec!TRANRATE:            RecRpt!SBROKTYPE = TRec!broktype
                            RecRpt!SREGLOT = IIf(IsNull(TRec!regularlot), 0, TRec!regularlot) & vbNullString
                            RecRpt!STRDNO = (TRec!ROWNO1 & vbNullString)
                            RecRpt!SBROKRATE = IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY)
                            If TRec!EXCHANGECODE = "NSE" And TRec!LOTWISE = "Y" Then
                                RecRpt!CALVAL = TRec!TRADEABLELOT
                            Else
                                RecRpt!CALVAL = TRec!lot
                            End If
                            LCalval = RecRpt!CALVAL

                            GoTo FLAG1
                        End If
                        RecRpt.MoveNext
                    Loop
                    
                    If RecRpt.EOF Then
                        RecRpt.AddNew
                        SrNo = SrNo + 1
                        RecRpt!CONTDATE = TRec!Condate:         RecRpt!CONTDATE1 = TRec!Condate
                        RecRpt!saudacode = TRec!Sauda:          RecRpt!SAUDANAME = TRec!Sauda
                        RecRpt!ITEMCODE = TRec!ITEMCODE:        RecRpt!ITEMName = TRec!ITEMCODE
                        RecRpt!PARTYCODE = TRec!AC_CODE:        RecRpt!PARTYNAME = TRec!NAME
                        RecRpt!PRTYADD = TRec!ADD1:             RecRpt!PrtyCity = TRec!City
                        RecRpt!PRTYPHN = TRec!PhoneO:           RecRpt!PhoneR = TRec!PhoneR
                        RecRpt!Mobile = TRec!Mobile:            RecRpt!Fax = TRec!Fax
                        RecRpt!Pin = TRec!Pin:                  RecRpt!PANNO = TRec!PANNO
                        RecRpt!ctype = TRec!CONTYPE:            RecRpt!PATTAN = "C"
                        RecRpt!BQnty = 0:                       RecRpt!BRate = 0
                        RecRpt!SQnty = TRec!QTY:                RecRpt!SRate = TRec!Rate
                        RecRpt!BCONNO = vbNullString:           RecRpt!BCONTIME = vbNullString
                        RecRpt!SCONNO = TRec!CONNO:             RecRpt!SCONTIME = TRec!contime
                        RecRpt!SBROKRATE = TRec!brokrate:       RecRpt!STRANRATE = TRec!TRANRATE
                        RecRpt!SBROKTYPE = TRec!broktype:       RecRpt!exchange = TRec!EXCHANGECODE
                        RecRpt!PRICEUNIT = TRec!PRICEUNIT:      RecRpt!QTYUNIT = TRec!QTYUNIT
                        RecRpt!BORDNO = TRec!ORDNO:             RecRpt!BREGLOT = IIf(IsNull(TRec!REFLOT), 1, TRec!REFLOT)
                        RecRpt!SREGLOT = IIf(IsNull(TRec!REFLOT), 1, TRec!REFLOT)
                        RecRpt!SrNo = SrNo:
                        RecRpt!STRDNO = (TRec!ROWNO1 & vbNullString)
                        RecRpt!BTRDNO = vbNullString
                        LBrokRate = IIf(IsNull(TRec!brokrate), 0, TRec!brokrate)
                        LBrokRate2 = IIf(IsNull(TRec!BROKRATE2), 0, TRec!BROKRATE2)
                        LBrokType = TRec!broktype
                        If TRec!EXCHANGECODE = "NSE" And TRec!LOTWISE = "Y" Then
                            RecRpt!CALVAL = TRec!TRADEABLELOT
                        Else
                            RecRpt!CALVAL = TRec!lot
                        End If
                         LCalval = RecRpt!CALVAL
                    End If
FLAG1:
                    If LBrokType = "Z" Then LBrokQty = LBrokLot
                    If LBrokType = "A" Then LBrokQty2 = LBrokLot
                    If LBrokType = "R" Then LBrokQty2 = LBrokLot
                    If (LBrokType = "O" Or LBrokType = "C" Or LBrokType = "A") Then LBrokQty = Get_BrokQty(LBrokType, LBalQty, "B", TRec!QTY)
                    LBalQty = LBalQty + TRec!QTY
                    LBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, LBrokQty, TRec!QTY, TRec!Rate, LCalval, TRec!INSTTYPE, TRec!STRIKEPRICE, LBrokQty2, TRec!TRADEABLELOT, TRec!CONTYPE, "2", TRec!itemid)
                    RecRpt!STampamt = LBrokAmt
                    RecRpt.Update
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
                If TRec.EOF Then Exit Do
            Loop
            Set TRec = Nothing
            If CreateChk.Value = 1 Then
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset:    Set TRec = RecRpt.Clone
                mysql = "Contract Register From " & vcDTP1.Value & " To " & vcDTP2.Value & ""
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CONTREG.RPT", 1)
                RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
                RDCREPO.DiscardSavedData
                RDCREPO.Database.SetDataSource TRec
                RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
                RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\CONTREG-" & LPartyName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
                RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
                RDCREPO.ExportOptions.PDFExportAllPages = True
                RDCREPO.Export False
            End If
            LPartyRec.MoveNext
        Loop
        mysql = "Contract Register From " & vcDTP1.Value & " To " & vcDTP2.Value & ""
    End If
    If CreateChk.Value = 0 Then
        Set TRec = Nothing:    Set TRec = New ADODB.Recordset:    Set TRec = RecRpt.Clone
        If Check4.Value = 1 Then
            mysql = "Net Position From " & vcDTP1.Value & " To " & vcDTP2.Value & ""
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "NetPosition.RPT", 1)
        Else
            If Option1.Value = True Then
                If Combo1.ListIndex = 0 Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CONTREG-DATE.RPT", 1)
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CONTREG-DATE-SUMM.RPT", 1)
                End If
            ElseIf Option2.Value = True Then
                If Combo1.ListIndex = 0 Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CONTREG.RPT", 1)
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CONTREG-SUMM.RPT", 1)
                End If
            End If
        End If
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
        mysql = "'Trade Register From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
        CRViewer1.ZOrder
        CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True
        CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
        Me.MousePointer = 0
    Else
        MsgBox "Report Exported Successfully  "
    End If
    Frame2.Enabled = True
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
End Sub
Sub TURNOVER_REPORT()
    Dim LParty As String:    Dim LSauda As String:    Dim LItemCode As String
    Dim lOpQty As Double:    Dim lOpRate As Double:   Dim LOpAmt As Double:           Dim LCloseRate As Double
    Dim LSaudaID As Long:    Dim LADD As Boolean:     Dim TRec As ADODB.Recordset:    Dim LExCode As String
    Dim LACCID As Long
    
    LSExCodes = Get_ExCodes:    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSInst = Get_Inst
    
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "LCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "LNAME", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "BUYQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BUYRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SELLQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SELLRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CLRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "OPQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "OPRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    If Combo1.ListIndex = 0 Then
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "ITEMCODE", adVarChar, 30, adFldIsNullable
        RecRpt.Fields.Append "BUYQTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BUYAMT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SELLQTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SELLAMT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
            mysql = "SELECT C.EXCODE,C.ITEMCODE,  C.CONTYPE, SUM(C.QTY) AS TOTALQTY, SUM(C.RATE * C.CALVAL * C.QTY)AS TOTAL FROM CTR_D AS C "
            mysql = mysql & " WHERE C.COMPCODE=" & GCompCode & " AND C.PATTAN <>'O' "
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND C.EXID IN (" & LSExCodes & ")"
            If AllSaudas = False Then mysql = mysql & " AND C.SAUDAID IN(" & LSSaudas & ") "
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  C.INSTTYPE  IN  (" & LSInst & ") "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND C.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND C.PARTY IN (" & LSParties & ") "
            mysql = mysql & " AND C.CONDATE >= '" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND C.CONDATE <= '" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' "
            mysql = mysql & " GROUP BY C.EXCODE, C.ITEMCODE, C.CONTYPE  "
            mysql = mysql & " ORDER BY C.EXCODE,C.ITEMCODE,  C.CONTYPE  "
    ElseIf Combo1.ListIndex = 1 Then
            mysql = "SELECT A.NAME,C.EXCODE,C.CONTYPE,SUM(C.QTY)AS TQTY ,SUM(C.RATE * C.CALVAL * C.QTY) AS TAMT FROM ACCOUNTD AS A, CTR_D AS C "
            mysql = mysql & " WHERE C.COMPCODE=" & GCompCode & " AND C.PATTAN <>'O' AND C.ACCID = A.ACCID "
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND C.EXID IN (" & LSExCodes & ")"
            If AllSaudas = False Then mysql = mysql & " AND C.SAUDAID IN(" & LSSaudas & ") "
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  C.INSTTYPE  IN  (" & LSInst & ") "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND A.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ") "
            mysql = mysql & " AND C.CONDATE >= '" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND C.CONDATE <= '" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' "
            mysql = mysql & "  GROUP BY A.NAME,C.EXCODE,C.CONTYPE "
            mysql = mysql & "  ORDER BY A.NAME,C.EXCODE,C.CONTYPE "
    ElseIf Combo1.ListIndex = 3 Then
            mysql = "SELECT A.NAME,C.EXCODE,C.CONDATE,C.CONTYPE,SUM(C.RATE * C.CALVAL * C.QTY) AS TOTAL FROM ACCOUNTD AS A ,CTR_D AS C "
            mysql = mysql & " WHERE A.COMPCODE = " & GCompCode & "  AND C.ACCID = A.ACCID  "
            mysql = mysql & " AND  C.CONDATE >= '" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND C.CONDATE <= '" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND C.EXID IN (" & LSExCodes & ")"
            If AllSaudas = False Then mysql = mysql & " AND C.SAUDAID IN(" & LSSaudas & ") "
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  C.INSTTYPE  IN  (" & LSInst & ") "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND A.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID  IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ") "
            mysql = mysql & " GROUP BY A.NAME,C.EXCODE,C.CONDATE,C.CONTYPE"
            mysql = mysql & " ORDER BY A.NAME,C.EXCODE,C.CONDATE,C.CONTYPE"
    Else
            mysql = "SELECT A.AC_CODE,A.NAME,C.EXCODE,C.SAUDA,C.SAUDAID,C.ITEMCODE,C.CONTYPE,C.CALVAL,SUM(C.QTY)AS TOTQTY ,SUM(C.RATE * C.CALVAL * C.QTY) AS TOTAMT "
            mysql = mysql & " FROM ACCOUNTD AS A, CTR_D AS C WHERE A.COMPCODE=" & GCompCode & " "
            mysql = mysql & " AND C.PATTAN <> 'O' "
            mysql = mysql & " AND C.ACCID = A.ACCID "
            mysql = mysql & " AND C.CONDATE >= '" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND C.CONDATE <= '" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND C.EXID IN (" & LSExCodes & ")"
            If AllSaudas = False Then mysql = mysql & " AND C.SAUDAID IN(" & LSSaudas & ") "
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  C.INSTTYPE  IN  (" & LSInst & ") "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND A.ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ") "
            mysql = mysql & " GROUP BY A.AC_CODE,A.NAME,C.EXCODE,C.SAUDA,C.SAUDAID,C.ITEMCODE,C.CONTYPE,C.CALVAL"
            mysql = mysql & " ORDER BY A.AC_CODE,A.NAME,C.EXCODE,C.SAUDA,C.CONTYPE"
    End If
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        If Combo1.ListIndex = 0 Then
            Do While Not TRec.EOF
                LItemCode = TRec!ITEMCODE
                Do While TRec!ITEMCODE = LItemCode
                    If TRec!CONTYPE = "B" Then
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "ITEMCODE ='" & TRec!ITEMCODE & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!ITEMCODE = TRec!ITEMCODE
                            RecRpt!excode = TRec!excode
                            RecRpt!BUYQTY = 0
                            RecRpt!SELLQTY = 0
                            RecRpt!BUYAMT = 0
                            RecRpt!SELLAMT = 0
                        End If
                        RecRpt!BUYQTY = TRec!TOTALQTY
                        RecRpt!BUYAMT = TRec!TOTAL
                        RecRpt.Update
                    Else
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "ITEMCODE ='" & TRec!ITEMCODE & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!ITEMCODE = TRec!ITEMCODE
                            RecRpt!excode = TRec!excode
                            RecRpt!BUYQTY = 0
                            RecRpt!SELLQTY = 0
                            RecRpt!BUYAMT = 0
                            RecRpt!SELLAMT = 0
                        End If
                        RecRpt!SELLQTY = TRec!TOTALQTY
                        RecRpt!SELLAMT = TRec!TOTAL
                        RecRpt.Update
                    End If
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
                If TRec.EOF Then Exit Do
            Loop
            RecRpt.Filter = adFilterNone
            Set TRec = Nothing:            Set TRec = New ADODB.Recordset
            Set TRec = RecRpt.Clone
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ITEMturnover.rpt", 1)
        ElseIf Combo1.ListIndex = 1 Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "turnover.rpt", 1)
        ElseIf Combo1.ListIndex = 3 Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "datewiseturnover.rpt", 1)
        Else
            Do While Not TRec.EOF
                LADD = False:      lOpQty = 0:  lOpRate = 0:    LOpAmt = 0:
                LParty = TRec!AC_CODE
                LSauda = TRec!Sauda
                LExCode = TRec!excode
                LSaudaID = TRec!SAUDAID
                lOpQty = Get_CloseQty(LACCID, LSaudaID, vcDTP1.Value - 1)
                If lOpQty <> 0 Then
                    lOpRate = SDCLRATE(LSaudaID, vcDTP1.Value, "O")
                    LOpAmt = lOpRate * lOpQty * TRec!CALVAL
                End If
                Do While LParty = TRec!AC_CODE And LSauda = TRec!Sauda
                    LCloseRate = SDCLRATE(LSaudaID, vcDTP2.Value, "C")
                    If TRec!CONTYPE = "B" Then
                        LADD = True
                        RecRpt.AddNew
                        RecRpt!LCode = TRec!AC_CODE:                        RecRpt!LName = TRec!NAME
                        RecRpt!saudacode = TRec!Sauda:
                        RecRpt!excode = LExCode
                        RecRpt!ITEMCODE = TRec!ITEMCODE:
                        RecRpt!BUYQTY = TRec!TotQty:                        RecRpt!BuyRATE = TRec!TotAmt
                        RecRpt!SELLQTY = 0
                        RecRpt!SellRATE = 0:
                        RecRpt!ClRate = LCloseRate:                         RecRpt!CALVAL = TRec!CALVAL
                        RecRpt!OpQty = lOpQty:                              RecRpt!OPRATE = lOpRate
                        RecRpt.Update
                    Else
                        If LADD = True Then
                            LADD = False
                            RecRpt!SELLQTY = TRec!TotQty:         RecRpt!SellRATE = TRec!TotAmt
                            RecRpt.Update
                        Else
                            LADD = True
                            RecRpt.AddNew
                            RecRpt!LCode = TRec!AC_CODE:                            RecRpt!LName = TRec!NAME
                            RecRpt!saudacode = TRec!Sauda:
                            RecRpt!excode = LExCode
                            RecRpt!ITEMCODE = TRec!ITEMCODE:
                            RecRpt!BUYQTY = 0:                                      RecRpt!BuyRATE = 0
                            RecRpt!SELLQTY = TRec!TotQty
                            RecRpt!SellRATE = TRec!TotAmt
                            RecRpt!ClRate = LCloseRate:                             RecRpt!CALVAL = TRec!CALVAL
                            RecRpt!OpQty = lOpQty:                                  RecRpt!OPRATE = lOpRate
                            RecRpt.Update
                        End If
                    End If
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
            Loop
            Set TRec = Nothing:            Set TRec = New ADODB.Recordset
            Set TRec = RecRpt.Clone
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "turnover_sauda.rpt", 1)
        End If
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & "Turnover Report From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
        CRViewer1.ZOrder
        CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True
        CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
    Else
            MsgBox "Record does not exists.", vbInformation
    End If
    Me.MousePointer = 0
    OkCmd.Enabled = True
End Sub
Sub DATE_WS_CONT_REG()
    On Error GoTo err1
    Dim BFlag As Boolean:       Dim SFlag As Boolean
    Dim parties As String:      Dim MNSParties As String:    Dim LSauda As String:
    Dim CountJ As Integer:      Dim J As Integer
    Dim SrNo As Long
    Dim TRec As ADODB.Recordset
    
    SrNo = 0
    LSExCodes = Get_ExCodes:    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSInst = Get_Inst
    
    MNSParties = vbNullString: parties = vbNullString: CountJ = 0
    If AllParties = False Then
        For J = 1 To PartyList.ListItems.Count
            If PartyList.ListItems(J).Checked = True Then
                CountJ = CountJ + 1
                parties = parties & "'" & PartyList.ListItems(J).SubItems(1) & "'"
            Else
                MNSParties = MNSParties & "'" & PartyList.ListItems(J).SubItems(1) & "'"
            End If
            If J < PartyList.ListItems.Count Then
                If PartyList.ListItems(J + 1).Checked = True And LenB(parties) > 0 Then
                    parties = parties & ", "
                Else
                    If MNSParties <> "" Then MNSParties = MNSParties & ", "
                End If
            End If
        Next
        If LenB(parties) = 0 Then MsgBox "Please Select Party.", vbCritical:  Exit Sub
    End If
    If LenB(MNSParties) = 0 Then MNSParties = "'0'"
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "CONTDATE", adDate, , adFldIsNullable
    RecRpt.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SAUDANAME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "ITEMNAME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "PARTYNAME", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "PARTYCODE1", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "PARTYNAME1", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CTYPE", adVarChar, 1, adFldIsNullable
    RecRpt.Fields.Append "PATTAN", adVarChar, 1, adFldIsNullable
    RecRpt.Fields.Append "CONTDATE1", adDate, , adFldIsNullable
    RecRpt.Fields.Append "SRNO", adInteger, , adFldIsNullable
    RecRpt.Fields.Append "BCONNO", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "BCONTIME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SCONNO", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SCONTIME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    mysql = "SELECT CD.CONNO,CD.ROWNO1,CD.CONTIME,CD.CONDATE, CD.SAUDA, SU.SAUDANAME, I.ITEMCODE, I.ITEMNAME,CD.QTY,CD.RATE,CD.CONTYPE,CM.PATTAN,"
    mysql = mysql & " AC.AC_CODE, AC.NAME,I.LOT  FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC "
    mysql = mysql & " WHERE CM.COMPCODE =" & GCompCode & " AND CM.COMPCODE =CD.COMPCODE AND   "
    mysql = mysql & " CM.CONSNO=CD.CONSNO AND CD.SAUDAID=SU.SAUDAID AND CD.ITEMID =I.ITEMID AND  "
    mysql = mysql & " CD.ACCID =AC.ACCID AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' "
    If AllSaudas = False Then mysql = mysql & " AND  CD.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    mysql = mysql & " ORDER BY CD.CONDATE, CD.SAUDA,CD.ROWNO"
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Not TRec.EOF Then TRec.MoveFirst
    Do While Not TRec.EOF
        BFlag = True: SFlag = True
        If InStr(MNSParties, "'" & TRec!AC_CODE & "'") <> 0 Then BFlag = False
        If InStr(MNSParties, "'" & TRec!AC_CODE & "'") <> 0 Then SFlag = False
        If BFlag And SFlag Then
            SrNo = SrNo + 1
            LSauda = TRec!Sauda
            Do While LSauda = TRec!Sauda And Not TRec.EOF
                If TRec!CONTYPE = "B" Then
                    RecRpt.Filter = adFilterNone
                    RecRpt.Filter = "SAUDACODE='" & LSauda & "'"
                    If Not RecRpt.EOF Then
                        RecRpt.MoveFirst
                        RecRpt.Find "PARTYCODE=''", , adSearchForward
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!PARTYCODE1 = vbNullString
                        End If
                    Else
                        RecRpt.AddNew
                        RecRpt!PARTYCODE1 = vbNullString
                    End If
                    SrNo = SrNo + 1
                    RecRpt!CONTDATE = TRec!Condate:                    RecRpt!saudacode = TRec!Sauda
                    RecRpt!SAUDANAME = TRec!SAUDANAME:                 RecRpt!ITEMCODE = TRec!ITEMCODE
                    RecRpt!ITEMName = TRec!ITEMName:                   RecRpt!PARTYCODE = TRec!AC_CODE
                    RecRpt!PARTYNAME = TRec!NAME:                      RecRpt!ctype = TRec!CONTYPE
                    RecRpt!PATTAN = TRec!PATTAN:                       RecRpt!BQnty = TRec!QTY
                    RecRpt!BRate = TRec!Rate:                          RecRpt!SrNo = SrNo
                    RecRpt!BCONNO = TRec!ROWNO1:                       RecRpt!BCONTIME = TRec!contime
                    RecRpt!SCONNO = vbNullString:                      RecRpt!SCONTIME = vbNullString
                    RecRpt!CALVAL = TRec!lot
                Else
                    RecRpt.Filter = adFilterNone
                    RecRpt.Filter = "SAUDACODE='" & LSauda & "'"
                    If Not RecRpt.EOF Then
                        RecRpt.MoveFirst
                        RecRpt.Find "PARTYCODE1=''", , adSearchForward
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!PARTYCODE = vbNullString
                        End If
                    Else
                        RecRpt.AddNew
                        RecRpt!PARTYCODE = vbNullString
                    End If
                    SrNo = SrNo + 1
                    RecRpt!CONTDATE = TRec!Condate:                    RecRpt!saudacode = TRec!Sauda
                    RecRpt!SAUDANAME = TRec!SAUDANAME:                 RecRpt!ITEMCODE = TRec!ITEMCODE
                    RecRpt!ITEMName = TRec!ITEMName:                   RecRpt!PARTYCODE1 = TRec!AC_CODE
                    RecRpt!PARTYName1 = TRec!NAME:                     RecRpt!CONTDATE = TRec!Condate
                    RecRpt!SQnty = TRec!QTY:                           RecRpt!SRate = TRec!Rate
                    RecRpt!SCONNO = TRec!ROWNO1:                       RecRpt!CALVAL = TRec!lot
                End If
                RecRpt.Update
                TRec.MoveNext
                If TRec.EOF Then GoTo FLAG1
            Loop
            GoTo X
        End If
        TRec.MoveNext
X:
    Loop
FLAG1:
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    Set TRec = RecRpt.Clone
    If Combo1.ListIndex = 0 Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "DTWSCONT.rpt", 1)
    Else
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "DTWSCONTsmry.rpt", 1)
    End If
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    mysql = "' Date wise Contract Register From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0: OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
End Sub
'Sub Sauda_Wise_Standing()
'On Error GoTo ERR1
'    Dim LPartyName As String:       Dim LItemCode As String:        Dim LFmlyName As String:        Dim LExCode As String:   Dim LPartyCode  As String:  Dim LSaudaCode As String
'    Dim TRec As ADODB.Recordset:    Dim TRec2 As ADODB.Recordset:   Dim MPrvCloseRate  As Double:   Dim LPrevStd As Double:  Dim LPBQnty As Double:      Dim LRegLot As Double
'    Dim LPSQnty As Double:          Dim MQnty As Double:            Dim MASAmt As Double:           Dim MABAmt As Double:    Dim LCloseRate As Double:   Dim MBLQty As Double
'    Dim MNetAmt As Double:          Dim MNetQty As Double:          Dim MBQty As Double:            Dim MSQty As Double:     Dim DCloseRate As Double:   Dim LastClosingDate As Date
'    Dim LastCondate As Date:        Dim LBalQty As Double:          Dim LMDt As Date:               Dim LPQty As Double:     Dim LRate As Double:        Dim LConCode  As String
'    Dim LBrokerName As String:      Dim LSaudaID As Long:          Dim LExID As Integer: Dim LItemID As Integer
'    Dim LCalval As Double
'    LSExCodes = Get_ExCodes:    LSParties = Get_Parties
'    LSSaudas = Get_Saudas:      LSInst = Get_Inst
'
'    Me.MousePointer = Val(11): OkCmd.Enabled = False
'
'    If Option1.Value = True Then  ' Without Avergae Rate
'        MYSQL = "SELECT MAX(CONDATE) AS CONDATE FROM CTR_M WHERE COMPCODE =" & GCompCode & " "
'        If AllSaudas = False Then MYSQL = MYSQL & " AND SAUDAID IN (" & LSSaudas & ")"
'        MYSQL = MYSQL & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
'        Set TRec = Nothing:  Set TRec = New ADODB.Recordset
'        TRec.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
'        If Not TRec.EOF Then
'            If Not IsNull(TRec!Condate) Then LastCondate = TRec!Condate
'        Else
'            LastCondate = vcDTP1.Value
'            MsgBox "No Previous Closing Rates Found."
'        End If
'        MYSQL = "SELECT MAX(CONDATE) AS CONDATE FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
'        If AllSaudas = False Then MYSQL = MYSQL & " AND SAUDAID IN (" & LSSaudas & ")"
'        MYSQL = MYSQL & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
'        Set TRec = Nothing:  Set TRec = New ADODB.Recordset
'        TRec.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
'        If Not TRec.EOF Then
'            If Not IsNull(TRec!Condate) Then
'                If LastCondate <= TRec!Condate Then LastCondate = TRec!Condate
'            End If
'        Else
'            LastCondate = vcDTP1.Value
'            MsgBox "No Previous Closing Rates Found."
'        End If
'        Set TRec = Nothing
'    Else 'with avg Rate
'        MYSQL = "SELECT DISTINCT CONDATE FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
'        If AllSaudas = False And LenB(LSSaudas) > 0 Then MYSQL = MYSQL & " AND SAUDAID IN (" & LSSaudas & ")"
'        MYSQL = MYSQL & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'ORDER BY CONDATE DESC"
'        Set TRec = Nothing:  Set TRec = New ADODB.Recordset
'        TRec.Open MYSQL, Cnn, adOpenKeyset, adLockReadOnly
'        If Not TRec.EOF Then
'            LastCondate = TRec!Condate
'        Else
'            LastCondate = vcDTP1.Value
'            MsgBox "No Previous Closing Rates Found."
'        End If
'        Set TRec = Nothing
'    End If
'    If Option5.Value = True Then ' userid
'        MYSQL = "SELECT IT.EXID,IT.EXCHANGECODE,IT.LOT,IT.ITEMID,IT.ITEMCODE,SU.SAUDAID,SU.SAUDACODE,SU.MATURITY,SU.TRADEABLELOT,CD.USERID,SUM( CASE CONTYPE WHEN 'B' THEN QTY WHEN 'S' THEN QTY*-1 END ) AS SUMOFQTY "
'        MYSQL = MYSQL & " FROM CTR_D AS CD,SAUDAMAST AS SU ,ITEMMAST AS IT "
'        MYSQL = MYSQL & " WHERE CD.COMPCODE = " & GCompCode & " AND CD.COMPCODE =SU.COMPCODE AND CD.COMPCODE=IT.COMPCODE AND  CD.SAUDAID=SU.SAUDAID AND SU.ITEMID= IT.ITEMID "
'        MYSQL = MYSQL & " AND CD.CONDATE <='" & Format(LastCondate, "yyyy/MM/dd") & "' "
'        MYSQL = MYSQL & " AND SU.MATURITY>='" & Format(LastCondate, "yyyy/MM/dd") & "'&" '"
'        If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND IT.EXID IN (" & LSExCodes & ")"
'        If AllSaudas = False And LenB(LSSaudas) > 0 Then MYSQL = MYSQL & " AND CD.SAUDAID IN (" & LSSaudas & ") "
'        If AllSaudas = True And AllInst = False Then MYSQL = MYSQL & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
'        MYSQL = MYSQL & " GROUP BY IT.EXID,IT.EXCHANGECODE,IT.LOT,IT.ITEMID,IT.ITEMCODE,,SU.SAUDAID,SU.SAUDACODE,SU.MATURITY,SU.TRADEABLELOT,CD.USERID"
'        MYSQL = MYSQL & " HAVING SUM(CASE CONTYPE WHEN 'B' THEN QTY * 1 WHEN 'S' THEN QTY*-1 END) <> 0 "
'        MYSQL = MYSQL & " ORDER BY IT.EXID,IT.EXCHANGECODE,IT.ITEMCODE,SU.MATURITY,CD.USERID"
'    Else
'        If Option1.Value = False Then  'with avg rate
'            MYSQL = "SELECT DISTINCT IT.EXID,IT.EXCHANGECODE,IT.ITEMID,IT.ITEMCODE,"
'            MYSQL = MYSQL & " SU.SAUDAID,SU.SAUDACODE,SU.MATURITY,SU.REFLOT,P.NAME,P.AC_CODE,CD.CALVAL"
'            MYSQL = MYSQL & " FROM CTR_D AS CD,SAUDAMAST AS SU,ACCOUNTD AS P,ITEMMAST AS IT "
'            MYSQL = MYSQL & " WHERE CD.COMPCODE = " & GCompCode & " AND CD.COMPCODE =P.COMPCODE  "
'            MYSQL = MYSQL & " AND CD.SAUDAID=SU.SAUDAID  AND SU.ITEMID = IT.ITEMID AND CD.PARTY=P.AC_CODE "
'            MYSQL = MYSQL & " AND CD.CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
'            MYSQL = MYSQL & " AND SU.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
'            If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND IT.EXID  IN (" & LSExCodes & ")"
'            If AllFmly = False And LenB(LSFmlyCodes) And AllParties = True > 0 Then
'                MYSQL = MYSQL & " AND P.AC_CODE IN (SELECT PARTY FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYCODE IN (" & LSFmlyCodes & "))"
'            End If
'
'            If AllParties = False And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND P.AC_CODE IN (" & LSParties & ")"
'            If AllSaudas = False And LenB(LSSaudas) > 0 Then MYSQL = MYSQL & " AND CD.SAUDAID IN (" & LSSaudas & ") "
'            If AllSaudas = True And AllInst = False Then MYSQL = MYSQL & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
'            MYSQL = MYSQL & " ORDER BY IT.EXID,IT.EXCHANGECODE,IT.ITEMCODE,SU.MATURITY,SU.SAUDAID,P.NAME"
'        Else
'            If Check9.Value = 0 Then
'                MYSQL = "SELECT IT.EXID,IT.EXCHANGECODE,IT.ITEMID,IT.ITEMCODE,"
'                MYSQL = MYSQL & " SU.SAUDAID,SU.SAUDACODE,SU.REFLOT,SU.MATURITY,P.NAME,P.AC_CODE,CD.CALVAL,SUM( CASE CONTYPE WHEN 'B' THEN QTY WHEN 'S' THEN QTY*-1 END ) AS SUMOFQTY "
'            Else
'                MYSQL = "SELECT IT.EXID,IT.EXCHANGECODE,IT.ITEMID,IT.ITEMCODE,"
'                MYSQL = MYSQL & " SU.SAUDAID,SU.SAUDACODE,SU.REFLOT,P.NAME,P.AC_CODE,CD.CONCODE,CD.CALVAL,AD.NAME AS BROKER,SUM( CASE CONTYPE WHEN 'B' THEN QTY WHEN 'S' THEN QTY*-1 END ) AS SUMOFQTY "
'            End If
'            'MYSQL = "SELECT C.PARTY,S.SAUDAID,S.REFLOT,S.SAUDACODE,S.ITEMCODE,S.EXCODE ,C.CALVAL , SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY WHEN 'S' THEN C.QTY*-1 END ) AS SUMOFQTY"
'            'MYSQL = MYSQL & " From CTR_D AS C , SAUDAMAST AS S WHERE C.COMPCODE =" & GCompCode & " AND C.CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
'            'MYSQL = MYSQL & " AND C.SAUDAID=S.SAUDAID AND S.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
'            'If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND S.EXID  IN (" & LSExCodes & ")"
'            'If (AllParties = False Or AllFmly = False) And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND C.PARTY IN (" & LSParties & ")"
'            'If AllSaudas = False And LenB(LSSaudas) > 0 Then MYSQL = MYSQL & " AND S.SAUDAID IN (" & LSSaudas & ") "
'            'If AllSaudas = True And AllInst = False Then MYSQL = MYSQL & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
'            ''MYSQL = MYSQL & " GROUP BY C.PARTY,S.SAUDAID "
'            'MYSQL = MYSQL & " HAVING SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY * 1 WHEN 'S' THEN C.QTY*-1 END) <> 0"
'            'MYSQL = MYSQL & " ORDER BY S.EXCODE,S.SAUDACODE"
'
'            MYSQL = MYSQL & " FROM CTR_D AS CD,SAUDAMAST AS SU,ACCOUNTD AS P ,ITEMMAST AS IT "
'            If Check9.Value = 1 Then MYSQL = MYSQL & " ,ACCOUNTD AS AD"
'            MYSQL = MYSQL & " WHERE CD.COMPCODE = " & GCompCode & " AND CD.COMPCODE =P.COMPCODE AND CD.SAUDAID=SU.SAUDAID  AND SU.ITEMID = IT.ITEMID  "
'            MYSQL = MYSQL & " AND CD.PARTY=P.AC_CODE "
'            If Check9.Value = 1 Then MYSQL = MYSQL & " AND AD.COMPCODE =CD.COMPCODE AND AD.AC_CODE = CD.CONCODE "
'            MYSQL = MYSQL & " AND CD.CONDATE <='" & Format(LastCondate, "yyyy/MM/dd") & "' "
'            MYSQL = MYSQL & " AND SU.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
'            If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND IT.EXID  IN (" & LSExCodes & ")"
'            If (AllParties = False Or AllFmly = False) And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND P.AC_CODE IN (" & LSParties & ")"
'            If AllSaudas = False And LenB(LSSaudas) > 0 Then MYSQL = MYSQL & " AND CD.SAUDAID IN (" & LSSaudas & ") "
'            If AllSaudas = True And AllInst = False Then MYSQL = MYSQL & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
'            If Check9.Value = 0 Then
'                MYSQL = MYSQL & " GROUP BY IT.EXID,IT.EXCHANGECODE,IT.ITEMID,IT.ITEMCODE,SU.SAUDAID,SU.SAUDACODE,SU.REFLOT,SU.MATURITY, P.NAME,P.AC_CODE,CD.CALVAL "
'                MYSQL = MYSQL & " HAVING SUM(CASE CONTYPE WHEN 'B' THEN QTY * 1 WHEN 'S' THEN QTY*-1 END) <> 0 "
'                MYSQL = MYSQL & " ORDER BY IT.EXID,IT.EXCHANGECODE,IT.ITEMCODE, SU.MATURITY,SU.SAUDAID,P.NAME"
'            Else
'                MYSQL = MYSQL & " GROUP BY IT.EXID,IT.EXCHANGECODE,IT.ITEMID,IT.ITEMCODE,SU.SAUDAID,SU.SAUDACODE,SU.REFLOT,P.NAME,P.AC_CODE,CD.CONCODE,CD.CALVAL,AD.NAME "
'                MYSQL = MYSQL & " HAVING SUM(CASE CONTYPE WHEN 'B' THEN QTY * 1 WHEN 'S' THEN QTY*-1 END) <> 0 "
'                MYSQL = MYSQL & " ORDER BY IT.EXID,IT.EXCHANGECODE,IT.ITEMCODE, SU.MATURITY, SU.SAUDAID,P.NAME,AD.NAME"
'            End If
'        End If
'    End If
'    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
'    TRec.Open MYSQL, Cnn, adOpenKeyset, adLockReadOnly
'    Set RecRpt = Nothing
'    Set RecRpt = New ADODB.Recordset
'    RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
'    RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
'    RecRpt.Fields.Append "SPARTY", adVarChar, 100, adFldIsNullable
'    RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
'    RecRpt.Fields.Append "BPARTY", adVarChar, 100, adFldIsNullable
'    RecRpt.Fields.Append "BRATE", adDouble, , adFldIsNullable
'    RecRpt.Fields.Append "SRATE", adDouble, , adFldIsNullable
'    RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
'    RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
'    RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
'    RecRpt.Fields.Append "SFMLY", adVarChar, 100, adFldIsNullable
'    RecRpt.Fields.Append "BFMLY", adVarChar, 100, adFldIsNullable
'    RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
'    RecRpt.Fields.Append "BCODE", adVarChar, 6, adFldIsNullable
'    RecRpt.Fields.Append "SCODE", adVarChar, 6, adFldIsNullable
'    RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
'    'End If
'    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
'    Do While Not TRec.EOF
'        LSaudaCode = TRec!SAUDACODE
'        LSaudaID = TRec!SAUDAID
'        DCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value), "C")
'        MPrvCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value - 1), "O")
'        Do While LSaudaCode = TRec!SAUDACODE
'            LPartyCode = TRec!AC_CODE:            LPartyName = Get_AccountName(LPartyCode)
'            LExCode = TRec!EXCHANGECODE:
'            ';LExID = TRec!EXID
'            LItemCode = TRec!ITEMCODE:            LItemID = TRec!ITEMID
'            LFmlyName = vbNullString:             LRegLot = TRec!REFLOT
'            LCalval = TRec!Calval:
'            LConCode = vbNullString
'            LBrokerName = vbNullString
'            If Check9.Value = 1 Then
'                LConCode = TRec!CONCODE
'                LBrokerName = TRec!BROKER
'            End If
'            MQnty = 0: MASAmt = 0: MABAmt = 0
'            If Option1.Value = False Then MQnty = Get_CloseQty(LPartyCode, LSaudaID, LastCondate)
'            GETMAIN.Label1.Caption = LPartyName & " " & LSaudaCode
'            DoEvents
'            Do While LPartyName = TRec!NAME And LSaudaCode = TRec!SAUDACODE
'                If Option1.Value = True Then
'                    If TRec!SUMOFQTY > 0 Then
'                            MQnty = MQnty + TRec!SUMOFQTY
'                        Else
'                            MQnty = MQnty - Abs(TRec!SUMOFQTY)
'                        End If
'                    End If
'                        TRec.MoveNext
'                        If TRec.EOF Then GoTo FLAG1
'                    Loop
'FLAG1:
'                    If Not RecRpt.EOF Then RecRpt.MoveFirst
'                    If Option3.Value = False Then 'party wise
'                        MBLQty = 0: MNetAmt = 0: MNetQty = 0
'                        If Option1.Value = False Then
'                            If Option2.Value = True Then 'avg rate
'                                If Check3.Value = 1 Then
'                                    MYSQL = "SELECT MAX(SETDATE) AS MDT FROM SETTLE WHERE COMPCODE =" & GCompCode & " AND SETDATE <'" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
'                                    Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
'                                    TRec2.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
'                                    If Not TRec2.EOF Then
'                                        LMDt = IIf(IsNull(TRec2!MDt), GFinBegin, TRec2!MDt)
'                                        LPQty = Get_CloseQty(LPartyCode, LSaudaID, LMDt)
'                                        LRate = SDCLRATE(LSaudaID, DateValue(LMDt), "C")
'                                        MNetAmt = LPQty * LRate
'                                        Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
'                                        MYSQL = "SELECT SUM(CASE CONTYPE WHEN 'B' THEN QTY*RATE WHEN 'S' THEN QTY*RATE*-1 END ) AS AMT FROM CTR_D WHERE"
'                                        MYSQL = MYSQL & " PARTY='" & LPartyCode & "' AND CONDATE >'" & Format(LMDt, "yyyy/MM/dd") & "' AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
'                                        MYSQL = MYSQL & " AND SAUDAID=" & LSaudaID & ""
'                                        TRec2.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
'                                        If Not TRec2.EOF Then
'                                            MNetAmt = Abs(MNetAmt + (IIf(IsNull(TRec2!AMT), 0, TRec2!AMT)))
'                                        End If
'                                    End If
'                                Else
'                                    MBQty = 0:  MSQty = 0
'                                    MABAmt = 0: MASAmt = 0
'                                    LBalQty = Abs(MQnty)
'                                    If LBalQty <> 0 Then
'                                        MYSQL = "SELECT RATE,QTY FROM CTR_D WHERE COMPCODE= " & GCompCode & " AND PARTY='" & LPartyCode & "'"
'                                        MYSQL = MYSQL & " AND CONDATE <='" & Format(LastCondate, "yyyy/MM/dd") & "' "
'                                        If MQnty > 0 Then
'                                            MYSQL = MYSQL & " AND CONTYPE ='B'"
'                                        Else
'                                            MYSQL = MYSQL & " AND CONTYPE ='S'"
'                                        End If
'                                        MYSQL = MYSQL & " AND SAUDA='" & LSaudaCode & "' ORDER BY CONDATE DESC ,CONNO DESC "
'                                        Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
'                                        TRec2.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
'                                        Do While Not TRec2.EOF
'                                            If LBalQty >= TRec2!QTY Then
'                                                MNetAmt = MNetAmt + TRec2!QTY * TRec2!Rate
'                                                LBalQty = LBalQty - TRec2!QTY
'                                            Else
'                                                MNetAmt = MNetAmt + (LBalQty) * TRec2!Rate
'                                                LBalQty = 0
'                                            End If
'                                            If LBalQty = 0 Then Exit Do
'                                            TRec2.MoveNext
'                                        Loop
'                                        Set TRec2 = Nothing
'                                    End If
'                                End If
'                            Else
'                                Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
'                                MYSQL = "SELECT SUM(CASE CONTYPE WHEN 'B' THEN QTY*RATE WHEN 'S' THEN QTY*RATE*-1 END ) AS AMT FROM CTR_D WHERE COMPCODE=" & GCompCode & ""
'                                 MYSQL = MYSQL & " AND PARTY='" & LPartyCode & "' AND CONDATE <='" & Format(LastCondate, "yyyy/MM/dd") & "' "
'                                MYSQL = MYSQL & " AND SAUDAID=" & LSaudaID & ""
'                                TRec2.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
'                                If Not TRec2.EOF Then
'                                    MNetAmt = Abs(IIf(IsNull(TRec2!AMT), 0, TRec2!AMT))
'                                End If
'                            End If
'                        End If
'                        If Round(MQnty, 2) <> 0 Then
'                            RecRpt.Filter = adFilterNone
'                            RecRpt.Filter = "SAUDA='" & LSaudaCode & "' AND BCODE ='" & LPartyCode & "'"
'                            If Not RecRpt.EOF Then
'                                If Round(MQnty, 2) > 0 Then
'                                    If RecRpt!BQnty <> 0 Then
'                                        RecRpt!BQnty = RecRpt!BQnty + MQnty
'                                        RecRpt.Update
'                                    ElseIf RecRpt!SQnty <> 0 Then
'                                        If RecRpt!SQnty >= Abs(MQnty) Then
'                                            RecRpt!SQnty = RecRpt!SQnty - Abs(MQnty)
'                                            RecRpt.Update
'                                        Else
'                                            RecRpt!BQnty = Abs(MQnty) - RecRpt!SQnty
'                                            RecRpt!SQnty = 0
'                                            RecRpt.Update
'                                        End If
'                                    Else
'                                        RecRpt!BQnty = Abs(MQnty)
'                                        RecRpt!SQnty = 0
'                                        RecRpt.Update
'                                    End If
'                                ElseIf Round(MQnty, 2) < 0 Then
'                                    If RecRpt!SQnty <> 0 Then
'                                        RecRpt!SQnty = RecRpt!SQnty + Abs(MQnty)
'                                        RecRpt.Update
'                                    ElseIf RecRpt!BQnty <> 0 Then
'                                        If RecRpt!BQnty > Abs(MQnty) Then
'                                            RecRpt!BQnty = RecRpt!BQnty - Abs(MQnty)
'                                            RecRpt!SQnty = 0
'                                            RecRpt.Update
'                                        Else
'                                            RecRpt!SQnty = Abs(MQnty) - RecRpt!BQnty
'                                            RecRpt!BQnty = 0
'                                            RecRpt.Update
'                                        End If
'                                    Else
'                                        RecRpt!SQnty = Abs(MQnty)
'                                        RecRpt!BQnty = 0
'                                        RecRpt.Update
'                                    End If
'                                End If
'                            Else
'                                RecRpt.AddNew
'                                RecRpt!Sauda = LSaudaCode:      RecRpt!SFMLY = LFmlyName
'                                RecRpt!BPARTY = LPartyName:     RecRpt!BCODE = LPartyCode
'                                RecRpt!EXCODE = LExCode:        RecRpt!SETRATE = DCloseRate
'                                RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRegLot
'                                RecRpt!Calval = LCalval
'                                If Round(MQnty, 2) > 0 Then
'                                    RecRpt!SQnty = 0:               RecRpt!SRate = 0:
'                                    RecRpt!BQnty = Abs(Val(MQnty)): RecRpt!BRate = MNetAmt / Abs(Val(MQnty)):
'                                Else
'                                    RecRpt!SQnty = Abs(Val(MQnty)): RecRpt!SRate = MNetAmt / Abs(Val(MQnty))
'                                    RecRpt!BQnty = 0:               RecRpt!BRate = 0:
'                                End If
'                                RecRpt.Update
'                            End If
'                            RecRpt.Filter = adFilterNone
'                        End If
'                    Else 'saudawise
'                        If Round(MQnty, 2) > 0 Then
'                            RecRpt.Filter = "SAUDA='" & LSaudaCode & "'"
'                            If Not RecRpt.EOF Then
'                                RecRpt.MoveFirst
'                                RecRpt.Find "BCODE='" & LPartyCode & "'", , adSearchForward
'                                If RecRpt.EOF Then
'                                    RecRpt.MoveFirst
'                                    RecRpt.Find "SCODE='" & LPartyCode & "'", , adSearchForward
'                                    If RecRpt.EOF Then
'                                        RecRpt.MoveFirst
'                                        RecRpt.Find "BCODE=''", , adSearchForward
'                                        If RecRpt.EOF Then
'                                            RecRpt.AddNew
'                                            RecRpt!SQnty = 0
'                                            RecRpt!SPARTY = vbNullString
'                                            RecRpt!scode = vbNullString
'                                        End If
'                                        RecRpt!Sauda = LSaudaCode
'                                        RecRpt!BQnty = Abs(Val(MQnty))
'                                        RecRpt!BPARTY = LPartyName
'                                        RecRpt!BCODE = LPartyCode
'                                        RecRpt!BRate = ((MABAmt - MASAmt) / MQnty)
'                                        RecRpt!SETRATE = DCloseRate
'                                        RecRpt!PRVRate = MPrvCloseRate
'                                        RecRpt!REFLOT = LRegLot
'                                        RecRpt.Update
'                                    Else
'                                        If RecRpt!SQnty >= Abs(MQnty) Then
'                                            RecRpt!SQnty = RecRpt!SQnty - Abs(MQnty)
'                                        Else
'                                            LPSQnty = RecRpt!SQnty
'                                            RecRpt!SQnty = 0
'                                            RecRpt!SPARTY = vbNullString
'                                            RecRpt!scode = vbNullString
'                                            RecRpt.Update
'                                            RecRpt.MoveFirst
'                                            RecRpt.Find "BCODE=''", , adSearchForward
'                                            If RecRpt.EOF Then
'                                                RecRpt.AddNew:             RecRpt!SQnty = 0
'                                                RecRpt!SPARTY = vbNullString:        RecRpt!scode = vbNullString
'                                            End If
'                                            RecRpt!Sauda = LSaudaCode:                   RecRpt!BQnty = Abs(Val(MQnty)) - LPSQnty
'                                            RecRpt!BPARTY = LPartyName:                  RecRpt!BCODE = LPartyCode
'                                            RecRpt!BRate = 0:                            RecRpt!SETRATE = DCloseRate
'                                            RecRpt!PRVRate = MPrvCloseRate:              RecRpt!REFLOT = LRegLot
'                                            RecRpt.Update
'                                        End If
'                                   End If
'                                Else
'                                If RecRpt!BQnty <> 0 Then
'                                    RecRpt!BQnty = RecRpt!BQnty + Abs(MQnty)
'                                Else
'                                    If RecRpt!SQnty >= Abs(MQnty) Then
'                                        RecRpt!SQnty = RecRpt!SQnty - Abs(MQnty)
'                                    Else
'                                        RecRpt!BQnty = Abs(MQnty) - RecRpt!SQnty
'                                        RecRpt!SQnty = 0
'                                    End If
'                                End If
'                                    RecRpt.Update
'                                End If
'                            Else
'                                RecRpt.AddNew
'                                RecRpt!SQnty = 0:                            RecRpt!SPARTY = vbNullString
'                                RecRpt!scode = vbNullString:                 RecRpt!Sauda = LSaudaCode
'                                RecRpt!BQnty = Abs(Val(MQnty)):              RecRpt!BPARTY = LPartyName
'                                RecRpt!BCODE = LPartyCode:                   RecRpt!BRate = ((MABAmt - MASAmt) / MQnty)
'                                RecRpt!SETRATE = DCloseRate:                 RecRpt!PRVRate = MPrvCloseRate
'                                RecRpt!REFLOT = LRegLot:                     RecRpt.Update
'                            End If
'                        ElseIf Round(MQnty, 2) < 0 Then
'                            RecRpt.Filter = "SAUDA='" & LSaudaCode & "'"
'                            If Not RecRpt.EOF Then
'                                RecRpt.MoveFirst
'                                RecRpt.Find "BCODE='" & LPartyCode & "'", , adSearchForward
'                                If RecRpt.EOF Then
'                                    RecRpt.MoveFirst
'                                    RecRpt.Find "SCODE='" & LPartyCode & "'", , adSearchForward
'                                    If RecRpt.EOF Then
'                                        RecRpt.MoveFirst
'                                        RecRpt.Find "SCODE=''", , adSearchForward
'                                        If RecRpt.EOF Then
'                                            RecRpt.AddNew:                    RecRpt!BQnty = 0
'                                            RecRpt!BPARTY = vbNullString:     RecRpt!BCODE = vbNullString
'                                        End If
'                                        RecRpt!Sauda = LSaudaCode:                       RecRpt!SQnty = Abs(Val(MQnty))
'                                        RecRpt!SPARTY = LPartyName:                      RecRpt!scode = LPartyCode
'                                        RecRpt!SRate = ((MABAmt - MASAmt) / MQnty):      RecRpt!SETRATE = DCloseRate
'                                        RecRpt!PRVRate = MPrvCloseRate:                  RecRpt!REFLOT = LRegLot
'                                        RecRpt.Update
'                                    Else
'                                        RecRpt!SQnty = RecRpt!SQnty + Abs(MQnty)
'                                   End If
'                                Else
'                                    If RecRpt!BQnty >= Abs(MQnty) Then
'                                        RecRpt!BQnty = RecRpt!BQnty - Abs(Val(MQnty))
'                                    Else
'                                        LPBQnty = RecRpt!BQnty:          RecRpt!BQnty = 0
'                                        RecRpt!BPARTY = vbNullString:    RecRpt!BCODE = vbNullString
'                                        RecRpt.Update
'                                        RecRpt.MoveFirst
'                                        RecRpt.Find "SCODE=''", , adSearchForward
'                                        If RecRpt.EOF Then
'                                            RecRpt.AddNew:                  RecRpt!BQnty = 0
'                                            RecRpt!BPARTY = vbNullString:   RecRpt!BCODE = vbNullString
'                                        End If
'                                        RecRpt!Sauda = LSaudaCode:               RecRpt!SQnty = Abs(Val(MQnty)) - LPBQnty
'                                        RecRpt!SPARTY = LPartyName:              RecRpt!scode = LPartyCode
'                                        RecRpt!BRate = 0:                        RecRpt!SETRATE = DCloseRate
'                                        RecRpt!PRVRate = MPrvCloseRate:          RecRpt!REFLOT = LRegLot
'                                        RecRpt.Update
'                                    End If
'                                End If
'                            Else
'                                RecRpt.AddNew
'                                RecRpt!BQnty = 0:                            RecRpt!BPARTY = vbNullString
'                                RecRpt!BCODE = vbNullString:                 RecRpt!Sauda = LSaudaCode
'                                RecRpt!SQnty = Abs(Val(MQnty)):              RecRpt!SPARTY = LPartyName
'                                RecRpt!scode = LPartyCode:                   RecRpt!SRate = ((MABAmt - MASAmt) / MQnty)
'                                RecRpt!SETRATE = DCloseRate:                 RecRpt!PRVRate = MPrvCloseRate
'                                RecRpt!REFLOT = LRegLot:                     RecRpt.Update
'                            End If
'                        End If
'                    End If
'                    If Check4.Value = 1 Then Call Share_Sauda_Wise_Standing(LPartyCode, LItemCode, LSaudaCode, MQnty, LExCode, DCloseRate, LRegLot, LItemID, MPrvCloseRate)
'                    If TRec.EOF Then GoTo FLAG2
'                Loop
'FLAG2:
'        Loop
'    Set TRec = Nothing
'    Set TRec = New ADODB.Recordset
'    Set TRec = RecRpt.Clone
'    If Option3.Value = False Then
'        If Option4.Value And Option1.Value Then
'            If Check9.Value = 0 Then
'                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT.rpt", 1)
'            Else
'                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CPOUT.rpt", 1)
'            End If
'
'        ElseIf Option4.Value And Option1.Value = False Then
'            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "APOUT.rpt", 1)
'        End If
'        MYSQL = "'Party wise Sauda wise Standing upto " & vcDTP1.Value & "'"
'    Else
'        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MOUT.rpt", 1)
'        MYSQL = "'Sauda wise Party wise Standing upto " & vcDTP1.Value & "'"
'    End If
'    RDCREPO.DiscardSavedData
'    RDCREPO.Database.SetDataSource TRec
'    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
'    RDCREPO.FormulaFields.GetItemByName("TITLE").text = MYSQL
'    CRViewer1.ZOrder
'    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
'    CRViewer1.Visible = True
'    CRViewer1.ReportSource = RDCREPO
'    CRViewer1.Zoom 1
'    CRViewer1.ViewReport
'    Me.MousePointer = 0
'    OkCmd.Enabled = True
'    Exit Sub
'ERR1:
'    If err.Number <> 0 Then
'        MsgBox err.Description, vbCritical, "Error Number : " & err.Number
'        Me.MousePointer = 0
'
'        OkCmd.Enabled = True
'    End If
'End Sub

'Sub Share_Sauda_Wise_Standing(LDParty As String, LDItem As String, LDSauda As String, LDQty As Double, LDExCode As String, PDCloseRate As Double, PDRegLot As Double, PdItemID As Integer, PDPrevCloseRate As Double)
'Dim DREC As ADODB.Recordset:    Dim LPSQnty As Double:  Dim LPBQnty As Double
'Dim LOldQnty As Double:         Dim LPrevStd As Double:
'Dim LSHQTY As Double
'
'MYSQL = "SELECT A.FMLYCODE,A.FMLYHEAD,A.CONTRA_AC,B.PARTY,C.SHRATE,C.UPTOSTDT,D.NAME AS HEADNAME ,E.NAME AS CONTRANAME FROM ACCFMLY AS A, ACCFMLYD AS B,ACCOUNTD AS D ,ACCOUNTD AS E "
'MYSQL = MYSQL & " ,PITSBROK AS C WHERE A.COMPCODE =" & GCompCode & " "
'MYSQL = MYSQL & " AND D.ACCID =A.HEADID AND E.ACCID  =A.CONTRAID And C.SHRATE <> 0 "
'MYSQL = MYSQL & " AND A.FMLYID =B.FMLYID AND B.ACCID =C.ACCID  "
'MYSQL = MYSQL & " AND C.UPTOSTDT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND C.PARTY = '" & LDParty & "' AND C.ITEMID =" & PdItemID & " ORDER BY UPTOSTDT "
'Set DREC = Nothing: Set DREC = New ADODB.Recordset
'DREC.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'If DREC.EOF Then
'    MYSQL = "SELECT A.FMLYCODE,A.FMLYHEAD,A.CONTRA_AC,B.PARTY,C.SHRATE,C.UPTOSTDT,D.NAME AS HEADNAME ,E.NAME AS CONTRANAME FROM ACCFMLY AS A, ACCFMLYD AS B,ACCOUNTD AS D ,ACCOUNTD AS E "
'    MYSQL = MYSQL & " ,PEXSBROK AS C WHERE A.COMPCODE =" & GCompCode & " AND "
'    MYSQL = MYSQL & " AND D.ACCID =A.HEADID AND E.ACCID =A.CONTRAID AND C.SHRATE <> 0 "
'    MYSQL = MYSQL & " AND A.FMLYID =B.FMLYID AND B.ACCID =C.ACCID  AND B.FMLYID =C.FMLYID "
'    MYSQL = MYSQL & " AND C.UPTOSTDT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND C.PARTY = '" & LDParty & "' AND C.EXCODE  ='" & LDExCode & "' ORDER BY UPTOSTDT "
'    Set DREC = Nothing: Set DREC = New ADODB.Recordset
'    DREC.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'End If
'If Option3.Value = False Then
'    Do While Not DREC.EOF
'        If LDQty > 0 Then
'            RecRpt.Filter = adFilterNone
'            RecRpt.Filter = "SAUDA='" & LDSauda & "'"
'            If Not RecRpt.EOF Then
'                RecRpt.MoveFirst
'                RecRpt.Find "BCODE='" & DREC!FMLYHEAD & "'", , adSearchForward
'                If RecRpt.EOF Then
'                    RecRpt.AddNew
'                    RecRpt!Sauda = LDSauda:                    RecRpt!SQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                    RecRpt!BPARTY = DREC!HEADNAME:             RecRpt!BCODE = DREC!FMLYHEAD
'                    RecRpt!SRate = 0:                          RecRpt!SETRATE = PDCloseRate
'                    RecRpt!PRVRate = PDPrevCloseRate:          RecRpt!REFLOT = PDRegLot
'                    RecRpt!BQnty = 0:                          RecRpt.Update
'                Else
'                    If RecRpt!BQnty <> 0 Then
'                        If RecRpt!BQnty >= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            RecRpt!BQnty = RecRpt!BQnty - (Abs(LDQty) * (DREC!SHRATE / 100))
'                            RecRpt.Update
'                        ElseIf RecRpt!BQnty <= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            RecRpt!SQnty = (Abs(LDQty) * (DREC!SHRATE / 100)) - RecRpt!BQnty
'                            RecRpt!BQnty = 0
'                            RecRpt.Update
'                        End If
'                    ElseIf RecRpt!SQnty <> 0 Then
'                        'If RecRpt!SQnty >= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            RecRpt!SQnty = RecRpt!SQnty + ((Abs(LDQty) * (DREC!SHRATE / 100)))
'                            RecRpt.Update
'                        'Else
'                         '   RecRpt!BQnty = ((Abs(LDQty) * (DREC!SHRATE / 100))) + RecRpt!SQnty
'                         '   RecRpt!SQnty = 0
'                         '   RecRpt.Update
'                        'End If
'                    End If
'                End If
'            Else
'                RecRpt.AddNew
'                RecRpt!Sauda = LDSauda:                RecRpt!SQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                RecRpt!BPARTY = DREC!HEADNAME:         RecRpt!BCODE = DREC!FMLYHEAD
'                RecRpt!SRate = 0:                      RecRpt!SETRATE = PDCloseRate
'                RecRpt!PRVRate = PDPrevCloseRate:          RecRpt!REFLOT = PDRegLot
'                RecRpt!BQnty = 0:                      RecRpt.Update
'            End If
'            RecRpt.Filter = adFilterNone
'            RecRpt.Filter = "SAUDA='" & LDSauda & "'"
'            If Not RecRpt.EOF Then
'
'                RecRpt.MoveFirst
'                RecRpt.Find "BCODE='" & DREC!Contra_Ac & "'", , adSearchForward
'                If RecRpt.EOF Then
'                    RecRpt.AddNew
'                    RecRpt!Sauda = LDSauda:                    RecRpt!BQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                    RecRpt!BPARTY = DREC!CONTRANAME:           RecRpt!BCODE = DREC!Contra_Ac
'                    RecRpt!BRate = 0:                          RecRpt!SETRATE = PDCloseRate
'                    RecRpt!PRVRate = PDPrevCloseRate:              RecRpt!REFLOT = PDRegLot
'                    RecRpt!SQnty = 0:                          RecRpt.Update
'                Else
'                    If RecRpt!BQnty <> 0 Then
'                        RecRpt!BQnty = RecRpt!BQnty + (Abs(LDQty) * (DREC!SHRATE / 100))
'                        RecRpt.Update
'                    ElseIf RecRpt!SQnty <> 0 Then
'                        If RecRpt!SQnty >= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            RecRpt!SQnty = RecRpt!SQnty - ((Abs(LDQty) * (DREC!SHRATE / 100)))
'                            RecRpt.Update
'                        Else
'                            RecRpt!BQnty = ((Abs(LDQty) * (DREC!SHRATE / 100))) - RecRpt!SQnty
'                            RecRpt!SQnty = 0
'                            RecRpt.Update
'                        End If
'                    End If
'                End If
'            End If
'        Else
'            RecRpt.Filter = adFilterNone
'            RecRpt.Filter = "SAUDA='" & LDSauda & "'"
'            If Not RecRpt.EOF Then
'                RecRpt.MoveFirst
'                RecRpt.Find "BCODE='" & DREC!FMLYHEAD & "'", , adSearchForward
'                If RecRpt.EOF Then
'                    RecRpt.AddNew
'                    RecRpt!Sauda = LDSauda:                    RecRpt!BQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                    RecRpt!BPARTY = DREC!HEADNAME:             RecRpt!BCODE = DREC!FMLYHEAD
'                    RecRpt!SRate = 0:                          RecRpt!SETRATE = PDCloseRate
'                    RecRpt!PRVRate = PDPrevCloseRate:          RecRpt!REFLOT = PDRegLot
'                    RecRpt!SQnty = 0:                          RecRpt.Update
'                Else
'                    If RecRpt!BQnty <> 0 Then
'                        RecRpt!BQnty = RecRpt!BQnty + (Abs(LDQty) * (DREC!SHRATE / 100))
'                        RecRpt.Update
'                    ElseIf RecRpt!SQnty <> 0 Then
'                        If RecRpt!SQnty >= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            LSHQTY = ((Abs(LDQty) * (DREC!SHRATE / 100)))
'                            RecRpt!SQnty = RecRpt!SQnty - LSHQTY
'                            RecRpt.Update
'                        Else
'                            RecRpt!BQnty = ((Abs(LDQty) * (DREC!SHRATE / 100))) - RecRpt!SQnty
'                            RecRpt!SQnty = 0
'                            RecRpt.Update
'                        End If
'                    End If
'                End If
'            Else
'                RecRpt.AddNew
'                RecRpt!Sauda = LDSauda:                RecRpt!BQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                RecRpt!BPARTY = DREC!HEADNAME:         RecRpt!BCODE = DREC!FMLYHEAD
'                RecRpt!SRate = 0:                      RecRpt!SETRATE = PDCloseRate
'                RecRpt!PRVRate = PDPrevCloseRate:          RecRpt!REFLOT = PDRegLot
'                RecRpt!SQnty = 0:                      RecRpt.Update
'            End If
'            RecRpt.Filter = adFilterNone
'            RecRpt.Filter = "SAUDA='" & LDSauda & "'"
'            If Not RecRpt.EOF Then
'                RecRpt.MoveFirst
'                RecRpt.Find "BCODE='" & DREC!Contra_Ac & "'", , adSearchForward
'                If RecRpt.EOF Then
'                    RecRpt.AddNew
'                    RecRpt!Sauda = LDSauda:                    RecRpt!SQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                    RecRpt!BPARTY = DREC!CONTRANAME:           RecRpt!BCODE = DREC!Contra_Ac
'                    RecRpt!BRate = 0:                          RecRpt!SETRATE = PDCloseRate
'                    RecRpt!PRVRate = PDPrevCloseRate:          RecRpt!REFLOT = PDRegLot
'                    RecRpt!BQnty = 0:                          RecRpt.Update
'                Else
'                    If RecRpt!BQnty <> 0 Then
'                        If RecRpt!BQnty <= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            RecRpt!SQnty = (Abs(LDQty) * (DREC!SHRATE / 100)) - RecRpt!BQnty
'                            RecRpt!BQnty = 0
'                            RecRpt.Update
'                        Else
'                            RecRpt!BQnty = RecRpt!BQnty - (Abs(LDQty) * (DREC!SHRATE / 100))
'                            RecRpt.Update
'                        End If
'                    ElseIf RecRpt!SQnty <> 0 Then
'                        'If RecRpt!SQnty <= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            RecRpt!SQnty = RecRpt!SQnty + ((Abs(LDQty) * (DREC!SHRATE / 100)))
'                            RecRpt.Update
'                        'Else
'                        '    RecRpt!BQnty = ((Abs(LDQty) * (DREC!SHRATE / 100))) + RecRpt!SQnty
'                        '    RecRpt!SQnty = 0
'                        '    RecRpt.Update
'                        'End If
'                    End If
'
'                End If
'            End If
'        End If
'        DREC.MoveNext
'    Loop
'Else ' saudawise
'    Do While Not DREC.EOF
'        If LDQty > 0 Then
'            RecRpt.Filter = adFilterNone
'            RecRpt.Filter = "SAUDA='" & LDSauda & "'"
'            If Not RecRpt.EOF Then
'                RecRpt.MoveFirst
'                RecRpt.Find "BCODE='" & DREC!FMLYHEAD & "'", , adSearchForward
'                If RecRpt.EOF Then
'                    RecRpt.MoveFirst
'                    RecRpt.Find "SCODE='" & DREC!FMLYHEAD & "'", , adSearchForward
'                    If RecRpt.EOF Then
'                        RecRpt.MoveFirst
'                        RecRpt.Find "SCODE=''", , adSearchForward
'                        If RecRpt.EOF Then
'                            RecRpt.AddNew
'                            RecRpt!BQnty = 0:          RecRpt!BPARTY = vbNullString:            RecRpt!BCODE = vbNullString
'                        End If
'                        RecRpt!Sauda = LDSauda:              RecRpt!SQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                        RecRpt!SPARTY = DREC!HEADNAME:       RecRpt!scode = DREC!FMLYHEAD
'                        RecRpt!SRate = 0:                    RecRpt!SETRATE = PDCloseRate
'                        RecRpt!PRVRate = PDPrevCloseRate:        RecRpt!REFLOT = PDRegLot
'                        RecRpt.Update
'                    Else
'                        If RecRpt!SQnty <> 0 Then
'                            RecRpt!SQnty = RecRpt!SQnty + (Abs(LDQty) * (DREC!SHRATE / 100))
'                            RecRpt.Update
'                        Else
'                            RecRpt!SQnty = (Abs(LDQty) * (DREC!SHRATE / 100))
'                            RecRpt.Update
'                        End If
'                    End If
'                Else
'                    If RecRpt!BQnty >= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                        RecRpt!BQnty = RecRpt!BQnty - ((Abs(LDQty) * (DREC!SHRATE / 100)))
'                        RecRpt.Update
'                    Else
'                        LPrevStd = RecRpt!BQnty:    RecRpt!BCODE = vbNullString:
'                        RecRpt!BPARTY = vbNullString:         RecRpt!BQnty = 0
'                        RecRpt.Update
'                        RecRpt.MoveFirst
'                        RecRpt.Find "SCODE=''", , adSearchForward
'                        If RecRpt.EOF Then
'                            RecRpt.AddNew
'                            RecRpt!BQnty = 0:                RecRpt!BPARTY = vbNullString:            RecRpt!BCODE = vbNullString
'                            RecRpt.Update
'                        End If
'                        RecRpt!Sauda = LDSauda:              RecRpt!SQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100) - Abs(LPrevStd)
'                        RecRpt!SPARTY = DREC!HEADNAME:       RecRpt!scode = DREC!FMLYHEAD
'                        RecRpt!SRate = 0:                    RecRpt!SETRATE = PDCloseRate
'                        RecRpt!PRVRate = PDPrevCloseRate:        RecRpt!REFLOT = PDRegLot
'                        RecRpt.Update
'                    End If
'                End If
'            Else
'                RecRpt.AddNew:                                               RecRpt!Sauda = LDSauda
'                RecRpt!SQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100):        RecRpt!SPARTY = DREC!HEADNAME
'                RecRpt!scode = DREC!FMLYHEAD:                                RecRpt!SRate = 0
'                RecRpt!SETRATE = PDCloseRate:                                RecRpt!PRVRate = PDPrevCloseRate
'                RecRpt!REFLOT = PDRegLot:                                           RecRpt!BQnty = 0
'                RecRpt.Update
'            End If
'            RecRpt.Filter = adFilterNone
'            RecRpt.Filter = "SAUDA='" & LDSauda & "'"
'            If Not RecRpt.EOF Then
'                RecRpt.MoveFirst
'                RecRpt.Find "BCODE='" & DREC!Contra_Ac & "'", , adSearchForward
'                If RecRpt.EOF Then
'                    RecRpt.MoveFirst
'                    RecRpt.Find "SCODE='" & DREC!Contra_Ac & "'", , adSearchForward
'                    If RecRpt.EOF Then
'                        RecRpt.MoveFirst
'                        RecRpt.Find "BCODE=''", , adSearchForward
'                        If RecRpt.EOF Then
'                            RecRpt.AddNew
'                            RecRpt!SQnty = 0
'                            RecRpt!SPARTY = vbNullString
'                            RecRpt!scode = vbNullString
'                        End If
'                        RecRpt!Sauda = LDSauda
'                        RecRpt!BQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                        RecRpt!BPARTY = DREC!CONTRANAME
'                        RecRpt!BCODE = DREC!Contra_Ac
'                        RecRpt!BRate = 0
'                        RecRpt!SETRATE = PDCloseRate
'                        RecRpt!PRVRate = PDPrevCloseRate
'                        RecRpt!REFLOT = PDRegLot
'                        RecRpt.Update
'                    Else
'                        If RecRpt!SQnty >= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            RecRpt!SQnty = RecRpt!SQnty - ((Abs(LDQty) * (DREC!SHRATE / 100)))
'                            RecRpt.Update
'                        Else
'                            LOldQnty = RecRpt!SQnty
'                            RecRpt!scode = vbNullString
'                            RecRpt!SPARTY = vbNullString
'                            RecRpt!SQnty = 0
'                            RecRpt.Update
'                            RecRpt.MoveFirst
'                            RecRpt.Find "BCODE=''", , adSearchForward
'                            If RecRpt.EOF Then
'                                RecRpt.AddNew
'                                RecRpt!SQnty = 0:          RecRpt!SPARTY = vbNullString:            RecRpt!scode = vbNullString
'                                RecRpt!REFLOT = PDRegLot
'                                RecRpt.Update
'                            End If
'                            RecRpt!Sauda = LDSauda
'                            RecRpt!BQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100) - LOldQnty
'                            RecRpt!BPARTY = DREC!CONTRANAME
'                            RecRpt!BCODE = DREC!Contra_Ac
'                            RecRpt!BRate = 0
'                            RecRpt!SETRATE = PDCloseRate
'                            RecRpt!PRVRate = PDPrevCloseRate
'                            RecRpt!REFLOT = PDRegLot
'
'                            RecRpt.Update
'                        End If
'                    End If
'                Else
'                    RecRpt!BQnty = RecRpt!BQnty + (Abs(LDQty) * (DREC!SHRATE / 100))
'                    RecRpt.Update
'                End If
'            End If
'        Else
'            RecRpt.Filter = adFilterNone
'            RecRpt.Filter = "SAUDA='" & LDSauda & "'"
'            If Not RecRpt.EOF Then
'                RecRpt.MoveFirst
'                RecRpt.Find "BCODE='" & DREC!FMLYHEAD & "'", , adSearchForward
'                If RecRpt.EOF Then
'                    RecRpt.MoveFirst
'                    RecRpt.Find "SCODE='" & DREC!FMLYHEAD & "'", , adSearchForward
'                    If RecRpt.EOF Then
'                        RecRpt.MoveFirst
'                        RecRpt.Find "BCODE=''", , adSearchForward
'                        If RecRpt.EOF Then
'                            RecRpt.AddNew
'                            RecRpt!SQnty = 0
'                            RecRpt!SPARTY = vbNullString
'                            RecRpt!scode = vbNullString
'                        End If
'                        RecRpt!Sauda = LDSauda
'                        RecRpt!BQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                        RecRpt!BPARTY = DREC!HEADNAME
'                        RecRpt!BCODE = DREC!FMLYHEAD
'                        RecRpt!SRate = 0
'                        RecRpt!SETRATE = PDCloseRate
'                        RecRpt!PRVRate = PDPrevCloseRate
'                        RecRpt!REFLOT = PDRegLot
'                        RecRpt.Update
'                    Else
'                        If RecRpt!SQnty >= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                            RecRpt!SQnty = RecRpt!SQnty - ((Abs(LDQty) * (DREC!SHRATE / 100)))
'                            RecRpt.Update
'                        Else
'                            LPSQnty = RecRpt!SQnty
'                            RecRpt!SPARTY = vbNullString
'                            RecRpt!scode = vbNullString
'                            RecRpt!SQnty = 0
'                            RecRpt.Update
'                            RecRpt.MoveFirst
'                            RecRpt.Find "BCODE=''", , adSearchForward
'                            If RecRpt.EOF Then
'                                RecRpt.AddNew
'                                RecRpt!SQnty = 0
'                                RecRpt!SPARTY = vbNullString
'                                RecRpt!scode = vbNullString
'                            End If
'                            RecRpt!Sauda = LDSauda
'                            RecRpt!BQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100) - LPSQnty
'                            RecRpt!BPARTY = DREC!HEADNAME
'                            RecRpt!BCODE = DREC!FMLYHEAD
'                            RecRpt!SRate = 0
'                            RecRpt!SETRATE = PDCloseRate
'                            RecRpt!PRVRate = PDPrevCloseRate
'                            RecRpt!REFLOT = PDRegLot
'                            RecRpt.Update
'                        End If
'                    End If
'                Else
'                    RecRpt!BQnty = RecRpt!BQnty + (Abs(LDQty) * (DREC!SHRATE / 100))
'                    RecRpt.Update
'                End If
'            Else
'                RecRpt.AddNew
'                RecRpt!Sauda = LDSauda
'                RecRpt!BQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                RecRpt!BPARTY = DREC!HEADNAME
'                RecRpt!BCODE = DREC!FMLYHEAD
'                RecRpt!SRate = 0
'                RecRpt!SETRATE = PDCloseRate
'                RecRpt!PRVRate = PDPrevCloseRate
'                RecRpt!REFLOT = PDRegLot
'                RecRpt!SQnty = 0
'                RecRpt.Update
'            End If
'            RecRpt.Filter = adFilterNone
'            RecRpt.Filter = "SAUDA='" & LDSauda & "'"
'            If Not RecRpt.EOF Then
'                RecRpt.MoveFirst
'                RecRpt.Find "BCODE='" & DREC!Contra_Ac & "'", , adSearchForward
'                If RecRpt.EOF Then
'                    RecRpt.MoveFirst
'                    RecRpt.Find "SCODE='" & DREC!Contra_Ac & "'", , adSearchForward
'                    If RecRpt.EOF Then
'                        RecRpt.AddNew
'                        RecRpt!Sauda = LDSauda
'                        RecRpt!SQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                        RecRpt!SPARTY = DREC!CONTRANAME
'                        RecRpt!scode = DREC!Contra_Ac
'                        RecRpt!BRate = 0
'                        RecRpt!SETRATE = PDCloseRate
'                        RecRpt!PRVRate = PDPrevCloseRate
'                        RecRpt!REFLOT = PDRegLot
'                        RecRpt!BQnty = 0
'                        RecRpt!BPARTY = vbNullString
'                        RecRpt!BCODE = vbNullString
'                        RecRpt.Update
'                    Else
'                        RecRpt!SQnty = RecRpt!SQnty + Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                        RecRpt.Update
'                    End If
'                Else
'                    If RecRpt!BQnty >= (Abs(LDQty) * (DREC!SHRATE / 100)) Then
'                        RecRpt!BQnty = RecRpt!BQnty - (Abs(LDQty) * (DREC!SHRATE / 100))
'                        RecRpt.Update
'                    Else
'                        LPrevStd = RecRpt!BQnty
'                        RecRpt!BQnty = 0
'                        RecRpt!BCODE = vbNullString
'                        RecRpt!BPARTY = vbNullString
'                        RecRpt.Update
'                        RecRpt.MoveFirst
'                        RecRpt.Find "SCODE=''", , adSearchForward
'                        If RecRpt.EOF Then
'                            RecRpt.AddNew
'                            RecRpt!Sauda = LDSauda
'                            RecRpt!BQnty = 0
'                            RecRpt!BPARTY = vbNullString
'                            RecRpt!BCODE = vbNullString
'                        End If
'                        RecRpt!SQnty = Abs(Val(LDQty)) * (DREC!SHRATE / 100)
'                        RecRpt!SPARTY = DREC!CONTRANAME
'                        RecRpt!scode = DREC!Contra_Ac
'                        RecRpt!BRate = 0
'                        RecRpt!SETRATE = PDCloseRate
'                        RecRpt!PRVRate = PDPrevCloseRate
'                        RecRpt!REFLOT = PDRegLot
'                        RecRpt.Update
'                        RecRpt!SQnty = (Abs(LDQty) * (DREC!SHRATE / 100)) - LPrevStd
'                    End If
'                End If
'            End If
'        End If
'        DREC.MoveNext
'    Loop
'End If
'End Sub
Sub MSTwise_Standing()
    On Error GoTo err1
    Dim MABRate As Double:    Dim MASRate As Double:    Dim LBAmt As Double:    Dim LSAmt As Double
    
    
    LSParties = Get_Parties:    LSExCodes = Get_ExCodes:    LSSaudas = Get_Saudas:    LSInst = Get_Inst
    Dim TRec As ADODB.Recordset
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "SAUDCODE", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PARTY", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "MATURITY", adDate, , adFldIsNullable
    RecRpt.Fields.Append "CUTQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CUTRATE", adDouble, , adFldIsNullable
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    
    mysql = "SELECT  SU.SAUDANAME,P.NAME,SU.MATURITY,SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY WHEN 'S' THEN C.QTY*-1 END ) AS NETQTY "
    mysql = mysql & " FROM CTR_D AS C ,SAUDAMAST AS SU,ACCOUNTD AS P "
    mysql = mysql & " WHERE C.COMPCODE =" & GCompCode & "  AND C.SAUDAID = SU.SAUDAID "
    mysql = mysql & " AND C.ACCID =P.ACCID  "
    mysql = mysql & " AND SU.MATURITY  >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND P.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND P.AC_CODE IN (" & LSParties & ")"
    If AllSaudas = False Then mysql = mysql & " AND C.SAUDAID IN (" & LSSaudas & ") "
    mysql = mysql & " GROUP BY SU.SAUDANAME,P.NAME,SU.MATURITY "
    mysql = mysql & " HAVING SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY WHEN'S' THEN C.QTY*-1 END )<> 0 "
    mysql = mysql & " ORDER BY P.NAME,SU.SAUDANAME"
    
    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly

    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MSTREPS.rpt", 1)
    mysql = "'Maturitywise Standing Report from " & Format(vcDTP1.Value, "dd/mm/yyyy") & " to " & Format(vcDTP2.Value, "dd/mm/yyyy") & "'"

    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
End Sub
Sub DatewiseStanding()
    On Error GoTo err1
    Dim TRec As ADODB.Recordset
    LSParties = Get_Parties:    LSExCodes = Get_ExCodes:    LSParties = Get_Parties:    LSSaudas = Get_Saudas
    LSInst = Get_Inst
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    mysql = "SELECT A.NAME,S.SAUDACODE,D.CONDATE,D.OPENQTY, D.BUYQTY,D.SELLQTY,D.CLOSEQTY, D.CLOSERATE,S.ITEMCODE "
    mysql = mysql & " FROM ACCOUNTD AS A,SAUDAMAST AS S , DMARGIN AS D WHERE D.COMPCODE=" & GCompCode & " "
    mysql = mysql & " AND  D.ACCID  = A.ACCID AND D.SAUDAID = S.SAUDAID "
    If AllSaudas = False Then mysql = mysql & " AND  D.SAUDAID IN (" & LSSaudas & ")"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID   IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
    mysql = mysql & " AND D.CONDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND D.CONDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    mysql = mysql & " ORDER BY A.NAME,D.CONDATE,S.ITEMCODE,D.MATURITY"
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        mysql = "Datewise Standing Report"
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "DTStand.RPT", 1)
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        CRViewer1.ZOrder
        CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True
        CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
    Else
        MsgBox "No Records"
        Exit Sub
    End If
    Me.MousePointer = 0: OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
    OkCmd.Enabled = True
End Sub

Sub CreateFile()
    Dim TradeLine As String:        Dim LExCode As String:          Dim TxtPath As String
    Dim LAcCode As String:          Dim LItem  As String:           Dim Lmaturity As Date
    Dim LExchangeCode As String:    Dim LEXHCODE  As String:        Dim LConType As String
    Dim LBQty  As Double:           Dim LSQty As Double:            Dim LBal As Double
    Dim Mdt1 As Date:               Dim MDT2 As Date:               Dim MCounter As Long
    Dim TrdRec As ADODB.Recordset:  Dim TRec As ADODB.Recordset:
    Dim LFileFlag As Boolean
    Dim LFileSystemObject As Scripting.FileSystemObject
    Dim LFile As TextStream: Dim MRate As Double
    
    Mdt1 = vcDTP1.Value
    MDT2 = vcDTP2.Value
    
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSBrokers = Get_Brokers
    
    mysql = "SELECT EXCODE FROM EXMAST WHERE COMPCODE =" & GCompCode & " "
    If LenB(LSExCodes) <> 0 Then mysql = mysql & " AND EXID IN (" & LSExCodes & ")"
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    
    If Option1.Value = True Then ' trades
        If Option3.Value Then  'excel 7
            Do While Mdt1 <= MDT2
                LExCode = vbNullString
                MCounter = 1000
                TRec.MoveFirst
                Do While Not TRec.EOF
                    LExCode = TRec!excode
                    mysql = "SELECT CD.PARTY,CD.CONNO,CD.CONTYPE,CD.QTY,CD.CONDATE,CD.RATE, IT.EXHCODE,S.MATURITY, CD.CONCODE  FROM CTR_D AS CD,"
                    mysql = mysql & " SAUDAMAST AS S , ITEMMAST AS IT "
                    mysql = mysql & " WHERE CD.COMPCODE =" & GCompCode & " AND  CD.SAUDAID=S.SAUDAID "
                    mysql = mysql & " AND CD.EXCODE ='" & LExCode & "'AND CD.PARTY <>CD.CONCODE AND  IT.ITEMID =S.ITEMID "
                    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                        mysql = mysql & " AND CD.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
                    End If
                    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND CD.PARTY IN (" & LSParties & ")"
                    If AllSaudas = False Then mysql = mysql & " AND SAUDAID IN (" & LSSaudas & ") "
                    If AllBrokers = False Then mysql = mysql & " AND CONCODE  IN (" & LSBrokers & ") "
                    mysql = mysql & " AND CONDATE ='" & Format(Mdt1, "YYYY/MM/DD") & "'"
                    Set TrdRec = Nothing: Set TrdRec = New ADODB.Recordset
                    TrdRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    DoEvents
                    LFileFlag = False
                    If Not TrdRec.EOF Then
                        Do While Not TrdRec.EOF
                            If LFileFlag = False Then
                                TxtPath = App.Path & "\TRADE\TRD" & LExCode & CStr(Left$(Mdt1, 2)) & CStr(Mid(Mdt1, 4, 2)) & Right$(CStr(Year(Mdt1)), 4) & ".TXT"
                                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                                Set LFile = LFileSystemObject.CreateTextFile(TxtPath, True)
                            End If
                            TradeLine = TrdRec!Condate & "," & TrdRec!EXHCODE & "," & TrdRec!MATURITY & "," & TrdRec!PARTY & "," & TrdRec!CONTYPE & "," & TrdRec!QTY & "," & TrdRec!Rate & "," & TrdRec!CONCODE & ""
                            LFile.WriteLine (TradeLine)
                            MCounter = MCounter + 1
                            TrdRec.MoveNext
                            LFileFlag = True
                        Loop
                    End If
                    TRec.MoveNext
                Loop
                Mdt1 = Mdt1 + 1
            Loop
        Else ' excel 2
            MCounter = 1000
            mysql = "SELECT CD.PARTY,IT.EXHCODE,S.MATURITY,CD.CONDATE,CD.CONTYPE,CD.QTY,CD.RATE "
            mysql = mysql & " FROM CTR_D AS CD,ITEMMAST AS IT, SAUDAMAST AS S  "
            mysql = mysql & " WHERE CD.COMPCODE =" & GCompCode & " AND CD.SAUDAID=S.SAUDAID "
            mysql = mysql & " AND S.ITEMID =IT.ITEMID "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND CD.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND CD.PARTY IN (" & LSParties & ")"
            If AllSaudas = False Then mysql = mysql & " AND SAUDAID IN (" & LSSaudas & ") "
            If AllBrokers = False Then mysql = mysql & " AND CONCODE  IN (" & LSBrokers & ") "
            mysql = mysql & " AND CONDATE> ='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
            mysql = mysql & " ORDER BY CD.CONDATE,CD.PARTY,CD.SAUDA,CD.CONTYPE"
            Set TrdRec = Nothing: Set TrdRec = New ADODB.Recordset
            TrdRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            DoEvents
            LFileFlag = False
            If Not TrdRec.EOF Then
                Do While Not TrdRec.EOF
                    If LFileFlag = False Then
                        TxtPath = App.Path & "\TRADE\" & CStr(Left$(Mdt1, 2)) & CStr(Mid(Mdt1, 4, 2)) & Right$(CStr(Year(Mdt1)), 4) & ".CSV"
                        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                        Set LFile = LFileSystemObject.CreateTextFile(TxtPath, True)
                    End If
                    TradeLine = TrdRec!PARTY & "," & TrdRec!Condate & "," & TrdRec!CONTYPE & "," & TrdRec!EXHCODE & "," & TrdRec!MATURITY & "," & TrdRec!QTY & "," & TrdRec!Rate & ""
                    LFile.WriteLine (TradeLine)
                    MCounter = MCounter + 1
                    TrdRec.MoveNext
                    LFileFlag = True
                Loop
            End If
        End If
    Else 'posiotn opening
        mysql = "SELECT CD.PARTY,CD.CONDATE,IT.EXCHANGECODE,IT.EXHCODE,S.MATURITY,IT.ITEMCODE,CD.CONTYPE,SUM(CD.QTY)AS QNTY "
        mysql = mysql & " FROM CTR_D AS CD,ITEMMAST AS IT, SAUDAMAST AS S"
        mysql = mysql & " Where CD.COMPCODE = " & GCompCode & " And CD.SaudaID = S.SAUDAID And S.ItemID = IT.ItemID"
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND CD.ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND CD.PARTY IN (" & LSParties & ")"
        If AllSaudas = False Then mysql = mysql & " AND CD.SAUDAID IN (" & LSSaudas & ") "
        mysql = mysql & "  AND CONDATE ='" & Format(Mdt1, "YYYY/MM/DD") & "'"
        mysql = mysql & " GROUP BY CD.PARTY,CD.CONDATE,IT.EXCHANGECODE,IT.EXHCODE,IT.ITEMCODE,S.MATURITY,CD.CONTYPE"
        mysql = mysql & " ORDER BY CD.PARTY,CD.CONDATE,IT.EXCHANGECODE,IT.EXHCODE,IT.ITEMCODE,S.MATURITY,CD.CONTYPE"
        Set TrdRec = Nothing
        Set TrdRec = New ADODB.Recordset
        TrdRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        DoEvents
        LFileFlag = False
        If Not TrdRec.EOF Then
            Label15.Caption = CStr(TrdRec!Condate)
            Do While Not TrdRec.EOF
                LAcCode = TrdRec!PARTY
                LItem = TrdRec!ITEMCODE
                Lmaturity = TrdRec!MATURITY
                LExchangeCode = TrdRec!EXCHANGECODE
                LEXHCODE = TrdRec!EXHCODE
                LBQty = 0:                LSQty = 0:                LBal = 0: MRate = 0
                Do While TrdRec!PARTY = LAcCode And TrdRec!ITEMCODE = LItem And TrdRec!MATURITY = Lmaturity
                    If TrdRec!CONTYPE = "B" Then
                        LBQty = LBQty + TrdRec!QNTY
                    Else
                        LSQty = LSQty + TrdRec!QNTY
                    End If
                    TrdRec.MoveNext
                    If TrdRec.EOF Then
                        Exit Do
                    End If
                Loop
                If LBQty = LSQty Then
                    LBal = 0
                Else
                    If LBQty > LSQty Then
                        LBal = LBQty - LSQty
                        LConType = "B"
                    Else
                        LBal = LSQty - LBQty
                        LConType = "S"
                    End If
                End If
                If LBal <> 0 Then
                    If LFileFlag = False Then
                        TxtPath = App.Path & "\TRADE\POS" & LExchangeCode & CStr(Left$(Mdt1, 2)) & CStr(Mid(Mdt1, 4, 2)) & Right$(CStr(Year(Mdt1)), 4) & ".TXT"
                        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                        Set LFile = LFileSystemObject.CreateTextFile(TxtPath, True)
                        LFileFlag = True
                    End If
                    'Closing Rate
                    Set TRec = Nothing:            Set TRec = New ADODB.Recordset
                    mysql = "SELECT CLRATE FROM CTR_R,SAUDAMAST WHERE CTR_R.COMPCODE =" & GCompCode & " AND CTR_R.SAUDAID = SAUDAMAST.SAUDAID AND SAUDAMAST.ITEMCODE = '" & LItem & "' AND MATURITY = '" & Format(Lmaturity, "YYYY/MM/DD") & "' "
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then MRate = Val(TRec!ClRate & "")

                    TradeLine = LAcCode & "," & Lmaturity & "," & LExchangeCode & "," & LEXHCODE & "," & Mdt1 & "," & MRate & " ," & LBal & "," & LConType & ""
                    LFile.WriteLine (TradeLine)
                    MCounter = MCounter + 1
                End If
            Loop
        End If
    End If
    MsgBox "Task over Successfully"
End Sub
Sub Create_Margin_File()
    
    Dim Mdt1 As Date:               Dim MDT2 As Date:                   Dim ldate As String
    Dim TRec As ADODB.Recordset:    Dim DMarginRec As ADODB.Recordset:  Dim LFile As TextStream
    Dim LParty As String:           Dim LExCode As String:              Dim LMemberId As String
    Dim LSauda As String:           Dim LClient As String:              Dim LPtyType As String * 1
    Dim TxtPath As String:          Dim TradeLine As String:            Dim MOpBal As Double
    Dim MBal As Double:             Dim MBal2 As Double:                Dim LMTMBal As Double
    Dim LOthMBal As Double:         Dim LBal As Double:                 Dim TradeDt As Date
    Dim LPeakPer As Double
    Dim LPeakMargin  As Double
    Dim LFileSystemObject As Scripting.FileSystemObject
    Mdt1 = vcDTP1.Value + 1
    MDT2 = vcDTP2.Value
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes
    
    mysql = "SELECT EXCODE,MEMBERID FROM EXMAST WHERE COMPCODE =" & GCompCode & " "
    If LenB(LSExCodes) <> 0 Then mysql = mysql & " AND EXID IN (" & LSExCodes & ")"
    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        LMemberId = IIf(IsNull(TRec!MemberId), "", TRec!MemberId)
        LExCode = TRec!excode
    End If
    
    For TradeDt = vcDTP1.Value To vcDTP2.Value
        mysql = "SELECT * FROM DAILYMARGIN WHERE COMPCODE =" & GCompCode & " AND EXCODE ='" & LExCode & "' AND CONDATE ='" & Format(TradeDt, "YYYY/MM/DD") & "'"
        Set DMarginRec = Nothing:        Set DMarginRec = New ADODB.Recordset
        DMarginRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If LExCode = "MCX" Then
            TxtPath = App.Path & "\MCX_UPLOAD\MCX_MARGIN_" & Right$(CStr(Year(TradeDt)), 4) & CStr(Mid(TradeDt, 4, 2)) & CStr(Left$(TradeDt, 2)) & "_.M01"
        ElseIf LExCode = "UCX" Then
            TxtPath = App.Path & "\UCX_UPLOAD\UCX_MarginReporting_" & LMemberId & "_" & Right$(CStr(Year(TradeDt)), 4) & CStr(Mid(TradeDt, 4, 2)) & CStr(Left$(TradeDt, 2)) & ".01.LIS"
        End If
        If Not TRec.EOF Then
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            Set LFile = LFileSystemObject.CreateTextFile(TxtPath, True)
        End If
        Do While Not DMarginRec.EOF
            If LExCode = "MCX" Then
                ldate = Trim(CStr(Format(DMarginRec!Condate, "DDMMMYYYY")))
            Else
                ldate = Trim(CStr(Format(DMarginRec!Condate, "DDMMYYYY")))
            End If
            LParty = DMarginRec!PARTY
            LClient = DMarginRec!ACEXCODE
            LPtyType = "C"
            If LClient = LMemberId Then LPtyType = "P"
            Set TRec = Nothing:            Set TRec = New ADODB.Recordset
            mysql = "SELECT OP_BAL FROM ACCOUNTM WHERE COMPCODE =" & GCompCode & " AND AC_CODE='" & LParty & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then MOpBal = Val(TRec!OP_BAL & "")
            MBal = MOpBal
            LBal = 0
            LBal = Net_DrCr(LParty, DateValue(DMarginRec!Condate))
            MBal = MBal + LBal
            Set TRec = Nothing: Set TRec = New ADODB.Recordset
            mysql = "EXEC ACSUMVCHS " & GCompCode & ",'" & LParty & "','" & Format(DMarginRec!Condate, "yyyy/MM/dd") & "','" & Format(DMarginRec!Condate, "yyyy/MM/dd") & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then MBal = MBal + IIf(IsNull(TRec!AMT), 0, TRec!AMT)
            Set TRec = Nothing
            MBal2 = MOpBal
            LBal = 0
            LBal = Net_DrCr(LParty, DateValue(DMarginRec!Condate + 2))
            MBal2 = MBal2 + LBal
            If DMarginRec!TOTALMTM < MBal2 Then
                LMTMBal = DMarginRec!TOTALMTM
            Else
                LMTMBal = DMarginRec!TOTALMTM - MBal2
            End If
            If DMarginRec!addmargin < MBal2 + DMarginRec!TOTALMTM + DMarginRec!regmargin Then
                LOthMBal = DMarginRec!addmargin
            Else
                LOthMBal = DMarginRec!addmargin - (MBal2 + DMarginRec!TOTALMTM + DMarginRec!regmargin)
            End If
            If DMarginRec!regmargin < (MBal + DMarginRec!TOTALMTM * -1) Then
                MBal = DMarginRec!regmargin
            Else
                MBal = DMarginRec!regmargin - (MBal + DMarginRec!TOTALMTM)
            End If
            If LPtyType = "P" Then
                MBal = DMarginRec!TOTALMARGIN
                LMTMBal = DMarginRec!TOTALMTM
                LOthMBal = DMarginRec!addmargin
            End If
            LPeakPer = DMarginRec!PEAKPER
            LPeakMargin = DMarginRec!PEAKMARGIN
            
            If LExCode = "MCX" Then
                TradeLine = ldate & "," & LMemberId & "," & DMarginRec!ACEXCODE & "," & DMarginRec!regmargin & "," & DMarginRec!addmargin & "," & DMarginRec!TOTALMTM & ", , ," & Val(LMTMBal) & "," & Val(MBal) & "," & Val(LOthMBal) & "," & Format(Val(LPeakPer), "0.00") & "," & Format(LPeakMargin, "0.00") & "," & Format(LPeakMargin, "0.00") & ",0"
            Else
                TradeLine = ldate & "|" & LMemberId & "|" & DMarginRec!ACEXCODE & "|" & Format(DMarginRec!regmargin, "0.00") & "|" & Format(DMarginRec!addmargin, "0.00") & "|" & Format(DMarginRec!TOTALMTM, "0.00") & "|||" & Format(Val(LMTMBal), "0.00") & "|" & Format(Val(MBal), "0.00") & "|" & Format(Val(LOthMBal), "0.00") & ""
            End If
            LFile.WriteLine (TradeLine)
            DMarginRec.MoveNext
        Loop
    Next
    MsgBox "Task over Successfully"
End Sub
Sub Create_Deposit_file()
    Dim LParty As String
    Dim LFileSystemObject As Scripting.FileSystemObject
    Dim LFile As TextStream:     Dim Mdt1 As Date:               Dim MDT2 As Date:
    Dim LFileFlag As Boolean:    Dim TradeLine As String:        Dim TRec As ADODB.Recordset
    Dim TxtPath As String:       Dim LBal As Double:             Dim MOpBal As Double
    Dim MBal As Double:          Dim LExCode  As String:
    
    Mdt1 = vcDTP1.Value + 1
    MDT2 = vcDTP2.Value
    
    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSParties = Get_Parties:    LExCode = LSExCodes
    
    mysql = "SELECT A.AC_CODE,ACEXCODE,OP_BAL FROM ACCOUNTM A, ACCT_EX B WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID =B.ACCID  AND A.AC_CODE IN (" & LSParties & ")  AND B.EXCODE =" & LExCode & " ORDER BY A.AC_CODE "
    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    LFileFlag = False
    Do While Not TRec.EOF
        LParty = TRec!AC_CODE
        LBal = 0
        MOpBal = TRec!OP_BAL: MBal = MOpBal
        LBal = Net_DrCr(LParty, DateValue(vcDTP2.Value))
        MBal = LBal + MBal
        If LFileFlag = False Then
            If Combo2.ListIndex = 0 Then
                TxtPath = App.Path & "\TRADE\DEPOSIT" & LExCode & CStr(Left$(Mdt1, 2)) & CStr(Mid(Mdt1, 4, 2)) & Right$(CStr(Year(Mdt1)), 4) & "_" & LParty & ".CSV"
            Else
                TxtPath = App.Path & "\TRADE\Collater" & LExCode & CStr(Left$(Mdt1, 2)) & CStr(Mid(Mdt1, 4, 2)) & Right$(CStr(Year(Mdt1)), 4) & "_" & LParty & ".CSV"
            End If
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            Set LFile = LFileSystemObject.CreateTextFile(TxtPath, True)
            LFileFlag = True
        End If
        If Combo2.ListIndex = 0 Then
            If MBal <= 0 Then
                TradeLine = Trim(TRec!ACEXCODE) & "|HO|9|1"
            Else
                TradeLine = Trim(TRec!ACEXCODE) & "|HO,9|" & Trim(CStr(MBal)) & ""
            End If
        Else
            If MBal <= 0 Then
                TradeLine = "MCX|CLIENT|" & Trim(TRec!ACEXCODE) & "|Inward|" & Format(vcDTP2.Value, "dd/mm/yyyy") & "|4|MCX| | |1| |" & Format(vcDTP2.Value, "dd/mm/yyyy") & "|1"
            Else
                TradeLine = "MCX|CLIENT|" & Trim(TRec!ACEXCODE) & "|Inward|" & Format(vcDTP2.Value, "dd/mm/yyyy") & "|4|MCX| | |" & Trim(CStr(MBal)) & "| |" & Format(vcDTP2.Value, "dd/mm/yyyy") & "|1"
            End If
        End If
        LFile.WriteLine (TradeLine)
        TRec.MoveNext
    Loop
    MsgBox "Task over Successfully"
End Sub
Sub MarginRateList()
    Dim TRec As ADODB.Recordset
    Me.MousePointer = 11
    OkCmd.Enabled = False
    LSSaudas = Get_Saudas
    mysql = "SELECT MR.CONDATE,SU.SAUDANAME,MR.IMRATE,MR.EMRATE,MR.AMRATE,TMRATE,ADDLONG,ADDSHORT,SPCASHMGLONG,SPCASHMGSHORT, CR.CLOSERATE,SU.TRADEABLELOT,IT.REGULARLOT*IT.LOT AS REGULARLOT "
    mysql = mysql & " FROM DLYMGN AS MR, SAUDAMAST AS SU, CTR_R AS CR, ITEMMAST AS IT WHERE MR.COMPCODE =" & GCompCode & " AND MR.COMPCODE  = SU.COMPCODE AND IT.COMPCODE =SU.COMPCODE AND IT.ITEMID =SU.ITEMID "
    mysql = mysql & " AND SU.COMPCODE =CR.COMPCODE AND mr.condate = cr.condate AND  MR.SAUDAID = SU.saudaID AND MR.CONDATE >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
    mysql = mysql & " AND MR.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND CR.SAUDAID = SU.SAUDAID AND CR.CONDATE >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
    mysql = mysql & " AND CR.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND MR.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' "
    If AllSaudas = False Then mysql = mysql & " AND MR.SAUDAID IN (" & LSSaudas & ")  ORDER BY MR.CONDATE,SU.SAUDANAME,SU.MATURITY"
    Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Not TRec.EOF Then
        If Option1.Value = True Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MRRateLst.rpt", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MRRateLstValue.rpt", 1)
        End If
        mysql = "Margin Rate List"
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("org").text = "'" & GCompanyName & "'"
        mysql = "'Margin Rate List From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
        CRViewer1.ZOrder
        CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True
        CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
        Me.MousePointer = 0
        OkCmd.Enabled = True
        Exit Sub
err1:
        MsgBox err.Description, vbCritical, "Error Number : " & err.Number
        Me.MousePointer = 0: OkCmd.Enabled = True
    Else
        MsgBox "Record does not exists.", vbInformation
        Me.MousePointer = 0: OkCmd.Enabled = True
    End If
End Sub
Sub Daily_ClientMGn()
    Dim TRec As ADODB.Recordset
    On Error GoTo err1
    LSExCodes = Get_ExCodes
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    mysql = " SELECT I.CONDATE,AC.NAME,I.CLIENT,I.IMARGIN,I.MMARGIN,I.SPMARGIN,I.EXCODE,I.CMARGIN,I.PEAKINITIAL,I.PEAKEXTREME,I.SPREADMARGIN,I.NETBUYPREMIUM,I.SPREADMARGIN "
    mysql = mysql & " FROM ACCOUNTD AS AC, DLYCLMGN AS I"
    mysql = mysql & " WHERE I.COMPCODE  = " & GCompCode & " AND  I.COMPCODE =AC.COMPCODE  AND I.CLIENT  = AC.AC_CODE "
    If LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID IN ( " & LSExCodes & ")"
    mysql = mysql & " AND I.CONDATE>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND I.CONDATE<='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    mysql = mysql & " ORDER BY I.CONDATE,AC.NAME"
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Not TRec.EOF Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "DLYCLMGN.RPT", 1)
        mysql = "'Daily Client Wise Margin From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
        RDCREPO.DiscardSavedData: RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
        CRViewer1.ZOrder: CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True: CRViewer1.ReportSource = RDCREPO: CRViewer1.Zoom 1: CRViewer1.ViewReport
    Else
        MsgBox "No Entries for given Date Range"
    End If
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0:
    OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub

Sub DTMarginList()
    
End Sub

Sub MarginList()
    On Error GoTo err1
    Dim TRec As ADODB.Recordset:    Dim TRec2 As ADODB.Recordset:    Dim mparty As String:           Dim MPartyCode As String
    Dim MOpBal As Double:           Dim MBal As Double:              Dim MMarBal As Double:          Dim LBal As Double
    Dim LCashMarAmt As Double:      Dim LMarAmt As Double:           Dim LAddMarAmt As Double:       Dim LMarType As String
    Dim MFMLYCODE As String:        Dim MFmlyName As String:         Dim MNetBal  As Double:         Dim MItemCode As String
    Dim LMarRate As Double:         Dim LOpFlag As Boolean:          Dim LMarginFlag As Boolean:     Dim LExCode As String
    Dim TRec1 As ADODB.Recordset:   Dim PExBrokRec As ADODB.Recordset
    Dim LMarginRate As Double
    Dim NewRec As ADODB.Recordset
    Dim LSaudaID As Long
    Dim TRATE As ADODB.Recordset
    Dim LSauda As String
    Dim LCalval As Double
    LSParties = Get_Parties:
    ChkCsh = 0
    
    'LSaudas = Get_Saudas:
    LSExCodes = Get_ExCodes
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    If Option4.Value = True Then 'clientwise
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "SAUDA", adVarChar, 35, adFldIsNullable
        RecRpt.Fields.Append "SPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "RATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MType", adVarChar, 2, adFldIsNullable
        RecRpt.Fields.Append "ClBal", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MARBal", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MAMT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "CASHMAMT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "ADDMARAMT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "IMARGIN", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MMARGIN", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PEAKMARGIN", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
        Set TRec = Nothing
        
        mysql = "SELECT D.EXCODE,D.CLIENT,D.IMARGIN,D.MMARGIN,D.SPMARGIN,CMARGIN,PREEXPMARGIN,DELIVERYMARGIN,EXTREMELOSS,"
        mysql = mysql & " D.PEAKMARGIN ,D.NETBUYPREMIUM ,D.SPREADMARGIN ,A.NAME ,A.OP_BAL FROM DLYCLMGN As D, ACCOUNTM AS A  WHERE d.COMPCODE =" & GCompCode & ""
        mysql = mysql & "  AND D.CONDATE  ='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'AND D.ACCID T = A.ACCID  "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND A.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ") "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  D.EXID IN (" & LSExCodes & ")"
        mysql = mysql & " ORDER BY d.CLIENT,d.EXCODE"
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        Do While Not TRec.EOF
            mparty = TRec!NAME: MOpBal = 0: MBal = 0
            MPartyCode = TRec!CLIENT
            LExCode = TRec!excode
            LAddMarAmt = IIf(IsNull(TRec!CMARGIN), 0, TRec!CMARGIN) + IIf(IsNull(TRec!SPMARGIN), 0, TRec!SPMARGIN) + TRec!PREEXPMARGIN + TRec!DELIVERYMARGIN + TRec!NETBUYPREMIUM + TRec!SPREADMARGIN + TRec!EXTREMELOSS
            MOpBal = Val(TRec!OP_BAL & vbNullString)
            MBal = MOpBal:            LBal = 0
            LBal = Net_DrCr(MPartyCode, DateValue(vcDTP1.Value + 1))
            MBal = MBal + LBal
            RecRpt.AddNew
            RecRpt!Sauda = vbNullString:            RecRpt!SPARTY = mparty
            RecRpt!SQnty = 0:                       RecRpt!Rate = 0
            RecRpt!CALVAL = 0:                      RecRpt!MAMT = 0
            RecRpt!MRate = 0:                       RecRpt!MTYPE = vbNullString
            RecRpt!CLBAL = MBal:
            RecRpt!CASHMAMT = 0:                    RecRpt!ADDMARAMT = Abs(LAddMarAmt)
            RecRpt!IMARGIN = Abs(TRec!IMARGIN)
            RecRpt!MMARGIN = Abs(TRec!MMARGIN)
            RecRpt!PEAKMARGIN = Abs(TRec!PEAKMARGIN)
            RecRpt!excode = LExCode
            RecRpt.Update
            TRec.MoveNext
        Loop
        Set TRec = Nothing
    Else
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "SPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "RATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MType", adVarChar, 2, adFldIsNullable
        RecRpt.Fields.Append "ClBal", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MARBal", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MAMT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "CASHMAMT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "ADDMARAMT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "MARGINRATE", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
        mysql = "SELECT AC_CODE,EXCODE,MARTYPE,MARRATE,UPTOSTDT FROM PEXBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' "
        mysql = mysql & " AND " 'INSTTYPE  ='FUT'"
        If ChkCsh = 1 Then
            mysql = mysql & " INSTTYPE  ='CSH'"
        Else
            mysql = mysql & " INSTTYPE  ='FUT' "
        End If
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID  IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND AC_CODE IN (" & LSParties & ") "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND EXID IN (" & LSExCodes & ")"
        mysql = mysql & " ORDER BY AC_CODE,EXCODE,UPTOSTDT"
        Set PExBrokRec = Nothing
        Set PExBrokRec = New ADODB.Recordset
        PExBrokRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        
        LOpFlag = False: MPartyCode = vbNullString
        LMarginFlag = False
        If ChkCsh = 1 Then
            mysql = "SELECT C.EXCODE,A.NAME,A.OP_BAL,C.PARTY,C.SAUDA,C.SAUDAID,C.CONTYPE,C.QTY,C.CALVAL FROM CTR_D As C, ACCOUNTM AS A WHERE C.COMPCODE =" & GCompCode & ""
            mysql = mysql & "  AND A.ACCID = C.ACCID  AND C.CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'  "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND C.ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND C.PARTY  IN (" & LSParties & ") "
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  C.EXID IN (" & LSExCodes & ")"
            mysql = mysql & " ORDER BY A.NAME,C.EXCODE,C.SAUDA"
       Else
            mysql = "SELECT I.EXCODE,A.NAME,A.OP_BAL,I.PARTY,I.SAUDA,I.SAUDAID,I.CLQTY,I.CLRATE,I.CALVAL FROM INV_D As I, ACCOUNTM AS A WHERE I.COMPCODE =" & GCompCode & ""
            mysql = mysql & "  AND A.ACCID = I.ACCID  AND I.STDATE ='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'AND I.CLQTY <>0 "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND A.ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE  IN (" & LSParties & ") "
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  I.EXID IN (" & LSExCodes & ")"
            mysql = mysql & " ORDER BY A.NAME,I.EXCODE,I.SAUDA"
       End If
        Dim MQty, MRate As Double
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            LMarType = "I": LMarRate = 0: MBal = 0
            LMarAmt = 0
            LSaudaID = TRec!SAUDAID
            mparty = TRec!NAME
            LExCode = TRec!excode
            LSauda = TRec!Sauda
            LCalval = TRec!CALVAL
            
            If MPartyCode <> TRec!PARTY Then
                LOpFlag = False
                LMarginFlag = False
            End If
            MPartyCode = TRec!PARTY
            If ChkCsh <> 1 Then
                If (LExCode <> TRec!excode) Then LMarginFlag = False

                MQty = TRec!CLQTY
                MRate = TRec!ClRate
            Else
                Do While TRec!SAUDAID = LSaudaID And TRec!PARTY = MPartyCode And Not TRec.EOF
                    If TRec!CONTYPE = "B" Then
                        MQty = MQty + TRec!QTY
                    Else
                        MQty = MQty - TRec!QTY
                    End If
                    TRec.MoveNext
                    If TRec.EOF Then
                        Exit Do
                    End If
                Loop
                Set TRATE = Nothing
                Set TRATE = New ADODB.Recordset

                mysql = "SELECT CLOSERATE FROM CTR_R WHERE COMPCODE =" & GCompCode & " AND SAUDAID = '" & LSaudaID & "' AND CONDATE = '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
                TRATE.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRATE.EOF Then
                    MRate = TRATE!CLOSERATE
                End If
            End If
            'MPartyCode = TRec!NAME
            'MPartyCode = TRec!party
            'LExCode = TRec!excode
            If Not TRec.EOF Then
                PExBrokRec.Filter = "AC_CODE='" & TRec!PARTY & "' AND EXCODE='" & TRec!excode & "'"
                If Not PExBrokRec.EOF Then
                    LMarType = PExBrokRec!MARTYPE
                    LMarRate = PExBrokRec!MARRATE
                End If
            End If

            If LMarginFlag = False Then
                LMarAmt = Calc_Margin(LMarType, LMarRate, LSauda, vcDTP1.Value, (MQty * -1), MRate, MPartyCode, LCalval, LExCode)
                mysql = "SELECT (IMRATE+EMRATE+AMRATE+SPCASHMGLONG+SPCASHMGSHORT) AS MARGINRATE,ADDLONG,ADDSHORT   FROM DLYMGN WHERE "
                mysql = mysql & " SAUDAID = " & LSaudaID & " AND CONDATE  ='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
                Set NewRec = Nothing: Set NewRec = New ADODB.Recordset
                NewRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If MQty < 0 Then
                    If Not NewRec.EOF Then LMarginRate = Val(NewRec!MarginRate + NewRec!ADDLONG & vbNullString)
                Else
                    If Not NewRec.EOF Then LMarginRate = Val(NewRec!MarginRate + NewRec!ADDSHORT & vbNullString)
                End If
    
            End If
            If LMarType = "C" And LMarginFlag = False Then
                mysql = "SELECT IMARGIN,MMARGIN,SPMARGIN,CMARGIN,PREEXPMARGIN,DELIVERYMARGIN FROM DLYCLMGN WHERE COMPCODE =" & GCompCode & " AND CLIENT='" & TRec!PARTY & "' AND CONDATE ='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' "
                If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND EXID IN (" & LSExCodes & ")"
                Set TRec1 = Nothing:                Set TRec1 = New ADODB.Recordset
                TRec1.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                LMarAmt = 0
                If Not TRec1.EOF Then
                    Do While Not TRec1.EOF
                        LMarAmt = LMarAmt + Val(IIf(IsNull(TRec1!IMARGIN), 0, TRec1!IMARGIN) + IIf(IsNull(TRec1!MMARGIN), 0, TRec1!MMARGIN) + IIf(IsNull(TRec1!SPMARGIN), 0, TRec1!SPMARGIN)) + IIf(IsNull(TRec1!CMARGIN), 0, TRec1!CMARGIN) + TRec1!PREEXPMARGIN + TRec1!DELIVERYMARGIN
                        TRec1.MoveNext
                    Loop
                End If
            End If
            If MQty <> 0 Then
                If LOpFlag = False Then
                    MOpBal = Val(TRec!OP_BAL & vbNullString)
                    MBal = MOpBal:            LBal = 0
                    LBal = Net_DrCr(MPartyCode, DateValue(vcDTP1.Value + 1))
                    MBal = MBal + LBal
                    LOpFlag = True
                End If
                
                If LMarType = "C" Then LMarginFlag = True
                
                mysql = "SELECT PARTYTYPE FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " AND NAME = '" & mparty & "' "
                Set TRec1 = Nothing: Set TRec1 = New ADODB.Recordset
                TRec1.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec1.EOF Then
                    If TRec1!PARTYTYPE = 2 Then
                        LMarAmt = LMarAmt * -1
                    End If
                End If
                RecRpt.AddNew
                RecRpt!Sauda = LSauda:                RecRpt!SPARTY = mparty
                RecRpt!SQnty = MQty * -1:                 RecRpt!Rate = MRate
                RecRpt!CALVAL = LCalval:              RecRpt!MRate = LMarginRate
                RecRpt!MTYPE = LMarType:                  RecRpt!CLBAL = MBal
                RecRpt!CASHMAMT = 0
                RecRpt!ADDMARAMT = 0
                RecRpt!MarginRate = LMarginRate
        
                RecRpt!MAMT = LMarAmt:                    RecRpt.Update
            End If
            If TRec.EOF Then Exit Do
            TRec.MoveNext
        Loop
    End If
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    Set TRec = RecRpt.Clone
    mysql = "'Margin as on  " & vcDTP1.Value & "'"
    If Option1.Value = False Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MrgnSmry.rpt", 1)
    Else
        If Option4.Value = True Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MarginClientWise.rpt", 1)
            'Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MrgnCLDtl.rpt", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MrgnDtl.rpt", 1)
        End If
    End If
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1100)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
    OkCmd.Enabled = True
End Sub

Sub Invoice_Print()
    Dim GPhone As String
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    Call AccRecNew
    Set PartyRec = Nothing
    Set PartyRec = New ADODB.Recordset
    mysql = "SELECT DISTINCT A.ACCID,A.AC_CODE,A.NAME,B.ADD1,B.CITY,B.PANNO,B.GSTIN,A.OP_BAL,B.PIN,B.PHONEO,B.PHONER,B.FAX,B.MOBILE,B.PIN,C.SAUDA,C.INVNO,C.INVDATE,B.PARTYTYPE,B.EMAIL,B.STATE,B.STATECODE,"
    mysql = mysql & " S.INSTTYPE,S.ITEMCODE,S.STRIKEPRICE,S.OPTTYPE,S.MATURITY,I.EXCHANGECODE,I.LOT,S.TRADEABLELOT,S.BROKLOT ,S.SAUDANAME,I.ITEMNAME,I.SCGROUP,S.REFLOT "
    mysql = mysql & " ,C.BILLNO,C.STDATE,C.FROMDATE,C.OPQTY,C.OPRATE,C.OPENDT,C.CLQTY,C.CLRATE,C.DIFFAMT,C.BROKAMT,C.STDAMT,C.TRANAMT,C.BILLAMT,C.SRVAMT,C.STAMPAMT,C.STTTAX,C.CTTAMT,RISKMAMT,C.SEBITAXAMT,C.SBC_TAX_AMT,CGSTAMT,SGSTAMT,IGSTAMT,UTTAMT "
    mysql = mysql & " FROM ACCOUNTM AS A, ACCOUNTD AS B, INV_D AS C, ITEMMAST AS I, SAUDAMAST AS S "
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID =B.ACCID   "
    mysql = mysql & " AND S.ITEMID =I.ITEMID AND S.MATURITY >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
    mysql = mysql & " AND A.ACCID =C.ACCID  AND C.SAUDAID=S.SAUDAID AND C.INVNO<>0 "
    
    mysql = mysql & " AND C.STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND C.STDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  A.AC_CODE  IN (" & LSParties & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    mysql = mysql & " ORDER BY A.NAME,C.INVNO,S.ITEMCODE,S.INSTTYPE,S.MATURITY,C.INVDATE "
    PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If PartyRec.EOF Then
        MsgBox "No Records.", vbCritical:
        Frame2.Enabled = True
        PartyCmd.SetFocus: Exit Sub
    End If
    mysql = "SELECT CONTRACTACC,EXCODE,LOTWISE FROM EXMAST WHERE COMPCODE =" & GCompCode & " "
    Set Rec_ExMast = Nothing: Set Rec_ExMast = New ADODB.Recordset: Rec_ExMast.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    
    Call Invoice_GenerateStatement
    If CreateChk.Value = 1 Then
        MsgBox "Files Exported Successfully"
    Else
        AccRecSet.Filter = adFilterNone
        If AccRecSet.RecordCount > 0 Then
            AccRecSet.Sort = "srno asc"
            AccRecSet.MoveFirst
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "INVOICE.RPT", 1)
            mysql = "'Invoice From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            GPhone = "Ph: " & GCompPhoneO & ", " & GCompPhoneR & "," & GCompMobile & ""
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource AccRecSet
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            RDCREPO.FormulaFields.GetItemByName("GTTL").text = "'" & GCompTitle & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            RDCREPO.FormulaFields.GetItemByName("OPHONE1").text = "'" & GPhone & "'"
            RDCREPO.FormulaFields.GetItemByName("SRVNO").text = "'" & GSrvRegNo & "'"
            
            RDCREPO.FormulaFields.GetItemByName("GPANNO").text = "'" & GPANNo & "'"
           ' RDCREPO.FormulaFields.GetItemByName("CINNO").text = "'" & GCINNo & "'"
            RDCREPO.FormulaFields.GetItemByName("EMAIL").text = "'" & GEmail & "'"
            RDCREPO.FormulaFields.GetItemByName("COMP_GSTIN").text = "'" & GGSTIN & "'"
            RDCREPO.FormulaFields.GetItemByName("SEBI_REG_NO").text = "'" & GSEBIRegNo & "'"
    
            
            If Option4.Value Then
                mysql = "Y"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            ElseIf Option5.Value Then
                mysql = "L"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            Else
                mysql = "N"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            End If
            If Option1.Value Then
                mysql = "Y"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            Else
                mysql = "N"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            End If
            If CreateChk.Value = 1 Then
                If Combo1.ListIndex = 0 Then
                    'RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                    RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                    RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
                    
                ElseIf Combo1.ListIndex = 1 Then
                    'RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
                    RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
                    RDCREPO.ExportOptions.FormatType = crEFTExcel80
                Else
                    RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                    'RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
                    RDCREPO.ExportOptions.FormatType = crEFTExactRichText
                
                End If
                RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
                RDCREPO.ExportOptions.PDFExportAllPages = True
                RDCREPO.Export False
            Else
                CRViewer1.ZOrder
                CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
                CRViewer1.Visible = True
                CRViewer1.ReportSource = RDCREPO
                CRViewer1.Zoom 1
                CRViewer1.ViewReport
            End If
        Else
            MsgBox "Record does not exists.", vbInformation
        End If
    End If
Me.MousePointer = 0
GETMAIN.ProgressBar1.Visible = False
OkCmd.Enabled = True
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub
Sub ACC_STT()

    Dim GPhone As String
    Dim TRec As ADODB.Recordset
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    Call AccRecNew
    GFBroktype = "N"
    
    mysql = "SELECT TOP 1 BROKTYPE FROM PEXBROK WHERE COMPCODE =" & GCompCode & " AND MBROKTYPE='F'"
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then GFBroktype = "Y"
    Set PartyRec = Nothing
    Set PartyRec = New ADODB.Recordset
    
    mysql = "SELECT DISTINCT A.ACCID,A.AC_CODE,A.NAME,A.OP_BAL,"
    mysql = mysql & " B.ADD1,B.CITY,B.PANNO,B.PIN,B.PHONEO,B.PHONER,B.FAX,B.MOBILE,B.STATE,B.STATECODE,B.PIN, B.OPTCUTBROK, B.FUTCUTBROK "
    mysql = mysql & " ,B.SRTAXAPP , B.CTTTYPE, B.PARTYTYPE, B.EMAIL, B.GSTIN, B.RISKMTYPE, B.APPLYON,B.SEBITYPE,B.CGST, B.SGST, B.IGST, B.UTT, S.SAUDACODE ,S.SAUDAID, S.REFLOT,S.BROKLOT"
    mysql = mysql & " ,S.INSTTYPE, I.ITEMCODE, S.STRIKEPRICE,S.OPTTYPE,S.MATURITY,I.LOT,S.TRADEABLELOT,I.RISKMAPP,I.SCGROUP,EX.EXCODE,EX.LOTWISE, EX.CONTRACTACC,EX.EXID,I.ITEMID "
    mysql = mysql & " FROM ACCOUNTM AS A,ACCOUNTD AS B,CTR_D AS C, ITEMMAST AS I,SAUDAMAST AS S ,EXMAST AS EX "
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND  A.ACCID =B.ACCID AND A.ACCID  =C.ACCID AND C.SAUDAID=S.SAUDAID"
    mysql = mysql & " AND EX.EXID=I.EXID  AND S.ITEMID =I.ITEMID AND S.MATURITY >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND C.CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    If (AllFmly = False Or LenB(LSFmlyIDs) > 0) And AllParties = True Then
        mysql = mysql & " AND A.ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE  IN (" & LSParties & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    If AllSaudas = False And Len(LSSaudas) > 0 Then mysql = mysql & " AND S.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " ORDER BY A.NAME,EX.EXCODE,I.ITEMCODE,S.INSTTYPE,S.MATURITY"
    
    
    PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If PartyRec.EOF Then
        MsgBox "No Records.", vbCritical:
        Frame2.Enabled = True
        PartyCmd.SetFocus: Exit Sub
    End If
    
      
    Call NewGenerateStatement1 '>>> original
    
    'Call NewGenerateStatement1_new '>>> updated
    
    If CreateChk.Value = 1 Then
        MsgBox "Files Exported Successfully"
    Else
        AccRecSet.Filter = adFilterNone
        If AccRecSet.RecordCount > 0 Then
            If Check12.Value = 1 Then
                AccRecSet.Sort = "PARTYCODE,CONTDATE,PIN asc"
                AccRecSet.MoveFirst
                '>>> BALANCE RECALCULATE after sorting
                CF_BALANCE = 0
                While Not AccRecSet.EOF
                    If (AccRecSet.Fields("PIN").Value = "A") Then 'opening
                        If AccRecSet.Fields("BRATE").Value > 0 Then
                            CF_BALANCE = (-1) * AccRecSet.Fields("BRATE").Value
                            AccRecSet.Fields("BRATE") = 0
                        ElseIf AccRecSet.Fields("SRATE").Value > 0 Then
                            CF_BALANCE = AccRecSet.Fields("SRATE").Value
                            AccRecSet.Fields("SRATE") = 0
                        End If
                        AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
                    ElseIf (AccRecSet.Fields("PIN").Value = "Z") Then 'VOUCHER
                        If AccRecSet.Fields("CGSTAMT").Value > 0 Then
                            CF_BALANCE = CF_BALANCE + (AccRecSet.Fields("CGSTAMT").Value * -1)
                        ElseIf AccRecSet.Fields("SGSTAMT").Value > 0 Then
                            CF_BALANCE = CF_BALANCE + (AccRecSet.Fields("SGSTAMT").Value)
                        End If
                        AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
                    ElseIf (AccRecSet.Fields("PIN").Value = "B") Or (AccRecSet.Fields("PIN").Value = "S") Then 'TRANSACTION
                        If AccRecSet.Fields("PIN").Value = "B" Then
                            
                            CF_BALANCE = CF_BALANCE + (((AccRecSet.Fields("BQNTY").Value * AccRecSet.Fields("BRATE").Value) * AccRecSet.Fields("CALVAL").Value) * -1) + (AccRecSet.Fields("BBROKAMT").Value * -1)
                        ElseIf AccRecSet.Fields("PIN").Value = "S" Then
                            CF_BALANCE = CF_BALANCE + ((AccRecSet.Fields("BQNTY").Value * AccRecSet.Fields("BRATE").Value)) - AccRecSet.Fields("BBROKAMT").Value
                        End If
                        AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
                    Else
                        AccRecSet.Fields("DRAMOUNT") = 0
                    End If
                    
                    AccRecSet.MoveNext
                Wend
                AccRecSet.MoveFirst
                
            Else
                AccRecSet.Sort = "srno asc"
            End If
            AccRecSet.MoveFirst
               
'            If MFormat = "Account Statement" Then 'new
'                If Option5.Value = 0 And Check9.Value = 0 And Check5.Value = 0 And Check10.Value = 0 Then
'                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT.rpt", 1)
'                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
'                Else
'                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-LST.RPT", 1)
'                    mysql = "'From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
'                End If
'            Else
                If MFormat = "Sauda Summary" Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTSMRY.RPT", 1)
                    mysql = "'Sauda Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                Else
                    If Check10.Value = 1 Then
                        If Option5.Value Then
                            If Check12.Value Then '>>> customized format
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-LST-CF.RPT", 1) '>>> customized format
                            Else
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-LST.RPT", 1)
                            End If
                            mysql = "'From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                        Else
                            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-TST.RPT", 1)
                            mysql = "'From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                        End If
                        
                    ElseIf Check3.Value = 1 Then   '>>> hide brok
                        If Option5.Value = True Then
                            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B-L.RPT", 1)
                            mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                        ElseIf Option4.Value = True Then
                            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B-O.RPT", 1)
                            mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                        Else
                            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B.RPT", 1)
                            mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                        End If
                        
                    Else
                        If Option5.Value = True Then
                        
                            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-LST.rpt", 1)
                            mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                        Else
                            If Check4.Value = 1 Then
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-S.rpt", 1)
                                mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                            Else
                                If Check5.Value = 1 Then
                                    If Check9.Value = 1 Then
                                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-ST-SUMM.rpt", 1)
                                        mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                                    ElseIf Option4.Value = True Then
                                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-STO.rpt", 1)
                                        mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                                    Else
                                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-ST.rpt", 1)
                                        mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                                    End If
                                    
                                Else
                                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT.rpt", 1)
                                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                                End If
                            End If
                        End If
                    End If
                End If
            'End If
            GPhone = "Ph: " & GCompPhoneO & ", " & GCompPhoneR & "," & GCompMobile & ""
            RDCREPO.DiscardSavedData
                                    
            RDCREPO.Database.SetDataSource AccRecSet
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            RDCREPO.FormulaFields.GetItemByName("GTTL").text = "'" & GCompTitle & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & Trim$(GCompanyAdd1) & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            RDCREPO.FormulaFields.GetItemByName("OPHONE1").text = "'" & GPhone & "'"
            RDCREPO.FormulaFields.GetItemByName("SRVNO").text = "'" & GSrvRegNo & "'"
            
            If Option4.Value Then
                mysql = "Y"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            ElseIf Option5.Value Then
                mysql = "L"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            Else
                mysql = "N"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            End If
            If Option1.Value Then
                mysql = "Y"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            Else
                mysql = "N"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            End If
'            If CreateChk.Value = 1 Then
'                If Combo1.ListIndex = 0 Then
'                    RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
'                    RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
'                ElseIf Combo1.ListIndex = 1 Then
'                    RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
'                    RDCREPO.ExportOptions.FormatType = crEFTExcel80
'                Else
'                    RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTT-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
'                    RDCREPO.ExportOptions.FormatType = crEFTExactRichText
'                End If
'                RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
'                RDCREPO.ExportOptions.PDFExportAllPages = True
'                RDCREPO.Export False
'            Else
                CRViewer1.ZOrder
                CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
                CRViewer1.Visible = True
                CRViewer1.ReportSource = RDCREPO
                CRViewer1.Zoom 1
                CRViewer1.ViewReport
          '  End If
        Else
            MsgBox "Record does not exists.", vbInformation
        End If
    End If
    Me.MousePointer = 0
    GETMAIN.ProgressBar1.Visible = False
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    GETMAIN.ProgressBar1.Visible = False
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub

Private Sub Client_Margin()
Dim LFLAG As Boolean:   Dim LMargin  As Double:     Dim LPty As String: Dim TRec As ADODB.Recordset
Dim LPeakMargin  As Double
    AccRecSet.Filter = 0
    If AccRecSet.RecordCount >= 1 Then
    
    ''''
    If GUniqClientId = "1779GWA" Then
        If AccRecSet.RecordCount > 0 Then
            AccRecSet.MoveFirst
            Do While Not AccRecSet.EOF
                If AccRecSet.Fields("EXCODE") = "MCX" And (AccRecSet.Fields("ITEMCODE") = "GOLDM" Or AccRecSet.Fields("ITEMCODE") = "SILVERM" Or AccRecSet.Fields("ITEMCODE") = "GOLDMINI" Or AccRecSet.Fields("ITEMCODE") = "SILVERMINI" Or AccRecSet.Fields("ITEMCODE") = "MINISILVER" Or AccRecSet.Fields("ITEMCODE") = "MINIGOLD") Then
                    AccRecSet.Fields("EXCODE") = "MINI"
                End If
                AccRecSet.Update
                AccRecSet.MoveNext
            Loop
        End If
    End If

    
    ''''
    
        AccRecSet.Sort = "PARTYCODE"
        AccRecSet.MoveFirst
        Do While Not AccRecSet.EOF
            LMargin = 0:            LFLAG = False:                LPty = AccRecSet!PARTYCODE & ""
            LPeakMargin = 0
            mysql = "SELECT IMARGIN,MMARGIN,SPMARGIN,CMARGIN,PREEXPMARGIN,DELIVERYMARGIN,EXTREMELOSS,SPREADMARGIN,PEAKMARGIN,NETBUYPREMIUM FROM DLYCLMGN WHERE COMPCODE =" & GCompCode & " AND CLIENT='" & LPty & "' AND CONDATE ='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' "
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND EXID IN (" & LSExCodes & ")"
            Set TRec = Nothing:                Set TRec = New ADODB.Recordset
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            LMargin = 0
            If Not TRec.EOF Then
                Do While Not TRec.EOF
                    LFLAG = True
                    LMargin = LMargin + Val(TRec!IMARGIN) + Val(TRec!MMARGIN) + Val(TRec!SPMARGIN) + Val(TRec!CMARGIN) + Val(TRec!PREEXPMARGIN) + Val(TRec!DELIVERYMARGIN) + Val(TRec!SPREADMARGIN) + Val(TRec!NETBUYPREMIUM) + Val(TRec!EXTREMELOSS)
                    LPeakMargin = LPeakMargin + Val(TRec!PEAKMARGIN)
                    TRec.MoveNext
                Loop
            End If
            Set TRec = Nothing
            Do While LPty = AccRecSet!PARTYCODE
                AccRecSet.MoveNext
                If AccRecSet.EOF Then GoTo FLAG23
            Loop
            If LFLAG = True Then
                AccRecSet.MovePrevious
                AccRecSet!MarAmt = Val(LMargin)
                AccRecSet!NETAMT = Val(LPeakMargin)
                AccRecSet.Update
                LFLAG = False
                AccRecSet.MoveNext
            End If
FLAG23:
        Loop
        If LFLAG = True Then
            AccRecSet.MovePrevious
            AccRecSet!MarAmt = Val(LMargin)
            AccRecSet.Update
        End If
    End If
End Sub
Sub AccRecNew()
    Dim LBlankStr As String
    LBlankStr = vbNullString
    Set AccRecSet = Nothing
    Set AccRecSet = New ADODB.Recordset
    AccRecSet.Fields.Append "CONTDATE", adVarChar, 10, adFldIsNullable
    
    AccRecSet.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    AccRecSet.Fields.Append "ITEMNAME", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    AccRecSet.Fields.Append "PARTYNAME", adVarChar, 100, adFldIsNullable
    AccRecSet.Fields.Append "ADDRESS", adVarChar, 100, adFldIsNullable
    AccRecSet.Fields.Append "CITY", adVarChar, 30, adFldIsNullable
    AccRecSet.Fields.Append "BQNTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SQNTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CTYPE", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "PATTAN", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "DRAMOUNT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CRAMOUNT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BROKERAGE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "STANDING", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "TRFEES", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CONTDATE1", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "SRNO", adInteger, , adFldIsNullable
    AccRecSet.Fields.Append "INVNO", adInteger, , adFldIsNullable
    AccRecSet.Fields.Append "INVDATE", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "WORDAMT", adVarChar, 300, adFldIsNullable
    AccRecSet.Fields.Append "CALVAL", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "OPENQTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "RPATTAN", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "SERVICETAX", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "PrevBal", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "TurnOverTax", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BrokRate", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BrokType", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "CONNO", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "CONTIME", adVarChar, 20, adFldIsNullable
    AccRecSet.Fields.Append "MarRate", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "MarAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "MarType", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "SBROKRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SBROKTYPE", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "SCONNO", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "SCONTIME", adVarChar, 20, adFldIsNullable
    AccRecSet.Fields.Append "STTTax", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "TRANTAX", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BILLNO", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BILLDATE", adDate, , adFldIsNullable
    AccRecSet.Fields.Append "PIN", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "PHONEO", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "PHONER", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "MOBILE", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "FAX", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "PANNO", adVarChar, 20, adFldIsNullable
    AccRecSet.Fields.Append "DebitAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CreditAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "RptGrp", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "ShareAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SEBITaxAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SEBITax", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SBCTaxAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BBROKAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SBROKAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "MATURITY", adDate, , adFldIsNullable
    AccRecSet.Fields.Append "LUSDINRRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "RUSDINRRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BBROKQTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SBROKQTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "REFLOT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CINNO", adVarChar, 30, adFldIsNullable
    AccRecSet.Fields.Append "CGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "IGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "UTTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "GSTIN", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "CLIENTCODE", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "EMAIL", adVarChar, 100, adFldIsNullable
    AccRecSet.Fields.Append "CLOSEQTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "GROSSMTM", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BROKAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "NETAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "STATE", adVarChar, 35, adFldIsNullable
    AccRecSet.Fields.Append "STATECODE", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "OPENRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BINSTYPE", adVarChar, 5, adFldIsNullable
    AccRecSet.Open , , adOpenKeyset, adLockOptimistic
     
End Sub

Sub AccRecSumm()
    
    Set AccRecSet = Nothing
    Set AccRecSet = New ADODB.Recordset
    AccRecSet.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "MATURITY", adDate, , adFldIsNullable
    AccRecSet.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    AccRecSet.Fields.Append "CALVAL", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "REFLOT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    AccRecSet.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
    AccRecSet.Fields.Append "PrevBal", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "OPENQTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "OPENRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BQNTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SQNTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CLQNTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CLRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "DIFFAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BROKAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "STANDING", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "TRANAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SRVAX", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "TurnOverTax", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CTTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "TRANTAX", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SEBITaxAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SEBITax", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SBCTaxAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "IGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "UTTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "ShareAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "MarAmt", adDouble, , adFldIsNullable  '0
    AccRecSet.Open , , adOpenKeyset, adLockOptimistic
End Sub

Public Function Get_StampDutyAmt(ByVal LSTParty As String, ByVal LSDT1 As Date, ByVal LSDT2 As Date, ByVal LSExCodes As String) As Double
    Dim LNStmAmt As Double:    Dim RecBal As ADODB.Recordset
    LNStmAmt = 0
    mysql = "SELECT SUM(CASE DR_CR WHEN 'D'THEN AMOUNT*-1 WHEN 'C' THEN AMOUNT END) AS AMT FROM VCHAMT WHERE COMPCODE =" & GCompCode & ""
    mysql = mysql & " AND AC_CODE='" & LSTParty & "'AND VOU_DT>='" & Format(LSDT1, "YYYY/MM/DD") & "' AND VOU_DT<='" & Format(LSDT2, "YYYY/MM/DD") & "' AND VOU_TYPE='S'"
    If LenB(LSExCodes) <> 0 Then mysql = mysql & " AND EXID IN (" & LSExCodes & ")"
    mysql = mysql & " AND VOU_NO LIKE 'STMP%'"
    Set RecBal = Nothing: Set RecBal = New ADODB.Recordset
    RecBal.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not RecBal.EOF Then LNStmAmt = IIf(IsNull(RecBal!AMT), 0, RecBal!AMT)
    Set RecBal = Nothing
    Get_StampDutyAmt = LNStmAmt
End Function

Sub NewGenerateStatement1()
'original
Dim LRefLot As Double:          Dim LBuyAmt As Double:          Dim LSellAmt As Double:         Dim LBrokLot As Double
Dim LprevBal As Double:         Dim LBal As Double:             Dim LDebitAmt As Double:        Dim LCreditAmt As Double
Dim LBrokRate As Double:        Dim LBrokRate2 As Double:       Dim LBrokQty As Double:         Dim LUTTAmt As Double
Dim LBrokQty2 As Double:        Dim LCalval As Double:          Dim LStrike As Double:          Dim LTradeableLot As Double
Dim LMarRate As Double:         Dim LCloseRate As Double:       Dim LOpenRate As Double:        Dim GSrvTax As Double
Dim LTranAmount As Double:      Dim LStmAmt As Double:          Dim LTotStmAmt As Double:       Dim LStmRate As Double
Dim LSTTAmt As Double:          Dim LTotSTTAmt As Double:       Dim LSTTRate As Double:         Dim LRiskMAmt  As Double
Dim LSEBITaxAmt As Double:      Dim LTotSEBITaxAmt As Double:   Dim LSEBITax As Double:         Dim LSBCTaxAmt As Double
Dim LMarAmt As Double:          Dim LMinRate As Double:         Dim LNStmAmt As Double:         Dim LSGSTAmt As Double
Dim LTotBuyQty As Double:       Dim LTotSellQty As Double:      Dim GSTDChrs As Double:         Dim LBrokAmount As Double
Dim LCGSTAmt As Double:         Dim LTotBuyAmt As Double:       Dim LTotSellAmt As Double:      Dim LTotOpAmt As Double
Dim MSrvTax As Double:          Dim LTranRate As Double:        Dim LCBrokAmt As Double:        Dim LcTranAmt   As Double
Dim LSBCTax As Double:          Dim LCGSTRate As Double:        Dim LSGSTRate As Double:        Dim LIGSTRate As Double:
Dim LUTTRate As Double:         Dim LClQty As Double:           Dim LShareAmt As Double:        Dim lOpQty As Double
Dim LIGSTAmt As Double:         Dim LBalQty As Double:          Dim LDiffAmt As Double:         Dim LEQSTMRate As Double
Dim LEQSTTRate As Double:
Dim LBrokType As String:       Dim LATranType As String:        Dim GSrTaxApp As String:        Dim LCttType As String
Dim LRiskMType As String:      Dim LSEBIType As String:         Dim LCGSTType As String:        Dim LLotWise As String
Dim LIGSTType As String:       Dim LUTTType As String:          Dim LPStmType As String:        Dim LMStrDate As String
Dim LMarType As String:        Dim LRiskMApp As String:         Dim MCLPattan As String:        Dim TRec2 As ADODB.Recordset
Dim TRecVOU As ADODB.Recordset
Dim LSGSTType As String:        Dim LCINNo As String:           Dim CountRec As Long:           Dim LRptGrp As Integer
Dim LPartyCode As String:       Dim LPartyName As String:       Dim LContractAcc As String:     Dim LFAX As String
Dim LPANNO As String:           Dim LPHoneo As String:          Dim LPhoneR As String:          Dim LPIN As String
Dim LAExCode As String:         Dim LItemCode As String:        Dim LMobile As String:          Dim LInstType As String:
Dim LSaudaCode As String:       Dim LStmFlag As Boolean:        Dim LOpFlag As Boolean:         Dim Lmaturity As Date:
Dim LSOpQty As Double:          Dim LTillDate  As Date:         Dim LTFromDate  As Date:        Dim LSetNo As Long
Dim LBuyClRate As Double:       Dim LSellClRate As Double:      Dim LCloseAmt As Double:        Dim LBillBy As String
Dim LTotBQAmt As Double:        Dim LTotSQAmt As Double:        Dim LNetRecdPay As Double:      Dim LNetMargin As Double
Dim TRec As ADODB.Recordset:    Dim LConType  As String:        Dim LedgerFlag As Boolean:      Dim AccStAdoREC As ADODB.Recordset
Dim LOptCutBrok As String:      Dim LFutCutBrok As String:      Dim LSaudaID As Long:           Dim LNetPosition As Double
Dim LExID As Integer:           Dim LItemID As Integer:         Dim LStampDutyDate As Date:     Dim LNetOpenPosition As Double
Dim LOptType  As String:        Dim LBrokName  As String:       Dim LACCID  As Long
Dim Mledger1 As String:         Dim Mledger2 As String:         Dim Mledger3 As String:         Dim LSaudaCode_muliple As String:
Dim loopdate As Date:           Dim TempPart As String
Dim mpartyop As Boolean:        Dim MBROKTRADES As Long:        Dim LPartyType As String:       Dim mpusdinr As Double

CFlag = False
LStampDutyDate = DateValue("01/07/2020")
CF_BALANCE = 0
LSetNo = 0
LBillBy = "S": LSaudaCode_muliple = ""
Set TRec = Nothing:         Set TRec = New ADODB.Recordset
mysql = "SELECT SETNO FROM SETTLE WHERE COMPCODE =" & GCompCode & "  AND SETDATE ='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
If Not TRec.EOF Then
    LSetNo = TRec!SETNO
End If

TempPart = ""
LCurrFRate = 1: LCurrCRate = 1: LCurrDRate = 1: mpusdinr = 1

Me.MousePointer = Val(11):      LStmFlag = False:               LOpFlag = False
GETMAIN.ProgressBar1.Visible = True
GETMAIN.ProgressBar1.Max = PartyRec.RecordCount + 1
GETMAIN.ProgressBar1.Value = 0
Do While Not PartyRec.EOF ' party loop
    CFlag = False
    If LPartyCode <> PartyRec!AC_CODE Then
        loopdate = DateValue("01/01/1900")
        LStmFlag = False:   mpartyop = False:   LedgerFlag = False: LOpFlag = False
        Set TRec2 = Nothing: Set TRec2 = New ADODB.Recordset
        mysql = "SELECT ACEXCODE FROM ACCT_EX WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & PartyRec!AC_CODE & "'"
        TRec2.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec2.EOF Then
            LClientCode = TRec2!ACEXCODE
        End If
        Set TRec2 = Nothing
        mpusdinr = 1
    End If
    LPartyCode = PartyRec!AC_CODE:  LPartyName = PartyRec!NAME: LACCID = PartyRec!ACCID
    LPANNO = Trim$(PartyRec!PANNO & vbNullString)
    LPHoneo = Trim$(PartyRec!PhoneO & vbNullString):    LPhoneR = Trim$(PartyRec!PhoneR & vbNullString)
    LFAX = Trim$(PartyRec!Fax & vbNullString):          LMobile = Trim$(PartyRec!Mobile & vbNullString)
    LPIN = Trim$(PartyRec!Pin & vbNullString): LCINNo = vbNullString
    LOptCutBrok = Trim$(PartyRec!OptCutBrok & vbNullString): LFutCutBrok = Trim$(PartyRec!FUTCutBrok & vbNullString)
    LPartyType = PartyRec!PARTYTYPE
    
    If GOnlyBrok = 0 Then
        GSrTaxApp = PartyRec!SRTAXAPP:
        LCttType = IIf(IsNull(PartyRec!CTTTYPE), "N", PartyRec!CTTTYPE)
        LRiskMType = IIf(IsNull(PartyRec!RISKMTYPE), "N", PartyRec!RISKMTYPE)
        LSEBIType = IIf(IsNull(PartyRec!SEBITYPE), "N", PartyRec!SEBITYPE)
        LCGSTType = IIf(IsNull(PartyRec!CGST), "N", PartyRec!CGST)
        LSGSTType = IIf(IsNull(PartyRec!SGST), "N", PartyRec!SGST)
        LIGSTType = IIf(IsNull(PartyRec!IGST), "N", PartyRec!IGST)
        LUTTType = IIf(IsNull(PartyRec!UTT), "N", PartyRec!UTT)
        LPStmType = IIf(IsNull(PartyRec!APPLYON), "N", PartyRec!APPLYON)
    End If
    If LOpFlag = False Then
        LNetRecdPay = 0
        If (Option4.Value) Or (Option5.Value) Then
            LprevBal = PartyRec!OP_BAL
            If Check10.Value = 0 Then
                LBal = Net_DrCr(PartyRec!AC_CODE, DateValue(vcDTP1.Value))
                LprevBal = LprevBal + LBal
            End If
            If Option4.Value Then
                If Check10.Value = 1 Then
                    LNetRecdPay = 0
                    LNetMargin = 0
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    mysql = "SELECT SUM(Case DR_CR WHEN 'D' THEN  AMOUNT * -1 WHEN 'C' THEN  AMOUNT * 1  END) AS AMT FROM VCHAMT "
                    mysql = mysql & " WHERE COMPCODE = " & GCompCode & " AND AC_CODE ='" & PartyRec!AC_CODE & "' AND VOU_DT <'" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CHEQUE_NO NOT IN ('DMARGIN','RMARGIN') "
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then LprevBal = LprevBal + IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    mysql = "SELECT SUM(Case DR_CR WHEN 'D' THEN  AMOUNT * -1 WHEN 'C' THEN  AMOUNT * 1  END) AS AMT FROM VCHAMT "
                    mysql = mysql & " WHERE COMPCODE = " & GCompCode & " AND AC_CODE ='" & PartyRec!AC_CODE & "' AND VOU_DT >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'AND VOU_DT <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
                    mysql = mysql & " AND VOU_TYPE <>'S' AND CHEQUE_NO NOT IN ('DMARGIN','RMARGIN') "
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then LNetRecdPay = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    mysql = "SELECT IMARGIN FROM DLYCLMGN "
                    mysql = mysql & " WHERE COMPCODE = " & GCompCode & " AND CLIENT ='" & PartyRec!AC_CODE & "' AND CONDATE ='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
                    mysql = mysql & " AND EXCODE='CME' "
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then LNetMargin = IIf(IsNull(TRec!IMARGIN), 0, TRec!IMARGIN)
                    Set TRec = Nothing
                Else
                    If Check4.Value = 1 Then
                        LprevBal = LprevBal + Get_Balance(LACCID)
                    Else
                        Set TRec = Nothing: Set TRec = New ADODB.Recordset
                        mysql = "EXEC ACSUMVCHS " & GCompCode & ",'" & PartyRec!AC_CODE & "','" & Format(vcDTP1.Value, "yyyy/MM/dd") & "','" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec.EOF Then LprevBal = LprevBal + IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                        Set TRec = Nothing
                    End If
                End If
            ElseIf Option5.Value Then
                LDebitAmt = 0: LCreditAmt = 0
                mysql = "SELECT DR_CR,SUM(AMOUNT) AS AMT FROM VCHAMT WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & PartyRec!AC_CODE & "' "
                mysql = mysql & " AND VOU_DT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND  vou_type <> 'S' AND VOU_DT<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                mysql = mysql & " GROUP BY DR_CR "
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    If TRec!DR_CR = "C" Then LCreditAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    If TRec!DR_CR = "D" Then LDebitAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    TRec.MoveNext
                    If Not TRec.EOF Then
                        If TRec!DR_CR = "C" Then LCreditAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                        If TRec!DR_CR = "D" Then LDebitAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    End If
                    LNetRecdPay = LCreditAmt - LDebitAmt
                End If
                Set TRec = Nothing
            End If
        End If
        LOpFlag = True
    End If
    LTillDate = vcDTP2.Value:     LTFromDate = vcDTP1.Value:     LMStrDate = vbNullString
    LMStrDate = Get_MaxExCondate(PartyRec!EXID, DateValue(vcDTP2.Value))
    If LenB(LMStrDate) > 1 Then LTillDate = DateValue(LMStrDate)
    LAExCode = PartyRec!excode:         LItemCode = PartyRec!ITEMCODE
    LInstType = PartyRec!INSTTYPE:      LStrike = Val(PartyRec!STRIKEPRICE)
    LSaudaCode = PartyRec!saudacode:    Lmaturity = PartyRec!MATURITY
    
    If LSaudaCode_muliple = "" Then
        LSaudaCode_muliple = LSaudaCode
    Else
        LSaudaCode_muliple = LSaudaCode_muliple & ";" & LSaudaCode
    End If
    
    LRefLot = IIf(IsNull(PartyRec!REFLOT), 1, PartyRec!REFLOT):    LBrokLot = IIf(IsNull(PartyRec!BROKLOT), 1, PartyRec!BROKLOT)
    LContractAcc = PartyRec!CONTRACTACC:                           LLotWise = PartyRec!LOTWISE
    LSaudaID = PartyRec!SAUDAID:                                   LExID = PartyRec!EXID
    LOptType = PartyRec!OPTTYPE: LItemID = PartyRec!itemid

    LMinRate = 0
    If GMinBrokYN = "Y" And GFBroktype = "Y" Then
        Call getminrate(LPartyCode, LItemID, LExID, LMinRate)
    End If
    LBuyClRate = 1: LSellClRate = 1
    Do While LSaudaID = PartyRec!SAUDAID And LPartyCode = PartyRec!AC_CODE

        DoEvents
        Label5.Caption = LPartyName & " " & LSaudaCode
        LTradeableLot = PartyRec!TRADEABLELOT
        If LAExCode = "NSE" And LLotWise = "Y" Then
            LCalval = PartyRec!TRADEABLELOT
        Else
            If LAExCode = "MCX" And LLotWise = "Y" Then
                LCalval = PartyRec!TRADEABLELOT
            Else
                LCalval = PartyRec!lot
            End If
        End If
        mpusdinr = 1
        
        Set TRec2 = Nothing: Set TRec2 = New ADODB.Recordset
        mysql = "SELECT BILLBY,ACEXCODE FROM ACCT_EX WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & PartyRec!AC_CODE & "' and EXCODE = '" & LAExCode & "' "
        TRec2.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec2.EOF Then
            LBillBy = TRec2!billby
        End If
        Set TRec2 = Nothing
        
        'Getting Inr Rate
        If LAExCode = "CMX" Then
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT closerate,HGRATE,LOWRATE FROM CTR_R WHERE COMPCODE =" & GCompCode & " AND SAUDA ='USDINR' AND CONDATE ='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                LCurrFRate = TRec!CLOSERATE: LCurrCRate = TRec!LOWRATE: LCurrDRate = TRec!HGRATE
            End If
            Set TRec = Nothing
        Else
            LCurrDRate = 1: LCurrCRate = 1
        End If
        
        'Getting Script Rate
        If LBillBy = "B" Then
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT CLOSERATE,HGRATE,LOWRATE FROM CTR_R WHERE COMPCODE =" & GCompCode & " AND SAUDAID ='" & LSaudaID & "' AND CONDATE= '" & Format(vcDTP2.Value, "yyyy/mm/dd") & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                LBuyClRate = IIf(TRec!LOWRATE = 0, TRec!CLOSERATE, TRec!LOWRATE)
                LSellClRate = IIf(TRec!HGRATE = 0, TRec!CLOSERATE, TRec!HGRATE)
            End If
            Set TRec = Nothing
        ElseIf LBillBy = "S" Then
            LCurrCRate = LCurrFRate: LCurrDRate = LCurrFRate
        ElseIf LBillBy = "P" Then
            Dim LPOPRATE As Double
            Dim LPCLRATE As Double
            LPOPRATE = 0: LPCLRATE = 0
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT TOP 1 SETTLERATE FROM CTR_RP WHERE party = '" & LPartyCode & "' AND SAUDAID ='" & LSaudaID & "' AND CONDATE < '" & Format(vcDTP1.Value, "yyyy/mm/dd") & "' ORDER BY CONDATE DESC"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                If TRec!SETTLERATE <> 0 Then LPOPRATE = TRec!SETTLERATE
            End If
            
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT SETTLERATE FROM CTR_RP WHERE PARTY = '" & LPartyCode & "' AND  SAUDAID ='" & LSaudaID & "' AND CONDATE= '" & Format(vcDTP2.Value, "yyyy/mm/dd") & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                If TRec!SETTLERATE <> 0 Then LPCLRATE = TRec!SETTLERATE
            End If

            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT SETTLERATE,HiGh,LOW FROM CTR_RP WHERE COMPCODE =" & GCompCode & " AND PARTY = '" & LPartyCode & "' AND SAUDA ='USDINR' AND CONDATE ='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                LCurrFRate = TRec!SETTLERATE: LCurrCRate = TRec!LOW: LCurrDRate = TRec!HIGH
            End If
            Set TRec = Nothing
        End If

        'Check For inv_d USDINR Rates for The Party
        'mpusdinr
        If GUniqClientId = "BRO2-CHE" Then
            If mpusdinr = 1 And LAExCode = "CMX" And Check5.Value = 0 And Check13.Value = 1 Then
                mysql = "SELECT CURRRATE,USDINR FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY = '" & LPartyCode & "' AND EXCODE  ='CMX' AND STDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' ORDER BY STDATE DESC"
                Set TRec = Nothing ' rrrrrr
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    mpusdinr = TRec!USDINR
                    LCurrDRate = TRec!CURRRATE
                End If
            End If
            If mpusdinr <> 1 Or (Check5.Value = 0 And Check13.Value = 0) Then
                LCurrFRate = mpusdinr: LCurrCRate = mpusdinr
            End If
        Else
            If mpusdinr = 1 And LAExCode = "CMX" And Check5.Value = 0 And Check13.Value = 1 Then
                mysql = "SELECT CURRRATE,USDINR FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY = '" & LPartyCode & "' AND EXCODE  ='CMX' AND STDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' ORDER BY STDATE DESC"
                Set TRec = Nothing ' rrrrrr
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    mpusdinr = TRec!USDINR
                    LCurrDRate = TRec!USDINR
                End If
                If mpusdinr <> 1 Or (Check5.Value = 0 And Check13.Value = 0) Then
                    LCurrFRate = mpusdinr: LCurrCRate = mpusdinr
                End If
            End If
        End If
        If LAExCode <> "CMX" Then
           ' LCurrCRate = 1: LCurrDRate = 1
        End If
        
        LRiskMApp = PartyRec!RISKMAPP
        LRiskMAmt = 0:      LSBCTaxAmt = 0
        LBrokAmount = 0:    GSrvTax = 0:        LTranAmount = 0:    LStmAmt = 0:
        LTotStmAmt = 0:     LStmRate = 0:       LSTTAmt = 0:        LTotSTTAmt = 0:     LSTTRate = 0:
        LSEBITaxAmt = 0:    LTotSEBITaxAmt = 0: LSEBITax = 0:       LMarAmt = 0:
        LNStmAmt = 0:        LCloseRate = 0:    LClQty = 0:         LNetPosition = 0
        LEQSTTRate = 0:      LEQSTMRate = 0
        
        Set AccStAdoREC = Nothing: Set AccStAdoREC = New ADODB.Recordset
        mysql = "EXEC AcSt " & GCompCode & ",'" & Format(LTFromDate, "yyyy/MM/dd") & "','" & Format(LTillDate, "yyyy/MM/dd") & "'," & LSaudaID & ",'" & LPartyCode & "'," & GOnlyBrok & ""
        AccStAdoREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If GOnlyBrok = 0 Then
            If LPStmType = "R" Or LPStmType = "P" Then
                If LTillDate >= GSTMDate And LTillDate < LStampDutyDate Then LNStmAmt = Get_StampDutyAmt(LPartyCode, LTFromDate, LTillDate, LSExCodes)
            End If
        End If
        If Check10.Value = 1 Then
            Set TRec = Nothing ' rrrrrr
            Set TRec = New ADODB.Recordset
            mysql = "SELECT A.ROWNO1,A.CONNO,A.QTY,A.RATE,A.CONTYPE, A.CONDATE,a.pattan FROM CTR_D AS A WHERE  "
            mysql = mysql & " A.COMPCODE=" & GCompCode & " AND A.PARTY='" & LPartyCode & "' AND A.CONDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
            mysql = mysql & " AND A.SAUDAID =" & LSaudaID & " AND A.CONDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
            mysql = mysql & " ORDER BY A.CONDATE,A.CONNO"
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly

            Do While Not TRec.EOF
                CountRec = CountRec + 1
                AccRecSet.AddNew
                ''common
                AccRecSet.Fields("RPTGRP") = 1:                     AccRecSet.Fields("SRNO") = CountRec:
                AccRecSet.Fields("CALVAL") = LCalval:
                AccRecSet.Fields("CONNO") = TRec!CONNO
                'buy sell
                If TRec!CONTYPE > "B" Then
                    AccRecSet.Fields("CTYPE") = "B":                AccRecSet.Fields("CONTDATE") = Format(TRec!Condate, "yyyy/MM/dd")
                    AccRecSet.Fields("BQNTY") = TRec!QTY:           AccRecSet.Fields("BRATE") = TRec!Rate
                    AccRecSet.Fields("DRAMOUNT") = 0
                Else
                    'sachin
                    AccRecSet.Fields("CTYPE") = "S":                AccRecSet.Fields("CONTDATE") = Format(TRec!Condate, "yyyy/MM/dd")
                    AccRecSet.Fields("SQNTY") = TRec!QTY:           AccRecSet.Fields("SRATE") = TRec!Rate
                    AccRecSet.Fields("DRAMOUNT") = 0
                End If
                Call Add_PartyDetails
                Call Add_OtherDetails
                AccRecSet.Update
                TRec.MoveNext
            Loop
            Set TRec = Nothing
        End If
        
        ''OPENING QNTY INSERTION
        LTotBuyQty = 0:       LTotSellQty = 0:       GSTDChrs = 0:
        lOpQty = 0:           LBrokRate2 = 0:        LCGSTAmt = 0:       LSGSTAmt = 0:       LIGSTAmt = 0:       LUTTAmt = 0
        LTotBuyAmt = 0:       LTotSellAmt = 0:       LTotOpAmt = 0:      MSrvTax = 0:        LATranType = "P":   LBrokType = "P"
        LOpenRate = 0:        LTotBQAmt = 0:         LTotSQAmt = 0:      LDiffAmt = 0
        lOpQty = SDOpQty(LPartyCode, LSaudaID, LTFromDate):
        lOpQty = Round(lOpQty, 2)
        LNetOpenPosition = lOpQty:  LNetPosition = lOpQty: LBalQty = lOpQty
        If lOpQty <> 0 Then
            LOpenRate = SDCLRATE(LSaudaID, LTFromDate - 1, "O")      'closing rate for opening
            If LPOPRATE <> 0 Then
                LOpenRate = LPOPRATE
            End If
            LTotOpAmt = lOpQty * LOpenRate * LCalval
        End If
        If (LInstType = "OPT" And OptMTMChk.Value = 0) Or (LInstType = "CSH" And CshMTMchk.Value = 0) Then
            lOpQty = 0
            LTotOpAmt = 0
        End If
        
        If lOpQty <> 0 Then    ''FOR OPENING INSERTION
            If MFormat = "Account Statement" Then
                'AccRecSet.AddNew
                CountRec = CountRec + 1
                If lOpQty > 0 Then
                    LConType = "B"
                    LDiffAmt = Abs(Val(lOpQty)) * Val(LOpenRate) * LCalval * -1
                Else
                    LConType = "S"
                    LDiffAmt = Abs(Val(lOpQty)) * Val(LOpenRate) * LCalval
                End If
                
                '>>> account statement report grouping
                If Check10.Value = 1 Then
                    LRptGrp = 2 'old
                    'LRptGrp = 1
                Else
                    LRptGrp = 1 'old
                    'LRptGrp = 2
                End If
                If LBrokType = "P" Then
                    LGBrokName = "Percentage Wise"
                ElseIf LBrokType = "T" Then
                    LGBrokName = "Transaction Wise"
                ElseIf LBrokType = "O" Then
                    LGBrokName = "Opening Sauda"
                End If
                LGBrokRate = str(Round(LBrokRate, 4))
                    
                If Check12.Value = 1 And MFormat = "Account Statement" Then '>>> oprning entry -- account statement customized format
                Else
                    Call Add_To_AccRecSet(LRptGrp, CountRec, LSetNo, lOpQty, LOpenRate, vbNullString, (LTFromDate - 1), LNetRecdPay, LNetMargin, vbNullString, 0, 0, LprevBal, LConType, LRefLot, LCalval, "O", "*", LInstType)
                End If
            End If
        End If

        If Check12.Value = 1 And Not mpartyop And MFormat = "Account Statement" Then '>>> oprning entry -- account statement customized format
            If (Check10.Value = 1 And Option5.Value And Check12.Value = 1 And MFormat = "Account Statement") Then
                LBal = Get_ClosingBal(PartyRec!ACCID, vcDTP1.Value - 1)
                mpartyop = True
                If LBal <> 0 Then
                    CountRec = CountRec + 1
                    Call Add_VOUCHER("2", CountRec, "OPENING", vcDTP1.Value, "", "", "", 0, LBal)
                End If
            End If
        End If
                    
        ''BOUGHT INSERTION
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: Set TRec = AccStAdoREC.Clone
        If GCINNo = "2000" Then
            TRec.Filter = "CONDATE >='" & Format(LTFromDate, "yyyy/MM/dd") & "'"
        Else
            If Check12.Value = 0 Then
                TRec.Filter = "CONTYPE='B'"
            End If
        End If
        
        If Not TRec.EOF Then
            If loopdate = "01/01/1900" Then
                loopdate = TRec!Condate
            End If
        End If
        With TRec
            Do While Not .EOF
                LCBrokAmt = 0: LcTranAmt = 0
                
                    LBrokType = IIf(IsNull(!broktype), "T", !broktype)
                    LBrokRate2 = Val(!BROKRATE2 & vbNullString):      LBrokQty = IIf(IsNull(!BROKQTY), 0, !BROKQTY)
                    LBrokRate = Val(!brokrate & vbNullString):        LBrokQty2 = IIf(IsNull(!BROKQTY2), 0, !BROKQTY2)

                If Not IsNull(!ORDNO) Then
                    If !ORDNO = "Carry" Then
                        LBrokRate = LBrokRate2
                    End If
                End If
                If GOnlyBrok = 0 Then
                    LTranRate = Val(!TRANRATE & vbNullString):        LATranType = IIf(IsNull(!TRANTYPE), "T", !TRANTYPE)
                    MSrvTax = Val(!SRVTAX & vbNullString):            LSBCTax = Val(!SBC_TAX & vbNullString)
                    LCGSTRate = Val(!CGSTRATE):                       LSGSTRate = Val(!SGSTRATE):
                    LIGSTRate = Val(!IGSTRATE):                       LUTTRate = Val(!UTTRATE)
                    LSEBITax = Val(!SEBITAX):                         LSTTRate = Val(!STTRATE & vbNullString)
                    LEQSTTRate = Val(!EQ_STT & vbNullString)
                    LEQSTMRate = Val(!EQ_STAMP & vbNullString)
                    If !Condate >= GSTMDate And !Condate < LStampDutyDate And (LPStmType = "R" Or LPStmType = "P") Then
                        LStmRate = 0
                    Else
                        LStmRate = Val(!STMRATE & vbNullString)
                        LEQSTMRate = Val(!EQ_STAMP & vbNullString)
                    End If
                End If

                If !PATTAN <> "C" Then
                    'If Check12.Value = 0 Then
                    If GCINNo = "2000" Then
                        If !CONTYPE = "B" Then
                            lOpQty = lOpQty + !QTY: LTotOpAmt = LTotOpAmt + (!QTY * !Rate * LCalval)
                            LBalQty = lOpQty
                        Else
                            lOpQty = lOpQty - !QTY: LTotOpAmt = LTotOpAmt - (!QTY * !Rate * LCalval)
                            LBalQty = lOpQty
                        End If
                    Else
                        If !CONTYPE = "B" Then
                            lOpQty = lOpQty + !QTY: LTotOpAmt = LTotOpAmt + (!QTY * !Rate * LCalval)
                            LBalQty = lOpQty
                        Else
                            lOpQty = lOpQty - !QTY: LTotOpAmt = LTotOpAmt - (!QTY * !Rate * LCalval)
                            LBalQty = lOpQty
                        End If
                    End If
                    LNetPosition = lOpQty
                Else
                    If GCINNo = "2000" Then
                        If !CONTYPE = "B" Then
                            LBuyAmt = !QTY * !Rate * LCalval:                    LTotBuyAmt = LTotBuyAmt + LBuyAmt
                        Else
                            LSellAmt = !QTY * !Rate * LCalval:                   LTotSellAmt = LTotSellAmt + LSellAmt
                        End If
                    Else
                        LBuyAmt = !QTY * !Rate * LCalval:                        LTotBuyAmt = LTotBuyAmt + LBuyAmt
                        LTotBQAmt = LTotBQAmt + LBuyAmt
                    End If
                    
                    If LBrokType = "Z" Then LBrokQty = LBrokLot
                    If LBrokType = "A" Then LBrokQty2 = LBrokLot
                    If LBrokType = "R" Then LBrokQty2 = LBrokLot
                    If LBrokType = "5" Then LBrokQty2 = LBrokLot
                    If GCINNo = "2000" Or Check12.Value = 1 Then
                        If !CONTYPE = "B" Then
                            If (LBrokType = "O" Or LBrokType = "C") Then LBrokQty = Get_BrokQty(LBrokType, LBalQty, "B", !QTY)
                            LBalQty = LBalQty + !QTY
                            LTotBuyQty = LTotBuyQty + !QTY
                        Else
                            If (LBrokType = "O" Or LBrokType = "C") Then LBrokQty = Get_BrokQty(LBrokType, LBalQty, "S", !QTY)
                            LBalQty = LBalQty + !QTY
                            LTotSellQty = LTotSellQty + !QTY
                        End If
                    Else
                        If (LBrokType = "O" Or LBrokType = "C" Or LBrokType = "A" Or LBrokType = "5") Then LBrokQty = Get_BrokQty(LBrokType, LBalQty, "B", !QTY)
                            LBalQty = LBalQty + !QTY
                            LTotBuyQty = LTotBuyQty + !QTY
                    End If
                    LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, LBrokQty, !QTY, !Rate, LCalval, LInstType, LStrike, LBrokQty2, LTradeableLot, "B", "2", LItemID)
                    If LMinRate <> 0 And (LMinRate * (!QTY / LRefLot)) > LCBrokAmt Then
                        LCBrokAmt = LMinRate * (!QTY / LRefLot)
                    End If
                    LBrokAmount = LBrokAmount + LCBrokAmt
                    If GOnlyBrok = 0 Then
                        If LInstType = "CSH" Then
                            LStmAmt = (LStmRate / 100) * ((!QTY - LBrokQty2) * !Rate * LCalval)
                            LTotStmAmt = LTotStmAmt + LStmAmt
                            LTotStmAmt = LTotStmAmt + ((LEQSTMRate / 100) * (LBrokQty2 * !Rate * LCalval))
                            LSTTAmt = (LSTTRate / 100) * ((!QTY - LBrokQty2) * !Rate * LCalval)
                            LTotSTTAmt = LTotSTTAmt + LSTTAmt
                            LTotSTTAmt = LTotSTTAmt + (((LEQSTTRate / 100) * ((LBrokQty2) * !Rate * LCalval)))
                        Else
                            LStmAmt = (LStmRate / 100) * LBuyAmt:
                            LSTTAmt = (LSTTRate / 100) * LBuyAmt:
                            LTotStmAmt = LTotStmAmt + LStmAmt
                            LTotSTTAmt = LTotSTTAmt + LSTTAmt
                        End If
        
                        LSEBITaxAmt = (LSEBITax / 100) * LBuyAmt:            LTotSEBITaxAmt = LTotSEBITaxAmt + LSEBITaxAmt
                        If LATranType = "T" Then
                            LcTranAmt = LTranRate * !QTY: LTranAmount = LTranAmount + LcTranAmt
                        ElseIf LATranType = "P" Then
                            LcTranAmt = (LTranRate / 100) * LBuyAmt
                            LTranAmount = LTranAmount + LcTranAmt
                        ElseIf LATranType = "I" Then
                            LcTranAmt = ((LTranRate / 100) * LBrokQty * !Rate * LCalval)
                            LTranAmount = LTranAmount + LcTranAmt
                        End If
                        GSrvTax = GSrvTax + (LCBrokAmt * MSrvTax) / 100
                        LSBCTaxAmt = LSBCTaxAmt + (LCBrokAmt * LSBCTax) / 100
                        LCGSTAmt = LCGSTAmt + ((LCBrokAmt * LCGSTRate) / 100)
                        LSGSTAmt = LSGSTAmt + ((LCBrokAmt * LSGSTRate) / 100)
                        LIGSTAmt = LIGSTAmt + ((LCBrokAmt * LIGSTRate) / 100)
                        LUTTAmt = LUTTAmt + ((LCBrokAmt * LUTTRate) / 100)
                        If GSrStdYN = "Y" Then
                            If !Condate >= DateValue(GSrvDate) Then
                                GSrvTax = GSrvTax + (LcTranAmt * MSrvTax) / 100
                                LSBCTaxAmt = LSBCTaxAmt + (LcTranAmt * LSBCTax) / 100
                                LCGSTAmt = LCGSTAmt + ((LcTranAmt * LCGSTRate) / 100)
                                LSGSTAmt = LSGSTAmt + ((LcTranAmt * LSGSTRate) / 100)
                                LIGSTAmt = LIGSTAmt + ((LcTranAmt * LIGSTRate) / 100)
                                LUTTAmt = LUTTAmt + ((LcTranAmt * LUTTRate) / 100)
                            End If
                            If TRec!Condate >= DateValue(GSrvDate2) Then
                                LCGSTAmt = LCGSTAmt + ((LSEBITaxAmt * LCGSTRate) / 100)
                                LSGSTAmt = LSGSTAmt + ((LSEBITaxAmt * LSGSTRate) / 100)
                                LIGSTAmt = LIGSTAmt + ((LSEBITaxAmt * LIGSTRate) / 100)
                            End If
                        End If
                    End If
                End If
                If MFormat = "Account Statement" Then
                    CountRec = CountRec + 1:
                    If LBrokType = "P" Then
                        LGBrokName = "Percentage Wise"
                    ElseIf LBrokType = "T" Then
                        LGBrokName = "Transaction Wise"
                    ElseIf LBrokType = "O" Then
                        LGBrokName = "Opening Sauda"
                    End If
                    LGBrokRate = str(Round(LBrokRate, 4))
                    CFlag = False

                If !PATTAN <> "C" And Check12.Value = 1 Then
                Else
                    Call Add_To_AccRecSet(LRptGrp, CountRec, LSetNo, !QTY, !Rate, (!ROWNO1 & vbNullString), !Condate, LNetRecdPay, LNetMargin, !contime, LBrokRate, LCBrokAmt, LprevBal, !CONTYPE, LRefLot, LCalval, !PATTAN, LBrokType, LInstType)
                End If
                End If
                .MoveNext
            Loop

            CFlag = False
        End With
        ''END BOUGHT
                        
        ''SOLD START
        If Check12.Value = 0 Then
        If GCINNo <> "2000" Then
            Set TRec = Nothing: Set TRec = New ADODB.Recordset: Set TRec = AccStAdoREC.Clone
            TRec.Filter = "CONTYPE='S'"
            If Not TRec.EOF Then
                AccRecSet.Filter = adFilterNone
                AccRecSet.Sort = "SRNO ASC"
                AccRecSet.Filter = "SAUDACODE='" & LSaudaCode & "' AND PARTYCODE='" & PartyRec!AC_CODE & "' And PATTAN ='C'"
                Do While Not AccRecSet.EOF
                    LCBrokAmt = 0: LcTranAmt = 0
                    LBrokType = IIf(IsNull(TRec!broktype), "T", TRec!broktype):         LBrokRate = Val(TRec!brokrate & vbNullString)
                    LBrokRate2 = Val(TRec!BROKRATE2 & vbNullString):                    LBrokQty = IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY)
                    LBrokQty2 = IIf(IsNull(TRec!BROKQTY2), 0, TRec!BROKQTY2)
                    
                    If Not IsNull(TRec!ORDNO) Then
                        If TRec!ORDNO = "Carry" Then
                            LBrokRate = LBrokRate2
                        End If
                    End If

                    If GOnlyBrok = 0 Then
                        LATranType = IIf(IsNull(TRec!TRANTYPE), "T", TRec!TRANTYPE):    LTranRate = Val(TRec!TRANRATE & vbNullString)
                        If TRec!Condate >= GSTMDate And TRec!Condate < LStampDutyDate And (LPStmType = "R" Or LPStmType = "P") Then
                            LStmRate = 0
                        Else
                            LStmRate = Val(TRec!STMRATE & vbNullString):
                        End If
                        LEQSTTRate = Val(TRec!EQ_STT & vbNullString):          LEQSTMRate = Val(TRec!EQ_STAMP & vbNullString)
                        LSTTRate = Val(TRec!STTRATE & vbNullString):          LSEBITax = Val(TRec!SEBITAX & vbNullString)
                        MSrvTax = Val(TRec!SRVTAX & vbNullString):            LSBCTax = Val(TRec!SBC_TAX & vbNullString)
                        LCGSTRate = Val(TRec!CGSTRATE):                       LSGSTRate = Val(TRec!SGSTRATE)
                        LIGSTRate = Val(TRec!IGSTRATE):                       LUTTRate = Val(TRec!UTTRATE)
                        LSEBITax = Val(TRec!SEBITAX):                         LSTTRate = Val(TRec!STTRATE & vbNullString)
                    End If
                    If TRec!PATTAN <> "C" Then
                        lOpQty = lOpQty - TRec!QTY:
                        LNetPosition = LNetPosition - Abs(TRec!QTY)
                        LBalQty = LBalQty - TRec!QTY
                        LTotOpAmt = LTotOpAmt - (TRec!QTY * TRec!Rate * LCalval)
                        'LNetPosition = LNetPosition - abslOpQty
                        If MFormat = "Account Statement" Then
                            'AccRecSet.AddNew
                            CountRec = CountRec + 1
                            
                            '>>> account statement report grouping
                            If Check10.Value = 1 Then
                                LRptGrp = 2 'old
                                'LRptGrp = 1
                            Else
                                LRptGrp = 1 'old
                                'LRptGrp = 2
                            End If
                            
                            If LBrokType = "P" Then
                                LGBrokName = "Percentage Wise"
                            ElseIf LBrokType = "T" Then
                                LGBrokName = "Transaction Wise"
                            ElseIf LBrokType = "O" Then
                                LGBrokName = "Opening Sauda"
                            End If
                            LGBrokRate = str(Round(LBrokRate, 4))
                    
                            Call Add_To_AccRecSet(LRptGrp, CountRec, LSetNo, TRec!QTY, TRec!Rate, vbNullString, TRec!Condate, LNetRecdPay, LNetMargin, vbNullString, 0, 0, LprevBal, TRec!CONTYPE, LRefLot, LCalval, "O", LBrokType, LInstType)
                        End If
                    Else
                        LSellAmt = TRec!QTY * TRec!Rate * LCalval:      LTotSellAmt = LTotSellAmt + LSellAmt
                        LTotSellQty = LTotSellQty + TRec!QTY:
                        LTotSQAmt = LTotSQAmt + LSellAmt
                        If LBrokType = "Z" Then LBrokQty = LBrokLot
                        If LBrokType = "R" Then LBrokQty2 = LBrokLot
                        If LBrokType = "A" Then LBrokQty2 = LBrokLot
                        If LBrokType = "5" Then LBrokQty2 = LBrokLot
                       ' If TRec!pattan <> "O" Then
                            If (LBrokType = "O" Or LBrokType = "C" Or LBrokType = "A" Or LBrokType = "5") Then LBrokQty = Get_BrokQty(LBrokType, LBalQty, "S", TRec!QTY)
                        'End If
                        LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, LBrokQty, TRec!QTY, TRec!Rate, LCalval, LInstType, LStrike, LBrokQty2, LTradeableLot, "S", "2", LItemID)
                        If LMinRate <> 0 And (LMinRate * (TRec!QTY / LRefLot)) > LCBrokAmt Then
                            LCBrokAmt = LMinRate * (TRec!QTY / LRefLot)
                        End If
                        
                        LBrokAmount = LBrokAmount + LCBrokAmt
                        LBalQty = LBalQty - TRec!QTY
                        
                        If GOnlyBrok = 0 Then
                            If LInstType = "CSH" Then
                                LStmAmt = (LStmRate / 100) * ((TRec!QTY - LBrokQty2) * TRec!Rate * LCalval)
                                LTotStmAmt = LTotStmAmt + LStmAmt
                                LTotStmAmt = LTotStmAmt + ((LEQSTMRate / 100) * (LBrokQty2 * TRec!Rate * LCalval))
                                LSTTAmt = (LSTTRate / 100) * ((TRec!QTY - LBrokQty2) * TRec!Rate * LCalval)
                                LTotSTTAmt = LTotSTTAmt + LSTTAmt
                                LTotSTTAmt = LTotSTTAmt + (((LEQSTTRate / 100) * ((LBrokQty2) * TRec!Rate * LCalval)))
                            Else
                                LStmAmt = ((LStmRate / 100) * LSellAmt):
                                LSTTAmt = ((LSTTRate / 100) * LSellAmt):
                                LTotStmAmt = LTotStmAmt + LStmAmt
                                LTotSTTAmt = LTotSTTAmt + LSTTAmt
                            End If
                            LSEBITaxAmt = ((LSEBITax / 100) * LSellAmt):    LTotSEBITaxAmt = LTotSEBITaxAmt + LSEBITaxAmt
                            If LATranType = "T" Then
                                LcTranAmt = (LTranRate * TRec!QTY): LTranAmount = LTranAmount + LcTranAmt
                            ElseIf LATranType = "P" Then
                                LcTranAmt = ((LTranRate / 100) * TRec!QTY * TRec!Rate * LCalval): LTranAmount = LTranAmount + LcTranAmt
                            End If
                        End If
                        If MFormat = "Account Statement" Then
                            'sachin11
                            AccRecSet.Fields("CONTDATE1") = Format(TRec!Condate, "yyyy/MM/dd"): AccRecSet.Fields("SQNTY") = TRec!QTY: AccRecSet.Fields("SRate") = TRec!Rate
                            AccRecSet.Fields("CRAMOUNT") = TRec!QTY * TRec!Rate
                            AccRecSet.Fields("SBROKRate") = LBrokRate:               AccRecSet.Fields("SBROKQTY") = 0
                            AccRecSet.Fields("SBROKType") = LBrokType:               AccRecSet.Fields("SBROKAMT") = LCBrokAmt
                            AccRecSet.Fields("SCONNO") = TRec!ROWNO1:                AccRecSet.Fields("SCONTIME") = TRec!contime
                            AccRecSet.Fields("SEBITAX") = Val(LSEBITax):             AccRecSet.Update
                        End If
                    End If
                    AccRecSet.MoveNext
                    'Service tax calculation **************
                    If GOnlyBrok = 0 Then
                        LCGSTAmt = LCGSTAmt + ((LCBrokAmt * LCGSTRate) / 100)
                        LSGSTAmt = LSGSTAmt + ((LCBrokAmt * LSGSTRate) / 100)
                        LIGSTAmt = LIGSTAmt + ((LCBrokAmt * LIGSTRate) / 100)
                        LUTTAmt = LUTTAmt + ((LCBrokAmt * LUTTRate) / 100)
                        GSrvTax = GSrvTax + (LCBrokAmt * MSrvTax) / 100
                        LSBCTaxAmt = LSBCTaxAmt + (LCBrokAmt * LSBCTax) / 100
                    End If
                    If GSrStdYN = "Y" Then
                        If TRec!Condate >= DateValue(GSrvDate) Then
                            GSrvTax = GSrvTax + (LcTranAmt * MSrvTax) / 100
                            LSBCTaxAmt = LSBCTaxAmt + (LcTranAmt * LSBCTax) / 100
                            LCGSTAmt = LCGSTAmt + ((LcTranAmt * LCGSTRate) / 100)
                            LSGSTAmt = LSGSTAmt + ((LcTranAmt * LSGSTRate) / 100)
                            LIGSTAmt = LIGSTAmt + ((LcTranAmt * LIGSTRate) / 100)
                            LUTTAmt = LUTTAmt + ((LcTranAmt * LUTTRate) / 100)
                        End If
                        If TRec!Condate >= DateValue(GSrvDate2) Then
                            LCGSTAmt = LCGSTAmt + ((LSEBITaxAmt * LCGSTRate) / 100)
                            LSGSTAmt = LSGSTAmt + ((LSEBITaxAmt * LSGSTRate) / 100)
                            LIGSTAmt = LIGSTAmt + ((LSEBITaxAmt * LIGSTRate) / 100)
                        End If
                        
                    End If
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
                Do While Not TRec.EOF
                    LBrokType = IIf(IsNull(TRec!broktype), "T", TRec!broktype):         LBrokRate = Val(TRec!brokrate & "")
                    LBrokRate2 = Val(TRec!BROKRATE2 & vbNullString):   LBrokQty = IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY)
                    LBrokQty2 = IIf(IsNull(TRec!BROKQTY2), 0, TRec!BROKQTY2)
                    If Not IsNull(TRec!ORDNO) Then
                        If TRec!ORDNO = "Carry" Then
                            LBrokRate = LBrokRate2
                        End If
                    End If
                    If LBrokType = "Z" Then LBrokQty = LBrokLot
                    If LBrokType = "R" Then LBrokQty2 = LBrokLot
                    If LBrokType = "A" Then LBrokQty2 = LBrokLot
                    If LBrokType = "5" Then LBrokQty2 = LBrokLot
                    If (LBrokType = "O" Or LBrokType = "C" Or LBrokType = "A" Or LBrokType = "5") Then LBrokQty = Get_BrokQty(LBrokType, LBalQty, "S", TRec!QTY)
                    LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, LBrokQty, TRec!QTY, TRec!Rate, LCalval, LInstType, LStrike, LBrokQty2, LTradeableLot, "S", "2", LItemID)
                    If LMinRate <> 0 And (LMinRate * (TRec!QTY / LRefLot)) > LCBrokAmt Then
                        LCBrokAmt = LMinRate * (TRec!QTY / LRefLot)
                     End If
                    LBalQty = LBalQty - TRec!QTY
                    
                    If GOnlyBrok = 0 Then
                        LATranType = IIf(IsNull(TRec!TRANTYPE), "T", TRec!TRANTYPE):        LTranRate = Val(TRec!TRANRATE & "")
                        If TRec!Condate >= GSTMDate And TRec!Condate < LStampDutyDate And (LPStmType = "R" Or LPStmType = "P") Then
                            LStmRate = 0
                        Else
                            LStmRate = Val(TRec!STMRATE & vbNullString)
                        End If
                        
                        LEQSTTRate = Val(TRec!EQ_STT & vbNullString)
                        LEQSTMRate = Val(TRec!EQ_STAMP & vbNullString)
                        
                        LSTTRate = Val(TRec!STTRATE & vbNullString):       LSEBITax = Val(TRec!SEBITAX & vbNullString)
                        MSrvTax = Val(TRec!SRVTAX & vbNullString):         LSBCTax = Val(TRec!SBC_TAX)
                        LCGSTRate = Val(TRec!CGSTRATE):                    LSGSTRate = Val(TRec!SGSTRATE)
                        LIGSTRate = Val(TRec!IGSTRATE):                    LUTTRate = Val(TRec!UTTRATE)
                    End If
                        
                    If TRec!PATTAN <> "C" Then
                        lOpQty = lOpQty - TRec!QTY: LTotOpAmt = LTotOpAmt - (TRec!QTY * TRec!Rate * LCalval)
                        LCBrokAmt = 0
                        LNetPosition = LNetPosition - Abs(TRec!QTY)
                    Else
                        LSellAmt = TRec!QTY * TRec!Rate * LCalval:      LTotSellAmt = LTotSellAmt + LSellAmt
                        LTotSellQty = LTotSellQty + TRec!QTY:
                        LTotSQAmt = LTotSQAmt + LSellAmt
                        LBrokAmount = LBrokAmount + LCBrokAmt
                        If GOnlyBrok = 0 Then
                            If LInstType = "CSH" Then
                                LStmAmt = (LStmRate / 100) * ((TRec!QTY - LBrokQty2) * TRec!Rate * LCalval)
                                LTotStmAmt = LTotStmAmt + LStmAmt
                                LTotStmAmt = LTotStmAmt + ((LEQSTMRate / 100) * (LBrokQty2 * TRec!Rate * LCalval))
                                LSTTAmt = (LSTTRate / 100) * ((TRec!QTY - LBrokQty2) * TRec!Rate * LCalval)
                                LTotSTTAmt = LTotSTTAmt + LSTTAmt
                                LTotSTTAmt = LTotSTTAmt + (((LEQSTTRate / 100) * ((LBrokQty2) * TRec!Rate * LCalval)))
                            Else
                                LStmAmt = (LStmRate / 100) * LSellAmt:
                                LSTTAmt = (LSTTRate / 100) * LSellAmt:
                                LTotStmAmt = LTotStmAmt + LStmAmt
                                LTotSTTAmt = LTotSTTAmt + LSTTAmt
                            End If
                            LSEBITaxAmt = (LSEBITax / 100) * LSellAmt:        LTotSEBITaxAmt = LTotSEBITaxAmt + LSEBITaxAmt
                            GSrvTax = GSrvTax + (LCBrokAmt * MSrvTax) / 100
                            LSBCTaxAmt = LSBCTaxAmt + (LCBrokAmt * LSBCTax) / 100
                            LcTranAmt = 0
                            If LATranType = "P" Then LcTranAmt = ((LTranRate / 100) * TRec!QTY * TRec!Rate * LCalval): LTranAmount = LTranAmount + LcTranAmt
                            LCGSTRate = Val(TRec!CGSTRATE):       LSGSTRate = Val(TRec!SGSTRATE):       LIGSTRate = Val(TRec!IGSTRATE):      LUTTRate = Val(TRec!UTTRATE)
                            LCGSTAmt = LCGSTAmt + ((LCBrokAmt * LCGSTRate) / 100)
                            LSGSTAmt = LSGSTAmt + ((LCBrokAmt * LSGSTRate) / 100)
                            LIGSTAmt = LIGSTAmt + ((LCBrokAmt * LIGSTRate) / 100)
                            LUTTAmt = LUTTAmt + ((LCBrokAmt * LUTTRate) / 100)
                            If GSrStdYN = "Y" Then
                                If TRec!Condate >= DateValue(GSrvDate) Then
                                    GSrvTax = GSrvTax + (LcTranAmt * MSrvTax) / 100
                                    LSBCTaxAmt = LSBCTaxAmt + (LcTranAmt * LSBCTax) / 100
                                    LCGSTAmt = LCGSTAmt + ((LcTranAmt * LCGSTRate) / 100)
                                    LSGSTAmt = LSGSTAmt + ((LcTranAmt * LSGSTRate) / 100)
                                    LIGSTAmt = LIGSTAmt + ((LcTranAmt * LIGSTRate) / 100)
                                    LUTTAmt = LUTTAmt + ((LcTranAmt * LUTTRate) / 100)
                                End If
                                If TRec!Condate >= DateValue(GSrvDate2) Then
                                    LCGSTAmt = LCGSTAmt + ((LSEBITaxAmt * LCGSTRate) / 100)
                                    LSGSTAmt = LSGSTAmt + ((LSEBITaxAmt * LSGSTRate) / 100)
                                    LIGSTAmt = LIGSTAmt + ((LSEBITaxAmt * LIGSTRate) / 100)
                                End If
                            End If
                        End If
                    End If
                    If MFormat = "Account Statement" Then
                        'AccRecSet.AddNew
                        CountRec = CountRec + 1:
                        
                        '>>> account statement report grouping
                        If Check10.Value = 1 Then
                            LRptGrp = 2: 'old
                            'LRptGrp = 1:  ''rrrrrrrrrr
                        Else
                            LRptGrp = 1: 'old
                            'LRptGrp = 2:
                        End If
                        If LBrokType = "P" Then
                            LGBrokName = "Percentage Wise"
                        ElseIf LBrokType = "T" Then
                                LGBrokName = "Transaction Wise"
                        ElseIf LBrokType = "O" Then
                            LGBrokName = "Opening Sauda"
                        End If
                        LGBrokRate = str(Round(LBrokRate, 4))
                    
                        Call Add_To_AccRecSet(LRptGrp, CountRec, LSetNo, TRec!QTY, TRec!Rate, (TRec!ROWNO1 & vbNullString), TRec!Condate, LNetRecdPay, LNetMargin, TRec!contime, LBrokRate, LCBrokAmt, LprevBal, TRec!CONTYPE, LRefLot, LCalval, TRec!PATTAN, LBrokType, LInstType)
                    End If
                    TRec.MoveNext
                Loop
            End If
            Set TRec = Nothing
        End If
        End If '>>> If Check12.Value = 0 Then
        ''END SOLD
        LCBrokAmt = 0
        
        ''CLOSING CALC
        If MFormat = "Bill Summary" Or MFormat = "Bill Summary With Sharing" Or MFormat = "Account Statement Summary" Then  '
            If LTotOpAmt > 0 Then
                LTotBuyAmt = LTotBuyAmt + LTotOpAmt
            Else
                LTotSellAmt = LTotSellAmt + Abs(LTotOpAmt)
            End If
        End If
        'LClQty = Round(Val(LTotBuyQty), 2) - Round(Val(LTotSellQty), 2) + Val(lOpQty)
        LClQty = LNetPosition + Round(Val(LTotBuyQty) - Val(LTotSellQty), 2)
        If (LInstType = "OPT" And OptMTMChk.Value = 0 And Lmaturity <= LTillDate) Then
            LClQty = Val(LTotBuyQty) - Val(LTotSellQty) + (Val(LNetOpenPosition) * -1)
        End If
        If (LInstType = "OPT" And OptMTMChk.Value = 0) Or (LInstType = "CSH" And CshMTMchk.Value = 0) Then
             LClQty = 0
        End If
       ' LClQty = Round(LClQty, 2)
        LNetPosition = LNetPosition + Round(Val(LTotBuyQty) - Val(LTotSellQty), 2)
        If LBillBy = "P" Then
            If LPCLRATE <> 0 Then
                LCloseRate = LPCLRATE
            Else
                If LClQty <> 0 Then LCloseRate = SDCLRATE(LSaudaID, IIf(Lmaturity <= LTillDate, Lmaturity, LTillDate), "C") ''CLOSING RATE
            End If
        Else
            If LClQty <> 0 Then LCloseRate = SDCLRATE(LSaudaID, IIf(Lmaturity <= LTillDate, Lmaturity, LTillDate), "C") ''CLOSING RATE
        End If
        
        LMarAmt = 0
        If (LInstType = "OPT" And OptMTMChk.Value = 0) Or (LInstType = "CSH" And CshMTMchk.Value = 0) Then LClQty = 0
        If (LInstType = "OPT" And OptMTMChk.Value = 0 And Lmaturity <= LTillDate) And LCloseRate <> 0 Then
            LClQty = Val(LTotBuyQty) - Val(LTotSellQty) + (Val(LNetOpenPosition))
            If LOptType = "CE" And LCloseRate >= LStrike Then
                LCloseRate = Round(LCloseRate - LStrike, 2)
            ElseIf LOptType = "CE" And LCloseRate < LStrike Then
                LClQty = 0
                LCloseRate = 0
            End If
            If LOptType = "PE" And LCloseRate > LStrike Then
                LCloseRate = 0
                LClQty = 0
            End If
        End If

        If Option1.Value = True Then
            If LTillDate < Lmaturity Then
                If LClQty <> 0 Then
                    LMarRate = 0: LMarType = "V"
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset      ''BROKERAGE CALCULATION
                    mysql = "SELECT TOP 1 MARTYPE,MARRATE FROM PITBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >= '" & Format(LTillDate, "yyyy/MM/dd") & "' AND AC_CODE='" & PartyRec!AC_CODE & "' AND ITEMID=" & LItemID & " AND INSTTYPE ='" & LInstType & "' ORDER BY UPTOSTDT ":
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If TRec.EOF Then
                        Set TRec = Nothing: Set TRec = New ADODB.Recordset      ''BROKERAGE CALCULATION
                        mysql = "SELECT TOP 1 MARTYPE,MARRATE FROM PEXBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >= '" & Format(LTillDate, "yyyy/MM/dd") & "' AND AC_CODE='" & PartyRec!AC_CODE & "' AND EXID =" & LExID & " AND INSTTYPE ='" & LInstType & "' ORDER BY UPTOSTDT ":
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            LMarRate = 0: LMarType = vbNullString: LMarRate = 0
                        Else
                            LMarType = IIf(IsNull(TRec!MARTYPE), "T", TRec!MARTYPE)
                            LMarRate = IIf(IsNull(TRec!MARRATE), 0, TRec!MARRATE)
                            LMarRate = LMarRate
                        End If
                    Else
                        LMarType = IIf(IsNull(TRec!MARTYPE), "T", TRec!MARTYPE)
                        LMarRate = IIf(IsNull(TRec!MARRATE), 0, TRec!MARRATE)
                    End If
                    Set TRec = Nothing
                    LMarAmt = Calc_Margin(LMarType, LMarRate, LSaudaCode, LTillDate, Abs(LClQty), LCloseRate, PartyRec!AC_CODE, LCalval, LAExCode)
                End If ' LClQty
            End If
        End If 'maturity
        If PartyRec!AC_CODE = LContractAcc Then LMarAmt = LMarAmt * -1
        If LClQty <> 0 And LCloseRate = 0 Then If MsgBox("Closing Rate missing for Sauda " & LSaudaCode & " of date " & CStr(LTillDate), vbOKCancel) = vbCancel Then Exit Sub
        MCLPattan = "B"
        
        If LTillDate >= Lmaturity And LClQty <> 0 And LBrokType <> "3" Then
            LBrokRate = 0: LBrokType = "P": LATranType = "P": LTranRate = 0:        LBrokRate2 = 0
            If LInstType = "OPT" And LOptCutBrok = "0" Then
                LBrokRate = 0:      LBrokType = "T":
                LBrokRate2 = 0:    LATranType = "P":
                LTranRate = 0:
            ElseIf LInstType = "FUT" And LFutCutBrok = "0" Then
                LBrokRate = 0:      LBrokType = "T":
                LBrokRate2 = 0:    LATranType = "P":
                LTranRate = 0:
            Else
                Set TRec = Nothing: Set TRec = New ADODB.Recordset   ''BROKERAGE CALCULATION
                mysql = " EXEC GET_BROKRATE " & LACCID & "," & LExID & "," & LItemID & ",'" & Format(Lmaturity, "YYYY/MM/DD") & "','" & LInstType & "'"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    If TRec!MinRate > LCloseRate Then
                        LBrokRate = TRec!MBROKRATE:      LBrokType = TRec!MBROKTYPE:
                        LBrokRate2 = TRec!MBROKRATE2:    LATranType = TRec!TRANTYPE:
                        LTranRate = TRec!TRANRATE:
                    Else
                        LBrokRate = TRec!brokrate:      LBrokType = TRec!broktype:
                        LBrokRate2 = TRec!BROKRATE2:    LATranType = TRec!TRANTYPE:
                        LTranRate = TRec!TRANRATE:
                    End If
                End If
                Set TRec = Nothing
            End If
            MSrvTax = 0
            If GSrTaxApp = "1" Or LCGSTType = "1" Or LIGSTType = "1" Or LIGSTType = "1" Then
                Set TRec = Nothing: Set TRec = New ADODB.Recordset
                mysql = "SELECT SERVICETAX,SBC_TAX,STCTAX,CGSTRATE,SGSTRATE,IGSTRATE,UTTRATE FROM EXTAX WHERE COMPCODE =" & GCompCode & " "
                mysql = mysql & " AND EXCHANGECODE = '" & LAExCode & "' AND FROMDT <='" & Format(Lmaturity, "YYYY/MM/DD") & "' And TODT >='" & Format(Lmaturity, "YYYY/MM/DD") & "'"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                
                If Not TRec.EOF Then
                    MSrvTax = Val(TRec!servicetax & vbNullString):  LSBCTax = Val(TRec!SBC_TAX & vbNullString):
                    LSEBITax = Val(TRec!STCTAX):                    LCGSTRate = Val(TRec!CGSTRATE):
                    LSGSTRate = Val(TRec!SGSTRATE):                 LIGSTRate = Val(TRec!IGSTRATE):
                    LUTTRate = Val(TRec!UTTRATE)
                Else
                    MSrvTax = 0:    LSBCTax = 0:        LCGSTRate = 0: LSBCTax = 0
                    LSGSTRate = 0:  LIGSTRate = 0:      LUTTRate = 0: LSEBITax = 0
                End If
                Set TRec = Nothing: Set TRec = New ADODB.Recordset
                mysql = "SELECT SEBITAX FROM ITEM_TAX WHERE COMPCODE =" & GCompCode & " AND ITEMID =" & LItemID & " AND FROMDT<='" & Format(Lmaturity, "YYYY/MM/DD") & "' AND TODT >='" & Format(Lmaturity, "YYYY/MM/DD") & "'"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSEBITax = Val(TRec!SEBITAX)
                End If
            End If
            MCLPattan = "A"
            LCBrokAmt = 0
            If LCloseRate <> 0 Then
                LBrokQty = Abs(LClQty)
                If LBrokType = "Z" Then LBrokQty = LBrokLot
                If LBrokType = "R" Then LBrokQty2 = LBrokLot
                If LBrokType = "A" Then LBrokQty2 = LBrokLot
                If LBrokType = "O" Then
                    LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, 0, Abs(LClQty), LCloseRate, LCalval, LInstType, LStrike, 0, LTradeableLot, "B", "2", LItemID)
                ElseIf LBrokType = "R" And LCloseRate = 0 Then
                    LCBrokAmt = 0
                ElseIf LBrokType = "A" Then
                    LCBrokAmt = 0
                Else
                    LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, LBrokQty, Abs(LClQty), LCloseRate, LCalval, LInstType, LStrike, 0, LTradeableLot, "B", "2", LItemID)
                    If LMinRate <> 0 And (LMinRate * (LClQty / LRefLot)) > LCBrokAmt Then
                        LCBrokAmt = LMinRate * (LClQty / LRefLot)
                    End If
                    
                End If
            End If
            LBrokAmount = LBrokAmount + LCBrokAmt
            LSTTRate = 0
            LSTTAmt = ((LSTTRate / 100) * Abs(LClQty) * LCloseRate * LCalval): LTotSTTAmt = LTotSTTAmt + LSTTAmt
            LcTranAmt = 0
            If LATranType = "T" Then
                LcTranAmt = LTranRate * Abs(LClQty): LTranAmount = LTranAmount + LcTranAmt
            ElseIf LATranType = "P" Then
                LcTranAmt = ((LTranRate / 100) * Abs(LClQty) * LCloseRate * LCalval): LTranAmount = LTranAmount + LcTranAmt
            End If
            If LSEBIType <> "N" Then
                LSEBITaxAmt = ((LSEBITax / 100) * (Abs(LClQty) * LCloseRate * LCalval)):
            End If
            LTotSEBITaxAmt = LTotSEBITaxAmt + LSEBITaxAmt
            If LCGSTType = "1" Then LCGSTAmt = LCGSTAmt + ((LCBrokAmt * LCGSTRate) / 100)
            If LSGSTType = "1" Then LSGSTAmt = LSGSTAmt + ((LCBrokAmt * LSGSTRate) / 100)
            If LIGSTType = "1" Then LIGSTAmt = LIGSTAmt + ((LCBrokAmt * LIGSTRate) / 100)
            If LUTTType = "1" Then LUTTAmt = LUTTAmt + ((LCBrokAmt * LUTTRate) / 100)
            GSrvTax = GSrvTax + (LCBrokAmt * MSrvTax) / 100
            LSBCTaxAmt = LSBCTaxAmt + (LCBrokAmt * LSBCTax) / 100
            If GSrStdYN = "Y" Then
                If Lmaturity >= DateValue(GSrvDate) Then
                    GSrvTax = GSrvTax + (LcTranAmt * MSrvTax) / 100
                    LSBCTaxAmt = LSBCTaxAmt + (LcTranAmt * LSBCTax) / 100
                    If LCGSTType = "1" Then LCGSTAmt = LCGSTAmt + ((LcTranAmt * LCGSTRate) / 100)
                    If LSGSTType = "1" Then LSGSTAmt = LSGSTAmt + ((LcTranAmt * LSGSTRate) / 100)
                    If LIGSTType = "1" Then LIGSTAmt = LIGSTAmt + ((LcTranAmt * LIGSTRate) / 100)
                    If LUTTType = "1" Then LUTTAmt = LUTTAmt + ((LcTranAmt * LUTTRate) / 100)
                End If
                If Lmaturity >= DateValue(GSrvDate2) Then
                    LCGSTAmt = LCGSTAmt + ((LSEBITaxAmt * LCGSTRate) / 100)
                    LSGSTAmt = LSGSTAmt + ((LSEBITaxAmt * LSGSTRate) / 100)
                    LIGSTAmt = LIGSTAmt + ((LSEBITaxAmt * LIGSTRate) / 100)
                End If
            End If
        End If
        GSTDChrs = 0:  LSTTRate = 0: LSTTAmt = 0
        If GRoundOff = "Y" Then
            LTranAmount = Round(LTranAmount) * (-1)
            LBrokAmount = Round(LBrokAmount) * (-1)
            LTotSEBITaxAmt = Round(LTotSEBITaxAmt) * (-1)
        Else
            LTranAmount = LTranAmount * (-1)
            LBrokAmount = LBrokAmount * (-1)
            LTotSEBITaxAmt = LTotSEBITaxAmt * (-1)
        End If
        If LRiskMType <> "N" And LRiskMApp = "Y" Then LRiskMAmt = Calc_RiskMFees(LSaudaCode, LAExCode, CStr(PartyRec!AC_CODE), LTFromDate, LTillDate, Lmaturity, LCalval, LItemID, LSaudaID, LACCID)
        LShareAmt = 0
        If GUniqClientId = "BRO2-CHE" Then
            If Check4.Value = 1 Then LShareAmt = Calc_SharePAmt(LSaudaID, PartyRec!AC_CODE, LTFromDate, LTillDate)
        Else
            If Check4.Value = 1 Then LShareAmt = Calc_ShareAmt(LSaudaID, PartyRec!AC_CODE, LTFromDate, LTillDate)
        End If
                
        If LRiskMAmt <> 0 Then
            If LRiskMType = "P" Then LRiskMAmt = LRiskMAmt * -1
            GSrvTax = GSrvTax + (MSrvTax / 100) * (LRiskMAmt * -1)
            LSBCTaxAmt = LSBCTaxAmt + ((LRiskMAmt * -1) * (LSBCTax / 100))
            If LCGSTType = "1" Then LCGSTAmt = LCGSTAmt + ((LRiskMAmt * -1 * LCGSTRate) / 100)
            If LSGSTType = "1" Then LSGSTAmt = LSGSTAmt + ((LRiskMAmt * -1 * LSGSTRate) / 100)
            If LIGSTType = "1" Then LIGSTAmt = LIGSTAmt + ((LRiskMAmt * -1 * LIGSTRate) / 100)
            If LUTTType = "1" Then LUTTAmt = LUTTAmt + ((LRiskMAmt * -1 * LUTTRate) / 100)
        End If
        LTotStmAmt = LTotStmAmt * -1:           LTotSTTAmt = LTotSTTAmt * -1
        LCGSTAmt = LCGSTAmt * -1:               LSGSTAmt = LSGSTAmt * -1:
        LIGSTAmt = LIGSTAmt * -1:               LUTTAmt = LUTTAmt * -1
        
        If LTotSEBITaxAmt = 0 And GUniqClientId = "BRO2-CHE" Then
            If Check4.Value = 1 Then LTotSEBITaxAmt = Calc_SharebAmt(LSaudaID, PartyRec!AC_CODE, LTFromDate, LTillDate)
        End If
        '''cLOSING sAUDA pERCECNTAGE

        'This used to calculate stANDing sum of amount on every settlement
        If LBrokType = "3" Then
            LCloseRate = SDCLRATE(LSaudaID, IIf(Lmaturity <= LTillDate, Lmaturity, LTillDate), "C")
            LBrokAmount = Calculate_Percentage_BrokAmt(lOpQty, LTillDate, LACCID, LSaudaID, LTotOpAmt, LBrokRate, Lmaturity, LCloseRate)
            LBrokAmount = LBrokAmount * -1
        End If
      
        If GStandingYN = "Y" Then
            GSTDChrs = Standing_Amt(LSaudaCode, LAExCode, CStr(PartyRec!AC_CODE), LTFromDate, LTillDate, Lmaturity, LItemCode, LSaudaID)
        End If
'
        If GRoundOff = "Y" Then GSTDChrs = Round(GSTDChrs)
        GSrvTax = (-1) * GSrvTax
        LSBCTaxAmt = LSBCTaxAmt * -1
        If LNetPosition <> 0 Then
            'Party Rate ujjwal
            If LBillBy = "B" Then
                If LClQty > 0 Then
                    LCloseRate = LBuyClRate
                Else
                    LCloseRate = LSellClRate
                End If
            End If
            
            If MFormat = "Bill Summary" Or MFormat = "Bill Summary With Sharing" Or MFormat = "Account Statement Summary" Then      'Or MFORMAT = "Account Statement Summary"
                LCloseAmt = Abs(Val(LClQty)) * LCloseRate * LCalval
                If LClQty > 0 Then
                    LTotSellAmt = LTotSellAmt + LCloseAmt
                Else
                    LTotBuyAmt = LTotBuyAmt + LCloseAmt
                End If
            End If
            ''END CLOSING
            'If (LInstType = "CSH" And CshMTMchk.Value = 0) Or (LInstType = "OPT" And OptMTMChk.Value = 0 And LMaturity < LTillDate) Then
            If (LInstType = "CSH" And CshMTMchk.Value = 0) Then
                AccRecSet.Filter = 0
                AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                AccRecSet.Sort = "SRNO DESC"
                If Not AccRecSet.EOF Then
                    AccRecSet.Fields("BROKERAGE") = Val(LBrokAmount):
                    AccRecSet.Fields("STANDING") = GSTDChrs:          AccRecSet.Fields("TRFEES") = Val(LTranAmount)
                    If LStmFlag = False Then
                        AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt) + Val(LNStmAmt):
                        LStmFlag = True
                    Else
                        AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt)
                    End If
                    AccRecSet.Fields("STTTax") = LTotSTTAmt:                        AccRecSet.Fields("TRANTAX") = LRiskMAmt
                    AccRecSet.Fields("SEBITAXAMT") = LTotSEBITaxAmt:                AccRecSet.Fields("ServiceTax") = GSrvTax
                    AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:                     AccRecSet.Fields("PrevBal") = LprevBal
                    AccRecSet.Fields("DEBITAMT") = LNetRecdPay:                     AccRecSet.Fields("CREDITAMT") = LNetMargin
                    AccRecSet.Fields("SHAREAMT") = LShareAmt:
                    
                    If Check12.Value = 0 Then
                        AccRecSet.Fields("CGSTAMT") = LCGSTAmt
                        AccRecSet.Fields("SGSTAMT") = LSGSTAmt:
                    End If
                    
                    AccRecSet.Fields("IGSTAMT") = LIGSTAmt
                    AccRecSet.Fields("UTTAMT") = LUTTAmt:                           AccRecSet.Update
                Else
                    If Check10.Value = 1 Then 'new '>>> account statement report grouping
                        If (lOpQty <> 0 Or LClQty <> 0 Or LTotSellQty Or LTotBuyQty <> 0) Then
                            AccRecSet.AddNew
                            AccRecSet.Fields("BILLNO") = LSetNo
                            AccRecSet.Fields("RPTGRP") = 1:                     AccRecSet.Fields("SHAREAMT") = LShareAmt
                            CountRec = CountRec + 1:                            AccRecSet.Fields("SRNO") = CountRec
                            AccRecSet.Fields("SAUDACODE") = LSaudaCode:         AccRecSet.Fields("EXCODE") = LAExCode
                            AccRecSet.Fields("ITEMCODE") = LItemCode:
                            AccRecSet.Fields("DRAMOUNT") = Abs(LTotBuyAmt):     AccRecSet.Fields("TRFEES") = LTranAmount
                            AccRecSet.Fields("CRAMOUNT") = Abs(LTotSellAmt):    AccRecSet.Fields("CTYPE") = "B":
                            AccRecSet.Fields("PATTAN") = MCLPattan:             AccRecSet.Fields("BROKERAGE") = LBrokAmount:
                            AccRecSet.Fields("REFLOT") = LRefLot:               AccRecSet.Fields("STANDING") = GSTDChrs
                            AccRecSet.Fields("BRATE") = LCloseRate:             AccRecSet.Fields("SRATE") = LCloseRate
                            AccRecSet.Fields("BQNTY") = Abs(Val(LTotBuyQty)):   AccRecSet.Fields("SQNTY") = Abs(Val(LTotSellQty))
                            AccRecSet.Fields("DEBITAMT") = Abs(LTotBQAmt):      AccRecSet.Fields("CREDITAMT") = Abs(LTotSQAmt)
                            AccRecSet.Fields("OPENQTY") = Val(lOpQty):          AccRecSet.Fields("OPENRATE") = Val(LOpenRate)
                            Call Add_PartyDetails:
                            If LStmFlag = False Then
                                AccRecSet.Fields("TurnOverTax") = LTotStmAmt + LNStmAmt
                                LStmFlag = True
                            Else
                                AccRecSet.Fields("TurnOverTax") = LTotStmAmt
                            End If
                            AccRecSet.Fields("STTTAX") = LTotSTTAmt:            AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt)
                            AccRecSet.Fields("SEBITAXAMT") = LTotSEBITaxAmt:    AccRecSet.Fields("CONTDATE1") = Format(LTillDate, "yyyy/MM/dd"):
                            AccRecSet.Fields("CALVAL") = LCalval:               AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):
                            AccRecSet.Fields("ServiceTax") = GSrvTax::          AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                            AccRecSet.Fields("PrevBal") = LprevBal:             AccRecSet.Fields("BrokRate") = LBrokRate:
                            AccRecSet.Fields("MarRate") = LMarRate:             AccRecSet.Fields("BrokType") = LBrokType:
                            If Check12.Value = 0 Then
                                AccRecSet.Fields("CGSTAMT") = LCGSTAmt:             AccRecSet.Fields("SGSTAMT") = LSGSTAmt
                            End If
                            
                            AccRecSet.Fields("IGSTAMT") = LIGSTAmt:             AccRecSet.Fields("UTTAMT") = LUTTAmt
                            AccRecSet.Fields("CONTIME") = vbNullString:         AccRecSet.Fields("CONNO") = vbNullString:
                            AccRecSet.Fields("MarAmt") = LMarAmt:               AccRecSet.Fields("MarType") = LMarType
                            AccRecSet.Fields("rpattan") = vbNullString
                            AccRecSet.Fields("SBROKRATE") = 0:                   AccRecSet.Fields("SBROKType") = vbNullString
                            AccRecSet.Fields("INVNO") = 0:                      AccRecSet.Fields("CONTDATE") = vbNullString
                            AccRecSet.Update
                        End If
                    End If
                    
                End If
            Else
                Dim mstanding As Boolean
                mstanding = False
                If LTillDate >= Lmaturity And LClQty <> 0 And LBrokType = "3" Then
                    MCLPattan = "A"
                End If
                
                If LTotBuyQty + Abs(LTotSellQty) + Abs(LClQty) + Abs(lOpQty) <> 0 Then
                    If Check12.Value = 0 Then '>>> Account Statement customized format
                        AccRecSet.AddNew
                        mstanding = True
                        CountRec = CountRec + 1:                                             AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("BILLNO") = LSetNo:                                 AccRecSet.Fields("SAUDACODE") = LSaudaCode
       
                        '>>> account statement report grouping
                        If Check10.Value = 1 Then
                            AccRecSet.Fields("RPTGRP") = 2: 'old
                            'AccRecSet.Fields("RPTGRP") = 1:  'rrrrrrrrr
                        Else
                            AccRecSet.Fields("RPTGRP") = 1: 'old
                            'AccRecSet.Fields("RPTGRP") = 2:
                        End If
        
                        AccRecSet.Fields("SHAREAMT") = Val(LShareAmt)
                        AccRecSet.Fields("REFLOT") = LRefLot:                                AccRecSet.Fields("EXCODE") = LAExCode
                        AccRecSet.Fields("ITEMCODE") = LItemCode:                            AccRecSet.Fields("CREDITAMT") = LNetMargin
                        AccRecSet.Fields("ServiceTax") = GSrvTax:                            AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt
                        AccRecSet.Fields("STTTax") = LTotSTTAmt:                             AccRecSet.Fields("SEBITAXAMT") = LTotSEBITaxAmt:
                        AccRecSet.Fields("TRANTAX") = LRiskMAmt:                             AccRecSet.Fields("TRFEES") = LTranAmount
                        AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):       AccRecSet.Fields("CALVAL") = LCalval
                        AccRecSet.Fields("PrevBal") = LprevBal:                              AccRecSet.Fields("DEBITAMT") = LNetRecdPay
                        AccRecSet.Fields("MarRate") = LMarRate:                              AccRecSet.Fields("MarAmt") = LMarAmt
                        AccRecSet.Fields("MarType") = LMarType:                              AccRecSet.Fields("SBROKRATE") = LBrokRate
                        AccRecSet.Fields("BrokType") = LBrokType:
                        AccRecSet.Fields("SBROKType") = LBrokType:
                        If Check12.Value = 0 Then
                            AccRecSet.Fields("CGSTAMT") = Val(LCGSTAmt): AccRecSet.Fields("SGSTAMT") = Val(LSGSTAmt):
                        End If
                        
                        AccRecSet.Fields("IGSTAMT") = Val(LIGSTAmt)
                        AccRecSet.Fields("UTTAMT") = Val(LUTTAmt):                           AccRecSet.Fields("PATTAN") = MCLPattan
                        AccRecSet.Fields("OPENQTY") = Val(lOpQty)
                        AccRecSet.Fields("OPENRATE") = Val(LOpenRate)
    
                        Call Add_PartyDetails
                        If LClQty > 0 Then
                            AccRecSet.Fields("CONTDATE") = Format(LTillDate, "yyyy/MM/dd"):
                            AccRecSet.Fields("SQNTY") = Abs(Val(LClQty)):                       AccRecSet.Fields("SRATE") = LCloseRate
                            AccRecSet.Fields("CTYPE") = "S":
                            If MFormat = "Account Statement" Then
                                AccRecSet.Fields("CRAMOUNT") = Abs(Val(LClQty)) * LCloseRate
                            Else
                                AccRecSet.Fields("DRAMOUNT") = Abs(LTotBuyAmt):                   AccRecSet.Fields("CRAMOUNT") = Abs(LTotSellAmt)
                                AccRecSet.Fields("BQNTY") = Abs(Val(LTotBuyQty))
                                AccRecSet.Fields("SQNTY") = Abs(Val(LTotSellQty))
                                AccRecSet.Fields("DEBITAMT") = Abs(LTotBQAmt)
                                AccRecSet.Fields("CREDITAMT") = Abs(LTotSQAmt)
    
                            End If
                            AccRecSet.Fields("BBROKAMT") = LCBrokAmt
                            AccRecSet.Fields("SBROKAMT") = 0
                        ElseIf LClQty < 0 Then
                            AccRecSet.Fields("CONTDATE1") = Format(LTillDate, "yyyy/MM/dd")
                            AccRecSet.Fields("BQNTY") = Abs(Val(LClQty)):                        AccRecSet.Fields("BRATE") = LCloseRate:
                            AccRecSet.Fields("CTYPE") = "B":                                     AccRecSet.Fields("BBROKAMT") = LCBrokAmt:
                            If MFormat = "Account Statement" Then
                                AccRecSet.Fields("DRAMOUNT") = Abs(Val(LClQty)) * LCloseRate
                            Else
                                AccRecSet.Fields("DRAMOUNT") = Abs(LTotBuyAmt):                  AccRecSet.Fields("CRAMOUNT") = Abs(LTotSellAmt)
                                AccRecSet.Fields("BQNTY") = Abs(Val(LTotBuyQty))
                                AccRecSet.Fields("SQNTY") = Abs(Val(LTotSellQty))
                                AccRecSet.Fields("DEBITAMT") = Abs(LTotBQAmt)
                                AccRecSet.Fields("CREDITAMT") = Abs(LTotSQAmt)
                            End If
                            AccRecSet.Fields("BBROKAMT") = 0
                            AccRecSet.Fields("SBROKAMT") = LCBrokAmt
                        ElseIf LClQty = 0 Then
                            AccRecSet.Fields("CONTDATE1") = Format(LTillDate, "yyyy/MM/dd")
                            AccRecSet.Fields("BQNTY") = Abs(Val(LClQty)):                        AccRecSet.Fields("BRATE") = LCloseRate:
                            AccRecSet.Fields("CTYPE") = "B":                                     AccRecSet.Fields("BBROKAMT") = LCBrokAmt:
                            If MFormat = "Account Statement" Then
                                AccRecSet.Fields("DRAMOUNT") = Abs(Val(LClQty)) * LCloseRate
                            Else
                                AccRecSet.Fields("DRAMOUNT") = Abs(LTotBuyAmt):                  AccRecSet.Fields("CRAMOUNT") = Abs(LTotSellAmt)
                                AccRecSet.Fields("BQNTY") = Abs(Val(LTotBuyQty))
                                AccRecSet.Fields("SQNTY") = Abs(Val(LTotSellQty))
                                AccRecSet.Fields("DEBITAMT") = Abs(LTotBQAmt)
                                AccRecSet.Fields("CREDITAMT") = Abs(LTotSQAmt)
                            End If
                            AccRecSet.Fields("BBROKAMT") = 0
                            AccRecSet.Fields("SBROKAMT") = LCBrokAmt
                        End If
                        AccRecSet.Fields("BROKERAGE") = LBrokAmount:                             AccRecSet.Fields("STANDING") = GSTDChrs
                        If LStmFlag = False Then
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt & vbNullString) + Val(LNStmAmt):
                            LStmFlag = True
                        Else
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt & vbNullString)
                        End If
                        AccRecSet.Fields("BINSTYPE") = "CSH"
                        
                        AccRecSet.Update
                   End If
                End If
            End If
            'check10 show trade confirmation check 5 with standing option 5 with ledger
            If (Check10.Value = 1 Or Check5.Value = 1) Then  'old
                'If Check12.Value = 0 Then
                    If Lmaturity > vcDTP2.Value Then
                    'aaaaaaaaa
                        'If (Check10.Value = 1 And LCloseRate > 0) Or (Check10.Value <> 1) Then
                        'If (Check10.Value = 1  Or (Check10.Value <> 1) Then
                            AccRecSet.AddNew:
                            CountRec = CountRec + 1
                            AccRecSet.Fields("BILLNO") = LSetNo:            AccRecSet.Fields("EXCODE") = LAExCode
                            '>>> account statement report grouping
                            If Check10.Value = 1 Then 'old
                                AccRecSet.Fields("RPTGRP") = 3:
                            Else
                                AccRecSet.Fields("RPTGRP") = 2:
                            End If
                            AccRecSet.Fields("SRNO") = CountRec
                            AccRecSet.Fields("SAUDACODE") = LSaudaCode:                     AccRecSet.Fields("CONTDATE") = Format(LTillDate, "yyyy/MM/dd")
                            AccRecSet.Fields("ITEMCODE") = LItemCode:                       AccRecSet.Fields("REFLOT") = LRefLot
                            Call Add_PartyDetails
                            If LNetPosition > 0 Then
                                AccRecSet.Fields("BQNTY") = Abs(Val(LNetPosition)):         AccRecSet.Fields("SQNTY") = 0:
                            Else
                                AccRecSet.Fields("BQNTY") = 0:                              AccRecSet.Fields("SQNTY") = Abs(Val(LNetPosition)):
                            End If
                            If LCloseRate = 0 And LNetPosition <> 0 Then
                                LCloseRate = SDCLRATE(LSaudaID, IIf(Lmaturity <= LTillDate, Lmaturity, LTillDate), "C") ''CLOSING RATE
                            End If
                            AccRecSet.Fields("SRATE") = LCloseRate:                         AccRecSet.Fields("CTYPE") = "S"
                            AccRecSet.Fields("PATTAN") = MCLPattan:                         AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                            AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):  AccRecSet.Fields("CALVAL") = LCalval
                            AccRecSet.Fields("PrevBal") = LprevBal:                         AccRecSet.Fields("MarType") = LMarType:
                            AccRecSet.Fields("SBROKTYPE") = LBrokType:
                            If LStmFlag = False Then LStmFlag = True
                            AccRecSet.Update
                        'End If
                    End If
                End If
            'End If 'old
        Else
            If (MFormat = "Bill Summary" Or MFormat = "Bill Summary With Sharing" Or MFormat = "Account Statement Summary") And (Abs(LTotBuyAmt) + Abs(LTotSellAmt) + Abs(LTotOpAmt)) <> 0 Then
                AccRecSet.AddNew
                AccRecSet.Fields("BILLNO") = LSetNo
                AccRecSet.Fields("RPTGRP") = 1:                     AccRecSet.Fields("SHAREAMT") = LShareAmt
                CountRec = CountRec + 1:                            AccRecSet.Fields("SRNO") = CountRec
                AccRecSet.Fields("SAUDACODE") = LSaudaCode:         AccRecSet.Fields("EXCODE") = LAExCode
                AccRecSet.Fields("ITEMCODE") = LItemCode:
                AccRecSet.Fields("DRAMOUNT") = Abs(LTotBuyAmt):     AccRecSet.Fields("TRFEES") = LTranAmount
                AccRecSet.Fields("CRAMOUNT") = Abs(LTotSellAmt):    AccRecSet.Fields("CTYPE") = "B":
                AccRecSet.Fields("PATTAN") = MCLPattan:             AccRecSet.Fields("BROKERAGE") = LBrokAmount:
                AccRecSet.Fields("REFLOT") = LRefLot:               AccRecSet.Fields("STANDING") = GSTDChrs
                AccRecSet.Fields("BRATE") = LCloseRate:        AccRecSet.Fields("SRATE") = LCloseRate
                AccRecSet.Fields("BQNTY") = Abs(Val(LTotBuyQty))
                AccRecSet.Fields("SQNTY") = Abs(Val(LTotSellQty))
                AccRecSet.Fields("DEBITAMT") = Abs(LTotBQAmt)
                AccRecSet.Fields("CREDITAMT") = Abs(LTotSQAmt)
                AccRecSet.Fields("OPENQTY") = Val(lOpQty)
                AccRecSet.Fields("OPENRATE") = Val(LOpenRate)
                
                Call Add_PartyDetails:
                If LStmFlag = False Then
                    AccRecSet.Fields("TurnOverTax") = LTotStmAmt + LNStmAmt
                    LStmFlag = True
                Else
                    AccRecSet.Fields("TurnOverTax") = LTotStmAmt
                End If
                AccRecSet.Fields("STTTAX") = LTotSTTAmt:            AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt)
                AccRecSet.Fields("SEBITAXAMT") = LTotSEBITaxAmt:    AccRecSet.Fields("CONTDATE1") = Format(LTillDate, "yyyy/MM/dd"):
                AccRecSet.Fields("CALVAL") = LCalval:               AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):
                AccRecSet.Fields("ServiceTax") = GSrvTax::          AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                AccRecSet.Fields("PrevBal") = LprevBal:             AccRecSet.Fields("BrokRate") = LBrokRate:
                AccRecSet.Fields("MarRate") = LMarRate:             AccRecSet.Fields("BrokType") = LBrokType:
                If Check12.Value = 0 Then
                    AccRecSet.Fields("CGSTAMT") = LCGSTAmt:             AccRecSet.Fields("SGSTAMT") = LSGSTAmt
                End If
                
                AccRecSet.Fields("IGSTAMT") = LIGSTAmt:             AccRecSet.Fields("UTTAMT") = LUTTAmt
                AccRecSet.Fields("CONTIME") = vbNullString:         AccRecSet.Fields("CONNO") = vbNullString:
                AccRecSet.Fields("MarAmt") = LMarAmt:               AccRecSet.Fields("MarType") = LMarType
                AccRecSet.Fields("rpattan") = vbNullString
                AccRecSet.Fields("SBROKRATE") = 0:                   AccRecSet.Fields("SBROKType") = vbNullString
                AccRecSet.Fields("INVNO") = 0:                      AccRecSet.Fields("CONTDATE") = vbNullString
                AccRecSet.Update
            Else
                AccRecSet.Filter = 0
                AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                AccRecSet.Sort = "SRNO DESC"
                If Not AccRecSet.EOF Then
                    AccRecSet.Fields("BROKERAGE") = LBrokAmount
                    AccRecSet.Fields("STANDING") = GSTDChrs
                    AccRecSet.Fields("TRFEES") = LTranAmount
                    If LStmFlag = False Then
                        AccRecSet.Fields("TurnOverTax") = LTotStmAmt + LNStmAmt:
                        LStmFlag = True
                    Else
                        AccRecSet.Fields("TurnOverTax") = LTotStmAmt
                    End If
                    AccRecSet.Fields("SEBITAXAMT") = LTotSEBITaxAmt:    AccRecSet.Fields("STTTax") = LTotSTTAmt
                    AccRecSet.Fields("TRANTAX") = LRiskMAmt:            AccRecSet.Fields("rpattan") = "C"
                    AccRecSet.Fields("ServiceTax") = GSrvTax::          AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                    AccRecSet.Fields("PrevBal") = LprevBal:             AccRecSet.Fields("DEBITAMT") = LNetRecdPay
                    AccRecSet.Fields("CREDITAMT") = LNetMargin:         AccRecSet.Fields("SHAREAMT") = LShareAmt
                    If Check12.Value = 0 Then
                        AccRecSet.Fields("CGSTAMT") = LCGSTAmt:             AccRecSet.Fields("SGSTAMT") = LSGSTAmt
                    End If
                    AccRecSet.Fields("IGSTAMT") = LIGSTAmt:             AccRecSet.Fields("UTTAMT") = LUTTAmt
                    AccRecSet.Update
                End If
            End If
        End If
        
        '>>> account statement report grouping
        If Check10.Value = 1 Then 'old
            Set TRec = Nothing
        End If
        '>>> account statement report grouping
        If (Check10.Value = 1 And Option5.Value And Check12.Value = 0) Then
            'If LedgerFlag = True Then ''>>> account statement report grouping
            If LedgerFlag = False Then 'old
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
            
                mysql = "SELECT A.VOU_NO,A.VOU_DT,a.AMOUNT, A.DR_CR, A.NARRATION FROM VCHAMT AS A WHERE A.COMPCODE=" & GCompCode & " AND A.AC_CODE ='" & LPartyCode & "'"
                mysql = mysql & " AND VOU_TYPE <> 'S' AND A.VOU_DT >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND A.VOU_DT <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                mysql = mysql & "  ORDER BY A.VOU_DT,A.VOU_NO"
                            
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                LBal = Get_ClosingBal(LACCID, vcDTP1.Value - 1)
                If LBal <> 0 Then
                    
                        AccRecSet.AddNew
                        CountRec = CountRec + 1
                        AccRecSet.Fields("RPTGRP") = 6:
                        AccRecSet.Fields("SRNO") = CountRec:
                        AccRecSet.Fields("CONNO") = "Opening Bal"
                        AccRecSet.Fields("CONTDATE") = Format(vcDTP1.Value, "yyyy/MM/dd")
                        AccRecSet.Fields("WORDAMT") = vbNullString
                        'buy sell
                        If LBal < 0 Then
                            AccRecSet.Fields("DEBITAMT") = Abs(LBal)
                            AccRecSet.Fields("CREDITAMT") = 0
                            AccRecSet.Fields("CTYPE") = "D":
                        Else
                            AccRecSet.Fields("DEBITAMT") = 0
                            AccRecSet.Fields("CREDITAMT") = Abs(LBal)
                            AccRecSet.Fields("CTYPE") = "C":
                        End If
                        AccRecSet.Fields("STANDING") = LBal
                        Call Add_PartyDetails
                        Call Add_OtherDetails
                        AccRecSet.Update
                End If
                Do While Not TRec.EOF
                    AccRecSet.AddNew
                    CountRec = CountRec + 1
                    AccRecSet.Fields("RPTGRP") = 6:                     AccRecSet.Fields("SRNO") = CountRec:
                    AccRecSet.Fields("CONNO") = TRec!VOU_NO
                    AccRecSet.Fields("CONTDATE") = Format(TRec!VOU_DT, "yyyy/MM/dd")
                    AccRecSet.Fields("WORDAMT") = TRec!NARRATION
                    'buy sell
                    If TRec!DR_CR = "D" Then
                        AccRecSet.Fields("DEBITAMT") = TRec!AMOUNT
                        AccRecSet.Fields("CREDITAMT") = 0
                        AccRecSet.Fields("CTYPE") = "D":
                        LBal = LBal + (TRec!AMOUNT * -1)
                    Else
                        AccRecSet.Fields("DEBITAMT") = 0
                        AccRecSet.Fields("CREDITAMT") = TRec!AMOUNT
                        AccRecSet.Fields("CTYPE") = "C":
                        LBal = LBal + (TRec!AMOUNT)
                    End If
                    AccRecSet.Fields("STANDING") = LBal
                    Call Add_PartyDetails
                    Call Add_OtherDetails
                    AccRecSet.Update
                    TRec.MoveNext
                Loop
                LedgerFlag = True 'old
        End If
    End If
    CFlag = False
    If Check9.Value = 1 Then
        If Check12.Value = 0 Then
            If Abs(Val(LTotBuyQty)) + Abs(LTotSellQty) + Abs(lOpQty) + Abs(LClQty) <> 0 Then
                    If (Check10.Value = 1 And LCloseRate > 0) Or (Check9.Value = 1) Then
                        AccRecSet.AddNew:
                        CountRec = CountRec + 1
                        AccRecSet.Fields("BILLNO") = LSetNo:
                        AccRecSet.Fields("EXCODE") = LAExCode:
                                        
        '                 old
                        If Check10.Value = 1 Then
                            AccRecSet.Fields("RPTGRP") = 4:
                        Else
                            AccRecSet.Fields("RPTGRP") = 3:
                        End If
        
                        '>>> account statement report grouping
                        If Check9.Value = 1 Then
                            AccRecSet.Fields("RPTGRP") = 4:  '>>> summary
                        Else
                            AccRecSet.Fields("RPTGRP") = 3: '>>> standing > net position
                        End If
                        
                        AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode:     AccRecSet.Fields("CONTDATE") = Format(LTillDate, "yyyy/MM/dd")
                        AccRecSet.Fields("ITEMCODE") = LItemCode:       AccRecSet.Fields("REFLOT") = LRefLot
                        AccRecSet.Fields("OPENQTY") = Val(lOpQty):      AccRecSet.Fields("CLOSEQTY") = Val(LClQty):
                        AccRecSet.Fields("PrevBal") = LprevBal
                        AccRecSet.Fields("DEBITAMT") = LNetRecdPay
                        AccRecSet.Fields("CREDITAMT") = LNetMargin
                        If LTotOpAmt > 0 Then
                            LTotBuyAmt = LTotBuyAmt + LTotOpAmt
                        Else
                            LTotSellAmt = LTotSellAmt + Abs(LTotOpAmt)
                        End If
                        If LClQty > 0 Then
                            LTotSellAmt = LTotSellAmt + (Abs(Val(LClQty)) * LCloseRate * LCalval)
                        Else
                            LTotBuyAmt = LTotBuyAmt + (Abs(Val(LClQty)) * LCloseRate * LCalval)
                        End If
                        AccRecSet.Fields("GROSSMTM") = LTotSellAmt - LTotBuyAmt
                        AccRecSet.Fields("BROKAMT") = LBrokAmount
                        AccRecSet.Fields("NETAMT") = (LTotSellAmt - LTotBuyAmt) + LBrokAmount
                        
                        Call Add_PartyDetails
                        
                        'AccRecSet.Fields("BQNTY") = Abs(Val(LTotBuyQty)):               AccRecSet.Fields("SQNTY") = LTotSellQty:
                        AccRecSet.Fields("SRATE") = LCloseRate:                         AccRecSet.Fields("CTYPE") = "S"
                        AccRecSet.Fields("PATTAN") = MCLPattan:
                        AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):  AccRecSet.Fields("CALVAL") = LCalval
                        
                        AccRecSet.Update
                    End If
                End If
            End If
        End If
            ''END CLOSING
        ''' Update Interest
        Call updinterest(LPartyCode, LSaudaCode_muliple)
            DoEvents
            If PartyRec.EOF Then
                GoTo flag_party
            End If
        Loop '>>> saudarec
flag_party:
        Call flag_party(LPartyCode, LPartyName)
        
        If (TempPart <> LPartyCode) Then
            TempPart = LPartyCode
            If (Check10.Value = 1 And Option5.Value And Check12.Value = 1 And MFormat = "Account Statement") Then
              If LedgerFlag = False Then 'old
                  Set TRecVOU = Nothing: Set TRecVOU = New ADODB.Recordset
                  mysql = "SELECT A.VOU_NO,A.VOU_DT,a.AMOUNT, A.DR_CR, A.NARRATION FROM VCHAMT AS A WHERE A.COMPCODE=" & GCompCode & " AND A.AC_CODE ='" & LPartyCode & "'"
                  If Check11.Value = 1 Then
                      mysql = mysql & " AND VOU_TYPE <> 'S' AND A.VOU_DT ='" & Format(loopdate, "YYYY/MM/DD") & "'"
                  Else
                      mysql = mysql & " AND VOU_TYPE <> 'S' AND VOU_TYPE <> 'I' AND A.VOU_DT >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' and A.VOU_DT <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' "
                  End If
                  mysql = mysql & "  ORDER BY A.VOU_DT,A.VOU_NO"
                  TRecVOU.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                  Do While Not TRecVOU.EOF
                      CountRec = CountRec + 1
                      Call Add_VOUCHER("2", CountRec, "TRAN", TRecVOU!VOU_DT, TRecVOU!VOU_NO, TRecVOU!NARRATION, TRecVOU!DR_CR, TRecVOU!AMOUNT, 0)
                      TRecVOU.MoveNext
                  Loop
              End If
          End If
          CountRec = CountRec + 1
        End If

    Loop '>>> partyrec
Call Client_Margin

GETMAIN.ProgressBar1.Visible = False
GETMAIN.PERLBL.Caption = vbNullString
End Sub

Sub CreateReport(ByVal LPName As String)
Dim GPhone As String
Dim LUserId As String
Dim LAccessHash As String
Dim LFilepath   As String
    If MFormat = "Account Statement" Or MFormat = "Account Statement Summary" Then
        Call Client_Margin
    ElseIf MFormat = "Branch Wise Sharing Report" Then
            If Check5.Value = 1 Then
                If Check3.Value = 1 Then
                    RecRpt.Sort = "fmlyname,ACNAME"
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CLBranch_ShareSummINR.rpt", 1)
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_ShareSummINR.rpt", 1)
                End If
            Else
                If Combo1.ListIndex = 0 Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_ShareDetail.rpt", 1) '>>> Branch_ShareDetail_test.rpt
                ElseIf Combo1.ListIndex = 1 Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_ShareSumm.rpt", 1)
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_ShareCONS.rpt", 1)
                End If
            End If
            mysql = "'Branch Wise Brokerage and Sharing From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            
            RecRpt.MoveFirst
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource RecRpt
            
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            'RDCREPO.FormulaFields.GetItemByName("ACBAL").text = MBal
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
            'RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            'RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            'If Combo1.ListIndex = 0 Then
                RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\Branch-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
            'ElseIf Combo1.ListIndex = 1 Then
             '   RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\Branch-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
              '  RDCREPO.ExportOptions.FormatType = crEFTExcel80
            'Else
             '   RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\Branch-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
              '  RDCREPO.ExportOptions.FormatType = crEFTExactRichText
            'End If
            RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
            RDCREPO.ExportOptions.PDFExportAllPages = True
            RDCREPO.Export False
            
            'RDCREPO.DiscardSavedData: RDCREPO.Database.SetDataSource RecRpt
            'RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            'RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            'CRViewer1.ZOrder: CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
            'CRViewer1.Visible = True: CRViewer1.ReportSource = RDCREPO: CRViewer1.Zoom 1: CRViewer1.ViewReport
  '
        End If
    If MFormat = "Account Statement" Or MFormat = "Account Statement Summary" Then
    AccRecSet.Filter = adFilterNone
    If AccRecSet.RecordCount > 0 Then
        AccRecSet.Sort = "srno asc"
        AccRecSet.MoveFirst
        If MFormat = "Account Statement Summary" Then
            If Combo2.ListIndex = 0 Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmr.rpt", 1)
                mysql = "'Account Statement Summary  From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmrsumm.RPT", 1)
                mysql = "'Account Statement Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            End If
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource AccRecSet
            
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            'RDCREPO.FormulaFields.GetItemByName("ACBAL").text = MBal
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            If Combo1.ListIndex = 0 Then
                RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTTSMR-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
            ElseIf Combo1.ListIndex = 1 Then
                RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTTSMR-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
                RDCREPO.ExportOptions.FormatType = crEFTExcel80
            Else
                RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTTSMR-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
                RDCREPO.ExportOptions.FormatType = crEFTExactRichText
            End If
            RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
            RDCREPO.ExportOptions.PDFExportAllPages = True
            RDCREPO.Export False
        ElseIf MFormat = "Account Statement" Then
            If Check10.Value = 1 Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-lST.RPT", 1)
                mysql = "'From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            ElseIf Check3.Value = 1 Then
                If Option5.Value = True Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B-L.RPT", 1)
                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                ElseIf Option4.Value = True Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B-O.RPT", 1)
                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B.RPT", 1)
                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                End If
            Else
                If Option5.Value = True Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-L.rpt", 1)
                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                Else
                    If Check4.Value = 1 Then
                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-S.rpt", 1)
                        mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                    Else
                        If Check5.Value = 1 Then
                            If Check9.Value = 1 Then
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-ST-SUMM.rpt", 1)
                                mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                            ElseIf Option4.Value = True Then
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-STO.rpt", 1)
                                mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                            Else
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-ST.rpt", 1)
                                mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                            End If
                        Else
                            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT.rpt", 1)
                            mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                        End If
                    End If
                End If
            End If
            GPhone = "Ph: " & GCompPhoneO & ", " & GCompPhoneR & "," & GCompMobile & ""
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource AccRecSet
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            RDCREPO.FormulaFields.GetItemByName("GTTL").text = "'" & GCompTitle & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            RDCREPO.FormulaFields.GetItemByName("OPHONE1").text = "'" & GPhone & "'"
            RDCREPO.FormulaFields.GetItemByName("SRVNO").text = "'" & GSrvRegNo & "'"
            If Option4.Value Then
                mysql = "Y"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            ElseIf Option5.Value Then
                mysql = "L"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            Else
                mysql = "N"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            End If
            If Option1.Value Then
                mysql = "Y"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            ElseIf Option2.Value Then
                mysql = "n"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            Else
                mysql = "N"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            End If
            If Combo1.ListIndex = 0 Then
                LFilepath = TxtReport.text & "" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
            ElseIf Combo1.ListIndex = 1 Then
                LFilepath = TxtReport.text & "" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
                RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
                RDCREPO.ExportOptions.FormatType = crEFTExcel80
            Else
                LFilepath = TxtReport.text & "" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
                RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
                RDCREPO.ExportOptions.FormatType = crEFTExactRichText
            End If
            RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
            RDCREPO.ExportOptions.PDFExportAllPages = True
            RDCREPO.Export False
        End If
        End If
        If ChkTelegram.Value = 1 Then
            Dim LFileName As String
            LFileName = LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
            'Dim TRec As ADODB.Recordset
            'Set TRec = Nothing
            'Set TRec = New ADODB.Recordset
            'mysql = "SELECT FAX,DIRECTOR FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " and NAME ='" & LPName & "'"
            'TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            'If Not TRec.EOF Then
            '    LUserId = TRec!DIRECTOR
            '    LAccessHash = TRec!Fax
            '    'And LenB(LAccessHash) > 0
            '    If LenB(LUserId) > 0 Then
            '        Call send_whatsup(LUserId, LFilepath, LFileName)
            '    Else
            '        MsgBox "UserId not Defined for" & LPName & ""
            '    End If
            'End If
            
            'telegram
            Dim TRec As ADODB.Recordset
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT FAX,DIRECTOR FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " and NAME ='" & LPName & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                LUserId = TRec!DIRECTOR
                LAccessHash = TRec!Fax
                'And LenB(LAccessHash) > 0
                If LenB(LUserId) > 0 Then
                    Call Send_Telegram(LUserId, LAccessHash, LFilepath, LFileName)
                Else
                    MsgBox "UserId not Defined for" & LPName & ""
                End If
            End If
        End If
    End If
End Sub
Public Sub CreateReport_MODULE(ByVal LPName As String)
Dim GPhone As String
Dim LUserId As String
Dim LAccessHash As String
Dim LFilepath   As String

On Error GoTo err1
    'If MFormat = "Account Statement" Or MFormat = "Account Statement Summary" Then
        'Call Client_Margin
    'End If
     GlobalAccRecSet.Filter = adFilterNone
    If GlobalAccRecSet.RecordCount > 0 Then
        GlobalAccRecSet.Sort = "srno asc"
        GlobalAccRecSet.MoveFirst
        If MFormat = "Account Statement Summary" Then
            If Combo2.ListIndex = 0 Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmr.rpt", 1)
                mysql = "'Account Statement Summary  From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmrsumm.RPT", 1)
                mysql = "'Account Statement Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            End If
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource GlobalAccRecSet
            
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            'RDCREPO.FormulaFields.GetItemByName("ACBAL").text = MBal
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            If Combo1.ListIndex = 0 Then
                RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTTSMR-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
            ElseIf Combo1.ListIndex = 1 Then
                RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTTSMR-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
                RDCREPO.ExportOptions.FormatType = crEFTExcel80
            Else
                RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\ACSTTSMR-" & Trim(LPName) & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
                RDCREPO.ExportOptions.FormatType = crEFTExactRichText
            End If
            RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
            RDCREPO.ExportOptions.PDFExportAllPages = True
            RDCREPO.Export False
        ElseIf MFormat = "Account Statement" Then
            If Check10.Value = 1 Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-TST.RPT", 1)
                mysql = "'From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            ElseIf Check3.Value = 1 Then
                If Option5.Value = True Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B-L.RPT", 1)
                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                ElseIf Option4.Value = True Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B-O.RPT", 1)
                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-B.RPT", 1)
                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                End If
            Else
                If Option5.Value = True Then
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-L.rpt", 1)
                    mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                Else
                    If Check4.Value = 1 Then
                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-S.rpt", 1)
                        mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                    Else
                        If Check5.Value = 1 Then
                            If Check9.Value = 1 Then
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-ST-SUMM.rpt", 1)
                                mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                            ElseIf Option4.Value = True Then
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-STO.rpt", 1)
                                mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                            Else
                                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT-ST.rpt", 1)
                                mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                            End If
                        Else
                            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTT.rpt", 1)
                            mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                        End If
                    End If
                End If
            End If
            GPhone = "Ph: " & GCompPhoneO & ", " & GCompPhoneR & "," & GCompMobile & ""
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource GlobalAccRecSet
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            RDCREPO.FormulaFields.GetItemByName("GTTL").text = "'" & GCompTitle & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            RDCREPO.FormulaFields.GetItemByName("OPHONE1").text = "'" & GPhone & "'"
            RDCREPO.FormulaFields.GetItemByName("SRVNO").text = "'" & GSrvRegNo & "'"
            If Option4.Value Then
                mysql = "Y"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            ElseIf Option5.Value Then
                mysql = "L"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            Else
                mysql = "N"
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            End If
            If Option1.Value Then
                mysql = "Y"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            ElseIf Option2.Value Then
                mysql = "n"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            Else
                mysql = "N"
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'" & mysql & "'"
            End If
            If Combo1.ListIndex = 0 Then
                LFilepath = TxtReport.text & "ACSTT-" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "ACSTT-" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
            ElseIf Combo1.ListIndex = 1 Then
                LFilepath = TxtReport.text & "ACSTT-" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
                RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "ACSTT-" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".XLS"
                RDCREPO.ExportOptions.FormatType = crEFTExcel80
            Else
                LFilepath = TxtReport.text & "ACSTT-" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
                RDCREPO.ExportOptions.DiskFileName = TxtReport.text & "ACSTT-" & LPName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".RTF"
                RDCREPO.ExportOptions.FormatType = crEFTExactRichText
            End If
            RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
            RDCREPO.ExportOptions.PDFExportAllPages = True
            RDCREPO.Export False
        End If

        If ChkTelegram.Value = 1 Then
            Dim TRec As ADODB.Recordset
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT FAX,DIRECTOR FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " and NAME ='" & LPName & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                LUserId = TRec!DIRECTOR
                LAccessHash = TRec!Fax
                If LenB(LUserId) > 0 And LenB(LAccessHash) > 0 Then
                    Call Send_Telegram(LUserId, LAccessHash, LFilepath, "")
                Else
                    MsgBox "UserId not Defined for" & LPName & ""
                End If
            End If
        End If
    End If
err1:
If err.Number <> 0 Then
    Resume Next
End If
End Sub
Sub ACC_STT_SMRY()

    Dim TRec As ADODB.Recordset
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
        
    GFBroktype = "N"
    mysql = "SELECT TOP 1 BROKTYPE FROM PEXBROK WHERE COMPCODE =" & GCompCode & " AND MBROKTYPE='F'"
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then GFBroktype = "Y"
    
    Set PartyRec = Nothing
    Set PartyRec = New ADODB.Recordset
    mysql = "SELECT DISTINCT A.ACCID,A.AC_CODE,A.NAME,A.OP_BAL,B.ADD1,B.CITY,B.PANNO,B.PIN,B.PHONEO,B.PHONER,B.FAX,B.MOBILE,B.PIN,B.SRTAXAPP,B.CTTTYPE,B.RISKMTYPE,B.APPLYON,"
    mysql = mysql & " S.SAUDACODE,S.SAUDAID,B.PARTYTYPE,B.EMAIL,B.GSTIN,B.STATE,B.STATECODE,B.OPTCUTBROK,B.FUTCUTBROK,"
    mysql = mysql & " S.INSTTYPE,I.ITEMCODE,S.STRIKEPRICE,S.OPTTYPE,S.MATURITY,I.LOT,S.TRADEABLELOT,I.RISKMAPP,S.BROKLOT,I.SCGROUP,"
    mysql = mysql & " B.SEBITYPE,S.REFLOT,B.CGST,B.SGST,B.IGST,B.UTT ,EX.EXCODE,EX.LOTWISE,EX.CONTRACTACC ,EX.EXID ,I.ITEMID"
    mysql = mysql & " FROM ACCOUNTM AS A, ACCOUNTD AS B, CTR_D AS C, ITEMMAST AS I, SAUDAMAST AS S , EXMAST EX"
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND  A.ACCID =B.ACCID "
    mysql = mysql & " AND S.ITEMID =I.ITEMID AND S.MATURITY >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
    mysql = mysql & " AND A.ACCID =C.ACCID  AND C.SAUDAID=S.SAUDAID AND  EX.EXID =S.EXID "
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  A.AC_CODE  IN (" & LSParties & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    If AllSaudas = False Then mysql = mysql & " AND S.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " ORDER BY A.NAME,EX.EXCODE,I.ITEMCODE,S.INSTTYPE,S.MATURITY"
            
    '--------------
    PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If PartyRec.EOF Then
        MsgBox "No Records.", vbCritical: PartyCmd.SetFocus: Exit Sub
    End If
    
    Call AccRecNew
    Call NewGenerateStatement1
         
    '--------------
'    'NEW process applied - 05 FEB 2021 - start
'        Call AccRecNew_MODULE
'        Set GlobalPartyRec = Nothing
'        Set GlobalPartyRec = New ADODB.Recordset
'        GlobalPartyRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'        If GlobalPartyRec.EOF Then
'            MsgBox "No Records.", vbCritical: PartyCmd.SetFocus: Exit Sub
'        End If
'        Call New_Generate_Statementl_MODULE(vcDTP2.Value, Option4.Value, Option5.Value, Check10.Value, vcDTP1.Value, Check4.Value, OptMTMChk.Value, CshMTMchk.Value, Option1.Value, Check5.Value, Check9.Value, CreateChk.Value, AllExcodes, LSExCodes)
'        Set AccRecSet = GlobalAccRecSet
'    'NEW process applied - 05 FEB 2021 - end
    
        
    AccRecSet.Filter = adFilterNone
    If CreateChk.Value = 1 Then
        MsgBox "Files Exported Successfully"
        Me.MousePointer = 0
        GETMAIN.ProgressBar1.Visible = False
        OkCmd.Enabled = True
        Exit Sub
    Else
        If AccRecSet.EOF Then
            MsgBox "Record not found"
        Else
            AccRecSet.MoveFirst
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            Set TRec = AccRecSet.Clone
            If MFormat = "Sauda Summary" Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "ACSTSMRY.RPT", 1)
                mysql = "'Sauda Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            ElseIf MFormat = "Branchwise Account Statement Summary" Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "BRACSTTSMR.RPT", 1)
                mysql = "'Branch wise Account Statement Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            Else
                If Check4.Value = 1 Then
                    If Combo2.ListIndex = 2 Then 'summary
                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmr-Summ-SHARE.RPT", 1)
                        mysql = "'Account Statement Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                    Else
                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmr-SHARE.RPT", 1)
                        mysql = "'Account Statement Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                    
                    End If
                    
                ElseIf Combo2.ListIndex = 2 Then 'summary
'                        GReportPath = "D:\REPORTS\Acsttsmrsumm_ledger.rpt"
'                        Set RDCREPO = RDCAPP.OpenReport(GReportPath, 1)
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmrSumm.RPT", 1)
                    mysql = "'Account Statement Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                Else
                    If Combo2.ListIndex = 0 Then 'party wise
                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmr.rpt", 1)
                    ElseIf Combo2.ListIndex = 1 Then 'item wise
                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AcsttSmr_itemwise.rpt", 1)
                    End If
                    mysql = "'Account Statement Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
                End If
            End If
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource TRec
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            CRViewer1.ZOrder
            CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
            CRViewer1.Visible = True
            CRViewer1.ReportSource = RDCREPO
            CRViewer1.Zoom 1
            CRViewer1.ViewReport
        End If
        Me.MousePointer = 0
        GETMAIN.ProgressBar1.Visible = False
        OkCmd.Enabled = True
        Exit Sub
    End If
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number

    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub
Sub BILLSMRY()
    Dim LPartyCode As String:   Dim LPartyName As String:   Dim LItemCode As String:
    Dim LParty As String:       Dim LSaudaCode As String
    
    Dim LBrokAmt As Double:     Dim LOpBal As Double:       Dim LSrvAmt As Double:      Dim LTranAmt As Double:
    Dim LStdAmt As Double:      Dim LStmpdty As Double:     Dim LStampDuty As Double:   Dim LSTTAmt As Double:
    Dim LCttAmt As Double:      Dim LNetAmt As Double:      Dim LTotNetAmt As Double:   Dim LTotStd As Double:
    Dim LTotBrok As Double:     Dim LTotTran As Double:     Dim LTotSrv As Double:      Dim LTotStampDuty As Double:
    Dim LTotCttAmt As Double:   Dim LRiskMAmt As Double:    Dim LTotRiskmAmt As Double: Dim LTotSTTAmt As Double
    Dim LSEBIAmt As Double:     Dim LTotSEBIAmt As Double:  Dim LCGSTAmt As Double:     Dim LSGSTAmt As Double
    Dim LIGSTAmt As Double:     Dim LUTTAmt As Double:      Dim LTotSBCAmt As Double:   Dim LHGRate As Double
    Dim LXExCode As String:     Dim LSPartyType  As String: Dim LXBillAmt As Double:    Dim LLowRate As Double
    Dim LNetRate  As Double:    Dim LExCurr As String:
    
    Dim LExRec As ADODB.Recordset: Dim TRec As ADODB.Recordset:    Dim PtyRateRec As ADODB.Recordset
    
    Set LExRec = Nothing
    Set LExRec = New ADODB.Recordset
    mysql = "SELECT EXCODE FROM EXMAST WHERE COMPCODE =" & GCompCode & " AND CURR='Y' "
    LExRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    
     
    
    Me.MousePointer = 11:
    Dim RateRec As ADODB.Recordset
    
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    Call AccRecNew
    
    GFBroktype = "N"
    mysql = "SELECT TOP 1 BROKTYPE FROM PEXBROK WHERE COMPCODE =" & GCompCode & " AND MBROKTYPE='F'"
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then GFBroktype = "Y"
    
    Set PartyRec = Nothing
    Set PartyRec = New ADODB.Recordset
    mysql = "SELECT DISTINCT A.ACCID,A.AC_CODE,A.NAME,A.OP_BAL,"
    mysql = mysql & " B.ADD1,B.CITY, B.PANNO, B.PARTYTYPE, B.PIN, B.PHONEO, B.PHONER, B.FAX, B.MOBILE, B.PIN, B.SRTAXAPP, B.CGST, B.SGST, B.IGST, B.UTT, B.CTTTYPE,B.RISKMTYPE,B.OPTCUTBROK,B.FUTCUTBROK,"
    mysql = mysql & " B.APPLYON,B.EMAIL,B.GSTIN,B.STATE,B.STATECODE,B.SEBITYPE,"
    mysql = mysql & " S.SAUDACODE,S.SAUDAID,S.INSTTYPE,I.ITEMCODE,S.STRIKEPRICE,S.OPTTYPE,S.MATURITY,S.TRADEABLELOT,S.BROKLOT ,S.REFLOT,"
    mysql = mysql & " I.ITEMID,I.LOT,I.RISKMAPP,I.SCGROUP,EX.EXCODE,EX.EXID,EX.LOTWISE,EX.CONTRACTACC "
    mysql = mysql & " FROM ACCOUNTM AS A, ACCOUNTD AS B, CTR_D AS C, ITEMMAST AS I, SAUDAMAST AS S ,EXMAST EX "
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID =B.ACCID "
    mysql = mysql & " AND S.ITEMID =I.ITEMID AND S.MATURITY >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND C.CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    mysql = mysql & " AND A.ACCID=C.ACCID  AND C.SAUDAID=S.SAUDAID"
    mysql = mysql & " AND EX.EXID=S.EXID"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  A.AC_CODE  IN (" & LSParties & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    If AllSaudas = False Then mysql = mysql & " AND S.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " ORDER BY A.NAME,EX.EXCODE,I.ITEMCODE,S.INSTTYPE,S.MATURITY"
    PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If PartyRec.EOF Then
        MsgBox "No Records.", vbCritical:
        Me.MousePointer = 0
        Frame2.Enabled = True
        PartyCmd.SetFocus: Exit Sub
    End If
    Call NewGenerateStatement1
    
    Set PartyRec = Nothing
    LLowRate = 1
    LHGRate = 1
    
    mysql = "SELECT HGRATE,LOWRATE FROM CTR_R  WHERE COMPCODE =" & GCompCode & " AND SAUDA ='USDINR' AND CONDATE  ='" & Format(vcDTP2.Value, "yyyy/mm/dd") & "' "
    Set RateRec = Nothing
    Set RateRec = New ADODB.Recordset
    RateRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not RateRec.EOF Then
        LLowRate = RateRec!LOWRATE
        LHGRate = RateRec!HGRATE
    End If
    
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "LCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "LNAME", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "LDIFFER", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LBROKAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LSTDAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LTRANAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LBILLAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "RNAME", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "RDIFFER", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RBROKAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RSTDAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RTRANAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RBILLAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "ITEMNAME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "LSRVAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RSRVAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LSTAMPAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RSTAMPAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LCTTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RCTTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LRISKM", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RRISKM", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LSEBIAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RSEBIAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LSBCAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RSBCAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LCGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RCGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LSGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RSGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LIGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RIGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LUTTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RUTTAMT", adDouble, , adFldIsNullable
    
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    Call AccRec1
    
    Dim AccClone  As ADODB.Recordset
    AccRecSet.Filter = adFilterNone
    AccRecSet.Sort = "PARTYNAME,EXCODE,SAUDACODE"
    If AccRecSet.RecordCount > 0 Then
        AccRecSet.MoveFirst
        Do While Not AccRecSet.EOF
            LPartyCode = AccRecSet!PARTYCODE:   LPartyName = AccRecSet!PARTYNAME
            LSaudaCode = AccRecSet!saudacode:   LSPartyType = IIf(IsNull(AccRecSet!CINNO), vbNullString, AccRecSet!CINNO)
            LItemCode = AccRecSet!ITEMCODE:     LXExCode = AccRecSet!excode
            LParty = vbNullString:    LNetAmt = 0:    LBrokAmt = 0:  LSrvAmt = 0:   LTranAmt = 0:   LStdAmt = 0:    LCGSTAmt = 0: LIGSTAmt = 0
            LStmpdty = 0:             LStampDuty = 0: LSTTAmt = 0:   LCttAmt = 0:   LOpBal = 0:     LRiskMAmt = 0:  LSEBIAmt = 0: LSGSTAmt = 0: LUTTAmt = 0
            LTotSEBIAmt = 0: LTotSBCAmt = 0
            Do While LPartyName = AccRecSet!PARTYNAME And LSaudaCode = AccRecSet!saudacode
                LNetAmt = LNetAmt + (Val(AccRecSet!DRAMOUNT & vbNullString) - Val(AccRecSet!CRAMOUNT & vbNullString))

                LBrokAmt = LBrokAmt + IIf(IsNull(AccRecSet!BROKERAGE), 0, AccRecSet!BROKERAGE)
                LOpBal = IIf(IsNull(AccRecSet!PREVBAL), 0, AccRecSet!PREVBAL)
                If GOnlyBrok = 0 Then
                    LSrvAmt = LSrvAmt + AccRecSet!servicetax:   LTotSBCAmt = LTotSBCAmt + AccRecSet!SBCTaxAmt
                    LTranAmt = LTranAmt + AccRecSet!TRFEES:     LStdAmt = LStdAmt + AccRecSet!standing
                    LRiskMAmt = LRiskMAmt + AccRecSet!TRANTAX:  LSEBIAmt = LSEBIAmt + AccRecSet!SEBITaxAmt
                    LStampDuty = LStampDuty + AccRecSet!TURNOVERTAX
                    LSTTAmt = LSTTAmt + AccRecSet!STTTax:       LCGSTAmt = LCGSTAmt + AccRecSet!cgstamt
                    LSGSTAmt = LSGSTAmt + AccRecSet!SGSTAMT:    LIGSTAmt = LIGSTAmt + AccRecSet!IGSTAMT
                    LUTTAmt = LUTTAmt + AccRecSet!UTTAMT:
                End If
                AccRecSet.MoveNext
                If AccRecSet.EOF Then Exit Do
            Loop
            
            AccRec.AddNew
            AccRec!PARTYCODE = LPartyCode:              AccRec!PARTYNAME = LPartyName
            AccRec!SAUDANAME = LSaudaCode:              AccRec!excode = LXExCode
            AccRec!PARTYTYPE = LSPartyType:             AccRec!ITEMCODE = LItemCode
            AccRec!PREVBAL = LOpBal:
            LExCurr = "N"
            If LExRec.RecordCount > 0 Then
                LExRec.MoveFirst
                LExRec.Find "EXCODE='" & LXExCode & "'"
                If LExRec.EOF Then
                    LExCurr = "N"
                Else
                    LExCurr = "Y"
                End If
            End If
            AccRec!ECURR = LExCurr
            AccRec!NETAMT = LNetAmt:        AccRec!BROKAMT = LBrokAmt
            AccRec!STAMPDUTY = LStampDuty:  AccRec!SRVAMT = LSrvAmt
            AccRec!TRANSAMT = LTranAmt:     AccRec!STDAMT = LStdAmt
            AccRec!STTTax = LSTTAmt:        AccRec!RISKMAMT = LRiskMAmt
            AccRec!SEBIAMT = LSEBIAmt:      AccRec!SBCAMT = LTotSBCAmt
            AccRec!cgstamt = LCGSTAmt:      AccRec!SGSTAMT = LSGSTAmt
            AccRec!IGSTAMT = LIGSTAmt:      AccRec!UTTAMT = LUTTAmt
            
            AccRec.Update
        Loop
        
        AccRec.MoveFirst
        AccRec.Sort = "PARTYNAME"
        AccRec.MoveFirst
        Set AccClone = Nothing
        Set AccClone = New ADODB.Recordset
        Set AccClone = AccRec.Clone
        Do While Not AccRec.EOF
            LPartyCode = AccRec!PARTYCODE
            LPartyName = AccRec!PARTYNAME
            LXExCode = AccRec!excode
            LSPartyType = AccRec!PARTYTYPE
            LNetAmt = 0:       LTotNetAmt = 0:             LTotStd = 0:        LTotBrok = 0:   LTotTran = 0
            LTotSrv = 0:       LOpBal = AccRec!PREVBAL:    LTotStampDuty = 0:  LTotSTTAmt = 0: LIGSTAmt = 0
            LTotRiskmAmt = 0:  LTotSEBIAmt = 0:            LTotSBCAmt = 0:     LUTTAmt = 0:    LSGSTAmt = 0
            LCGSTAmt = 0:
            Do While LPartyName = AccRec!PARTYNAME
                LNetAmt = LNetAmt + ((AccRec!NETAMT) * -1)
                LTotBrok = LTotBrok + AccRec!BROKAMT
                If Option4.Value Then
                    LTotNetAmt = LTotNetAmt + ((AccRec!NETAMT * -1) + AccRec!BROKAMT + AccRec!STDAMT + AccRec!TRANSAMT + AccRec!STTTax + AccRec!SRVAMT + AccRec!STAMPDUTY + AccRec!RISKMAMT + AccRec!SEBIAMT + AccRec!SBCAMT + AccRec!cgstamt + AccRec!SGSTAMT + AccRec!IGSTAMT + AccRec!UTTAMT) + LOpBal
                Else
                    If GOnlyBrok = 0 Then
                        LTotNetAmt = LTotNetAmt + ((AccRec!NETAMT * -1) + AccRec!BROKAMT + AccRec!STDAMT + AccRec!TRANSAMT + AccRec!STAMPDUTY + AccRec!SRVAMT + AccRec!STTTax + AccRec!RISKMAMT + AccRec!SEBIAMT + AccRec!SBCAMT + AccRec!cgstamt + AccRec!SGSTAMT + AccRec!IGSTAMT + AccRec!UTTAMT)
                    Else
                        LTotNetAmt = LTotNetAmt + ((AccRec!NETAMT * -1) + AccRec!BROKAMT)
                    End If
                End If
                If GOnlyBrok = 0 Then
                    LTotStd = LTotStd + AccRec!STDAMT:              LTotTran = LTotTran + AccRec!TRANSAMT
                    LTotSrv = LTotSrv + AccRec!SRVAMT:              LTotStampDuty = LTotStampDuty + AccRec!STAMPDUTY
                    LTotSTTAmt = LTotSTTAmt + AccRec!STTTax:        LTotRiskmAmt = LTotRiskmAmt + AccRec!RISKMAMT
                    LTotSEBIAmt = LTotSEBIAmt + AccRec!SEBIAMT:     LTotSBCAmt = LTotSBCAmt + AccRec!SBCAMT
                    LCGSTAmt = LCGSTAmt + AccRec!cgstamt:           LSGSTAmt = LSGSTAmt + AccRec!SGSTAMT
                    LIGSTAmt = LIGSTAmt + AccRec!IGSTAMT:           LUTTAmt = LUTTAmt + AccRec!UTTAMT
                End If
                
                LOpBal = 0
                AccRec.MoveNext
                If AccRec.EOF Then GoTo FLAG1
            Loop

FLAG1:
            RecRpt.Filter = adFilterNone
            If Not RecRpt.EOF Then RecRpt.MoveFirst
            
            If LTotNetAmt > 0 Then
                RecRpt.Filter = "LNAME ='ZZZZZ'"
                If RecRpt.EOF Then
                    RecRpt.AddNew
                    RecRpt!RCODE = "0"
                    RecRpt!RNAME = "ZZZZZ"
                    RecRpt!RSrvAmt = 0: RecRpt!RTranAmt = 0: RecRpt!RDIFFER = 0:    RecRpt!RBrokAmt = 0:    RecRpt!RUTTAmt = 0
                    RecRpt!RStdAmt = 0: RecRpt!RBIllAmt = 0: RecRpt!RSTAMPAMT = 0:  RecRpt!RCTTAMT = 0:     RecRpt!RRISKM = 0
                    RecRpt!RSEBIAMT = 0: RecRpt!RSBCAMT = 0: RecRpt!RCGSTAmt = 0:   RecRpt!RSGSTAmt = 0:    RecRpt!RIGSTAmt = 0:
                End If
                RecRpt!LCode = LPartyCode:                RecRpt!LName = LPartyName
                RecRpt!LDIFFER = LNetAmt:
                RecRpt!LBrokAmt = LTotBrok
                RecRpt!LBIllAmt = LTotNetAmt
                If Check4.Value = 1 Then
                    If LSPartyType <> 2 Then
                        If LTotNetAmt > 0 Then
                            RecRpt!LDIFFER = RecRpt!LDIFFER * LLowRate
                            RecRpt!LBrokAmt = RecRpt!LBrokAmt * LLowRate
                            RecRpt!LBIllAmt = RecRpt!LBIllAmt * LLowRate
                        Else
                            RecRpt!LDIFFER = RecRpt!LDIFFER * LHGRate
                            RecRpt!LBrokAmt = RecRpt!LBrokAmt * LHGRate
                            RecRpt!LBIllAmt = RecRpt!LBIllAmt * LHGRate
                        End If
                    Else
                        If LTotNetAmt < 0 Then
                            RecRpt!LDIFFER = RecRpt!LDIFFER * LLowRate
                            RecRpt!LBrokAmt = RecRpt!LBrokAmt * LLowRate
                            RecRpt!LBIllAmt = RecRpt!LBIllAmt * LLowRate
                        Else
                            RecRpt!LDIFFER = RecRpt!LDIFFER * LHGRate
                            RecRpt!LBrokAmt = RecRpt!LBrokAmt * LHGRate
                            RecRpt!LBIllAmt = RecRpt!LBIllAmt * LHGRate
                        End If
                    End If
                End If
                If GOnlyBrok = 0 Then
                    RecRpt!LStdAmt = LTotStd:                 RecRpt!LTranAmt = LTotTran
                    RecRpt!LSrvAmt = LTotSrv:                 RecRpt!LStampAmt = LTotStampDuty
                    RecRpt!LCttAmt = LTotSTTAmt:              RecRpt!LRISKM = LTotRiskmAmt
                    RecRpt!LSEBIAmt = LTotSEBIAmt:            RecRpt!LSBCAmt = LTotSBCAmt
                    RecRpt!LCGSTAmt = LCGSTAmt:               RecRpt!LSGSTAmt = LSGSTAmt:
                    RecRpt!LIGSTAmt = LIGSTAmt:               RecRpt!LUTTAmt = LUTTAmt:
                End If
                
                RecRpt.Update
            ElseIf LTotNetAmt < 0 Then
                RecRpt.Filter = "RNAME ='ZZZZZ'"
                If RecRpt.EOF Then
                    RecRpt.AddNew
                    RecRpt!LCode = "0"
                    RecRpt!LName = "ZZZZZ"
                    RecRpt!LSrvAmt = 0:     RecRpt!LTranAmt = 0:    RecRpt!LDIFFER = 0:     RecRpt!LBrokAmt = 0
                    RecRpt!LStdAmt = 0:     RecRpt!LBIllAmt = 0:    RecRpt!LStampAmt = 0:   RecRpt!LCttAmt = 0:
                    RecRpt!LRISKM = 0:      RecRpt!LSEBIAmt = 0:    RecRpt!LSBCAmt = 0:     RecRpt!LUTTAmt = 0:
                    RecRpt!LCGSTAmt = 0:    RecRpt!LSGSTAmt = 0:    RecRpt!LIGSTAmt = 0:
                End If
                RecRpt!RCODE = LPartyCode
                RecRpt!RNAME = LPartyName:
                RecRpt!RDIFFER = LNetAmt
                RecRpt!RBrokAmt = LTotBrok:
                RecRpt!RBIllAmt = LTotNetAmt
                If Check4.Value = 1 Then
                    If LSPartyType <> 2 Then
                        If LTotNetAmt > 0 Then
                            RecRpt!RDIFFER = RecRpt!RDIFFER * LLowRate
                            RecRpt!RBrokAmt = RecRpt!RBrokAmt * LLowRate
                            RecRpt!RBIllAmt = RecRpt!RBIllAmt * LLowRate
                        Else
                            RecRpt!RDIFFER = RecRpt!RDIFFER * LHGRate
                            RecRpt!RBrokAmt = RecRpt!RBrokAmt * LHGRate
                            RecRpt!RBIllAmt = RecRpt!RBIllAmt * LHGRate
                        End If
                    Else
                        If LTotNetAmt < 0 Then
                            RecRpt!RDIFFER = RecRpt!RDIFFER * LLowRate
                            RecRpt!RBrokAmt = RecRpt!RBrokAmt * LLowRate
                            RecRpt!RBIllAmt = RecRpt!RBIllAmt * LLowRate
                        Else
                            RecRpt!RDIFFER = RecRpt!RDIFFER * LHGRate
                            RecRpt!RBrokAmt = RecRpt!RBrokAmt * LHGRate
                            RecRpt!RBIllAmt = RecRpt!RBIllAmt * LHGRate
                        End If
                    End If
                End If
                If GOnlyBrok = 0 Then
                    RecRpt!RStdAmt = LTotStd
                    RecRpt!RTranAmt = LTotTran:                 RecRpt!RSrvAmt = LTotSrv
                    RecRpt!RSTAMPAMT = LTotStampDuty:           RecRpt!RRISKM = LTotRiskmAmt
                    RecRpt!RSEBIAMT = LTotSEBIAmt:              RecRpt!RSBCAMT = LTotSBCAmt
                    RecRpt!RCGSTAmt = LCGSTAmt:                 RecRpt!RSGSTAmt = LSGSTAmt:
                    RecRpt!RIGSTAmt = LIGSTAmt:                 RecRpt!RUTTAmt = LUTTAmt:
                    RecRpt!RCTTAMT = LTotSTTAmt:
                End If
                
                RecRpt.Update
            End If
        Loop
        
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "BILLPSMRY.rpt", 1)
        mysql = "'Bill Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
        Set TRec = New ADODB.Recordset
        Set TRec = RecRpt.Clone
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
        CRViewer1.ZOrder
        CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True
        CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
    Else
        MsgBox "No Records Found for the selection"
    End If
    Me.MousePointer = 0
    GETMAIN.ProgressBar1.Visible = False
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub

Sub AccRec1()
    Set AccRec = Nothing
    Set AccRec = New ADODB.Recordset
    AccRec.Fields.Append "SAUDANAME", adVarChar, 50, adFldIsNullable
    AccRec.Fields.Append "PARTYNAME", adVarChar, 100, adFldIsNullable
    AccRec.Fields.Append "NETAMT", adDouble, 100, adFldIsNullable
    AccRec.Fields.Append "BROKAMT", adDouble, 50, adFldIsNullable
    AccRec.Fields.Append "STDAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "TRANSAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "SRVAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "PrevBal", adDouble, , adFldIsNullable
    AccRec.Fields.Append "STAMPDUTY", adDouble, , adFldIsNullable
    AccRec.Fields.Append "STTTax", adDouble, , adFldIsNullable
    AccRec.Fields.Append "CTTTax", adDouble, , adFldIsNullable
    AccRec.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    AccRec.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    AccRec.Fields.Append "RISKMAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "SEBIAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "SBCAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "CGSTAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "SGSTAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "IGSTAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "UTTAMT", adDouble, , adFldIsNullable
    AccRec.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    AccRec.Fields.Append "PARTYTYPE", adVarChar, 1, adFldIsNullable
    AccRec.Fields.Append "ECURR", adVarChar, 1, adFldIsNullable
    AccRec.Open , , adOpenKeyset, adLockOptimistic
End Sub
Public Sub Add_PartyDetails()
    AccRecSet.Fields("PARTYCODE") = PartyRec!AC_CODE:       AccRecSet.Fields("PARTYNAME") = Trim$(PartyRec!NAME):
    AccRecSet.Fields("ADDRESS") = Trim$(PartyRec!ADD1):     AccRecSet.Fields("CITY") = Trim$(PartyRec!City):
    If Check12.Value = 0 Then
        AccRecSet.Fields("PIN") = Trim$(PartyRec!Pin):
    End If
    AccRecSet.Fields("PHONEO") = Trim$(PartyRec!PhoneO):
    AccRecSet.Fields("PHONER") = Trim$(PartyRec!PhoneR):    AccRecSet.Fields("FAX") = Trim$(PartyRec!Fax):
    AccRecSet.Fields("MOBILE") = Trim$(PartyRec!Mobile):    AccRecSet.Fields("PANNO") = Trim$(PartyRec!PANNO & vbNullString):
    
    If Not CFlag Then
        AccRecSet.Fields("SAUDACODE") = PartyRec!saudacode:
    End If
    
    AccRecSet.Fields("MATURITY") = PartyRec!MATURITY
    AccRecSet.Fields("ITEMCODE") = PartyRec!ITEMCODE:       AccRecSet.Fields("CINNO") = PartyRec!PARTYTYPE
    
    If Check12.Value = 1 Then '>>> acount statement customized format
        AccRecSet.Fields("EXCODE") = ""
    Else
        AccRecSet.Fields("EXCODE") = PartyRec!excode
    End If
    AccRecSet.Fields("LUSDINRRATE") = LCurrCRate
    AccRecSet.Fields("RUSDINRRATE") = LCurrDRate:           AccRecSet.Fields("EMAIL") = Trim$(PartyRec!Email & vbNullString):
    AccRecSet.Fields("GSTIN") = Trim$(PartyRec!GSTIN & vbNullString):
    AccRecSet.Fields("CLIENTCODE") = Trim$(LClientCode & vbNullString):
    AccRecSet.Fields("STATE") = LGBrokName:
    AccRecSet.Fields("STATECODE") = LGBrokRate
End Sub
Public Sub Add_OtherDetails()
    AccRecSet.Fields("MarType") = "I":           AccRecSet.Fields("BILLDATE") = Format(vcDTP1.Value, "YYYY/MM/DD")
End Sub
Sub BillSummary()
    
    On Error GoTo err1
    Dim Rec As ADODB.Recordset
    LSParties = Get_Parties:    LSSaudas = Get_Saudas_cd:           LSExCodes = Get_ExCodes:           LSInst = Get_Inst
    Me.MousePointer = Val(11):  OkCmd.Enabled = False
    FlagBillSummary = True
    
    ''''' Get Saudas
             
    '>>> start -- Call common function
       
        'If Check11 = 0 Or GUniqClientId <> "MANI-IND" Then
            Call Bill_summary_share(LSParties, LSSaudas, LSExCodes, LSInst, vcDTP1.Value, vcDTP2.Value, Check4.Value, LSFmlyIDs, AllParties, AllFmly, AllSaudas, AllExcodes, AllInst, Check11.Value, unqucc.text, Check3.Value, Check10.Value)
        'Else
         '   Call Bill_smry_shr_cons(LSParties, LSSaudas, LSExCodes, LSInst, vcDTP1.Value, vcDTP2.Value, Check4.Value, LSFmlyIDs, AllParties, AllFmly, AllSaudas, AllExcodes, AllInst, unqucc.text)
        'End If
    '>>> end
    
'    Dim SrNo As Long
'    Dim LMEXCODE  As String:     Dim LSauda  As String:          Dim LOp_Bal As Double:           Dim LOpBalUSD As Double
'    Dim LParty As String:        Dim LPartyName As String:       Dim LPartyCode As String:        Dim LPartyName2 As String
'    Dim BillRec As ADODB.Recordset: Dim PartyRec As ADODB.Recordset: Dim VouRec As ADODB.Recordset
'    Dim MRec As ADODB.Recordset: Dim RecInv As ADODB.Recordset:  Dim LTotBQty  As Double:         Dim LTotBAmt  As Double
'    Dim LTotSQty As Double:      Dim LTotSamt As Double:         Dim LTotDiffAmt As Double:       Dim LTotBrokAmt As Double
'    Dim LTotSTDAmt  As Double:   Dim LTotStampAmt  As Double:    Dim LTotBillamt As Double:       Dim LTotSrvAmt  As Double
'    Dim LTotTranAmt As Double:   Dim LBAlFlag As Boolean:        Dim LAddFlag As Boolean:         Dim LBal As Double:
'    Dim MBal As Double:          Dim RecRpt1 As ADODB.Recordset
'    Dim LNetAmt As Double
'    Dim TRec As ADODB.Recordset
'    SrNo = 0

'    Set RecRpt1 = Nothing
'    Set RecRpt1 = New ADODB.Recordset
'    RecRpt1.Fields.Append "CODE", adVarChar, 6, adFldIsNullable
'    RecRpt1.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
'    RecRpt1.Fields.Append "DIFFER", adDouble, , adFldIsNullable
'    RecRpt1.Fields.Append "BROKAMT", adDouble, , adFldIsNullable
'    RecRpt1.Fields.Append "STDAMT", adDouble, , adFldIsNullable
'    RecRpt1.Fields.Append "TRANAMT", adDouble, , adFldIsNullable
'    RecRpt1.Fields.Append "SRVAMT", adDouble, , adFldIsNullable
'    RecRpt1.Fields.Append "STAMPAMT", adDouble, , adFldIsNullable
'    RecRpt1.Fields.Append "BILLAMT", adDouble, , adFldIsNullable
'    RecRpt1.Open , , adOpenKeyset, adLockBatchOptimistic
'
'    Set GlobalRecRpt = Nothing
'    Set GlobalRecRpt = New ADODB.Recordset
'    GlobalRecRpt.Fields.Append "LCODE", adVarChar, 6, adFldIsNullable
'    GlobalRecRpt.Fields.Append "LNAME", adVarChar, 100, adFldIsNullable
'    GlobalRecRpt.Fields.Append "LDIFFER", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "LBROKAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "LSTDAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "LTRANAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "LBILLAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "RCODE", adVarChar, 6, adFldIsNullable
'    GlobalRecRpt.Fields.Append "RNAME", adVarChar, 100, adFldIsNullable
'    GlobalRecRpt.Fields.Append "RDIFFER", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "RBROKAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "RSTDAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "RTRANAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "RBILLAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
'    GlobalRecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
'    GlobalRecRpt.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
'    GlobalRecRpt.Fields.Append "ITEMNAME", adVarChar, 50, adFldIsNullable
'    GlobalRecRpt.Fields.Append "LSRVAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "RSRVAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "LSTAMPAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "RSTAMPAMT", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "LNetValue", adDouble, , adFldIsNullable
'    GlobalRecRpt.Fields.Append "RNetValue", adDouble, , adFldIsNullable
'
'    GlobalRecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
'    If Check4.Value = 1 Then
'        MYSQL = "SELECT AD.AC_CODE,AD.NAME,SUM(I.IDIFFAMT) AS DIFFAMT ,SUM(I.IBROKAMT) AS BROKAMT ,SUM(I.SRVAMT) AS SRVAMT,"
'        MYSQL = MYSQL & " SUM(I.STAMPAMT) AS STAMPAMT, SUM(I.BILLAMT*I.CURR_RATE)"
'        MYSQL = MYSQL & " AS BILLAMT FROM INV_D AS I, ACCOUNTD AS AD , SAUDAMAST AS S "
'        MYSQL = MYSQL & " WHERE AD.COMPCODE =" & GCompCode & " AND I.ACCID =AD.ACCID "
'        MYSQL = MYSQL & " AND S.SAUDAID = I.SAUDAID"
'        MYSQL = MYSQL & " AND STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' "
'        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
'            MYSQL = MYSQL & " AND AD.ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
'        End If
'        If AllParties = False And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND AD.AC_CODE IN (" & LSParties & ")"
'        If AllSaudas = False Then MYSQL = MYSQL & "  AND S.SAUDAID IN (" & LSSaudas & ")"
'        If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND S.EXID IN (" & LSExCodes & ")"
'        If AllSaudas = True And AllInst = False Then MYSQL = MYSQL & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
'        MYSQL = MYSQL & " GROUP BY AD.AC_CODE,AD.NAME"
'        MYSQL = MYSQL & " ORDER BY AD.NAME"
'    Else
'        If GOnlyBrok = 0 Then
'            MYSQL = "SELECT AD.AC_CODE,AD.NAME,SUM(I.DIFFAMT) AS DIFFAMT ,SUM(I.BROKAMT) AS BROKAMT ,SUM(I.SRVAMT) AS SRVAMT,"
'            MYSQL = MYSQL & " SUM(I.STAMPAMT) AS STAMPAMT, SUM(I.BILLAMT) AS BILLAMT FROM INV_D AS I, ACCOUNTD AS AD, SAUDAMAST AS S   "
'        Else
'            MYSQL = "SELECT AD.AC_CODE,AD.NAME,SUM(I.DIFFAMT) AS DIFFAMT ,SUM(I.BROKAMT) AS BROKAMT,"
'            MYSQL = MYSQL & " SUM(I.BILLAMT) AS BILLAMT FROM INV_D AS I, ACCOUNTD AS AD , SAUDAMAST AS S "
'        End If
'        MYSQL = MYSQL & " WHERE I.COMPCODE =" & GCompCode & " AND  I.ACCID =AD.ACCID "
'        MYSQL = MYSQL & " AND S.SAUDAID = I.SAUDAID"
'        MYSQL = MYSQL & " AND STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' "
'        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
'            MYSQL = MYSQL & " AND AD.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
'        End If
'        If AllParties = False And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND AD.AC_CODE IN (" & LSParties & ")"
'        If AllSaudas = False Then MYSQL = MYSQL & "  AND S.SAUDAID IN (" & LSSaudas & ")"
'        If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND S.EXID IN (" & LSExCodes & ")"
'        If AllSaudas = True And AllInst = False Then MYSQL = MYSQL & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
'        MYSQL = MYSQL & " GROUP BY AD.AC_CODE,AD.NAME"
'        MYSQL = MYSQL & " ORDER BY AD.NAME"
'    End If
'    Set BillRec = Nothing
'    Set BillRec = New ADODB.Recordset
'    BillRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'    LBAlFlag = False
'
'    Do While Not BillRec.EOF
'        RecRpt1.AddNew
'        RecRpt1!Code = BillRec!AC_CODE:         RecRpt1!NAME = BillRec!NAME
'        RecRpt1!DIFFER = BillRec!diffaMt:           RecRpt1!BROKAMT = BillRec!BROKAMT
'        If GOnlyBrok = 0 Then
'            RecRpt1!SRVAMT = BillRec!SRVAMT:   RecRpt1!STampamt = BillRec!STampamt
'        Else
'            RecRpt1!SRVAMT = 0:                     RecRpt1!STampamt = 0
'        End If
'        RecRpt1!STDAMT = 0:                         RecRpt1!TranAmt = 0
'        RecRpt1!BILLAMT = BillRec!BILLAMT:    RecRpt1.Update
'        BillRec.MoveNext
'    Loop
'
'    MYSQL = "SELECT A.NAME,I.PARTY,FMLY.FMLYNAME,FMLY.FMLYHEAD,A2.NAME AS FMLYNM,FMLY.CONTRA_AC,A3.NAME AS CONTRANAME,SUM(AMOUNT) AS BBROKAMT,SUM(SAMOUNT)AS SHAREAMT "
'    MYSQL = MYSQL & " FROM INV_D1 AS I, ACCOUNTM AS A, ACCFMLY AS FMLY, ACCOUNTM AS A2, ACCOUNTM AS A3, SAUDAMAST AS S "
'    MYSQL = MYSQL & " WHERE  A.COMPCODE =" & GCompCode & " And I.ACCID  = A.ACCID AND I.FMLYID = FMLY.FMLYID "
'    MYSQL = MYSQL & " AND A2.ACCID  =FMLY.HEADID AND  A3.ACCID = FMLY.CONTRAID AND S.SAUDAID = I.SAUDAID "
'    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
'        MYSQL = MYSQL & " AND A.ACCID IN (SELECT DISTINCT ACCID FROM ACCFMLYD WHERE FMLYID IN  (" & LSFmlyIDs & "))"
'    End If
'    If AllParties = False And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND A.AC_CODE IN (" & LSParties & ")"
'    If AllSaudas = False Then MYSQL = MYSQL & "  AND S.SAUDAID IN (" & LSSaudas & ")"
'    If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND S.EXID IN (" & LSExCodes & ")"
'    If AllSaudas = True And AllInst = False Then MYSQL = MYSQL & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
'    MYSQL = MYSQL & " AND I.STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND I.STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
'    MYSQL = MYSQL & " GROUP BY A.NAME,I.PARTY, FMLY.FMLYNAME, FMLY.FMLYHEAD,A2.NAME, FMLY.CONTRA_AC,A3.NAME"
'    MYSQL = MYSQL & " ORDER BY A.NAME,I.PARTY, FMLY.FMLYNAME, FMLY.FMLYHEAD,A2.NAME, FMLY.CONTRA_AC,A3.NAME"
'    Set BillRec = Nothing
'    Set BillRec = New ADODB.Recordset
'    BillRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'    LBAlFlag = False
'    Do While Not BillRec.EOF
'        'If BillRec!fmlyhead = "RRLD" Then
'        '    MsgBox ""
'        'End If
'
'        If BillRec!BBROKAMT <> 0 Then
'            RecRpt1.AddNew
'            RecRpt1!Code = BillRec!FMLYHEAD:    RecRpt1!NAME = BillRec!fmlynm
'            RecRpt1!STDAMT = BillRec!BBROKAMT:  RecRpt1!BILLAMT = BillRec!BBROKAMT
'            RecRpt1!DIFFER = 0:                 RecRpt1!BROKAMT = 0
'            RecRpt1!TranAmt = 0:                RecRpt1!SRVAMT = 0
'            RecRpt1!STampamt = 0
'
'            RecRpt1.Update
'        End If
'        If BillRec!SHAREAMT <> 0 Then
'            RecRpt1.AddNew
'            RecRpt1!Code = BillRec!FMLYHEAD:            RecRpt1!NAME = BillRec!fmlynm
'            RecRpt1!TranAmt = BillRec!SHAREAMT * -1:    RecRpt1!BILLAMT = BillRec!SHAREAMT * -1
'            RecRpt1!DIFFER = 0:                         RecRpt1!BROKAMT = 0
'            RecRpt1!STDAMT = 0:                         RecRpt1!SRVAMT = 0
'            RecRpt1!STampamt = 0:                       RecRpt1.Update
'
'            RecRpt1.AddNew
'            RecRpt1!Code = BillRec!Contra_Ac:           RecRpt1!NAME = BillRec!CONTRANAME
'            RecRpt1!TranAmt = BillRec!SHAREAMT:         RecRpt1!BILLAMT = BillRec!SHAREAMT
'            RecRpt1!DIFFER = 0:                         RecRpt1!BROKAMT = 0
'            RecRpt1!STDAMT = 0:                         RecRpt1!SRVAMT = 0
'            RecRpt1!STampamt = 0:                       RecRpt1.Update
'        End If
'        BillRec.MoveNext
'    Loop
'    LTotDiffAmt = 0: LTotBrokAmt = 0: LTotSTDAmt = 0: LTotStampAmt = 0: LTotBillamt = 0: LTotSrvAmt = 0: LTotTranAmt = 0
'    If RecRpt1.RecordCount > 0 Then
'        RecRpt1.MoveFirst
'        RecRpt1.Sort = "NAME"
'        RecRpt1.MoveFirst
'        Do While Not RecRpt1.EOF
'            LTotDiffAmt = 0: LTotBrokAmt = 0: LTotSTDAmt = 0: LTotStampAmt = 0: LTotBillamt = 0: LTotSrvAmt = 0: LTotTranAmt = 0
'            LAddFlag = False
'            LParty = RecRpt1!Code
'            LPartyName = RecRpt1!NAME
'            Do While LParty = RecRpt1!Code
'                LTotDiffAmt = LTotDiffAmt + RecRpt1!DIFFER
'                LTotBrokAmt = LTotBrokAmt + RecRpt1!BROKAMT
'                LTotSTDAmt = LTotSTDAmt + RecRpt1!STDAMT
'                LTotSrvAmt = LTotSrvAmt + RecRpt1!SRVAMT
'                LTotTranAmt = LTotTranAmt + RecRpt1!TranAmt
'                LTotStampAmt = LTotStampAmt + RecRpt1!STampamt
'                LTotBillamt = LTotBillamt + RecRpt1!BILLAMT
'                RecRpt1.MoveNext
'                If RecRpt1.EOF Then Exit Do
'            Loop
'            GlobalRecRpt.Filter = adFilterNone
'            MYSQL = "SELECT SUM (CLQTY*CLRATE) AS NAMT FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LParty & "' "
'            MYSQL = MYSQL & " AND STDATE ='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
'            Set TRec = Nothing
'            Set TRec = New ADODB.Recordset
'            TRec.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
'            LNetAmt = 0
'            If Not TRec.EOF Then LNetAmt = Val(TRec!NAMT & vbNullString)
'            If LNetAmt <> 0 Then LNetAmt = LNetAmt / 10000000
'
'            LTotBillamt = Round(LTotBillamt, 2)
'            If LTotBillamt > 0 Then
'                If GlobalRecRpt.RecordCount > 0 Then
'                    GlobalRecRpt.Filter = "LCODE='ZZZZZZ'"
'                    If GlobalRecRpt.EOF Then
'                        LAddFlag = True
'                        GlobalRecRpt.AddNew
'                    End If
'                Else
'                    LAddFlag = True
'                    GlobalRecRpt.AddNew
'                End If
'                GlobalRecRpt!LCode = LParty:                GlobalRecRpt!LName = LPartyName
'                GlobalRecRpt!LDIFFER = LTotDiffAmt:         GlobalRecRpt!LBrokAmt = LTotBrokAmt
'                GlobalRecRpt!LStdAmt = LTotSTDAmt:          GlobalRecRpt!LTranAmt = LTotTranAmt
'                GlobalRecRpt!LSrvAmt = LTotSrvAmt:          GlobalRecRpt!LStampAmt = LTotStampAmt
'                GlobalRecRpt!LBIllAmt = LTotBillamt
'                GlobalRecRpt!LNetValue = LNetAmt
'                If LAddFlag = True Then
'                    GlobalRecRpt!RCODE = "ZZZZZZ":                    GlobalRecRpt!RNAME = "ZZZZZZ"
'                    GlobalRecRpt!RDIFFER = 0:                         GlobalRecRpt!RBrokAmt = 0
'                    GlobalRecRpt!RStdAmt = 0:                         GlobalRecRpt!RTranAmt = 0
'                    GlobalRecRpt!RSrvAmt = 0:                         GlobalRecRpt!RSTAMPAMT = 0
'                    GlobalRecRpt!RBILLAMT = 0
'                    GlobalRecRpt!RNetValue = 0
'                End If
'                GlobalRecRpt.Update
'            ElseIf LTotBillamt < 0 Then
'                If GlobalRecRpt.RecordCount > 0 Then
'                    GlobalRecRpt.Filter = "RCODE='ZZZZZZ'"
'                    If GlobalRecRpt.EOF Then
'                        LAddFlag = True
'                        GlobalRecRpt.AddNew
'                    End If
'                Else
'                    LAddFlag = True
'                    GlobalRecRpt.AddNew
'                End If
'                GlobalRecRpt!RCODE = LParty:                      GlobalRecRpt!RNAME = LPartyName
'                GlobalRecRpt!RDIFFER = LTotDiffAmt:               GlobalRecRpt!RBrokAmt = LTotBrokAmt
'                GlobalRecRpt!RStdAmt = LTotSTDAmt:                GlobalRecRpt!RTranAmt = LTotTranAmt
'                GlobalRecRpt!RSrvAmt = LTotSrvAmt:                GlobalRecRpt!RSTAMPAMT = LTotStampAmt
'                GlobalRecRpt!RBILLAMT = LTotBillamt
'                GlobalRecRpt!RNetValue = LNetAmt
'                If LAddFlag = True Then
'                    GlobalRecRpt!LCode = "ZZZZZZ":               GlobalRecRpt!LName = "ZZZZZZ"
'                    GlobalRecRpt!LDIFFER = 0:                    GlobalRecRpt!LBrokAmt = 0
'                    GlobalRecRpt!LStdAmt = 0:                    GlobalRecRpt!LTranAmt = 0
'                    GlobalRecRpt!LSrvAmt = 0:                    GlobalRecRpt!LStampAmt = 0
'                    GlobalRecRpt!LBIllAmt = 0
'                    GlobalRecRpt!LNetValue = 0
'                End If
'                GlobalRecRpt.Update
'            End If
'            If RecRpt1.EOF Then Exit Do
'        Loop
'    Else
'        MsgBox "No Records Found"
'        Me.MousePointer = 0
'        OkCmd.Enabled = True
'        Exit Sub
'    End If
        
    If Not FlagBillSummary Then
        MsgBox "No Records Found"
        Me.MousePointer = 0
        OkCmd.Enabled = True
        Exit Sub
    End If
    
    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "BILLPSMRY_SHARE.rpt", 1)
    mysql = "'Bill Summary with Sharing From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
    Set Rec = New ADODB.Recordset
    Set Rec = GlobalRecRpt.Clone
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource Rec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
    OkCmd.Enabled = True
End Sub
Public Sub Fill_Brokers()
Me.MousePointer = 11: BrokerLst.TabStop = False: BrokerChk.TabStop = False

Label5.Caption = "Getting Brokers"
BrokerLst.ListItems.Clear
Dim TRec As ADODB.Recordset
    Set TRec = Nothing:
    Set TRec = New ADODB.Recordset
    mysql = "SELECT DISTINCT AD.AC_CODE,AD.NAME FROM ACCOUNTD AS AD ,CTR_D AS C WHERE AD.COMPCODE=" & GCompCode & " AND AD.COMPCODE =C.COMPCODE AND AD.AC_CODE = C.CONCODE  "
    If vcDTP2.Visible = True Then
        mysql = mysql & " AND C.CONDATE<='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    Else
        mysql = mysql & " AND C.CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    End If
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND C.EXID IN (" & LSExCodes & ") "
    mysql = mysql & " ORDER BY AD.NAME"
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    BrokerLst.Visible = False
    If Not TRec.EOF Then
        BrokerLst.Visible = False
        Do While Not TRec.EOF
            BrokerLst.ListItems.Add , , TRec!NAME
            BrokerLst.ListItems(BrokerLst.ListItems.Count).ListSubItems.Add , , TRec!AC_CODE
            TRec.MoveNext
        Loop
    End If
    BrokerLst.TabStop = True: BrokerLst.TabStop = True:
    BrokerChk.TabStop = True
    Me.MousePointer = 0

    Label5.Caption = ""
End Sub

Public Function Get_Balance(ByVal LFAc_Code As Long)
Dim LFBal As Double
Dim TRec As ADODB.Recordset
LFBal = 0
mysql = "SELECT SUM(CASE DR_CR WHEN 'D'THEN AMOUNT*-1 WHEN 'C' THEN AMOUNT END ) AS AMT  FROM VCHAMT WHERE  ACCID  =" & LFAc_Code & ""
mysql = mysql & " AND VOU_DT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND VOU_TYPE NOT IN ('S','H') AND VOU_DT<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
Set TRec = Nothing: Set TRec = New ADODB.Recordset
TRec.Open mysql, Cnn, adOpenDynamic, adLockReadOnly
If Not TRec.EOF Then LFBal = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
Get_Balance = LFBal
End Function


Sub INVOICE_Summary()
    LSParties = Get_Parties:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    Call AccRecNew
    
    Set PartyRec = Nothing
    Set PartyRec = New ADODB.Recordset
    mysql = "SELECT  A.AC_CODE,A.NAME,I.EXCHANGECODE,I.ITEMCODE,S.SAUDACODE,S.MATURITY,C.INVNO,C.INVDATE,C.DIFFAMT,C.BROKAMT,C.STDAMT,C.TRANAMT,SRVAMT,"
    mysql = mysql & " STAMPAMT,STTTAX,RISKMAMT,SBC_TAX_AMT,SEBITAXAMT,BILLAMT  FROM ACCOUNTM AS A, INV_D AS C, ITEMMAST AS I, SAUDAMAST AS S "
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND  "
    mysql = mysql & " AND S.ITEMID =I.ITEMID  AND A.ACCID =C.ACCID  AND C.SAUDAID=S.SAUDAID "
    mysql = mysql & " AND C.INVNO<>0 AND C.INVDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND C.INVDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID   IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
    End If
    
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  A.AC_CODE IN (" & LSParties & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    mysql = mysql & " ORDER BY C.INVNO,A.NAME,I.EXCHANGECODE,S.ITEMCODE,S.INSTTYPE,S.MATURITY"
    
    PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If PartyRec.EOF Then
        MsgBox "No Records.", vbCritical: PartyCmd.SetFocus: Exit Sub
    Else
        If Combo2.ListIndex = 0 Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "INV_list.RPT", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "INV_LIST_SMRY.RPT", 1)
        End If
        
        mysql = "INVOICE"

        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource PartyRec
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
        CRViewer1.ZOrder
        CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True
        CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
    End If
Me.MousePointer = 0
GETMAIN.ProgressBar1.Visible = False
OkCmd.Enabled = True
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub
Sub BROKERAGE_SUMMARY()
    On Error GoTo err1
    Dim MSauda As String:    Dim mparty As String:    Dim LItemCode As String:    Dim TRec As ADODB.Recordset:    Dim LREC As ADODB.Recordset
    Dim LBrokAmt As Double:  Dim LSrvAmt As Double:   Dim LTranAmt  As Double:    Dim LBrokQty As Double:         Dim LStdAmt As Double:
    Dim LTotTurnover As Double
    Dim lusdinr As Double
    Dim LTOTQTY As Double
    Dim LExCode  As String
    Dim LSaudaID As Long
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    Set RecRpt = Nothing: Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "AcName", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "SaudaName", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "ItemName", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "BrokType", adVarChar, 30, adFldIsNullable
    RecRpt.Fields.Append "BrokAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "TranAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SrvAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "Amount", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BrokQty", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BrokValue", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "TOTQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "USDINR", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    lusdinr = 0
    LSaudaID = Get_SaudaID("USDINR)")
    lusdinr = SDCLRATE(LSaudaID, vcDTP2.Value, "C")
    If Check4 = 1 Then
        If GUniqClientId = "BRO2-CHE" Then
            mysql = "SELECT AC.NAME,SD.EXCODE,IT.ITEMNAME,IT.LOT,SD.SAUDANAME,SUM(I.BROKAMT*i.CURRRATE) AS BROKAMT ,SUM(I.TRANAMT*I.USDINR) AS TRANAMT,SUM(I.SRVAMT*I.USDINR) AS SRVAMT,"
        Else
            mysql = "SELECT AC.NAME,SD.EXCODE,IT.ITEMNAME,IT.LOT,SD.SAUDANAME,SUM(I.BROKAMT*i.usdinr) AS BROKAMT ,SUM(I.TRANAMT*I.USDINR) AS TRANAMT,SUM(I.SRVAMT*I.USDINR) AS SRVAMT,"
        End If
    Else
        mysql = "SELECT AC.NAME,SD.EXCODE,IT.ITEMNAME,IT.LOT,SD.SAUDANAME,SUM(I.BROKAMT) AS BROKAMT ,SUM(I.TRANAMT) AS TRANAMT,SUM(I.SRVAMT) AS SRVAMT,"
    End If
    mysql = mysql & " SUM(I.STDAMT) AS STDAMT ,SUM(I.TOTBAMT+I.TOTSAMT) AS TOTAMT ,SUM(I.TOTBQTY+I.TOTSQTY) AS TOTQTY "
    mysql = mysql & " FROM ACCOUNTD AS AC, ITEMMAST AS IT,SAUDAMAST AS SD ,INV_D AS I "
    mysql = mysql & " WHERE I.COMPCODE = " & GCompCode & " "
    mysql = mysql & " AND I.STDATE >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND I.STDATE <= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' "
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND AC.ACCid  IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID  IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND AC.AC_CODE  IN (" & LSParties & ") "
    If AllSaudas = False Then mysql = mysql & " AND I.SAUDAID IN (" & LSSaudas & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND SD.EXID IN (" & LSExCodes & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SD.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " AND I.ACCID  = AC.ACCID AND I.SAUDAID = SD.SAUDAID And I.ITEMID = IT.ITEMID"
    mysql = mysql & " GROUP BY AC.NAME,SD.EXCODE,IT.ITEMNAME,IT.LOT,SD.SAUDANAME "
    mysql = mysql & " ORDER BY AC.NAME, IT.ITEMNAME ,SD.SAUDANAME "
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Not TRec.EOF Then
            Do While Not TRec.EOF
                LBrokAmt = 0: LSrvAmt = 0: LTranAmt = 0: LBrokQty = 0: LStdAmt = 0: LTotTurnover = 0
                LTOTQTY = 0
                MSauda = TRec!SAUDANAME
                mparty = TRec!NAME
                LItemCode = TRec!ITEMName
                LExCode = TRec!excode
                Do While MSauda = TRec!SAUDANAME And mparty = TRec!NAME
                    LBrokAmt = LBrokAmt + TRec!BROKAMT
                    LSrvAmt = LSrvAmt + TRec!SRVAMT
                    LTranAmt = LTranAmt + TRec!TranAmt
                    LStdAmt = LStdAmt + TRec!STDAMT
                    LTOTQTY = LTOTQTY + TRec!TotQty
                    LTotTurnover = LTotTurnover + TRec!TotAmt
                    
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
                RecRpt.AddNew
                RecRpt!ACNAME = mparty
                RecRpt!SAUDANAME = MSauda
                RecRpt!ITEMName = LItemCode
                RecRpt!excode = LExCode
                RecRpt!BROKAMT = LBrokAmt
                RecRpt!TranAmt = LTranAmt
                RecRpt!SRVAMT = LSrvAmt
                RecRpt!AMOUNT = LStdAmt
                RecRpt!BROKVALUE = LTotTurnover
                RecRpt!USDINR = lusdinr
                RecRpt!TotQty = LTOTQTY
                
                RecRpt.Update
                If TRec.EOF Then Exit Do
            Loop
            If Combo1.ListIndex = 0 Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "BROKSMRY.rpt", 1)
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "BROKSMRYS.rpt", 1)
            End If
            mysql = "'Brokerage Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            RDCREPO.DiscardSavedData: RDCREPO.Database.SetDataSource RecRpt
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            CRViewer1.ZOrder: CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
            CRViewer1.Visible = True: CRViewer1.ReportSource = RDCREPO: CRViewer1.Zoom 1: CRViewer1.ViewReport
        End If
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
    OkCmd.Enabled = True
End Sub

Sub INV_LIST()
    On Error GoTo err1
    Dim SrNo As Long
    LSExCodes = Get_ExCodes
    
    Dim TRec As ADODB.Recordset
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    mysql = "SELECT I.INVNO, I.INVDATE, P.AC_CODE, P.NAME, I.DIFFAMT, I.BROKAMT, I.STDAMT, I.TRANAMT, I.BILLAMT, I.SAUDA,  I.SETNO, "
    mysql = mysql & " I.SRVAMT,I.STTTAX,I.STAMPAMT,I.RISKMAMT,SEBITAXAMT,SBC_TAX_AMT,CGSTAMT,SGSTAMT,IGSTAMT,UTTAMT,I.EXCODE,P.STATE,P.GSTIN"
    mysql = mysql & " FROM INV_D AS I, ACCOUNTD AS P, SAUDAMAST AS S, ITEMMAST AS IT "
    mysql = mysql & " WHERE I.COMPCODE=" & GCompCode & " AND  I.INVNO <> 0 "
    mysql = mysql & " AND I.ACCID =P.ACCID AND I.SAUDAID=S.SAUDAID AND I.ITEMID = IT.ITEMID AND  I.INVDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID IN (" & LSExCodes & ")"
    mysql = mysql & " AND I.INVDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' ORDER BY I.INVNO"
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If MFormat = "Invoice GST Report" Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "INV_GSTLIST.RPT", 1)
    Else
        If Combo2.ListIndex = 0 Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "INV_LIST.RPT", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "INV_LIST_SUMM.RPT", 1)
        End If
    End If
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    mysql = "'Invoice List From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
    RDCREPO.FormulaFields.GetItemByName("mTITLE1").text = mysql
   ' RDCREPO.FormulaFields.GetItemByName("EXCODE").Text = "'" & LMEXCODE & "'"
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport

    Me.MousePointer = 0: OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
End Sub
Sub SWMRates()
    Dim TRec As ADODB.Recordset
    Dim LCloseRate As Double
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    
        mysql = "SELECT DISTINCT CD.CONDATE,CD.SAUDAID ,CD.SAUDA, SU.SAUDANAME FROM CTR_D AS CD, SAUDAMAST AS SU WHERE CD.COMPCODE=" & GCompCode & " AND CD.COMPCODE=SU.COMPCODE "
        mysql = mysql & " AND CD.SAUDAID =SU.SAUDAID "
        If AllSaudas = False Then mysql = mysql & " AND CD.SAUDAID IN (" & LSSaudas & ") "
        mysql = mysql & " AND CD.CONDATE >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' ORDER BY CD.CONDATE"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        If Not TRec.EOF Then
            Set RecRpt = Nothing: Set RecRpt = New ADODB.Recordset
            RecRpt.Fields.Append "CONTDATE", adDate, , adFldIsNullable
            RecRpt.Fields.Append "SAUDANAME", adVarChar, 50, adFldIsNullable
            RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
            While Not TRec.EOF
                LCloseRate = SDCLRATE(TRec!SAUDAID, TRec!Condate, "C")
                If LCloseRate = 0 Then RecRpt.AddNew: RecRpt!CONTDATE = TRec!Condate: RecRpt!SAUDANAME = TRec!SAUDANAME: RecRpt.Update
                TRec.MoveNext
            Wend
            mysql = "Sauda wise missing rates"
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "SWMRts.rpt", 1)
            RDCREPO.DiscardSavedData: RDCREPO.Database.SetDataSource RecRpt
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
            CRViewer1.ZOrder
            CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
            CRViewer1.Visible = True: CRViewer1.ReportSource = RDCREPO: CRViewer1.Zoom 1: CRViewer1.ViewReport
            OkCmd.Enabled = True: Me.MousePointer = 0
        End If
End Sub
Sub BRANCH_BROK()
    On Error GoTo err1
    Dim MSauda As String:           Dim mparty As String:    Dim LItemCode As String:        Dim LFmlyName As String
    Dim TRec As ADODB.Recordset:    Dim LBrokAmt  As Double: Dim LSrvAmt As Double:          Dim LTranAmt As Double:
    Dim LBrokQty As Double:         Dim LStdAmt As Double:   Dim LBBrokAmt  As Double
    Dim LTOTQTY As Double:          Dim LExCode As String:   Dim lusdinr  As Double
    Dim LSaudaID As Long:           Dim LTURNOVER As Double:
    Dim MBROKTYPE As String:        Dim MBROKRATE As Double
    Dim MPartyCode As String
    Dim PTRec As ADODB.Recordset:
    
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    LSFmlyIDs = Get_FmlyCodes
    
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    Set RecRpt = Nothing: Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "AcName", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "SaudaName", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "ItemName", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "Lot", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BrokAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "TranAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SrvAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "StdAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BBrokAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "FmlyName", adVarChar, 200, adFldIsNullable
    RecRpt.Fields.Append "TotQty", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    RecRpt.Fields.Append "USDINR", adDouble, , adFldIsNullable

    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    mysql = "SELECT AC.AC_CODE,AC.NAME,SD.SAUDAID ,SD.SAUDANAME ,SD.EXCODE,IT.ITEMCODE,IT.LOT,FMLY.FMLYID,FMLY.FMLYNAME,SUM(I.TOTBAMT+I.TOTSAMT) AS TURNOVER,SUM(I.TOTBQTY+I.TOTSQTY) AS TOTQTY ,SUM(I.BROKAMT) AS BROKAMT ,SUM(ID.AMOUNT )AS BBROKAMT  "
    mysql = mysql & " FROM ACCOUNTD AS AC, ITEMMAST AS IT,SAUDAMAST AS SD, INV_D AS I,ACCFMLY AS FMLY,INV_D1 AS ID "
    mysql = mysql & " WHERE ID.COMPCODE  = " & GCompCode & " "
    mysql = mysql & " AND ID.STDATE >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND ID.STDATE <= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    If LenB(LSFmlyIDs) > 1 Then mysql = mysql & " AND FMLY.FMLYID IN (" & LSFmlyIDs & ") "
    If LenB(LSParties) > 1 Then mysql = mysql & " AND AC.AC_CODE IN (" & LSParties & ") "
    If AllSaudas = False Then mysql = mysql & " AND ID.SAUDAID IN (" & LSSaudas & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID IN (" & LSExCodes & ")"
    mysql = mysql & " AND ID.ACCID  = AC.ACCID AND ID.FMLYID = FMLY.FMLYID AND ID.SAUDAID  = SD.SAUDAID AND ID.ITEMID  = IT.ITEMID "
    mysql = mysql & " AND ID.COMPCODE =I.COMPCODE AND ID.BILLNO =I.BILLNO "
    mysql = mysql & " GROUP BY AC.AC_CODE,AC.NAME ,SD.SAUDAID, SD.SAUDANAME, SD.EXCODE, IT.ITEMCODE, IT.LOT, FMLY.FMLYID,FMLY.FMLYNAME"
    mysql = mysql & " ORDER BY FMLY.FMLYNAME,AC.NAME,SD.EXCODE,IT.ITEMCODE,SD.SAUDANAME "
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Not TRec.EOF Then
        Do While Not TRec.EOF
            LBrokAmt = 0:       LSrvAmt = 0:   LTranAmt = 0:
            LBrokQty = 0:       LStdAmt = 0:   LBBrokAmt = 0
            LTOTQTY = 0:        lusdinr = 0
            
            LExCode = TRec!excode:            MSauda = TRec!SAUDANAME
            mparty = TRec!NAME:               LFmlyName = TRec!FmlyNAME & vbNullString
            LItemCode = TRec!ITEMCODE:        LBrokAmt = TRec!BROKAMT
            LBBrokAmt = TRec!BBROKAMT:        LTOTQTY = TRec!TotQty
            LSaudaID = TRec!SAUDAID
            LTURNOVER = TRec!turnover
            lusdinr = SDCLRATE(LSaudaID, vcDTP2.Value, "C")
            
            MPartyCode = TRec!AC_CODE
            MBROKRATE = 0
            
            mysql = "SELECT BROKTYPE,BROKRATE FROM PEXBROK WHERE COMPCODE  = " & GCompCode & " AND EXCODE = '" & LExCode & "' AND UPTOSTDT >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND AC_CODE = '" & MPartyCode & "' ORDER BY UPTOSTDT DESC "
            Set PTRec = Nothing: Set PTRec = New ADODB.Recordset
            PTRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
            If Not PTRec.EOF Then
                MBROKTYPE = PTRec!broktype
                MBROKRATE = PTRec!brokrate
            End If
            If MBROKRATE = 0 Then
                mysql = "SELECT BROKTYPE,BROKRATE FROM PITBROK WHERE COMPCODE  = " & GCompCode & " AND EXCODE = '" & LExCode & "' AND UPTOSTDT >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND AC_CODE = '" & MPartyCode & "' ORDER BY UPTOSTDT,BROKRATE DESC "
                Set PTRec = Nothing: Set PTRec = New ADODB.Recordset
                PTRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
                If Not PTRec.EOF Then
                    MBROKTYPE = PTRec!broktype
                    MBROKRATE = PTRec!brokrate
                End If
            End If
            RecRpt.AddNew:                  RecRpt!ACNAME = mparty + " " + MBROKTYPE
            RecRpt!SAUDANAME = MSauda:      RecRpt!ITEMName = LItemCode
            RecRpt!excode = LExCode:        RecRpt!BROKAMT = LBrokAmt
            RecRpt!BBROKAMT = LBBrokAmt:    RecRpt!TotQty = LTOTQTY
            RecRpt!TranAmt = LTURNOVER:     RecRpt!SRVAMT = MBROKRATE
            RecRpt!USDINR = lusdinr:        RecRpt!FmlyNAME = LFmlyName
            RecRpt.Update
            TRec.MoveNext
            
        Loop
        If Combo1.ListIndex = 0 Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_BrokDetail.rpt", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_BrokSumm.rpt", 1)
        End If
        
        mysql = "'Branch Wise Brokerage Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
        RDCREPO.DiscardSavedData: RDCREPO.Database.SetDataSource RecRpt
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
        CRViewer1.ZOrder: CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True: CRViewer1.ReportSource = RDCREPO: CRViewer1.Zoom 1: CRViewer1.ViewReport
    Else
        MsgBox "No Records Found"
    End If
    Me.MousePointer = 0
    GETMAIN.ProgressBar1.Visible = False
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub

Sub ContList()
    Dim LTrfto As String:    Dim LSauda As String:    Dim TRec As ADODB.Recordset
    Me.MousePointer = 11: OkCmd.Enabled = False
    ContBFram.ListItems.Clear
    ContSFram.ListItems.Clear
    
    If MFormat = "Sauda Transfer DD" Then 'date to date
    Else
        LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    End If
    
    
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    If MFormat = "Sauda Transfer DD" Then 'date to date
        mysql = "SELECT CD.CONDATE, CD.CONNO, CD.SAUDA, CD.ITEMCODE, CD.QTY, CD.RATE, CD.CONTYPE,IM.LOT, CD.ROWNO1 AS 'CONCODE'  " '>>> CD.CONCODE,
        mysql = mysql & "FROM CTR_D AS CD,ITEMMAST AS IM "
        mysql = mysql & "WHERE CD.COMPCODE = " & GCompCode & " AND CD.COMPCODE=IM.COMPCODE AND CD.CONDATE = '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' and CD.PERCONT = 'P' "
        If DataCombo2.BoundText <> "" Then mysql = mysql & " AND CD.SAUDAID  = '" & LToParty & "' "
        If DataCombo1.BoundText <> "" Then mysql = mysql & " AND CD.clcode  = '" & LFromParty & "' "
        mysql = mysql & "AND CD.ITEMID = IM.ITEMID AND CD.INVNO = 0 ORDER BY CD.CONDATE,CD.SAUDA,CD.CONNO"
    Else
        mysql = "SELECT CD.CONDATE, CD.CONNO, CD.SAUDA, CD.ITEMCODE, CD.QTY, CD.RATE, CD.CONTYPE,IM.LOT, CD.CONCODE "
        mysql = mysql & "FROM CTR_D AS CD,ITEMMAST AS IM "
        mysql = mysql & "WHERE CD.COMPCODE = " & GCompCode & " AND CD.COMPCODE=IM.COMPCODE AND CD.CONDATE >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' "
        If AllSaudas = False Then mysql = mysql & " AND CD.SAUDAID IN  (" & LSSaudas & ")"
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND IM.EXID IN ( " & LSExCodes & ")"
        mysql = mysql & "AND CD.PARTY = '" & LFromParty & "' "
        mysql = mysql & "AND CD.ITEMID = IM.ITEMID AND CD.INVNO = 0 ORDER BY CD.CONDATE,CD.SAUDA,CD.CONNO"
    End If
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then
        ContBFram.Visible = False
        ContSFram.Visible = False
        DoEvents
        GETMAIN.Label1.Caption = "Filling List View "
        Do While Not TRec.EOF
            If TRec!CONTYPE = "B" Then
                ContBFram.ListItems.Add , , TRec!CONNO
                ContBFram.ListItems(ContBFram.ListItems.Count).ListSubItems.Add , , TRec!Condate
                ContBFram.ListItems(ContBFram.ListItems.Count).ListSubItems.Add , , TRec!QTY
                ContBFram.ListItems(ContBFram.ListItems.Count).ListSubItems.Add , , Format(TRec!Rate, "0.0000")
                ContBFram.ListItems(ContBFram.ListItems.Count).ListSubItems.Add , , TRec!Sauda
                ContBFram.ListItems(ContBFram.ListItems.Count).ListSubItems.Add , , TRec!lot
                ContBFram.ListItems(ContBFram.ListItems.Count).ListSubItems.Add , , TRec!CONCODE
            ElseIf TRec!CONTYPE = "S" Then
                ContSFram.ListItems.Add , , TRec!CONNO
                ContSFram.ListItems(ContSFram.ListItems.Count).ListSubItems.Add , , TRec!Condate
                ContSFram.ListItems(ContSFram.ListItems.Count).ListSubItems.Add , , TRec!QTY
                ContSFram.ListItems(ContSFram.ListItems.Count).ListSubItems.Add , , Format(TRec!Rate, "0.0000")
                ContSFram.ListItems(ContSFram.ListItems.Count).ListSubItems.Add , , TRec!Sauda
                ContSFram.ListItems(ContSFram.ListItems.Count).ListSubItems.Add , , TRec!lot
                ContSFram.ListItems(ContSFram.ListItems.Count).ListSubItems.Add , , TRec!CONCODE
            End If
            TRec.MoveNext
        Loop
        ContBFram.Visible = True
        ContSFram.Visible = True
        GETMAIN.Label1.Caption = vbNullString
    End If
    Set TRec = Nothing
    Me.MousePointer = 0:
End Sub
Sub Voucher_Transfer(FromParty As String, ToParty As String)
    mysql = "UPDATE VCHAMT SET AC_CODE ='" & ToParty & "' WHERE COMPCODE =" & GCompCode & " AND  AC_CODE ='" & FromParty & "' AND VOU_TYPE NOT IN ('S','C') "
    mysql = mysql & " AND VOU_DT >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND VOU_DT <= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    Cnn.Execute mysql
    MsgBox "Vouchers Transfered Succesfully"
End Sub
Sub GetTotQty(Ltype As String)
    Dim I As Integer
    Dim LBQty As Double:    Dim LSQty As Double:    Dim LBAmt As Double:    Dim LSAmt As Double
    LBQty = 0: LSQty = 0: LBAmt = 0: LSAmt = 0
    If Ltype = "B" Then
        Text12.text = vbNullString: Text11.text = vbNullString: Text10.text = vbNullString
        For I = 1 To ContBFram.ListItems.Count
            If ContBFram.ListItems(I).Checked Then
               Text12.text = Val(Text12.text) + Val(ContBFram.ListItems.Item(I).SubItems(2))
               Text10.text = Format((Val(Text10.text) + (Val(ContBFram.ListItems.Item(I).SubItems(2)) * Val(ContBFram.ListItems.Item(I).SubItems(3)) * Val(ContBFram.ListItems.Item(I).SubItems(5)))), "0.00")
               Text11.text = Format((Val(Text10.text)) / Val(Text12.text) / Val(ContBFram.ListItems.Item(I).SubItems(5)), "0.00")
            End If
        Next
    Else
        Text9.text = vbNullString: Text8.text = vbNullString: Text7.text = vbNullString
        For I = 1 To ContSFram.ListItems.Count
            If ContSFram.ListItems(I).Checked Then
               Text9.text = Val(Text9.text) + Val(ContSFram.ListItems.Item(I).SubItems(2))
               Text7.text = Format((Val(Text7.text) + (Val(ContSFram.ListItems.Item(I).SubItems(2)) * Val(ContSFram.ListItems.Item(I).SubItems(3)) * Val(ContSFram.ListItems.Item(I).SubItems(5)))), "0.00")
               Text8.text = Format((Val(Text7.text) / Val(Text9.text)) / Val(ContSFram.ListItems.Item(I).SubItems(5)), "0.00")
            End If
        Next
    End If
    LBQty = Val(Text12.text & vbNullString)
    LBAmt = Val(Text10.text & vbNullString)
    LSQty = Val(Text9.text & vbNullString)
    LSAmt = Val(Text7.text & vbNullString)
    Text6.text = str(LBQty - LSQty)
    Text4.text = Format(LBAmt - LSAmt, "0.00")
End Sub
Sub SaudaTrf()
    'Dim LToParty As String:    Dim LFromParty As String:
    Dim LSauda As String:      Dim LConCode As String:
    Dim I As Integer:          Dim LMParties As String
    Dim LExIDS As String
    Me.MousePointer = 11:
    LExIDS = Get_ExCodes
    Dim LToAccID As Long
    Cnn.BeginTrans
    'LFromParty = DataCombo1.BoundText
    'LToParty = DataCombo2.BoundText
    LExIDS = vbNullString
    LFromParty = Get_AccountDCode(LFromParty)
    
    If LenB(LFromParty) < 1 And MFormat <> "Sauda Transfer DD" Then
        MsgBox "Please Select From Party "
        DataCombo1.BoundText = vbNullString
        DataCombo1.SetFocus
        Cnn.RollbackTrans
        Exit Sub
    End If
    
    
    If MFormat = "Sauda Transfer DD" Then
    Else
        LToParty = Get_AccountDCode(LToParty)
        If LenB(LToParty) < 1 Then
            MsgBox "Please Select To Party "
            DataCombo2.BoundText = vbNullString
            DataCombo2.SetFocus
            Cnn.RollbackTrans
            Exit Sub
        End If
        LToAccID = Get_AccID(LToParty)
    End If

    
    If MFormat = "Sauda Transfer DD" Then
        Dim VConNo As Integer
        VConNo = Get_Max_ConNo(vcDTP2.Value, 0)
        Dim VConNo_temp As Integer
        VConNo_temp = VConNo
        'LSConSno = Get_ConSNo(LvcDTP1, TRec!saudacode, TRec!ITEMCODE, TRec!excode, TRec!SAUDAID, TRec!itemid, TRec!EXID)
        For I = 1 To ContBFram.ListItems.Count
            If ContBFram.ListItems(I).Checked Then
                LConCode = ContBFram.ListItems.Item(I).SubItems(6)
                VConNo_temp = VConNo_temp + 1
                mysql = "UPDATE CTR_D SET  CONDATE='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "', conno='" & VConNo_temp & "'  "
                mysql = mysql & " WHERE ROWNO1 = " & LConCode & " "
                Cnn.Execute mysql
            End If
        Next
        VConNo_temp = VConNo
        For I = 1 To ContSFram.ListItems.Count      ''SAUDA LOOP
            If ContSFram.ListItems(I).Checked Then
                LConCode = ContSFram.ListItems.Item(I).SubItems(6)
                VConNo_temp = VConNo_temp + 1
                mysql = "UPDATE CTR_D SET CONDATE='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "', conno='" & VConNo_temp & "' "
                mysql = mysql & " WHERE ROWNO1 = " & LConCode & " "
                Cnn.Execute mysql
            End If
        Next
        Call Set_Consno
    Else
        For I = 1 To ContBFram.ListItems.Count
            If ContBFram.ListItems(I).Checked Then
                LSauda = ContBFram.ListItems.Item(I).SubItems(4)
                LConCode = ContBFram.ListItems.Item(I).SubItems(6)
                mysql = "UPDATE CTR_D SET  PARTY='" & LToParty & "',ACCID =" & LToAccID & ""
                mysql = mysql & " WHERE COMPCODE = " & GCompCode & " "
                mysql = mysql & " AND PARTY ='" & LFromParty & "' "
                mysql = mysql & " AND CONDATE ='" & Format(ContBFram.ListItems.Item(I).SubItems(1), "yyyy/MM/dd") & "' "
                mysql = mysql & " AND SAUDA ='" & ContBFram.ListItems.Item(I).SubItems(4) & "' "
                mysql = mysql & " AND CONTYPE = 'B' "
                mysql = mysql & " AND CONNO =" & ContBFram.ListItems.Item(I).text & ""
                Cnn.Execute mysql
                If LFromParty = LConCode Then
                    mysql = "UPDATE CTR_D SET CONCODE ='" & LToParty & "' WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(ContBFram.ListItems.Item(I).SubItems(1), "yyyy/MM/dd") & "'"
                    mysql = mysql & " AND SAUDA='" & LSauda & "' AND CONNO=" & ContBFram.ListItems.Item(I).text & ""
                    Cnn.Execute mysql
                End If
            End If
        Next
        For I = 1 To ContSFram.ListItems.Count      ''SAUDA LOOP
            If ContSFram.ListItems(I).Checked Then
                LSauda = ContSFram.ListItems.Item(I).SubItems(4)
                LConCode = ContSFram.ListItems.Item(I).SubItems(6)
                mysql = "UPDATE CTR_D SET PARTY='" & LToParty & "',ACCID =" & LToAccID & ""
                mysql = mysql & " WHERE COMPCODE = " & GCompCode & " "
                mysql = mysql & " AND PARTY ='" & LFromParty & "'"
                mysql = mysql & " AND CONDATE ='" & Format(ContSFram.ListItems.Item(I).SubItems(1), "yyyy/MM/dd") & "'"
                mysql = mysql & " AND SAUDA ='" & ContSFram.ListItems.Item(I).SubItems(4) & "'"
                mysql = mysql & " AND CONTYPE = 'S' "
                mysql = mysql & " AND CONNO =" & ContSFram.ListItems.Item(I).text & ""
                Cnn.Execute mysql
                If LFromParty = LConCode Then
                    mysql = "UPDATE CTR_D SET CONCODE ='" & LToParty & "' WHERE COMPCODE =" & GCompCode & ""
                    mysql = mysql & " AND CONDATE ='" & Format(ContSFram.ListItems.Item(I).SubItems(1), "yyyy/MM/dd") & "' AND SAUDA='" & LSauda & "' AND CONNO=" & ContSFram.ListItems.Item(I).text & ""
                    Cnn.Execute mysql
                End If
            End If
        Next
    End If
    
    If MFormat = "Sauda Transfer DD" Then
        LMParties = LFromParty
        LExIDS = ""
    Else
        LMParties = "'" & LFromParty & "','" & LToParty & "'"
    End If
    'UPDATE Brokerage
    Cnn.CommitTrans: CNNERR = False
    'Call Update_BrokTran(LMParties, LExIDS, vbNullString, vbNullString, vcDTP1.Value, vcDTP2.Value)
    Call Update_Charges(LMParties, LExIDS, vbNullString, vbNullString, vcDTP1.Value, vcDTP2.Value, True)
    CNNERR = True:
    Cnn.BeginTrans
    If BILL_GENERATION(CDate(vcDTP1.Value), CDate(GFinEnd), vbNullString, LMParties, LExIDS) Then
        Cnn.CommitTrans: CNNERR = False
    Else
        Cnn.RollbackTrans: CNNERR = False
    End If
    'Call Chk_Billing
    Me.MousePointer = 0:      vcDTP1.Enabled = True
    vcDTP2.Enabled = True:    SaudaCmd.Enabled = True
    FmlyCmd.Enabled = True:   ExCmd.Enabled = True
    Frame6.Enabled = True
    Text4.text = "0.00":    Text6.text = "0"
    Text7.text = "0.00":    Text8.text = "0.00"
    Text9.text = "0":       Text10.text = "0.00"
    Text11.text = "0.00":   Text12.text = "0"
err1:
    If err.Number <> 0 Then MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then Cnn.RollbackTrans: CNNERR = False
    GETMAIN.ProgressBar1.Visible = False
End Sub
Private Sub Set_Consno()
        Dim LConSno As Integer
        Dim NewRec As ADODB.Recordset
        Dim LLOT As String
        Dim mlowdt As Date
        
        LConSno = 0
        mysql = "SELECT max(consno) as maxsno FROM CTR_D "
        mysql = mysql & " WHERE COMPCODE =" & GCompCode & " AND "
        
        If vcDTP1.Value < vcDTP2.Value Then
            mlowdt = vcDTP1.Value
            mysql = mysql & " condate < '" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' "
        Else
            mlowdt = vcDTP2.Value
            mysql = mysql & " condate < '" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' "
        End If
        
        Set NewRec = Nothing: Set NewRec = New ADODB.Recordset
        NewRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not NewRec.EOF Then
            LConSno = NewRec!maxsno
        End If

            
        DoEvents
        'GETMAIN.Label1.Caption = "Updating ConSno "
        'mysql = "EXEC UPDATE_CTR_DR_CONSNO " & GCompCode & ""
        'Cnn.Execute mysql
        
        mysql = "SELECT DISTINCT C.COMPCODE,C.CONSNO,C.SAUDA,S.SAUDAID,C.CONDATE,C.PATTAN,I.LOT,S.TRADEABLELOT,EX.LOTWISE,EX.EXCODE,EX.EXID ,I.ITEMID ,I.ITEMCODE "
        mysql = mysql & " FROM CTR_D AS C,ITEMMAST AS I,SAUDAMAST AS S,EXMAST AS EX "
        mysql = mysql & " WHERE C.COMPCODE =" & GCompCode & " AND C.COMPCODE =I.COMPCODE AND C.COMPCODE =S.COMPCODE AND S.SAUDAID=C.SAUDAID "
        mysql = mysql & " AND C.COMPCODE =EX.COMPCODE AND I.EXCHANGECODE = EX.EXCODE AND I.ITEMCODE =S.ITEMCODE   "
        mysql = mysql & " AND c.Condate>= '" & Format(mlowdt, "YYYY/MM/DD") & "' ORDER BY CONDATE,EX.EXID,I.ITEMID,S.SAUDAID"
        Set NewRec = Nothing: Set NewRec = New ADODB.Recordset
        NewRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not NewRec.EOF Then
            Do While Not NewRec.EOF
                LConSno = LConSno + 1
                DoEvents
                'GETMAIN.Label1.Caption = "Generating ConSNo " & LConSno & " of Date " & NewRec!Condate & ""
                If NewRec!excode = "NSE" And NewRec!LOTWISE = "Y" Then
                    LLOT = NewRec!TRADEABLELOT
                ElseIf NewRec!excode = "MCX" And NewRec!LOTWISE = "Y" Then
                    LLOT = NewRec!TRADEABLELOT
                Else
                    LLOT = NewRec!lot
                End If
                mysql = "EXEC UPDATE_CTR_DR_ALL " & GCompCode & "," & LConSno & ",'" & NewRec!excode & "'," & LLOT & ",'" & NewRec!ITEMCODE & "'," & NewRec!SAUDAID & ",'" & Format(NewRec!Condate, "YYYY/MM/DD") & "'"
                Cnn.Execute mysql
                                
                mysql = "update ctr_m set consno=" & LConSno & " where COMPCODE =" & GCompCode & " and saudaid=" & NewRec!SAUDAID & " and condate ='" & Format(NewRec!Condate, "YYYY/MM/DD") & "' "
                Cnn.Execute mysql
                NewRec.MoveNext
            Loop
        End If
End Sub
Private Sub Check7_Click()
Dim I As Integer
    If Check7.Value = 1 Then
        For I = 1 To ContBFram.ListItems.Count
            ContBFram.ListItems(I).Checked = True
        Next
        Call GetTotQty("B")
    Else
        Text10.text = vbNullString: Text11.text = vbNullString: Text12.text = vbNullString
        For I = 1 To ContBFram.ListItems.Count
            ContBFram.ListItems(I).Checked = False
        Next
    End If
End Sub
Private Sub Check8_Click()
Dim I As Integer
    If Check8.Value = 1 Then
        For I = 1 To ContSFram.ListItems.Count
            ContSFram.ListItems(I).Checked = True
        Next
        Call GetTotQty("S")
    Else
        Text7.text = vbNullString: Text8.text = vbNullString: Text9.text = vbNullString
        For I = 1 To ContSFram.ListItems.Count
            ContSFram.ListItems(I).Checked = False
        Next
    End If
End Sub

Sub INV_SET_GENERATION()
    Dim IFlag As Boolean:      Dim InvRec As ADODB.Recordset:    Dim LInvDate  As Date
    Dim LSExCode As String:    Dim LMParty  As String:           Dim MSetDate As Date
    Dim LInvNo As Long:        Dim TRec As ADODB.Recordset
    
    On Error GoTo err1
    LSExCodes = Get_ExCodes
    Me.MousePointer = Val(11)
    If Fb_Press = 1 Then ' Create Invoice
        Cnn.BeginTrans
        CNNERR = True
        IFlag = False
        OkCmd.Enabled = False
        mysql = "SELECT DISTINCT STDATE,PARTY,EXCODE FROM INV_D AS I WHERE I.COMPCODE =" & GCompCode & " "
        mysql = mysql & " AND I.PARTY IN (SELECT AC_CODE FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " AND PARTYTYPE = '1')"
        mysql = mysql & " AND  I.STDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND INVNO =0 ORDER BY I.STDATE,PARTY"
        Set InvRec = Nothing:        Set InvRec = New ADODB.Recordset
        InvRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If InvRec.EOF Then
            Me.MousePointer = 0: OkCmd.Enabled = True
            MsgBox "No Settlement in the Date Range ", vbCritical: Exit Sub
        End If
        CNNERR = True
        IFlag = False
        OkCmd.Enabled = False
        
        'If InvRec.RecordCount > 0 Then InvRec.MoveNext
        'MYSQL = "SELECT MAX(INVNO) AS INVNO FROM INV_D AS I WHERE I.COMPCODE=" & GCompCode & " "
        'MYSQL = MYSQL & " AND I.EXCODE ='" & InvRec!EXCODE & "'"
        'Set TRec = Nothing:                Set TRec = New ADODB.Recordset
        'TRec.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
        'LInvNo = Val(TRec!INVNO & vbNullString)
        
        Do While Not InvRec.EOF
            If LSExCode <> InvRec!excode Then
                mysql = "SELECT MAX(INVNO) AS INVNO FROM INV_D AS I WHERE I.COMPCODE=" & GCompCode & " "
               ' MYSQL = MYSQL & " AND I.EXCODE ='" & LSExCode & "'"
                Set TRec = Nothing:                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                LInvNo = Val(TRec!invno & vbNullString)
            End If
            
            LInvNo = LInvNo + 1
            MSetDate = InvRec!STDATE
            
            LMParty = InvRec!PARTY
            LSExCode = InvRec!excode
            DoEvents
            GETMAIN.Label1.Caption = "Generating Settlement Invoice for " & MSetDate & " of " & InvRec!PARTY
            IFlag = True
            mysql = "UPDATE INV_D SET INVNO=" & LInvNo & ", INVDATE='" & Format(MSetDate, "yyyy/MM/dd") & "' WHERE COMPCODE  = " & GCompCode & " AND PARTY='" & LMParty & "'"
            mysql = mysql & " AND STDATE <= '" & Format(MSetDate, "yyyy/MM/dd") & "'AND INVNO = 0 AND EXCODE='" & LSExCode & "'"
            Cnn.Execute mysql '
            mysql = "UPDATE CTR_D SET INVNO=" & LInvNo & " WHERE COMPCODE  = " & GCompCode & " "
            mysql = mysql & " AND PARTY='" & LMParty & "'AND CONDATE <= '" & Format(MSetDate, "yyyy/MM/dd") & "'AND INVNO = 0 AND EXCODE = '" & LSExCode & "'"
            Cnn.Execute mysql '
            mysql = "SELECT DISTINCT VOUCHER.VOU_NO FROM VOUCHER, VCHAMT WHERE VOUCHER.COMPCODE=" & GCompCode & " AND "
            mysql = mysql & " AND VOUCHER.VOU_ID = VCHAMT.VOU_ID AND VCHAMT.AC_CODE='" & LMParty & "' AND VOUCHER.VOU_DT <= '" & Format(MSetDate, "yyyy/MM/dd") & "'"
            mysql = mysql & " AND VOUCHER.INVNO = 0 AND VOUCHER.VOU_TYPE='S' AND VCHAMT.EXCODE ='" & LSExCode & "'"
            Set TRec = Nothing:                Set TRec = New ADODB.Recordset
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            Do While Not TRec.EOF
                mysql = "UPDATE VOUCHER SET INVNO=" & LInvNo & " WHERE COMPCODE = " & GCompCode & " AND VOU_NO='" & TRec!VOU_NO & "'"
                Cnn.Execute mysql
                mysql = "UPDATE VCHAMT SET INVNO=" & LInvNo & " WHERE COMPCODE = " & GCompCode & " AND VOU_NO='" & TRec!VOU_NO & "'"
                Cnn.Execute mysql
                TRec.MoveNext
            Loop
            InvRec.MoveNext
        Loop
    Else ' Delete Invoice
        Cnn.BeginTrans
        ''DELETING INVOICES
        mysql = "SELECT DISTINCT PARTY,EXCODE FROM INV_D WHERE COMPCODE =" & GCompCode & " AND INVDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' "
        mysql = mysql & " AND INVNO <>0  ORDER BY PARTY "
        DoEvents
        Set PartyRec = Nothing
        Set PartyRec = New ADODB.Recordset
        PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        Do While Not PartyRec.EOF
            GETMAIN.Label1.Caption = "Deleting Invoice " & PartyRec!PARTY
            LMParty = PartyRec!PARTY
            LSExCode = PartyRec!excode
            mysql = "UPDATE INV_D SET INVNO=0  WHERE COMPCODE = " & GCompCode & " AND PARTY='" & LMParty & "' AND INVDATE >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
            mysql = mysql & " AND INVNO<>0 AND EXCODE = '" & LSExCode & "'"
            Cnn.Execute mysql
            mysql = "UPDATE CTR_D SET INVNO=0 WHERE COMPCODE = " & GCompCode & " AND PARTY='" & LMParty & "' AND CONDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
            mysql = mysql & " AND INVNO<>0 AND EXCODE  = '" & LSExCode & "'"
            Cnn.Execute mysql

            mysql = "SELECT DISTINCT V.VOU_NO FROM VOUCHER V,VCHAMT VT WHERE V.COMPCODE=" & GCompCode & " AND  V.VOU_ID = VT.VOU_ID "
            mysql = mysql & " AND VT.AC_CODE='" & LMParty & "' AND  V.INVNO<>0 AND V.VOU_DT >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND VT.EXCODE ='" & LSExCode & "'"
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            Do While Not TRec.EOF
                mysql = "UPDATE VOUCHER SET INVNO=0 WHERE COMPCODE = " & GCompCode & " AND VOU_NO='" & TRec!VOU_NO & "'"
                Cnn.Execute mysql
                mysql = "UPDATE VCHAMT SET INVNO=0  WHERE COMPCODE = " & GCompCode & " AND VOU_NO='" & TRec!VOU_NO & "'"
                Cnn.Execute mysql
                TRec.MoveNext
            Loop
            PartyRec.MoveNext
        Loop
        
    End If
    CNNERR = False
    If Fb_Press = 1 Then
        If IFlag = True Then
            MsgBox "Invoice(s) generated successfully.", vbInformation
        Else
            MsgBox "No Records found to Generate Invoice(s) ", vbInformation
        End If
    Else
        MsgBox "Invoice(s) Deleted ", vbInformation
    End If
    Cnn.CommitTrans
    CNNERR = False

    GETMAIN.ProgressBar1.Visible = False
    Call CANCEL_REC
    Me.MousePointer = 0: OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Cnn.RollbackTrans
    CNNERR = False
    GETMAIN.ProgressBar1.Visible = False
    OkCmd.Enabled = True
End Sub

Sub Add_Rec()   ''USED FOR GENERATE INVOICE
    If MFormat = "Invoice Generation Settlement Wise" Then
        Frame2.Enabled = True
        vcDTP1.SetFocus
        Call Ask_Var("FFFFTTFF")
    End If
End Sub

Sub CANCEL_REC()    ''USED FOR GENERATE INVOICE
    If MFormat = "Invoice Generation Settlement Wise" Then
        Fb_Press = 0
        Call Ask_Var("TFTFFTFF")
        OkCmd.Enabled = True
    End If
End Sub
Sub ClosingRateList()
    Dim TRec As ADODB.Recordset
    Me.MousePointer = 11
    LSExCodes = Get_ExCodes
    LSSaudas = Get_Saudas
    mysql = "SELECT CR.CONDATE,SU.SAUDANAME,CR.LOWRATE,CR.HGRATE,CR.CLOSERATE,CR.OPRATE,CR.CLRATE,IT.EXCHANGECODE"
    mysql = mysql & " FROM CTR_R AS CR, SAUDAMAST AS SU,ITEMMAST AS IT WHERE CR.COMPCODE=" & GCompCode & " "
    mysql = mysql & " AND CR.COMPCODE = SU.COMPCODE AND CR.COMPCODE=IT.COMPCODE AND IT.ITEMID = SU.ITEMID "
    mysql = mysql & " AND CR.SAUDAID=SU.SAUDAID AND CR.CONDATE >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    mysql = mysql & " AND CR.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND IT.EXID IN (" & LSExCodes & ")  "
    If AllSaudas = False Then mysql = mysql & " AND CR.SAUDAID IN (" & LSSaudas & ")  "
    mysql = mysql & " ORDER BY IT.EXCHANGECODE,CR.CONDATE,SU.ITEMCODE,SU.MATURITY "
    Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Not TRec.EOF Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "RateLst.rpt", 1)
        mysql = "Rate List"
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("org").text = "'" & GCompanyName & "'"
        mysql = "' Rate List From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
        CRViewer1.ZOrder
        CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True
        CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
        Me.MousePointer = 0
        OkCmd.Enabled = True
        Exit Sub
err1:
        MsgBox err.Description, vbCritical, "Error Number : " & err.Number
        Me.MousePointer = 0: OkCmd.Enabled = True
    Else
        MsgBox "Record does not exists.", vbInformation
        Me.MousePointer = 0: Command1.Enabled = True
    End If

End Sub
Sub BROKERAGE_LIST()
    On Error GoTo err1
    Dim SrNo As Long
    Dim TRec As ADODB.Recordset
    Dim TRec2 As ADODB.Recordset
    Dim A As Long
    Dim LUptoDate As Date
    Dim LACCID As Long
    Dim LExID As Integer
    Dim LItemID As Long
    Dim LInstType As String
    LSExCodes = Get_ExCodes
    LSSaudas = Get_Saudas
    LSParties = Get_Parties
    
    If AllParties = False And LenB(LSParties) = 0 Then
        MsgBox "Please Select Party.", vbCritical:
        Frame2.Enabled = True
        PartyCmd.SetFocus: Exit Sub
    End If
    If MFormat = "Sub Brokerage && Sharing List" Then
        Me.MousePointer = Val(11):
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "PartyName", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "ItemName", adVarChar, 20, adFldIsNullable
        RecRpt.Fields.Append "BrokType", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "BrokRate", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BBrokType", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "BBrokRate", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "ShareType", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "Share", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "UptoStDt", adDate, , adFldIsNullable
        RecRpt.Fields.Append "INSTTYPE", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        RecRpt.Fields.Append "FMlYHEAD", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "HEADNAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "CONTRA_AC", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "CONTRANAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 20, adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
        
        mysql = "SELECT D.FMLYID,D.FMLYCODE, D.FMLYNAME, D.FMLYHEAD, B.NAME AS HEADNAME, D.CONTRA_AC, C.NAME AS CONTRANAME, E.ACCID,E.AC_CODE,  E.NAME AS PARTYNAME, A.EXID,A.EXCODE,A.INSTTYPE"
        mysql = mysql & " ,A.BROKTYPE, A.BROKRATE, A.SHTYPE, A.SHRATE, A.UPTOSTDT "
        mysql = mysql & " FROM PEXSBROK AS A, ACCOUNTM AS B, ACCOUNTM AS C, ACCFMLY AS D , ACCOUNTM AS E "
        mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & "   "
        mysql = mysql & " And D.HEADID = B.ACCID And D.CONTRAID = C.ACCID  And A.FMLYID = D.FMLYID  And A.ACCID =E.ACCID "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND A.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND A.EXID IN (" & LSExCodes & ")"
        mysql = mysql & " ORDER BY B.NAME, E.NAME,A.EXCODE,A.INSTTYPE,A.UPTOSTDT"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        Do While Not TRec.EOF
            RecRpt.AddNew
            RecRpt!FMLYCODE = TRec!FMLYCODE:            RecRpt!FmlyNAME = TRec!FmlyNAME
            RecRpt!FMLYHEAD = TRec!FMLYHEAD:            RecRpt!HEADNAME = TRec!HEADNAME
            RecRpt!Contra_Ac = TRec!Contra_Ac:          RecRpt!CONTRAname = TRec!CONTRAname
            RecRpt!PARTYCODE = TRec!FMLYCODE:           RecRpt!PARTYNAME = TRec!FmlyNAME
            RecRpt!ITEMName = TRec!excode:              RecRpt!INSTTYPE = TRec!INSTTYPE
            RecRpt!excode = TRec!excode:                RecRpt!PARTYNAME = TRec!PARTYNAME
            RecRpt!SHARE = TRec!SHRATE:                 RecRpt!bbrokrate = Val(TRec!brokrate & vbNullString)
            LACCID = TRec!ACCID
            LExID = TRec!EXID
            LItemID = 0
            LUptoDate = TRec!UPTOSTDT
            LInstType = TRec!INSTTYPE
            Set TRec2 = Nothing: Set TRec2 = New ADODB.Recordset                   ''BROKERAGE CALCULATION
            mysql = "EXEC GET_BROKRATE  " & LACCID & "," & LExID & "," & LItemID & ",'" & Format(LUptoDate, "yyyy/MM/dd") & "','" & LInstType & "'"
            TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec2.EOF Then
                RecRpt!brokrate = TRec2!brokrate
                Select Case TRec2!broktype
                    Case "T"
                        RecRpt!broktype = "Transaction"
                    Case "O"
                        RecRpt!broktype = "Opening Sauda"
                    Case "C"
                        RecRpt!broktype = "Closing Sauda"
                    Case "P"
                        RecRpt!broktype = "Percentage wise"
                End Select
            End If
            Set TRec2 = Nothing
             
            Select Case TRec!broktype
             Case "T"
                RecRpt!bbroktype = "Transaction"
            Case "O"
                RecRpt!bbroktype = "Opening Sauda"
            Case "C"
                RecRpt!bbroktype = "Closing Sauda"
            Case "P"
                RecRpt!bbroktype = "Percentage wise"
            End Select
            If TRec!SHTYPE = "N" Then
                RecRpt!SHARETYPE = "Net Amount"
            Else
                RecRpt!SHARETYPE = "Gross Amount"
            End If
            RecRpt!UPTOSTDT = Format(TRec!UPTOSTDT, "YYYY/MM/DD")
            RecRpt.Update
            TRec.MoveNext
        Loop
        
        mysql = "SELECT A.FMLYID,A.FMLYCODE, D.FMLYNAME,D.FMLYHEAD, B.NAME AS HEADNAME, D.CONTRA_AC, C.NAME AS CONTRANAME, E.ACCID,E.AC_CODE, E.NAME AS PARTYNAME, A.EXID,A.EXCODE, A.ITEMID,A.ITEMCODE, A.INSTTYPE"
        mysql = mysql & " ,A.BROKTYPE,A.BROKRATE,A.SHTYPE,A.SHRATE,A.UPTOSTDT "
        mysql = mysql & " FROM PITSBROK AS A, ACCOUNTM AS B, ACCOUNTM AS C, ACCFMLY AS D , ACCOUNTM AS E "
        mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & "  "
        mysql = mysql & " And D.HEADID = B.ACCID And D.CONTRAID  = C.ACCID And A.FMLYID  = D.FMLYID  And A.ACCID =E.ACCID "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND A.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND A.EXID IN (" & LSExCodes & ")"
        mysql = mysql & " ORDER BY B.NAME,E.NAME,A.EXCODE,A.ITEMCODE,A.INSTTYPE,A.UPTOSTDT"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        Do While Not TRec.EOF
            RecRpt.AddNew
            RecRpt!FMLYCODE = TRec!FMLYCODE:            RecRpt!FmlyNAME = TRec!FmlyNAME
            RecRpt!FMLYHEAD = TRec!FMLYHEAD:            RecRpt!HEADNAME = TRec!HEADNAME
            RecRpt!Contra_Ac = TRec!Contra_Ac:          RecRpt!CONTRAname = TRec!CONTRAname
            RecRpt!PARTYCODE = TRec!FMLYCODE:
            RecRpt!ITEMName = TRec!ITEMCODE:            RecRpt!INSTTYPE = TRec!INSTTYPE
            RecRpt!excode = TRec!excode:                RecRpt!PARTYNAME = TRec!PARTYNAME
            RecRpt!SHARE = TRec!SHRATE:                 RecRpt!brokrate = Val(TRec!brokrate & vbNullString)
            LACCID = TRec!ACCID
            LExID = 0
            LItemID = TRec!itemid
            LUptoDate = TRec!UPTOSTDT
            LInstType = TRec!INSTTYPE
            
            Set TRec2 = Nothing: Set TRec2 = New ADODB.Recordset                   ''BROKERAGE CALCULATION
            mysql = "EXEC GET_BROKRATE  " & LACCID & "," & LExID & "," & LItemID & ",'" & Format(LUptoDate, "yyyy/MM/dd") & "','" & LInstType & "'"
            TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec2.EOF Then
                RecRpt!brokrate = TRec2!brokrate
                Select Case TRec2!broktype
                    Case "T"
                        RecRpt!broktype = "Transaction"
                    Case "O"
                        RecRpt!broktype = "Opening Sauda"
                    Case "C"
                        RecRpt!broktype = "Closing Sauda"
                    Case "P"
                        RecRpt!broktype = "Percentage wise"
                End Select
            End If
            Set TRec2 = Nothing
            
            
            Select Case TRec!broktype
             Case "T"
                RecRpt!broktype = "Transaction"
            Case "O"
                RecRpt!broktype = "Opening Sauda"
            Case "C"
                RecRpt!broktype = "Closing Sauda"
            Case "P"
                RecRpt!broktype = "Percentage wise"
            End Select
            If TRec!SHTYPE = "N" Then
                RecRpt!SHARETYPE = "Net Amount"
            Else
                RecRpt!SHARETYPE = "Gross Amount"
            End If
            RecRpt!UPTOSTDT = Format(TRec!UPTOSTDT, "YYYY/MM/DD")
            RecRpt.Update
            TRec.MoveNext
        Loop
        'ITEMWISE SUB BROK BROK
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "SUBBROKLIST.rpt", 1)
    Else

        Me.MousePointer = Val(11):
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "PrtyName", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "ItemName", adVarChar, 20, adFldIsNullable
        RecRpt.Fields.Append "BrokType", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "BrokRate", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MrgnType", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "MrgnRate", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "UPTOSTDT", adDate, , adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 6, adFldIsNullable
        RecRpt.Fields.Append "INSTTYPE", adVarChar, 7, adFldIsNullable
        RecRpt.Fields.Append "BrokRate2", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MINRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MBROKTYPE", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "MBROKRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "MBROKRATE2", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic

        mysql = "SELECT DISTINCT A.NAME,P.INSTTYPE ,P.EXCODE,P.BROKTYPE,P.BROKRATE,P.BROKRATE2,P.MARTYPE,P.MARRATE,P.UPTOSTDT"
        mysql = mysql & ",P.MINRATE,P.MBROKTYPE,P.MBROKRATE,P.MBROKRATE2 FROM PEXBROK AS P, "
        mysql = mysql & " ACCOUNTD AS A WHERE A.COMPCODE=" & GCompCode & " AND P.ACCID =A.ACCID "
        If Check3.Value = 1 Then mysql = mysql & " AND P.BROKRATE=0 "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND P.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND   P.AC_CODE IN (" & LSParties & ") "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND P.EXID  IN (" & LSExCodes & ")"
        mysql = mysql & " ORDER BY A.NAME,P.EXCODE,P.INSTTYPE,P.UPTOSTDT "
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        Do While Not TRec.EOF
            RecRpt.AddNew
            RecRpt!PrtyName = TRec!NAME
            RecRpt!ITEMName = TRec!excode
            RecRpt!excode = TRec!excode
            RecRpt!INSTTYPE = TRec!INSTTYPE
            If TRec!broktype = "T" Then
                RecRpt!broktype = "Transaction"
            ElseIf TRec!broktype = "O" Then
                RecRpt!broktype = "Opening Sauda"
            ElseIf TRec!broktype = "C" Then
                RecRpt!broktype = "Closing Sauda"
            ElseIf TRec!broktype = "P" Then
                RecRpt!broktype = "Percentage wise"
            ElseIf TRec!broktype = "I" Then
                RecRpt!broktype = "Intraday Brokerage"
            ElseIf TRec!broktype = "Q" Then
                RecRpt!broktype = "Quantity Wise IntraDay"
            ElseIf TRec!broktype = "H" Then
                RecRpt!broktype = "Higher Value Wise"
            ElseIf TRec!broktype = "W" Then
                RecRpt!broktype = "WHigher Value Wise"
            
            ElseIf TRec!broktype = "R" Then
                RecRpt!broktype = "RZLotwise Intraday"
            ElseIf TRec!broktype = "X" Then
                RecRpt!broktype = "XIntraDay"
            ElseIf TRec!broktype = "Z" Then
                RecRpt!broktype = "ZLotwise"
            ElseIf TRec!broktype = "V" Then
                RecRpt!broktype = "Value Wise Intraday"
            End If
            
            If TRec!MBROKTYPE = "T" Then
                RecRpt!MBROKTYPE = "Transaction"
            ElseIf TRec!MBROKTYPE = "O" Then
                RecRpt!MBROKTYPE = "Opening Sauda"
            ElseIf TRec!MBROKTYPE = "C" Then
                RecRpt!MBROKTYPE = "Closing Sauda"
            ElseIf TRec!MBROKTYPE = "P" Then
                RecRpt!MBROKTYPE = "Percentage wise"
            ElseIf TRec!MBROKTYPE = "Q" Then
                RecRpt!MBROKTYPE = "Quantity Wise IntraDay"
            ElseIf TRec!MBROKTYPE = "H" Then
                RecRpt!MBROKTYPE = "Higher Value Wise"
            ElseIf TRec!MBROKTYPE = "W" Then
                RecRpt!MBROKTYPE = "WHigher Value Wise"
            ElseIf TRec!MBROKTYPE = "X" Then
                RecRpt!MBROKTYPE = "XIntraDay"
            ElseIf TRec!MBROKTYPE = "Z" Then
                RecRpt!MBROKTYPE = "ZLotwise"
            ElseIf TRec!MBROKTYPE = "v" Then
                RecRpt!MBROKTYPE = "Value Wise Intraday"
            End If
            RecRpt!brokrate = Val(TRec!brokrate & vbNullString)
            RecRpt!BROKRATE2 = Val(TRec!BROKRATE2 & vbNullString)
            RecRpt!MBROKRATE = Val(TRec!MBROKRATE & vbNullString)
            RecRpt!MBROKRATE2 = Val(TRec!MBROKRATE2 & vbNullString)
            RecRpt!MinRate = Val(TRec!MinRate & vbNullString)
            
            If TRec!MARTYPE = "Q" Then
                RecRpt!MrgnType = "Qtywise (Per Unit)"
            Else
                RecRpt!MrgnType = "Value Wise (In %)"
            End If
            RecRpt!MrgnRate = Val(TRec!MARRATE & vbNullString)
            RecRpt!UPTOSTDT = TRec!UPTOSTDT
            RecRpt.Update
            TRec.MoveNext
        Loop

        mysql = "SELECT A.NAME,I.EXCHANGECODE, I.ITEMNAME,P.INSTTYPE ,P.BROKTYPE,P.BROKRATE,P.BROKRATE2,P.MARTYPE,P.MARRATE,P.UPTOSTDT"
        mysql = mysql & " , P.MINRATE,P.MBROKTYPE,P.MBROKRATE,P.MBROKRATE2 FROM PITBROK AS P,ACCOUNTD AS A,ITEMMAST AS I WHERE A.COMPCODE=" & GCompCode & " "
        mysql = mysql & " AND P.ACCID =A.ACCID  AND P.ITEMID = I.ITEMID "
        If Check3.Value = 1 Then mysql = mysql & " AND P.BROKRATE=0 "
        If AllSaudas = False Then mysql = mysql & "  AND P.ITEMCODE IN (" & LSSaudas & ")"
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND P.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND P.AC_CODE IN (" & LSParties & ") "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
        If Combo1.ListIndex = 0 Then
            mysql = mysql & "ORDER BY A.NAME,I.ITEMNAME,UPTOSTDT"
        Else
            mysql = mysql & "ORDER BY I.ITEMNAME,A.NAME,UPTOSTDT"
        End If
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        Do While Not TRec.EOF
            RecRpt.AddNew
            RecRpt!PrtyName = TRec!NAME
            RecRpt!ITEMName = TRec!ITEMName
            RecRpt!excode = TRec!EXCHANGECODE
            RecRpt!INSTTYPE = TRec!INSTTYPE
            If TRec!broktype = "T" Then
                RecRpt!broktype = "Transaction"
            ElseIf TRec!broktype = "O" Then
                RecRpt!broktype = "Opening Sauda"
            ElseIf TRec!broktype = "C" Then
                RecRpt!broktype = "Closing Sauda"
            ElseIf TRec!broktype = "P" Then
                RecRpt!broktype = "Percentage wise"
            ElseIf TRec!broktype = "I" Then
                RecRpt!broktype = "Intraday Brokerage"
            ElseIf TRec!broktype = "R" Then
                RecRpt!broktype = "RZLotwise Intraday"
            ElseIf TRec!broktype = "Q" Then
                RecRpt!broktype = "Quantity Wise IntraDay"
            ElseIf TRec!broktype = "H" Then
                RecRpt!broktype = "Higher Value Wise"
            ElseIf TRec!broktype = "W" Then
                RecRpt!broktype = "WHigher Value Wise"
            ElseIf TRec!broktype = "X" Then
                RecRpt!broktype = "XIntraDay"
            ElseIf TRec!broktype = "Z" Then
                RecRpt!broktype = "ZLotwise"
            ElseIf TRec!broktype = "v" Then
                RecRpt!broktype = "Value Wise Intraday"
            End If
            
            If TRec!MBROKTYPE = "T" Then
                RecRpt!MBROKTYPE = "Transaction"
            ElseIf TRec!MBROKTYPE = "O" Then
                RecRpt!MBROKTYPE = "Opening Sauda"
            ElseIf TRec!MBROKTYPE = "C" Then
                RecRpt!MBROKTYPE = "Closing Sauda"
            ElseIf TRec!broktype = "P" Then
                RecRpt!MBROKTYPE = "Percentage wise"
            ElseIf TRec!MBROKTYPE = "I" Then
                RecRpt!MBROKTYPE = "Intraday Brokerage"
            ElseIf TRec!MBROKTYPE = "Q" Then
                RecRpt!MBROKTYPE = "Quantity Wise IntraDay"
            ElseIf TRec!MBROKTYPE = "H" Then
                RecRpt!MBROKTYPE = "Higher Value Wise"
            ElseIf TRec!MBROKTYPE = "W" Then
                RecRpt!MBROKTYPE = "WHigher Value Wise"
            ElseIf TRec!MBROKTYPE = "X" Then
                RecRpt!MBROKTYPE = "XIntraDay"
            ElseIf TRec!MBROKTYPE = "Z" Then
                RecRpt!MBROKTYPE = "ZLotwise"
            ElseIf TRec!MBROKTYPE = "v" Then
                RecRpt!MBROKTYPE = "Value Wise Intraday"
            End If
            
            
            RecRpt!brokrate = Val(TRec!brokrate & vbNullString)
            RecRpt!BROKRATE2 = Val(TRec!BROKRATE2 & vbNullString)
            RecRpt!MBROKRATE = Val(TRec!MBROKRATE & vbNullString)
            RecRpt!MBROKRATE2 = Val(TRec!MBROKRATE2 & vbNullString)
            RecRpt!MinRate = Val(TRec!MinRate & vbNullString)
            
            If TRec!MARTYPE = "Q" Then
                RecRpt!MrgnType = "Qtywise (Per Unit)"
            Else
                RecRpt!MrgnType = "Value Wise (In %)"
            End If
            RecRpt!MrgnRate = Val(TRec!MARRATE & "")
            RecRpt!UPTOSTDT = TRec!UPTOSTDT
            RecRpt.Update
            TRec.MoveNext
        Loop
        RecRpt.Sort = "PrtyName,EXCODE,INSTTYPE,ITEMName,UPTOSTDT"
        If Combo1.ListIndex = 0 Then 'PARTY WISE
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "PwBList.rpt", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "IwBList.rpt", 1)
        End If
    End If
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource RecRpt
    mysql = "Sub Brokerage and Sharing List "
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0:
    Frame2.Enabled = True
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    
    Me.MousePointer = 0
    
    OkCmd.Enabled = True
End Sub
Private Sub ContBFram_ColumnClick(ByVal ColumnHeader As MSComctlLib.ColumnHeader)
    ContBFram.Sorted = True
    If ColumnHeader = "Contract" Then
        ContBFram.SortKey = 0
    ElseIf ColumnHeader = "Date" Then
        ContBFram.SortKey = 1
    ElseIf ColumnHeader = "Qty." Then
        ContBFram.SortKey = 2
    ElseIf ColumnHeader = "Rate" Then
        ContBFram.SortKey = 3
    ElseIf ColumnHeader = "Sauda" Then
        ContBFram.SortKey = 4
    End If
    If ContBFram.SORTORDER = lvwAscending Then
        ContBFram.SORTORDER = lvwDescending
    Else
        ContBFram.SORTORDER = lvwAscending
    End If
End Sub
Private Sub ContSFram_ColumnClick(ByVal ColumnHeader As MSComctlLib.ColumnHeader)
    ContSFram.Sorted = True
    If ColumnHeader = "Contract" Then
        ContSFram.SortKey = 0
    ElseIf ColumnHeader = "Date" Then
        ContSFram.SortKey = 1
    ElseIf ColumnHeader = "Qty." Then
        ContSFram.SortKey = 2
    ElseIf ColumnHeader = "Rate" Then
        ContSFram.SortKey = 3
    ElseIf ColumnHeader = "Sauda" Then
        ContSFram.SortKey = 4
    End If
    If ContSFram.SORTORDER = lvwAscending Then
        ContSFram.SORTORDER = lvwDescending
    Else
        ContSFram.SORTORDER = lvwAscending
    End If
End Sub
Sub Daily_Activity_Statement()
    Call DailyStatement
    Me.MousePointer = 0
    GETMAIN.ProgressBar1.Visible = False
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub
Sub DailyStatement()
End Sub
Sub Bill_Acstt()
    Dim TRec As ADODB.Recordset:    Dim GPhone As String
    
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes
    LSInst = Get_Inst
    Call AccRecNew
    
    Set PartyRec = Nothing
    Set PartyRec = New ADODB.Recordset
    mysql = "SELECT DISTINCT A.ACCID,A.AC_CODE,A.NAME,A.OP_BAL,B.ADD1,B.CITY,B.PANNO,B.PIN,B.PHONEO,B.PHONER,B.FAX,B.MOBILE,B.PIN,B.SRTAXAPP,C.SAUDA,B.PARTYTYPE,B.GSTIN,B.STATE,B.STATECODE,B.EMAIL, "
    mysql = mysql & " S.INSTTYPE,S.ITEMCODE,S.STRIKEPRICE,S.OPTTYPE,S.MATURITY,I.EXCHANGECODE,I.LOT,S.TRADEABLELOT,I.RISKMAPP,S.BROKLOT ,S.SAUDANAME,I.ITEMNAME,I.SCGROUP,S.REFLOT "
    mysql = mysql & " ,C.BILLNO,C.STDATE,C.FROMDATE,C.OPQTY,C.OPRATE,C.OPENDT,C.CLQTY,C.CLRATE,C.DIFFAMT,C.BROKAMT,C.STDAMT,C.TRANAMT,C.BILLAMT,C.SRVAMT , C.STAMPAMT, C.STTTAX, C.CTTAMT, "
    mysql = mysql & " RISKMAMT, C.SEBITAXAMT, C.SBC_TAX_AMT,C.CGSTAMT,C.SGSTAMT,C.IGSTAMT,C.UTTAMT "
    mysql = mysql & " FROM ACCOUNTM AS A, ACCOUNTD AS B, INV_D AS C, ITEMMAST AS I, SAUDAMAST AS S "
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID  =B.ACCID "
    mysql = mysql & " AND S.ITEMID =I.ITEMID AND S.MATURITY >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
    mysql = mysql & " AND A.ACCID =C.ACCID  AND C.SAUDAID=S.SAUDAID"
    mysql = mysql & " AND C.STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND C.STDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE  FMLID  IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  A.AC_CODE IN (" & LSParties & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    If AllSaudas = False Then mysql = mysql & " AND C.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " ORDER BY A.NAME,I.EXCHANGECODE,S.ITEMCODE,S.INSTTYPE,S.MATURITY,C.STDATE"
    
    PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If PartyRec.EOF Then
        MsgBox "No Records.", vbCritical:
        Frame2.Enabled = True
        PartyCmd.SetFocus: Exit Sub
    End If
    mysql = "SELECT CONTRACTACC,EXCODE,LOTWISE FROM EXMAST WHERE COMPCODE =" & GCompCode & " "
    Set Rec_ExMast = Nothing: Set Rec_ExMast = New ADODB.Recordset: Rec_ExMast.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    Call Bill_GenerateStatement
    If CreateChk.Value = 1 Then
        MsgBox "Files Exported Successfully"
    Else
        AccRecSet.Filter = adFilterNone
        If AccRecSet.RecordCount > 0 Then
            AccRecSet.Sort = "srno asc"
            AccRecSet.MoveFirst
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "BILL_ACSTT.rpt", 1)
            mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            GPhone = "Ph: " & GCompPhoneO & ", " & GCompPhoneR & "," & GCompMobile & ""
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource AccRecSet
            RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
            RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
            RDCREPO.FormulaFields.GetItemByName("GTTL").text = "'" & GCompTitle & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
            RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
            RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
            RDCREPO.FormulaFields.GetItemByName("OPHONE1").text = "'" & GPhone & "'"
            RDCREPO.FormulaFields.GetItemByName("SRVNO").text = "'" & GSrvRegNo & "'"
            If Option4.Value Then
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'Y'"
            ElseIf Option5.Value Then
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'L'"
            Else
                RDCREPO.FormulaFields.GetItemByName("WOPBAL").text = "'" & mysql & "'"
            End If
            If Option1.Value Then
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'Y'"
            Else
                RDCREPO.FormulaFields.GetItemByName("WMRGN").text = "'N'"
            End If
            CRViewer1.ZOrder
            CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
            CRViewer1.Visible = True
            CRViewer1.ReportSource = RDCREPO
            CRViewer1.Zoom 1
            CRViewer1.ViewReport
        Else
            MsgBox "Record does not exists.", vbInformation
        End If
    End If
Me.MousePointer = 0
GETMAIN.ProgressBar1.Visible = False
OkCmd.Enabled = True
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub


Sub Bill_GenerateStatement()
Dim LPartyCode As String:       Dim LContractAcc As String:     Dim LDebitAmt As Double:        Dim LCreditAmt As Double
Dim LStDate As Date:            Dim LTitle As String:           Dim LMarType As String
Dim LSaudaCode As String:       Dim LExCode As String:          Dim LPartyName As String:       Dim LOpenRate As Double:
Dim LBAmt As Double:            Dim LRefLot As Double:          Dim LSAmt As Double:            Dim LBillNo As Long
Dim LMarRate As Double:         Dim LCloseQty As Double:        Dim LCloseRate As Double:       Dim LCalval As Double
Dim LBrokLot As Double:         Dim MBal As Double:             Dim LBal As Double:             Dim MOpBal As Double
Dim LMIRate  As Double:         Dim LMERate As Double:          Dim LMARate As Double:          Dim LAddLongRate As Double
Dim LAddShortRate As Double:    Dim LBrokRate As Double:        Dim LBrokRate2 As Double:       Dim LBrokQty As Double
Dim LBrokQty2 As Double:        Dim LStrike As Double:          Dim LTradeableLot As Double:    Dim GSrvTax As Double
Dim LSBrokRate  As Double:      Dim LSBrokRate2 As Double:      Dim LSDutyAmt As Double:        Dim LBrokAmount As Double
Dim LTranAmount As Double:      Dim LStmAmt As Double:          Dim LTotStmAmt As Double:       Dim LStmRate As Double
Dim LSTTAmt As Double:          Dim LTotSTTAmt As Double:       Dim LSTTRate As Double:         Dim LRiskMAmt  As Double
Dim LSEBITaxAmt As Double:      Dim LTotSEBITaxAmt As Double:   Dim LSEBITax As Double:         Dim LSBCTaxAmt As Double
Dim LMarAmt As Double:          Dim LMinRate As Double:         Dim LNStmAmt As Double:         Dim LSGSTAmt As Double
Dim MTotBQty As Double:         Dim MTotSQty As Double:         Dim GTrFees As Double:          Dim GSTDChrs As Double
Dim MOpQty As Double:           Dim LIGSTAmt As Double:         Dim LUTTAmt As Double:          Dim OpQty As Double
Dim LCGSTAmt As Double:         Dim MTotBAmt As Double:         Dim MTotSAmt As Double:         Dim MTotOpAmt As Double
Dim MSrvTax As Double:          Dim LTranRate As Double:        Dim LCBrokAmt As Double:        Dim LcTranAmt   As Double
Dim LSBCTax As Double:          Dim LCGSTRate As Double:        Dim LSGSTRate As Double:        Dim LIGSTRate As Double:
Dim LUTTRate As Double:         Dim MClQty As Double:           Dim BROKAMT As Double:          Dim LShareAmt As Double
Dim LAMT As Double:             Dim TotAmt As Double:           Dim LBIllAmt As Double:         Dim LBrokType As String
Dim LATranType As String:       Dim LSInstType As String:       Dim LLotWise As String:         Dim LCGSTType As String:
Dim LIGSTType As String:        Dim LUTTType As String:         Dim LScGroup As String:         Dim LMBrokType As String:
Dim MItemCode  As String:       Dim MCLPattan As String:        Dim Lmaturity As Date:
Dim TRec As ADODB.Recordset:    Dim LPANNO As String:           Dim LPHoneo As String:          Dim LPhoneR As String:
Dim LFAX As String:             Dim LItemCode As String:        Dim LMobile As String:          Dim LPIN As String
Dim LItemName As String:        Dim LInstType As String:        Dim LSaudaName As String:       Dim LSGSTType As String:
Dim LCINNo As String:           Dim LTotCGSTAmt As Double:      Dim LTotSGSTAmt As Double:      Dim LTotIGSTAmt As Double:
Dim LTotUTTAmt As Double:       Dim CountRec As Long:           Dim LStmFlag As Boolean:        Dim LOpFlag As Boolean
Dim MExCode As String
Dim GMarRate As Double
Dim LACCID As Long
Dim MCMXNETAMT As Long

LOpFlag = False
LPartyCode = vbNullString
    Me.MousePointer = Val(11)
    Do While Not PartyRec.EOF ' party loop
        If LPartyCode <> PartyRec!AC_CODE Then
            LOpFlag = False
        End If
        LPartyCode = PartyRec!AC_CODE:        LPartyName = PartyRec!NAME
        LPANNO = Trim(IIf(IsNull(PartyRec!PANNO), "", PartyRec!PANNO))
        LPHoneo = Trim(IIf(IsNull(PartyRec!PhoneO), "", PartyRec!PhoneO))
        LPhoneR = Trim(IIf(IsNull(PartyRec!PhoneR), "", PartyRec!PhoneR))
        LFAX = Trim(IIf(IsNull(PartyRec!Fax), "", PartyRec!Fax))
        LMobile = Trim(IIf(IsNull(PartyRec!Mobile), "", PartyRec!Mobile))
        LPIN = Trim(IIf(IsNull(PartyRec!Pin), "", PartyRec!Pin))
        LStDate = PartyRec!STDATE:        LBillNo = PartyRec!BILLNO
        LBIllAmt = PartyRec!Billamt
        LACCID = PartyRec!ACCID
        LTitle = "Account Statement From " & PartyRec!FROMDATE & " to " & PartyRec!STDATE & ""
        MBal = 0
        If (Option4.Value) Or (Option5.Value) Then
            MOpBal = PartyRec!OP_BAL: MBal = MOpBal
            LBal = 0:    LBal = Net_DrCr(PartyRec!AC_CODE, DateValue(PartyRec!FROMDATE))
            MBal = MBal + LBal
            If Option4.Value Then
                If Check4.Value = 1 Then
                    MBal = Get_Balance(LACCID)
                Else
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    mysql = "EXEC ACSUMVCHS " & GCompCode & ",'" & PartyRec!AC_CODE & "','" & Format(PartyRec!Opendt, "yyyy/MM/dd") & "','" & Format(PartyRec!STDATE, "yyyy/MM/dd") & "'"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then MBal = MBal + IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                End If
            ElseIf Option5.Value Then
                LDebitAmt = 0: LCreditAmt = 0
                mysql = "SELECT DR_CR,SUM(AMOUNT) AS AMT  FROM VCHAMT WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & PartyRec!AC_CODE & "' AND VOU_DT>='" & Format(PartyRec!Opendt, "YYYY/MM/DD") & "'"
                mysql = mysql & " AND VOU_TYPE<>'S' AND VOU_DT<='" & Format(PartyRec!STDATE, "YYYY/MM/DD") & "' GROUP BY DR_CR"
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenDynamic, adLockReadOnly
                If Not TRec.EOF Then
                    If TRec!DR_CR = "C" Then
                        LCreditAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    End If
                    If TRec!DR_CR = "D" Then
                        LDebitAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    End If
                    TRec.MoveNext
                    If Not TRec.EOF Then
                        If TRec!DR_CR = "C" Then
                            LCreditAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                        End If
                        If TRec!DR_CR = "D" Then
                            LDebitAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                        End If
                    End If
                End If
            End If
        End If
        MExCode = PartyRec!EXCHANGECODE:        MItemCode = PartyRec!ITEMCODE
        LItemName = PartyRec!ITEMName:          LInstType = PartyRec!INSTTYPE
        LStrike = Val(PartyRec!STRIKEPRICE):    LSaudaCode = PartyRec!Sauda
        LSaudaName = PartyRec!SAUDANAME:        Lmaturity = PartyRec!MATURITY
        LBrokLot = IIf(IsNull(PartyRec!BROKLOT), 0, PartyRec!BROKLOT)
        LRefLot = IIf(IsNull(PartyRec!REFLOT), 1, PartyRec!REFLOT)
        Rec_ExMast.Filter = adFilterNone
        Rec_ExMast.MoveFirst
        Rec_ExMast.Filter = "EXCODE ='" & MExCode & "'"
        If Not Rec_ExMast.EOF Then
            LContractAcc = Rec_ExMast!CONTRACTACC
            LLotWise = Rec_ExMast!LOTWISE
        Else
            MsgBox "Invalid Exchange "
            Exit Sub
        End If
        Do While LBillNo = PartyRec!BILLNO And LPartyCode = PartyRec!AC_CODE
            DoEvents
            Label5.Caption = LPartyName & " " & LSaudaCode
            LContractAcc = vbNullString:
            LMIRate = 0: LMERate = 0: LMARate = 0: LAddLongRate = 0: LAddShortRate = 0:
            'LScGroup = IIf(IsNull(PartyRec!SCGROUP), "0", PartyRec!SCGROUP)
            LTradeableLot = PartyRec!TRADEABLELOT
            If MExCode = "NSE" And LLotWise = "Y" Then
                LCalval = PartyRec!TRADEABLELOT
            Else
                If MExCode = "MCX" And LLotWise = "Y" Then
                    LCalval = PartyRec!TRADEABLELOT
                Else
                    LCalval = PartyRec!lot
                End If
            End If
            LRiskMAmt = 0
            LMBrokType = "P":   LSBrokRate = 0:     LSBrokRate2 = 0:        LMarAmt = 0:        LMinRate = 0
            LSDutyAmt = 0:      LBrokAmount = 0:    GSrvTax = 0:            LTranAmount = 0:    LStmAmt = 0:
            LTotStmAmt = 0:     LStmRate = 0:       LSTTAmt = 0:            LTotSTTAmt = 0:     LSTTRate = 0:
            LRiskMAmt = 0:      LSEBITaxAmt = 0:    LTotSEBITaxAmt = 0:     LSEBITax = 0:       LSBCTaxAmt = 0
            LTotCGSTAmt = 0: LTotSGSTAmt = 0: LTotIGSTAmt = 0: LTotUTTAmt = 0
            DoEvents
            ''OPENING QNTY INSERTION
            MTotBQty = 0:   MTotSQty = 0:               GSTDChrs = 0:       GTrFees = 0
            MOpQty = 0:     LBrokType = vbNullString:   LBrokRate2 = 0:     LATranType = vbNullString
            MTotBAmt = 0:   MTotSAmt = 0:               MTotOpAmt = 0:      LOpenRate = 0
            OpQty = PartyRec!OpQty:                     LOpenRate = PartyRec!OPRATE
            If OpQty <> 0 Then    ''FOR OPENING INSERTION
                MTotOpAmt = OpQty * PartyRec!OPRATE * LCalval
                If MFormat = "Billwise Account Statement" Then
                    AccRecSet.AddNew
                    AccRecSet.Fields("RPTGRP") = 1:                 CountRec = CountRec + 1
                    AccRecSet.Fields("SRNO") = CountRec:            AccRecSet.Fields("EXCODE") = MExCode:
                    
                    AccRecSet.Fields("SAUDACODE") = LSaudaCode:     AccRecSet.Fields("CONTDATE") = Format(PartyRec!Opendt, "yyyy/MM/dd"):
                    AccRecSet.Fields("ITEMCODE") = MItemCode:       AccRecSet.Fields("ITEMNAME") = vbNullString:
                    AccRecSet.Fields("CALVAL") = LCalval:           AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd")
                    AccRecSet.Fields("PrevBal") = MBal:             AccRecSet.Fields("REFLOT") = LRefLot
                    AccRecSet.Fields("DEBITAMT") = Val(LDebitAmt):  AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                    AccRecSet.Fields("MATURITY") = Lmaturity:       AccRecSet.Fields("BILLDATE") = LStDate
                               AccRecSet.Fields("PATTAN") = "O"
                    If OpQty > 0 Then
                        AccRecSet.Fields("BQNTY") = Abs(Val(OpQty)): AccRecSet.Fields("BRATE") = Val(PartyRec!OPRATE)
                        AccRecSet.Fields("DRAMOUNT") = Abs(Val(OpQty)) * Val(PartyRec!OPRATE)
                        AccRecSet.Fields("SQNTY") = 0: AccRecSet.Fields("SRATE") = 0: AccRecSet.Fields("CRAMOUNT") = 0
                    Else
                        AccRecSet.Fields("BQNTY") = 0: AccRecSet.Fields("BRATE") = 0: AccRecSet.Fields("DRAMOUNT") = 0
                        AccRecSet.Fields("SQNTY") = Abs(Val(OpQty)): AccRecSet.Fields("SRATE") = Val(PartyRec!OPRATE): AccRecSet.Fields("CRAMOUNT") = Abs(Val(OpQty)) * Val(PartyRec!OPRATE)
                    End If
                    Call Add_PartyDetails
                    Call Add_OtherDetails
                    AccRecSet.Fields("BILLNO") = LBillNo:        AccRecSet.Fields("BILLDATE") = LStDate
                    AccRecSet.Fields("CONNO") = vbNullString:    AccRecSet.Fields("CONTIME") = vbNullString
                    AccRecSet.Fields("CONTDATE1") = "":          AccRecSet.Fields("RPATTAN") = vbNullString
                    AccRecSet.Fields("BrokRate") = 0:            AccRecSet.Fields("BrokType") = "P"
                    AccRecSet.Fields("MarRate") = 0:             AccRecSet.Fields("SCONNO") = "":
                    AccRecSet.Fields("SCONTIME") = "":           AccRecSet.Fields("BBROKAMT") = 0:
                    AccRecSet.Fields("SBROKAMT") = 0::           AccRecSet.Update
                    AccRecSet.Fields("WORDAMT") = LTitle:
                End If
            End If
            MSrvTax = 0
            ''BOUGHT INSERTION
            Set TRec = Nothing: Set TRec = New ADODB.Recordset:
            mysql = "SELECT CONDATE,CONTYPE,CONNO,CONTIME,ROWNO1,BROKTYPE,BROKRATE,BROKRATE2,BROKQTY,BROKQTY2,TRANTYPE,TRANRATE,STMRATE,SEBITAX,STTRATE,QTY,RATE,PATTAN,SRVTAX,SBC_TAX FROM CTR_D"
            mysql = mysql & " WHERE BILLNO =" & LBillNo & " AND PARTY='" & PartyRec!AC_CODE & "' AND SAUDA='" & PartyRec!Sauda & "' AND CONTYPE='B' ORDER BY CONDATE,CONNO"
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            With TRec
                Do While Not .EOF
                    LBrokType = IIf(IsNull(!broktype), "T", !broktype)
                    LBrokRate2 = Val(!BROKRATE2 & ""): LBrokQty = IIf(IsNull(!BROKQTY), 0, !BROKQTY)
                    LBrokRate = Val(!brokrate & ""):   LBrokQty2 = IIf(IsNull(!BROKQTY2), 0, !BROKQTY2)
                    LTranRate = Val(!TRANRATE & ""):   LATranType = IIf(IsNull(!TRANTYPE), "T", !TRANTYPE)
                    LSEBITax = Val(!SEBITAX)
                    LSTTRate = Val(!STTRATE & "")
                    If !PATTAN <> "C" Then
                        MOpQty = MOpQty + !QTY: MTotOpAmt = MTotOpAmt + (!QTY * !Rate * LCalval)
                    Else
                        MTotBQty = MTotBQty + !QTY
                        LBAmt = (!QTY * !Rate * LCalval)
                        MTotBAmt = MTotBAmt + LBAmt
                    End If
                    If MFormat = "Billwise Account Statement" Then
                        AccRecSet.AddNew
                        CountRec = CountRec + 1:
                        AccRecSet.Fields("SRNO") = CountRec:            AccRecSet.Fields("RPTGRP") = 1:
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode:     AccRecSet.Fields("CONTDATE") = Format(!Condate, "yyyy/MM/dd"):
                        AccRecSet.Fields("EXCODE") = MExCode:           AccRecSet.Fields("ITEMCODE") = MItemCode
                        AccRecSet.Fields("ITEMNAME") = vbNullString:    AccRecSet.Fields("DRAMOUNT") = Val(!QTY * !Rate)
                        AccRecSet.Fields("BQNTY") = !QTY:               AccRecSet.Fields("BRATE") = Val(!Rate)
                        AccRecSet.Fields("CTYPE") = !CONTYPE:           AccRecSet.Fields("PATTAN") = !PATTAN
                        AccRecSet.Fields("CALVAL") = LCalval:           AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd")
                        AccRecSet.Fields("PrevBal") = MBal:             AccRecSet.Fields("BrokType") = LBrokType
                        AccRecSet.Fields("DEBITAMT") = LDebitAmt:       AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                        AccRecSet.Fields("CONNO") = !ROWNO1:            AccRecSet.Fields("SEBITAX") = Val(LSEBITax)
                        AccRecSet.Fields("BBROKAMT") = LCBrokAmt:       AccRecSet.Fields("REFLOT") = LRefLot
                        AccRecSet.Fields("SBROKAMT") = 0:               AccRecSet.Fields("MarRate") = 0
                        AccRecSet.Fields("WORDAMT") = LTitle:           AccRecSet.Fields("CONTIME") = !contime
                        AccRecSet.Fields("BILLDATE") = LStDate
                        If !PATTAN = "C" Then
                            AccRecSet.Fields("BrokRate") = Val(LBrokRate & "")
                        Else
                            AccRecSet.Fields("BrokRate") = 0
                        End If
                        Call Add_PartyDetails
                        Call Add_OtherDetails
                        AccRecSet.Fields("CONTDATE1") = vbNullString:   AccRecSet.Fields("SQNTY") = 0
                        AccRecSet.Fields("RPATTAN") = vbNullString:     AccRecSet.Fields("INVNO") = 0:
                        'AccRecSet.Fields("TranRate") = 0:               AccRecSet.Fields("TranType") = "P"
                        AccRecSet.Fields("SCONNO") = vbNullString:      AccRecSet.Fields("SCONTIME") = ""
                        AccRecSet.Fields("CRAMOUNT") = 0:               AccRecSet.Fields("SRATE") = 0:
                        AccRecSet.Fields("BILLNO") = LBillNo:           AccRecSet.Fields("BILLDATE") = LStDate
                        AccRecSet.Update
                    End If
                    .MoveNext
                Loop
            End With
            ''END BOUGHT
            ''SOLD START
            LCBrokAmt = 0
            Set TRec = Nothing: Set TRec = New ADODB.Recordset
            mysql = "SELECT CONDATE,CONTYPE,CONNO,CONTIME,ROWNO1,BROKTYPE,BROKRATE,BROKRATE2,BROKQTY,BROKQTY2,TRANTYPE,TRANRATE,STMRATE,SEBITAX,STTRATE,QTY,RATE,PATTAN,SRVTAX,SBC_TAX FROM CTR_D"
            mysql = mysql & " WHERE BILLNO =" & LBillNo & " AND PARTY='" & PartyRec!AC_CODE & "' AND SAUDA='" & PartyRec!Sauda & "' AND CONTYPE='S' ORDER BY CONDATE,CONNO"
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            If Not TRec.EOF Then
                AccRecSet.Filter = adFilterNone
                AccRecSet.Sort = "SRNO ASC"
                AccRecSet.Filter = "BILLNO=" & LBillNo & " AND PARTYCODE='" & PartyRec!AC_CODE & "' And PATTAN ='C'"
                Do While Not AccRecSet.EOF
                    LBrokType = IIf(IsNull(TRec!broktype), "T", TRec!broktype): LBrokRate = Val(TRec!brokrate & ""): LATranType = IIf(IsNull(TRec!TRANTYPE), "T", TRec!TRANTYPE): LTranRate = Val(TRec!TRANRATE & ""):
                    LSTTRate = Val(TRec!STTRATE & ""):              LSEBITax = Val(TRec!SEBITAX & ""):
                    LBrokRate2 = Val(TRec!BROKRATE2 & ""):          LBrokQty = IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY)
                    LBrokQty2 = IIf(IsNull(TRec!BROKQTY2), 0, TRec!BROKQTY2)
                    If TRec!PATTAN <> "C" Then
                        MOpQty = MOpQty - TRec!QTY: MTotOpAmt = MTotOpAmt - (TRec!QTY * TRec!Rate * LCalval)
                        If MFormat = "Billwise Account Statement" Then
                            AccRecSet.AddNew
                            CountRec = CountRec + 1
                            AccRecSet.Fields("RPTGRP") = 1:              AccRecSet.Fields("SHAREAMT") = 0
                            AccRecSet.Fields("SAUDACODE") = LSaudaCode:  AccRecSet.Fields("EXCODE") = MExCode
                            AccRecSet.Fields("BILLNO") = LBillNo:        AccRecSet.Fields("BILLDATE") = LStDate

                            AccRecSet.Fields("ITEMCODE") = MItemCode:    AccRecSet.Fields("ITEMNAME") = LItemName
                            AccRecSet.Fields("SQNTY") = TRec!QTY:        AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd")
                            AccRecSet.Fields("SRATE") = TRec!Rate:       AccRecSet.Fields("CTYPE") = TRec!CONTYPE
                            AccRecSet.Fields("PATTAN") = TRec!PATTAN:    AccRecSet.Fields("CRAMOUNT") = TRec!QTY * TRec!Rate
                            AccRecSet.Fields("CONTDATE") = vbNullString: AccRecSet.Fields("CONTDATE1") = Format(TRec!Condate, "yyyy/MM/dd")
                            AccRecSet.Fields("SRNO") = CountRec:         AccRecSet.Fields("INVNO") = 0
                            AccRecSet.Fields("CALVAL") = LCalval:        AccRecSet.Fields("DEBITAMT") = LDebitAmt:
                            AccRecSet.Fields("PrevBal") = MBal:          AccRecSet.Fields("SEBITAX") = 0
                            AccRecSet.Fields("SCONNO") = TRec!ROWNO1:    AccRecSet.Fields("TranRate") = Val(TRec!brokrate)
                            AccRecSet.Fields("SCONTIME") = TRec!contime: AccRecSet.Fields("CREDITAMT") = LCreditAmt
                            AccRecSet.Fields("REFLOT") = LRefLot:        AccRecSet.Fields("WORDAMT") = LTitle
                            AccRecSet.Fields("TranType") = IIf(IsNull(TRec!broktype), "T", TRec!broktype)

                            AccRecSet.Fields("BROKERAGE") = 0:           AccRecSet.Fields("STANDING") = 0
                            AccRecSet.Fields("TRFEES") = 0:
                            AccRecSet.Fields("BQNTY") = 0:               AccRecSet.Fields("BRATE") = 0
                            AccRecSet.Fields("COMPCODE") = 0:            AccRecSet.Fields("rpattan") = vbNullString
                            AccRecSet.Fields("ServiceTax") = 0:          AccRecSet.Fields("ShareAmt") = 0:
                            AccRecSet.Fields("STTTax") = 0:              AccRecSet.Fields("SebiTaxAmt") = 0
                            AccRecSet.Fields("TurnOverTax") = 0:         AccRecSet.Fields("TranTax") = 0:
                            AccRecSet.Fields("BrokRate") = 0:            AccRecSet.Fields("BrokType") = vbNullString:
                            AccRecSet.Fields("MarRate") = 0:             AccRecSet.Fields("MarAmt") = 0
                            AccRecSet.Fields("MarType") = vbNullString:  AccRecSet.Fields("DRAMOUNT") = 0:
                            Call Add_PartyDetails
                            AccRecSet.Update
                        End If
                    Else
                        LSAmt = TRec!QTY * TRec!Rate * LCalval
                        MTotSQty = MTotSQty + TRec!QTY: MTotSAmt = MTotSAmt + LSAmt
                        LcTranAmt = 0
                        If MFormat = "Billwise Account Statement" Then
                            AccRecSet.Fields("CONTDATE1") = Format(TRec!Condate, "yyyy/MM/dd")
                            AccRecSet.Fields("SQNTY") = TRec!QTY:    AccRecSet.Fields("SRate") = TRec!Rate
                            AccRecSet.Fields("CRAMOUNT") = TRec!QTY * TRec!Rate
                            AccRecSet.Fields("SBROKAMT") = LCBrokAmt
                            AccRecSet.Fields("SCONNO") = TRec!ROWNO1:     AccRecSet.Fields("SCONTIME") = TRec!contime
                            AccRecSet.Fields("TRANTAX") = 0:              AccRecSet.Fields("TurnOverTax") = 0:
                            AccRecSet.Fields("SEBITAX") = Val(LSEBITax):  AccRecSet.Fields("SEBITAXAMT") = 0
                            AccRecSet.Update
                        End If
                    End If
                    AccRecSet.MoveNext
                    'Service tax calculation **************
                    MSrvTax = Val(TRec!SRVTAX & "")
                    LSBCTax = Val(TRec!SBC_TAX)
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
                With TRec
                    Do While Not .EOF
                        LBrokType = IIf(IsNull(!broktype), "T", !broktype): LBrokRate = Val(!brokrate & ""): LATranType = IIf(IsNull(!TRANTYPE), "T", !TRANTYPE): LTranRate = Val(!TRANRATE & ""):
                        LSTTRate = Val(!STTRATE & ""):       LSEBITax = Val(!SEBITAX & ""):
                        LBrokRate2 = Val(!BROKRATE2 & ""):   LBrokQty = IIf(IsNull(!BROKQTY), 0, !BROKQTY)
                        LBrokQty2 = IIf(IsNull(!BROKQTY2), 0, !BROKQTY2)
                        If !PATTAN <> "C" Then
                            MOpQty = MOpQty - !QTY: MTotOpAmt = MTotOpAmt - (!QTY * !Rate * LCalval)
                        Else
                            LSAmt = !QTY * !Rate * LCalval:                    MTotSQty = MTotSQty + !QTY:
                            MTotSAmt = MTotSAmt + LSAmt:                       MSrvTax = Val(!SRVTAX & ""):
                            LSBCTax = Val(!SBC_TAX & ""):                      LcTranAmt = 0
                        End If
                        If MFormat = "Billwise Account Statement" Then
                            AccRecSet.AddNew
                            AccRecSet.Fields("RPTGRP") = 1
                            AccRecSet.Fields("SHAREAMT") = 0
                            CountRec = CountRec + 1:                           AccRecSet.Fields("SRNO") = CountRec
                            AccRecSet.Fields("SAUDACODE") = LSaudaCode:        AccRecSet.Fields("EXCODE") = MExCode
                            AccRecSet.Fields("BILLNO") = LBillNo:              AccRecSet.Fields("BILLDATE") = LStDate
                            AccRecSet.Fields("ITEMCODE") = MItemCode:          AccRecSet.Fields("ITEMNAME") = vbNullString
                            AccRecSet.Fields("SQNTY") = !QTY:                  AccRecSet.Fields("SRATE") = !Rate:
                            AccRecSet.Fields("CTYPE") = !CONTYPE:              AccRecSet.Fields("REFLOT") = LRefLot
                            AccRecSet.Fields("PATTAN") = !PATTAN:              AccRecSet.Fields("DRAMOUNT") = 0
                            AccRecSet.Fields("CRAMOUNT") = !QTY * !Rate:       AccRecSet.Fields("CONTDATE1") = Format(!Condate, "yyyy/MM/dd")
                            AccRecSet.Fields("PrevBal") = MBal:                AccRecSet.Fields("DEBITAMT") = LDebitAmt
                            AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt):
                            AccRecSet.Fields("CALVAL") = LCalval:              AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):
                            AccRecSet.Fields("TRANTAX") = 0:
                            'AccRecSet.Fields("BrokType") = LBrokType
                            AccRecSet.Fields("SCONNO") = !ROWNO1:              AccRecSet.Fields("SEBITAX") = 0
                            AccRecSet.Fields("SEBITAXAMT") = 0:                AccRecSet.Fields("BQNTY") = 0:
                            AccRecSet.Fields("BROKERAGE") = 0:                 AccRecSet.Fields("STANDING") = 0
                            AccRecSet.Fields("TRFEES") = 0:                    AccRecSet.Fields("ServiceTax") = 0
                            AccRecSet.Fields("CONTDATE") = vbNullString:       AccRecSet.Fields("MarType") = vbNullString
                            AccRecSet.Fields("SBROKAMT") = LCBrokAmt:
                            AccRecSet.Fields("INVNO") = 0:
                            AccRecSet.Fields("BBROKAMT") = 0:                  AccRecSet.Fields("REFLOT") = LRefLot
                            AccRecSet.Fields("SCONTIME") = !contime
                            Call Add_PartyDetails
                            AccRecSet.Fields("WORDAMT") = LTitle
                            AccRecSet.Update
                        End If
                        .MoveNext
                    Loop
                End With
            End If
            ''END SOLD
            ''CLOSING CALC
            LCloseQty = PartyRec!CLQTY * -1
            LMarAmt = 0
            LCloseRate = PartyRec!ClRate
            If PartyRec!STDATE < Lmaturity Then
                If LCloseQty <> 0 Then
                    GMarRate = 0: LMarType = "V"
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset      ''BROKERAGE CALCULATION
                    mysql = "SELECT MARTYPE,MARRATE FROM PITBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND AC_CODE='" & PartyRec!AC_CODE & "' "
                    mysql = mysql & " AND ITEMCODE='" & MItemCode & "'AND INSTTYPE ='" & LInstType & "' ORDER BY UPTOSTDT ": TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If TRec.EOF Then
                        Set TRec = Nothing: Set TRec = New ADODB.Recordset      ''BROKERAGE CALCULATION
                        mysql = "SELECT MARTYPE,MARRATE FROM PEXBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND AC_CODE='" & PartyRec!AC_CODE & "'"
                        mysql = mysql & " AND EXCODE ='" & MExCode & "'AND INSTTYPE ='" & LInstType & "' ORDER BY UPTOSTDT ":
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            GMarRate = 0: LMarType = "": LMarRate = 0
                        Else
                            LMarType = IIf(IsNull(TRec!MARTYPE), "T", TRec!MARTYPE)
                            LMarRate = IIf(IsNull(TRec!MARRATE), 0, TRec!MARRATE)
                            GMarRate = LMarRate
                        End If
                    Else
                        TRec.MoveFirst
                        LMarType = IIf(IsNull(TRec!MARTYPE), "T", TRec!MARTYPE)
                        LMarRate = IIf(IsNull(TRec!MARRATE), 0, TRec!MARRATE)
                    End If
                    If Option1.Value = True Then LMarAmt = Calc_Margin(LMarType, LMarRate, LSaudaCode, vcDTP2.Value, Abs(LCloseQty), LCloseRate, PartyRec!AC_CODE, LCalval, LExCode)
                End If ' lcloseqty
            End If 'maturity
            If PartyRec!AC_CODE = LContractAcc Then LMarAmt = LMarAmt * -1
            If LInstType = "FUT" Then
                If LCloseQty <> 0 And LCloseRate = 0 Then If MsgBox("Closing Rate missing for Sauda " & LSaudaName & " of date " & CStr(vcDTP2.Value), vbOKCancel) = vbCancel Then Exit Sub
            ElseIf LInstType = "OPT" Then
                If OptMTMChk.Value = 1 Then
                    If vcDTP2.Value < Lmaturity Then
                        If LCloseQty <> 0 And LCloseRate = 0 Then If MsgBox("Closing rate missing for Sauda " & LSaudaName & " of date " & CStr(vcDTP2.Value), vbOKCancel) = vbCancel Then Exit Sub
                    End If
                Else
                    LCloseQty = 0
                End If
            ElseIf LInstType = "CSH" Then
                If CshMTMchk.Value = 1 Then
                    If LCloseQty <> 0 And LCloseRate = 0 Then If MsgBox("Closing rate missing for Sauda " & LSaudaName & " of date " & CStr(vcDTP2.Value), vbOKCancel) = vbCancel Then Exit Sub
                Else
                    LCloseQty = 0
                End If
            End If
            MCLPattan = "B"
            If PartyRec!STDATE >= Lmaturity And LCloseQty <> 0 Then
                LBrokRate = 0: LBrokType = "P": LATranType = "P": LTranRate = 0
                MSrvTax = 0
                MCLPattan = "A"
                LCBrokAmt = 0
                If LCloseRate <> 0 Then
                    LBrokQty = Abs(LCloseQty)
                    If LBrokType = "Z" Or LBrokType = "R" Then LBrokQty = LBrokLot
                End If
                LBrokAmount = LBrokAmount + LCBrokAmt
                LSTTRate = 0
                LcTranAmt = 0
            End If
            GSTDChrs = 0: GTrFees = 0: LSTTRate = 0: LSTTAmt = 0
            GTrFees = Round(PartyRec!TranAmt)
            BROKAMT = PartyRec!BROKAMT
            LTotSEBITaxAmt = Format(Round(PartyRec!SEBITaxAmt), "0.00")
            LRiskMAmt = PartyRec!RISKMAMT
            GSrvTax = PartyRec!SRVAMT
            LSBCTaxAmt = PartyRec!SBC_TAX_AMt
            LTotStmAmt = PartyRec!STampamt
            LTotCGSTAmt = PartyRec!cgstamt
            LTotSGSTAmt = PartyRec!SGSTAMT
            LTotIGSTAmt = PartyRec!IGSTAMT
            LTotUTTAmt = PartyRec!UTTAMT
            LTotSTTAmt = PartyRec!STTTax
            GSTDChrs = Format(PartyRec!STDAMT)
            If LCloseQty <> 0 Then
                If (LInstType = "OPT" And OptMTMChk.Value = 0) Or (LInstType = "CSH" And CshMTMchk.Value = 0) Then
                    AccRecSet.Filter = 0
                    AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                    AccRecSet.Sort = "SRNO DESC"
                    If Not AccRecSet.EOF Then
                        AccRecSet.Fields("RPATTAN") = "C":                     AccRecSet.Fields("BROKERAGE") = BROKAMT
                        AccRecSet.Fields("STANDING") = GSTDChrs:               AccRecSet.Fields("TRFEES") = GTrFees
                        AccRecSet.Fields("TurnOverTax") = LTotStmAmt:          AccRecSet.Fields("STTTax") = LTotSTTAmt
                        AccRecSet.Fields("TRANTAX") = LRiskMAmt:               AccRecSet.Fields("SEBITAXAMT") = LTotSEBITaxAmt
                        AccRecSet.Fields("CGSTAMT") = LTotCGSTAmt:             AccRecSet.Fields("SGSTAMT") = LTotSGSTAmt
                        AccRecSet.Fields("IGSTAMT") = LTotIGSTAmt:             AccRecSet.Fields("UTTAMT") = LTotUTTAmt
                        AccRecSet.Fields("ServiceTax") = GSrvTax:              AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt
                        AccRecSet.Fields("PrevBal") = MBal:                    AccRecSet.Fields("DEBITAMT") = LDebitAmt
                        AccRecSet.Fields("CREDITAMT") = LCreditAmt:            AccRecSet.Fields("SHAREAMT") = LShareAmt
                        AccRecSet.Update
                    End If
                Else
                    If LCloseQty > 0 Then
                        AccRecSet.AddNew
                        AccRecSet.Fields("RPTGRP") = 1:                        AccRecSet.Fields("SHAREAMT") = LShareAmt
                        CountRec = CountRec + 1:                               AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("EXCODE") = MExCode:                  AccRecSet.Fields("ITEMCODE") = MItemCode
                        AccRecSet.Fields("REFLOT") = LRefLot:                  AccRecSet.Fields("CGSTAMT") = LTotCGSTAmt:
                        AccRecSet.Fields("SGSTAMT") = LTotSGSTAmt:             AccRecSet.Fields("IGSTAMT") = LTotIGSTAmt:
                        AccRecSet.Fields("UTTAMT") = LTotUTTAmt:               AccRecSet.Fields("SAUDACODE") = LSaudaCode
                        AccRecSet.Fields("CONTDATE") = Format(PartyRec!STDATE, "yyyy/MM/dd")
                        AccRecSet.Fields("ITEMNAME") = vbNullString:
                        Call Add_PartyDetails
                        AccRecSet.Fields("ServiceTax") = GSrvTax:               AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                        AccRecSet.Fields("SQNTY") = Abs(Val(LCloseQty)):        AccRecSet.Fields("SRATE") = LCloseRate
                        AccRecSet.Fields("CTYPE") = "S":                        AccRecSet.Fields("PATTAN") = MCLPattan
                        AccRecSet.Fields("DRAMOUNT") = 0:                       AccRecSet.Fields("CRAMOUNT") = Abs(Val(LCloseQty)) * LCloseRate
                        AccRecSet.Fields("BROKERAGE") = BROKAMT:                AccRecSet.Fields("STANDING") = GSTDChrs
                        AccRecSet.Fields("TurnOverTax") = LTotStmAmt:           AccRecSet.Fields("STTTax") = LTotSTTAmt
                        AccRecSet.Fields("SEBITAXAMT") = LTotSEBITaxAmt:        AccRecSet.Fields("TRANTAX") = LRiskMAmt
                        AccRecSet.Fields("TRFEES") = GTrFees:                   AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):
                        AccRecSet.Fields("CALVAL") = LCalval:                   AccRecSet.Fields("PrevBal") = MBal
                        AccRecSet.Fields("DEBITAMT") = LDebitAmt:               AccRecSet.Fields("CREDITAMT") = LCreditAmt
                        AccRecSet.Fields("CONTDATE1") = vbNullString:           AccRecSet.Fields("CITY") = vbNullString
                        AccRecSet.Fields("BRATE") = 0:                          AccRecSet.Fields("INVNO") = 0
                        AccRecSet.Fields("BQNTY") = 0:                          AccRecSet.Fields("ADDRESS") = vbNullString
                        AccRecSet.Fields("RPATTAN") = vbNullString
                        AccRecSet.Fields("CONNO") = vbNullString:               AccRecSet.Fields("CONTIME") = vbNullString
                        AccRecSet.Fields("MarRate") = GMarRate:                 AccRecSet.Fields("MarAmt") = LMarAmt
                        AccRecSet.Fields("MarType") = LMarType:
                        AccRecSet.Fields("BBROKAMT") = LCBrokAmt
                        AccRecSet.Fields("SBROKAMT") = 0:                       AccRecSet.Fields("BILLNO") = LBillNo
                        AccRecSet.Fields("BILLDATE") = LStDate:                 AccRecSet.Fields("WORDAMT") = LTitle
                        AccRecSet.Update
                    Else
                        AccRecSet.AddNew
                        AccRecSet.Fields("RPTGRP") = 1:                        AccRecSet.Fields("SHAREAMT") = Val(LShareAmt)
                        CountRec = CountRec + 1:                               AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode::           AccRecSet.Fields("EXCODE") = MExCode
                        AccRecSet.Fields("REFLOT") = LRefLot:                  AccRecSet.Fields("ITEMCODE") = MItemCode:
                        AccRecSet.Fields("ITEMNAME") = vbNullString:               Call Add_PartyDetails
                        AccRecSet.Fields("BQNTY") = Abs(Val(LCloseQty)):       AccRecSet.Fields("BRATE") = LCloseRate:
                        AccRecSet.Fields("CTYPE") = "B":                       AccRecSet.Fields("PATTAN") = MCLPattan
                        AccRecSet.Fields("BROKERAGE") = BROKAMT:               AccRecSet.Fields("STANDING") = GSTDChrs
                        AccRecSet.Fields("TRFEES") = GTrFees:                  AccRecSet.Fields("TurnOverTax") = LTotStmAmt
                        AccRecSet.Fields("STTTAX") = LTotSTTAmt:               AccRecSet.Fields("SEBITAXAMT") = LTotSEBITaxAmt:
                        AccRecSet.Fields("TRANTAX") = LRiskMAmt:               AccRecSet.Fields("CGSTAMT") = LTotCGSTAmt:
                        AccRecSet.Fields("SGSTAMT") = LTotSGSTAmt:             AccRecSet.Fields("IGSTAMT") = Val(LTotIGSTAmt):
                        AccRecSet.Fields("UTTAMT") = LTotUTTAmt:               AccRecSet.Fields("BILLDATE") = LStDate
                        AccRecSet.Fields("ServiceTax") = GSrvTax:              AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                        AccRecSet.Fields("PrevBal") = MBal:                    AccRecSet.Fields("DEBITAMT") = LDebitAmt
                        AccRecSet.Fields("CREDITAMT") = LCreditAmt:            AccRecSet.Fields("BrokRate") = LBrokRate
                        AccRecSet.Fields("BrokType") = LBrokType:              AccRecSet.Fields("CONTIME") = vbNullString
                        AccRecSet.Fields("CONNO") = vbNullString:              AccRecSet.Fields("SQNTY") = 0
                        AccRecSet.Fields("SRATE") = 0:                         AccRecSet.Fields("CONTDATE") = vbNullString
                        AccRecSet.Fields("MarRate") = GMarRate:                AccRecSet.Fields("MarAmt") = LMarAmt
                        AccRecSet.Fields("MarType") = LMarType:
                        AccRecSet.Fields("rpattan") = vbNullString:            AccRecSet.Fields("ADDRESS") = vbNullString
                        AccRecSet.Fields("CITY") = vbNullString:
                        AccRecSet.Fields("INVNO") = 0
                        AccRecSet.Fields("BBROKAMT") = 0:                      AccRecSet.Fields("SBROKAMT") = LCBrokAmt
                        AccRecSet.Fields("WORDAMT") = LTitle:                  AccRecSet.Fields("BILLNO") = LBillNo
                        AccRecSet.Fields("DRAMOUNT") = Abs(LCloseQty) * LCloseRate
                        AccRecSet.Fields("CONTDATE1") = Format(vcDTP2.Value, "yyyy/MM/dd"):   AccRecSet.Fields("CALVAL") = LCalval
                        AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):
                        AccRecSet.Update
                    End If
                    If Check5.Value = 1 Then
                        AccRecSet.AddNew
                        AccRecSet.Fields("SHAREAMT") = 0
                        AccRecSet.Fields("RPTGRP") = 2
                        CountRec = CountRec + 1
                        AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("CONTDATE") = Format(vcDTP2.Value, "yyyy/MM/dd"):          AccRecSet.Fields("SAUDACODE") = LSaudaCode
                        AccRecSet.Fields("EXCODE") = MExCode:                                       AccRecSet.Fields("ITEMCODE") = MItemCode
                        AccRecSet.Fields("ITEMNAME") = vbNullString:
                        AccRecSet.Fields("REFLOT") = LRefLot
                        Call Add_PartyDetails
                        If LCloseQty > 0 Then
                            AccRecSet.Fields("BQNTY") = Abs(Val(LCloseQty)):
                            AccRecSet.Fields("SQNTY") = 0:
                        Else
                            AccRecSet.Fields("BQNTY") = 0:
                            AccRecSet.Fields("SQNTY") = Abs(Val(LCloseQty)):
                        End If

                        AccRecSet.Fields("SRATE") = LCloseRate:                       AccRecSet.Fields("CTYPE") = "S"
                        AccRecSet.Fields("PATTAN") = MCLPattan:                       AccRecSet.Fields("DRAMOUNT") = 0
                        AccRecSet.Fields("CRAMOUNT") = 0:                             AccRecSet.Fields("BROKERAGE") = 0
                        AccRecSet.Fields("STANDING") = 0:                             AccRecSet.Fields("TurnOverTax") = 0
                        AccRecSet.Fields("STTTax") = 0:                               AccRecSet.Fields("SEBITAXAMT") = 0:
                        AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:                   AccRecSet.Fields("TRANTAX") = 0
                        AccRecSet.Fields("CGSTAMT") = Val(LTotCGSTAmt):               AccRecSet.Fields("SGSTAMT") = Val(LTotSGSTAmt):
                        AccRecSet.Fields("IGSTAMT") = Val(LTotIGSTAmt):               AccRecSet.Fields("UTTAMT") = Val(LTotUTTAmt):
                        AccRecSet.Fields("TRFEES") = 0:                               AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):
                        AccRecSet.Fields("CALVAL") = LCalval:                         AccRecSet.Fields("PrevBal") = 0
                        AccRecSet.Fields("DEBITAMT") = 0:                             AccRecSet.Fields("CREDITAMT") = 0
                        AccRecSet.Fields("CONTDATE1") = vbNullString:                 AccRecSet.Fields("CITY") = vbNullString
                        AccRecSet.Fields("BRATE") = 0:                                AccRecSet.Fields("INVNO") = 0
                        AccRecSet.Fields("COMPCODE") = 0:                             AccRecSet.Fields("RPATTAN") = vbNullString
                        AccRecSet.Fields("BrokRate") = 0:                             AccRecSet.Fields("BrokType") = vbNullString
                        AccRecSet.Fields("CONNO") = "":                               AccRecSet.Fields("CONTIME") = vbNullString
                        AccRecSet.Fields("MarRate") = 0:                              AccRecSet.Fields("MarAmt") = 0
                        AccRecSet.Fields("MarType") = LMarType:                       AccRecSet.Fields("TranRate") = 0
                        AccRecSet.Fields("TranType") = LBrokType:                     AccRecSet.Fields("BILLNO") = LBillNo
                        AccRecSet.Fields("BILLDATE") = LStDate:                       AccRecSet.Fields("WORDAMT") = LTitle
                        AccRecSet.Update
                    End If
                End If
            Else
                TotAmt = Abs(MTotBAmt) + Abs(MTotSAmt) + Abs(MTotOpAmt)
                If (MFormat = "Bill Summary" Or MFormat = "Bill Summary With Sharing" Or MFormat = "Account Statement Summary") And TotAmt <> 0 Then
                    AccRecSet.AddNew
                    AccRecSet.Fields("RPTGRP") = 1
                    AccRecSet.Fields("SHAREAMT") = Val(LShareAmt)
                    CountRec = CountRec + 1
                    AccRecSet.Fields("SRNO") = CountRec
                    AccRecSet.Fields("SAUDACODE") = LSaudaCode:       AccRecSet.Fields("EXCODE") = MExCode
                    AccRecSet.Fields("REFLOT") = LRefLot
                    AccRecSet.Fields("ITEMCODE") = MItemCode:         AccRecSet.Fields("ITEMNAME") = vbNullString
                    Call Add_PartyDetails:                            AccRecSet.Fields("DRAMOUNT") = Abs(MTotBAmt):     AccRecSet.Fields("CRAMOUNT") = Abs(MTotSAmt)
                    AccRecSet.Fields("CTYPE") = "B":                  AccRecSet.Fields("PATTAN") = MCLPattan
                    AccRecSet.Fields("BROKERAGE") = Val(BROKAMT & "")
                    AccRecSet.Fields("STANDING") = Val(GSTDChrs & "")
                    AccRecSet.Fields("TRFEES") = Val(GTrFees & ""):
                    If LStmFlag = False Then
                        AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt & "") + Val(LNStmAmt)
                        LStmFlag = True
                    Else
                        AccRecSet.Fields("TurnOverTax") = LTotStmAmt
                    End If
                    AccRecSet.Fields("STTTAX") = LTotSTTAmt:                              AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt)
                    AccRecSet.Fields("SEBITAXAMT") = Val(LTotSEBITaxAmt):
                    AccRecSet.Fields("CONTDATE1") = Format(vcDTP2.Value, "yyyy/MM/dd"):   AccRecSet.Fields("CALVAL") = LCalval
                    AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd"):        AccRecSet.Fields("ServiceTax") = GSrvTax:
                    AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:                           AccRecSet.Fields("PrevBal") = MBal
                    AccRecSet.Fields("CGSTAMT") = Val(LTotCGSTAmt):                       AccRecSet.Fields("SGSTAMT") = Val(LTotSGSTAmt):
                    AccRecSet.Fields("IGSTAMT") = Val(LTotIGSTAmt):                       AccRecSet.Fields("UTTAMT") = Val(LTotUTTAmt):
                    AccRecSet.Fields("DEBITAMT") = LDebitAmt:                             AccRecSet.Fields("CREDITAMT") = LCreditAmt
                    AccRecSet.Fields("BrokRate") = LBrokRate:                             AccRecSet.Fields("BrokType") = LBrokType
                    AccRecSet.Fields("CONTIME") = vbNullString:                           AccRecSet.Fields("CONNO") = vbNullString
                    AccRecSet.Fields("SQNTY") = 0:                                        AccRecSet.Fields("SRATE") = 0
                    AccRecSet.Fields("CONTDATE") = vbNullString:                          AccRecSet.Fields("MarRate") = GMarRate
                    AccRecSet.Fields("MarAmt") = LMarAmt:                                 AccRecSet.Fields("MarType") = LMarType
                    AccRecSet.Fields("COMPCODE") = 0:                                     AccRecSet.Fields("rpattan") = vbNullString
                    AccRecSet.Fields("ADDRESS") = vbNullString:                           AccRecSet.Fields("CITY") = vbNullString
                    AccRecSet.Fields("TranRate") = 0:                                     AccRecSet.Fields("TranType") = vbNullString
                    AccRecSet.Fields("INVNO") = 0:                                        AccRecSet.Fields("WORDAMT") = LTitle
                    AccRecSet.Update
                Else
                    AccRecSet.Filter = 0
                    AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                    AccRecSet.Sort = "SRNO DESC"
                    If Not AccRecSet.EOF Then
                        AccRecSet.Fields("BROKERAGE") = Val(BROKAMT):
                        AccRecSet.Fields("STANDING") = Val(GSTDChrs):                           AccRecSet.Fields("TRFEES") = Val(GTrFees)
                        If LStmFlag = False Then
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt) + Val(LNStmAmt):
                            LStmFlag = True
                        Else
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt)
                        End If
                        AccRecSet.Fields("SEBITAXAMT") = Val(LTotSEBITaxAmt):                   AccRecSet.Fields("STTTax") = Val(LTotSTTAmt)
                        AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt):                           AccRecSet.Fields("rpattan") = "C"
                        AccRecSet.Fields("ServiceTax") = GSrvTax:                               AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                        AccRecSet.Fields("CGSTAMT") = Val(LTotCGSTAmt):                         AccRecSet.Fields("SGSTAMT") = Val(LTotSGSTAmt):
                        AccRecSet.Fields("IGSTAMT") = Val(LTotIGSTAmt):                         AccRecSet.Fields("UTTAMT") = Val(LTotUTTAmt):
                        AccRecSet.Fields("PrevBal") = MBal:                                     AccRecSet.Fields("DEBITAMT") = LDebitAmt
                        AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt):                        AccRecSet.Fields("SHAREAMT") = Val(LShareAmt)
                        AccRecSet.Fields("WORDAMT") = LTitle:                                   AccRecSet.Update
                    End If
                End If
            End If
            ''END CLOSING

           
            '''
            PartyRec.MoveNext
            If PartyRec.EOF Then GoTo flag_party

        Loop
flag_party:
        If CreateChk.Value = 1 Then
            If PartyRec.EOF Then
                Call Client_Margin
                Call CreateReport(LPartyName)
            Else
                If LPartyCode <> PartyRec!AC_CODE Then
                    Call Client_Margin
                    Call CreateReport(LPartyName)
                    Call AccRecNew
                End If
            End If
        End If
    Loop
    Call Client_Margin
End Sub

Private Sub Trade_Delete()
  Dim LMsg As String
    Call DataBackUp
    DoEvents: Cnn.BeginTrans
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    LMsg = " Are you sure to Delete All Trades From " & vcDTP1.Value & " To " & vcDTP2.Value & " of "
    If LenB(LSExCodes) <> 0 Then
        LMsg = LMsg & LSExCodes & " Exchanges and "
    Else
        LMsg = LMsg & " All Exchanges "
    End If
    If LenB(LSSaudas) <> 0 Then
        LMsg = LMsg & LSSaudas & " Contracts and "
    Else
        LMsg = LMsg & " All Contracts  "
    End If
    
    If LSParties <> "" Then
        LMsg = LMsg & LSParties & " Parties "
    Else
        LMsg = LMsg & " All Parties  "
    End If
    LMsg = LMsg & " Cofirm Delete?"
    
    If MsgBox(LMsg, vbQuestion + vbYesNo + vbDefaultButton2, "Confirm") = vbYes Then
        If LSParties <> "" Then
            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
            mysql = mysql & " AND CONDATE >='" & Format(vcDTP1.Value, "yyyy/mm/dd") & "' AND CONDATE <='" & Format(vcDTP2.Value, "yyyy/mm/dd") & "'"
            mysql = mysql & " AND STR(CONSNO)+ STR(CONNO) IN (SELECT STR(CONSNO)+STR(CONNO) FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND PARTY IN (" & LSParties & ") "
            If LenB(LSSaudas) <> 0 Then mysql = mysql & " AND SAUDAID IN (" & LSSaudas & ")"
            If LenB(LSExCodes) <> 0 Then mysql = mysql & " AND EXID  IN (" & LSExCodes & ")"
            mysql = mysql & " ) "
            If LenB(LSSaudas) <> 0 Then mysql = mysql & " AND SAUDAID IN (" & LSSaudas & ")"
            If LenB(LSExCodes) <> 0 Then mysql = mysql & " AND EXID  IN (" & LSExCodes & ")"
            Cnn.Execute mysql
        Else
            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
            mysql = mysql & " AND CONDATE >='" & Format(vcDTP1.Value) & "' AND CONDATE <='" & Format(vcDTP2.Value) & "'"
            If LenB(LSSaudas) <> 0 Then mysql = mysql & " AND SAUDAID IN (" & LSSaudas & ")"
            If LenB(LSExCodes) <> 0 Then mysql = mysql & " AND EXID  IN (" & LSExCodes & ")"
            Cnn.Execute mysql
        End If
    End If
    Call Update_Charges(vbNullString, vbNullString, vbNullString, vbNullString, vcDTP1.Value, vcDTP2.Value, True)
    
    If BILL_GENERATION(vcDTP1.Value, GFinEnd, vbNullString, vbNullString, vbNullString) Then
        Cnn.CommitTrans
        CNNERR = False
    Else
        Cnn.RollbackTrans
        CNNERR = False
    End If
    'Chk_Billing
End Sub
Private Sub Contract_Note()
    Dim LRiskMType As String:    Dim LAC_CODE As String:       Dim LExCode As String:    Dim LSaudaCode As String
    Dim LRiskMApp As String:     Dim MMemberID As String:      Dim LFMCCode As String:   Dim LMBrokType As String * 1
    Dim LPStmType As String:     Dim LBrokType As String * 1:  Dim GPhone As String:     Dim LSrvTax As Double:
    Dim LTD1 As Date:            Dim LCondate As Date:         Dim Lmaturity As Date:    Dim LRiskMDate As Date:
    Dim A As Integer:            Dim SrNo As Long:             Dim GBrokLot As Double:   Dim LSBCTaxRate As Double:
    Dim LBrokAmt As Double:      Dim LDiffAmt As Double:       Dim LSBrokRate As Double: Dim LSBrokRate2 As Double
    Dim LBrokQty As Double::     Dim LBrokQty2 As Double:      Dim LTranAmt As Double:   Dim LStmRate As Double
    Dim LTotStmAmt  As Double:   Dim LStmAmt As Double:        Dim LRiskMAmt As Double:  Dim LTradeableLot As Double:
    Dim LCalval As Double:
    Dim LExID As Integer
    Dim TRec As ADODB.Recordset: Dim TRec2 As ADODB.Recordset
    LExID = 0
    On Error GoTo err1

    LTD1 = DateValue("01/07/2013")
    SrNo = 0
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    'LSExCodes = Get_ExCodes
    LSParties = Get_Parties
    Dim I As Integer
    For I = 1 To ExList.ListItems.Count
        If ExList.ListItems(I).Checked = True Then
            LExID = Val(ExList.ListItems(I).ListSubItems(2))
        End If
    Next
    
    If LExID = 0 Then
        MsgBox "Retry"
        Me.MousePointer = 0
        Frame2.Enabled = True
        ExCmd.SetFocus
        OkCmd.Enabled = True
        Exit Sub
    End If
    
    Call CreateRec_Cont
    mysql = " SELECT CD.NOTENO,CD.ORDNO, CD.CONNO,CD.CONTIME,CD.CONDATE,CD.SAUDA,SU.SAUDANAME,SU.MATURITY,SU.TRADEABLELOT,SU.BROKLOT,I.ITEMCODE,I.ITEMNAME,I.LOT,I.EXCHANGECODE,I.QTYUNIT,I.PRICEUNIT,"
    mysql = mysql & "  CD.QTY,CD.RATE,CD.CONTYPE,CD.BROKRATE,CD.TRANRATE,CD.BROKTYPE,CM.PATTAN,CD.BROKQTY,CD.SRVTAX,CD.ROWNO1,CD.STMRATE,CD.STTRATE, "
    mysql = mysql & " AC.AC_CODE,AC.NAME,AC.ADD1,AC.CITY,AC.PHONEO,AC.PANNO ,AC.MOBILE,AC.FAX,AC.PIN,AC.PHONER, AX.ACEXCODE ,AC.APPLYON,E.LOTWISE,CD.SBC_TAX,CD.SEBITAX,CD.BROKRATE2,AC.RISKMTYPE,I.RISKMAPP"
    mysql = mysql & " FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC, ACCT_EX AS AX,EXMAST AS E "
    mysql = mysql & " WHERE AC.COMPCODE =" & GCompCode & " AND CM.COMPCODE =CD.COMPCODE  AND CM.CONSNO = CD.CONSNO "
    mysql = mysql & " AND CD.SAUDAID=SU.SAUDAID AND CD.ITEMID=I.ITEMID AND CD.ACCID =AC.ACCID AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    mysql = mysql & " AND E.EXID =I.EXID  and NOTENO <>0 "
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND AC.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
    End If
    
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  AC.AC_CODE IN (" & LSParties & ") "
    mysql = mysql & " AND AX.ACCID =AC.ACCID AND AX.EXID =" & LExID & ""
    mysql = mysql & " AND I.EXID  =" & LExID & ""
    mysql = mysql & " ORDER BY CD.CONDATE,AC.NAME,"
    mysql = mysql & " AC.AC_CODE,SU.SAUDANAME"
    Set TRec = Nothing: Set TRec = New ADODB.Recordset:
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    With TRec
        Do While Not TRec.EOF
            LDiffAmt = 0
            RecRpt.AddNew:                   SrNo = SrNo + 1:             LPStmType = !APPLYON
            LAC_CODE = !AC_CODE:             LRiskMType = !RISKMTYPE:     RecRpt!PARTYCODE = !AC_CODE
            RecRpt!PARTYNAME = !NAME:        RecRpt!PRTYADD = !ADD1:      RecRpt!PrtyCity = !City:
            RecRpt!PRTYPHN = !PhoneO:        RecRpt!PhoneR = !PhoneR:     RecRpt!Mobile = !Mobile
            RecRpt!Fax = !Fax:               RecRpt!Pin = !Pin:           RecRpt!PANNO = !PANNO:
            LRiskMApp = !RISKMAPP:           LSaudaCode = !Sauda:         Lmaturity = !MATURITY
            LCondate = !Condate:             LCalval = !lot:              LTradeableLot = !TRADEABLELOT
            GBrokLot = !BROKLOT:             RecRpt!CONTDATE = !Condate:  RecRpt!saudacode = !Sauda
            RecRpt!SAUDANAME = !SAUDANAME:   RecRpt!ITEMCODE = !ITEMCODE: RecRpt!ITEMName = !ITEMName:
            RecRpt!ctype = !CONTYPE:         RecRpt!PATTAN = !PATTAN:     RecRpt!BORDNO = !ORDNO & vbNullString
            RecRpt!SORDNO = !ACEXCODE & vbNullString:                     RecRpt!BCONNO = !ROWNO1 & vbNullString
            RecRpt!BCONTIME = !contime & vbNullString:                    RecRpt!CNOTENO = IIf(IsNull(!NOTENO), 0, !NOTENO)
            RecRpt!STMTYPE = LPStmType
            If !CONTYPE = "B" Then
                RecRpt!BQnty = !QTY:                RecRpt!BRate = !Rate
                RecRpt!bbrokrate = !brokrate:       RecRpt!bbroktype = !broktype:
                RecRpt!SQnty = 0:                   RecRpt!SRate = 0
                RecRpt!SBROKTYPE = "P":             RecRpt!SBROKRATE = 0
                RecRpt!STRANRATE = 0:               RecRpt!SREGLOT = 0
                RecRpt!SBROKQTY = 0:                RecRpt!SSRVTAX = 0
                RecRpt!SCTTRATE = 0:                RecRpt!SSBCTAX = 0
                RecRpt!SSEBITAX = 0:                RecRpt!SBROKRATE2 = 0
                RecRpt!BBROKRATE2 = !BROKRATE2:     RecRpt!BBROKQTY = IIf(IsNull(!BROKQTY), 0, !BROKQTY)
                RecRpt!BREGLOT = !STMRATE:
            Else
                RecRpt!BQnty = 0:                   RecRpt!BRate = 0
                RecRpt!bbrokrate = 0:               RecRpt!BTRANRATE = 0
                RecRpt!bbroktype = "P":             RecRpt!BBROKQTY = 0
                RecRpt!BREGLOT = 0:                 RecRpt!BSRVTAX = 0
                RecRpt!BCTTRATE = 0:                RecRpt!BSBCTAX = 0
                RecRpt!BSEBITAX = 0:                RecRpt!BBROKRATE2 = 0
                RecRpt!SQnty = !QTY:                RecRpt!SRate = !Rate
                RecRpt!SBROKTYPE = !broktype:       RecRpt!SBROKRATE = !brokrate
                RecRpt!STRANRATE = !TRANRATE:       RecRpt!SREGLOT = !STMRATE
                RecRpt!SSRVTAX = !SRVTAX:           RecRpt!SCTTRATE = !STTRATE
                RecRpt!SSBCTAX = !SBC_TAX:          RecRpt!SSEBITAX = !SEBITAX
                RecRpt!SBROKRATE2 = !BROKRATE2:     RecRpt!SBROKQTY = IIf(IsNull(!BROKQTY), 0, !BROKQTY)
            End If
            LExCode = (!EXCHANGECODE & vbNullString)
            RecRpt!SrNo = SrNo
            
            RecRpt!CALVAL = !lot
            RecRpt!exchange = (!EXCHANGECODE & vbNullString)
            RecRpt!PRICEUNIT = !PRICEUNIT & vbNullString
            RecRpt!QTYUNIT = !QTYUNIT & vbNullString
            RecRpt!RISKMAMT = 0
            LSBrokRate = 0: LSBrokRate2 = 0
            If LBrokType = "Z" Then LBrokQty = GBrokLot
            If LBrokType = "R" Then LBrokQty2 = GBrokLot
            LBrokAmt = Calc_Brokerage(!broktype, !brokrate, !BROKRATE2, !BROKQTY, !QTY, !Rate, !lot, "FUT", 0, 0, LTradeableLot, "B", "2", TRec!itemid)
            LTranAmt = (!TRANRATE / 100) * !QTY * !Rate * !lot
            RecRpt!BTRANRATE = !TRANRATE
            RecRpt!BSRVTAX = 0
            LStmAmt = ((LStmRate / 100) * !QTY * !Rate * LCalval):
            LTotStmAmt = LTotStmAmt + LStmAmt
            LSrvTax = !SRVTAX:                  RecRpt!BCTTRATE = 0
            RecRpt!BROKAMT = 0:                 RecRpt!SRVAMT = 0
            RecRpt!TranAmt = 0:                 RecRpt!BSEBITAX = 0
            RecRpt!BSBCTAX = 0:                 LSBCTaxRate = !SBC_TAX
            RecRpt!RISKMAMT = 0:                RecRpt!STampamt = 0
            RecRpt!LDiffAmt = 0:
            .MoveNext
            LRiskMAmt = 0
            If .EOF Then
                LTotStmAmt = 0:
                mysql = "SELECT DIFFAMT,BROKAMT,TRANAMT,SRVAMT,STTTAX,SEBITAXAMT,SBC_TAX_AMT,RISKMAMT,STAMPAMT  FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LAC_CODE & "' "
                mysql = mysql & " AND SAUDA='" & LSaudaCode & "' AND STDATE ='" & Format(LCondate, "YYYY/MM/DD") & "'"
                Set TRec2 = Nothing
                Set TRec2 = New ADODB.Recordset
                TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec2.EOF Then
                    LDiffAmt = TRec2!DIFFAMT:              RecRpt!LDiffAmt = LDiffAmt
                    RecRpt!BROKAMT = TRec2!BROKAMT:        RecRpt!SRVAMT = TRec2!SRVAMT
                    RecRpt!TranAmt = TRec2!TranAmt:        RecRpt!BCTTRATE = TRec2!STTTax
                    RecRpt!BSEBITAX = TRec2!SEBITaxAmt:    RecRpt!BSBCTAX = TRec2!SBC_TAX_AMt
                    RecRpt!RISKMAMT = TRec2!RISKMAMT:      RecRpt!STampamt = TRec2!STampamt
                End If
                Set TRec2 = Nothing
            Else
                If LAC_CODE <> !AC_CODE Then
                    mysql = "SELECT DIFFAMT,BROKAMT,TRANAMT,SRVAMT,STTTAX,SEBITAXAMT,SBC_TAX_AMT,RISKMAMT, STAMPAMT  FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LAC_CODE & "' "
                    mysql = mysql & " AND SAUDA='" & LSaudaCode & "' AND STDATE ='" & Format(LCondate, "YYYY/MM/DD") & "'"
                    Set TRec2 = Nothing
                    Set TRec2 = New ADODB.Recordset
                    TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec2.EOF Then
                        LDiffAmt = TRec2!DIFFAMT
                        RecRpt!LDiffAmt = LDiffAmt:                 RecRpt!BROKAMT = TRec2!BROKAMT
                        RecRpt!SRVAMT = TRec2!SRVAMT:               RecRpt!TranAmt = TRec2!TranAmt
                        RecRpt!BCTTRATE = TRec2!STTTax:             RecRpt!BSEBITAX = TRec2!SEBITaxAmt
                        RecRpt!BSBCTAX = TRec2!SBC_TAX_AMt:         RecRpt!BROKAMT = TRec2!BROKAMT
                        RecRpt!RISKMAMT = TRec2!RISKMAMT:           RecRpt!STampamt = TRec2!STampamt
                        LTotStmAmt = 0:
                    End If
                    Set TRec2 = Nothing
                Else
                    If LSaudaCode <> !Sauda Then
                        mysql = "SELECT DIFFAMT,BROKAMT,TRANAMT,SRVAMT,STTTAX,SEBITAXAMT,SBC_TAX_AMT,RISKMAMT,STAMPAMT  FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LAC_CODE & "' "
                        mysql = mysql & " AND SAUDA='" & LSaudaCode & "' AND STDATE ='" & Format(LCondate, "YYYY/MM/DD") & "'"
                        Set TRec2 = Nothing
                        Set TRec2 = New ADODB.Recordset
                        TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec2.EOF Then
                            LDiffAmt = TRec2!DIFFAMT
                            RecRpt!LDiffAmt = LDiffAmt:             RecRpt!BROKAMT = TRec2!BROKAMT
                            RecRpt!SRVAMT = TRec2!SRVAMT:           RecRpt!TranAmt = TRec2!TranAmt
                            RecRpt!BCTTRATE = TRec2!STTTax:         RecRpt!BSEBITAX = TRec2!SEBITaxAmt
                            RecRpt!BSBCTAX = TRec2!SBC_TAX_AMt:     RecRpt!BROKAMT = TRec2!BROKAMT
                            RecRpt!RISKMAMT = TRec2!RISKMAMT:       RecRpt!STampamt = TRec2!STampamt
                        End If
                        Set TRec2 = Nothing
                    End If
                End If
            End If
            RecRpt.Update
        Loop
    End With
    Set TRec = Nothing
    mysql = "SELECT MEMBERID,FMCCODE FROM EXMAST WHERE COMPCODE  = " & GCompCode & " AND EXID =" & LExID & ""
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        MMemberID = IIf(IsNull(TRec!MemberId), "", TRec!MemberId)
        LFMCCode = IIf(IsNull(TRec!FMCCODE), "", TRec!FMCCODE)
    End If
    Set TRec = Nothing
    If RecRpt.RecordCount > 0 Then
    RecRpt.Sort = "PARTYNAME,SAUDANAME,CONTDATE"
    If LExCode = "NCDX" Then
        If Option1.Value = True Then
            If vcDTP2.Value < LTD1 Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTENCDEX01072013.RPT", 1)
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTENCDEX.RPT", 1)
            End If
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTENCDEXPRE.RPT", 1)
        End If
    ElseIf LExCode = "UCX" Then
        If Combo2.ListIndex = 0 Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTEUCX.RPT", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTEUCX.RPT", 1)
        End If
    ElseIf LExCode = "MCX" Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTEMCX.RPT", 1)
    ElseIf LExCode = "NMCE" Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTENMCE.RPT", 1)
    ElseIf LExCode = "EQ" Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTEEQ.RPT", 1)
    ElseIf LExCode = "ACE" Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTEACE.RPT", 1)
    Else
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTENBOT.RPT", 1)
    End If
    GPhone = "Ph: " & GCompPhoneO & ", " & GCompPhoneR & "," & GCompMobile & ""
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
    RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
    RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
    RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
    RDCREPO.FormulaFields.GetItemByName("OPHONE1").text = "'" & GPhone & "'"
    RDCREPO.FormulaFields.GetItemByName("SRVNO").text = "'" & GSrvRegNo & "'"
    RDCREPO.FormulaFields.GetItemByName("MMEMID").text = "'" & MMemberID & "'"
    RDCREPO.FormulaFields.GetItemByName("FMCCODE").text = "'" & LFMCCode & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & GPANNo & "'"
    RDCREPO.FormulaFields.GetItemByName("CINNO").text = "'" & GCINNo & "'"
    RDCREPO.FormulaFields.GetItemByName("EMAIL").text = "'" & GEmail & "'"
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource RecRpt
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    mysql = "'Trade Register From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
    
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
    Else
        MsgBox "No Records Found"
    End If
        Me.MousePointer = 0
        Frame2.Enabled = True
        OkCmd.Enabled = True
        Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
End Sub
Private Sub Trade_Register()
Dim LTExCode As String:         Dim LBrokType As String * 1:    Dim LInstType As String * 3:    Dim LContractAcc As String:
Dim MMemberID As String:        Dim LFMCCode As String:         Dim LParty As String:           Dim GPhone As String
Dim LPartyName As String:       Dim LSaudaCode As String:       Dim LSaudaName As String:       Dim LItemCode As String
Dim LItemName As String:        Dim LConType As String:         Dim LScGroup As String * 1:     Dim LMBrokType As String * 1:

Dim LBrokRate As Double:        Dim LBrokRate2 As Double:       Dim LBrokQty As Double:     Dim LCalval As Double:
Dim LStrike As Double:          Dim LTradeableLot As Double:    Dim LBrokAmount As Double:  Dim LMinRate As Double
Dim GBrokLot As Double:         Dim LSBrokRate As Double:       Dim LSBrokRate2 As Double:  Dim LBrokQty2 As Double
Dim LRATE As Double:            Dim TotQty As Double:           Dim LBrokAmt As Double:     Dim LTotBrokAmt As Double
Dim LCBrokAmt As Double

Dim LCondate As Date:           Dim SrNo As Long:               Dim TRec As ADODB.Recordset
Dim LContime As String


    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
        
    If Combo1.ListIndex = 0 Then
        mysql = "SELECT EXCODE,CONTRACTACC,FMCCODE,MEMBERID FROM EXMAST WHERE COMPCODE  = " & GCompCode & " "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  EXID IN (" & LSExCodes & ")"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not TRec.EOF Then
            LTExCode = TRec!excode
            LContractAcc = TRec!CONTRACTACC
            MMemberID = IIf(IsNull(TRec!MemberId), "", TRec!MemberId)
            LFMCCode = IIf(IsNull(TRec!FMCCODE), "", TRec!FMCCODE)
        End If
        Set TRec = Nothing
        If AllExcodes = False Then
            mysql = "SELECT CD.CONDATE,CD.ORDNO,CD.ROWNO1,I.ITEMNAME,SU.MATURITY,CD.CONTYPE,CD.QTY,CD.RATE,CD.BROKRATE,CD.BROKQTY,CD.BROKTYPE,ACEX.ACEXCODE,"
            mysql = mysql & " AC.NAME ,I.LOT ,CD.CONTIME,CD.USERID,E.LOTWISE,SU.TRADEABLELOT,SU.SAUDACODE,SAUDA,I.EXCHANGECODE,CD.CONCODE,AM.NAME AS CONNAME,CD.STTRATE"
            mysql = mysql & " FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC , ACCT_EX  AS ACEX,EXMAST AS E , ACCOUNTD AS AM"
            mysql = mysql & " WHERE  ACEX.ACCID =AC.ACCID AND  AM.AC_CODE =CD.CONCODE"
            mysql = mysql & " AND ACEX.EXCODE ='" & LTExCode & "'"
            mysql = mysql & " AND CM.COMPCODE =" & GCompCode & " AND CM.COMPCODE =CD.COMPCODE  "
            mysql = mysql & " AND CM.CONSNO=CD.CONSNO AND CD.SAUDAID = SU.SAUDAID AND CD.ITEMID=I.ITEMID AND CD.ACCID =AC.ACCID "
            mysql = mysql & " AND CD.PARTY <> CD.CONCODE AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
            mysql = mysql & " AND E.EXID =I.EXID  "
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  I.EXID IN  (" & LSExCodes & ") "
            If AllSaudas = False Then mysql = mysql & "  AND CD.SAUDAID IN (" & LSSaudas & ") "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND AC.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND AC.AC_CODE IN (" & LSParties & ")"
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
            mysql = mysql & " ORDER BY CD.CONDATE,CD.ROWNO1"
        Else
            mysql = "SELECT CD.CONDATE,CD.ORDNO, CD.ROWNO1,I.ITEMNAME,SU.MATURITY,CD.CONTYPE,CD.QTY,CD.RATE,CD.BROKRATE,CD.BROKQTY, CD.BROKTYPE,AC.AC_CODE, "
            mysql = mysql & " AC.NAME ,I.LOT ,CD.CONTIME,CD.USERID,E.LOTWISE,SU.TRADEABLELOT,SU.SAUDACODE,I.EXCHANGECODE,CD.CONCODE,AM.NAME AS CONNAME,CD.STTRATE,CD.CONTIME"
            mysql = mysql & " FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC,EXMAST AS E , ACCOUNTD AS AM "
            mysql = mysql & " WHERE CM.COMPCODE =" & GCompCode & " AND CM.COMPCODE =CD.COMPCODE "
            mysql = mysql & " AND CM.CONSNO = CD.CONSNO AND CD.SAUDAID=SU.SAUDAID AND CD.ITEMID =I.ITEMID AND CD.ACCID =AC.ACCID  "
            mysql = mysql & " AND CD.PARTY <> CD.CONCODE AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
            mysql = mysql & " AND E.EXID=I.EXID AND AM.COMPCODE =CD.COMPCODE AND AM.AC_CODE =CD.CONCODE "
            If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  I.EXID  IN  (" & LSExCodes & ") "
            If AllSaudas = False Then mysql = mysql & "  AND CD.SAUDAID IN (" & LSSaudas & ") "
            If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
                mysql = mysql & " AND AC.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
            End If
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND AC.AC_CODE  IN (" & LSParties & ")"
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
            mysql = mysql & " ORDER BY CD.CONDATE,CD.CONNO"
        End If
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    ElseIf Combo1.ListIndex = 2 Then
        mysql = "SELECT EXCODE,CONTRACTACC,MEMBERID,FMCCODE FROM EXMAST WHERE COMPCODE  = " & GCompCode & " "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  EXID IN (" & LSExCodes & ")"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec.EOF Then
            LTExCode = TRec!excode
            LContractAcc = TRec!CONTRACTACC
            MMemberID = TRec!MemberId
            LFMCCode = IIf(IsNull(TRec!FMCCODE), "", TRec!FMCCODE)
        End If
        mysql = "SELECT CD.CONDATE,CD.ORDNO, CD.ROWNO1,I.ITEMNAME,SU.MATURITY,CD.CONTYPE,CD.QTY,CD.RATE,CD.BROKRATE,CD.BROKQTY,CD.BROKTYPE,ACEX.ACEXCODE, "
        mysql = mysql & " AC.NAME ,I.LOT,CD.CONTIME,CD.USERID,E.LOTWISE,SU.BROKLOT "
        mysql = mysql & " FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC , ACCT_EX  AS ACEX,EXMAST AS E "
        mysql = mysql & " WHERE ACEX.COMPCODE =CM.COMPCODE AND ACEX.AC_CODE=AC.AC_CODE AND ACEX.EXCODE ='" & LTExCode & "' AND CM.COMPCODE =" & GCompCode & ""
        mysql = mysql & " AND CM.COMPCODE =CD.COMPCODE AND CD.COMPCODE =AC.COMPCODE "
        mysql = mysql & " AND CM.CONSNO = CD.CONSNO AND CD.SAUDAID=SU.SAUDAID AND CD.ITEMID = I.ITEMID AND CD.ACCID =AC.ACCID "
        mysql = mysql & " AND CD.PARTY <> '" & LContractAcc & "'AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
        mysql = mysql & " AND E.COMPCODE =I.COMPCODE AND E.EXCODE =I.EXCHANGECODE"
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND AC.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND AC.AC_CODE IN (" & LSParties & ")"
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  I.EXID IN  (" & LSExCodes & ") "
        If AllSaudas = False Then mysql = mysql & " AND  CD.SAUDAID IN (" & LSSaudas & ") "
        If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
        mysql = mysql & " ORDER BY CD.CONDATE,CD.CONTIME"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    ElseIf Combo1.ListIndex = 3 Then
        mysql = "SELECT EXCODE,CONTRACTACC,MEMBERID,FMCCODE FROM EXMAST WHERE COMPCODE  = " & GCompCode & " "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  EXID  IN (" & LSExCodes & ")"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec.EOF Then
            LTExCode = TRec!excode
            LContractAcc = TRec!CONTRACTACC
            MMemberID = TRec!MemberId
            LFMCCode = IIf(IsNull(TRec!FMCCODE), "", TRec!FMCCODE)
        End If
        mysql = "SELECT CD.CONDATE,CD.ORDNO, CD.ROWNO1,SU.SAUDANAME,SU.MATURITY,CD.CONTYPE,CD.QTY,CD.RATE,CD.BROKRATE,CD.BROKQTY,CD.BROKTYPE,"
        mysql = mysql & " AC.AC_CODE,AC.NAME ,I.LOT,CD.CONTIME,CD.USERID,I.EXCHANGECODE,E.LOTWISE "
        mysql = mysql & " FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC, EXMAST AS E"
        mysql = mysql & " WHERE  CM.COMPCODE =" & GCompCode & " AND CM.COMPCODE =CD.COMPCODE "
        mysql = mysql & " AND CD.COMPCODE =AC.COMPCODE AND CM.CONSNO = CD.CONSNO AND CD.SAUDAID = SU.SAUDAID AND CD.ITEMID=I.ITEMID AND CD.ACCID =AC.ACCID "
        mysql = mysql & " AND CD.PARTY <> '" & LContractAcc & "'AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
        mysql = mysql & " AND E.COMPCODE =I.COMPCODE AND E.EXCODE =I.EXCHANGECODE"
        If AllSaudas = False Then mysql = mysql & " AND  CD.SAUDAID IN (" & LSSaudas & ") "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND AC.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
        End If
            
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND AC.AC_CODE IN (" & LSParties & ")"
        If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  I.EXID   IN  (" & LSExCodes & ") "
        mysql = mysql & " ORDER BY CD.CONDATE,AC.NAME,I.EXCHANGECODE,CD.CONTYPE ,CD.CONTIME"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    Else
        LBrokAmt = 0
        LTotBrokAmt = 0
        mysql = "SELECT CD.CONDATE,SU.SAUDACODE,SU.SAUDANAME,SU.INSTTYPE,SU.STRIKEPRICE,I.ITEMCODE,I.ITEMNAME,I.LOT,CD.QTY,CD.RATE,CD.CONTYPE,"
        mysql = mysql & " CD.BROKRATE,CD.BROKRATE2,CD.TRANRATE,CD.BROKTYPE,CM.PATTAN,CD.BROKQTY,CD.SRVTAX,SU.TRADEABLELOT,SU,BROKLOT "
        mysql = mysql & " AC.AC_CODE,AC.NAME,AC.ADD1,AC.CITY,AC.PHONEO ,AC.MOBILE,AC.FAX,AC.PIN,AC.PHONEO,E.LOTWISE "
        mysql = mysql & " FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC,EXMAST AS E "
        mysql = mysql & " WHERE CM.COMPCODE =" & GCompCode & " AND CM.COMPCODE =CD.COMPCODE "
        mysql = mysql & " AND CD.COMPCODE =AC.COMPCODE AND CM.CONSNO = CD.CONSNO AND CD.SAUDAID=SU.SAUDAID AND CD.ITEMID=I.ITEMID "
        mysql = mysql & " AND CD.ACCID =AC.ACCID AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND CD.CONTYPE='B' "
        mysql = mysql & " AND E.EXID =I.EXID "
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  I.EXID IN  (" & LSExCodes & ") "
        If AllSaudas = False Then mysql = mysql & " AND  CD.SAUDAID IN (" & LSSaudas & ") "
        If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND AC.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
        End If
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  AC.AC_CODE  IN (" & LSParties & ") "
        mysql = mysql & " ORDER BY AC.NAME,CD.CONDATE,SU.SAUDANAME,CD.RATE"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        Do While Not TRec.EOF
            LRATE = TRec!Rate
            TotQty = 0:                                              LCBrokAmt = 0:            LBrokAmount = 0
            LCalval = IIf(IsNull(TRec!lot), 1, TRec!lot):            LInstType = TRec!INSTTYPE
            LStrike = TRec!STRIKEPRICE:                              LBrokRate = IIf(IsNull(TRec!brokrate), 0, TRec!brokrate)
            LBrokRate2 = TRec!BROKRATE2:                             LBrokType = IIf(IsNull(TRec!broktype), "P", TRec!broktype)
            LCondate = TRec!Condate:                                 LParty = TRec!AC_CODE
            LPartyName = TRec!NAME:                                  LSaudaCode = TRec!Sauda
            LSaudaName = TRec!SAUDANAME:                             LItemCode = TRec!ITEMCODE
            LItemName = TRec!ITEMName:                               LConType = TRec!CONTYPE
            LMBrokType = "P":                                        LTradeableLot = TRec!TRADEABLELOT
            LContime = TRec!contime
            GBrokLot = IIf(IsNull(TRec!BROKLOT), 1, TRec!BROKLOT): LSBrokRate = 0
            LSBrokRate2 = 0:         LCBrokAmt = 0
            LBrokAmount = 0:         LBrokQty = 0
            If TRec!EXCHANGECODE = "NSE" And TRec!LOTWISE = "Y" Then
                LCalval = TRec!TRADEABLELOT
            Else
                LCalval = TRec!lot
            End If
            Do While TRec!Rate = LRATE And TRec!AC_CODE = LParty
                TotQty = TotQty + TRec!QTY
                LBrokQty = LBrokQty + IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY)
                If LBrokType = "Z" Then LBrokQty = GBrokLot
                If LBrokType = "R" Then LBrokQty2 = GBrokLot
                LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY), TRec!QTY, TRec!Rate, LCalval, LInstType, LStrike, 0, LTradeableLot, "B", "2", TRec!itemid)
                LBrokAmount = LBrokAmount + LCBrokAmt
                TRec.MoveNext
                If TRec.EOF Then GoTo FLAG21
            Loop
FLAG21:
            RecRpt.AddNew
            SrNo = SrNo + 1
            RecRpt!CONTDATE = LCondate:               RecRpt!saudacode = LSaudaCode
            RecRpt!SAUDANAME = LSaudaName:            RecRpt!ITEMCODE = LItemCode
            RecRpt!ITEMName = LItemName:              RecRpt!PARTYCODE = LParty
            RecRpt!PARTYNAME = LPartyName:            RecRpt!ctype = LConType
            RecRpt!BQnty = Val(TotQty):               RecRpt!BRate = LRATE
            RecRpt!bbrokrate = LBrokAmount:           RecRpt!BBROKQTY = LBrokQty
            RecRpt!SrNo = SrNo:                       RecRpt!CALVAL = LCalval
            RecRpt!SCONNO = vbNullString:             RecRpt!SCONTIME = LContime
            

        Loop
        mysql = "SELECT CD.ORDNO,CD.CONNO,CD.CONTIME,CD.CONDATE, SU.SAUDACODE, SU.INSTTYPE, SU.STRIKEPRICE, SU.SAUDANAME,SU.TRADEABLELOT, SU.BROKLOT,"
        mysql = mysql & " I.ITEMCODE, I.ITEMNAME,I.LOT,I.EXCHANGECODE,I.QTYUNIT, I.PRICEUNIT, CD.QTY, CD.RATE, CD.BROKRATE,CD.BROKRATE2,CD.TRANRATE,"
        mysql = mysql & " CD.BROKTYPE, CD.CONTYPE, CM.PATTAN,CD.BROKQTY,CD.SRVTAX,AC.AC_CODE,AC.NAME,AC.ADD1,AC.CITY,AC.PHONEO ,AC.MOBILE,AC.FAX,AC.PIN,"
        mysql = mysql & " AC.PHONEO,E.LOTWISE FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC,EXMAST AS E "
        mysql = mysql & " WHERE CM.COMPCODE =" & GCompCode & " AND CM.COMPCODE=CD.COMPCODE "
        mysql = mysql & " AND CD.COMPCODE=AC.COMPCODE AND CM.CONSNO=CD.CONSNO AND CD.SAUDAID = SU.SAUDAID AND CD.ITEMID =I.ITEMID AND CD.ACCID =AC.ACCID "
        mysql = mysql & "  AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
        mysql = mysql & "  AND CD.CONTYPE='S' AND E.EXID =I.EXID"
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND  I.EXID IN  (" & LSExCodes & ") "
        If AllSaudas = False Then mysql = mysql & " AND  CD.SAUDAID IN (" & LSSaudas & ") "
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND AC.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE  FMLYID IN (" & LSFmlyIDs & "))"
        End If
        
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & "AND AC.AC_CODE  IN (" & LSParties & ") "
        If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
        mysql = mysql & " ORDER BY AC.NAME,CD.CONDATE,SU.SAUDANAME,CD.CONNO"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        Do While Not TRec.EOF
            LCalval = TRec!lot
            LInstType = TRec!INSTTYPE:                                  LStrike = TRec!STRIKEPRICE
            LBrokRate = Val(TRec!brokrate & vbNullString):              LBrokRate2 = Val(TRec!BROKRATE2 & vbNullString)
            LBrokType = IIf(IsNull(TRec!broktype), "P", TRec!broktype): LBrokQty = Val(TRec!BROKQTY & vbNullString)
            LCondate = TRec!Condate:                                    LTradeableLot = TRec!TRADEABLELOT
            LContime = TRec!contime
            
            GBrokLot = IIf(IsNull(TRec!BROKLOT), 1, TRec!BROKLOT):      LParty = TRec!AC_CODE
            LPartyName = TRec!NAME:                                     LSaudaCode = TRec!Sauda
            LSaudaName = TRec!SAUDANAME:                                LItemCode = TRec!ITEMCODE
            LItemName = TRec!ITEMName:                                  LConType = TRec!CONTYPE
            LMinRate = 0:                                               LMBrokType = "P"
            LSBrokRate = 0:                                             LSBrokRate2 = 0
            LRATE = TRec!Rate:                                          TotQty = 0
            LBrokQty = 0:                                               LCBrokAmt = 0
            LBrokAmount = 0
            If TRec!EXCHANGECODE = "NSE" And TRec!LOTWISE = "Y" Then
                LCalval = TRec!TRADEABLELOT
            Else
                LCalval = TRec!lot
            End If
            
           
            Do While TRec!Rate = LRATE And TRec!Sauda = LSaudaCode
                TotQty = TotQty + TRec!QTY
                LBrokQty = LBrokQty + IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY)
                If LBrokType = "Z" Then LBrokQty = GBrokLot
                If LBrokType = "R" Then LBrokQty2 = GBrokLot
                LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, IIf(IsNull(TRec!BROKQTY), 0, TRec!BROKQTY), TRec!QTY, TRec!Rate, LCalval, LInstType, LStrike, 0, LTradeableLot, "B", "2", TRec!itemid)
                LBrokAmount = LBrokAmount + LCBrokAmt
                TRec.MoveNext
                If TRec.EOF Then GoTo FLAG33
            Loop
FLAG33:
            RecRpt.Filter = adFilterNone
            RecRpt.Filter = "SAUDACODE='" & LSaudaCode & "' AND PARTYCODE='" & LParty & "'"
            Do While Not RecRpt.EOF
                If Val(RecRpt!SQnty & "") = 0 Then
                    RecRpt!CONTDATE1 = LCondate
                    RecRpt!SQnty = TotQty
                    RecRpt!SRate = LRATE
                    RecRpt!SBROKRATE = LBrokAmount
                    RecRpt!SBROKQTY = LBrokQty
                    GoTo FLAG1231
                End If
                RecRpt.MoveNext
            Loop
            If RecRpt.EOF Then
                RecRpt.AddNew
                SrNo = SrNo + 1
                RecRpt!CONTDATE = LCondate:                RecRpt!saudacode = LSaudaCode
                RecRpt!SAUDANAME = LSaudaName:             RecRpt!ITEMCODE = LItemCode
                RecRpt!ITEMName = LItemName:               RecRpt!PARTYCODE = LParty
                RecRpt!PARTYNAME = LPartyName:             RecRpt!SBROKQTY = LBrokQty
                RecRpt!ctype = LConType:                   RecRpt!SQnty = TotQty
                RecRpt!SRate = LRATE:                      RecRpt!SrNo = SrNo
                RecRpt!CALVAL = LCalval:                   RecRpt!BCONNO = vbNullString
                RecRpt!BCONTIME = LContime:                RecRpt!SBROKRATE = LBrokAmount
                
            End If
FLAG1231:
            RecRpt.Update
        Loop
    End If

    If Combo1.ListIndex = 1 Then
        RecRpt.Sort = "PARTYNAME,SAUDANAME,SRNO"
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        Set TRec = RecRpt.Clone
    End If
    If Combo1.ListIndex = 0 Or Combo1.ListIndex = 2 Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "TRDREGISTER.RPT", 1)
    ElseIf Combo1.ListIndex = 3 Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "TRDREGISTER-PT.RPT", 1)
    Else
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CONTREGrt.RPT", 1)
    End If
    GPhone = "Ph: " & GCompPhoneO & ", " & GCompPhoneR & "," & GCompMobile & ""
    RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
    RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
    RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
    RDCREPO.FormulaFields.GetItemByName("OPHONE1").text = "'" & GPhone & "'"
    RDCREPO.FormulaFields.GetItemByName("SRVNO").text = "'" & GSrvRegNo & "'"
    RDCREPO.FormulaFields.GetItemByName("MMEMID").text = "'" & MMemberID & "'"
    RDCREPO.FormulaFields.GetItemByName("FMCCODE").text = "'" & LFMCCode & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & GPANNo & "'"
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    mysql = "'Trade Register From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"

    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    Frame2.Enabled = True
    OkCmd.Enabled = True
    Set TRec = Nothing
    Exit Sub
err1:
        MsgBox err.Description, vbCritical, "Error Number : " & err.Number
        Me.MousePointer = 0
End Sub
Private Sub CreateRec_Cont()
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "CONTDATE", adDate, , adFldIsNullable
    RecRpt.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SAUDANAME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "ITEMNAME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "PARTYNAME", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CTYPE", adVarChar, 1, adFldIsNullable
    RecRpt.Fields.Append "PATTAN", adVarChar, 1, adFldIsNullable
    RecRpt.Fields.Append "CONTDATE1", adDate, , adFldIsNullable
    RecRpt.Fields.Append "SRNO", adInteger, , adFldIsNullable
    RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BCONNO", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "BCONTIME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SCONNO", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SCONTIME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PRTYADD", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "PRTYCITY", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PRTYPHN", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "BBROKRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SBROKRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BBROKTYPE", adVarChar, 1, adFldIsNullable
    RecRpt.Fields.Append "SBROKTYPE", adVarChar, 1, adFldIsNullable
    RecRpt.Fields.Append "BTRANRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "STRANRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "EXCHANGE", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "PRICEUNIT", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "QTYUNIT", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "BORDNO", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "SORDNO", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "BSRVTAX", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SSRVTAX", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BBROKQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SBROKQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CNOTENO", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "PIN", adVarChar, 10, adFldIsNullable
    RecRpt.Fields.Append "PHONEO", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PHONER", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "MOBILE", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "FAX", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PANNO", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "BREGLOT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SREGLOT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BCTTRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SCTTRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "STMTYPE", adVarChar, 1, adFldIsNullable
    RecRpt.Fields.Append "BSBCTAX", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SSBCTAX", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BSEBITAX", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SSEBITAX", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BBROKRATE2", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SBROKRATE2", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RISKMAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BROKAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "STAMPAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "LDiffAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "TranAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SrvAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CINNO", adVarChar, 30, adFldIsNullable
    RecRpt.Fields.Append "ORDTIME", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "CGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "IGSTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "UTTAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "STATE", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "STATECODE", adVarChar, 10, adFldIsNullable
    RecRpt.Fields.Append "UCC", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "GSTIN", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "BTRDNO", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "STRDNO", adVarChar, 50, adFldIsNullable
    
    
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
End Sub
Private Sub Contract_Note_all()
    Dim LRiskMType As String:    Dim LAC_CODE As String:       Dim LExCode As String:    Dim LSaudaCode As String
    Dim LRiskMApp As String:     Dim MMemberID As String:      Dim LFMCCode As String:   Dim LMBrokType As String * 1
    Dim LPStmType As String:     Dim LBrokType As String * 1:  Dim GPhone As String:     Dim LClientCode As String
    Dim LCItemCode As String:    Dim LTD1 As Date:             Dim LCondate As Date:     Dim Lmaturity As Date
    Dim LRiskMDate As Date:      Dim SrNo As Long:             Dim GBrokLot As Double:   Dim LNStmAmt As Double
    Dim LCalval As Double:       Dim LSBCTaxRate As Double:    Dim LSrvTax As Double:    Dim ClRate1 As Double
    Dim LBrokAmt As Double:      Dim LDiffAmt As Double:       Dim LSBrokRate As Double: Dim LSBrokRate2 As Double
    Dim LBrokQty As Double::     Dim LBrokQty2 As Double:      Dim LTranAmt As Double:   Dim LStmRate As Double
    Dim LTotStmAmt  As Double:   Dim LStmAmt As Double:        Dim LRiskMAmt As Double:  Dim LTradeableLot As Double:
    Dim LBalQty  As Double
    Dim LTotStampAmt As Double
    Dim LSaudaID As Long
    
    Dim TRec As ADODB.Recordset: Dim TRec2 As ADODB.Recordset
    Dim IRec As ADODB.Recordset
    Dim LEXNAME  As String
    On Error GoTo err1
    
    LTD1 = DateValue("01/07/2013")
    SrNo = 0
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    LSParties = Get_Parties
    Call CreateRec_Cont
    LAC_CODE = vbNullString
    LExCode = vbNullString
    mysql = " SELECT E.EXCODE,E.EXNAME,CD.NOTENO,CD.ORDNO, CD.CONNO,CD.CONTIME,CD.CONDATE,CD.SAUDAID,CD.SAUDA,SU.SAUDANAME,SU.MATURITY,SU.TRADEABLELOT,SU.BROKLOT,I.ITEMCODE,I.ITEMNAME,I.LOT,I.QTYUNIT,I.PRICEUNIT,CD.QTY,CD.RATE,"
    mysql = mysql & " CD.CONTYPE,CD.BROKRATE,CD.TRANRATE,CD.BROKTYPE,CM.PATTAN,CD.BROKQTY,CD.SRVTAX,CD.ROWNO1,CD.STMRATE,CD.STTRATE,CD.ORDTIME,CD.INSTTYPE, "
    mysql = mysql & " AC.AC_CODE,AC.NAME,AC.ADD1,AC.CITY,AC.PHONEO,AC.PANNO ,AC.MOBILE,AC.FAX,AC.PIN,AC.PHONER, AC.APPLYON,AC.STATE,AC.STATECODE,AC.UCC,AC.GSTIN,E.LOTWISE,CD.SBC_TAX,CD.SEBITAX,CD.BROKRATE2,AC.RISKMTYPE, I.RISKMAPP "
    mysql = mysql & " FROM CTR_M AS CM, CTR_D AS CD, SAUDAMAST AS SU, ITEMMAST AS I, ACCOUNTD AS AC, EXMAST AS E "
    mysql = mysql & " WHERE CM.COMPCODE =" & GCompCode & " AND CM.COMPCODE =CD.COMPCODE AND CD.COMPCODE = SU.COMPCODE AND CD.COMPCODE = I.COMPCODE AND CD.COMPCODE =AC.COMPCODE AND CM.CONSNO = CD.CONSNO "
    mysql = mysql & " AND CD.SAUDAID=SU.SAUDAID AND CD.ITEMID =I.ITEMID AND CD.ACCID =AC.ACCID AND CD.CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CD.CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    mysql = mysql & " AND E.COMPCODE =I.COMPCODE AND E.EXCODE =I.EXCHANGECODE and NOTENO <>0 "
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND AC.ACCID IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  AC.AC_CODE IN (" & LSParties & ") "
    mysql = mysql & " ORDER BY CD.CONDATE,AC.NAME,"
    mysql = mysql & " AC.AC_CODE,E.EXCODE,I.ITEMCODE,SU.MATURITY"
    Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    With TRec
        Do While Not .EOF
            LDiffAmt = 0
            LAC_CODE = !AC_CODE:            LExCode = !excode
            LEXNAME = !EXNAME
            Do While LAC_CODE = !AC_CODE And LExCode = !excode
                LCondate = !Condate
                Set TRec2 = Nothing:            Set TRec2 = New ADODB.Recordset
                mysql = "SELECT ACEXCODE FROM ACCT_EX WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & !AC_CODE & "' AND EXCODE ='" & !excode & "'"
                TRec2.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec2.EOF Then LClientCode = TRec2!ACEXCODE
                Set TRec2 = Nothing
                LTotStampAmt = 0
                Set TRec2 = Nothing:            Set TRec2 = New ADODB.Recordset
                mysql = "SELECT SUM(STAMPAMT) AS TOTSTAMP FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & !AC_CODE & "' "
                mysql = mysql & " AND EXCODE ='" & !excode & "' AND STDATE ='" & Format(LCondate, "YYYY/MM/DD") & "'"
                TRec2.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec2.EOF Then LTotStampAmt = IIf(IsNull(TRec2!TOTSTAMP), 0, TRec2!TOTSTAMP)
                Do While LCondate = !Condate And LAC_CODE = !AC_CODE And LExCode = !excode
                    LSaudaCode = !Sauda:            LSaudaID = !SAUDAID
                    LCItemCode = !ITEMCODE:         Lmaturity = !MATURITY
                    LRiskMApp = !RISKMAPP:          LCalval = !lot
                    LTradeableLot = !TRADEABLELOT:  LPStmType = !APPLYON
                    LRiskMType = !RISKMTYPE
                    LBalQty = SDOpQty(LAC_CODE, LSaudaID, LCondate):
                    Do While LAC_CODE = !AC_CODE And LExCode = !excode And LSaudaCode = !Sauda And LCondate = !Condate
                        RecRpt.AddNew:                   SrNo = SrNo + 1:
                        GBrokLot = !BROKLOT:
                        LBrokType = !broktype
                        RecRpt!PARTYCODE = !AC_CODE
                        RecRpt!CONTDATE = Format(!Condate, "YYYY/MM/DD")
                        RecRpt!PARTYNAME = !NAME:        RecRpt!PRTYADD = !ADD1:            RecRpt!PrtyCity = !City:
                        RecRpt!PRTYPHN = !PhoneO:        RecRpt!PhoneR = !PhoneR:           RecRpt!Mobile = !Mobile
                        RecRpt!Fax = !Fax:               RecRpt!Pin = !Pin:                 RecRpt!PANNO = !PANNO
                        RecRpt!saudacode = !Sauda:       RecRpt!SAUDANAME = !SAUDANAME:     RecRpt!ITEMCODE = !ITEMCODE
                        RecRpt!ITEMName = !ITEMName:     RecRpt!ctype = !CONTYPE:           RecRpt!PATTAN = !PATTAN
                        RecRpt!BRate = !Rate:            RecRpt!bbrokrate = !brokrate:      RecRpt!bbroktype = !broktype
                        RecRpt!BREGLOT = !STMRATE:       RecRpt!SQnty = 0:                  RecRpt!SRate = 0
                        RecRpt!SBROKTYPE = "P":          RecRpt!SBROKRATE = 0:              RecRpt!STRANRATE = 0
                        RecRpt!SREGLOT = 0:              RecRpt!SBROKQTY = 0:               RecRpt!SSRVTAX = 0
                        RecRpt!SCTTRATE = 0:             RecRpt!SSBCTAX = 0:                RecRpt!SSEBITAX = 0
                        RecRpt!SBROKRATE2 = 0:           RecRpt!BORDNO = !ORDNO & vbNullString: RecRpt!SORDNO = LClientCode
                        RecRpt!BCONNO = !ROWNO1 & vbNullString:                             RecRpt!State = !State & vbNullString
                        RecRpt!StateCode = !StateCode & vbNullString:                       RecRpt!UCC = !UCC & vbNullString
                        RecRpt!GSTIN = !GSTIN & vbNullString:                               RecRpt!BCONTIME = !contime & vbNullString
                        RecRpt!CNOTENO = IIf(IsNull(!NOTENO), 0, !NOTENO):                  RecRpt!STMTYPE = LPStmType:
                        RecRpt!ORDTIME = !ORDTIME & vbNullString:                           RecRpt!BQnty = !QTY
                        RecRpt!BBROKRATE2 = !BROKRATE2:                                     RecRpt!BBROKQTY = IIf(IsNull(!BROKQTY), 0, !BROKQTY)
                        RecRpt!SrNo = SrNo:                                                 RecRpt!CALVAL = !lot
                        RecRpt!exchange = !EXNAME & vbNullString:                           RecRpt!PRICEUNIT = !PRICEUNIT & vbNullString
                        RecRpt!QTYUNIT = !QTYUNIT & vbNullString:                           RecRpt!RISKMAMT = 0
                        LSBrokRate = 0: LSBrokRate2 = 0
                        If LBrokType = "Z" Then LBrokQty = GBrokLot
                        If LBrokType = "R" Then LBrokQty2 = GBrokLot
                        If (LBrokType = "O" Or LBrokType = "C") Then
                            LBrokQty = Get_BrokQty(LBrokType, LBalQty, !CONTYPE, !QTY)
                            If !CONTYPE = "B" Then
                                LBalQty = LBalQty + !QTY
                            Else
                                LBalQty = LBalQty - !QTY
                            End If
                        End If
                        LBrokAmt = Calc_Brokerage(!broktype, !brokrate, !BROKRATE2, LBrokQty, !QTY, !Rate, !lot, !INSTTYPE, 0, 0, LTradeableLot, "B", "2", TRec!itemid)
                        LTranAmt = (!TRANRATE / 100) * !QTY * !Rate * !lot
                        RecRpt!BTRANRATE = !TRANRATE
                        RecRpt!BSRVTAX = 0
                       ' LStmAmt = ((LStmRate / 100) * !QTY * !Rate * LCalval):
                       ' LTotStmAmt = LTotStmAmt + LStmAmt
                        LSrvTax = !SRVTAX:               RecRpt!BCTTRATE = 0
                        RecRpt!BROKAMT = LBrokAmt:       RecRpt!SRVAMT = 0
                        RecRpt!TranAmt = 0:              RecRpt!BSEBITAX = 0
                        RecRpt!BSBCTAX = 0:              LSBCTaxRate = !SBC_TAX
                        RecRpt!RISKMAMT = 0:             RecRpt!STampamt = 0
                        RecRpt!LDiffAmt = 0:
                        RecRpt.Update
                        TRec.MoveNext
                        If TRec.EOF Then Exit Do
                    Loop
                    LRiskMAmt = 0
                    mysql = "SELECT DIFFAMT,BROKAMT,TRANAMT,SRVAMT,STTTAX,SEBITAXAMT,SBC_TAX_AMT,RISKMAMT,CGSTAMT,SGSTAMT,IGSTAMT,UTTAMT,CGSTAMT,SGSTAMT,IGSTAMT,UTTAMT "
                    mysql = mysql & " FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LAC_CODE & "' AND SAUDA='" & LSaudaCode & "' AND STDATE ='" & Format(LCondate, "YYYY/MM/DD") & "'"
                    Set IRec = Nothing
                    Set IRec = New ADODB.Recordset
                    IRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not IRec.EOF Then
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "PARTYCODE ='" & LAC_CODE & "'AND EXCHANGE ='" & LEXNAME & "' AND CONTDATE ='" & Format(LCondate, "YYYY/MM/DD") & "' AND SAUDACODE='" & LSaudaCode & "'"
                        If Not RecRpt.EOF Then
                            RecRpt!LDiffAmt = IRec!DIFFAMT:            RecRpt!SRVAMT = IRec!SRVAMT
                            RecRpt!TranAmt = IRec!TranAmt:             RecRpt!BCTTRATE = IRec!STTTax
                            RecRpt!BSEBITAX = IRec!SEBITaxAmt:         RecRpt!BSBCTAX = IRec!SBC_TAX_AMt
                            RecRpt!RISKMAMT = IRec!RISKMAMT:           RecRpt!cgstamt = IRec!cgstamt
                            RecRpt!SGSTAMT = IRec!SGSTAMT:             RecRpt!IGSTAMT = IRec!IGSTAMT
                            RecRpt!UTTAMT = IRec!UTTAMT
                            RecRpt!STampamt = LTotStampAmt
                            RecRpt.Update
                            LTotStampAmt = 0
                        End If
                    End If
                    If TRec.EOF Then Exit Do
                    Set IRec = Nothing
                Loop
                If TRec.EOF Then Exit Do
            Loop
            If TRec.EOF Then Exit Do
        Loop
    End With
    RecRpt.Filter = adFilterNone
    MMemberID = vbNullString
    LFMCCode = vbNullString
    RecRpt.Sort = "PARTYNAME,SAUDANAME,CONTDATE"
    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CNOTE_ALL.RPT", 1)
    
    GPhone = "Ph: " & GCompPhoneO & ", " & GCompPhoneR & "," & GCompMobile & ""
        
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
    RDCREPO.FormulaFields.GetItemByName("OADD1").text = "'" & GCompanyAdd1 & "'"
    RDCREPO.FormulaFields.GetItemByName("OADD2").text = "'" & GCompanyAdd2 & "'"
    RDCREPO.FormulaFields.GetItemByName("OCITY").text = "'" & GCCity & "'"
    RDCREPO.FormulaFields.GetItemByName("OPHONE1").text = "'" & GPhone & "'"
    RDCREPO.FormulaFields.GetItemByName("SRVNO").text = "'" & GSrvRegNo & "'"
    RDCREPO.FormulaFields.GetItemByName("MMEMID").text = "'" & MMemberID & "'"
    RDCREPO.FormulaFields.GetItemByName("FMCCODE").text = "'" & LFMCCode & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & GPANNo & "'"
    RDCREPO.FormulaFields.GetItemByName("CINNO").text = "'" & GCINNo & "'"
    RDCREPO.FormulaFields.GetItemByName("EMAIL").text = "'" & GEmail & "'"
    RDCREPO.FormulaFields.GetItemByName("COMP_GSTIN").text = "'" & GGSTIN & "'"
    RDCREPO.FormulaFields.GetItemByName("SEBI_REG_NO").text = "'" & GSEBIRegNo & "'"
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource RecRpt
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    mysql = "'Trade Register From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    Frame2.Enabled = True
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
End Sub
Sub Invoice_GenerateStatement()

Dim LBAmt As Double:            Dim LRefLot As Double:           Dim LBrokLot As Double:          Dim MBal As Double
Dim LBal As Double:             Dim MOpBal As Double:            Dim LMarType As String:          Dim LDebitAmt As Double
Dim LCreditAmt As Double:       Dim GSrvTax As Double:           Dim LTotStmAmt As Double:        Dim LTotSTTAmt As Double
Dim LRiskMAmt  As Double:       Dim LTotSEBITaxAmt As Double:    Dim LSBCTaxAmt As Double:        Dim LMarAmt As Double
Dim LBrokRate As Double:        Dim LCalval As Double:           Dim LStrike As Double:           Dim LTradeableLot As Double
Dim GTrFees As Double:          Dim GSTDChrs As Double:          Dim OpQty As Double:             Dim MTotBAmt As Double
Dim MTotSAmt As Double:         Dim MTotOpAmt As Double:         Dim LTranRate As Double:         Dim LCGSTAmt As Double:
Dim LcTranAmt   As Double:      Dim LPartyCode As String:        Dim LPartyName As String:        Dim Acct_ExRec As ADODB.Recordset:
Dim LContractAcc As String:     Dim TRec As ADODB.Recordset:     Dim LPANNO As String:            Dim LPIN As String
Dim LPHoneo As String:          Dim LPhoneR As String:           Dim LFAX As String:              Dim LMobile As String
Dim LExCode As String:          Dim LItemCode As String:         Dim LItemName As String:         Dim LInstType As String
Dim LSaudaCode As String:       Dim LIInvDate As Date:           Dim LSaudaName As String:        Dim LBrokType As String
Dim LLotWise As String:         Dim LAMT As Double:              Dim LBIllAmt As Double:          Dim LStmFlag As Boolean
Dim LOpFlag As Boolean:         Dim Lmaturity As Date:           Dim LGSTIN As String:            Dim LStDate As Date
Dim CountRec As Long:           Dim MItemCode As String:         Dim ClRate As Double:            Dim ClRate1 As Double
Dim LBillNo As Double:          Dim LTitle As String:            Dim LIInvNo As Long:             Dim LShareAmt As Double
Dim MCLPattan As String:    Dim MExCode As String:           Dim AccStAdoREC As ADODB.Recordset
Dim LSAmt As Double:            Dim MClQty As Double:            Dim LBrokAmt  As Double:         Dim LUTTAmt As Double:
Dim LMarRate As Double:         Dim LNStmAmt As Double:          Dim LSGSTAmt As Double:          Dim LIGSTAmt As Double:
Dim LACCID  As Long
    
    mysql = "SELECT * FROM ACCT_EX WHERE COMPCODE =" & GCompCode & "  ORDER BY AC_CODE,EXCODE"
    Set Acct_ExRec = Nothing
    Set Acct_ExRec = New ADODB.Recordset
    Acct_ExRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    Me.MousePointer = Val(11)
    Do While Not PartyRec.EOF ' party loop
        If LIInvNo <> PartyRec!invno Then
            LStmFlag = False
            LOpFlag = False
        End If
        LIInvNo = PartyRec!invno:                   LIInvDate = PartyRec!INVDATE
        LPartyCode = PartyRec!AC_CODE:              LPartyName = PartyRec!NAME
        LStDate = PartyRec!STDATE:                  LBillNo = PartyRec!BILLNO
        LGSTIN = Trim(IIf(IsNull(PartyRec!GSTIN), vbNullString, PartyRec!GSTIN))
        LPANNO = Trim(IIf(IsNull(PartyRec!PANNO), vbNullString, PartyRec!PANNO))
        LPHoneo = Trim(IIf(IsNull(PartyRec!PhoneO), vbNullString, PartyRec!PhoneO))
        LPhoneR = Trim(IIf(IsNull(PartyRec!PhoneR), vbNullString, PartyRec!PhoneR))
        LFAX = Trim(IIf(IsNull(PartyRec!Fax), vbNullString, PartyRec!Fax))
        LMobile = Trim(IIf(IsNull(PartyRec!Mobile), vbNullString, PartyRec!Mobile))
        LPIN = Trim(IIf(IsNull(PartyRec!Pin), vbNullString, PartyRec!Pin))
        LACCID = PartyRec!ACCID

        LBIllAmt = PartyRec!Billamt
        LTitle = "Invoice From " & PartyRec!FROMDATE & " to " & PartyRec!STDATE & ""
        MBal = 0
        If (Option4.Value) Or (Option5.Value) Then
            MOpBal = PartyRec!OP_BAL: MBal = MOpBal
            LBal = 0:    LBal = Net_DrCr(PartyRec!AC_CODE, DateValue(PartyRec!INVDATE))
            MBal = MBal + LBal
            If Option4.Value Then
                If Check4.Value = 1 Then
                    MBal = Get_Balance(PartyRec!AC_CODE)
                Else
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    mysql = "EXEC ACSUMVCHS " & GCompCode & ",'" & PartyRec!AC_CODE & "','" & Format(PartyRec!Opendt, "yyyy/MM/dd") & "','" & Format(PartyRec!STDATE, "yyyy/MM/dd") & "'"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then MBal = MBal + IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                End If
            ElseIf Option5.Value Then
                LDebitAmt = 0: LCreditAmt = 0
                mysql = "SELECT DR_CR,SUM(AMOUNT) AS AMT  FROM VCHAMT WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & PartyRec!AC_CODE & "' AND VOU_DT>='" & Format(PartyRec!Opendt, "YYYY/MM/DD") & "'"
                mysql = mysql & " AND VOU_TYPE<>'S' AND VOU_DT<='" & Format(PartyRec!STDATE, "YYYY/MM/DD") & "' GROUP BY DR_CR"
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenDynamic, adLockReadOnly
                If Not TRec.EOF Then
                    If TRec!DR_CR = "C" Then LCreditAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    If TRec!DR_CR = "D" Then LDebitAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    TRec.MoveNext
                    If Not TRec.EOF Then
                        If TRec!DR_CR = "C" Then LCreditAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                        If TRec!DR_CR = "D" Then LDebitAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    End If
                End If
            End If
        End If
        MExCode = PartyRec!EXCHANGECODE:        LItemCode = PartyRec!ITEMCODE
        LItemName = PartyRec!ITEMName:          LInstType = PartyRec!INSTTYPE
        LStrike = Val(PartyRec!STRIKEPRICE):    LSaudaCode = PartyRec!Sauda
        LSaudaName = PartyRec!SAUDANAME:        Lmaturity = PartyRec!MATURITY
        LBrokLot = IIf(IsNull(PartyRec!BROKLOT), 0, PartyRec!BROKLOT)
        LRefLot = IIf(IsNull(PartyRec!REFLOT), 1, PartyRec!REFLOT)
        Acct_ExRec.Filter = adFilterNone
        Acct_ExRec.Filter = "AC_CODE='" & LPartyCode & "' AND EXCODE='" & MExCode & "'"
        If Acct_ExRec.EOF Then
            LClientCode = vbNullString
        Else
            LClientCode = IIf(IsNull(Acct_ExRec!ACEXCODE), vbNullString, Acct_ExRec!ACEXCODE)
        End If

        Do While LIInvNo = PartyRec!invno And LSaudaName = PartyRec!SAUDANAME
            DoEvents
            Label5.Caption = LPartyName & " " & LSaudaCode
            LContractAcc = vbNullString:
            Rec_ExMast.Filter = adFilterNone
            Rec_ExMast.MoveFirst
            Rec_ExMast.Filter = "EXCODE ='" & MExCode & "'"
            If Not Rec_ExMast.EOF Then
                LContractAcc = Rec_ExMast!CONTRACTACC
                LLotWise = Rec_ExMast!LOTWISE
            Else
                MsgBox "Invalid Exchange "
                Exit Sub
            End If
            LTradeableLot = PartyRec!TRADEABLELOT
            If MExCode = "NSE" And LLotWise = "Y" Then
                LCalval = PartyRec!TRADEABLELOT
            Else
                If MExCode = "MCX" And LLotWise = "Y" Then
                    LCalval = PartyRec!TRADEABLELOT
                Else
                    LCalval = PartyRec!lot
                End If
            End If

            LMarAmt = 0:        GSrvTax = 0:
            LTotStmAmt = 0:     LTotSTTAmt = 0:
            LRiskMAmt = 0:        LTotSEBITaxAmt = 0:   LSBCTaxAmt = 0

            DoEvents
            ''OPENING QNTY INSERTION
            GTrFees = 0:                GSTDChrs = 0:
            LBrokType = vbNullString:
            MTotBAmt = 0:   MTotSAmt = 0:               MTotOpAmt = 0
            OpQty = PartyRec!OpQty
            If OpQty <> 0 Then    ''FOR OPENING INSERTION
                MTotOpAmt = OpQty * PartyRec!OPRATE * LCalval
                AccRecSet.AddNew
                AccRecSet.Fields("RPTGRP") = 1:                     CountRec = CountRec + 1
                AccRecSet.Fields("SRNO") = CountRec:                AccRecSet.Fields("EXCODE") = MExCode:
                AccRecSet.Fields("BILLNO") = LBillNo:               AccRecSet.Fields("BILLDATE") = LStDate
                AccRecSet.Fields("SAUDACODE") = LSaudaCode:         AccRecSet.Fields("CONTDATE") = Format(PartyRec!Opendt, "yyyy/MM/dd"):
                AccRecSet.Fields("ITEMCODE") = LItemCode:
                AccRecSet.Fields("CALVAL") = LCalval:               AccRecSet.Fields("INVDATE") = Format(LIInvDate, "yyyy/MM/dd")
                AccRecSet.Fields("PrevBal") = MBal:                 AccRecSet.Fields("DEBITAMT") = Val(LDebitAmt)
                AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt):    AccRecSet.Fields("PATTAN") = "O"
                AccRecSet.Fields("REFLOT") = LRefLot:               AccRecSet.Fields("INVNO") = LIInvNo:
                If OpQty > 0 Then
                    AccRecSet.Fields("BQNTY") = Abs(Val(OpQty)):        AccRecSet.Fields("BRATE") = Val(PartyRec!OPRATE)
                    AccRecSet.Fields("SQNTY") = 0:                      AccRecSet.Fields("SRATE") = 0:
                    AccRecSet.Fields("CRAMOUNT") = 0:                   AccRecSet.Fields("DRAMOUNT") = Abs(Val(OpQty)) * Val(PartyRec!OPRATE)

                Else
                    AccRecSet.Fields("BQNTY") = 0:                      AccRecSet.Fields("BRATE") = 0
                    AccRecSet.Fields("DRAMOUNT") = 0:                   AccRecSet.Fields("SQNTY") = Abs(Val(OpQty)):
                    AccRecSet.Fields("SRATE") = Val(PartyRec!OPRATE):   AccRecSet.Fields("CRAMOUNT") = Abs(Val(OpQty)) * Val(PartyRec!OPRATE)
                End If
                Call Add_PartyDetails:                                  Call Add_OtherDetails
                AccRecSet.Fields("CLIENTCODE") = LClientCode
                AccRecSet.Fields("MATURITY") = Lmaturity
                AccRecSet.Fields("BILLDATE") = LStDate
                AccRecSet.Fields("WORDAMT") = LTitle
                AccRecSet.Update
            End If
            ''BOUGHT INSERTION
            Set TRec = Nothing: Set TRec = New ADODB.Recordset:
            mysql = "SELECT CONDATE,CONTYPE,CONNO,CONTIME,ROWNO1,BROKTYPE,BROKRATE,BROKRATE2,BROKQTY,BROKQTY2,QTY,RATE,PATTAN FROM CTR_D"
            mysql = mysql & " WHERE COMPCODE =" & GCompCode & " AND INVNO =" & LIInvNo & " AND PARTY='" & PartyRec!AC_CODE & "' AND SAUDA='" & PartyRec!Sauda & "' AND CONTYPE='B' AND PATTAN ='C' ORDER BY CONDATE,CONNO"
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            With TRec
                Do While Not TRec.EOF
                    LBrokType = IIf(IsNull(!broktype), "T", !broktype)
                    LBrokRate = Val(!brokrate & vbNullString):
                    If !PATTAN <> "C" Then
                        MTotOpAmt = MTotOpAmt + (!QTY * !Rate * LCalval)
                    Else
                        LBAmt = (!QTY * !Rate * LCalval)
                        MTotBAmt = MTotBAmt + LBAmt
                    End If
                    AccRecSet.AddNew
                    CountRec = CountRec + 1:
                    AccRecSet.Fields("SRNO") = CountRec:            AccRecSet.Fields("RPTGRP") = 1:
                    AccRecSet.Fields("BILLNO") = LBillNo:           AccRecSet.Fields("BILLDATE") = LStDate
                    AccRecSet.Fields("SAUDACODE") = LSaudaCode:     AccRecSet.Fields("CONTDATE") = Format(!Condate, "yyyy/MM/dd"):
                    AccRecSet.Fields("EXCODE") = MExCode:          AccRecSet.Fields("ITEMCODE") = LItemCode
                    AccRecSet.Fields("DRAMOUNT") = Val(!QTY * !Rate)
                    AccRecSet.Fields("BQNTY") = !QTY:               AccRecSet.Fields("BRATE") = Val(!Rate)
                    AccRecSet.Fields("CTYPE") = !CONTYPE:           AccRecSet.Fields("PATTAN") = !PATTAN
                    AccRecSet.Fields("CALVAL") = LCalval:           AccRecSet.Fields("INVDATE") = Format(LIInvDate, "yyyy/MM/dd")
                    AccRecSet.Fields("PrevBal") = MBal:             AccRecSet.Fields("BrokType") = LBrokType
                    AccRecSet.Fields("DEBITAMT") = LDebitAmt:       AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                    AccRecSet.Fields("CONNO") = !ROWNO1:
                    AccRecSet.Fields("BBROKAMT") = 0:               AccRecSet.Fields("REFLOT") = LRefLot
                    AccRecSet.Fields("SBROKAMT") = 0:               AccRecSet.Fields("MarRate") = 0
                    AccRecSet.Fields("BrokRate") = 0:               AccRecSet.Fields("CONTIME") = !contime
                    Call Add_PartyDetails:                          Call Add_OtherDetails
                    AccRecSet.Fields("CLIENTCODE") = LClientCode:   AccRecSet.Fields("INVNO") = LIInvNo:
                    AccRecSet.Fields("BILLDATE") = LStDate:         AccRecSet.Fields("WORDAMT") = LTitle
                    If !PATTAN = "C" Then AccRecSet.Fields("BrokRate") = Val(LBrokRate)
                    AccRecSet.Update
                    .MoveNext
                Loop
            End With
            ''END BOUGHT
            ''SOLD START
            Set TRec = Nothing: Set TRec = New ADODB.Recordset
            mysql = "SELECT CONDATE,CONTYPE,CONNO,CONTIME,ROWNO1,BROKTYPE,BROKRATE,BROKRATE2,BROKQTY,BROKQTY2,TRANTYPE,TRANRATE,STMRATE,SEBITAX,STTRATE,QTY,RATE,PATTAN,SRVTAX,SBC_TAX FROM CTR_D"
            mysql = mysql & " WHERE COMPCODE =" & GCompCode & " AND  INVNO  =" & LIInvNo & " AND PARTY='" & PartyRec!AC_CODE & "' AND SAUDA='" & PartyRec!Sauda & "' AND CONTYPE='S' AND PATTAN ='C' ORDER BY CONDATE,CONNO"
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            If Not TRec.EOF Then
                AccRecSet.Filter = adFilterNone
                AccRecSet.Sort = "SRNO ASC"
                AccRecSet.Filter = "BILLNO=" & LBillNo & " AND PARTYCODE='" & LPartyCode & "' And PATTAN ='C'"
                With TRec
                    Do While Not AccRecSet.EOF
                        LBrokType = IIf(IsNull(!broktype), "T", !broktype): LBrokRate = Val(!brokrate & vbNullString)
                        
                        If !PATTAN <> "C" Then
                             MTotOpAmt = MTotOpAmt - (!QTY * !Rate * LCalval)
                            AccRecSet.AddNew
                            CountRec = CountRec + 1
                            AccRecSet.Fields("RPTGRP") = 1:              AccRecSet.Fields("SHAREAMT") = 0
                            AccRecSet.Fields("SAUDACODE") = LSaudaCode:  AccRecSet.Fields("SAUDANAME") = LSaudaName
                            AccRecSet.Fields("BILLNO") = LBillNo:        AccRecSet.Fields("BILLDATE") = LStDate
                            AccRecSet.Fields("ITEMCODE") = LItemCode:    AccRecSet.Fields("ITEMNAME") = LItemName
                            AccRecSet.Fields("SQNTY") = !QTY:            AccRecSet.Fields("INVDATE") = Format(LIInvDate, "yyyy/MM/dd")
                            AccRecSet.Fields("SRATE") = !Rate:           AccRecSet.Fields("CTYPE") = !CONTYPE
                            AccRecSet.Fields("PATTAN") = !PATTAN:        AccRecSet.Fields("CRAMOUNT") = !QTY * !Rate
                            AccRecSet.Fields("CONTDATE") = vbNullString: AccRecSet.Fields("CONTDATE1") = Format(!Condate, "yyyy/MM/dd")
                            AccRecSet.Fields("SRNO") = CountRec:         AccRecSet.Fields("INVNO") = LIInvNo
                            AccRecSet.Fields("CALVAL") = LCalval:        AccRecSet.Fields("DEBITAMT") = LDebitAmt:
                            AccRecSet.Fields("PrevBal") = MBal:
                            AccRecSet.Fields("SCONNO") = !ROWNO1:        AccRecSet.Fields("TranRate") = Val(!brokrate)
                            AccRecSet.Fields("SCONTIME") = !contime:     AccRecSet.Fields("CREDITAMT") = LCreditAmt
                            AccRecSet.Fields("BROKERAGE") = 0:           AccRecSet.Fields("STANDING") = 0
                            AccRecSet.Fields("REFLOT") = LRefLot:        AccRecSet.Fields("TranType") = IIf(IsNull(!broktype), "T", !broktype)
                            Call Add_PartyDetails
                            AccRecSet.Fields("CLIENTCODE") = LClientCode
                            AccRecSet.Fields("WORDAMT") = LTitle
                            AccRecSet.Update
                        Else
                            LSAmt = !QTY * !Rate * LCalval
                            MTotSAmt = MTotSAmt + LSAmt
                            LcTranAmt = 0
                            AccRecSet.Fields("CONTDATE1") = Format(!Condate, "yyyy/MM/dd")
                            AccRecSet.Fields("SQNTY") = !QTY:    AccRecSet.Fields("SRate") = !Rate
                            AccRecSet.Fields("CRAMOUNT") = !QTY * !Rate
                            AccRecSet.Fields("SBROKAMT") = 0
                            AccRecSet.Fields("SCONNO") = !ROWNO1:      AccRecSet.Fields("SCONTIME") = !contime
                            AccRecSet.Fields("TRANTAX") = 0:              AccRecSet.Fields("TurnOverTax") = 0:
                             AccRecSet.Fields("SEBITAXAMT") = 0
                            AccRecSet.Update
                        End If
                        AccRecSet.MoveNext
                        'Service tax calculation **************
                        .MoveNext
                        If .EOF Then Exit Do
                    Loop
                    Do While Not .EOF
                        LBrokType = IIf(IsNull(!broktype), "T", !broktype):     LBrokRate = Val(!brokrate & ""):
                        If !PATTAN <> "C" Then
                             MTotOpAmt = MTotOpAmt - (!QTY * !Rate * LCalval)
                        Else
                            LSAmt = !QTY * !Rate * LCalval:
                            MTotSAmt = MTotSAmt + LSAmt:
                            LcTranAmt = 0
                        End If
                        AccRecSet.AddNew
                        AccRecSet.Fields("RPTGRP") = 1:                    AccRecSet.Fields("SHAREAMT") = 0
                        CountRec = CountRec + 1:                           AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode:        AccRecSet.Fields("EXCODE") = MExCode
                        AccRecSet.Fields("BILLNO") = LBillNo:              AccRecSet.Fields("BILLDATE") = LStDate
                        AccRecSet.Fields("ITEMCODE") = LItemCode:
                        AccRecSet.Fields("SQNTY") = !QTY:                  AccRecSet.Fields("SRATE") = !Rate:
                        AccRecSet.Fields("PATTAN") = !PATTAN:              AccRecSet.Fields("DRAMOUNT") = 0
                        AccRecSet.Fields("CRAMOUNT") = !QTY * !Rate:       AccRecSet.Fields("CONTDATE1") = Format(!Condate, "yyyy/MM/dd")
                        AccRecSet.Fields("PrevBal") = MBal:                AccRecSet.Fields("DEBITAMT") = LDebitAmt
                        AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt):
                        AccRecSet.Fields("CALVAL") = LCalval:              AccRecSet.Fields("INVDATE") = Format(LIInvDate, "yyyy/MM/dd"):
                        AccRecSet.Fields("TRANTAX") = 0:                   AccRecSet.Fields("BrokType") = LBrokType
                        AccRecSet.Fields("SCONNO") = !ROWNO1:
                        AccRecSet.Fields("SBROKAMT") = 0:          AccRecSet.Fields("REFLOT") = LRefLot
                        AccRecSet.Fields("CTYPE") = !CONTYPE:              AccRecSet.Fields("BRATE") = 0
                        AccRecSet.Fields("BBROKAMT") = 0:                  AccRecSet.Fields("INVNO") = LIInvNo:
                        AccRecSet.Fields("SCONTIME") = !contime
                        Call Add_PartyDetails
                        AccRecSet.Fields("CLIENTCODE") = LClientCode
                        AccRecSet.Fields("WORDAMT") = LTitle
                        AccRecSet.Update
                        .MoveNext
                    Loop
                End With
            End If
            Set TRec = Nothing
            ''END SOLD
            ''CLOSING CALC
            If MFormat = "Bill Summary" Or MFormat = "Bill Summary With Sharing" Or MFormat = "Account Statement Summary" Then  '
                If MTotOpAmt > 0 Then
                    MTotBAmt = MTotBAmt + MTotOpAmt
                Else
                    MTotSAmt = MTotSAmt + Abs(MTotOpAmt)
                End If
            End If
            MClQty = PartyRec!CLQTY * -1
            LMarAmt = 0
            
            ClRate1 = PartyRec!ClRate

            If PartyRec!STDATE < Lmaturity Then
                If MClQty <> 0 Then
                    LMarRate = 0: LMarType = "V"
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset      ''BROKERAGE CALCULATION
                    mysql = "SELECT MARTYPE,MARRATE FROM PITBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND AC_CODE='" & PartyRec!AC_CODE & "' "
                    mysql = mysql & " AND ITEMCODE='" & LItemCode & "'AND INSTTYPE ='" & LInstType & "' ORDER BY UPTOSTDT ": TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If TRec.EOF Then
                        Set TRec = Nothing: Set TRec = New ADODB.Recordset      ''BROKERAGE CALCULATION
                        mysql = "SELECT MARTYPE,MARRATE FROM PEXBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND AC_CODE='" & PartyRec!AC_CODE & "' "
                        mysql = mysql & " AND EXCODE ='" & MExCode & "'AND INSTTYPE ='" & LInstType & "' ORDER BY UPTOSTDT ":
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            LMarRate = 0: LMarType = "": LMarRate = 0:
                        Else
                            LMarType = IIf(IsNull(TRec!MARTYPE), "T", TRec!MARTYPE)
                            LMarRate = IIf(IsNull(TRec!MARRATE), 0, TRec!MARRATE)
                        End If
                    Else
                        TRec.MoveFirst
                        LMarType = IIf(IsNull(TRec!MARTYPE), "T", TRec!MARTYPE)
                        LMarRate = IIf(IsNull(TRec!MARRATE), 0, TRec!MARRATE)
                    End If
                    If Option1.Value = True Then
                        LMarAmt = Calc_Margin(LMarType, LMarRate, LSaudaCode, vcDTP2.Value, Abs(MClQty), ClRate1, PartyRec!AC_CODE, LCalval, LExCode)
                    End If ' OPTION 5
                End If ' MCLQTY
            End If 'maturity
            If PartyRec!AC_CODE = LContractAcc Then
                LMarAmt = LMarAmt * -1
            End If
            If LInstType = "FUT" Then
                If MClQty <> 0 And ClRate1 = 0 Then If MsgBox("Closing Rate missing for Sauda " & LSaudaName & " of date " & CStr(vcDTP2.Value), vbOKCancel) = vbCancel Then Exit Sub
            ElseIf LInstType = "OPT" Then
                If OptMTMChk.Value = 1 Then
                    If vcDTP2.Value < Lmaturity Then
                        If MClQty <> 0 And ClRate1 = 0 Then If MsgBox("Closing rate missing for Sauda " & LSaudaName & " of date " & CStr(vcDTP2.Value), vbOKCancel) = vbCancel Then Exit Sub
                    End If
                Else
                    MClQty = 0
                End If
            ElseIf LInstType = "CSH" Then
                If CshMTMchk.Value = 1 Then
                    If MClQty <> 0 And ClRate1 = 0 Then If MsgBox("Closing rate missing for Sauda " & LSaudaName & " of date " & CStr(vcDTP2.Value), vbOKCancel) = vbCancel Then Exit Sub
                Else
                    MClQty = 0
                End If
            End If
            MCLPattan = "B"
            If PartyRec!STDATE >= Lmaturity And MClQty <> 0 Then
                LBrokRate = 0:  LBrokType = "P":
                MCLPattan = "A":
            End If

            GTrFees = Val(PartyRec!TranAmt & vbNullString):                 LBrokAmt = Val(PartyRec!BROKAMT & vbNullString)
            LTotSEBITaxAmt = Val(PartyRec!SEBITaxAmt & vbNullString):       LRiskMAmt = Val(PartyRec!RISKMAMT & vbNullString)
            GSrvTax = Val(PartyRec!SRVAMT & vbNullString):                  LSBCTaxAmt = Val(PartyRec!SBC_TAX_AMt & vbNullString)
            LTotStmAmt = (-1) * Val(PartyRec!STampamt & vbNullString):      LTotSTTAmt = Val(PartyRec!STTTax & vbNullString)
            GSTDChrs = Val(PartyRec!STDAMT & vbNullString):                 LCGSTAmt = Val(PartyRec!cgstamt & vbNullString)
            LSGSTAmt = Val(PartyRec!SGSTAMT & vbNullString):                LIGSTAmt = Val(PartyRec!IGSTAMT & vbNullString)
            LUTTAmt = Val(PartyRec!UTTAMT & vbNullString)
            If MClQty <> 0 Then
                If MFormat = "Bill Summary" Or MFormat = "Bill Summary With Sharing" Or MFormat = "Account Statement Summary" Then      'Or MFORMAT = "Account Statement Summary"
                    LAMT = Abs(Val(MClQty)) * ClRate1 * LCalval
                    If MClQty > 0 Then
                        MTotSAmt = MTotSAmt + LAMT
                    Else
                        MTotBAmt = MTotBAmt + LAMT
                    End If
                End If
                ''END CLOSING
                If LInstType = "OPT" And OptMTMChk.Value = 0 Then
                    AccRecSet.Filter = 0
                    AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                    AccRecSet.Sort = "SRNO DESC"
                    If Not AccRecSet.EOF Then
                        AccRecSet.Fields("RPATTAN") = "C":                        AccRecSet.Fields("BROKERAGE") = Val(LBrokAmt):
                        AccRecSet.Fields("STANDING") = Val(GSTDChrs):             AccRecSet.Fields("TRFEES") = Val(GTrFees)
                        If LStmFlag = False Then
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt) + Val(LNStmAmt):
                            LStmFlag = True
                        Else
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt)
                        End If
                        AccRecSet.Fields("STTTax") = Val(LTotSTTAmt):                        AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt):
                        AccRecSet.Fields("SEBITAXAMT") = Val(LTotSEBITaxAmt):                AccRecSet.Fields("ServiceTax") = GSrvTax:
                        AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:                          AccRecSet.Fields("CGSTAMT") = LCGSTAmt:
                        AccRecSet.Fields("SGSTAMT") = LSGSTAmt:                              AccRecSet.Fields("IGSTAMT") = LIGSTAmt:
                        AccRecSet.Fields("UTTAMT") = LUTTAmt:                                AccRecSet.Fields("PrevBal") = MBal
                        AccRecSet.Fields("DEBITAMT") = LDebitAmt:                            AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                        AccRecSet.Fields("SHAREAMT") = Val(LShareAmt):                      AccRecSet.Update
                    End If
                ElseIf LInstType = "CSH" And CshMTMchk.Value = 0 Then
                    AccRecSet.Filter = 0
                    AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                    AccRecSet.Sort = "SRNO DESC"
                    If Not AccRecSet.EOF Then
                        AccRecSet.Fields("rpattan") = "C":                         AccRecSet.Fields("BROKERAGE") = Val(LBrokAmt):
                        AccRecSet.Fields("STANDING") = Val(GSTDChrs):              AccRecSet.Fields("TRFEES") = Val(GTrFees)
                        If LStmFlag = False Then
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt) + Val(LNStmAmt):
                            LStmFlag = True
                        Else
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt)
                        End If
                        AccRecSet.Fields("STTTax") = Val(LTotSTTAmt):                AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt):
                        AccRecSet.Fields("SEBITAXAMT") = Val(LTotSEBITaxAmt):        AccRecSet.Fields("ServiceTax") = GSrvTax:
                        AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:                  AccRecSet.Fields("PrevBal") = MBal
                        AccRecSet.Fields("DEBITAMT") = LDebitAmt:                    AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                        AccRecSet.Fields("SHAREAMT") = Val(LShareAmt):               AccRecSet.Fields("WORDAMT") = LTitle
                        AccRecSet.Fields("CGSTAMT") = LCGSTAmt:                      AccRecSet.Fields("SGSTAMT") = LSGSTAmt:
                        AccRecSet.Fields("IGSTAMT") = LIGSTAmt:                      AccRecSet.Fields("UTTAMT") = LUTTAmt:
                        AccRecSet.Update
                    End If
                Else
                    If MClQty > 0 Then
                        AccRecSet.AddNew
                        AccRecSet.Fields("RPTGRP") = 1
                        AccRecSet.Fields("SHAREAMT") = Val(LShareAmt)
                        CountRec = CountRec + 1
                        AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("CONTDATE") = Format(PartyRec!STDATE, "yyyy/MM/dd"):          AccRecSet.Fields("SAUDACODE") = LSaudaCode
                        AccRecSet.Fields("REFLOT") = LRefLot
                        AccRecSet.Fields("EXCODE") = MExCode:     AccRecSet.Fields("ITEMCODE") = LItemCode
                        Call Add_PartyDetails
                        AccRecSet.Fields("CLIENTCODE") = LClientCode:                     AccRecSet.Fields("ServiceTax") = GSrvTax
                        AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:                       AccRecSet.Fields("SQNTY") = Abs(Val(MClQty))
                        AccRecSet.Fields("SRATE") = ClRate1:                              AccRecSet.Fields("CTYPE") = "S"
                        AccRecSet.Fields("PATTAN") = MCLPattan:                           AccRecSet.Fields("DRAMOUNT") = 0
                        AccRecSet.Fields("CRAMOUNT") = Abs(Val(MClQty)) * ClRate1:        AccRecSet.Fields("BROKERAGE") = Val(LBrokAmt)
                        AccRecSet.Fields("STANDING") = Val(GSTDChrs)
                        If LStmFlag = False Then
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt) + Val(LNStmAmt):
                            LStmFlag = True
                        Else
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt)
                        End If
                        AccRecSet.Fields("STTTax") = Val(LTotSTTAmt):                   AccRecSet.Fields("SEBITAXAMT") = Val(LTotSEBITaxAmt):
                        AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt):                   AccRecSet.Fields("TRFEES") = Val(GTrFees & "")
                        AccRecSet.Fields("CGSTAMT") = LCGSTAmt:                         AccRecSet.Fields("SGSTAMT") = LSGSTAmt:
                        AccRecSet.Fields("IGSTAMT") = LIGSTAmt:                         AccRecSet.Fields("UTTAMT") = LUTTAmt:
                        AccRecSet.Fields("INVDATE") = Format(LIInvDate, "yyyy/MM/dd"):  AccRecSet.Fields("CALVAL") = LCalval
                        AccRecSet.Fields("PrevBal") = MBal:                             AccRecSet.Fields("DEBITAMT") = LDebitAmt
                        AccRecSet.Fields("CREDITAMT") = LCreditAmt:                     AccRecSet.Fields("CONTDATE1") = vbNullString:
                        AccRecSet.Fields("BRATE") = 0:                                  AccRecSet.Fields("INVNO") = LIInvNo
                        AccRecSet.Fields("BQNTY") = 0:                                  AccRecSet.Fields("ADDRESS") = vbNullString
                        AccRecSet.Fields("MarRate") = LMarRate:                         AccRecSet.Fields("MarAmt") = LMarAmt
                        AccRecSet.Fields("MarType") = LMarType:                         AccRecSet.Fields("CITY") = vbNullString:
                        AccRecSet.Fields("BBROKAMT") = 0:                               AccRecSet.Fields("SBROKAMT") = 0
                        AccRecSet.Fields("BILLNO") = LBillNo:                           AccRecSet.Fields("BILLDATE") = LStDate
                        AccRecSet.Fields("WORDAMT") = LTitle:                           AccRecSet.Update
                    Else
                        AccRecSet.AddNew
                        AccRecSet.Fields("RPTGRP") = 1:                                 AccRecSet.Fields("SHAREAMT") = Val(LShareAmt)
                        CountRec = CountRec + 1:                                        AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode:                     AccRecSet.Fields("EXCODE") = MExCode
                        AccRecSet.Fields("REFLOT") = LRefLot:                           AccRecSet.Fields("ITEMCODE") = LItemCode:
                        Call Add_PartyDetails
                        AccRecSet.Fields("CLIENTCODE") = LClientCode
                        AccRecSet.Fields("BQNTY") = Abs(Val(MClQty)):                   AccRecSet.Fields("BRATE") = ClRate1:
                        AccRecSet.Fields("CTYPE") = "B":                                AccRecSet.Fields("PATTAN") = MCLPattan
                        AccRecSet.Fields("DRAMOUNT") = Abs(Val(MClQty)) * ClRate1:      AccRecSet.Fields("BROKERAGE") = Val(LBrokAmt)
                        AccRecSet.Fields("STANDING") = Val(GSTDChrs):                   AccRecSet.Fields("TRFEES") = Val(GTrFees):
                        If LStmFlag = False Then
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt & "") + Val(LNStmAmt)
                            LStmFlag = True
                        Else
                            AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt & "")
                        End If
                        AccRecSet.Fields("STTTAX") = Val(LTotSTTAmt):                     AccRecSet.Fields("SEBITAXAMT") = Val(LTotSEBITaxAmt):
                        AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt):                         AccRecSet.Fields("INVDATE") = Format(LIInvDate, "yyyy/MM/dd")
                        AccRecSet.Fields("ServiceTax") = GSrvTax:                             AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                        AccRecSet.Fields("PrevBal") = MBal:                                   AccRecSet.Fields("DEBITAMT") = LDebitAmt
                        AccRecSet.Fields("CREDITAMT") = LCreditAmt:                           AccRecSet.Fields("BrokRate") = LBrokRate:
                        AccRecSet.Fields("CONTIME") = vbNullString:                           AccRecSet.Fields("CONNO") = vbNullString
                        AccRecSet.Fields("SQNTY") = 0:                                        AccRecSet.Fields("SRATE") = 0
                        AccRecSet.Fields("CONTDATE") = vbNullString:                          AccRecSet.Fields("MarRate") = LMarRate
                        AccRecSet.Fields("MarAmt") = LMarAmt:                                 AccRecSet.Fields("MarType") = LMarType
                        AccRecSet.Fields("INVNO") = LIInvNo:                                  AccRecSet.Fields("BBROKAMT") = 0
                        AccRecSet.Fields("SBROKAMT") = 0:                             AccRecSet.Fields("WORDAMT") = LTitle
                        AccRecSet.Fields("CGSTAMT") = LCGSTAmt:
                        AccRecSet.Fields("SGSTAMT") = LSGSTAmt:
                        AccRecSet.Fields("IGSTAMT") = LIGSTAmt:
                        AccRecSet.Fields("UTTAMT") = LUTTAmt:

                        AccRecSet.Fields("BILLNO") = LBillNo:                                 AccRecSet.Fields("BILLDATE") = LStDate
                        AccRecSet.Fields("CONTDATE1") = Format(vcDTP2.Value, "yyyy/MM/dd"):   AccRecSet.Fields("CALVAL") = LCalval
                        AccRecSet.Fields("BrokType") = LBrokType:                             AccRecSet.Update
                    End If
                    If Check5.Value = 1 Then
                        AccRecSet.AddNew
                        AccRecSet.Fields("SHAREAMT") = 0:                                     AccRecSet.Fields("RPTGRP") = 2
                        CountRec = CountRec + 1:                                              AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("CONTDATE") = Format(vcDTP2.Value, "yyyy/MM/dd"):    AccRecSet.Fields("SAUDACODE") = LSaudaCode
                        AccRecSet.Fields("EXCODE") = MExCode:                           AccRecSet.Fields("ITEMCODE") = LItemCode
                        AccRecSet.Fields("REFLOT") = LRefLot
                        Call Add_PartyDetails
                        AccRecSet.Fields("CLIENTCODE") = LClientCode
                        If MClQty > 0 Then
                            AccRecSet.Fields("BQNTY") = Abs(Val(MClQty)):                            AccRecSet.Fields("SQNTY") = 0
                        Else
                            AccRecSet.Fields("BQNTY") = 0:                                          AccRecSet.Fields("SQNTY") = Abs(Val(MClQty)):
                        End If
                        AccRecSet.Fields("SRATE") = ClRate1:                               AccRecSet.Fields("CTYPE") = "S"
                        AccRecSet.Fields("PATTAN") = MCLPattan:                            AccRecSet.Fields("DRAMOUNT") = 0
                        AccRecSet.Fields("CRAMOUNT") = 0:                                  AccRecSet.Fields("BROKERAGE") = 0
                        AccRecSet.Fields("STANDING") = 0:                                  AccRecSet.Fields("TurnOverTax") = 0
                        If LStmFlag = False Then LStmFlag = True
                        AccRecSet.Fields("STTTax") = 0:                                     AccRecSet.Fields("SEBITAXAMT") = 0
                        AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:                         AccRecSet.Fields("TRANTAX") = 0
                        AccRecSet.Fields("TRFEES") = 0:                                     AccRecSet.Fields("INVDATE") = Format(LIInvDate, "yyyy/MM/dd")
                        AccRecSet.Fields("CALVAL") = LCalval:                               AccRecSet.Fields("PrevBal") = 0
                        AccRecSet.Fields("DEBITAMT") = 0:                                   AccRecSet.Fields("CREDITAMT") = 0
                        AccRecSet.Fields("CONTDATE1") = vbNullString:                       AccRecSet.Fields("CITY") = vbNullString
                        AccRecSet.Fields("BRATE") = 0:                                      AccRecSet.Fields("INVNO") = LIInvNo
                        AccRecSet.Fields("COMPCODE") = 0:                                   AccRecSet.Fields("RPATTAN") = vbNullString
                        AccRecSet.Fields("BrokRate") = 0:                                   AccRecSet.Fields("BrokType") = vbNullString
                        AccRecSet.Fields("CONNO") = vbNullString:                           AccRecSet.Fields("CONTIME") = vbNullString
                        AccRecSet.Fields("MarRate") = 0:                                    AccRecSet.Fields("MarAmt") = 0
                        AccRecSet.Fields("MarType") = LMarType:                             AccRecSet.Fields("TranRate") = 0
                        AccRecSet.Fields("TranType") = LBrokType:                           AccRecSet.Fields("BILLNO") = LBillNo
                        AccRecSet.Fields("BILLDATE") = LStDate:                             AccRecSet.Fields("WORDAMT") = LTitle
                        AccRecSet.Fields("CGSTAMT") = LCGSTAmt:
                        AccRecSet.Fields("SGSTAMT") = LSGSTAmt:
                        AccRecSet.Fields("IGSTAMT") = LIGSTAmt:
                        AccRecSet.Fields("UTTAMT") = LUTTAmt:

                        AccRecSet.Update
                    End If
                End If
            Else
                AccRecSet.Filter = 0
                AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                AccRecSet.Sort = "SRNO DESC"
                If Not AccRecSet.EOF Then
                    AccRecSet.Fields("BROKERAGE") = Val(LBrokAmt):                         AccRecSet.Fields("STANDING") = Val(GSTDChrs)
                    AccRecSet.Fields("TRFEES") = Val(GTrFees)
                    If LStmFlag = False Then
                        AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt) + Val(LNStmAmt):
                        LStmFlag = True
                    Else
                        AccRecSet.Fields("TurnOverTax") = Val(LTotStmAmt)
                    End If
                    AccRecSet.Fields("SEBITAXAMT") = Val(LTotSEBITaxAmt):                  AccRecSet.Fields("STTTax") = Val(LTotSTTAmt)
                    AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt):                          AccRecSet.Fields("rpattan") = "C"
                    AccRecSet.Fields("ServiceTax") = GSrvTax:                              AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                    AccRecSet.Fields("PrevBal") = MBal:                                    AccRecSet.Fields("DEBITAMT") = LDebitAmt
                    AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt):                       AccRecSet.Fields("SHAREAMT") = Val(LShareAmt):
                    AccRecSet.Fields("WORDAMT") = LTitle:                                  AccRecSet.Fields("CGSTAMT") = LCGSTAmt:
                    AccRecSet.Fields("SGSTAMT") = LSGSTAmt:                                AccRecSet.Fields("IGSTAMT") = LIGSTAmt:
                    AccRecSet.Fields("UTTAMT") = LUTTAmt:                                  AccRecSet.Update
                End If
            End If
            ''END CLOSING
            PartyRec.MoveNext
            If PartyRec.EOF Then
                GoTo flag_party
            End If
        Loop
flag_party:
        If CreateChk.Value = 1 Then
            If PartyRec.EOF Then
                Call Client_Margin
                Call CreateReport(LPartyName)
            Else
                If LPartyCode <> PartyRec!AC_CODE Then
                    Call Client_Margin
                    Call CreateReport(LPartyName)
                    Call AccRecNew
                End If
            End If
        End If
    Loop
    Call Client_Margin
End Sub
'Sub Activity_Summary()
'    Dim TRec As ADODB.Recordset:        Dim SrNo As Long:               Dim LAC_CODE As String
'    Dim LastDate As Date:               Dim LAddNew As Boolean:         Dim BillRec As ADODB.Recordset
'    Dim LOpBal As Double:               Dim ExRec As ADODB.Recordset:   Dim LCExCode As String
'    Dim AccRec As ADODB.Recordset
'
'    On Error GoTo ERR1
'    Set AccRecSet = Nothing
'    Set AccRecSet = New ADODB.Recordset
'    AccRecSet.Fields.Append "CODE", adVarChar, 6, adFldIsNullable
'    AccRecSet.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
'    AccRecSet.Fields.Append "OPBAL", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
'    AccRecSet.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
'    AccRecSet.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
'    AccRecSet.Fields.Append "MATURITY", adDate, , adFldIsNullable
'    AccRecSet.Fields.Append "CLOSEQTY", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "CLOSERATE", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "DIFFAMT", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "BROKERAGE", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "STANDING", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "TRANFEES", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "SERVICETAX", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "SEBITaxAmt", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "RISKMTAX", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "SBCTaxAmt", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "CTTTax", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "STAMPDUTY", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "CGSTAMT", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "SGSTAMT", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "IGSTAMT", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "UTTAMT", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "BILLAMT", adDouble, , adFldIsNullable
'    AccRecSet.Fields.Append "MARGINAMT", adDouble, , adFldIsNullable  '0
'    AccRecSet.Fields.Append "INVNO", adInteger, , adFldIsNullable
'    AccRecSet.Fields.Append "INVDATE", adVarChar, 15, adFldIsNullable
'    AccRecSet.Open , , adOpenKeyset, adLockOptimistic
'
'    Me.MousePointer = Val(11): OkCmd.Enabled = False
'
'    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
'
'    Set AccRec = Nothing
'    Set AccRec = New ADODB.Recordset
'    Set ExRec = Nothing
'    Set ExRec = New ADODB.Recordset
'    MYSQL = "SELECT DISTINCT EXCODE FROM CTR_D WHERE COMPCODE =" & GCompCode & ""
'    If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND EXID IN (" & LSExCodes & ")"
'    If AllSaudas = False Then MYSQL = MYSQL & " AND SAUDAID IN (" & LSSaudas & ")"
'    If AllFmly = False And LenB(LSFmlyCodes) And AllParties = True > 0 Then
'        MYSQL = MYSQL & " AND PARTY IN (SELECT PARTY FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYCODE IN (" & LSFmlyCodes & "))"
'    End If
'    If AllParties = False And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND PARTY IN (" & LSParties & ")"
'    MYSQL = MYSQL & " ORDER BY EXCODE"
'    ExRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'
'    LastDate = vcDTP2.Value
'    MYSQL = "SELECT AC_CODE,NAME,OP_BAL FROM ACCOUNTM  WHERE COMPCODE=" & GCompCode & " AND AC_CODE IN (SELECT DISTINCT PARTY FROM CTR_D WHERE COMPCODE =" & GCompCode & ""
'    MYSQL = MYSQL & " AND SAUDA IN (SELECT DISTINCT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND MATURITY>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "')"
'    If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND EXID IN (" & LSExCodes & ")"
'    If AllSaudas = False Then MYSQL = MYSQL & " AND SAUDAID IN (" & LSSaudas & ")"
'    If AllFmly = False And LenB(LSFmlyCodes) And AllParties = True > 0 Then
'        MYSQL = MYSQL & " AND PARTY IN (SELECT PARTY FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYCODE IN (" & LSFmlyCodes & "))"
'    End If
'    If AllParties = False And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND PARTY IN (" & LSParties & ")"
'    MYSQL = MYSQL & " AND CONDATE <='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "') ORDER BY NAME"
'    AccRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'    Do While Not AccRec.EOF
'        LAC_CODE = AccRec!AC_CODE
'        LOpBal = AccRec!OP_BAL
'        LOpBal = LOpBal + Net_DrCr(LAC_CODE, vcDTP2.Value)
'        ExRec.MoveFirst
'        Do While Not ExRec.EOF
'            LCExCode = ExRec!EXCODE
'            MYSQL = "SELECT  TOP 1 STDATE FROM INV_D WHERE COMPCODE =" & GCompCode & " AND EXCODE ='" & LCExCode & "' AND STDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'ORDER BY STDATE DESC"
'            Set TRec = Nothing
'            Set TRec = New ADODB.Recordset
'            TRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'            If Not TRec.EOF Then LastDate = TRec!StDate
'            If LastDate = vcDTP2.Value Then
'                Set BillRec = Nothing
'                Set BillRec = New ADODB.Recordset
'                MYSQL = "SELECT EXCODE,SAUDA,SUM(DIFFAMT)AS TOTDIFF, SUM(BROKAMT)AS TOTBROK,SUM(TRANAMT)AS TOTTRAN,SUM(SRVAMT) AS TOTSRV,SUM(SEBITAXAMT) AS TOTSEBI,"
'                MYSQL = MYSQL & " SUM(CGSTAMT) AS TOTCGST,SUM(SGSTAMT) AS TOTSGST,SUM(IGSTAMT) AS TOTIGST,SUM(RISKMAMT)AS TOTRISKM,SUM(STTTAX) AS TOTSTT,SUM(STAMPAMT) AS TOTSTAMP"
'                MYSQL = MYSQL & " ,SUM(BILLAMT)AS TOTBILL FROM INV_D WHERE COMPCODE =" & GCompCode & "  AND PARTY = '" & LAC_CODE & "'AND EXCODE='" & LCExCode & "'"
'                If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND EXID IN (" & LSExCodes & ")"
'                If AllSaudas = False Then MYSQL = MYSQL & " AND SAUDAID IN (" & LSSaudas & ")"
'                If AllFmly = False And LenB(LSFmlyCodes) And AllParties = True > 0 Then
'                    MYSQL = MYSQL & " AND PARTY IN (SELECT PARTY FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYCODE IN (" & LSFmlyCodes & "))"
'                End If
'
'                If (AllParties = False Or AllFmly = False) And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND PARTY IN (" & LSParties & ")"
'                MYSQL = MYSQL & " AND STDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND STDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' GROUP BY EXCODE, SAUDA ORDER BY EXCODE,SAUDA"
'                BillRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'                Do While Not BillRec.EOF
'                    AccRecSet.AddNew
'                    MYSQL = "SELECT CLQTY,CLRATE FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY='" & LAC_CODE & "' AND SAUDA ='" & BillRec!Sauda & "' "
'                    MYSQL = MYSQL & "   AND STDATE ='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
'                    Set TRec = Nothing
'                    Set TRec = New ADODB.Recordset
'                    TRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'                    If Not TRec.EOF Then
'                        AccRecSet!CLOSEQTY = TRec!CLQTY * -1
'                        AccRecSet!CLOSERATE = TRec!ClRate
'                        If TRec!CLQTY <> 0 Then
'                            MYSQL = "SELECT AMOUNT FROM VCHAMT WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & LAC_CODE & "' AND CHEQUE_NO='I' AND DR_CR='D'"
'                            MYSQL = MYSQL & " AND VOU_DT='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' AND BANK_NAME ='" & BillRec!Sauda & "'"
'                            Set TRec = Nothing
'                            Set TRec = New ADODB.Recordset
'                            TRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'                            If Not TRec.EOF Then AccRecSet!MarginAmt = TRec!AMOUNT
'                        End If
'                    End If
'                    AccRecSet!Code = LAC_CODE:                          AccRecSet!NAME = AccRec!NAME
'                    AccRecSet!EXCODE = BillRec!EXCODE:                  AccRecSet!OPBAL = LOpBal
'                    AccRecSet!Sauda = BillRec!Sauda:                    AccRecSet!diffaMt = Val(BillRec!TOTDIFF & "")
'                    AccRecSet!BROKERAGE = Val(BillRec!TOTBROK & ""):    AccRecSet!TRANFEES = Val(BillRec!TOTTRAN & "")
'                    AccRecSet!servicetax = Val(BillRec!TOTSRV & ""):    AccRecSet!SEBITaxAmt = Val(BillRec!TOTSEBI)
'                    AccRecSet!RISKMTAX = Val(BillRec!TOTRISKM & ""):    AccRecSet!CTTTax = Val(BillRec!TOTSTT & "")
'                    AccRecSet!STAMPDUTY = Val(BillRec!TOTSTAMP & ""):   AccRecSet!CGSTAMT = BillRec!TOTCGST
'                    AccRecSet!SGSTAMT = BillRec!TOTSGST:                AccRecSet!IGSTAMT = BillRec!TOTIGST
'                    AccRecSet!BILLAMT = Val(BillRec!TOTBILL & ""):      AccRecSet.Update
'                    BillRec.MoveNext
'                Loop
'                MYSQL = "SELECT AMOUNT FROM VCHAMT WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & LAC_CODE & "' AND CHEQUE_NO='C' AND DR_CR='D' AND VOU_DT='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
'                MYSQL = MYSQL & " AND EXCODE ='" & LCExCode & "'"
'                Set TRec = Nothing
'                Set TRec = New ADODB.Recordset
'                TRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'                If Not TRec.EOF Then
'                    AccRecSet!MarginAmt = TRec!AMOUNT
'                    AccRecSet.Update
'                End If
'            Else
'                Set BillRec = Nothing
'                Set BillRec = New ADODB.Recordset
'                MYSQL = "SELECT EXCODE,SAUDA,CLQTY,CLRATE FROM INV_D WHERE COMPCODE =" & GCompCode & " AND PARTY = '" & LAC_CODE & "'AND EXCODE='" & LCExCode & "'"
'                If AllExcodes = False And LenB(LSExCodes) > 0 Then MYSQL = MYSQL & " AND EXID IN (" & LSExCodes & ")"
'                If AllSaudas = False Then MYSQL = MYSQL & " AND SAUDAID IN (" & LSSaudas & ")"
'                If (AllParties = False Or AllFmly = False) And LenB(LSParties) > 0 Then MYSQL = MYSQL & " AND PARTY IN (" & LSParties & ")"
'                MYSQL = MYSQL & " AND CLQTY<>0 AND STDATE ='" & Format(LastDate, "YYYY/MM/DD") & "'ORDER BY EXCODE,SAUDA"
'                BillRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'                Do While Not BillRec.EOF
'                    MYSQL = "SELECT AMOUNT FROM VCHAMT WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & LAC_CODE & "'"
'                    MYSQL = MYSQL & " AND CHEQUE_NO='I' AND DR_CR='D' AND VOU_DT='" & Format(LastDate, "YYYY/MM/DD") & "' AND BANK_NAME ='" & BillRec!Sauda & "'"
'                    Set TRec = Nothing
'                    Set TRec = New ADODB.Recordset
'                    TRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'                    If Not TRec.EOF Then AccRecSet!MarginAmt = TRec!AMOUNT
'                    AccRecSet.AddNew
'                    AccRecSet!Code = LAC_CODE:                  AccRecSet!NAME = AccRec!NAME
'                    AccRecSet!EXCODE = BillRec!EXCODE:          AccRecSet!OPBAL = LOpBal
'                    AccRecSet!Sauda = BillRec!Sauda:            AccRecSet!CLOSEQTY = BillRec!CLQTY * -1
'                    AccRecSet!CLOSERATE = BillRec!ClRate
'                    AccRecSet!diffaMt = 0:                      AccRecSet!BROKERAGE = 0
'                    AccRecSet!TRANFEES = 0:                     AccRecSet!servicetax = 0
'                    AccRecSet!SEBITaxAmt = 0:                   AccRecSet!RISKMTAX = 0
'                    AccRecSet!SBCTaxAmt = 0:                    AccRecSet!CTTTax = 0
'                    AccRecSet!STAMPDUTY = 0:                    AccRecSet!CGSTAMT = 0
'                    AccRecSet!SGSTAMT = 0:                      AccRecSet!IGSTAMT = 0
'                    AccRecSet!UTTAMT = 0:                       AccRecSet!BILLAMT = 0
'                    AccRecSet.Update
'                    BillRec.MoveNext
'                Loop
'                MYSQL = "SELECT AMOUNT FROM VCHAMT WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & LAC_CODE & "' AND CHEQUE_NO='C' AND DR_CR='D' AND VOU_DT='" & Format(LastDate, "YYYY/MM/DD") & "'"
'                MYSQL = MYSQL & " AND EXCODE ='" & LCExCode & "'"
'                Set TRec = Nothing
'                Set TRec = New ADODB.Recordset
'                TRec.Open MYSQL, Cnn, adOpenStatic, adLockReadOnly
'                If Not TRec.EOF Then
'                    AccRecSet!MarginAmt = TRec!AMOUNT
'                    AccRecSet.Update
'                End If
'            End If
'            ExRec.MoveNext
'        Loop
'        AccRec.MoveNext
'    Loop
'    If Combo2.ListIndex = 0 Then
'        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Act_DETAIL.RPT", 1)
'    Else
'        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Act_SUMM.RPT", 1)
'    End If
'    RDCREPO.DiscardSavedData
'    RDCREPO.Database.SetDataSource AccRecSet
'    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
'    MYSQL = "'Activity Summary From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
'    RDCREPO.FormulaFields.GetItemByName("TITLE").text = MYSQL
'    CRViewer1.ZOrder
'    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
'    CRViewer1.Visible = True
'    CRViewer1.ReportSource = RDCREPO
'    CRViewer1.Zoom 1
'    CRViewer1.ViewReport
'    Me.MousePointer = 0: OkCmd.Enabled = True
'    Exit Sub
'ERR1:
'    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
'    Me.MousePointer = 0: OkCmd.Enabled = True
'
'End Sub
Sub TradeWise_STM()
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    Set AccRecSet = Nothing
    Set AccRecSet = New ADODB.Recordset
    AccRecSet.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "MATURITY", adDate, , adFldIsNullable
    AccRecSet.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    AccRecSet.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    AccRecSet.Fields.Append "PARTYNAME", adVarChar, 100, adFldIsNullable
    AccRecSet.Fields.Append "ADDRESS", adVarChar, 100, adFldIsNullable
    AccRecSet.Fields.Append "CITY", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "PIN", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "PHONEO", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "PHONER ", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "MOBILE", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "FAX", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "PANNO", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "GSTIN", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "CONNO", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "TRADENO", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "CONTIME", adVarChar, 50, adFldIsNullable
    AccRecSet.Fields.Append "CONTYPE", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "CONDATE", adDate, , adFldIsNullable
    AccRecSet.Fields.Append "CALVAL", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "QNTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "RATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "PATTAN", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "DRAMOUNT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CRAMOUNT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BrokRate", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BrokType", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "BROKERAGE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "TRANFEES", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SERVICETAX", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "STAMPDUTY", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CTTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "RISKMAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SEBITaxAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SBCTaxAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "IGSTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "UTTAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "MARRATE", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "MARAMT", adDouble, , adFldIsNullable  '0
    AccRecSet.Fields.Append "MARTYPE", adVarChar, 1, adFldIsNullable
    AccRecSet.Fields.Append "DEBITAMT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CreditAmt", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "REFLOT", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "PREVBAL", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "SRNO", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "RptGrp", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "CINNO", adVarChar, 10, adFldIsNullable
    AccRecSet.Fields.Append "BillNo", adDouble, , adFldIsNullable
    AccRecSet.Fields.Append "BILLDATE", adDate, , adFldIsNullable
    AccRecSet.Open , , adOpenKeyset, adLockOptimistic
    
    Set PartyRec = Nothing
    Set PartyRec = New ADODB.Recordset
    mysql = "SELECT DISTINCT A.ACCID,A.AC_CODE,A.NAME,A.OP_BAL,B.ADD1,B.CITY,B.PANNO,B.PIN,B.PHONEO,B.PHONER,B.FAX,B.MOBILE,B.PIN,B.SRTAXAPP,B.CTTTYPE,B.RISKMTYPE,B.APPLYON,C.SAUDA,S.SAUDAID, "
    mysql = mysql & " S.INSTTYPE,S.ITEMCODE,S.STRIKEPRICE,S.OPTTYPE,S.MATURITY,I.EXCHANGECODE,I.LOT,S.TRADEABLELOT,I.RISKMAPP,S.BROKLOT ,S.SAUDANAME,I.ITEMNAME,I.SCGROUP,B.SEBITYPE,S.REFLOT "
    mysql = mysql & " ,C.BILLNO,C.STDATE,C.FROMDATE,C.OPQTY,C.OPRATE,C.OPENDT,C.CLQTY,C.CLRATE,C.CUTQTY,C.CUTRATE,C.DIFFAMT,C.BROKAMT,C.STDAMT,C.TRANAMT,C.BILLAMT,C.SRVAMT,"
    mysql = mysql & " C.STAMPAMT, C.STTTAX, C.CTTAMT, RISKMAMT, C.SEBITAXAMT, C.SBC_TAX_AMT ,I.ITEMID FROM ACCOUNTM AS A, ACCOUNTD AS B, INV_D AS C, ITEMMAST AS I, SAUDAMAST AS S "
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID =B.ACCID AND  "
    mysql = mysql & " AND S.ITEMID =I.ITEMID AND S.MATURITY >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
    mysql = mysql & " AND A.ACCID  =C.ACCID  AND C.SAUDAID = S.SAUDAID"
    mysql = mysql & " AND C.STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND C.STDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND  A.AC_CODE  IN (" & LSParties & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    If AllSaudas = False Then mysql = mysql & " AND C.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " ORDER BY A.NAME,I.EXCHANGECODE,S.ITEMCODE,S.INSTTYPE,S.MATURITY,C.STDATE"
    
    PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If PartyRec.EOF Then
        MsgBox "No Records.", vbCritical:
        Frame2.Enabled = True
        PartyCmd.SetFocus: Exit Sub
    End If
    mysql = "SELECT CONTRACTACC,EXCODE,LOTWISE FROM EXMAST WHERE COMPCODE =" & GCompCode & " "
    Set Rec_ExMast = Nothing: Set Rec_ExMast = New ADODB.Recordset: Rec_ExMast.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    Call TradeWise_Statement
    If CreateChk.Value = 1 Then
        MsgBox "Files Exported Successfully"
    Else
        AccRecSet.Filter = adFilterNone
        If AccRecSet.RecordCount > 0 Then
            AccRecSet.Sort = "srno asc"
            AccRecSet.MoveFirst
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "TRADE_ACSTT.RPT", 1)
            mysql = "'Account Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
            RDCREPO.DiscardSavedData
            RDCREPO.Database.SetDataSource AccRecSet
            CRViewer1.ZOrder
            CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
            CRViewer1.Visible = True
            CRViewer1.ReportSource = RDCREPO
            CRViewer1.Zoom 1
            CRViewer1.ViewReport
        Else
            MsgBox "Record does not exists.", vbInformation
        End If
    End If
Me.MousePointer = 0
GETMAIN.ProgressBar1.Visible = False
OkCmd.Enabled = True
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub
Sub TradeWise_Statement()
Dim LBAmt As Double:            Dim LRefLot As Double:          Dim LSAmt As Double:            Dim lOpQty As Double
Dim MOpQty As Double:           Dim LCutQty As Double:          Dim LCUTRATE As Double:         Dim LCloseRate As Double
Dim LMarRate As Double:         Dim MClQty As Double:           Dim LBrokRate As Double:        Dim LBrokRate2 As Double:
Dim LBrokQty As Double:         Dim LCalval As Double:          Dim LStrike As Double:          Dim LBrokQty2 As Double:
Dim LInstType As String:        Dim LPartyCode As String:       Dim LBrokType As String:        Dim LExCode As String
Dim LMarType As String:         Dim LSaudaCode As String:       Dim LSInstType As String:       Dim LBrokLot  As Double
Dim MBal As Double:             Dim LBal As Double:             Dim MOpBal As Double
Dim LDebitAmt As Double:        Dim LCreditAmt As Double:       Dim LSDutyRate As Double:       Dim LSDutyPer As Double
Dim LMIRate  As Double:         Dim LMERate As Double:          Dim LMARate As Double:          Dim LAddLongRate As Double
Dim LOpenRate As Double:        Dim GSrvTax As Double:          Dim MItemCode As String:        Dim LATranType As String:
Dim LSBrokRate As Double:       Dim LSBrokRate2 As Double:      Dim LSDutyAmt As Double:        Dim LBrokAmount As Double
Dim LTranAmount As Double:      Dim LStmAmt As Double:          Dim LTotStmAmt As Double:       Dim LStmRate As Double
Dim LSTTAmt As Double:          Dim LTotSTTAmt As Double:       Dim LSTTRate As Double:         Dim LRiskMAmt  As Double:
Dim LSEBITaxAmt As Double:      Dim LTotSEBITaxAmt As Double:   Dim LSEBITax As Double:         Dim LSBCTaxAmt As Double
Dim LMarAmt As Double:          Dim LMinRate As Double:         Dim LNStmAmt As Double:         Dim LSGSTAmt As Double:
Dim MTotBQty As Double:         Dim MTotSQty As Double:         Dim GTrFees As Double:          Dim GSTDChrs As Double
Dim LIGSTAmt As Double:         Dim LUTTAmt As Double:          Dim OpQty As Double:            Dim LCINNo As String
Dim LCGSTAmt As Double:         Dim MTotBAmt As Double:         Dim MTotSAmt As Double:         Dim MTotOpAmt As Double
Dim MSrvTax As Double:          Dim LTranRate As Double:        Dim LCBrokAmt As Double:        Dim LcTranAmt   As Double
Dim LSBCTax As Double:          Dim LCGSTRate As Double:        Dim LSGSTRate As Double:        Dim LIGSTRate As Double:
Dim LUTTRate As Double:         Dim BROKAMT As Double:          Dim LShareAmt As Double:        Dim LAMT As Double:
Dim TotAmt As Double:           Dim ClRate As Double:           Dim LTradeableLot As Double:    Dim LAddShortRate As Double:
Dim GSrTaxApp As String:        Dim LCttType As String:         Dim LLotWise As String:         Dim LRiskMType As String:
Dim LSEBIType As String:        Dim LCGSTType As String:        Dim LSDutyType As String
Dim LIGSTType As String:        Dim LUTTType As String:         Dim LPStmType As String:        Dim LMType As String
Dim LRiskMApp As String:        Dim LMBrokType As String:       Dim LItemName As String:
Dim MCLPattan As String:        Dim LPartyName As String:       Dim LContractAcc As String:
Dim LPANNO As String:           Dim LPHoneo As String:          Dim LPhoneR As String:          Dim LFAX As String
Dim LItemCode As String:        Dim LMobile As String:          Dim LPIN As String:             Dim LSaudaName As String
Dim LStmFlag As Boolean:        Dim LOpFlag As Boolean:         Dim CountRec As Long:           Dim MExCode As String
Dim Lmaturity As Date:          Dim LInvDate As Date:           Dim LTitle As String:           Dim LSaudaID As Long
Dim LStDate  As Date:           Dim LBillNo As Long:            Dim LBIllAmt As Double:         Dim AccStAdoREC As ADODB.Recordset:
Dim TRec As ADODB.Recordset:    Dim LSGSTType As String:
Dim LACCID As Long
Dim LItemID As Integer
    Me.MousePointer = Val(11)
    Do While Not PartyRec.EOF ' party loop
        If LPartyCode <> PartyRec!AC_CODE Then
            LStmFlag = False
            LOpFlag = False
        End If
        LPartyCode = PartyRec!AC_CODE:        LPartyName = PartyRec!NAME
        GSrTaxApp = PartyRec!SRTAXAPP:        LCttType = PartyRec!CTTTYPE
        LRiskMType = PartyRec!RISKMTYPE:      LSEBIType = PartyRec!SEBITYPE
        LPStmType = IIf(IsNull(PartyRec!APPLYON), "X", PartyRec!APPLYON)
        LPANNO = Trim(IIf(IsNull(PartyRec!PANNO), "", PartyRec!PANNO))
        LPHoneo = Trim(IIf(IsNull(PartyRec!PhoneO), "", PartyRec!PhoneO))
        LPhoneR = Trim(IIf(IsNull(PartyRec!PhoneR), "", PartyRec!PhoneR))
        LFAX = Trim(IIf(IsNull(PartyRec!Fax), "", PartyRec!Fax))
        LMobile = Trim(IIf(IsNull(PartyRec!Mobile), "", PartyRec!Mobile))
        LPIN = Trim(IIf(IsNull(PartyRec!Pin), "", PartyRec!Pin))
        LStDate = PartyRec!STDATE:        LBillNo = PartyRec!BILLNO:        LBIllAmt = PartyRec!Billamt
        
        LTitle = "Account Statement From " & PartyRec!FROMDATE & " to " & PartyRec!STDATE & ""
        MBal = 0
       If (Option4.Value) Or (Option5.Value) Then
            MOpBal = PartyRec!OP_BAL: MBal = MOpBal
            LBal = 0:    LBal = Net_DrCr(PartyRec!AC_CODE, DateValue(PartyRec!FROMDATE))
            MBal = MBal + LBal
            
            If Option4.Value Then
                If Check4.Value = 1 Then
                    MBal = Get_Balance(PartyRec!AC_CODE)
                Else
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    mysql = "EXEC ACSUMVCHS " & GCompCode & ",'" & PartyRec!AC_CODE & "','" & Format(PartyRec!Opendt, "yyyy/MM/dd") & "','" & Format(PartyRec!STDATE, "yyyy/MM/dd") & "'"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then MBal = MBal + IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                End If
            ElseIf Option5.Value Then
                LDebitAmt = 0: LCreditAmt = 0
                mysql = "SELECT DR_CR,SUM(AMOUNT) AS AMT FROM VCHAMT WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & PartyRec!AC_CODE & "' AND VOU_DT>='" & Format(PartyRec!Opendt, "YYYY/MM/DD") & "' AND VOU_TYPE<>'S' AND VOU_DT<='" & Format(PartyRec!STDATE, "YYYY/MM/DD") & "' GROUP BY DR_CR"
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenDynamic, adLockReadOnly
                If Not TRec.EOF Then
                    If TRec!DR_CR = "C" Then LCreditAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    If TRec!DR_CR = "D" Then LDebitAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    TRec.MoveNext
                    If Not TRec.EOF Then
                        If TRec!DR_CR = "C" Then LCreditAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                        If TRec!DR_CR = "D" Then LDebitAmt = IIf(IsNull(TRec!AMT), 0, TRec!AMT)
                    End If
                End If
            End If
        End If
        MExCode = PartyRec!EXCHANGECODE:        MItemCode = PartyRec!ITEMCODE
        LItemName = PartyRec!ITEMName:          LInstType = PartyRec!INSTTYPE
        LStrike = Val(PartyRec!STRIKEPRICE):    LSaudaCode = PartyRec!Sauda
        LSaudaName = PartyRec!SAUDANAME:        Lmaturity = PartyRec!MATURITY
        LBrokLot = IIf(IsNull(PartyRec!BROKLOT), 0, PartyRec!BROKLOT)
        LRefLot = IIf(IsNull(PartyRec!REFLOT), 1, PartyRec!REFLOT)
        LSaudaID = PartyRec!SAUDAID
        LItemID = PartyRec!itemid
        Do While LBillNo = PartyRec!BILLNO And LPartyCode = PartyRec!AC_CODE
            DoEvents
            Label5.Caption = LPartyName & " " & LSaudaCode
            LContractAcc = "":  LSDutyType = "P":
            LSDutyRate = 0:    LSDutyPer = 0:     LMType = "Q":
            LMIRate = 0: LMERate = 0: LMARate = 0: LAddLongRate = 0: LAddShortRate = 0:
            Rec_ExMast.Filter = adFilterNone
            Rec_ExMast.MoveFirst
            Rec_ExMast.Filter = "EXCODE ='" & MExCode & "'"
            If Not Rec_ExMast.EOF Then
                LContractAcc = Rec_ExMast!CONTRACTACC
                LLotWise = Rec_ExMast!LOTWISE
            Else
                MsgBox "Invalid Exchange "
                Exit Sub
            End If
           ' l 'ScGroup = IIf(IsNull(PartyRec!SCGROUP), "0", PartyRec!SCGROUP)
            LTradeableLot = PartyRec!TRADEABLELOT
            If MExCode = "NSE" And LLotWise = "Y" Then
                LCalval = PartyRec!TRADEABLELOT
            Else
                If MExCode = "MCX" And LLotWise = "Y" Then
                    LCalval = PartyRec!TRADEABLELOT
                Else
                    LCalval = PartyRec!lot
                End If
            End If
            LRiskMApp = PartyRec!RISKMAPP
            
            LRiskMAmt = 0
            LMBrokType = "P":   LSBrokRate = 0:     LSBrokRate2 = 0:        LStmAmt = 0:
            LSDutyAmt = 0:      LBrokAmount = 0:    GSrvTax = 0:            LTranAmount = 0
            LTotStmAmt = 0:     LStmRate = 0:       LSTTAmt = 0:            LTotSTTAmt = 0
            LRiskMAmt = 0:      LSEBITaxAmt = 0:    LTotSEBITaxAmt = 0:     LSEBITax = 0
            LMarAmt = 0:        LMinRate = 0:       LSTTRate = 0:           LSBCTaxAmt = 0
            DoEvents
            ''OPENING QNTY INSERTION
            MTotBQty = 0: MTotSQty = 0:   GTrFees = 0:     GSTDChrs = 0:   GTrFees = 0
            MOpQty = 0:   LBrokType = vbNullString:: LBrokRate2 = 0: LATranType = vbNullString
            MTotBAmt = 0: MTotSAmt = 0:   MTotOpAmt = 0
            OpQty = PartyRec!OpQty
            MClQty = PartyRec!CLQTY
            LCutQty = PartyRec!CutQty
            If LInstType = "FUT" Then
                If OpQty <> 0 Then    ''FOR OPENING INSERTION
                    MTotOpAmt = OpQty * PartyRec!OPRATE * LCalval
                    AccRecSet.AddNew:                                                       CountRec = CountRec + 1
                    AccRecSet.Fields("SRNO") = CountRec:                                    AccRecSet.Fields("BILLNO") = LBillNo
                    AccRecSet.Fields("BILLDATE") = Format(PartyRec!STDATE, "YYYY/MM/DD"):   AccRecSet.Fields("SAUDACODE") = LSaudaCode:
                    AccRecSet.Fields("CONDATE") = Format(PartyRec!Opendt, "yyyy/MM/dd"):    AccRecSet.Fields("REFLOT") = LRefLot
                    AccRecSet.Fields("ITEMCODE") = MItemCode:                               AccRecSet.Fields("CALVAL") = LCalval:       AccRecSet.Fields("MATURITY") = Format(Lmaturity, "yyyy/MM/dd")
                    AccRecSet.Fields("PrevBal") = MBal:                                     AccRecSet.Fields("DEBITAMT") = Val(LDebitAmt)
                    AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                    AccRecSet.Fields("PATTAN") = "O"
                    If OpQty > 0 Then
                        AccRecSet.Fields("QNTY") = Abs(Val(OpQty)): AccRecSet.Fields("RATE") = Val(PartyRec!OPRATE)
                        AccRecSet.Fields("DRAMOUNT") = Abs(Val(OpQty)) * Val(PartyRec!OPRATE) * LCalval
                        AccRecSet.Fields("CONTYPE") = "B"
                    Else
                        AccRecSet.Fields("QNTY") = Abs(Val(OpQty)): AccRecSet.Fields("RATE") = Val(PartyRec!OPRATE):
                        AccRecSet.Fields("CRAMOUNT") = Abs(Val(OpQty)) * Val(PartyRec!OPRATE) * LCalval
                        AccRecSet.Fields("CONTYPE") = "S"
                    End If
                    Call Add_PartyDetails
                    AccRecSet.Fields("CONNO") = 0:                        AccRecSet.Fields("CONTIME") = ""
                    AccRecSet.Fields("BrokRate") = 0:                     AccRecSet.Fields("BrokType") = "P"
                    AccRecSet.Fields("MarRate") = 0:
                    AccRecSet.Update
                End If
            ElseIf LInstType = "OPT" Then
                If OptMTMChk.Value = 1 Then
                    If OpQty <> 0 Then    ''FOR OPENING INSERTION
                        MTotOpAmt = OpQty * ClRate * LCalval
                        AccRecSet.AddNew
                        AccRecSet.Fields("RPTGRP") = 1:                 CountRec = CountRec + 1:
                        AccRecSet.Fields("SRNO") = CountRec:            AccRecSet.Fields("BILLNO") = LBillNo
                        AccRecSet.Fields("BILLDATE") = Format(PartyRec!STDATE, "YYYY/MM/DD")
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode:     AccRecSet.Fields("CONTDATE") = Format(vcDTP1.Value - 1, "yyyy/MM/dd"):
                        AccRecSet.Fields("REFLOT") = LRefLot:           AccRecSet.Fields("ITEMCODE") = MItemCode
                        AccRecSet.Fields("ITEMNAME") = LItemName:       AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd")
                        AccRecSet.Fields("CALVAL") = LCalval:           AccRecSet.Fields("PrevBal") = MBal
                        AccRecSet.Fields("DEBITAMT") = Val(LDebitAmt):  AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                        AccRecSet.Fields("CONTIME") = "":               AccRecSet.Fields("PATTAN") = "O"
                        
                        If OpQty > 0 Then
                            AccRecSet.Fields("QNTY") = Abs(Val(OpQty)):                    AccRecSet.Fields("RATE") = Val(ClRate)
                            AccRecSet.Fields("DRAMOUNT") = Abs(Val(OpQty)) * Val(ClRate)
                            AccRecSet.Fields("CONTYPE") = "B"
                        Else
                            AccRecSet.Fields("CONTYPE") = "S"
                            AccRecSet.Fields("SQNTY") = Abs(Val(OpQty)): AccRecSet.Fields("SRATE") = Val(ClRate): AccRecSet.Fields("CRAMOUNT") = Abs(Val(OpQty)) * Val(ClRate)
                        End If
                        Call Add_PartyDetails
                        AccRecSet.Update
                    End If
                End If
            ElseIf LInstType = "CSH" Then
                If CshMTMchk.Value = 1 Then
                    If OpQty <> 0 Then    ''FOR OPENING INSERTION
                        MTotOpAmt = OpQty * ClRate * LCalval
                        AccRecSet.AddNew
                        AccRecSet.Fields("RPTGRP") = 1
                        CountRec = CountRec + 1:                       AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode:    AccRecSet.Fields("CONTDATE") = Format(vcDTP1.Value - 1, "yyyy/MM/dd")
                        AccRecSet.Fields("REFLOT") = LRefLot
                        AccRecSet.Fields("ITEMCODE") = MItemCode
                        AccRecSet.Fields("ITEMNAME") = LItemName:      AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd")
                        AccRecSet.Fields("CALVAL") = LCalval:          AccRecSet.Fields("PrevBal") = MBal
                        AccRecSet.Fields("DEBITAMT") = Val(LDebitAmt): AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                        AccRecSet.Fields("BILLNO") = LBillNo
                        AccRecSet.Fields("BILLDATE") = Format(PartyRec!STDATE, "YYYY/MM/DD")
                
                        If OpQty > 0 Then
                            AccRecSet.Fields("QNTY") = Abs(Val(OpQty)): AccRecSet.Fields("RATE") = Val(ClRate)
                            AccRecSet.Fields("DRAMOUNT") = Abs(Val(OpQty)) * Val(ClRate)
                            AccRecSet.Fields("CONTYPE") = "B"
                        Else
                            AccRecSet.Fields("QNTY") = Abs(Val(OpQty)): AccRecSet.Fields("RATE") = Val(ClRate): AccRecSet.Fields("CRAMOUNT") = Abs(Val(OpQty)) * Val(ClRate)
                            AccRecSet.Fields("CONTYPE") = "S"
                        End If
                        Call Add_PartyDetails
                        AccRecSet.Update
                    End If
                End If
            End If
            LRiskMAmt = 0
            LMBrokType = "P":   LSBrokRate = 0:     LSBrokRate2 = 0:        LSDutyAmt = 0:      LBrokAmount = 0:
            LTotStmAmt = 0:     LStmRate = 0:       LSTTAmt = 0:            LTotSTTAmt = 0:     LSTTRate = 0:
            LRiskMAmt = 0:      LSEBITaxAmt = 0:    LTotSEBITaxAmt = 0:     LSEBITax = 0:       LSBCTaxAmt = 0
            GSrvTax = 0:       LTranAmount = 0:     LStmAmt = 0:
            Set AccStAdoREC = Nothing: Set AccStAdoREC = New ADODB.Recordset
            'MYSQL = "EXEC AcSt " & GCompCode  & ",'" & Format(vcDTP2.Value, "yyyy/MM/dd") & "','" & LSaudaCode & "','" & LPartyCode & "'"
            mysql = "SELECT CONNO,CONTIME,CONTYPE,CONDATE,PATTAN,QTY,RATE,BROKTYPE,BROKRATE,BROKRATE2,BROKQTY,TRANRATE,TRANTYPE,BROKQTY2,STMRATE, "
            mysql = mysql & " SEBITAX,STTRATE,STMRATE,SRVTAX,SBC_TAX,CGSTRATE,SGSTRATE,IGSTRATE,UTTRATE,ROWNO1,BROKFLAG"
            mysql = mysql & " FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND SAUDA='" & LSaudaCode & "' AND PARTY ='" & LPartyCode & "' "
            mysql = mysql & " AND BILLNO =" & LBillNo & " AND PATTAN ='C'"
            mysql = mysql & " ORDER BY CONDATE,CONTIME"
            AccStAdoREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            LMarAmt = 0: LMinRate = 0
            DoEvents
            LNStmAmt = 0
            If LPStmType = "R" Or LPStmType = "P" Then If PartyRec!STDATE >= GSTMDate Then LNStmAmt = Get_StampDutyAmt(LPartyCode, PartyRec!FROMDATE, PartyRec!STDATE, LSExCodes)
            ''OPENING QNTY INSERTION
            MTotBQty = 0:   MTotSQty = 0:       GTrFees = 0:        GSTDChrs = 0:       GTrFees = 0
            MOpQty = 0:     LBrokType = vbNullString:     LBrokRate2 = 0:     LATranType = vbNullString
            LCGSTAmt = 0:   LSGSTAmt = 0:       LIGSTAmt = 0:       LUTTAmt = 0
            MTotBAmt = 0:   MTotSAmt = 0:       MTotOpAmt = 0:      MSrvTax = 0
            ''Trade INSERTION
            Set TRec = Nothing: Set TRec = New ADODB.Recordset: Set TRec = AccStAdoREC.Clone
            With TRec
                Do While Not .EOF
                    LBrokType = IIf(IsNull(!broktype), "T", !broktype)
                    LBrokRate2 = Val(!BROKRATE2 & ""): LBrokQty = IIf(IsNull(!BROKQTY), 0, !BROKQTY)
                    LBrokRate = Val(!brokrate & ""):   LBrokQty2 = IIf(IsNull(!BROKQTY2), 0, !BROKQTY2)
                    LTranRate = Val(!TRANRATE & ""):   LATranType = IIf(IsNull(!TRANTYPE), "T", !TRANTYPE)
                    If !Condate >= GSTMDate And (LPStmType = "R" Or LPStmType = "P") Then
                        LStmRate = 0
                    Else
                        LStmRate = Val(!STMRATE & "")
                    End If
                    LSEBITax = Val(!SEBITAX)
                    LSTTRate = Val(!STTRATE & "")
                    If !PATTAN <> "C" Then
                        MOpQty = MOpQty + !QTY: MTotOpAmt = MTotOpAmt + (!QTY * !Rate * LCalval)
                    Else
                        LStmAmt = ((LStmRate / 100) * !QTY * !Rate * LCalval): LTotStmAmt = LTotStmAmt + LStmAmt
                        LSTTAmt = 0
                        If LSTTRate <> 0 Then
                            LSTTAmt = ((LSTTRate / 100) * !QTY * !Rate * LCalval): LTotSTTAmt = LTotSTTAmt + LSTTAmt
                        End If
                        LSEBITaxAmt = ((LSEBITax / 100) * !QTY * !Rate * LCalval): LTotSEBITaxAmt = LTotSEBITaxAmt + LSEBITaxAmt
                        LCBrokAmt = 0: LcTranAmt = 0
                        If LBrokType = "Z" Then LBrokQty = GBrokLot
                        If LBrokType = "R" Then LBrokQty2 = GBrokLot
    
                        LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, LBrokQty, !QTY, !Rate, LCalval, LInstType, LStrike, LBrokQty2, LTradeableLot, "B", "2", TRec!itemid)
                        LBrokAmount = LBrokAmount + LCBrokAmt
                        If LATranType = "T" Then
                            LcTranAmt = LTranRate * !QTY: LTranAmount = LTranAmount + LcTranAmt
                        ElseIf LATranType = "P" Then
                            LcTranAmt = ((LTranRate / 100) * !QTY * !Rate * LCalval): LTranAmount = LTranAmount + LcTranAmt
                        ElseIf LATranType = "I" Then
                            LcTranAmt = ((LTranRate / 100) * LBrokQty * !Rate * LCalval): LTranAmount = LTranAmount + LcTranAmt
                        End If
                        If !CONTYPE = "B" Then
                            MTotBQty = MTotBQty + !QTY
                            LBAmt = (!QTY * !Rate * LCalval)
                        Else
                            MTotSQty = MTotSQty + !QTY
                            LSAmt = (!QTY * !Rate * LCalval)
                        End If
                        MTotBAmt = MTotBAmt + LBAmt
                        MTotSAmt = MTotSAmt + LSAmt
                        'Service tax calculation **************
                        MSrvTax = Val(!SRVTAX & ""):
                        LSBCTax = Val(!SBC_TAX & "")
                        GSrvTax = GSrvTax + (LCBrokAmt * MSrvTax) / 100
                        LCGSTRate = Val(!CGSTRATE):       LSGSTRate = Val(!SGSTRATE):       LIGSTRate = Val(!IGSTRATE):      LUTTRate = Val(!UTTRATE)
                        LSBCTaxAmt = (LCBrokAmt * LSBCTax) / 100
                        LCGSTAmt = LCGSTAmt + ((LCBrokAmt * LCGSTRate) / 100)
                        LSGSTAmt = LSGSTAmt + ((LCBrokAmt * LSGSTRate) / 100)
                        LIGSTAmt = LIGSTAmt + ((LCBrokAmt * LIGSTRate) / 100)
                        LUTTAmt = LUTTAmt + ((LCBrokAmt * LUTTRate) / 100)
                        If GSrStdYN = "Y" Then
                            If !Condate >= DateValue(GSrvDate) Then
                                GSrvTax = GSrvTax + (LcTranAmt * MSrvTax) / 100
                                LSBCTaxAmt = LSBCTaxAmt + (LcTranAmt * LSBCTax) / 100
                                LCGSTAmt = LCGSTAmt + ((LcTranAmt * LCGSTRate) / 100)
                                LSGSTAmt = LSGSTAmt + ((LcTranAmt * LSGSTRate) / 100)
                                LIGSTAmt = LIGSTAmt + ((LcTranAmt * LIGSTRate) / 100)
                                LUTTAmt = LUTTAmt + ((LcTranAmt * LUTTRate) / 100)
                            End If
                        End If
                    End If
                    AccRecSet.AddNew
                    CountRec = CountRec + 1:
                    AccRecSet.Fields("SRNO") = CountRec:            AccRecSet.Fields("RPTGRP") = 1:
                    AccRecSet.Fields("SAUDACODE") = LSaudaCode:     AccRecSet.Fields("CONDATE") = Format(!Condate, "yyyy/MM/dd"):
                    AccRecSet.Fields("REFLOT") = LRefLot:           AccRecSet.Fields("ITEMCODE") = MItemCode
                    AccRecSet.Fields("QNTY") = !QTY:             AccRecSet.Fields("RATE") = Val(!Rate)
                    AccRecSet.Fields("CONTYPE") = !CONTYPE:      AccRecSet.Fields("PATTAN") = !PATTAN
                    AccRecSet.Fields("CALVAL") = LCalval:           AccRecSet.Fields("MATURITY") = Format(Lmaturity, "yyyy/MM/dd")
                    AccRecSet.Fields("PREVBAL") = MBal:             AccRecSet.Fields("BrokType") = LBrokType
                    AccRecSet.Fields("DEBITAMT") = LDebitAmt:       AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                    AccRecSet.Fields("TRADENO") = !ROWNO1:
                    AccRecSet.Fields("BILLNO") = LBillNo
                    AccRecSet.Fields("BILLDATE") = Format(PartyRec!STDATE, "YYYY/MM/DD")
                    If !CONTYPE = "B" Then
                        AccRecSet.Fields("DRAMOUNT") = Val(!QTY * !Rate) * LCalval
                    Else
                        AccRecSet.Fields("CRAMOUNT") = Val(!QTY * !Rate) * LCalval
                    End If
                    AccRecSet.Fields("BROKERAGE") = (LCBrokAmt * -1):   AccRecSet!TRANFEES = LcTranAmt * -1
                    AccRecSet!servicetax = GSrvTax * -1::               AccRecSet!STAMPDUTY = LStmAmt * -1
                    AccRecSet!CTTAMT = LSTTAmt * -1:                    AccRecSet!RISKMAMT = 0
                    AccRecSet!SEBITaxAmt = LSEBITaxAmt * -1:            AccRecSet!SBCTaxAmt = LSBCTaxAmt * -1
                    AccRecSet!cgstamt = LCGSTAmt * -1:                  AccRecSet!SGSTAMT = LSGSTAmt * -1
                    AccRecSet!IGSTAMT = LIGSTAmt * -1:                  AccRecSet!UTTAMT = LUTTAmt * -1
                    AccRecSet.Fields("MarRate") = 0
                    If !PATTAN = "C" Then
                        AccRecSet.Fields("BrokRate") = Val(LBrokRate & "")
                    Else
                        AccRecSet.Fields("BrokRate") = 0
                    End If
                    AccRecSet.Fields("CONTIME") = !contime
                    Call Add_PartyDetails
                   ' Call Add_OtherDetails
                    AccRecSet.Update
                    .MoveNext
                Loop
            End With
            Set TRec = Nothing
                ''END BOUGHT
            LCBrokAmt = 0
            ''CLOSING CALC
            LCBrokAmt = 0: LSTTAmt = 0: LcTranAmt = 0: LSEBITaxAmt = 0: LSBCTaxAmt = 0
            LCGSTAmt = 0:                LSGSTAmt = 0:                LIGSTAmt = 0:                LUTTAmt = 0
            LMarAmt = 0
            LCloseRate = PartyRec!ClRate
            If PartyRec!STDATE < Lmaturity Then
                If MClQty <> 0 Then
                    LMarRate = 0: LMarType = "V"
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset      ''BROKERAGE CALCULATION
                    mysql = "SELECT TOP 1 MARTYPE,MARRATE FROM PITBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >= '" & Format(PartyRec!STDATE, "yyyy/MM/dd") & "' "
                    mysql = mysql & " AND AC_CODE='" & PartyRec!AC_CODE & "' AND ITEMCODE='" & MItemCode & "'AND INSTTYPE ='" & LInstType & "' ORDER BY UPTOSTDT ":
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If TRec.EOF Then
                        Set TRec = Nothing: Set TRec = New ADODB.Recordset      ''BROKERAGE CALCULATION
                        mysql = "SELECT TOP 1 MARTYPE,MARRATE FROM PEXBROK WHERE COMPCODE =" & GCompCode & " AND UPTOSTDT >= '" & Format(PartyRec!STDATE, "yyyy/MM/dd") & "' "
                        mysql = mysql & " AND AC_CODE='" & PartyRec!AC_CODE & "' AND EXCODE ='" & MExCode & "'AND INSTTYPE ='" & LInstType & "' ORDER BY UPTOSTDT ":
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            LMarRate = 0: LMarType = "": LMarRate = 0:
                            'GSTDRate = 0
                        Else
                            LMarType = IIf(IsNull(TRec!MARTYPE), "T", TRec!MARTYPE)
                            LMarRate = IIf(IsNull(TRec!MARRATE), 0, TRec!MARRATE)
                            
                        End If
                    Else
                        LMarType = IIf(IsNull(TRec!MARTYPE), "T", TRec!MARTYPE)
                        LMarRate = IIf(IsNull(TRec!MARRATE), 0, TRec!MARRATE)
                        
                    End If
                    If Option1.Value = True Then LMarAmt = Calc_Margin(LMarType, LMarRate, LSaudaCode, PartyRec!STDATE, Abs(MClQty), LCloseRate, PartyRec!AC_CODE, LCalval, LExCode)
                End If ' MCLQTY
            End If 'maturity
            If PartyRec!AC_CODE = LContractAcc Then LMarAmt = LMarAmt * -1
            If LInstType = "FUT" Then
                If MClQty <> 0 And LCloseRate = 0 Then If MsgBox("Closing Rate missing for Sauda " & LSaudaName & " of date " & CStr(PartyRec!STDATE), vbOKCancel) = vbCancel Then Exit Sub
            ElseIf LInstType = "OPT" Then
                If OptMTMChk.Value = 1 Then
                    If PartyRec!STDATE < Lmaturity Then
                        If MClQty <> 0 And LCloseRate = 0 Then If MsgBox("Closing rate missing for Sauda " & LSaudaName & " of date " & CStr(PartyRec!STDATE), vbOKCancel) = vbCancel Then Exit Sub
                    End If
                Else
                    MClQty = 0
                End If
            ElseIf LInstType = "CSH" Then
                If CshMTMchk.Value = 1 Then
                    If MClQty <> 0 And LCloseRate = 0 Then If MsgBox("Closing rate missing for Sauda " & LSaudaName & " of date " & CStr(PartyRec!STDATE), vbOKCancel) = vbCancel Then Exit Sub
                Else
                    MClQty = 0
                End If
            End If
            MCLPattan = "B"
            If PartyRec!STDATE >= Lmaturity And MClQty <> 0 Then
                LBrokRate = 0: LBrokType = "P": LATranType = "P": LTranRate = 0
                Set TRec = Nothing: Set TRec = New ADODB.Recordset   ''BROKERAGE CALCULATION
                mysql = "SELECT BROKTYPE,BROKRATE,BROKRATE2,TRANRATE,TRANTYPE,MINRATE,MBROKTYPE,MBROKRATE,MBROKRATE2 FROM PITBROK WHERE COMPCODE = " & GCompCode & " "
                mysql = mysql & "AND AC_CODE = '" & PartyRec!AC_CODE & "' AND ITEMCODE='" & MItemCode & "' AND UPTOSTDT>='" & Format(Lmaturity, "yyyy/MM/dd") & "' "
                mysql = mysql & " AND UPTOSTDT >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'AND INSTTYPE='" & LInstType & "' ORDER BY UPTOSTDT"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LBrokRate = TRec!brokrate:      LBrokType = TRec!broktype:
                    LBrokRate2 = TRec!BROKRATE2
                    LATranType = TRec!TRANTYPE:      LTranRate = TRec!TRANRATE:
                    LMinRate = TRec!MinRate:        LMBrokType = TRec!MBROKTYPE
                    LSBrokRate = TRec!MBROKRATE:    LSBrokRate2 = TRec!MBROKRATE2
                Else
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset   ''BROKERAGE CALCULATION
                    mysql = "SELECT BROKTYPE,BROKRATE,BROKRATE2,TRANRATE, TRANTYPE,MINRATE,MBROKTYPE,MBROKRATE,MBROKRATE2 FROM PexBROK WHERE COMPCODE = " & GCompCode & " "
                    mysql = mysql & "AND AC_CODE = '" & PartyRec!AC_CODE & "' AND EXCODE ='" & MExCode & "' AND UPTOSTDT>='" & Format(Lmaturity, "yyyy/MM/dd") & "' AND UPTOSTDT >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
                    mysql = mysql & " AND INSTTYPE='" & LInstType & "' ORDER BY UPTOSTDT"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LBrokRate = TRec!brokrate:      LBrokType = TRec!broktype:: LBrokRate2 = TRec!BROKRATE2
                        LATranType = TRec!TRANTYPE:      LTranRate = TRec!TRANRATE:
                    Else
                        LBrokRate = 0:      LBrokType = "P": LBrokRate2 = 0
                        LATranType = "P":      LTranRate = 0:
                    End If
                End If
                MSrvTax = 0
                If GSrTaxApp = "1" Then
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    TRec.Open "SELECT SERVICETAX,SBC_TAX,STCTAX,CGSTRATE,SGSTRATE,IGSTRATE,UTTRATE  FROM EXTAX WHERE COMPCODE =" & GCompCode & " AND EXCHANGECODE = '" & MExCode & "' AND FROMdt <='" & Format(Lmaturity, "YYYY/MM/DD") & "' And TODT >='" & Format(Lmaturity, "YYYY/MM/DD") & "'", Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        MSrvTax = Val(TRec!servicetax & "")
                        LSBCTax = Val(TRec!SBC_TAX & "")
                        LCGSTRate = Val(TRec!CGSTRATE):       LSGSTRate = Val(TRec!SGSTRATE):       LIGSTRate = Val(TRec!IGSTRATE):
                        LUTTRate = Val(TRec!UTTRATE):         LSEBITax = Val(TRec!STCTAX)
                    Else
                        MSrvTax = 0:    LSBCTax = 0:        LCGSTRate = 0:
                        LSGSTRate = 0:  LIGSTRate = 0:      LUTTRate = 0
                    End If
                End If
                Set TRec = Nothing
                MCLPattan = "A"
                LCBrokAmt = 0
                If LCloseRate <> 0 Then
                    LCBrokAmt = 0: LSTTAmt = 0: LcTranAmt = 0: LSEBITaxAmt = 0: LSBCTaxAmt = 0
                    LCGSTAmt = 0:                LSGSTAmt = 0:                LIGSTAmt = 0:                LUTTAmt = 0
                    LBrokQty = Abs(MClQty)
                    If LBrokType = "Z" Then LBrokQty = GBrokLot
                    If LBrokType = "R" Then LBrokQty2 = GBrokLot
                    If LBrokType = "O" Then
                        LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, 0, Abs(MClQty), LCloseRate, LCalval, LInstType, LStrike, 0, LTradeableLot, "B", "2", TRec!itemid)
                    ElseIf LBrokType = "R" And LCloseRate = 0 Then
                        LCBrokAmt = 0
                    Else
                        LCBrokAmt = Calc_Brokerage(LBrokType, LBrokRate, LBrokRate2, LBrokQty, Abs(MClQty), LCloseRate, LCalval, LInstType, LStrike, 0, LTradeableLot, "B", "2", TRec!itemid)
                    End If
                End If
                LBrokAmount = LBrokAmount + LCBrokAmt
                LSTTRate = 0
                LSTTAmt = ((LSTTRate / 100) * Abs(MClQty) * LCloseRate * LCalval): LTotSTTAmt = LTotSTTAmt + LSTTAmt
                LcTranAmt = 0
                If LATranType = "T" Then
                    LcTranAmt = LTranRate * Abs(MClQty): LTranAmount = LTranAmount + LcTranAmt
                ElseIf LATranType = "P" Then
                    LcTranAmt = ((LTranRate / 100) * Abs(MClQty) * LCloseRate * LCalval): LTranAmount = LTranAmount + LcTranAmt
                End If
                LSEBITaxAmt = ((LSEBITax / 100) * (Abs(MClQty) * LCloseRate * LCalval)):
                LTotSEBITaxAmt = LTotSEBITaxAmt + LSEBITaxAmt
                If LCGSTType = "1" Then LCGSTAmt = ((LCBrokAmt * LCGSTRate) / 100) + ((LcTranAmt * LCGSTRate) / 100)
                If LSGSTType = "1" Then LSGSTAmt = ((LCBrokAmt * LSGSTRate) / 100) + ((LcTranAmt * LSGSTRate) / 100)
                If LIGSTType = "1" Then LIGSTAmt = ((LCBrokAmt * LIGSTRate) / 100) + ((LcTranAmt * LIGSTRate) / 100)
                If LUTTType = "1" Then LUTTAmt = ((LCBrokAmt * LUTTRate) / 100) + ((LcTranAmt * LUTTRate) / 100)
                GSrvTax = GSrvTax + (LCBrokAmt * MSrvTax) / 100
                LSBCTaxAmt = LSBCTaxAmt + (LCBrokAmt * LSBCTax) / 100
                If GSrStdYN = "Y" Then
                    If Lmaturity >= DateValue(GSrvDate) Then
                        GSrvTax = GSrvTax + (LcTranAmt * MSrvTax) / 100
                        LSBCTaxAmt = LSBCTaxAmt + (LcTranAmt * LSBCTax) / 100
                        If LCGSTType = "1" Then LCGSTAmt = LCGSTAmt + ((LcTranAmt * LCGSTRate) / 100)
                        If LSGSTType = "1" Then LSGSTAmt = LSGSTAmt + ((LcTranAmt * LSGSTRate) / 100)
                        If LIGSTType = "1" Then LIGSTAmt = LIGSTAmt + ((LcTranAmt * LIGSTRate) / 100)
                        If LUTTType = "1" Then LUTTAmt = LUTTAmt + ((LcTranAmt * LUTTRate) / 100)
                    End If
                End If
            End If
            GSTDChrs = 0: GTrFees = 0: LSTTRate = 0: LSTTAmt = 0
            If GRoundOff = "Y" Then
                GTrFees = Round(LTranAmount) * (-1)
            Else
                GTrFees = LTranAmount * (-1)
            End If
            If GRoundOff = "Y" Then
                BROKAMT = Format(Round(LBrokAmount)) * (-1)
            Else
                BROKAMT = LBrokAmount * (-1)
            End If
            If GRoundOff = "Y" Then
                LTotSEBITaxAmt = Format(Round(LTotSEBITaxAmt)) * (-1)
            Else
                LTotSEBITaxAmt = LTotSEBITaxAmt * (-1)
            End If
            If LRiskMType <> "N" And LRiskMApp = "Y" Then LRiskMAmt = Calc_RiskMFees(LSaudaCode, MExCode, CStr(PartyRec!AC_CODE), vcDTP1.Value, PartyRec!STDATE, Lmaturity, LCalval, LItemID, LSaudaID, LACCID)
            LShareAmt = 0
            If Check4.Value = 1 Then LShareAmt = Calc_ShareAmt(LSaudaCode, PartyRec!AC_CODE, vcDTP1.Value, PartyRec!STDATE)
            If LRiskMType = "P" Then LRiskMAmt = LRiskMAmt * -1
            GSrvTax = GSrvTax + (MSrvTax / 100) * (LRiskMAmt * -1)
            LSBCTaxAmt = LSBCTaxAmt + ((LRiskMAmt * -1) * (LSBCTax / 100))
            LTotStmAmt = (-1) * LTotStmAmt
            LTotSTTAmt = (-1) * LTotSTTAmt
            If LCGSTType = "1" Then LCGSTAmt = LCGSTAmt + ((LRiskMAmt * -1 * LCGSTRate) / 100)
            If LSGSTType = "1" Then LSGSTAmt = LSGSTAmt + ((LRiskMAmt * -1 * LSGSTRate) / 100)
            If LIGSTType = "1" Then LIGSTAmt = LIGSTAmt + ((LRiskMAmt * -1 * LIGSTRate) / 100)
            If LUTTType = "1" Then LUTTAmt = LUTTAmt + ((LRiskMAmt * -1 * LUTTRate) / 100)

            LCGSTAmt = LCGSTAmt * -1
            LSGSTAmt = LSGSTAmt * -1
            LIGSTAmt = LIGSTAmt * -1
            LUTTAmt = LUTTAmt * -1

            GSrvTax = (-1) * GSrvTax
            LSBCTaxAmt = LSBCTaxAmt * -1
            If MClQty <> 0 Then
                If LInstType = "OPT" And OptMTMChk.Value = 0 Then
                    AccRecSet.Filter = 0
                    AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                    AccRecSet.Sort = "SRNO DESC"
                    If Not AccRecSet.EOF Then
                        AccRecSet.Fields("RPATTAN") = "C":                        AccRecSet.Fields("BROKERAGE") = Val(LCBrokAmt) * -1:
                        AccRecSet.Fields("TRFEES") = Val(LcTranAmt) * -1:         AccRecSet.Fields("STTTax") = Val(LSTTAmt) * -1
                        AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt) * -1:        AccRecSet.Fields("SEBITAXAMT") = Val(LSEBITaxAmt) * -1:
                        AccRecSet.Fields("ServiceTax") = GSrvTax * -1:            AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt * -1:
                        AccRecSet.Fields("PrevBal") = MBal:                       AccRecSet.Fields("DEBITAMT") = LDebitAmt
                        AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt):          AccRecSet.Fields("SHAREAMT") = Val(LShareAmt)
                        AccRecSet.Fields("CGSTAMT") = Val(LCGSTAmt):              AccRecSet.Fields("SGSTAMT") = Val(LSGSTAmt)
                        AccRecSet.Fields("IGSTAMT") = Val(LIGSTAmt):             AccRecSet.Fields("UTTAMT") = Val(LUTTAmt)
                        AccRecSet.Update
                    End If
                ElseIf LInstType = "CSH" And CshMTMchk.Value = 0 Then
                    AccRecSet.Filter = 0
                    AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                    AccRecSet.Sort = "SRNO DESC"
                    If Not AccRecSet.EOF Then
                        AccRecSet.Fields("rpattan") = "C":                        AccRecSet.Fields("BROKERAGE") = Val(BROKAMT):
                        AccRecSet.Fields("STANDING") = Val(GSTDChrs):             AccRecSet.Fields("TRFEES") = Val(GTrFees)
                        AccRecSet.Fields("STTTax") = Val(LTotSTTAmt):             AccRecSet.Fields("TRANTAX") = Val(LRiskMAmt):
                        AccRecSet.Fields("SEBITAXAMT") = Val(LTotSEBITaxAmt):     AccRecSet.Fields("ServiceTax") = GSrvTax:
                        AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:               AccRecSet.Fields("PrevBal") = MBal
                        AccRecSet.Fields("DEBITAMT") = LDebitAmt:                 AccRecSet.Fields("CREDITAMT") = Val(LCreditAmt)
                        AccRecSet.Fields("SHAREAMT") = Val(LShareAmt):            AccRecSet.Fields("CGSTAMT") = Val(LCGSTAmt)
                        AccRecSet.Fields("SGSTAMT") = Val(LSGSTAmt):              AccRecSet.Fields("IGSTAMT") = Val(LIGSTAmt)
                        AccRecSet.Fields("UTTAMT") = Val(LUTTAmt):               AccRecSet.Update
                    End If
                Else
                    If MClQty > 0 Then
                        AccRecSet.AddNew
                        AccRecSet.Fields("RPTGRP") = 1:                                         CountRec = CountRec + 1
                        AccRecSet.Fields("SRNO") = CountRec:                                    AccRecSet.Fields("CONDATE") = Format(PartyRec!STDATE, "yyyy/MM/dd"):
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode:                             AccRecSet.Fields("REFLOT") = LRefLot
                        AccRecSet.Fields("ITEMCODE") = MItemCode:                               Call Add_PartyDetails
                        AccRecSet.Fields("ServiceTax") = 0:                                     AccRecSet.Fields("SBCTAXAMT") = 0
                        AccRecSet.Fields("QNTY") = Abs(Val(MClQty)):                            AccRecSet.Fields("RATE") = LCloseRate
                        AccRecSet.Fields("CONTYPE") = "B":                                      AccRecSet.Fields("PATTAN") = MCLPattan:
                        AccRecSet.Fields("DRAMOUNT") = Abs(Val(MClQty)) * LCloseRate * LCalval: AccRecSet.Fields("CRAMOUNT") = 0
                        AccRecSet.Fields("BROKERAGE") = Val(LCBrokAmt & "") * -1:               AccRecSet.Fields("SEBITAXAMT") = Val(LSEBITaxAmt) * -1
                        AccRecSet.Fields("RISKMAMT") = Val(LRiskMAmt):                          AccRecSet.Fields("TRANFEES") = Val(LcTranAmt & "") * -1
                        AccRecSet.Fields("CALVAL") = LCalval:                                   AccRecSet.Fields("PREVBAL") = MBal
                        AccRecSet.Fields("DEBITAMT") = LDebitAmt:                               AccRecSet.Fields("CREDITAMT") = LCreditAmt
                        AccRecSet.Fields("CITY") = vbNullString:                                AccRecSet.Fields("ADDRESS") = vbNullString
                        AccRecSet.Fields("BrokRate") = 0:                                       AccRecSet.Fields("BrokType") = vbNullString
                        AccRecSet.Fields("CONNO") = 0:                                          AccRecSet.Fields("CONTIME") = vbNullString
                        AccRecSet.Fields("MarRate") = LMarRate:                                 AccRecSet.Fields("MarAmt") = LMarAmt
                        AccRecSet.Fields("MarType") = LMarType:                                 AccRecSet.Fields("CGSTAMT") = Val(LCGSTAmt)
                        AccRecSet.Fields("SGSTAMT") = Val(LSGSTAmt):                            AccRecSet.Fields("IGSTAMT") = Val(LIGSTAmt)
                        AccRecSet.Fields("UTTAMT") = Val(LUTTAmt):                             AccRecSet.Fields("BILLNO") = LBillNo
                        AccRecSet.Fields("BILLDATE") = Format(PartyRec!STDATE, "YYYY/MM/DD")
                        AccRecSet.Update
                    Else
                        AccRecSet.AddNew:                                       AccRecSet.Fields("RPTGRP") = 1
                        CountRec = CountRec + 1:                                AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("SAUDACODE") = LSaudaCode:             AccRecSet.Fields("CONDATE") = Format(PartyRec!STDATE, "yyyy/MM/dd")
                        AccRecSet.Fields("REFLOT") = LRefLot:                   AccRecSet.Fields("ITEMCODE") = MItemCode:
                        Call Add_PartyDetails
                        AccRecSet.Fields("QNTY") = Abs(Val(MClQty)):            AccRecSet.Fields("RATE") = LCloseRate:
                        AccRecSet.Fields("CONTYPE") = "S"::                     AccRecSet.Fields("PATTAN") = MCLPattan
                        AccRecSet.Fields("DRAMOUNT") = 0:                       AccRecSet.Fields("CRAMOUNT") = Abs(Val(MClQty)) * LCloseRate * LCalval:
                        AccRecSet.Fields("BROKERAGE") = Val(LCBrokAmt & ""):    AccRecSet.Fields("TRANFEES") = Val(LcTranAmt & "") * -1
                        AccRecSet.Fields("BILLNO") = LBillNo:                   AccRecSet.Fields("BILLDATE") = Format(PartyRec!STDATE, "YYYY/MM/DD")
                        AccRecSet.Fields("SEBITAXAMT") = Val(LSEBITaxAmt) * -1: AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:
                        AccRecSet.Fields("PREVBAL") = MBal:                     AccRecSet.Fields("DEBITAMT") = LDebitAmt
                        AccRecSet.Fields("CREDITAMT") = LCreditAmt:             AccRecSet.Fields("BrokRate") = LBrokRate
                        AccRecSet.Fields("BrokType") = LBrokType:               AccRecSet.Fields("CONTIME") = vbNullString
                        AccRecSet.Fields("CONNO") = 0:                          AccRecSet.Fields("MarRate") = LMarRate
                        AccRecSet.Fields("MarAmt") = LMarAmt:                   AccRecSet.Fields("MarType") = LMarType
                        AccRecSet.Fields("ADDRESS") = vbNullString:             AccRecSet.Fields("CITY") = vbNullString
                        AccRecSet.Fields("CGSTAMT") = Val(LCGSTAmt) * -1:       AccRecSet.Fields("SGSTAMT") = Val(LSGSTAmt) * -1
                        AccRecSet.Fields("IGSTAMT") = Val(LIGSTAmt) * -1:       AccRecSet.Fields("UTTAMT") = Val(LUTTAmt) * -1
                        AccRecSet.Update
                    End If
                    If Check5.Value = 1 Then
                        AccRecSet.AddNew
                        AccRecSet.Fields("SHAREAMT") = 0:                                       AccRecSet.Fields("RPTGRP") = 2
                        AccRecSet.Fields("BILLNO") = LBillNo:                                   AccRecSet.Fields("BILLDATE") = Format(PartyRec!STDATE, "YYYY/MM/DD")
                        CountRec = CountRec + 1:                                                AccRecSet.Fields("SRNO") = CountRec
                        AccRecSet.Fields("CONTDATE") = Format(PartyRec!STDATE, "yyyy/MM/dd"):   AccRecSet.Fields("SAUDACODE") = LSaudaCode
                        AccRecSet.Fields("SAUDANAME") = LSaudaName:                             AccRecSet.Fields("ITEMCODE") = MItemCode
                        AccRecSet.Fields("ITEMNAME") = LItemName:                               AccRecSet.Fields("REFLOT") = LRefLot
                        Call Add_PartyDetails
                        If MClQty > 0 Then
                            AccRecSet.Fields("BQNTY") = Abs(Val(MClQty)):              AccRecSet.Fields("SQNTY") = 0:
                        Else
                            AccRecSet.Fields("BQNTY") = 0:                             AccRecSet.Fields("SQNTY") = Abs(Val(MClQty)):
                        End If
                        AccRecSet.Fields("SRATE") = LCloseRate:                        AccRecSet.Fields("CTYPE") = "S"
                        AccRecSet.Fields("PATTAN") = MCLPattan:                        AccRecSet.Fields("DRAMOUNT") = 0
                        AccRecSet.Fields("CRAMOUNT") = 0:                              AccRecSet.Fields("BROKERAGE") = 0
                        AccRecSet.Fields("STANDING") = 0:                              AccRecSet.Fields("TurnOverTax") = 0
                        If LStmFlag = False Then LStmFlag = True
                        AccRecSet.Fields("STTTax") = 0:                               AccRecSet.Fields("SEBITAXAMT") = 0:
                        AccRecSet.Fields("SBCTAXAMT") = LSBCTaxAmt:                   AccRecSet.Fields("TRANTAX") = 0:
                        AccRecSet.Fields("TRFEES") = 0:                               AccRecSet.Fields("INVDATE") = Format(Lmaturity, "yyyy/MM/dd")
                        AccRecSet.Fields("CALVAL") = LCalval:                         AccRecSet.Fields("PrevBal") = MBal:
                        AccRecSet.Fields("DEBITAMT") = 0:                             AccRecSet.Fields("CREDITAMT") = 0:
                        AccRecSet.Fields("CONTDATE1") = vbNullString:                 AccRecSet.Fields("CITY") = vbNullString
                        AccRecSet.Fields("BRATE") = 0:                                AccRecSet.Fields("INVNO") = 0
                        AccRecSet.Fields("COMPCODE") = 0:                             AccRecSet.Fields("RPATTAN") = vbNullString
                        AccRecSet.Fields("BrokRate") = 0:                             AccRecSet.Fields("BrokType") = vbNullString
                        AccRecSet.Fields("CONNO") = 0:                                AccRecSet.Fields("CONTIME") = vbNullString
                        AccRecSet.Fields("MarRate") = 0:                              AccRecSet.Fields("MarAmt") = 0
                        AccRecSet.Fields("MarType") = LMarType:                       AccRecSet.Fields("TranRate") = 0
                        AccRecSet.Fields("TranType") = LBrokType:                     AccRecSet.Update
                    End If
                End If
            Else
                TotAmt = Abs(MTotBAmt) + Abs(MTotSAmt) + Abs(MTotOpAmt)
                AccRecSet.Filter = 0
                AccRecSet.Filter = "PARTYCODE='" & PartyRec!AC_CODE & "' AND SAUDACODE='" & LSaudaCode & "'"
                AccRecSet.Sort = "SRNO DESC"
                If Not AccRecSet.EOF Then
                    AccRecSet.Fields("PREVBAL") = MBal
                    AccRecSet.Update
                End If
            End If
            PartyRec.MoveNext
            If PartyRec.EOF Then GoTo flag_party
        Loop
flag_party:
    Loop
    Call Client_Margin
End Sub
Private Sub Billwise_ACC_STT_SMRY()
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    Set PartyRec = Nothing
    Set PartyRec = New ADODB.Recordset
    mysql = "SELECT   I.BILLNO,I.STDATE,I.EXCODE, I.ITEMCODE,I.SAUDA, I.CALVAL, I.PARTY, A.NAME, A.OP_BAL, I.OPQTY, I.OPRATE, I.TOTBQTY, I.TOTBAMT, I.TOTSQTY, I.TOTSAMT,"
    mysql = mysql & " I.CLQTY, I.CLRATE, I.DIFFAMT, I.BROKAMT, I.STDAMT, I.TRANAMT, I.SRVAMT, I.STAMPAMT, I.STTTAX, I.RISKMAMT, I.SEBITAXAMT, I.SBC_TAX_AMT,"
    mysql = mysql & " I.CGSTAMT, I.SGSTAMT, I.IGSTAMT, I.UTTAMT, I.BILLAMT"
    mysql = mysql & " FROM ACCOUNTM AS A, INV_D AS I "
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID = I.ACCID  "
    mysql = mysql & "  AND I.STDATE  >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND I.STDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ") "
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    If AllSaudas = False Then mysql = mysql & "  AND I.SAUDAID IN (" & LSSaudas & ") "
    mysql = mysql & " ORDER BY A.NAME,I.STDATE,I.EXCODE,I.ITEMCODE,I.SAUDA "
    PartyRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If PartyRec.EOF Then
        MsgBox "No Records.", vbCritical:
        Frame2.Enabled = True
        PartyCmd.SetFocus: Exit Sub
    End If
    mysql = "Bill wise Summary from " & vcDTP1.Value & " to " & vcDTP2.Value & " "
    If Combo2.ListIndex = 0 Then
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "BACCSTSMR.rpt", 1)
    Else
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "BACCSTSMRSUMM.rpt", 1)
    End If
    
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource PartyRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
Me.MousePointer = 0
GETMAIN.ProgressBar1.Visible = False
OkCmd.Enabled = True
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
    
End Sub
Sub RptAccSmrRec()
    Set RptAccSmr = Nothing
    Set RptAccSmr = New ADODB.Recordset
    RptAccSmr.Fields.Append "BILLNO", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "STDATE", adDate, , adFldIsNullable
    RptAccSmr.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    RptAccSmr.Fields.Append "ITEMCODE", adVarChar, 20, adFldIsNullable
    RptAccSmr.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    RptAccSmr.Fields.Append "CALVAL", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    RptAccSmr.Fields.Append "PARTYNAME", adVarChar, 100, adFldIsNullable
    RptAccSmr.Fields.Append "PrevBal", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "OPQTY", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "OPRATE", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "BQNTY", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "BAMT", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "SQNTY", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "SAMT", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "CLQTY", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "CLRATE ", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "DIFFAMT", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "BROKERAGE", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "STANDING", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "TRANFEES", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "SRVTAX", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "STAMPDUTY", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "CTTTax", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "RISKMAMT", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "SEBITaxAmt", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "SBCTaxAmt", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "CGSTAMT", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "SGSTAMT", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "IGSTAMT", adDouble, , adFldIsNullable
    RptAccSmr.Fields.Append "UTTAMT", adDouble, , adFldIsNullable
    RptAccSmr.Open , , adOpenKeyset, adLockOptimistic
End Sub

Public Sub Annual_Report()
    On Error GoTo err1
    Dim LParty As String:           Dim LItemCode  As String
    Dim LBROK As Boolean:           Dim InvRec  As ADODB.Recordset
    Dim LInstType   As String:      Dim RecRpt As ADODB.Recordset:    Dim TradeRec As ADODB.Recordset
    
    LSParties = Get_Parties:   LSExCodes = Get_ExCodes
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "PartyCode", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "Name", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "UCC", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PAN", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    RecRpt.Fields.Append "ITEMCODE", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SAUDACODE", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "INSTTYPE", adVarChar, 3, adFldIsNullable
    RecRpt.Fields.Append "BUYQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BUYAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SELLQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SELLAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BROK", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "RISKM", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CTT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SEBI", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CGST", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SGST", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "IGST", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "UTT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "STAMP", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "TRAN", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SRV", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SBC", adDouble, , adFldIsNullable
    RecRpt.Open , , adOpenKeyset, adLockOptimistic
    Set TradeRec = Nothing
    Set TradeRec = New ADODB.Recordset
    mysql = "SELECT A.AC_CODE, A.NAME, A.PANNO,A.UCC,B.EXCODE,B.ITEMCODE,B.INSTTYPE,CONTYPE, SUM(B.QTY) AS TQTY ,SUM(B.QTY*B.RATE*B.CALVAL) AS TAMT  FROM ACCOUNTD AS A, CTR_D AS B "
    mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND A.COMPCODE =B.COMPCODE AND A.ACCID = B.ACCID "
    mysql = mysql & "  AND B.CONDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND B.CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
    mysql = mysql & "  GROUP BY A.AC_CODE, A.NAME, A.PANNO,A.UCC,B.EXCODE,B.ITEMCODE,B.INSTTYPE,B.CONTYPE"
    mysql = mysql & "  ORDER BY A.NAME, B.EXCODE,B.ITEMCODE,B.INSTTYPE,B.CONTYPE"
    TradeRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    Do While Not TradeRec.EOF
        LParty = TradeRec!AC_CODE
        Do While LParty = TradeRec!AC_CODE
            LItemCode = TradeRec!ITEMCODE
            LInstType = TradeRec!INSTTYPE
            RecRpt.Filter = adFilterNone
            RecRpt.Filter = "PARTYCODE ='" & LParty & "' AND ITEMCODE ='" & LItemCode & "' AND INSTTYPE ='" & LInstType & "'"
            If RecRpt.EOF Then
                RecRpt.AddNew
                RecRpt!PARTYCODE = TradeRec!AC_CODE
                RecRpt!NAME = TradeRec!NAME
                RecRpt!PAN = TradeRec!PANNO & vbNullString
                RecRpt!UCC = TradeRec!UCC & vbNullString
                RecRpt!excode = TradeRec!excode
                RecRpt!ITEMCODE = TradeRec!ITEMCODE
                RecRpt!INSTTYPE = TradeRec!INSTTYPE
            End If
            If TradeRec!CONTYPE = "B" Then
                RecRpt!BUYQTY = TradeRec!TQTY
                RecRpt!BUYAMT = TradeRec!TAMT
            Else
                RecRpt!SELLQTY = TradeRec!TQTY
                RecRpt!SELLAMT = TradeRec!TAMT
            End If
            RecRpt!BROK = 0:            RecRpt!tran = 0:            RecRpt!SRV = 0:             RecRpt!RISKM = 0
            RecRpt!STAMP = 0:           RecRpt!CTT = 0:             RecRpt!CGST = 0:            RecRpt!SGST = 0
            RecRpt!IGST = 0:            RecRpt!UTT = 0:             RecRpt!SEBI = 0:            RecRpt!SBC = 0
            RecRpt.Update
            TradeRec.MoveNext
            If TradeRec.EOF Then Exit Do
        Loop
        Set InvRec = Nothing
        Set InvRec = New ADODB.Recordset
        mysql = "SELECT SUM(BROKAMT) AS TBROKAMT,SUM(TRANAMT) AS TTRANAMT,SUM(SRVAMT) AS TSRVAMT,SUM(STAMPAMT) AS TSTAMPAMT,SUM(RISKMAMT) AS TRISKMAMT,SUM(STTTAX) AS TCTTAMT  "
        mysql = mysql & ",SUM(CGSTAMT) AS TCGSTAMT,SUM(SGSTAMT) AS TSGSTAMT, SUM(IGSTAMT) AS TIGSTAMT,SUM(UTTAMT) AS TUTTAMT,SUM(SBC_TAX_AMT) AS TSBCAMT,SUM(SEBITAXAMT) AS TSEBIAMT  "
        mysql = mysql & " FROM INV_D WHERE COMPCODE =" & GCompCode & "  AND PARTY ='" & LParty & "'"
        mysql = mysql & "  AND STDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND STDATE  <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
        InvRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not InvRec.EOF Then
            RecRpt.Filter = adFilterNone
            RecRpt.Filter = "PARTYCODE ='" & LParty & "'"
            If Not RecRpt.EOF Then
                RecRpt!BROK = IIf(IsNull(InvRec!TBROKAMT), 0, InvRec!TBROKAMT)
                RecRpt!tran = IIf(IsNull(InvRec!TTRANAMT), 0, InvRec!TTRANAMT)
                RecRpt!SRV = IIf(IsNull(InvRec!TSRVAMT), 0, InvRec!TSRVAMT)
                RecRpt!RISKM = IIf(IsNull(InvRec!TRISKMAMT), 0, InvRec!TRISKMAMT)
                RecRpt!STAMP = IIf(IsNull(InvRec!TSTAMPAMT), 0, InvRec!TSTAMPAMT)
                RecRpt!CTT = IIf(IsNull(InvRec!TCTTAMT), 0, InvRec!TCTTAMT)
                RecRpt!CGST = IIf(IsNull(InvRec!TCGSTAMT), 0, InvRec!TCGSTAMT)
                RecRpt!SGST = IIf(IsNull(InvRec!TSGSTAMT), 0, InvRec!TSGSTAMT)
                RecRpt!IGST = IIf(IsNull(InvRec!TIGSTAMT), 0, InvRec!TIGSTAMT)
                RecRpt!UTT = IIf(IsNull(InvRec!TUTTAMT), 0, InvRec!TUTTAMT)
                RecRpt!SEBI = IIf(IsNull(InvRec!TSEBIAMT), 0, InvRec!TSEBIAMT)
                RecRpt!SBC = IIf(IsNull(InvRec!TSBCAMT), 0, InvRec!TSBCAMT)
                RecRpt.Update
            End If
        End If
        Set InvRec = Nothing
        If TradeRec.EOF Then Exit Do
    Loop
    RecRpt.Filter = adFilterNone
    If RecRpt.RecordCount > 1 Then RecRpt.MoveFirst
    mysql = "Annual Global Transaction Statement From " & vcDTP1.Value & " To " & vcDTP2.Value & ""
    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "AnnualReport.rpt", 1)
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource RecRpt
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
Me.MousePointer = 0
GETMAIN.ProgressBar1.Visible = False
OkCmd.Enabled = True
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    
    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
    
End Sub
Sub Branch_Share()
    On Error GoTo err1
    Dim MSauda As String:           Dim mparty As String:       Dim LItemCode As String:            Dim LFmlyName As String
    Dim TRec As ADODB.Recordset:    Dim LBrokAmt  As Double:    Dim LDiffAmt  As Double:            Dim LBIllAmt  As Double
    Dim LBrokShare As Double:       Dim LShareAmt As Double:    Dim LExCode As String:              Dim LFmlyCode As String
    Dim LAcCode As String:          Dim LBal As Double:         Dim LOpFlag  As Boolean:            Dim InvRec  As ADODB.Recordset: Dim InvContra  As ADODB.Recordset
    Dim LPtyBal As Double:          Dim LP_OpFlag As Boolean:   Dim LAMT As Double:                 Dim HCurrRate  As Double
    Dim lShareRate As Double:       Dim LCurrRate  As Double:   Dim LRateRec As ADODB.Recordset:    Dim CL_SHRate As Double
    Dim LClFmly As String:          Dim LFmlyHead As String:    Dim LContraName As String:          Dim LContraName_Temp As String
    Dim LSaudaID As Long
    Dim LExID As Integer
    Dim LClBal As Double:   Dim LSHAREPER As Double
    Dim LHeadID  As Long
    Dim LACCID As Long
    Dim LTOTQTY As Double: Dim LTURNOVER As Double
    
    Dim LCDiffAmt As Double
    Dim LCBrokAmt As Double
    Dim LCBIllAmt As Double
    Dim LCFmlyCode As String: Dim LcHeadID   As Long: Dim LcFmlyHead As String: Dim LccontraID    As Long:
    Dim LCFMLYID As Long: Dim LFmlyID As Long
    
    LOpFlag = False
    LSHAREPER = 0
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:    LSExCodes = Get_ExCodes:    LSInst = Get_Inst
    LSFmlyIDs = Get_FmlyCodes
    
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    Set RecRpt = Nothing: Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "AcCode", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "AcName", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "SaudaName", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "EXCODE", adVarChar, 20, adFldIsNullable
    RecRpt.Fields.Append "DIFFAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BrokAmt", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BILLAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BROKSHARE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SHAREAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "FmlyName", adVarChar, 200, adFldIsNullable
    RecRpt.Fields.Append "FmlyBal", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "PartyBal", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SHARE_RATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "USDINR", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "FMLYCLBAL", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "FMLYCODE", adVarChar, 10, adFldIsNullable
    '>>>NEW
    RecRpt.Fields.Append "SHAREPER", adDouble, , adFldIsNullable
    '>>>NEW
    RecRpt.Fields.Append "TOTQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "TURNOVER", adDouble, , adFldIsNullable

    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    If Check4.Value = 1 Then
        Set LRateRec = Nothing
        Set LRateRec = New ADODB.Recordset
        mysql = "SELECT LOWRATE,HGRATE  FROM CTR_R WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' AND SAUDA ='USDINR'"
        LRateRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not LRateRec.EOF Then
            LCurrRate = LRateRec!LOWRATE
            HCurrRate = LRateRec!HGRATE
        End If
   End If

    
    If Check5.Value = 1 Then

        mysql = " SELECT F.FMLYID,F.FMLYHEAD,F.FMLYCODE,F.FMLYNAME,A.ACCID,A.AC_CODE,A.NAME,"
        If Check4 = 1 Then
            If GUniqClientId = "BRO2-CHE" Then
                mysql = mysql & " SUM(I.DIFFAMT*I.USDINR) AS DIFFAMT ,SUM(I.BROKAMT*I.CURRRATE) AS BROKAMT ,(SUM(I.DIFFAMT*I.USDINR)+SUM(I.BROKAMT*I.CURRRATE)) AS BILLAMT "
            Else
                mysql = mysql & " SUM(I.DIFFAMT*I.USDINR) AS DIFFAMT ,SUM(I.BROKAMT*I.USDINR) AS BROKAMT ,SUM(I.BILLAMT*I.USDINR) AS BILLAMT "
            End If
        Else
            mysql = mysql & " SUM(I.DIFFAMT) AS DIFFAMT ,SUM(I.BROKAMT) AS BROKAMT ,SUM(I.BILLAMT) AS BILLAMT "
        End If
        mysql = mysql & ",SUM(I.TOTBAMT+I.TOTSAMT) AS TURNOVER,SUM(I.TOTBQTY+I.TOTSQTY) AS TOTQTY "

        '>>>NEW
        mysql = mysql & ",ISNULL((select TOP 1 Z.SHRATE from PEXSBROK Z where Z.COMPCODE=" & GCompCode & "  AND UPTOSTDT >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND Z.EXID=I.EXID  AND Z.ACCID=A.ACCID AND ISNULL(Z.SHRATE,0)>0 ),0) AS 'SHAREPER' " '>>>AND Z.PARTY=F.FMLYHEAD
        
        mysql = mysql & " FROM ACCOUNTD AS A, ACCFMLY AS F , ACCFMLYD AS FD ,INV_D AS I"
        mysql = mysql & " WHERE A.COMPCODE = " & GCompCode & " "
        If LenB(LSFmlyIDs) > 0 Then mysql = mysql & " AND F.FMLYID IN (" & LSFmlyIDs & ")"
        If LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
        If LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
        mysql = mysql & " AND I.ACCID = A.ACCID"
        mysql = mysql & " AND F.FMLYID =FD.FMLYID AND  FD.ACCID =A.ACCID "
        mysql = mysql & " AND I.STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND I.STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'  "
        mysql = mysql & " GROUP BY F.FMLYID,F.FMLYHEAD,F.FMLYCODE,F.FMLYNAME,A.ACCID,A.AC_CODE,A.NAME "
        mysql = mysql & " ORDER BY F.FMLYHEAD,F.FMLYNAME,A.NAME"
        Set InvRec = Nothing: Set InvRec = New ADODB.Recordset
        InvRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        If Not InvRec.EOF Then
            Do While Not InvRec.EOF
                LFmlyCode = InvRec!FMLYCODE:                        LFmlyName = InvRec!FmlyNAME
                LFmlyHead = InvRec!FMLYHEAD:                        LAcCode = InvRec!AC_CODE:
                mparty = InvRec!NAME: LBrokAmt = InvRec!BROKAMT:
                LBIllAmt = InvRec!Billamt
                LBrokShare = 0:                                     LShareAmt = 0
                lShareRate = 0:                                     CL_SHRate = 0

                If Check4 = 1 Then
                    mysql = "SELECT SUM(AMOUNT*USDINR) AS BROKSHARE , SUM(SAMOUNT*USDINR) AS SHAREAMT FROM INV_D1 WHERE COMPCODE =" & GCompCode & " "
                Else
                    mysql = "SELECT SUM(AMOUNT) AS BROKSHARE , SUM(SAMOUNT) AS SHAREAMT FROM INV_D1 WHERE COMPCODE =" & GCompCode & " "
                End If
                mysql = mysql & " AND PARTY ='" & LAcCode & "' "
                mysql = mysql & " AND STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    LBrokShare = IIf(IsNull(TRec!BROKSHARE), 0, TRec!BROKSHARE)
                    LShareAmt = IIf(IsNull(TRec!SHAREAMT), 0, TRec!SHAREAMT)
                End If
                mysql = "SELECT SHRATE FROM PEXSBROK WHERE COMPCODE =" & GCompCode & " "
                mysql = mysql & " AND PARTY ='" & LAcCode & "' AND FMLYCODE ='" & LFmlyCode & "'"
                mysql = mysql & " AND UPTOSTDT >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    lShareRate = TRec!SHRATE
                End If
                mysql = "SELECT FMLYCODE FROM ACCFMLY WHERE COMPCODE =" & GCompCode & " "
                mysql = mysql & " AND FMLYHEAD ='" & LAcCode & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    LClFmly = TRec!FMLYCODE
                    mysql = "SELECT SHRATE FROM PEXSBROK WHERE COMPCODE =" & GCompCode & " "
                    mysql = mysql & " AND PARTY ='" & LAcCode & "' AND FMLYCODE ='" & LClFmly & "'"
                    mysql = mysql & " AND UPTOSTDT >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        CL_SHRate = TRec!SHRATE
                    End If
                End If
                RecRpt.AddNew:                  RecRpt!ACCODE = LAcCode
                RecRpt!ACNAME = mparty:         RecRpt!Billamt = LBIllAmt
                RecRpt!BROKSHARE = LBrokShare:  RecRpt!SHAREAMT = (LShareAmt * -1)
                RecRpt!FmlyNAME = LFmlyName:    RecRpt!SHARE_RATE = lShareRate
                If LBIllAmt > 0 Then
                    RecRpt!USDINR = LCurrRate
                Else
                    RecRpt!USDINR = HCurrRate
                End If
                'RecRpt!CL_SHRate = CL_SHRate
                '>>> NEW
                RecRpt!SHAREPER = InvRec!SHAREPER
                
                RecRpt.Update
                InvRec.MoveNext
            Loop
        End If
    Else
        Dim LFLAG As Boolean
        LFLAG = False
        If Combo1.ListIndex = 0 Then
            If Check4 = 1 Then
                If GUniqClientId = "BRO2-CHE" Then
                    mysql = " SELECT f.fmlyid,F.HEADID,F.CONTRAID,F.CONTRA_AC,(select Z.name from ACCOUNTD Z WITH(NOLOCK) where Z.COMPCODE=" & GCompCode & " AND Z.AC_CODE = F.CONTRA_AC) AS 'ContraName',F.FMLYID,F.FMLYHEAD,F.FMLYCODE,F.FMLYNAME,A.ACCID,A.AC_CODE,A.NAME,I.SAUDAID,I.SAUDA,I.EXID,I.EXCODE,SUM(I.DIFFAMT*I.USDINR) AS DIFFAMT ,SUM(I.BROKAMT*I.CURRRATE) AS BROKAMT ,(SUM(I.DIFFAMT*I.USDINR)+SUM(I.BROKAMT*I.CURRRATE)) AS BILLAMT  "
                Else
                    mysql = " SELECT f.fmlyid,F.HEADID,F.CONTRAID,F.CONTRA_AC,(select Z.name from ACCOUNTD Z WITH(NOLOCK) where Z.COMPCODE=" & GCompCode & " AND Z.AC_CODE = F.CONTRA_AC) AS 'ContraName',F.FMLYID,F.FMLYHEAD,F.FMLYCODE,F.FMLYNAME,A.ACCID,A.AC_CODE,A.NAME,I.SAUDAID,I.SAUDA,I.EXID,I.EXCODE,SUM(I.DIFFAMT*I.USDINR) AS DIFFAMT ,SUM(I.BROKAMT*I.USDINR) AS BROKAMT ,SUM(I.BILLAMT*I.USDINR) AS BILLAMT  "
                End If
            Else
                mysql = " SELECT f.fmlyid,F.HEADID,F.CONTRAID,F.CONTRA_AC,(select Z.name from ACCOUNTD Z WITH(NOLOCK) where Z.COMPCODE=" & GCompCode & " AND Z.AC_CODE = F.CONTRA_AC) AS 'ContraName',F.FMLYID,F.FMLYHEAD,F.FMLYCODE,F.FMLYNAME,A.ACCID,A.AC_CODE,A.NAME,I.SAUDAID,I.SAUDA,I.EXID,I.EXCODE,SUM(I.DIFFAMT) AS DIFFAMT ,SUM(I.BROKAMT) AS BROKAMT ,SUM(I.BILLAMT) AS BILLAMT  "
            End If
            mysql = mysql & ",SUM(I.TOTBAMT+I.TOTSAMT) AS TURNOVER,SUM(I.TOTBQTY+I.TOTSQTY) AS TOTQTY "
            '>>>NEW
            mysql = mysql & ",ISNULL((select TOP 1 Z.SHRATE from PEXSBROK Z where Z.COMPCODE=" & GCompCode & " AND UPTOSTDT >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND Z.EXID=I.EXID  and Z.ACCID=A.ACCID AND ISNULL(Z.SHRATE,0)<>0 ),0) AS 'SHAREPER' "
            mysql = mysql & " FROM ACCOUNTD AS A, ACCFMLY AS F , ACCFMLYD AS FD ,INV_D AS I"
            mysql = mysql & " WHERE A.COMPCODE = " & GCompCode & "  "
            If LenB(LSFmlyIDs) > 0 Then mysql = mysql & " AND F.FMLYID IN (" & LSFmlyIDs & ")"
            If LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
            If LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
            mysql = mysql & " And I.ACCID  = A.ACCID"
            mysql = mysql & " AND F.FMLYID =FD.FMLYID AND FD.ACCID=A.ACCID "
            mysql = mysql & " AND I.STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND I.STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'  "
            mysql = mysql & " GROUP BY f.fmlyid,F.HEADID,F.CONTRAID,F.CONTRA_AC,F.FMLYID,F.FMLYHEAD,F.FMLYCODE,F.FMLYNAME,A.ACCID,A.AC_CODE,A.NAME,I.EXID,I.EXCODE,I.SAUDAID,I.SAUDA "
            mysql = mysql & " ORDER BY F.FMLYHEAD,F.FMLYNAME,A.NAME ,I.EXCODE,I.SAUDA"
            Set InvRec = Nothing: Set InvRec = New ADODB.Recordset
            InvRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        Else
            mysql = " SELECT f.fmlyid,F.FMLYHEAD,F.FMLYCODE,F.FMLYNAME, F.FMLYHEAD,F.CONTRA_AC,(select Z.name from ACCOUNTD Z WITH(NOLOCK) where Z.COMPCODE=" & GCompCode & " AND Z.AC_CODE = F.CONTRA_AC) AS 'ContraName',F.HEADID,F.CONTRAID,"
            If Check4 = 1 Then
                If GUniqClientId = "BRO2-CHE" Then
                    mysql = mysql & " A.ACCID,A.AC_CODE,A.NAME,I.EXID,I.EXCODE,SUM(I.DIFFAMT*I.USDINR) AS DIFFAMT ,SUM(I.BROKAMT*I.CURRRATE) AS BROKAMT ,(SUM(I.DIFFAMT*I.USDINR)+sum(I.BROKAMT*I.CURRRATE)) AS BILLAMT "
                Else
                    mysql = mysql & " A.ACCID,A.AC_CODE,A.NAME,I.EXID,I.EXCODE,SUM(I.DIFFAMT*I.USDINR) AS DIFFAMT ,SUM(I.BROKAMT*I.USDINR) AS BROKAMT ,SUM(I.BILLAMT*I.USDINR) AS BILLAMT "
                End If
            Else
                mysql = mysql & " A.ACCID,A.AC_CODE,A.NAME,I.EXID,I.EXCODE,SUM(I.DIFFAMT) AS DIFFAMT ,SUM(I.BROKAMT) AS BROKAMT ,SUM(I.BILLAMT) AS BILLAMT "
            End If
            mysql = mysql & ",SUM(I.TOTBAMT+I.TOTSAMT) AS TURNOVER,SUM(I.TOTBQTY+I.TOTSQTY) AS TOTQTY "
            '>>>NEW
            mysql = mysql & ",ISNULL((select TOP 1 Z.SHRATE from PEXSBROK Z where Z.COMPCODE=" & GCompCode & " AND Z.ACCID=A.ACCID AND UPTOSTDT >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND Z.EXID=I.EXID AND Z.FMLYID=F.FMLYID AND ISNULL(Z.SHRATE,0)<>0 ),0) AS 'SHAREPER' " '<<<AND Z.PARTY=F.FMLYHEAD "
           
            mysql = mysql & " FROM ACCOUNTD AS A, ACCFMLY AS F, ACCFMLYD AS FD ,INV_D AS I"
            mysql = mysql & " WHERE A.COMPCODE = " & GCompCode & " "
            If LenB(LSFmlyIDs) > 0 Then mysql = mysql & " AND F.FMLYID IN (" & LSFmlyIDs & ")"
            If LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
            If LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
            mysql = mysql & " And I.ACCID  = A.ACCID "
            mysql = mysql & " AND F.FMLYID =FD.FMLYID AND FD.ACCID = A.ACCID"
            mysql = mysql & " AND I.STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND I.STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'  "
            mysql = mysql & " GROUP BY f.fmlyid,F.FMLYHEAD,F.FMLYCODE,F.FMLYNAME, F.FMLYHEAD,F.CONTRA_AC,F.HEADID,F.CONTRAID, A.ACCID,A.AC_CODE,A.NAME,I.EXCODE,I.EXID"
            mysql = mysql & " ORDER BY F.FMLYHEAD,F.FMLYNAME,A.NAME ,I.EXCODE"
            Set InvRec = Nothing: Set InvRec = New ADODB.Recordset
            InvRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        End If
        If Not InvRec.EOF Then
            LContraName_Temp = ""
            Dim LCflag As Boolean
            
            Do While Not InvRec.EOF
                LFmlyCode = InvRec!FMLYCODE
                LFmlyName = InvRec!FmlyNAME
                LHeadID = InvRec!HEADID
                LACCID = InvRec!ACCID
                LFmlyHead = InvRec!FMLYHEAD:
                If Not IsNull(InvRec!CONTRAname) Then
                    LContraName = InvRec!CONTRAname '>>> NEW 09OCT2021
                Else
                    LContraName = ""
                End If
                LCflag = False
                '>>>New
                If Combo1.ListIndex = 0 Then '>>> detail
                    
                    If LContraName_Temp <> "" Then
                        If InStr(1, LContraName_Temp, "," & LContraName) > 0 Then
                            GoTo nxt1
                        End If
                    End If
                    
                    If (LContraName_Temp = "") Then
                        LContraName_Temp = "," & LContraName
                    Else
                        LContraName_Temp = LContraName_Temp & "," & LContraName
                    End If
                    If Check11 = 1 Then
                    LCDiffAmt = 0
                    LCBrokAmt = 0
                    LCBIllAmt = 0
                    If Check4 = 1 Then
                        mysql = "select I.SAUDAID,I.SAUDA,isnull(SUM(I.DIFFAMT*I.USDINR),0) AS DIFFAMT ,isnull(SUM(I.BROKAMT*I.USDINR),0) AS BROKAMT ,isnull(SUM(I.BILLAMT*I.USDINR),0) AS BILLAMT "
                    Else
                        mysql = "select I.SAUDAID,I.SAUDA,isnull(SUM(I.DIFFAMT),0) AS DIFFAMT ,isnull(SUM(I.BROKAMT),0) AS BROKAMT ,isnull(SUM(I.BILLAMT),0) AS BILLAMT "
                    End If
                    mysql = mysql & "from inv_d I with(nolock) where I.party = '" & InvRec!Contra_Ac & "' and I.stdate >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' and I.stdate <= '" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' group by I.SAUDAID,I.SAUDA"
                    Set InvContra = Nothing: Set InvContra = New ADODB.Recordset
                    InvContra.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
                    While Not InvContra.EOF
                         If GRoundOff = "Y" Then
                                LCDiffAmt = Round(InvContra!DIFFAMT)
                                LCBrokAmt = Round(InvContra!BROKAMT)
                                LCBIllAmt = Round(InvContra!Billamt)
                          Else

                               LCDiffAmt = InvContra!DIFFAMT
                                LCBrokAmt = InvContra!BROKAMT
                                LCBIllAmt = InvContra!Billamt
                          End If
                                        
                        RecRpt.AddNew
                        RecRpt!ACCODE = InvRec!Contra_Ac
                        RecRpt!ACNAME = LContraName:     RecRpt!SAUDANAME = InvContra!Sauda
                        RecRpt!excode = LExCode:
                        If GRoundOff = "Y" Then
                        Else
                        RecRpt!DIFFAMT = LCDiffAmt
                        RecRpt!BROKAMT = LCBrokAmt
                        RecRpt!Billamt = LCBIllAmt
                        End If
                                                                                                            
                        RecRpt!BROKSHARE = 0
                        RecRpt!SHAREAMT = 0
                        RecRpt!FmlyNAME = LContraName:   RecRpt!FMLYBAL = 0
                        RecRpt!FMLYCLBAL = 0
                        RecRpt!FMLYCODE = Left(LContraName, 6)
                        RecRpt!PartyBal = 0
                        RecRpt!SHAREPER = 0
                        
                        RecRpt.Update
                        InvContra.MoveNext
                    Wend
                    End If
nxt1:
                End If
                '>>> end
                            
                LBal = Round(Get_ClosingBal(LHeadID, vcDTP1.Value - 1), 2)
                LClBal = Round(Get_ClosingBal(LHeadID, vcDTP2.Value), 2)
                
                '>>>NEW
                'LSHAREPER = InvRec!SHAREPER
                Do While LFmlyCode = InvRec!FMLYCODE
                    LAcCode = InvRec!AC_CODE:
                    
                    mparty = InvRec!NAME:
                    'LPtyBal = Round(Get_ClosingBal(LACCID, vcDTP1.Value - 1), 2)
                                                        
                    LP_OpFlag = False
                    Do While LAcCode = InvRec!AC_CODE And LFmlyCode = InvRec!FMLYCODE
                        If Combo1.ListIndex = 0 Then '>>> detail
                            MSauda = InvRec!Sauda:
                            LSaudaID = InvRec!SAUDAID
                        Else
                            MSauda = vbNullString
                        End If
                        LExID = InvRec!EXID
                        LExCode = InvRec!excode:
                        If GRoundOff = "Y" Then
                         LBrokAmt = Round(InvRec!BROKAMT)
                             LDiffAmt = Round(InvRec!DIFFAMT)
                               LBIllAmt = Round(InvRec!Billamt)
                        Else
                        
                             LBrokAmt = InvRec!BROKAMT:
                             LDiffAmt = InvRec!DIFFAMT
                               LBIllAmt = InvRec!Billamt
                       End If
                               
                               
                        LTOTQTY = InvRec!TotQty
                        LTURNOVER = InvRec!turnover

                        LBrokShare = 0
                        LShareAmt = 0
                        GETMAIN.Label1.Caption = LFmlyName & " " & mparty & " " & MSauda
                        DoEvents
                        If Combo1.ListIndex = 0 Then
                            If Check4 = 1 Then
                                mysql = "SELECT SUM(AMOUNT*USDINR) AS BROKSHARE , SUM(SAMOUNT*USDINR) AS SHAREAMT FROM INV_D1 WHERE "
                            Else
                                mysql = "SELECT SUM(AMOUNT) AS BROKSHARE , SUM(SAMOUNT) AS SHAREAMT FROM INV_D1 WHERE "
                            End If
                            mysql = mysql & " FMLYCODE ='" & LFmlyCode & "'AND PARTY ='" & LAcCode & "' And SAUDAID =" & LSaudaID & ""
                            mysql = mysql & " AND STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then
                                If LFLAG Then
                                    LBrokShare = (-1) * IIf(IsNull(TRec!BROKSHARE), 0, TRec!BROKSHARE)
                                    LShareAmt = (-1) * IIf(IsNull(TRec!SHAREAMT), 0, TRec!SHAREAMT)
                                Else
                                    LBrokShare = IIf(IsNull(TRec!BROKSHARE), 0, TRec!BROKSHARE)
                                    LShareAmt = IIf(IsNull(TRec!SHAREAMT), 0, TRec!SHAREAMT)
                                End If
                            End If
                        Else
                            If Check4 = 1 Then
                                mysql = "SELECT SUM(AMOUNT*USDINR) AS BROKSHARE , SUM(SAMOUNT*USDINR) AS SHAREAMT FROM INV_D1 WHERE "
                            Else
                                mysql = "SELECT SUM(AMOUNT) AS BROKSHARE , SUM(SAMOUNT) AS SHAREAMT FROM INV_D1 WHERE "
                            End If
                            mysql = mysql & "  PARTY ='" & LAcCode & "' AND EXID =" & LExID & ""
                            If Check10.Value = 0 Then
                                mysql = mysql & " AND FMLYCODE ='" & LFmlyCode & "'"
                            End If
                            mysql = mysql & " AND STDATE>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND STDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then
                                If LFLAG Then
                                    LBrokShare = (-1) * IIf(IsNull(TRec!BROKSHARE), 0, TRec!BROKSHARE)
                                    LShareAmt = (-1) * IIf(IsNull(TRec!SHAREAMT), 0, TRec!SHAREAMT)
                                Else
                                    LBrokShare = IIf(IsNull(TRec!BROKSHARE), 0, TRec!BROKSHARE)
                                    LShareAmt = IIf(IsNull(TRec!SHAREAMT), 0, TRec!SHAREAMT)
                                End If
                            End If
                        End If
                        If GRoundOff = "Y" Then
                                LBrokShare = Round(LBrokShare)
                              LShareAmt = Round(LShareAmt)
                        End If
                        
                        'Convert currency
                        If Check3.Value = 0 Then
                            RecRpt.AddNew:                  RecRpt!ACCODE = LAcCode
                            RecRpt!ACNAME = mparty:         RecRpt!SAUDANAME = MSauda
                            RecRpt!excode = LExCode:        RecRpt!DIFFAMT = LDiffAmt
                            RecRpt!BROKAMT = LBrokAmt:      RecRpt!Billamt = LBIllAmt
                            RecRpt!TotQty = LTOTQTY:        RecRpt!turnover = LTURNOVER
                            RecRpt!BROKSHARE = LBrokShare:  RecRpt!SHAREAMT = (LShareAmt * -1)
                            RecRpt!FmlyNAME = LFmlyName:    RecRpt!FMLYBAL = LBal
                            RecRpt!FMLYCLBAL = LClBal
                            RecRpt!FMLYCODE = LFmlyCode
                        
                            If LP_OpFlag = False Then
                                RecRpt!PartyBal = LPtyBal
                            Else
                                RecRpt!PartyBal = 0
                            End If
                            '>>> NEW
                            RecRpt!SHAREPER = InvRec!SHAREPER '>>> LSHAREPER
                        
                            LP_OpFlag = True
                            RecRpt.Update
                        Else
                            If RecRpt.RecordCount < 1 Then
                                RecRpt.AddNew:
                                RecRpt!FmlyNAME = LContraName: RecRpt!ACCODE = LAcCode
                                RecRpt!FMLYCODE = Left(LContraName, 6)
                                RecRpt!BROKSHARE = 0: RecRpt!SHAREAMT = 0
                                RecRpt!excode = LExCode:
                                RecRpt!SAUDANAME = MSauda
                            End If
                            RecRpt.MoveFirst
                            RecRpt.Filter = "FMLYNAME ='" & LContraName & "' AND SAUDANAME = '" & MSauda & "' AND EXCODE= '" & LExCode & "' AND ACCODE= '" & LAcCode & "'"
                            If RecRpt.EOF Then
                                RecRpt.AddNew
                                RecRpt!FmlyNAME = LContraName: RecRpt!ACCODE = LAcCode
                                RecRpt!FMLYCODE = Left(LContraName, 6)
                                RecRpt!BROKSHARE = 0: RecRpt!SHAREAMT = 0
                                RecRpt!excode = LExCode: RecRpt!SAUDANAME = MSauda
                            End If
                            RecRpt!ACNAME = mparty:
                            RecRpt!excode = LExCode:        RecRpt!DIFFAMT = LDiffAmt
                            RecRpt!BROKAMT = LBrokAmt:      RecRpt!Billamt = LBIllAmt
                            RecRpt!TotQty = LTOTQTY:        RecRpt!turnover = LTURNOVER
                            RecRpt!FMLYBAL = 0: RecRpt!FMLYCLBAL = 0
                            RecRpt!BROKSHARE = RecRpt!BROKSHARE + (LBrokShare * -1)
                            RecRpt!SHAREAMT = RecRpt!SHAREAMT + LShareAmt
                            RecRpt.Update
                            RecRpt.Filter = ""
                        End If
                                                
                        If Check11.Value And False Then '>>> include contra '>>> NEW 09OCT2021
                            LCDiffAmt = 0
                            LCBrokAmt = 0
                            LCBIllAmt = 0
                            RecRpt.MoveFirst
                            RecRpt.Filter = "ACCODE ='" & InvRec!Contra_Ac & "' AND SAUDANAME= '" & MSauda & "'"
                            If RecRpt.EOF Then
                                RecRpt.AddNew:

                                If Combo1.ListIndex = 0 Then '>>> detail
                                    mysql = "select isnull(SUM(I.DIFFAMT),0) AS DIFFAMT ,isnull(SUM(I.BROKAMT),0) AS BROKAMT ,isnull(SUM(I.BILLAMT),0) AS BILLAMT "
                                    mysql = mysql & "from inv_d I with(nolock) where I.party = '" & InvRec!Contra_Ac & "' and I.SAUDAID='" & LSaudaID & "' and I.stdate >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' and I.stdate <= '" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                                Else
                                    mysql = "select isnull(SUM(I.DIFFAMT),0) AS DIFFAMT ,isnull(SUM(I.BROKAMT),0) AS BROKAMT ,isnull(SUM(I.BILLAMT),0) AS BILLAMT "
                                    mysql = mysql & "from inv_d I with(nolock) where I.party = '" & InvRec!Contra_Ac & "'  and I.stdate >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' and I.stdate <= '" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                                End If
                                
                                Set InvContra = Nothing: Set InvContra = New ADODB.Recordset
                                InvContra.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
                                If Not InvContra.EOF Then
                                    LCDiffAmt = InvContra!DIFFAMT
                                    LCBrokAmt = InvContra!BROKAMT
                                    LCBIllAmt = InvContra!Billamt
                                End If
                            End If
                            RecRpt!ACCODE = InvRec!Contra_Ac
                            RecRpt!ACNAME = LContraName:     RecRpt!SAUDANAME = MSauda
                            RecRpt!excode = LExCode:
                            
                            If (RecRpt!DIFFAMT & vbNullString = "") Then
                                RecRpt!DIFFAMT = LCDiffAmt
                            Else
                                RecRpt!DIFFAMT = RecRpt!DIFFAMT + LCDiffAmt
                            End If
                            If (RecRpt!BROKAMT & vbNullString = "") Then
                                RecRpt!BROKAMT = LCBrokAmt
                            Else
                                RecRpt!BROKAMT = RecRpt!BROKAMT + LCBrokAmt
                            End If
                            If (RecRpt!Billamt & vbNullString = "") Then
                                RecRpt!Billamt = LCBIllAmt
                            Else
                                RecRpt!Billamt = RecRpt!Billamt + LCBIllAmt
                            End If
                                                                                                            
                            If (RecRpt!BROKSHARE & vbNullString = "") Then
                                RecRpt!BROKSHARE = LBrokShare * -1
                            Else
                                RecRpt!BROKSHARE = RecRpt!BROKSHARE + (LBrokShare * -1)
                            End If
                            
                            If (RecRpt!SHAREAMT & vbNullString = "") Then
                                RecRpt!SHAREAMT = LShareAmt
                            Else
                                RecRpt!SHAREAMT = RecRpt!SHAREAMT + LShareAmt
                            End If
                            
                            RecRpt!FmlyNAME = LContraName:   RecRpt!FMLYBAL = 0
                            RecRpt!FMLYCLBAL = 0
                            RecRpt!FMLYCODE = Left(LContraName, 6)
                            
                            If LP_OpFlag = False Then
                                RecRpt!PartyBal = LPtyBal
                            Else
                                RecRpt!PartyBal = 0
                            End If
                            '>>> NEW
                            RecRpt!SHAREPER = InvRec!SHAREPER '>>> LSHAREPER
                                                        
                            RecRpt.Update
                            RecRpt.Filter = ""
                          
                            '' new end
                        End If  '>> If Check11.Value Then '>>> include contra '>>> NEW 09OCT2021

                        InvRec.MoveNext
                        If InvRec.EOF Then Exit Do
                    Loop
                    If InvRec.EOF Then Exit Do
                Loop
                If InvRec.EOF Then Exit Do
            Loop
        Else
            MsgBox "No Records Found"
        End If
    End If
    
    ''
        If Combo1.ListIndex = 5 Then ' Consolidated
            ''
            If RecRpt.RecordCount >= 1 Then
            RecRpt.Filter = ""
            RecRpt.MoveFirst
            Do While Not RecRpt.EOF
                RecRpt!BROKSHARE = 0
                RecRpt!SHAREAMT = 0
                RecRpt.Update
            
                RecRpt.MoveNext
            Loop
            RecRpt.Filter = ""
            RecRpt.MoveFirst
            
            ''
            InvRec.Filter = ""
            InvRec.MoveFirst
            Do While Not InvRec.EOF
                LFmlyCode = InvRec!FMLYCODE
                LFmlyName = InvRec!FmlyNAME
                LHeadID = InvRec!HEADID
                LFmlyHead = InvRec!FMLYHEAD:
                LFmlyID = InvRec!FMLYID
                
                LContraName = InvRec!CONTRAname '>>> NEW 09OCT2021
                '' NEW -- Data From Vchamt Where Branch Head If Contra A/c In Other Branches'
                Dim Lbalmat As Double
                Lbalmat = 0
                mysql = ""
                mysql = "select sum(amount) as 'amount', dr_cr from VOUCHER ,vchamt where vchamt.vou_type = 'H' "
                If LFmlyID = "2" Then
                    mysql = mysql & "and accid = '" & LHeadID & "' AND VOUCHER.VOU_ID = VCHAMT.VOU_ID  "
                Else
                    mysql = mysql & "and (accid = '" & LHeadID & "' OR ACCID IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID = '" & LFmlyID & "')) AND VOUCHER.VOU_ID = VCHAMT.VOU_ID  "
                End If
                mysql = mysql & "AND vchamt.VOU_DT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND vchamt.VOU_DT<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                mysql = mysql & "Group by DR_CR order by DR_CR"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    If TRec!DR_CR = "C" Then
                        Lbalmat = Lbalmat + TRec!AMOUNT
                    Else
                        Lbalmat = Lbalmat - TRec!AMOUNT
                    End If
                    TRec.MoveNext
                    If Not TRec.EOF Then
                        If TRec!DR_CR = "D" Then
                            Lbalmat = Lbalmat - TRec!AMOUNT
                        Else
                            Lbalmat = Lbalmat + TRec!AMOUNT
                        End If
                    End If
                End If
                If LFmlyID = "2" Then
                     Lbalmat = Lbalmat * -1
                End If
                If Lbalmat <> 0 Then
                    RecRpt.Filter = ""
                    RecRpt.MoveFirst
                    RecRpt.Filter = "fmlycode ='" & LFmlyCode & "' "
                    If Not RecRpt.EOF Then
                        RecRpt!SHAREAMT = RecRpt!SHAREAMT + Lbalmat
                        RecRpt.Update
                    End If
                    RecRpt.Filter = ""
                End If
                
                ''Brokerage Update
                Lbalmat = 0
                mysql = ""
                mysql = "select sum(amount) as 'amount', dr_cr from VOUCHER ,vchamt where vchamt.vou_type = 'B' "
                mysql = mysql & "and accid = '" & LHeadID & "' AND VOUCHER.VOU_ID = VCHAMT.VOU_ID AND FMLYID = '" & LFmlyID & "' "
                mysql = mysql & "AND vchamt.VOU_DT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND vchamt.VOU_DT<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                mysql = mysql & "Group by DR_CR order by DR_CR"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    If TRec!DR_CR = "C" Then
                        Lbalmat = TRec!AMOUNT
                    Else
                        Lbalmat = Lbalmat - TRec!AMOUNT
                    End If
                    TRec.MoveNext
                    If Not TRec.EOF Then
                        If TRec!DR_CR = "D" Then
                            Lbalmat = Lbalmat - TRec!AMOUNT
                        End If
                    End If
                End If
                                
                If Lbalmat <> 0 Then
                    RecRpt.Filter = ""
                    RecRpt.MoveFirst
                    RecRpt.Filter = "fmlycode ='" & LFmlyCode & "' "
                    If Not RecRpt.EOF Then
                        RecRpt!BROKSHARE = RecRpt!BROKSHARE + Lbalmat
                        RecRpt.Update
                    End If
                    RecRpt.Filter = ""
               End If
                
                
                ''''Contrac Ac
                mysql = ""
                Set InvContra = Nothing: Set InvContra = New ADODB.Recordset
                mysql = mysql + "select fmlyid,fmlycode,fmlyname,headid,FMLYHEAD,contra_ac,contraid from accfmly where contraid = '" & LHeadID & "' "
                InvContra.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
                Do While Not InvContra.EOF
                    LCFmlyCode = InvContra!FMLYCODE
                    LccontraID = InvContra!CONTRAID
                    LcFmlyHead = InvContra!FMLYHEAD
                    LCFMLYID = InvContra!FMLYID
                    
                    Lbalmat = 0
                    mysql = ""
                    mysql = "select sum(amount) as 'amount', dr_cr from VOUCHER,vchamt where vchamt.vou_type = 'H' "
                    mysql = mysql & "and accid = '" & LccontraID & "' AND VOUCHER.VOU_ID = VCHAMT.VOU_ID AND FMLYID = '" & LCFMLYID & "' "
                    mysql = mysql & "AND vchamt.VOU_DT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND vchamt.VOU_DT<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                    mysql = mysql & "Group by DR_CR order by DR_CR"
                    
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        If TRec!DR_CR = "C" Then
                            Lbalmat = Lbalmat - TRec!AMOUNT
                        Else
                            Lbalmat = Lbalmat + TRec!AMOUNT
                        End If
                        TRec.MoveNext
                        If Not TRec.EOF Then
                            If TRec!DR_CR = "D" Then
                                Lbalmat = Lbalmat + TRec!AMOUNT
                            Else
                                Lbalmat = Lbalmat - TRec!AMOUNT
                            End If
                        End If
                    End If
                    If Lbalmat <> 0 Then
                        RecRpt.Filter = ""
                        RecRpt.MoveFirst
                        RecRpt.Filter = "fmlycode ='" & LFmlyCode & "' "
                        If Not RecRpt.EOF Then
                            RecRpt!SHAREAMT = RecRpt!SHAREAMT + Lbalmat
                            RecRpt.Update
                        End If
                        RecRpt.Filter = ""
                     End If
                
                    ''Brokerage Update
                    Lbalmat = 0
                    mysql = ""
                    mysql = "select sum(amount) as 'amount', dr_cr from VOUCHER ,vchamt where vchamt.vou_type = 'B' "
                    mysql = mysql & "and accid = '" & LccontraID & "' AND VOUCHER.VOU_ID = VCHAMT.VOU_ID AND FMLYID = '" & LCFMLYID & "' "
                    mysql = mysql & "AND vchamt.VOU_DT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND vchamt.VOU_DT<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "'"
                    mysql = mysql & "Group by DR_CR order by DR_CR"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        If TRec!DR_CR = "C" Then
                            Lbalmat = Lbalmat - TRec!AMOUNT
                        Else
                            Lbalmat = Lbalmat + TRec!AMOUNT
                        End If
                        TRec.MoveNext
                        If Not TRec.EOF Then
                            If TRec!DR_CR = "D" Then
                                Lbalmat = Lbalmat + TRec!AMOUNT
                            Else
                                Lbalmat = Lbalmat - TRec!AMOUNT
                            End If
                        End If
                    End If
                    If Lbalmat <> 0 Then
                        RecRpt.Filter = ""
                        RecRpt.MoveFirst
                        RecRpt.Filter = "fmlycode ='" & LFmlyCode & "' "
                        If Not RecRpt.EOF Then
                            RecRpt!BROKSHARE = RecRpt!BROKSHARE + Lbalmat
                            RecRpt.Update
                        End If
                        RecRpt.Filter = ""
                   End If

                    InvContra.MoveNext
                    If InvContra.EOF Then Exit Do
                Loop
                
                
                If InvRec.EOF Then GoTo FLAG_INV_REC
                
                Do While InvRec!FMLYCODE = LFmlyCode
                    InvRec.MoveNext
                    If InvRec.EOF Then GoTo FLAG_INV_REC
                Loop
                
                If InvRec.EOF Then GoTo FLAG_INV_REC
                'InvRec.MoveNexts
            Loop
    End If
    End If
            
    If RecRpt.RecordCount <= 0 Then
        GoTo err1:
    End If
    
FLAG_INV_REC:
        If CreateChk.Value = 1 Then
            If InvRec.EOF Then
                Call CreateReport(LFmlyName)
            Else
                If InvRec!FMLYCODE = LFmlyCode Then
                    Call CreateReport(LFmlyName)
                    'Call AccRecNew
                End If
            End If
        End If
    If CreateChk.Value = 1 Then
        MsgBox "Files Exported Successfully"
    Else
        If Check5.Value = 1 Then
            If Check3.Value = 1 Then
                RecRpt.Sort = "fmlyname,ACNAME"
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CLBranch_ShareSummINR.rpt", 1)
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_ShareSummINR.rpt", 1)
            End If
        Else
            If Combo1.ListIndex = 0 Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_ShareDetail.rpt", 1) '>>> Branch_ShareDetail_test.rpt
            ElseIf Combo1.ListIndex = 1 Then
                RecRpt.Sort = "fmlyname,ACNAME"
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_ShareSumm.rpt", 1)
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Branch_ShareCONS.rpt", 1)
            End If
        End If
        mysql = "'Branch Wise Brokerage and Sharing From " & vcDTP1.Value & " To " & vcDTP2.Value & "'"
        RecRpt.MoveFirst
        RDCREPO.DiscardSavedData: RDCREPO.Database.SetDataSource RecRpt
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
        CRViewer1.ZOrder: CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True: CRViewer1.ReportSource = RDCREPO: CRViewer1.Zoom 1: CRViewer1.ViewReport
   End If
    Me.MousePointer = 0
    GETMAIN.ProgressBar1.Visible = False
    OkCmd.Enabled = True
    Exit Sub
err1:

If err.Number <> 0 Then
     MsgBox err.Description, vbCritical, "Error Number : " & err.Number
End If

    Me.MousePointer = 0: OkCmd.Enabled = True
    GETMAIN.ProgressBar1.Visible = False
End Sub

Private Sub Add_To_AccRecSet(LARptGrp As Integer, LACounter As Long, LASetNo As Long, LAQty As Double, LARate As Double, LATrdNo As String, LACondate As Date, LANetRecdPay As Double, LANetMargin As Double _
 , LAContime As String, LABrokRate As Double, LABrokAmt As Double, LAPrevBal As Double, LAConType As String, LARefLot As Double, LACalval As Double, LAPattan As String, LABrokType As String, LINSTYPE As String)

    AccRecSet.AddNew
    AccRecSet.Fields("BILLNO") = LASetNo
    AccRecSet.Fields("PATTAN") = LAPattan
    AccRecSet.Fields("RPTGRP") = LARptGrp
    If LAConType = "B" Then
    
        CF_BALANCE = CF_BALANCE + (((LAQty * LARate) * LACalval) * -1) + (LABrokAmt * -1)
            
        AccRecSet.Fields("BQNTY") = LAQty: AccRecSet.Fields("BRATE") = Val(LARate)
        AccRecSet.Fields("CONNO") = LATrdNo: AccRecSet.Fields("CONTDATE") = Format(LACondate, "yyyy/MM/dd")
        
        If Check12.Value = 1 Then
            AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
        Else
            AccRecSet.Fields("DRAMOUNT") = Val(LAQty * LARate):
        End If
        AccRecSet.Fields("CONTIME") = Trim$(LAContime): AccRecSet.Fields("BBROKAMT") = LABrokAmt: AccRecSet.Fields("SBROKAMT") = 0
        
        If Check12.Value = 1 Then
            AccRecSet.Fields("CGSTAMT") = Abs((((LAQty * LARate) * LACalval) * -1) + (LABrokAmt * -1))
        End If
    Else
        If Check12.Value = 1 Then
        
            CF_BALANCE = CF_BALANCE + ((LAQty * LARate)) + LABrokAmt
                
            AccRecSet.Fields("BQNTY") = Abs(LAQty):               AccRecSet.Fields("BRATE") = Val(LARate)
            AccRecSet.Fields("CONNO") = LATrdNo:                  AccRecSet.Fields("CONTDATE") = Format(LACondate, "yyyy/MM/dd")
            
            If Check12.Value = 1 Then
                AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
            Else
                AccRecSet.Fields("DRAMOUNT") = (Abs(LAQty) * LARate):
            End If
            AccRecSet.Fields("CONTIME") = Trim$(LAContime): AccRecSet.Fields("BBROKAMT") = LABrokAmt: AccRecSet.Fields("SBROKAMT") = 0
            AccRecSet.Fields("SGSTAMT") = Abs((LAQty * LARate) - LABrokAmt)
            
        Else
            AccRecSet.Fields("SQNTY") = Abs(LAQty):               AccRecSet.Fields("SRATE") = Val(LARate)
            AccRecSet.Fields("CRAMOUNT") = (Abs(LAQty) * LARate): AccRecSet.Fields("SCONTIME") = Trim$(LAContime)
            AccRecSet.Fields("SCONNO") = LATrdNo:                 AccRecSet.Fields("CONTDATE1") = Format(LACondate, "yyyy/MM/dd")
            AccRecSet.Fields("BBROKAMT") = 0
            AccRecSet.Fields("SBROKAMT") = LABrokAmt
        End If
        
    End If
    AccRecSet.Fields("CALVAL") = LACalval:
    AccRecSet.Fields("BrokType") = LABrokType:                       AccRecSet.Fields("BBrokQty") = 0
    AccRecSet.Fields("BrokRate") = LABrokRate:
    AccRecSet.Fields("BINSTYPE") = LINSTYPE
    'Common
    AccRecSet.Fields("SRNO") = LACounter:
    
'    'If Check10.Value = 1 Then
'    '    AccRecSet.Fields("RPTGRP") = 1
'    'Else
'        AccRecSet.Fields("RPTGRP") = 2  'new -- account statement report grouping
'    'End If
    
    If Check10.Value = 1 Then 'OLD
        AccRecSet.Fields("RPTGRP") = 2
    Else
        AccRecSet.Fields("RPTGRP") = 1
    End If
    
    AccRecSet.Fields("PrevBal") = LAPrevBal:
    If Option5.Value = False Then
        AccRecSet.Fields("DEBITAMT") = LANetRecdPay
        AccRecSet.Fields("CREDITAMT") = LANetMargin:
    Else
        AccRecSet.Fields("DEBITAMT") = LANetRecdPay
        AccRecSet.Fields("CREDITAMT") = LANetMargin:
    End If
    AccRecSet.Fields("REFLOT") = LARefLot:
    AccRecSet.Fields("CTYPE") = LAConType
    
    If Check12.Value = 1 Then '>>> account statement customized format
        AccRecSet.Fields("PIN") = LAConType
    End If
    
    Call Add_PartyDetails:
    Call Add_OtherDetails
    AccRecSet.Update
End Sub
Private Sub Add_VOUCHER(LARptGrp As Integer, LACounter As Long, LTTYPE As String, LACondate As Date, LVouNo As String, LNarr As String, LDrCr As String, LAmount As Double, LBal As Double)

AccRecSet.AddNew
        If (LTTYPE = "OPENING") Then
            AccRecSet.Fields("RPTGRP") = LARptGrp:
            AccRecSet.Fields("SRNO") = LACounter:
            AccRecSet.Fields("SAUDACODE") = "Opening Bal":
            AccRecSet.Fields("CONTDATE") = Format(LACondate, "yyyy/MM/dd")
            AccRecSet.Fields("WORDAMT") = vbNullString
            'buy sell
            CF_BALANCE = LBal
            If LBal < 0 Then
                AccRecSet.Fields("BRATE") = Abs(LBal): AccRecSet.Fields("SRATE") = 0: AccRecSet.Fields("CTYPE") = "D":
                AccRecSet.Fields("BQNTY") = "1": AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
                AccRecSet.Fields("CGSTAMT") = Abs(CF_BALANCE)
            Else
                AccRecSet.Fields("BRATE") = 0: AccRecSet.Fields("SRATE") = Abs(LBal): AccRecSet.Fields("CTYPE") = "C":
                AccRecSet.Fields("SQNTY") = "1": AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
                AccRecSet.Fields("SGSTAMT") = CF_BALANCE
            End If
            AccRecSet.Fields("CALVAL") = "1": AccRecSet.Fields("BBROKAMT") = "0": AccRecSet.Fields("STANDING") = LBal
            AccRecSet.Fields("PIN") = "A"
        Else
            AccRecSet.Fields("RPTGRP") = LARptGrp:
            AccRecSet.Fields("SRNO") = LACounter:
            AccRecSet.Fields("SAUDACODE") = Left(LNarr + IIf(Len(LNarr) <= 0, LVouNo, ""), 50)
            AccRecSet.Fields("CONTDATE") = Format(LACondate, "yyyy/MM/dd"): AccRecSet.Fields("WORDAMT") = LNarr
            'buy sell
            If LDrCr = "D" Then
                CF_BALANCE = CF_BALANCE + (LAmount * -1)
                AccRecSet.Fields("BRATE") = 0: AccRecSet.Fields("SRATE") = 0: AccRecSet.Fields("CTYPE") = "D":
                AccRecSet.Fields("BQNTY") = "1": AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
                AccRecSet.Fields("CGSTAMT") = LAmount
                LBal = LBal + (LAmount * -1)
            Else
                'AccRecSet.Fields("BRATE") = 0: AccRecSet.Fields("SRATE") = LAmount
                CF_BALANCE = CF_BALANCE + LAmount
                AccRecSet.Fields("BRATE") = 0: AccRecSet.Fields("SRATE") = 0: AccRecSet.Fields("SQNTY") = "1"
                AccRecSet.Fields("BQNTY") = "0": AccRecSet.Fields("DRAMOUNT") = CF_BALANCE
                AccRecSet.Fields("SGSTAMT") = LAmount
                AccRecSet.Fields("CTYPE") = "C": LBal = LBal + (LAmount)
                
            End If
            AccRecSet.Fields("CALVAL") = "1": AccRecSet.Fields("BBROKAMT") = "0": AccRecSet.Fields("STANDING") = LBal
            AccRecSet.Fields("PIN") = "Z"
        End If
                
CFlag = True
Call Add_PartyDetails
Call Add_OtherDetails

AccRecSet.Update
                                                                            
End Sub

Private Sub Add_To_AccRecSet_new(LARptGrp As Integer, LACounter As Long, LASetNo As Long, LAQty As Double, LARate As Double, LATrdNo As String, LACondate As Date, LANetRecdPay As Double, LANetMargin As Double _
 , LAContime As String, LABrokRate As Double, LABrokAmt As Double, LAPrevBal As Double, LAConType As String, LARefLot As Double, LACalval As Double, LAPattan As String, LABrokType As String)

    AccRecSet.AddNew
    AccRecSet.Fields("BILLNO") = LASetNo
    AccRecSet.Fields("PATTAN") = LAPattan
    AccRecSet.Fields("RPTGRP") = LARptGrp
    If LAConType = "B" Then
        AccRecSet.Fields("BQNTY") = LAQty:                    AccRecSet.Fields("BRATE") = Val(LARate)
        AccRecSet.Fields("CONNO") = LATrdNo:                  AccRecSet.Fields("CONTDATE") = Format(LACondate, "yyyy/MM/dd")
        AccRecSet.Fields("DRAMOUNT") = Val(LAQty * LARate):   AccRecSet.Fields("CONTIME") = Trim$(LAContime)
        AccRecSet.Fields("BBROKAMT") = LABrokAmt
        AccRecSet.Fields("SBROKAMT") = 0
        
    Else
        AccRecSet.Fields("SQNTY") = Abs(LAQty):               AccRecSet.Fields("SRATE") = Val(LARate)
        AccRecSet.Fields("CRAMOUNT") = (Abs(LAQty) * LARate): AccRecSet.Fields("SCONTIME") = Trim$(LAContime)
        AccRecSet.Fields("SCONNO") = LATrdNo:                 AccRecSet.Fields("CONTDATE1") = Format(LACondate, "yyyy/MM/dd")
        AccRecSet.Fields("BBROKAMT") = 0
        AccRecSet.Fields("SBROKAMT") = LABrokAmt
    End If
    AccRecSet.Fields("CALVAL") = LACalval:
    AccRecSet.Fields("BrokType") = LABrokType:                       AccRecSet.Fields("BBrokQty") = 0
    AccRecSet.Fields("BrokRate") = LABrokRate:
    'Common
    AccRecSet.Fields("SRNO") = LACounter:
    
    'If Check10.Value = 1 Then
    '    AccRecSet.Fields("RPTGRP") = 1
    'Else
        AccRecSet.Fields("RPTGRP") = 2  'new -- account statement report grouping
    'End If
    
'    If Check10.Value = 1 Then 'OLD
'        AccRecSet.Fields("RPTGRP") = 2
'    Else
'        AccRecSet.Fields("RPTGRP") = 1
'    End If
    
    AccRecSet.Fields("PrevBal") = LAPrevBal:
    If Option5.Value = False Then
        AccRecSet.Fields("DEBITAMT") = LANetRecdPay
        AccRecSet.Fields("CREDITAMT") = LANetMargin:
    Else
        AccRecSet.Fields("DEBITAMT") = LANetRecdPay
        AccRecSet.Fields("CREDITAMT") = LANetMargin:
    End If
    AccRecSet.Fields("REFLOT") = LARefLot:
    AccRecSet.Fields("CTYPE") = LAConType
    Call Add_PartyDetails:
    Call Add_OtherDetails
    AccRecSet.Update
End Sub

Sub BillWise_Report()
    On Error GoTo err1
    Dim LPartyName As String:       Dim LItemCode As String:        Dim LFmlyName As String:        Dim LExCode As String:   Dim LPartyCode  As String:  Dim LSaudaCode As String
    Dim TRec As ADODB.Recordset:    Dim TRec2 As ADODB.Recordset:   Dim MPrvCloseRate  As Double:   Dim LPrevStd As Double:  Dim LPBQnty As Double:      Dim LRegLot As Double
    Dim LPSQnty As Double:          Dim LClQty As Double:           Dim LCLRATE  As Double:         Dim MABAmt As Double:    Dim LCloseRate As Double:   Dim MBLQty As Double
    Dim MNetAmt As Double:          Dim MNetQty As Double:          Dim MBQty As Double:            Dim msqty As Double:     Dim DCloseRate As Double:   Dim LastClosingDate As Date
    Dim LDiffAmt As Double:         Dim LBrokAmt  As Double:        Dim LMDT As Date:               Dim LPQty As Double:     Dim LRATE As Double:        Dim LConCode  As String
    Dim LBrokerName As String:      Dim LBuyAmt As Double:          Dim LSellAmt As Double:         Dim LNetRate As Double:  Dim LNetAmt As Double
    Dim LOpenQty As Double:         Dim LOpenRate As Double:        Dim LOpenmAmt As Double:        Dim LLOT As Double:      Dim LInstType As String
    Dim lOpQty As Double:           Dim lOpRate As Double:          Dim LMULTI As Double:           Dim RateRec As ADODB.Recordset
    Dim LShRate As Double:          Dim LShType As String:          Dim LSHQTY As Double:           Dim LShareAmt As Double
    Dim LContra_Ac As String:       Dim Lmaturity As Date:          Dim LSaudaID As Long
    Dim LExID As Integer
    Dim LItemID As Integer
    Dim LACCID As Long
    
    LSExCodes = Get_ExCodes:    LSParties = Get_Parties:    LSSaudas = Get_Saudas:      LSInst = Get_Inst

    Me.MousePointer = Val(11): OkCmd.Enabled = False
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "PARTY", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "CLQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CLRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "DIFFAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BROKAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SHAREAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SUBBROK", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
    RecRpt.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "SHQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "NetRate", adDouble, , adFldIsNullable
    'End If
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    If Option1.Value = True Then
        mysql = "SELECT S.EXCODE,S.EXID,S.ITEMID,S.ITEMCODE,S.SAUDAID,S.SAUDACODE,S.INSTTYPE,S.MATURITY,I.PARTY,A.ACCID,A.NAME,A.MULTIPLIER,I.CALVAL,"
        mysql = mysql & " SUM(DIFFAMT) AS DAMT ,SUM(BROKAMT) AS BAMT FROM INV_D AS I, ACCOUNTD AS A , SAUDAMAST AS S "
        mysql = mysql & " WHERE I.COMPCODE=" & GCompCode & " AND  I.ACCID  = A.ACCID "
        mysql = mysql & " AND  S.SAUDAID =I.SAUDAID "
        mysql = mysql & " AND I.STDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND I.STDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
        If LenB(LSExCodes) > 0 Then mysql = mysql & " AND S.EXID  IN (" & LSExCodes & ")"
        If LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
        If LenB(LSSaudas) > 0 Then mysql = mysql & " AND S.SAUDAID IN (" & LSSaudas & ") "
        If LenB(LSInst) > 0 Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
        mysql = mysql & " GROUP BY S.EXCODE,S.EXID,S.ITEMID,S.ITEMCODE,S.SAUDAID,S.SAUDACODE,S.INSTTYPE,S.MATURITY,I.PARTY,A.ACCID,A.NAME,A.MULTIPLIER,I.CALVAL "
        mysql = mysql & " ORDER BY A.NAME,S.EXCODE, S.SAUDACODE "
        Set TRec = Nothing:    Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        GETMAIN.ProgressBar1.Visible = True
        GETMAIN.ProgressBar1.Max = TRec.RecordCount + 1
        GETMAIN.ProgressBar1.Value = 0
        Do While Not TRec.EOF
            LSaudaCode = TRec!saudacode:            LPartyName = TRec!NAME:     LPartyCode = TRec!PARTY:            LExCode = TRec!excode
            LDiffAmt = 0:                       LBrokAmt = 0:               LLOT = TRec!CALVAL:                 LItemCode = TRec!ITEMCODE
            LClQty = 0:                         LCLRATE = 0:                LNetRate = 0:                       LNetAmt = 0
            LBuyAmt = 0:                        LSellAmt = 0:               LSHQTY = 0:                         LShRate = 0
            LShareAmt = 0:                      LMULTI = 1:                 LInstType = TRec!INSTTYPE:          LContra_Ac = vbNullString
            LSaudaID = TRec!SAUDAID:            LItemID = TRec!itemid
            LACCID = TRec!ACCID
            
            LOpenQty = 0: LOpenRate = 0
            LClQty = Get_CloseQty(LACCID, LSaudaID, vcDTP2.Value)
            LOpenQty = Get_CloseQty(LACCID, LSaudaID, vcDTP1.Value - 1)
            Lmaturity = TRec!MATURITY
            If Lmaturity < vcDTP2.Value Then
                LCLRATE = SDCLRATE(LSaudaID, Lmaturity, "C")
            Else
                LCLRATE = SDCLRATE(LSaudaID, vcDTP2.Value, "C")
            End If
            LOpenRate = SDCLRATE(LSaudaID, vcDTP1.Value - 1, "O")
            LExID = TRec!EXID
            If Check4.Value = 1 And TRec!MULTIPLIER = "1" Then
                LMULTI = Get_PartyMulti(LACCID, LItemID, LExID)
            End If
            If LClQty <> 0 And Check4.Value = 1 And TRec!MULTIPLIER = "1" And LMULTI > 1 Then
                LClQty = LClQty - (LClQty / LMULTI)
            End If
            If LOpenQty <> 0 And Check4.Value = 1 And TRec!MULTIPLIER = "1" And LMULTI > 1 Then
                LOpenQty = LOpenQty - (LOpenQty / LMULTI)
            End If
            
            mysql = "SELECT CONTYPE, SUM (QTY*RATE*CALVAL) AS AMT FROM CTR_D WHERE "
            mysql = mysql & " PARTY ='" & LPartyCode & "' AND SAUDAID =" & LSaudaID & ""
            mysql = mysql & " AND CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
            mysql = mysql & " AND CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
            mysql = mysql & " GROUP BY CONTYPE ORDER BY CONTYPE "
            Set TRec2 = Nothing
            Set TRec2 = New ADODB.Recordset
            TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            LBuyAmt = 0: LSellAmt = 0: LNetRate = 0: LNetAmt = 0
            If Not TRec2.EOF Then
                Do While Not TRec2.EOF
                    If TRec2!CONTYPE = "B" Then
                        LBuyAmt = TRec2!AMT
                    Else
                        LSellAmt = TRec2!AMT
                    End If
                    TRec2.MoveNext
                Loop
            End If
            If Check4.Value = 1 And TRec!MULTIPLIER = "1" Then
                LBuyAmt = LBuyAmt - (LBuyAmt / LMULTI)
                LSellAmt = LSellAmt - (LSellAmt / LMULTI)
            End If
            If LOpenQty > 0 Then
                LBuyAmt = LBuyAmt + (LOpenQty * LOpenRate * LLOT)
            ElseIf LOpenQty < 0 Then
                LSellAmt = LSellAmt + (Abs(LOpenQty) * LOpenRate * LLOT)
            End If
            
            If LBuyAmt > LSellAmt Then
                LNetAmt = LBuyAmt - LSellAmt
            Else
                LNetAmt = LSellAmt - LBuyAmt
            End If
            If LClQty <> 0 Then
                LNetRate = Abs(LNetAmt) / Abs(LClQty)
            End If
            If LClQty > 0 Then
                LDiffAmt = (LSellAmt + (LClQty * LCLRATE * LLOT)) - LBuyAmt
            ElseIf LClQty < 0 Then
                LDiffAmt = LSellAmt - (Abs((LClQty) * LCLRATE * LLOT) + LBuyAmt)
            Else
                LDiffAmt = LSellAmt - LBuyAmt
            End If
            If Lmaturity <= vcDTP2.Value Then
                LClQty = 0
                LNetRate = 0
            End If
            If Check4.Value = 1 Then
                LShRate = 0
                
                mysql = "SELECT A.SHRATE,A.SHTYPE,B.FMLYHEAD,B.CONTRA_AC FROM PITSBROK AS A, ACCFMLY AS B "
                mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND A.COMPCODE =B.COMPCODE AND A.FMLYCODE =B.FMLYCODE "
                mysql = mysql & " AND A.PARTY ='" & LPartyCode & "' AND A.INSTTYPE ='" & LInstType & "'"
                mysql = mysql & " AND A.ITEMCODE ='" & LItemCode & "' AND A.EXID =" & LExID & " "
                mysql = mysql & " AND A.UPTOSTDT>='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' ORDER BY UPTOSTDT"
                Set RateRec = Nothing
                Set RateRec = New ADODB.Recordset
                RateRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If RateRec.EOF Then
                    
                    mysql = "SELECT A.SHRATE,A.SHTYPE ,B.FMLYHEAD,B.CONTRA_AC FROM PEXSBROK AS A,ACCFMLY AS B   WHERE A.COMPCODE =" & GCompCode & " "
                    mysql = mysql & " AND A.COMPCODE=B.COMPCODE AND A.FMLYCODE =B.FMLYCODE "
                    mysql = mysql & " AND A.PARTY ='" & LPartyCode & "' AND A.INSTTYPE ='" & LInstType & "'"
                    mysql = mysql & " AND A.EXID = " & LExID & " AND A.UPTOSTDT>='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' ORDER BY A.UPTOSTDT"
                    Set RateRec = Nothing
                    Set RateRec = New ADODB.Recordset
                    RateRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not RateRec.EOF Then
                        Do While Not RateRec.EOF
                            LShRate = LShRate + RateRec!SHRATE
                            LShType = RateRec!SHTYPE
                            LContra_Ac = RateRec!Contra_Ac
                            RateRec.MoveNext
                        Loop
                        
                    End If
                Else
                    Do While Not RateRec.EOF
                        LShRate = LShRate + RateRec!SHRATE
                        LShType = RateRec!SHTYPE
                        LContra_Ac = RateRec!Contra_Ac
                        RateRec.MoveNext
                    Loop
                End If
                If LShRate <> 0 Then
                    If LMULTI = 1 Then
                        If LClQty <> 0 Then LSHQTY = (LClQty * -1) * (LShRate / 100)
                        
                        If LShType = "N" Then
                            LShareAmt = (LDiffAmt) * -1 * (LShRate / 100)
                        Else
                            LShareAmt = (LDiffAmt) * -1 * (LShRate / 100)
                        End If
                    Else
                        LShRate = (LShRate * LMULTI) / (LMULTI - 1)
                        If LClQty <> 0 Then
                            LSHQTY = (LClQty * -1) * (LShRate / 100)
                        End If
                        If LShType = "N" Then
                            LShareAmt = (LDiffAmt) * -1 * (LShRate / 100)
                        Else
                            LShareAmt = (LDiffAmt) * -1 * (LShRate / 100)
                        End If
                    End If
                End If
            End If
            RecRpt.Filter = adFilterNone
            RecRpt.Filter = "PARTYCODE='" & LPartyCode & "' AND SAUDA ='" & LSaudaCode & "'"
            If RecRpt.EOF Then RecRpt.AddNew
            
            RecRpt!Sauda = LSaudaCode:      RecRpt!PARTYCODE = LPartyCode
            RecRpt!PARTY = LPartyName:      RecRpt!CLQTY = Val(RecRpt!CLQTY & vbNullString) + LClQty
            RecRpt!excode = LExCode:        RecRpt!ClRate = LCLRATE
            RecRpt!DIFFAMT = Val(RecRpt!DIFFAMT & vbNullString) + LDiffAmt:       RecRpt!BROKAMT = Val(RecRpt!BROKAMT & vbNullString) + LBrokAmt
            RecRpt!SHQTY = Val(RecRpt!SHQTY & vbNullString) + LSHQTY:             RecRpt!SHAREAMT = Val(RecRpt!SHAREAMT & vbNullString) + LShareAmt
            RecRpt!NETRATE = LNetRate
            RecRpt.Update
            If LShRate <> 0 Then
                LACCID = Get_AccID(LContra_Ac)
                LPartyName = Get_AccountName(LACCID)
                RecRpt.Filter = adFilterNone
                RecRpt.Filter = "PARTYCODE='" & LContra_Ac & "' AND SAUDA ='" & LSaudaCode & "'"
                If RecRpt.EOF Then RecRpt.AddNew
                RecRpt!Sauda = LSaudaCode:      RecRpt!PARTYCODE = LContra_Ac
                RecRpt!PARTY = LPartyName:
                RecRpt!CLQTY = Val(RecRpt!CLQTY & vbNullString)
                RecRpt!excode = LExCode:        RecRpt!ClRate = LCLRATE
                'RecRpt!DIFFAMT = Val(RecRpt!DIFFAMT & vbNullString) + LDiffAmt:       RecRpt!BROKAMT = Val(RecRpt!BROKAMT & vbNullString) + LBrokAmt
                RecRpt!SHQTY = Val(RecRpt!SHQTY & vbNullString) + (LSHQTY * -1):       RecRpt!SHAREAMT = Val(RecRpt!SHAREAMT & vbNullString) + (LShareAmt * -1)
                'RecRpt!NETRATE = LNetRate
                RecRpt.Update
            End If
            GETMAIN.ProgressBar1.Value = GETMAIN.ProgressBar1.Value + 1
            TRec.MoveNext
        Loop
        
        GETMAIN.ProgressBar1.Visible = False
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        Set TRec = RecRpt.Clone
        If Check4.Value = 1 Then
            If Check9.Value = 1 Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Billwise-VSHSumm.RPT", 1)
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Billwise-SHSumm.RPT", 1)
            End If
            mysql = "'Party wise Summary from  " & vcDTP1.Value & " to " & vcDTP2.Value & "'"
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Billwise-Summ.RPT", 1)
            mysql = "'Party wise Summary from  " & vcDTP1.Value & " to " & vcDTP2.Value & "'"
        
        End If
        
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    Else
        Dim LFmlyRec  As ADODB.Recordset:        Dim LFmlyRec2  As ADODB.Recordset:    Dim LFmlyCode As String
        Dim LParty  As String:                   Dim LHeadAc As String:                Dim LContraAc  As String:
        
        
        
        'Dim LItemCode As String
        mysql = "SELECT FMLYCODE,FMLYNAME, FMLYHEAD ,CONTRA_AC FROM ACCFMLY WHERE COMPCODE=" & GCompCode & " "
        If AllFmly = False Then mysql = mysql & " AND FMLYID IN (" & LSFmlyIDs & ") "
        mysql = mysql & " ORDER BY FMLYNAME "
        Set LFmlyRec = Nothing
        Set FmlyRec = New ADODB.Recordset
        FmlyRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not FmlyRec.EOF
            LFmlyCode = FmlyRec!FMLYCODE
            LFmlyName = FmlyRec!FmlyNAME
        
            mysql = "SELECT DISTINCT PARTY FROM ACCFMLYD WHERE COMPCODE =" & GCompCode & " AND FMLYCODE ='" & LFmlyCode & "' "
            If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND PARTY IN (" & LSParties & ") "
            mysql = mysql & " ORDER BY PARTY  "
            Set LFmlyRec2 = Nothing
            Set LFmlyRec2 = New ADODB.Recordset
            LFmlyRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            Do While Not LFmlyRec2.EOF
                LParty = LFmlyRec2!PARTY
                mysql = "SELECT I.EXCODE,I.ITEMCODE,S.INSTTYPE,I.SAUDAID,I.SAUDA,I.PARTY,A.ACCID,A.NAME,A.MULTIPLIER,I.CALVAL, SUM(I.DIFFAMT) AS DAMT,SUM(I.BROKAMT) AS BAMT "
                mysql = mysql & " FROM INV_D AS I, ACCOUNTD AS A ,SAUDAMAST AS S "
                mysql = mysql & " WHERE A.COMPCODE =" & GCompCode & " AND  A.ACCID =I.ACCID AND A.AC_CODE ='" & LParty & "' "
                mysql = mysql & " AND  S.SAUDAID=I.SAUDAID"
                mysql = mysql & " AND I.STDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND I.STDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
                If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
                If AllSaudas = False Then mysql = mysql & " AND I.SAUDAID IN (" & LSSaudas & ") "
                If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
                mysql = mysql & " GROUP BY I.EXCODE,S.INSTTYPE,I.ITEMCODE,I.SAUDA,I.PARTY,A.ACCID,A.NAME,A.MULTIPLIER,I.CALVAL"
                mysql = mysql & " ORDER BY I.EXCODE, I.SAUDA "
                Set TRec = Nothing:    Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
                Do While Not TRec.EOF
                    LSaudaCode = TRec!Sauda:    LPartyName = TRec!NAME:     LPartyCode = LParty:        LExCode = TRec!excode
                    LDiffAmt = 0:               LBrokAmt = 0:               LInstType = TRec!INSTTYPE:  LItemCode = TRec!ITEMCODE
                    LClQty = 0:                 LCLRATE = 0:                LMULTI = 1:                 LOpenQty = 0:
                    LLOT = TRec!CALVAL:         LOpenRate = 0:              LNetAmt = 0:                LNetRate = 0
                    LBuyAmt = 0:                LSellAmt = 0
                    LSaudaID = TRec!SAUDAID
                    LACCID = TRec!ACCID
                    
                    LClQty = Get_CloseQty(LACCID, LSaudaID, vcDTP2.Value)
                    LOpenQty = Get_CloseQty(LACCID, LSaudaID, vcDTP1.Value - 1)
                    LCLRATE = SDCLRATE(LSaudaID, vcDTP2.Value, "C")
                    LOpenRate = SDCLRATE(LSaudaID, vcDTP1.Value - 1, "O")
                    If Check4.Value = 1 And TRec!MULTIPLIER = "1" Then
                        Set TRec2 = Nothing
                        Set TRec2 = New ADODB.Recordset
                        If LItemCode = "NIFTY" Or LItemCode = "BANKNIFTY" Then
                            mysql = "SELECT RATE FROM PARTYMULTI WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LPartyCode & "' AND ITEMCODE ='" & LItemCode & "'"
                        Else
                            mysql = "SELECT RATE FROM PARTYMULTI WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LPartyCode & "' AND ITEMCODE =''"
                        End If
                        TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec2.EOF Then LMULTI = TRec2!Rate
                    End If

                    If LClQty <> 0 And Check4.Value = 1 And TRec!MULTIPLIER = "1" Then
                        LClQty = LClQty - (LClQty / LMULTI)
                    End If
                    If LOpenQty <> 0 And Check4.Value = 1 And TRec!MULTIPLIER = "1" Then
                        LOpenQty = LOpenQty - (LOpenQty / LMULTI)
                    End If
                    mysql = "SELECT CONTYPE, SUM (QTY*RATE*CALVAL) AS AMT FROM CTR_D WHERE COMPCODE =" & GCompCode & ""
                    mysql = mysql & " AND PARTY ='" & LPartyCode & "' AND SAUDA ='" & LSaudaCode & "'"
                    mysql = mysql & " AND CONDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
                    mysql = mysql & " AND CONDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
                    mysql = mysql & " GROUP BY CONTYPE ORDER BY CONTYPE "
                    
                    Set TRec2 = Nothing
                    Set TRec2 = New ADODB.Recordset
                    TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    LBuyAmt = 0: LSellAmt = 0: LNetRate = 0: LNetAmt = 0
                    If Not TRec2.EOF Then
                        Do While Not TRec2.EOF
                            If TRec2!CONTYPE = "B" Then
                                LBuyAmt = TRec2!AMT
                            Else
                                LSellAmt = TRec2!AMT
                            End If
                            TRec2.MoveNext
                        Loop
                    End If
                    If Check4.Value = 1 And TRec!MULTIPLIER = "1" Then
                        LBuyAmt = LBuyAmt - (LBuyAmt / LMULTI)
                        LSellAmt = LSellAmt - (LSellAmt / LMULTI)
                    End If
            
                    If LOpenQty > 0 Then
                        LBuyAmt = LBuyAmt + (LOpenQty * LOpenRate * LLOT)
                    ElseIf LOpenQty < 0 Then
                        LSellAmt = LSellAmt + (Abs(LOpenQty) * LOpenRate * LLOT)
                    End If
                    
                    If LBuyAmt > LSellAmt Then
                        LNetAmt = LBuyAmt - LSellAmt
                    Else
                        LNetAmt = LSellAmt - LBuyAmt
                    End If
                    
                    If LClQty <> 0 Then LNetRate = Abs(LNetAmt) / Abs(LClQty)
                    
                    If LClQty > 0 Then
                        LDiffAmt = (LSellAmt + (LClQty * LCLRATE * LLOT)) - LBuyAmt
                    ElseIf LClQty < 0 Then
                        LDiffAmt = LSellAmt - (Abs((LClQty) * LCLRATE * LLOT) + LBuyAmt)
                    Else
                        LDiffAmt = LSellAmt - LBuyAmt
                    End If
                
                    If Check4.Value = 1 Then
                        LShRate = 0
                        mysql = "SELECT SHRATE,SHTYPE FROM PITSBROK WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LParty & "' AND INSTTYPE ='" & LInstType & "' AND FMLYCODE ='" & LFmlyCode & "'"
                        mysql = mysql & " AND ITEMCODE ='" & LItemCode & "' AND EXCODE ='" & LExCode & "' AND UPTOSTDT>='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' ORDER BY UPTOSTDT"
                        Set RateRec = Nothing
                        Set RateRec = New ADODB.Recordset
                        RateRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If RateRec.EOF Then
                            mysql = "SELECT SHRATE,SHTYPE FROM PEXSBROK WHERE COMPCODE =" & GCompCode & " AND PARTY ='" & LParty & "' AND INSTTYPE ='" & LInstType & "' AND FMLYCODE ='" & LFmlyCode & "'"
                            mysql = mysql & " AND EXCODE ='" & LExCode & "' AND UPTOSTDT>='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' ORDER BY UPTOSTDT"
                            Set RateRec = Nothing
                            Set RateRec = New ADODB.Recordset
                            RateRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not RateRec.EOF Then
                                LShRate = RateRec!SHRATE
                                LShType = RateRec!SHTYPE
                            End If
                        Else
                            LShRate = RateRec!SHRATE
                            LShType = RateRec!SHTYPE
                        End If
                        If LShRate <> 0 Then
                            If LMULTI = 1 Then
                                If LClQty <> 0 Then LSHQTY = (LClQty * -1) * (LShRate / 100)
                                If LShType = "N" Then
                                    LShareAmt = (LDiffAmt) * -1 * (LShRate / 100)
                                Else
                                    LShareAmt = (LDiffAmt) * -1 * (LShRate / 100)
                                End If
                            Else
                                LShRate = (LShRate * LMULTI) / (LMULTI - 1)
                                If LClQty <> 0 Then LSHQTY = (LClQty * -1) * (LShRate / 100)
                                If LShType = "N" Then
                                    LShareAmt = (LDiffAmt) * -1 * (LShRate / 100)
                                Else
                                    LShareAmt = (LDiffAmt) * -1 * (LShRate / 100)
                                End If
                            End If
                        End If
                    End If
                    RecRpt.AddNew
                    RecRpt!Sauda = LSaudaCode:      RecRpt!PARTY = LPartyCode
                    RecRpt!PARTY = LPartyName:      RecRpt!CLQTY = LClQty
                    RecRpt!excode = LExCode:        RecRpt!ClRate = LCLRATE
                    RecRpt!DIFFAMT = LDiffAmt:      RecRpt!BROKAMT = LBrokAmt
                    RecRpt!FMLYCODE = LFmlyCode:    RecRpt!FmlyNAME = LFmlyName
                    RecRpt!SHQTY = LSHQTY:          RecRpt!SHAREAMT = LShareAmt
                    RecRpt!NETRATE = LNetRate
                    RecRpt.Update
                    TRec.MoveNext
                Loop
                LFmlyRec2.MoveNext
            Loop
            FmlyRec.MoveNext
        Loop
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        Set TRec = RecRpt.Clone
        If Check9.Value = 1 Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Billwise-BRSumm.RPT", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "Billwise-BRSumm.RPT", 1)
        End If
        
        mysql = "'Party wise Summary from  " & vcDTP1.Value & " to " & vcDTP2.Value & "'"
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    End If
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
    
    OkCmd.Enabled = True
End Sub
Sub InvDWise_Report()
    On Error GoTo err1
    Dim LPartyName As String:       Dim LItemCode As String:        Dim LFmlyName As String:        Dim LExCode As String:   Dim LPartyCode  As String:  Dim LSaudaCode As String
    Dim TRec As ADODB.Recordset:    Dim TRec2 As ADODB.Recordset:   Dim MPrvCloseRate  As Double:   Dim LPrevStd As Double:  Dim LPBQnty As Double:      Dim LRegLot As Double
    Dim LPSQnty As Double:          Dim LClQty As Double:           Dim LCLRATE  As Double:         Dim MABAmt As Double:    Dim LCloseRate As Double:   Dim MBLQty As Double
    Dim MNetAmt As Double:          Dim MNetQty As Double:          Dim MBQty As Double:            Dim msqty As Double:     Dim DCloseRate As Double:   Dim LastClosingDate As Date
    Dim LDiffAmt As Double:         Dim LBrokAmt  As Double:        Dim LMDT As Date:               Dim LPQty As Double:     Dim LRATE As Double:        Dim LConCode  As String
    Dim LBrokerName As String:      Dim LBuyAmt As Double:          Dim LSellAmt As Double:         Dim LNetRate As Double:  Dim LNetAmt As Double:      Dim LShareAmt As Double
    Dim LOpenQty As Double:         Dim LOpenRate As Double:        Dim LOpenmAmt As Double:        Dim LLOT As Double:      Dim LInstType As String:    Dim LSaudaID As Long
    Dim lOpQty As Double:           Dim lOpRate As Double:          Dim LMULTI As Double:           Dim Lmaturity As Date:   Dim LBuyQty As Double:      Dim LSellQty As Double:
    Dim LShRate As Double:          Dim LShType As String:          Dim LSHQTY As Double:           Dim LContra_Ac As String: Dim RateRec As ADODB.Recordset
    Dim LACCID As Long
    
    LSExCodes = Get_ExCodes:        LSParties = Get_Parties
    LSSaudas = Get_Saudas:          LSInst = Get_Inst

    Me.MousePointer = Val(11): OkCmd.Enabled = False
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "PARTYCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "PARTY", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "OPQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "OPRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BUYQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BUYAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SELLQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SELLAMT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CLQTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "CLRATE", adDouble, , adFldIsNullable
    
    'End If
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    mysql = "SELECT I.EXCODE,I.ITEMCODE,I.SAUDAID,I.SAUDA,S.INSTTYPE,S.MATURITY,I.PARTY,A.ACCID,A.NAME,A.MULTIPLIER,I.CALVAL,"
    mysql = mysql & " SUM(TOTBQTY) AS BQTY ,SUM(TOTBAMT) AS BAMT , SUM(TOTSQTY) AS SQTY ,SUM(TOTSAMT) AS SAMT"
    mysql = mysql & " FROM INV_D AS I, ACCOUNTD AS A , SAUDAMAST AS S "
    mysql = mysql & " WHERE I.COMPCODE=" & GCompCode & " AND I.ACCID  = A.ACCID "
    mysql = mysql & " AND S.SAUDAID  =I.SAUDAID "
    mysql = mysql & " AND I.STDATE >='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND I.STDATE <='" & Format(vcDTP2.Value, "yyyy/MM/dd") & "'"
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND I.EXID  IN (" & LSExCodes & ")"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID  IN (SELECT ACCID  FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
    If AllSaudas = False Then mysql = mysql & " AND I.SAUDAID IN (" & LSSaudas & ") "
    mysql = mysql & " GROUP BY I.EXCODE,I.ITEMCODE,I.SAUDAID,I.SAUDA,S.INSTTYPE,S.MATURITY,I.PARTY,A.ACCID,A.NAME,A.MULTIPLIER,I.CALVAL "
    mysql = mysql & " ORDER BY A.NAME,I.EXCODE, I.SAUDA "
    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    Do While Not TRec.EOF
        LSaudaCode = TRec!Sauda:            LPartyName = TRec!NAME:     LPartyCode = TRec!PARTY:            LExCode = TRec!excode
        LDiffAmt = 0:                       LBrokAmt = 0:               LLOT = TRec!CALVAL:                 LItemCode = TRec!ITEMCODE
        LClQty = 0:                         LCLRATE = 0:                LNetRate = 0:                       LNetAmt = 0
        LBuyAmt = 0:                        LSellAmt = 0:               LSHQTY = 0:                         LShRate = 0
        LShareAmt = 0:                      LMULTI = 1:                 LBuyQty = 0:                        LSellQty = 0
        LBuyAmt = 0:                        LSellAmt = 0
        LSaudaID = TRec!SAUDAID
        LACCID = TRec!ACCID
        
        LInstType = TRec!INSTTYPE
        LOpenQty = 0: LOpenRate = 0
        LClQty = Get_CloseQty(LACCID, LSaudaID, vcDTP2.Value)
        LOpenQty = Get_CloseQty(LACCID, LSaudaID, vcDTP1.Value - 1)
        LCLRATE = SDCLRATE(LSaudaID, vcDTP2.Value, "C")
        LOpenRate = SDCLRATE(LSaudaID, vcDTP1.Value - 1, "O")
        Lmaturity = TRec!MATURITY
        LBuyQty = Val(TRec!BQTY & vbNullString)
        LBuyAmt = Val(TRec!BAMT & vbNullString)
        LSellQty = Val(TRec!SQTY & vbNullString)
        LSellAmt = Val(TRec!SAmt & vbNullString)
        
        If LOpenQty > 0 Then
            LBuyQty = LBuyQty + LOpenQty
            LBuyAmt = LBuyAmt + (LOpenQty * LOpenRate)
        ElseIf LOpenQty < 0 Then
            LSellQty = LSellQty + Abs(LOpenQty)
            LSellAmt = LSellAmt + (Abs(LOpenQty) * LOpenRate * LLOT)
        End If
        RecRpt.AddNew
        RecRpt!excode = TRec!excode:       RecRpt!Sauda = TRec!Sauda
        RecRpt!PARTYCODE = LPartyCode:     RecRpt!PARTY = LPartyName
        RecRpt!OpQty = LOpenQty:           RecRpt!OPRATE = LOpenRate
        RecRpt!BUYQTY = LBuyQty:           RecRpt!BUYAMT = LBuyAmt
        RecRpt!SELLQTY = LSellQty:         RecRpt!SELLAMT = LSellAmt
        RecRpt!CLQTY = LClQty:             RecRpt!ClRate = LCLRATE
        
        RecRpt.Update
        TRec.MoveNext
    Loop
        
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        Set TRec = RecRpt.Clone
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "INV_DRPT.RPT", 1)
        mysql = "'Party wise Summary from  " & vcDTP1.Value & " to " & vcDTP2.Value & "'"
        
        
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
    
    OkCmd.Enabled = True
End Sub
Sub Sauda_Wise_Standing2()

    On Error GoTo err1
    Dim LPartyName As String:       Dim LItemCode As String:        Dim LFmlyName As String:        Dim LExCode As String:   Dim LPartyCode  As String:  Dim LSaudaCode As String
    Dim TRec As ADODB.Recordset:    Dim TRec2 As ADODB.Recordset:   Dim MPrvCloseRate  As Double:   Dim MQnty As Double:     Dim LCloseRate As Double:   Dim LInstType As String
    Dim MNetAmt As Double:          Dim DCloseRate As Double:       Dim LBrokerName As String:      Dim LSaudaID As Long:    Dim LExID As Integer:       Dim LItemID As Integer
    Dim LSellQty  As Double::       Dim LCalval As Double:          Dim LRefLot As Double:          Dim LShareQty As Double: Dim LBuyQty As Double:      Dim LShRate As Double
    Dim TempRec As ADODB.Recordset: Dim MRec As ADODB.Recordset:    Dim LConCode As String:         Dim LFmlyCode As String: Dim LAvgRate As Double:     Dim LMDT  As Date:
    Dim LPQty As Double:            Dim LBalQty As Double:          Dim LACCID As Long:             Dim BranchRec As ADODB.Recordset
    Dim LAcExCode As String:        Dim acexRec As ADODB.Recordset: Dim LRATE As Double
                            
    LSExCodes = Get_ExCodes:    LSFmlyIDs = Get_FmlyCodes
    
    If Check4.Value = 1 Then
        LSParties = Get_ALL_Parties
    Else
        LSParties = Get_Parties
    End If
    
    LSSaudas = Get_Saudas:      LSInst = Get_Inst
    
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    GETMAIN.Label1.Caption = "Fetching Data"
    DoEvents
    mysql = "SELECT A.ACCID,A.AC_CODE,A.NAME,S.EXID,S.ITEMCODE,S.MATURITY,S.ITEMID,S.INSTTYPE,S.SAUDAID,S.REFLOT,S.SAUDACODE,S.EXCODE,I.REFLOT AS IREFLOT,C.CALVAL,"
    mysql = mysql & " SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY WHEN 'S' THEN C.QTY*-1 END ) AS SUMOFQTY"
    mysql = mysql & " From CTR_D AS C, SAUDAMAST AS S,ACCOUNTD AS A ,ITEMMAST AS I WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID =C.ACCID "
    mysql = mysql & " AND C.CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    mysql = mysql & " AND I.ITEMID = S.ITEMID "
    mysql = mysql & " AND C.SAUDAID=S.SAUDAID AND S.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND S.EXID  IN (" & LSExCodes & ")"
    If (AllFmly = False Or LenB(LSFmlyIDs) > 0) And AllParties = True Then
        mysql = mysql & " AND A.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
    If AllSaudas = False And LenB(LSSaudas) > 0 Then mysql = mysql & " AND S.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " GROUP BY A.ACCID,A.AC_CODE,A.NAME ,S.EXID,S.ITEMCODE,S.MATURITY,S.ITEMID,S.INSTTYPE,S.SAUDAID,S.REFLOT ,S.SAUDACODE ,S.EXCODE ,C.CALVAL,I.REFLOT"
    mysql = mysql & " HAVING ROUND(SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY * 1 WHEN 'S' THEN C.QTY*-1 END),2) <> 0"
    mysql = mysql & " ORDER BY S.EXCODE,S.ITEMCODE,S.MATURITY,S.INSTTYPE,S.SAUDAID,A.NAME"

    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Check4.Value = 1 Then  'party and sauda wise and with sharing
        Set TempRec = Nothing
        Set TempRec = New ADODB.Recordset
        TempRec.Fields.Append "PARTY", adVarChar, 15, adFldIsNullable
        TempRec.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
        TempRec.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        TempRec.Fields.Append "EXCODE", adVarChar, 20, adFldIsNullable
        TempRec.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        TempRec.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        TempRec.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        TempRec.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        TempRec.Fields.Append "BUYQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "SELLQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "SHAREQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        TempRec.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        TempRec.Open , , adOpenKeyset, adLockBatchOptimistic
        
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PARTY", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        RecRpt.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SHAREQTY", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    Else
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SFMLY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BFMLY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BCODE", adVarChar, 30, adFldIsNullable
        RecRpt.Fields.Append "SCODE", adVarChar, 30, adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    End If
    
    Do While Not TRec.EOF
    
        LSaudaCode = TRec!saudacode
        LSaudaID = TRec!SAUDAID
        DCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value), "C")
        MPrvCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value - 1), "O")
        GETMAIN.Label1.Caption = LSaudaCode
        DoEvents
        Do While LSaudaCode = TRec!saudacode
            LPartyCode = TRec!AC_CODE:          LPartyName = Trim(TRec!NAME)
            LExCode = TRec!excode:              LRefLot = TRec!REFLOT
            LCalval = TRec!CALVAL::             LExID = TRec!EXID
            LItemID = TRec!itemid:              LInstType = TRec!INSTTYPE
            LConCode = vbNullString:            LBrokerName = vbNullString
            LACCID = TRec!ACCID
            LAcExCode = LPartyCode
            If Check9.Value = 1 Then
                LConCode = TRec!CONCODE
                LBrokerName = TRec!BROKER
            End If
            MQnty = TRec!SUMOFQTY
            If TRec!IREFLOT > 0 And Check11.Value = 1 Then
                'MQnty = MQnty / TRec!IREFLOT
            End If

            'Consolidated
            LAcExCode = TRec!AC_CODE
            If Check11.Value = 1 Then
                Set acexRec = Nothing
                Set acexRec = New ADODB.Recordset
                mysql = "SELECT UCC FROM ACCOUNTD "
                mysql = mysql & " Where COMPCODE=" & GCompCode & " AND  ACCID  =" & LACCID & ""
                acexRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not acexRec.EOF Then
                    If Len(acexRec!UCC) > 0 Then
                        LAcExCode = acexRec!UCC
                        LPartyName = Trim(acexRec!UCC)
                    End If
                End If
            End If
            
            If Check4.Value = 1 Then   'party and sauda wise and with sharing

                If TempRec.RecordCount > 0 Then
                    TempRec.MoveFirst
                End If
                TempRec.Filter = "PARTY = '" & Left(LAcExCode, 15) & "' and Sauda = '" & LSaudaCode & "'"
                If TempRec.EOF Then
                
                    TempRec.Filter = adFilterNone
                    
                    TempRec.AddNew
                    TempRec!PARTY = Left(LAcExCode, 15)
                    If Check11.Value = 1 Then
                        If Len(acexRec!UCC) > 0 Then
                            TempRec!NAME = Trim(LAcExCode)
                        Else
                            TempRec!NAME = Trim(LPartyName)
                        End If
                    Else
                        TempRec!NAME = Trim(LPartyName)
                    End If

                    TempRec!shareqty = 0
                    TempRec!SELLQTY = 0
                    TempRec!BUYQTY = 0
                Else
                    'MQnty = MQnty + TempRec!BUYQTY - TempRec!SELLQTY
                End If
                
                TempRec!Sauda = LSaudaCode:
                'TempRec!NAME = LPartyName:       TempRec!party = LPartyCode
                TempRec!excode = LExCode:        TempRec!setrate = DCloseRate
                TempRec!PRVRate = MPrvCloseRate: TempRec!REFLOT = LRefLot
                TempRec!CALVAL = LCalval
                'TempRec!shareqty = 0
                
                If Round(MQnty, 2) > 0 Then
                    TempRec!BUYQTY = TempRec!BUYQTY + Abs(Val(MQnty))
                Else
                    TempRec!SELLQTY = TempRec!SELLQTY + Abs(Val(MQnty))
                End If
                
              
                'If Round(MQnty, 2) > 0 Then
                '    TempRec!SELLQTY = 0:
                '    TempRec!BUYQTY = Abs(Val(MQnty))
                'Else
                '    TempRec!SELLQTY = Abs(Val(MQnty))
                '    TempRec!BUYQTY = 0:
                'End If
                TempRec.Update
                
                Set BranchRec = Nothing
                Set BranchRec = New ADODB.Recordset
                mysql = "SELECT A.FMLYID ,A.FMLYCODE,A.FMLYNAME,A.FMLYHEAD,A.CONTRA_AC,A.HEADID,A.CONTRAID FROM ACCFMLY AS A, ACCFMLYD AS B"
                mysql = mysql & " Where A.COMPCODE=B.COMPCODE AND A.COMPCODE=" & GCompCode & " AND  A.FMLYID =B.FMLYID AND B.ACCID  =" & LACCID & ""
                BranchRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not BranchRec.EOF Then
                    Do While Not BranchRec.EOF
                        LShRate = 0
                        
                        mysql = " EXEC GET_SHARERATE " & BranchRec!FMLYID & "," & LACCID & "," & LExID & "," & LItemID & ",'" & LInstType & "','" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                        Set MRec = Nothing
                        Set MRec = New ADODB.Recordset
                        MRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not MRec.EOF Then LShRate = MRec!SHRATE
                        If LShRate <> 0 Then
                            
                            'Consolidated
                            LAcExCode = BranchRec!FMLYHEAD
                            If Check11.Value = 1 Then
                                Set acexRec = Nothing
                                Set acexRec = New ADODB.Recordset
                                mysql = "SELECT UCC FROM ACCOUNTD "
                                mysql = mysql & " Where COMPCODE=" & GCompCode & " AND  ACCID  =" & BranchRec!HEADID & ""
                                acexRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not acexRec.EOF Then
                                    If Len(acexRec!UCC) > 0 Then
                                        LAcExCode = acexRec!UCC
                                    End If
                                End If
                            End If
                            If TempRec.RecordCount > 0 Then
                                TempRec.MoveFirst
                            End If
                            
                            TempRec.Filter = "PARTY = '" & Left(LAcExCode, 15) & "' and Sauda = '" & LSaudaCode & "'"
                            If TempRec.EOF Then
                                TempRec.Filter = adFilterNone
                                TempRec.AddNew
                                TempRec!PARTY = Left(LAcExCode, 15)
                                TempRec!SELLQTY = 0: TempRec!BUYQTY = 0
                                If Check11.Value = 1 Then
                                    If Len(acexRec!UCC) > 0 And Check11.Value = 1 Then
                                        TempRec!NAME = Trim(LAcExCode)
                                    Else
                                        LPartyName = Get_AccountName(BranchRec!HEADID):      TempRec!NAME = Trim(LPartyName):
                                    End If
                                Else
                                    LPartyName = Get_AccountName(BranchRec!HEADID):      TempRec!NAME = Trim(LPartyName):
                                End If
                                TempRec!shareqty = 0
                           ' Else
                                'MQnty = MQnty + TempRec!BUYQTY - TempRec!SELLQTY
                            End If
                           
                            TempRec!Sauda = LSaudaCode::
                            'LPartyName = Get_AccountName(BranchRec!HEADID):       TempRec!NAME = LPartyName:
                            TempRec!excode = LExCode:                               TempRec!setrate = DCloseRate
                            TempRec!PRVRate = MPrvCloseRate:                        TempRec!REFLOT = LRefLot
                            'TempRec!SELLQTY = 0:                                    TempRec!BUYQTY = 0
                            TempRec!CALVAL = LCalval:
                            TempRec!shareqty = IIf(IsNull(TempRec!shareqty), 0, TempRec!shareqty) + (Round((MQnty * -1) * (LShRate / 100), 2))
                            'TempRec!shareqty = Round((MQnty * -1) * (LShRate / 100), 2)
                            TempRec.Update
    
                            'LContr_Ac
                            LAcExCode = BranchRec!Contra_Ac
                            If Check11.Value = 1 Then
                                Set acexRec = Nothing
                                Set acexRec = New ADODB.Recordset
                                mysql = "SELECT UCC FROM ACCOUNTD "
                                mysql = mysql & " Where COMPCODE=" & GCompCode & " AND  ACCID  =" & BranchRec!CONTRAID & ""
                                acexRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not acexRec.EOF Then
                                    If Len(acexRec!UCC) > 0 Then
                                        LAcExCode = acexRec!UCC
                                    End If
                                End If
                            End If
                            
                            If TempRec.RecordCount > 0 Then
                                TempRec.MoveFirst
                            End If
                            TempRec.Filter = "PARTY = '" & Left(LAcExCode, 15) & "' and Sauda = '" & LSaudaCode & "'"
                            If TempRec.EOF Then
                                TempRec.Filter = adFilterNone
                                TempRec.AddNew
                                TempRec!PARTY = Left(LAcExCode, 15)
                                TempRec!SELLQTY = 0: TempRec!BUYQTY = 0
                                TempRec!shareqty = 0
                                If Check11.Value = 1 Then
                                    If Len(acexRec!UCC) > 0 And Check10.Value = 1 Then
                                        TempRec!NAME = Trim(LAcExCode)
                                    Else
                                        LPartyName = Get_AccountName(BranchRec!CONTRAID):     TempRec!NAME = Trim(LPartyName):
                                    End If
                                Else
                                    LPartyName = Get_AccountName(BranchRec!CONTRAID):     TempRec!NAME = Trim(LPartyName):
                                End If
                           ' Else
                                'MQnty = MQnty + TempRec!BUYQTY - TempRec!SELLQTY
                            End If
                            
                            TempRec!Sauda = LSaudaCode:                            TempRec!PARTY = BranchRec!Contra_Ac
                            'LPartyName = Get_AccountName(BranchRec!CONTRAID):     TempRec!NAME = LPartyName:
                            TempRec!excode = LExCode:                              TempRec!setrate = DCloseRate
                            TempRec!PRVRate = MPrvCloseRate:                       TempRec!REFLOT = LRefLot
                            'TempRec!SELLQTY = 0:                                   TempRec!BUYQTY = 0
                            TempRec!CALVAL = LCalval:
                            'TempRec!shareqty = Round((MQnty) * (LShRate / 100), 2)
                            TempRec!shareqty = IIf(IsNull(TempRec!shareqty), 0, TempRec!shareqty) + (Round((MQnty) * (LShRate / 100), 2))

                            TempRec.Update
                        End If
GONEXT:
                        BranchRec.MoveNext
                    Loop

                End If
            Else
                If Option4.Value = True Then 'partywise
                    If RecRpt.RecordCount > 0 Then
                        RecRpt.MoveFirst
                    End If
                    RecRpt.Filter = "BCODE = '" & Left(LAcExCode, 15) & "' and Sauda = '" & LSaudaCode & "'"
                    If RecRpt.EOF Then
                        RecRpt.Filter = adFilterNone
                        
                        RecRpt.AddNew
                        RecRpt!Sauda = LSaudaCode:
                        RecRpt!bparty = Trim(LPartyName):     RecRpt!BCODE = LAcExCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LCalval
                    End If
                    LAvgRate = 0
                    If Option2.Value = True Then 'avg rate
                        'If Check3.Value = 1 Then
                        mysql = "SELECT MAX(SETDATE) AS MDT FROM SETTLE WHERE COMPCODE =" & GCompCode & " AND SETDATE <'" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                        Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                        TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec2.EOF Then
                            LMDT = IIf(IsNull(TRec2!MDt), GFinBegin, TRec2!MDt)
                            LPQty = Get_CloseQty(LACCID, LSaudaID, LMDT)
                            LRATE = SDCLRATE(LSaudaID, DateValue(LMDT), "C")
                            MNetAmt = LPQty * LRATE
                            Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                            mysql = "SELECT SUM(CASE CONTYPE WHEN 'B' THEN QTY*RATE WHEN 'S' THEN QTY*RATE*-1 END ) AS AMT FROM CTR_D WHERE"
                            mysql = mysql & " ACCID =" & LACCID & " AND CONDATE >'" & Format(LMDT, "yyyy/MM/dd") & "' AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
                            mysql = mysql & " AND SAUDAID=" & LSaudaID & ""
                            TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec2.EOF Then
                                MNetAmt = Abs(MNetAmt + (IIf(IsNull(TRec2!AMT), 0, TRec2!AMT)))
                            End If
                        End If
                    Else
                        LBalQty = Abs(MQnty)
                        If LBalQty <> 0 Then
                            mysql = "SELECT CONTYPE,RATE,QTY FROM CTR_D WHERE ACCID =" & LACCID & ""
                            mysql = mysql & " AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
                            'If MQnty > 0 Then
                            '    MYSQL = MYSQL & " AND CONTYPE ='B'"
                            'Else
                                '   MYSQL = MYSQL & " AND CONTYPE ='S'"
                            'End If
                            mysql = mysql & " AND SAUDAID =" & LSaudaID & " ORDER BY CONDATE DESC ,CONNO DESC "
                            Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                            TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            Do While Not TRec2.EOF
                                If TRec2!CONTYPE = "B" Then
                                    MNetAmt = MNetAmt + TRec2!QTY * TRec2!Rate
                                Else
                                    MNetAmt = MNetAmt - TRec2!QTY * TRec2!Rate
                                End If
                                TRec2.MoveNext
                            Loop
                            Set TRec2 = Nothing
                        End If
                        'End If
                    End If
                    LAvgRate = MNetAmt / MQnty
                    If Round(MQnty, 2) > 0 Then
                        RecRpt!SQnty = 0:               RecRpt!SRate = 0:
                        RecRpt!BQnty = Abs(Val(MQnty)): RecRpt!BRate = LAvgRate:
                    Else
                        RecRpt!SQnty = Abs(Val(MQnty)): RecRpt!SRate = LAvgRate
                        RecRpt!BQnty = 0:               RecRpt!BRate = 0:
                    End If
                    RecRpt.Update
                Else ' saudawise
                    If MQnty > 0 Then
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "BPARTY ='' AND SAUDA='" & LSaudaCode & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!SPARTY = vbNullString
                            RecRpt!SQnty = 0
                        End If
                        RecRpt!bparty = Trim(LPartyName):     RecRpt!BCODE = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LCalval:        RecRpt!Sauda = LSaudaCode
                        RecRpt!BQnty = Abs(Val(MQnty))
                        RecRpt.Update
                        If LExCode = "NSE" Then
                            RecRpt!BRate = LRefLot
                        End If
                    Else
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "SPARTY ='' AND SAUDA='" & LSaudaCode & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!bparty = vbNullString
                            RecRpt!BQnty = 0
                        End If
                        RecRpt!SPARTY = Trim(LPartyName):     RecRpt!scode = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LRefLot:        RecRpt!Sauda = LSaudaCode
                        RecRpt!SQnty = Abs(Val(MQnty))
                        RecRpt.Update
                        If LExCode = "NSE" Then
                            RecRpt!SRate = LRefLot
                        End If
                    End If
                    RecRpt.Filter = adFilterNone
                End If
            End If
            
            TRec.MoveNext
            If TRec.EOF Then Exit Do
        Loop
        If TRec.EOF Then Exit Do
    Loop
    
    GETMAIN.Label1.Caption = ""
    DoEvents
    If Check4.Value = 1 Then ' Sharing
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        Set TRec = TempRec.Clone
        
        LSParties = Replace(Replace(LSParties, "'", ""), ", ", ",")
        If (LSParties <> "") Then
            LSParties = "," & LSParties
            LSParties = LSParties & ","
        End If
        
        If TRec.RecordCount > 0 Then
            TRec.Sort = "PARTY,SAUDA"
            TRec.MoveFirst
            Do While Not TRec.EOF
                LPartyCode = TRec!PARTY:                LSaudaCode = TRec!Sauda
                LPartyName = Trim(TRec!NAME):                 LExCode = TRec!excode
                DCloseRate = TRec!setrate:              MPrvCloseRate = TRec!PRVRate
                LCalval = TRec!CALVAL:                  LRefLot = TRec!REFLOT
                LFmlyCode = TRec!FMLYCODE & vbNullString
                LFmlyName = TRec!FmlyNAME & vbNullString
                LBuyQty = 0: LSellQty = 0: LShareQty = 0
                GETMAIN.Label1.Caption = "Sharing " & LPartyName & " " & LSaudaCode & ""
                DoEvents
                Do While TRec!PARTY = LPartyCode And TRec!Sauda = LSaudaCode
                    LBuyQty = LBuyQty + TRec!BUYQTY
                    LSellQty = LSellQty + TRec!SELLQTY
                    LShareQty = LShareQty + TRec!shareqty
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
'Partywise
'                If Option4.Value Then  'party wise
                     
                    If (LSParties = "") Or (InStr(1, LSParties, "," & LPartyCode + ",") > 0) Then
                        RecRpt.AddNew
                        RecRpt!Sauda = LSaudaCode:
                        RecRpt!NAME = LPartyName:       RecRpt!PARTY = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LCalval
                        RecRpt!FMLYCODE = LFmlyCode
                        RecRpt!FmlyNAME = LFmlyName
                        MQnty = LBuyQty + (LSellQty * -1)
                        If Round(MQnty, 2) > 0 Then
                            RecRpt!SQnty = 0:
                            RecRpt!BQnty = Abs(Val(MQnty)):
                        Else
                            RecRpt!SQnty = Abs(Val(MQnty)):
                            RecRpt!BQnty = 0:
                        End If
                        RecRpt!shareqty = LShareQty
                        RecRpt.Update
                    End If
            Loop
            
            RecRpt.MoveFirst
            Do While Not RecRpt.EOF
                If RecRpt!BQnty - RecRpt!SQnty + RecRpt!shareqty = 0 Then
                    RecRpt.Delete
                End If
                RecRpt.MoveNext
            Loop
           
        End If
    End If
    
    
    RecRpt.Filter = adFilterNone
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    Set TRec = RecRpt.Clone
    LBuyQty = TRec.RecordCount
    If CreateChk.Value = 0 Then
        If Option3.Value = False Then  'party wise
            If Option4.Value And Option1.Value Then
                If Check9.Value = 0 Then
                    If Check4.Value = 1 Then
                        TRec.Sort = "party,EXCODE,SAUDA"
                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT-SHARE.RPT", 1)
                    Else
                        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT.RPT", 1)
                    End If
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CPOUT.rpt", 1)
                End If
            ElseIf Option4.Value And Option1.Value = False Then
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "APOUT.rpt", 1)
            End If
            mysql = "'Party wise Sauda wise Standing upto " & vcDTP1.Value & "'"
        Else 'sauda wise
            If Check4.Value = 1 Then 'sharing
                TRec.Sort = "SAUDA,party,EXCODE"
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MOUT-SHARE.RPT", 1)
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MOUT.rpt", 1)
            End If
            
            mysql = "'Sauda wise Party wise Standing upto " & vcDTP1.Value & "'"
        End If
        RDCREPO.DiscardSavedData
        RDCREPO.Database.SetDataSource TRec
        RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
        RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
        CRViewer1.ZOrder
        CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
        CRViewer1.Visible = True
        CRViewer1.ReportSource = RDCREPO
        CRViewer1.Zoom 1
        CRViewer1.ViewReport
        Me.MousePointer = 0
        OkCmd.Enabled = True
    Else
        Dim iloop As Integer
        Dim LFileSystemObject As FileSystemObject
        If FmlyList.ListItems.Count > 0 Then
            For iloop = 1 To FmlyList.ListItems.Count
            If FmlyList.ListItems(iloop).Checked = True Then
                RecRpt.Filter = adFilterNone
                RecRpt.MoveFirst
                LFmlyName = FmlyList.ListItems(iloop).text
                'RecRpt.Filter = "FMLYCODE = '" & LFmlyName & "' "
                LFmlyName = Replace(Replace(FmlyList.ListItems(iloop).text, "*", ""), "/", "")
                If Not RecRpt.EOF Then
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset: Set TRec = RecRpt '>>>RecRpt.Clone
                                                            
                    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    If (LFileSystemObject.FileExists(App.Path & "\RPT\Standing Branch " & LFmlyName & " - " & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF")) Then
                        LFileSystemObject.DeleteFile App.Path & "\RPT\Standing Branch " & LFmlyName & " - " & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                    End If
                    mysql = "PartyWise Sauda wise Standing upto " & vcDTP1.Value & ""
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT.RPT", 1)
                    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
                    RDCREPO.DiscardSavedData
                    RDCREPO.Database.SetDataSource TRec
                    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
                    RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\Standing Branch " & LFmlyName & " - " & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                    RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
                    RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
                    RDCREPO.ExportOptions.PDFExportAllPages = True
                    RDCREPO.Export False
                End If
            End If
            Next
        Else
        For iloop = 1 To PartyList.ListItems.Count
            If PartyList.ListItems(iloop).Checked = True Then
                RecRpt.Filter = adFilterNone
                RecRpt.MoveFirst
                If Check4.Value = 1 Then
                    RecRpt.Filter = "PARTY = '" & PartyList.ListItems(iloop).ListSubItems(1) & "'"
                Else
                    RecRpt.Filter = "BCODE = '" & PartyList.ListItems(iloop).ListSubItems(1) & "'"
                End If
                LPartyName = Replace(Replace(PartyList.ListItems(iloop).text, "*", ""), "/", "")
                If Not RecRpt.EOF Then
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset: Set TRec = RecRpt '>>>RecRpt.Clone
                                                            
                    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    If (LFileSystemObject.FileExists(App.Path & "\RPT\STANDING -" & LPartyName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF")) Then
                        LFileSystemObject.DeleteFile App.Path & "\RPT\STANDING -" & LPartyName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                    End If
                    mysql = "Party (" & LPartyName & ") wise Sauda wise Standing upto " & vcDTP1.Value & ""
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT.RPT", 1)
                    RDCREPO.FormulaFields.GetItemByName("TITLE").text = "'" & mysql & "'"
                    RDCREPO.DiscardSavedData
                    RDCREPO.Database.SetDataSource TRec
                    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
                    RDCREPO.ExportOptions.DiskFileName = App.Path & "\RPT\STANDING -" & LPartyName & "-" & Left$(CDate(vcDTP1.Value), 2) & Mid(CDate(vcDTP1.Value), 4, 2) & Right$(CDate(vcDTP1.Value), 4) & "-" & Left$(CDate(vcDTP2.Value), 2) & Mid(CDate(vcDTP2.Value), 4, 2) & Right$(CDate(vcDTP2.Value), 4) & ".PDF"
                    RDCREPO.ExportOptions.FormatType = crEFTPortableDocFormat
                    RDCREPO.ExportOptions.DestinationType = crEDTDiskFile
                    RDCREPO.ExportOptions.PDFExportAllPages = True
                    RDCREPO.Export False
                End If
            End If
        Next
        End If
        MsgBox "Report Exported Successfully  "
        
        Me.MousePointer = 0
        GETMAIN.ProgressBar1.Visible = False
        OkCmd.Enabled = True
    End If
    Exit Sub
err1:
    If err.Number <> 0 Then
        MsgBox err.Description, vbCritical, "Error Number : " & err.Number
        Me.MousePointer = 0
        OkCmd.Enabled = True
    End If
End Sub

Sub Sauda_Wise_Standing2_original()
    On Error GoTo err1
    Dim LPartyName As String:       Dim LItemCode As String:        Dim LFmlyName As String:        Dim LExCode As String:   Dim LPartyCode  As String:  Dim LSaudaCode As String
    Dim TRec As ADODB.Recordset:    Dim TRec2 As ADODB.Recordset:   Dim MPrvCloseRate  As Double:   Dim MQnty As Double:     Dim LCloseRate As Double:   Dim LInstType As String
    Dim MNetAmt As Double:          Dim DCloseRate As Double:       Dim LBrokerName As String:      Dim LSaudaID As Long:    Dim LExID As Integer:       Dim LItemID As Integer
    Dim LSellQty  As Double::       Dim LCalval As Double:          Dim LRefLot As Double:          Dim LShareQty As Double: Dim LBuyQty As Double:      Dim LShRate As Double
    Dim TempRec As ADODB.Recordset: Dim MRec As ADODB.Recordset:    Dim LConCode As String:         Dim LFmlyCode As String: Dim LAvgRate As Double:     Dim LMDT  As Date:
    Dim LPQty As Double:            Dim LBalQty As Double:          Dim LACCID As Long:             Dim BranchRec As ADODB.Recordset
    
    Dim LRATE As Double
                        
    
    LSExCodes = Get_ExCodes:    LSFmlyIDs = Get_FmlyCodes
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:      LSInst = Get_Inst
    
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    GETMAIN.Label1.Caption = "Fetching Data"
    DoEvents
    mysql = "SELECT A.ACCID,A.AC_CODE,A.NAME,S.EXID,S.ITEMCODE,S.MATURITY,S.ITEMID,S.INSTTYPE,S.SAUDAID,S.REFLOT,S.SAUDACODE,S.EXCODE,C.CALVAL,"
    mysql = mysql & " SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY WHEN 'S' THEN C.QTY*-1 END ) AS SUMOFQTY"
    mysql = mysql & " From CTR_D AS C, SAUDAMAST AS S,ACCOUNTD AS A  WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID =C.ACCID "
    mysql = mysql & " AND C.CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    mysql = mysql & " AND C.SAUDAID=S.SAUDAID AND S.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND S.EXID  IN (" & LSExCodes & ")"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
    If AllSaudas = False And LenB(LSSaudas) > 0 Then mysql = mysql & " AND S.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " GROUP BY A.ACCID,A.AC_CODE,A.NAME ,S.EXID,S.ITEMCODE,S.MATURITY,S.ITEMID,S.INSTTYPE,S.SAUDAID,S.REFLOT ,S.SAUDACODE ,S.EXCODE ,C.CALVAL"
    mysql = mysql & " HAVING ROUND(SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY * 1 WHEN 'S' THEN C.QTY*-1 END),2) <> 0"
    mysql = mysql & " ORDER BY S.EXCODE,S.ITEMCODE,S.MATURITY,S.INSTTYPE,S.SAUDAID,A.NAME"

    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Check4.Value = 1 Then
        Set TempRec = Nothing
        Set TempRec = New ADODB.Recordset
        TempRec.Fields.Append "PARTY", adVarChar, 15, adFldIsNullable
        TempRec.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
        TempRec.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        TempRec.Fields.Append "EXCODE", adVarChar, 20, adFldIsNullable
        TempRec.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        TempRec.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        TempRec.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        TempRec.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        TempRec.Fields.Append "BUYQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "SELLQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "SHAREQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        TempRec.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        TempRec.Open , , adOpenKeyset, adLockBatchOptimistic
        
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PARTY", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        RecRpt.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SHAREQTY", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    Else
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SFMLY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BFMLY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BCODE", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "SCODE", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    End If
    Do While Not TRec.EOF
    
        LSaudaCode = TRec!saudacode
        LSaudaID = TRec!SAUDAID
        DCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value), "C")
        MPrvCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value - 1), "O")
        GETMAIN.Label1.Caption = LSaudaCode
        DoEvents
        Do While LSaudaCode = TRec!saudacode
            LPartyCode = TRec!AC_CODE:            LPartyName = TRec!NAME
            LExCode = TRec!excode:              LRefLot = TRec!REFLOT
            LCalval = TRec!CALVAL::             LExID = TRec!EXID
            LItemID = TRec!itemid:              LInstType = TRec!INSTTYPE
            LConCode = vbNullString:            LBrokerName = vbNullString
            LACCID = TRec!ACCID
            
            If Check9.Value = 1 Then
                LConCode = TRec!CONCODE
                LBrokerName = TRec!BROKER
            End If
            MQnty = TRec!SUMOFQTY
                       
            If Check4.Value = 1 Then
                TempRec.AddNew
                TempRec!Sauda = LSaudaCode:
                TempRec!NAME = LPartyName:       TempRec!PARTY = LPartyCode
                TempRec!excode = LExCode:        TempRec!setrate = DCloseRate
                TempRec!PRVRate = MPrvCloseRate: TempRec!REFLOT = LRefLot
                TempRec!CALVAL = LCalval
                TempRec!shareqty = 0
                
                If Round(MQnty, 2) > 0 Then
                    TempRec!SELLQTY = 0:
                    TempRec!BUYQTY = Abs(Val(MQnty))
                Else
                    TempRec!SELLQTY = Abs(Val(MQnty))
                    TempRec!BUYQTY = 0:
                End If
                TempRec.Update
                
                Set BranchRec = Nothing
                Set BranchRec = New ADODB.Recordset
                mysql = "SELECT A.FMLYID ,A.FMLYCODE,A.FMLYNAME,A.FMLYHEAD,A.CONTRA_AC,A.HEADID,A.CONTRAID FROM ACCFMLY AS A, ACCFMLYD AS B"
                mysql = mysql & " Where A.COMPCODE=B.COMPCODE AND A.COMPCODE=" & GCompCode & " AND  A.FMLYID =B.FMLYID AND B.ACCID  =" & LACCID & ""
                BranchRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not BranchRec.EOF Then
                    Do While Not BranchRec.EOF
                        LShRate = 0
                        
                        mysql = " EXEC GET_SHARERATE " & BranchRec!FMLYID & "," & LACCID & "," & LExID & "," & LItemID & ",'" & LInstType & "','" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                        Set MRec = Nothing
                        Set MRec = New ADODB.Recordset
                        MRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not MRec.EOF Then LShRate = MRec!SHRATE
                        If LShRate <> 0 Then
                            TempRec.AddNew
                            TempRec!Sauda = LSaudaCode::                            TempRec!PARTY = BranchRec!FMLYHEAD
                            LPartyName = Get_AccountName(BranchRec!HEADID):       TempRec!NAME = LPartyName:
                            TempRec!excode = LExCode:                               TempRec!setrate = DCloseRate
                            TempRec!PRVRate = MPrvCloseRate:                        TempRec!REFLOT = LRefLot
                            TempRec!SELLQTY = 0:                                    TempRec!BUYQTY = 0
                            TempRec!CALVAL = LCalval:                               TempRec!shareqty = Round((MQnty * -1) * (LShRate / 100), 2)
                            TempRec.Update

                            'LContr_Ac
                            TempRec.AddNew
                            TempRec!Sauda = LSaudaCode:                            TempRec!PARTY = BranchRec!Contra_Ac
                            LPartyName = Get_AccountName(BranchRec!CONTRAID):     TempRec!NAME = LPartyName:
                            TempRec!excode = LExCode:                              TempRec!setrate = DCloseRate
                            TempRec!PRVRate = MPrvCloseRate:                       TempRec!REFLOT = LRefLot
                            TempRec!SELLQTY = 0:                                   TempRec!BUYQTY = 0
                            TempRec!CALVAL = LCalval:                              TempRec!shareqty = Round((MQnty) * (LShRate / 100), 2)
                            TempRec.Update
                        End If
GONEXT:
                        BranchRec.MoveNext
                    Loop

                End If
            Else
                If Option4.Value = True Then 'partywise
                    RecRpt.AddNew
                    RecRpt!Sauda = LSaudaCode:
                    RecRpt!bparty = LPartyName:     RecRpt!BCODE = LPartyCode
                    RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                    RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                    RecRpt!CALVAL = LCalval
                    LAvgRate = 0
                    If Option2.Value = True Then 'avg rate
                        'If Check3.Value = 1 Then
                            mysql = "SELECT MAX(SETDATE) AS MDT FROM SETTLE WHERE COMPCODE =" & GCompCode & " AND SETDATE <'" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                            Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                            TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec2.EOF Then
                                LMDT = IIf(IsNull(TRec2!MDt), GFinBegin, TRec2!MDt)
                                LPQty = Get_CloseQty(LACCID, LSaudaID, LMDT)
                                LRATE = SDCLRATE(LSaudaID, DateValue(LMDT), "C")
                                MNetAmt = LPQty * LRATE
                                Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                                mysql = "SELECT SUM(CASE CONTYPE WHEN 'B' THEN QTY*RATE WHEN 'S' THEN QTY*RATE*-1 END ) AS AMT FROM CTR_D WHERE"
                                mysql = mysql & " ACCID =" & LACCID & " AND CONDATE >'" & Format(LMDT, "yyyy/MM/dd") & "' AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
                                mysql = mysql & " AND SAUDAID=" & LSaudaID & ""
                                TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec2.EOF Then
                                    MNetAmt = Abs(MNetAmt + (IIf(IsNull(TRec2!AMT), 0, TRec2!AMT)))
                                End If
                            End If
                    Else
                            LBalQty = Abs(MQnty)
                            If LBalQty <> 0 Then
                                mysql = "SELECT CONTYPE,RATE,QTY FROM CTR_D WHERE ACCID =" & LACCID & ""
                                mysql = mysql & " AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
                                'If MQnty > 0 Then
                                '    MYSQL = MYSQL & " AND CONTYPE ='B'"
                                'Else
                                 '   MYSQL = MYSQL & " AND CONTYPE ='S'"
                                'End If
                                mysql = mysql & " AND SAUDAID =" & LSaudaID & " ORDER BY CONDATE DESC ,CONNO DESC "
                                Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                                TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                Do While Not TRec2.EOF
                                    If TRec2!CONTYPE = "B" Then
                                        MNetAmt = MNetAmt + TRec2!QTY * TRec2!Rate
                                    Else
                                        MNetAmt = MNetAmt - TRec2!QTY * TRec2!Rate
                                    End If
                                    TRec2.MoveNext
                                Loop
                                Set TRec2 = Nothing
                            End If
                        'End If
                    End If
                        LAvgRate = MNetAmt / MQnty
                    
'
                    
                    If Round(MQnty, 2) > 0 Then
                        RecRpt!SQnty = 0:               RecRpt!SRate = 0:
                        RecRpt!BQnty = Abs(Val(MQnty)): RecRpt!BRate = LAvgRate:
                    Else
                        RecRpt!SQnty = Abs(Val(MQnty)): RecRpt!SRate = LAvgRate
                        RecRpt!BQnty = 0:               RecRpt!BRate = 0:
                    End If
                    RecRpt.Update
                Else ' saudawise
                    If MQnty > 0 Then
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "BPARTY ='' AND SAUDA='" & LSaudaCode & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!SPARTY = vbNullString
                            RecRpt!SQnty = 0
                        End If
                        RecRpt!bparty = LPartyName:     RecRpt!BCODE = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LCalval:        RecRpt!Sauda = LSaudaCode
                        RecRpt!BQnty = Abs(Val(MQnty))
                        RecRpt.Update
                        If LExCode = "NSE" Then
                            RecRpt!BRate = LRefLot
                        End If
                    Else
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "SPARTY ='' AND SAUDA='" & LSaudaCode & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!bparty = vbNullString
                            RecRpt!BQnty = 0
                        End If
                        RecRpt!SPARTY = LPartyName:     RecRpt!scode = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LRefLot:        RecRpt!Sauda = LSaudaCode
                        RecRpt!SQnty = Abs(Val(MQnty))
                        RecRpt.Update
                        If LExCode = "NSE" Then
                            RecRpt!SRate = LRefLot
                        End If
                    End If
                    RecRpt.Filter = adFilterNone
                End If
            End If
            
            TRec.MoveNext
            If TRec.EOF Then Exit Do
        Loop
        If TRec.EOF Then Exit Do
    Loop
    GETMAIN.Label1.Caption = ""
    DoEvents
    If Check4.Value = 1 Then ' Sharing
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        Set TRec = TempRec.Clone
    
        If TRec.RecordCount > 0 Then
            TRec.Sort = "PARTY,SAUDA"
            TRec.MoveFirst
            Do While Not TRec.EOF
                LPartyCode = TRec!PARTY:                LSaudaCode = TRec!Sauda
                LPartyName = TRec!NAME:                 LExCode = TRec!excode
                DCloseRate = TRec!setrate:              MPrvCloseRate = TRec!PRVRate
                LCalval = TRec!CALVAL:                  LRefLot = TRec!REFLOT
                LFmlyCode = TRec!FMLYCODE & vbNullString
                LFmlyName = TRec!FmlyNAME & vbNullString
                LBuyQty = 0: LSellQty = 0: LShareQty = 0
                GETMAIN.Label1.Caption = "Sharing " & LPartyName & " " & LSaudaCode & ""
                DoEvents
                
                Do While TRec!PARTY = LPartyCode And TRec!Sauda = LSaudaCode
                    LBuyQty = LBuyQty + TRec!BUYQTY
                    LSellQty = LSellQty + TRec!SELLQTY
                    LShareQty = LShareQty + TRec!shareqty
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
'Partywise
                RecRpt.AddNew
                RecRpt!Sauda = LSaudaCode:
                RecRpt!NAME = LPartyName:       RecRpt!PARTY = LPartyCode
                RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                RecRpt!CALVAL = LCalval
                RecRpt!FMLYCODE = LFmlyCode
                RecRpt!FmlyNAME = LFmlyName
                MQnty = LBuyQty + (LSellQty * -1)
                If Round(MQnty, 2) > 0 Then
                    RecRpt!SQnty = 0:
                    RecRpt!BQnty = Abs(Val(MQnty)):
                Else
                    RecRpt!SQnty = Abs(Val(MQnty)):
                    RecRpt!BQnty = 0:
                End If
                RecRpt!shareqty = LShareQty
                RecRpt.Update
            Loop
        End If
        
        
    End If
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    Set TRec = RecRpt.Clone
    If Option3.Value = False Then
        If Option4.Value And Option1.Value Then
            If Check9.Value = 0 Then
                If Check4.Value = 1 Then
                    TRec.Sort = "party,EXCODE,SAUDA"
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT-SHARE.RPT", 1)
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT.RPT", 1)
                End If
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CPOUT.rpt", 1)
            End If
        ElseIf Option4.Value And Option1.Value = False Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "APOUT.rpt", 1)
        End If
        mysql = "'Party wise Sauda wise Standing upto " & vcDTP1.Value & "'"
    Else
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MOUT.rpt", 1)
        mysql = "'Sauda wise Party wise Standing upto " & vcDTP1.Value & "'"
    End If
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    If err.Number <> 0 Then
        MsgBox err.Description, vbCritical, "Error Number : " & err.Number

        Me.MousePointer = 0
        OkCmd.Enabled = True
    End If
End Sub

Sub Sauda_Wise_Standing42()
    On Error GoTo err1
    Dim LPartyName As String:       Dim LItemCode As String:        Dim LFmlyName As String:        Dim LExCode As String:   Dim LPartyCode  As String:  Dim LSaudaCode As String
    Dim TRec As ADODB.Recordset:    Dim TRec2 As ADODB.Recordset:   Dim MPrvCloseRate  As Double:   Dim MQnty As Double:     Dim LCloseRate As Double:   Dim LInstType As String
    Dim MNetAmt As Double:          Dim DCloseRate As Double:       Dim LBrokerName As String:      Dim LSaudaID As Long:    Dim LExID As Integer:       Dim LItemID As Integer
    Dim LSellQty  As Double::       Dim LCalval As Double:          Dim LRefLot As Double:          Dim LShareQty As Double: Dim LBuyQty As Double:      Dim LShRate As Double
    Dim TempRec As ADODB.Recordset: Dim MRec As ADODB.Recordset:    Dim LConCode As String:         Dim LFmlyCode As String: Dim LAvgRate As Double:     Dim LMDT  As Date:
    Dim LPQty As Double:            Dim LBalQty As Double:          Dim LACCID As Long:             Dim BranchRec As ADODB.Recordset
    
    Dim LRATE As Double
                        
    
    LSExCodes = Get_ExCodes:    LSFmlyIDs = Get_FmlyCodes
    LSParties = Get_Parties:    LSSaudas = Get_Saudas:      LSInst = Get_Inst
    
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    GETMAIN.Label1.Caption = "Fetching Data"
    DoEvents
    mysql = "SELECT A.ACCID,A.AC_CODE,A.NAME,S.EXID,S.ITEMCODE,S.MATURITY,S.ITEMID,S.INSTTYPE,S.SAUDAID,S.REFLOT,S.SAUDACODE,S.EXCODE,C.CALVAL,"
    mysql = mysql & " SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY WHEN 'S' THEN C.QTY*-1 END ) AS SUMOFQTY"
    mysql = mysql & " From CTR_D AS C, SAUDAMAST AS S,ACCOUNTD AS A  WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID =C.ACCID "
    mysql = mysql & " AND C.CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    mysql = mysql & " AND C.SAUDAID=S.SAUDAID AND S.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
    If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND S.EXID  IN (" & LSExCodes & ")"
    If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
        mysql = mysql & " AND A.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
    End If
    If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
    If AllSaudas = False And LenB(LSSaudas) > 0 Then mysql = mysql & " AND S.SAUDAID IN (" & LSSaudas & ") "
    If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
    mysql = mysql & " GROUP BY A.ACCID,A.AC_CODE,A.NAME ,S.EXID,S.ITEMCODE,S.MATURITY,S.ITEMID,S.INSTTYPE,S.SAUDAID,S.REFLOT ,S.SAUDACODE ,S.EXCODE ,C.CALVAL"
    mysql = mysql & " HAVING ROUND(SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY * 1 WHEN 'S' THEN C.QTY*-1 END),2) <> 0"
    mysql = mysql & " ORDER BY S.EXCODE,S.ITEMCODE,S.MATURITY,S.INSTTYPE,S.SAUDAID,A.NAME"

    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    If Check4.Value = 1 Then
        Set TempRec = Nothing
        Set TempRec = New ADODB.Recordset
        TempRec.Fields.Append "PARTY", adVarChar, 15, adFldIsNullable
        TempRec.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
        TempRec.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        TempRec.Fields.Append "EXCODE", adVarChar, 20, adFldIsNullable
        TempRec.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        TempRec.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        TempRec.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        TempRec.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        TempRec.Fields.Append "BUYQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "SELLQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "SHAREQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        TempRec.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        TempRec.Open , , adOpenKeyset, adLockBatchOptimistic
        
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PARTY", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        RecRpt.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SHAREQTY", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    Else
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SFMLY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BFMLY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BCODE", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "SCODE", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    End If
    Do While Not TRec.EOF
    
        LSaudaCode = TRec!saudacode
        LSaudaID = TRec!SAUDAID
        DCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value), "C")
        MPrvCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value - 1), "O")
        GETMAIN.Label1.Caption = LSaudaCode
        DoEvents
        Do While LSaudaCode = TRec!saudacode
            LPartyCode = TRec!AC_CODE:            LPartyName = TRec!NAME
            LExCode = TRec!excode:              LRefLot = TRec!REFLOT
            LCalval = TRec!CALVAL::             LExID = TRec!EXID
            LItemID = TRec!itemid:              LInstType = TRec!INSTTYPE
            LConCode = vbNullString:            LBrokerName = vbNullString
            LACCID = TRec!ACCID
            
            If Check9.Value = 1 Then
                LConCode = TRec!CONCODE
                LBrokerName = TRec!BROKER
            End If
            MQnty = TRec!SUMOFQTY
                       
            If Check4.Value = 1 Then
                TempRec.AddNew
                TempRec!Sauda = LSaudaCode:
                TempRec!NAME = LPartyName:       TempRec!PARTY = LPartyCode
                TempRec!excode = LExCode:        TempRec!setrate = DCloseRate
                TempRec!PRVRate = MPrvCloseRate: TempRec!REFLOT = LRefLot
                TempRec!CALVAL = LCalval
                TempRec!shareqty = 0
                
                If Round(MQnty, 2) > 0 Then
                    TempRec!SELLQTY = 0:
                    TempRec!BUYQTY = Abs(Val(MQnty))
                Else
                    TempRec!SELLQTY = Abs(Val(MQnty))
                    TempRec!BUYQTY = 0:
                End If
                TempRec.Update
                
                Set BranchRec = Nothing
                Set BranchRec = New ADODB.Recordset
                mysql = "SELECT A.FMLYID ,A.FMLYCODE,A.FMLYNAME,A.FMLYHEAD,A.CONTRA_AC,A.HEADID,A.CONTRAID FROM ACCFMLY AS A, ACCFMLYD AS B"
                mysql = mysql & " Where A.COMPCODE=B.COMPCODE AND A.COMPCODE=" & GCompCode & " AND  A.FMLYID =B.FMLYID AND B.ACCID  =" & LACCID & ""
                BranchRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not BranchRec.EOF Then
                    Do While Not BranchRec.EOF
                        LShRate = 0
                        
                        '>>> NEW 06/AUG/2021 ------
                        If AllParties = False Then   'WITH SHARING
                            If InStr(1, LSParties, BranchRec!FMLYCODE) <= 0 Then
                                GoTo GONEXT
                            End If
                        End If
                        '>>> NEW END 06/AUG/2021 ------

'                        '>>> NEW 06/AUG/2021 ------
'                        If Check4.Value = 1 And AllParties = False Then   'WITH SHARING
'                            If InStr(1, LSParties, BranchRec!FMLYCODE) <= 0 Then
'                                GoTo GONEXT
'                            End If
'                        End If
'                        '>>> NEW END 06/AUG/2021 ------
                        
                        mysql = " EXEC GET_SHARERATE " & BranchRec!FMLYID & "," & LACCID & "," & LExID & "," & LItemID & ",'" & LInstType & "','" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                        Set MRec = Nothing
                        Set MRec = New ADODB.Recordset
                        MRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not MRec.EOF Then LShRate = MRec!SHRATE
                        If LShRate <> 0 Then
                            TempRec.AddNew
                            TempRec!Sauda = LSaudaCode::                            TempRec!PARTY = BranchRec!FMLYHEAD
                            LPartyName = Get_AccountName(BranchRec!HEADID):       TempRec!NAME = LPartyName:
                            TempRec!excode = LExCode:                               TempRec!setrate = DCloseRate
                            TempRec!PRVRate = MPrvCloseRate:                        TempRec!REFLOT = LRefLot
                            TempRec!SELLQTY = 0:                                    TempRec!BUYQTY = 0
                            TempRec!CALVAL = LCalval:                               TempRec!shareqty = Round((MQnty * -1) * (LShRate / 100), 2)
                            TempRec.Update

                            '>>> NEW 06/AUG/2021 ------
                            If AllParties = True Then   'WITH SHARING
                                'LContr_Ac
                                TempRec.AddNew
                                TempRec!Sauda = LSaudaCode:                            TempRec!PARTY = BranchRec!Contra_Ac
                                LPartyName = Get_AccountName(BranchRec!CONTRAID):     TempRec!NAME = LPartyName:
                                TempRec!excode = LExCode:                              TempRec!setrate = DCloseRate
                                TempRec!PRVRate = MPrvCloseRate:                       TempRec!REFLOT = LRefLot
                                TempRec!SELLQTY = 0:                                   TempRec!BUYQTY = 0
                                TempRec!CALVAL = LCalval:                              TempRec!shareqty = Round((MQnty) * (LShRate / 100), 2)
                                TempRec.Update
                            End If
                        End If
GONEXT:
                        BranchRec.MoveNext
                    Loop
                Else
                    '>>> NEW
                    Set BranchRec = Nothing
                    Set BranchRec = New ADODB.Recordset
                    mysql = "SELECT A.FMLYID ,A.FMLYCODE,A.FMLYNAME,A.FMLYHEAD,A.CONTRA_AC,A.HEADID,A.CONTRAID FROM ACCFMLY AS A, ACCFMLYD AS B"
                    mysql = mysql & " Where A.COMPCODE=B.COMPCODE AND A.COMPCODE=" & GCompCode & " AND  A.FMLYID =B.FMLYID AND A.CONTRAID  =" & LACCID & ""
                    BranchRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not BranchRec.EOF Then
                    Do While Not BranchRec.EOF
                        LShRate = 0
                        
                        '>>> NEW 06/AUG/2021 ------
'                        If AllParties = False Then   'WITH SHARING
'                            If InStr(1, LSParties, BranchRec!FMLYCODE) <= 0 Then
'                                GoTo GONEXT
'                            End If
'                        End If
                        '>>> NEW END 06/AUG/2021 ------

                        mysql = " EXEC GET_SHARERATE " & BranchRec!FMLYID & "," & BranchRec!HEADID & "," & LExID & "," & LItemID & ",'" & LInstType & "','" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                        Set MRec = Nothing
                        Set MRec = New ADODB.Recordset
                        MRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not MRec.EOF Then LShRate = MRec!SHRATE
                        If LShRate <> 0 Then
                            TempRec.AddNew
                            TempRec!Sauda = LSaudaCode::                            TempRec!PARTY = BranchRec!FMLYHEAD
                            LPartyName = Get_AccountName(BranchRec!HEADID):       TempRec!NAME = LPartyName:
                            TempRec!excode = LExCode:                               TempRec!setrate = DCloseRate
                            TempRec!PRVRate = MPrvCloseRate:                        TempRec!REFLOT = LRefLot
                            TempRec!SELLQTY = 0:                                    TempRec!BUYQTY = 0
                            TempRec!CALVAL = LCalval:                               TempRec!shareqty = Round((MQnty * -1) * (LShRate / 100), 2)
                            TempRec.Update

                            '>>> NEW 06/AUG/2021 ------
                            'If AllParties = True Then   'WITH SHARING
                                'LContr_Ac
                                
                                    TempRec.AddNew
                                    TempRec!Sauda = LSaudaCode:                            TempRec!PARTY = BranchRec!Contra_Ac
                                    LPartyName = Get_AccountName(BranchRec!CONTRAID):     TempRec!NAME = LPartyName:
                                    TempRec!excode = LExCode:                              TempRec!setrate = DCloseRate
                                    TempRec!PRVRate = MPrvCloseRate:                       TempRec!REFLOT = LRefLot
                                    TempRec!SELLQTY = 0:                                   TempRec!BUYQTY = 0
                                    TempRec!CALVAL = LCalval:                              TempRec!shareqty = Round((MQnty) * (LShRate / 100), 2)
                                    TempRec.Update
                                
                            'End If
                        End If
                        BranchRec.MoveNext
                    Loop
                    End If
                    '>>> NEW END
                End If
            Else
                If Option4.Value = True Then 'partywise
                    RecRpt.AddNew
                    RecRpt!Sauda = LSaudaCode:
                    RecRpt!bparty = LPartyName:     RecRpt!BCODE = LPartyCode
                    RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                    RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                    RecRpt!CALVAL = LCalval
                    LAvgRate = 0
                   '2
                    If Option2.Value = True Then 'avg rate
                        'If Check3.Value = 1 Then
                            mysql = "SELECT MAX(SETDATE) AS MDT FROM SETTLE WHERE COMPCODE =" & GCompCode & " AND SETDATE <'" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                            Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                            TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec2.EOF Then
                                LMDT = IIf(IsNull(TRec2!MDt), GFinBegin, TRec2!MDt)
                                LPQty = Get_CloseQty(LACCID, LSaudaID, LMDT)
                                LRATE = SDCLRATE(LSaudaID, DateValue(LMDT), "C")
                                MNetAmt = LPQty * LRATE
                                Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                                mysql = "SELECT SUM(CASE CONTYPE WHEN 'B' THEN QTY*RATE WHEN 'S' THEN QTY*RATE*-1 END ) AS AMT FROM CTR_D WHERE"
                                mysql = mysql & " ACCID =" & LACCID & " AND CONDATE >'" & Format(LMDT, "yyyy/MM/dd") & "' AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
                                mysql = mysql & " AND SAUDAID=" & LSaudaID & ""
                                TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec2.EOF Then
                                    MNetAmt = Abs(MNetAmt + (IIf(IsNull(TRec2!AMT), 0, TRec2!AMT)))
                                End If
                            End If
                    Else
                            LBalQty = Abs(MQnty)
                            If LBalQty <> 0 Then
                                mysql = "SELECT CONTYPE,RATE,QTY FROM CTR_D WHERE ACCID =" & LACCID & ""
                                mysql = mysql & " AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
                                'If MQnty > 0 Then
                                '    MYSQL = MYSQL & " AND CONTYPE ='B'"
                                'Else
                                 '   MYSQL = MYSQL & " AND CONTYPE ='S'"
                                'End If
                                mysql = mysql & " AND SAUDAID =" & LSaudaID & " ORDER BY CONDATE DESC ,CONNO DESC "
                                Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                                TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                Do While Not TRec2.EOF
                                    If TRec2!CONTYPE = "B" Then
                                        MNetAmt = MNetAmt + TRec2!QTY * TRec2!Rate
                                    Else
                                        MNetAmt = MNetAmt - TRec2!QTY * TRec2!Rate
                                    End If
                                    TRec2.MoveNext
                                Loop
                                Set TRec2 = Nothing
                            End If
                        'End If
                    End If
                        LAvgRate = MNetAmt / MQnty
                    
'
                    
                    If Round(MQnty, 2) > 0 Then
                        RecRpt!SQnty = 0:               RecRpt!SRate = 0:
                        RecRpt!BQnty = Abs(Val(MQnty)): RecRpt!BRate = LAvgRate:
                    Else
                        RecRpt!SQnty = Abs(Val(MQnty)): RecRpt!SRate = LAvgRate
                        RecRpt!BQnty = 0:               RecRpt!BRate = 0:
                    End If
                    RecRpt.Update
                Else ' saudawise
                    If MQnty > 0 Then
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "BPARTY ='' AND SAUDA='" & LSaudaCode & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!SPARTY = vbNullString
                            RecRpt!SQnty = 0
                        End If
                        RecRpt!bparty = LPartyName:     RecRpt!BCODE = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LCalval:        RecRpt!Sauda = LSaudaCode
                        RecRpt!BQnty = Abs(Val(MQnty))
                        RecRpt.Update
                        If LExCode = "NSE" Then
                            RecRpt!BRate = LRefLot
                        End If
                    Else
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "SPARTY ='' AND SAUDA='" & LSaudaCode & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!bparty = vbNullString
                            RecRpt!BQnty = 0
                        End If
                        RecRpt!SPARTY = LPartyName:     RecRpt!scode = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LRefLot:        RecRpt!Sauda = LSaudaCode
                        RecRpt!SQnty = Abs(Val(MQnty))
                        RecRpt.Update
                        If LExCode = "NSE" Then
                            RecRpt!SRate = LRefLot
                        End If
                    End If
                    RecRpt.Filter = adFilterNone
                End If
            End If
            
            TRec.MoveNext
            If TRec.EOF Then Exit Do
        Loop
        If TRec.EOF Then Exit Do
    Loop
    GETMAIN.Label1.Caption = ""
    DoEvents
    If Check4.Value = 1 Then ' Sharing
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        Set TRec = TempRec.Clone
    
        If TRec.RecordCount > 0 Then
            TRec.Sort = "PARTY,SAUDA"
            TRec.MoveFirst
            Do While Not TRec.EOF
                LPartyCode = TRec!PARTY:                LSaudaCode = TRec!Sauda
                LPartyName = TRec!NAME:                 LExCode = TRec!excode
                DCloseRate = TRec!setrate:              MPrvCloseRate = TRec!PRVRate
                LCalval = TRec!CALVAL:                  LRefLot = TRec!REFLOT
                LFmlyCode = TRec!FMLYCODE & vbNullString
                LFmlyName = TRec!FmlyNAME & vbNullString
                LBuyQty = 0: LSellQty = 0: LShareQty = 0
                GETMAIN.Label1.Caption = "Sharing " & LPartyName & " " & LSaudaCode & ""
                DoEvents
                
                Do While TRec!PARTY = LPartyCode And TRec!Sauda = LSaudaCode
                    LBuyQty = LBuyQty + TRec!BUYQTY
                    LSellQty = LSellQty + TRec!SELLQTY
                    LShareQty = LShareQty + TRec!shareqty
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
'Partywise
                RecRpt.AddNew
                RecRpt!Sauda = LSaudaCode:
                RecRpt!NAME = LPartyName:       RecRpt!PARTY = LPartyCode
                RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                RecRpt!CALVAL = LCalval
                RecRpt!FMLYCODE = LFmlyCode
                RecRpt!FmlyNAME = LFmlyName
                MQnty = LBuyQty + (LSellQty * -1)
                If Round(MQnty, 2) > 0 Then
                    RecRpt!SQnty = 0:
                    RecRpt!BQnty = Abs(Val(MQnty)):
                Else
                    RecRpt!SQnty = Abs(Val(MQnty)):
                    RecRpt!BQnty = 0:
                End If
                RecRpt!shareqty = LShareQty
                RecRpt.Update
            Loop
        End If
        
        
    End If
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    Set TRec = RecRpt.Clone
    If Option3.Value = False Then
        If Option4.Value And Option1.Value Then
            If Check9.Value = 0 Then
                If Check4.Value = 1 Then
                    TRec.Sort = "party,EXCODE,SAUDA"
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT-SHARE.RPT", 1)
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT.RPT", 1)
                End If
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CPOUT.rpt", 1)
            End If
        ElseIf Option4.Value And Option1.Value = False Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "APOUT.rpt", 1)
        End If
        mysql = "'Party wise Sauda wise Standing upto " & vcDTP1.Value & "'"
    Else
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MOUT.rpt", 1)
        mysql = "'Sauda wise Party wise Standing upto " & vcDTP1.Value & "'"
    End If
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    If err.Number <> 0 Then
        MsgBox err.Description, vbCritical, "Error Number : " & err.Number

        Me.MousePointer = 0
        OkCmd.Enabled = True
    End If
End Sub
Sub Sauda_Wise_Standing()
    On Error GoTo err1
    Dim LPartyName As String:       Dim LItemCode As String:        Dim LFmlyName As String:
    Dim LExCode As String:          Dim LPartyCode  As String:      Dim LSaudaCode As String
    Dim RecRate As ADODB.Recordset: Dim TRec As ADODB.Recordset
    Dim TRec2 As ADODB.Recordset
    
    Dim MPrvCloseRate  As Double:   Dim LPrevStd As Double:         Dim LPBQnty As Double:
    Dim LRegLot As Double:          Dim LPSQnty As Double:          Dim MQnty As Double
    Dim MASAmt As Double:           Dim MABAmt As Double:           Dim LCloseRate As Double
    Dim MBLQty As Double:           Dim MNetAmt As Double:          Dim MNetQty As Double
    Dim MBQty As Double:            Dim msqty As Double:            Dim DCloseRate As Double
    Dim LastClosingDate As Date:    Dim LastCondate As Date
    Dim LBalQty As Double
    
    LSExCodes = Get_ExCodes:    LSParties = Get_Parties
    LSSaudas = Get_Saudas:      LSInst = Get_Inst
    
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    If Option2.Value = False Then
        mysql = "SELECT TOP 1 CONDATE FROM CTR_M WHERE COMPCODE =" & GCompCode & " "
        If AllSaudas = False Then mysql = mysql & " AND SAUDA IN (" & LSSaudas & ")"
        mysql = mysql & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'ORDER BY CONDATE DESC"
        Set TRec = Nothing:  Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        If Not TRec.EOF Then
            LastCondate = TRec!Condate
        Else
            LastCondate = vcDTP1.Value
            MsgBox "No Previous Closing Rates Found."
        End If
        mysql = "SELECT TOP 1 CONDATE FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
        If AllSaudas = False Then mysql = mysql & " AND SAUDA IN (" & LSSaudas & ")"
        mysql = mysql & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'ORDER BY CONDATE DESC"
        Set TRec = Nothing:  Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        If Not TRec.EOF Then
            If LastCondate <= TRec!Condate Then LastCondate = TRec!Condate
        Else
            LastCondate = vcDTP1.Value
            MsgBox "No Previous Closing Rates Found."
        End If
    Else
        mysql = "SELECT DISTINCT CONDATE FROM CTR_D WHERE COMPCODE =" & GCompCode & " "
        If AllSaudas = False Then mysql = mysql & " AND SAUDA IN (" & LSSaudas & ")"
        mysql = mysql & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'ORDER BY CONDATE DESC"
        Set TRec = Nothing:  Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
        If Not TRec.EOF Then
            LastCondate = TRec!Condate
        Else
            LastCondate = vcDTP1.Value
            MsgBox "No Previous Closing Rates Found."
        End If
    End If
    mysql = "SELECT CONDATE,SAUDA,CLOSERATE FROM CTR_R WHERE COMPCODE =" & GCompCode & " AND CONDATE<='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'AND CONDATE>='" & Format(vcDTP1.Value - 3, "yyyy/MM/dd") & "' ORDER BY CONDATE DESC"
    Set RecRate = Nothing
    Set RecRate = New ADODB.Recordset
    RecRate.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Option5.Value = True Then ' userid
        mysql = "SELECT IT.EXCHANGECODE,IT.LOT,SU.ITEMCODE,SU.SAUDACODE,SU.MATURITY,SU.TRADEABLELOT,CD.USERID,SUM( CASE CONTYPE WHEN 'B' THEN QTY WHEN 'S' THEN QTY*-1 END ) AS SUMOFQTY "
        mysql = mysql & " FROM CTR_D AS CD,SAUDAMAST AS SU ,ITEMMAST AS IT "
        mysql = mysql & " WHERE CD.COMPCODE = " & GCompCode & " AND CD.COMPCODE =SU.COMPCODE AND CD.COMPCODE=IT.COMPCODE AND  CD.SAUDA=SU.SAUDACODE AND SU.ITEMCODE = IT.ITEMCODE "
        mysql = mysql & " AND CD.CONDATE <='" & Format(LastCondate, "yyyy/MM/dd") & "' "
        mysql = mysql & " AND SU.MATURITY>='" & Format(LastCondate, "yyyy/MM/dd") & "'&" '"
        If AllExcodes = False Then mysql = mysql & " AND IT.EXCHANGECODE  IN (" & LSExCodes & ")"
        If AllSaudas = False Then mysql = mysql & " AND CD.SAUDA IN (" & LSSaudas & ") "
        If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
        mysql = mysql & " GROUP BY IT.EXCHANGECODE,IT.LOT,SU.ITEMCODE,SU.SAUDACODE,SU.MATURITY,SU.TRADEABLELOT,CD.USERID"
        mysql = mysql & " HAVING SUM(CASE CONTYPE WHEN 'B' THEN QTY * 1 WHEN 'S' THEN QTY*-1 END) <> 0 "
        mysql = mysql & " ORDER BY IT.EXCHANGECODE,SU.ITEMCODE, SU.MATURITY,SU.SAUDACODE,CD.USERID"
    Else
        If Option2.Value = True Then
            mysql = "SELECT DISTINCT IT.EXCHANGECODE,SU.ITEMCODE,SU.SAUDACODE,SU.MATURITY,P.NAME,P.AC_CODE,SU.REFLOT,SU.TRADEABLELOT,IT.LOT"
            mysql = mysql & " FROM CTR_D AS CD,SAUDAMAST AS SU,ACCOUNTD AS P,ITEMMAST AS IT "
            mysql = mysql & " WHERE CD.COMPCODE = " & GCompCode & " AND CD.COMPCODE =SU.COMPCODE AND CD.COMPCODE=IT.COMPCODE AND CD.COMPCODE =P.COMPCODE AND CD.SAUDA=SU.SAUDACODE AND SU.ITEMCODE = IT.ITEMCODE "
            mysql = mysql & " AND CD.PARTY=P.AC_CODE "
            mysql = mysql & " AND CD.CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
            mysql = mysql & " AND SU.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
            If AllExcodes = False Then mysql = mysql & " AND IT.EXCHANGECODE  IN (" & LSExCodes & ")"
            If AllParties = False Then mysql = mysql & " AND P.AC_CODE IN (" & LSParties & ")"
            If AllSaudas = False Then mysql = mysql & " AND CD.SAUDA IN (" & LSSaudas & ") "
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
            mysql = mysql & " ORDER BY IT.EXCHANGECODE,SU.ITEMCODE, SU.MATURITY,SU.SAUDACODE,P.NAME"
        Else
            mysql = "SELECT IT.EXCHANGECODE,IT.LOT,SU.ITEMCODE,SU.SAUDACODE,SU.REFLOT,SU.TRADEABLELOT,P.NAME,P.AC_CODE,SUM( CASE CONTYPE WHEN 'B' THEN QTY WHEN 'S' THEN QTY*-1 END ) AS SUMOFQTY "
            mysql = mysql & " FROM CTR_D AS CD,SAUDAMAST AS SU,ACCOUNTD AS P ,ITEMMAST AS IT "
            mysql = mysql & " WHERE CD.COMPCODE = " & GCompCode & " AND CD.COMPCODE =SU.COMPCODE AND CD.COMPCODE=IT.COMPCODE AND CD.COMPCODE =P.COMPCODE AND CD.SAUDA=SU.SAUDACODE AND SU.ITEMCODE = IT.ITEMCODE "
            mysql = mysql & " AND CD.PARTY=P.AC_CODE "
            mysql = mysql & " AND CD.CONDATE <='" & Format(LastCondate, "yyyy/MM/dd") & "' "
            mysql = mysql & " AND SU.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
            If AllExcodes = False Then mysql = mysql & " AND IT.EXCHANGECODE  IN (" & LSExCodes & ")"
            If AllParties = False Then mysql = mysql & " AND P.AC_CODE IN (" & LSParties & ")"
            If AllSaudas = False Then mysql = mysql & " AND CD.SAUDA IN (" & LSSaudas & ") "
            If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  SU.INSTTYPE  IN  (" & LSInst & ") "
            mysql = mysql & " GROUP BY IT.EXCHANGECODE,IT.LOT,SU.ITEMCODE,SU.SAUDACODE,SU.REFLOT,SU.TRADEABLELOT,SU.MATURITY, P.NAME,P.AC_CODE "
            mysql = mysql & " HAVING SUM(CASE CONTYPE WHEN 'B' THEN QTY * 1 WHEN 'S' THEN QTY*-1 END) <> 0 "
            mysql = mysql & " ORDER BY IT.EXCHANGECODE,SU.ITEMCODE, SU.MATURITY,SU.SAUDACODE, P.NAME"
        End If
    End If
    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenKeyset, adLockReadOnly
    Set RecRpt = Nothing
    Set RecRpt = New ADODB.Recordset
    RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
    RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SPARTY", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BPARTY", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "BRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
    RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "SFMLY", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "BFMLY", adVarChar, 100, adFldIsNullable
    RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
    RecRpt.Fields.Append "BCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "SCODE", adVarChar, 15, adFldIsNullable
    RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
    'End If
    RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    Do While Not TRec.EOF
        LSaudaCode = TRec!saudacode
        DCloseRate = 0:            MPrvCloseRate = 0
        RecRate.Filter = adFilterNone
        If Not RecRate.EOF Then
            RecRate.MoveFirst
            RecRate.Filter = "SAUDA='" & LSaudaCode & "'"
            If Not RecRate.EOF Then
                If RecRate!Condate = vcDTP1.Value Then
                    DCloseRate = RecRate!CLOSERATE
                Else
                    DCloseRate = 0
                End If
                RecRate.MoveNext
                If Not RecRate.EOF Then
                    MPrvCloseRate = RecRate!CLOSERATE
                Else
                    MPrvCloseRate = 0
                End If
            End If
        End If
        Do While LSaudaCode = TRec!saudacode
            LPartyName = TRec!NAME
            
            LPartyCode = TRec!AC_CODE
            
            LExCode = TRec!EXCHANGECODE
            LItemCode = TRec!ITEMCODE
            LFmlyName = vbNullString
            LRegLot = TRec!REFLOT
            MQnty = 0: MASAmt = 0: MABAmt = 0
            If Option2.Value = True Then MQnty = Get_CloseQty(CLng(LPartyCode), CLng(LSaudaCode), LastCondate)
            Do While LPartyName = TRec!NAME And LSaudaCode = TRec!saudacode
                If Option2.Value = False Then
                    If TRec!SUMOFQTY > 0 Then
                        MQnty = MQnty + TRec!SUMOFQTY
                    Else
                        MQnty = MQnty - Abs(TRec!SUMOFQTY)
                    End If
                End If
                    TRec.MoveNext
                    If TRec.EOF Then GoTo FLAG1
                Loop
FLAG1:
                If Not RecRpt.EOF Then RecRpt.MoveFirst
                If Option3.Value = False Then 'party wise
                    MBLQty = 0: MNetAmt = 0: MNetQty = 0
                    If Option2.Value = True Then
                        MBQty = 0:  msqty = 0
                        MABAmt = 0: MASAmt = 0
                        LBalQty = Abs(MQnty)
                        If LBalQty <> 0 Then
                            mysql = "SELECT RATE,QTY FROM CTR_D WHERE COMPCODE= " & GCompCode & " AND PARTY='" & LPartyCode & "'"
                            mysql = mysql & " AND CONDATE <='" & Format(LastCondate, "yyyy/MM/dd") & "' "
                            If MQnty > 0 Then
                                mysql = mysql & " AND CONTYPE ='B'"
                            Else
                                mysql = mysql & " AND CONTYPE ='S'"
                            End If
                            mysql = mysql & " AND SAUDA='" & LSaudaCode & "' ORDER BY CONDATE DESC ,CONNO DESC "
                            Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                            TRec2.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            Do While Not TRec2.EOF
                                If LBalQty >= TRec2!QTY Then
                                    MNetAmt = MNetAmt + TRec2!QTY * TRec2!Rate
                                    LBalQty = LBalQty - TRec2!QTY
                                Else
                                    MNetAmt = MNetAmt + (TRec2!QTY - LBalQty) * TRec2!Rate
                                    LBalQty = 0
                                End If
                                If LBalQty = 0 Then Exit Do
                                TRec2.MoveNext
                            Loop
                        End If
                    End If
                    If MQnty > 0 Then
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "SAUDA='" & LSaudaCode & "' AND BCODE ='" & LPartyCode & "'"
                        If Not RecRpt.EOF Then
                            If RecRpt!BQnty <> 0 Then
                                RecRpt!BQnty = RecRpt!BQnty + MQnty
                                RecRpt.Update
                            Else
                                If RecRpt!SQnty >= Abs(MQnty) Then
                                    RecRpt!SQnty = RecRpt!SQnty - Abs(MQnty)
                                    RecRpt.Update
                                Else
                                    RecRpt!BQnty = Abs(MQnty) - RecRpt!SQnty
                                    RecRpt!SQnty = 0
                                    RecRpt.Update
                                End If
                            End If
                        Else
                            RecRpt.AddNew
                            RecRpt!Sauda = LSaudaCode:                        RecRpt!SQnty = 0
                            RecRpt!SRate = 0:                                 RecRpt!BQnty = Abs(Val(MQnty))
                            RecRpt!BRate = MNetAmt / Abs(Val(MQnty)):         RecRpt!bparty = LPartyName
                            RecRpt!BCODE = LPartyCode:                        RecRpt!excode = LExCode & ""
                            RecRpt!setrate = DCloseRate:                      RecRpt!PRVRate = MPrvCloseRate
                            RecRpt!SFMLY = LFmlyName:                         RecRpt!REFLOT = LRegLot
                            RecRpt!CALVAL = 1
                            RecRpt.Update
                        End If
                        RecRpt.Filter = adFilterNone
                    ElseIf MQnty < 0 Then
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "SAUDA='" & LSaudaCode & "' AND BCODE ='" & LPartyCode & "'"
                        If Not RecRpt.EOF Then
                            If RecRpt!SQnty <> 0 Then
                                RecRpt!SQnty = RecRpt!SQnty + Abs(MQnty)
                                RecRpt.Update
                            ElseIf RecRpt!BQnty <> 0 Then
                                If RecRpt!BQnty > Abs(MQnty) Then
                                    RecRpt!BQnty = RecRpt!BQnty - Abs(MQnty)
                                    RecRpt!SQnty = 0
                                    RecRpt.Update
                                Else
                                    RecRpt!SQnty = Abs(MQnty) - RecRpt!BQnty
                                    RecRpt!BQnty = 0
                                    RecRpt.Update
                                End If
                            Else
                                RecRpt!SQnty = Abs(MQnty)
                                RecRpt!BQnty = 0
                                RecRpt.Update
                            End If
                        Else
                            RecRpt.AddNew
                            RecRpt!Sauda = LSaudaCode:                        RecRpt!SQnty = Abs(Val(MQnty))
                            RecRpt!SRate = MNetAmt / Abs(Val(MQnty)):         RecRpt!BQnty = 0
                            RecRpt!BRate = 0:                                 RecRpt!bparty = LPartyName
                            RecRpt!BCODE = LPartyCode:                        RecRpt!excode = LExCode & ""
                            RecRpt!setrate = DCloseRate:                      RecRpt!PRVRate = MPrvCloseRate
                            RecRpt!SFMLY = LFmlyName:                         RecRpt!REFLOT = LRegLot
                            RecRpt!CALVAL = 1
                            RecRpt.Update
                        End If
                        RecRpt.Filter = adFilterNone
                    End If
                Else 'saudawise
                    If MQnty > 0 Then
                        RecRpt.Filter = "SAUDA='" & LSaudaCode & "'"
                        If Not RecRpt.EOF Then
                            RecRpt.MoveFirst
                            RecRpt.Find "BCODE='" & LPartyCode & "'", , adSearchForward
                            If RecRpt.EOF Then
                                RecRpt.MoveFirst
                                RecRpt.Find "SCODE='" & LPartyCode & "'", , adSearchForward
                                If RecRpt.EOF Then
                                    RecRpt.MoveFirst
                                    RecRpt.Find "BCODE=''", , adSearchForward
                                    If RecRpt.EOF Then
                                        RecRpt.AddNew
                                        RecRpt!SQnty = 0
                                        RecRpt!SPARTY = vbNullString
                                        RecRpt!scode = vbNullString
                                    End If
                                    RecRpt!Sauda = LSaudaCode
                                    RecRpt!BQnty = Abs(Val(MQnty))
                                    RecRpt!bparty = LPartyName
                                    RecRpt!BCODE = LPartyCode
                                    RecRpt!BRate = ((MABAmt - MASAmt) / MQnty)
                                    RecRpt!setrate = DCloseRate
                                    RecRpt!PRVRate = MPrvCloseRate
                                    RecRpt!REFLOT = LRegLot
                                    RecRpt.Update
                                Else
                                    If RecRpt!SQnty >= Abs(MQnty) Then
                                        RecRpt!SQnty = RecRpt!SQnty - Abs(MQnty)
                                    Else
                                        LPSQnty = RecRpt!SQnty
                                        RecRpt!SQnty = 0
                                        RecRpt!SPARTY = vbNullString
                                        RecRpt!scode = vbNullString
                                        RecRpt.Update
                                        RecRpt.MoveFirst
                                        RecRpt.Find "BCODE=''", , adSearchForward
                                        If RecRpt.EOF Then
                                            RecRpt.AddNew:             RecRpt!SQnty = 0
                                            RecRpt!SPARTY = vbNullString:        RecRpt!scode = vbNullString
                                        End If
                                        RecRpt!Sauda = LSaudaCode:                   RecRpt!BQnty = Abs(Val(MQnty)) - LPSQnty
                                        RecRpt!bparty = LPartyName:                  RecRpt!BCODE = LPartyCode
                                        RecRpt!BRate = 0:                            RecRpt!setrate = DCloseRate
                                        RecRpt!PRVRate = MPrvCloseRate:              RecRpt!REFLOT = LRegLot
                                        RecRpt.Update
                                    End If
                               End If
                            Else
                            If RecRpt!BQnty <> 0 Then
                                RecRpt!BQnty = RecRpt!BQnty + Abs(MQnty)
                            Else
                                If RecRpt!SQnty >= Abs(MQnty) Then
                                    RecRpt!SQnty = RecRpt!SQnty - Abs(MQnty)
                                Else
                                    RecRpt!BQnty = Abs(MQnty) - RecRpt!SQnty
                                    RecRpt!SQnty = 0
                                End If
                            End If
                                RecRpt.Update
                            End If
                        Else
                            RecRpt.AddNew
                            RecRpt!SQnty = 0:                            RecRpt!SPARTY = vbNullString
                            RecRpt!scode = vbNullString:                 RecRpt!Sauda = LSaudaCode
                            RecRpt!BQnty = Abs(Val(MQnty)):              RecRpt!bparty = LPartyName
                            RecRpt!BCODE = LPartyCode:                   RecRpt!BRate = ((MABAmt - MASAmt) / MQnty)
                            RecRpt!setrate = DCloseRate:                 RecRpt!PRVRate = MPrvCloseRate
                            RecRpt!REFLOT = LRegLot:                     RecRpt.Update
                        End If
                    ElseIf MQnty < 0 Then
                        RecRpt.Filter = "SAUDA='" & LSaudaCode & "'"
                        If Not RecRpt.EOF Then
                            RecRpt.MoveFirst
                            RecRpt.Find "BCODE='" & LPartyCode & "'", , adSearchForward
                            If RecRpt.EOF Then
                                RecRpt.MoveFirst
                                RecRpt.Find "SCODE='" & LPartyCode & "'", , adSearchForward
                                If RecRpt.EOF Then
                                    RecRpt.MoveFirst
                                    RecRpt.Find "SCODE=''", , adSearchForward
                                    If RecRpt.EOF Then
                                        RecRpt.AddNew:                    RecRpt!BQnty = 0
                                        RecRpt!bparty = vbNullString:     RecRpt!BCODE = vbNullString
                                    End If
                                    RecRpt!Sauda = LSaudaCode:                       RecRpt!SQnty = Abs(Val(MQnty))
                                    RecRpt!SPARTY = LPartyName:                      RecRpt!scode = LPartyCode
                                    RecRpt!SRate = ((MABAmt - MASAmt) / MQnty):      RecRpt!setrate = DCloseRate
                                    RecRpt!PRVRate = MPrvCloseRate:                  RecRpt!REFLOT = LRegLot
                                    RecRpt.Update
                                Else
                                    RecRpt!SQnty = RecRpt!SQnty + Abs(MQnty)
                               End If
                            Else
                                If RecRpt!BQnty >= Abs(MQnty) Then
                                    RecRpt!BQnty = RecRpt!BQnty - Abs(Val(MQnty))
                                Else
                                    LPBQnty = RecRpt!BQnty:          RecRpt!BQnty = 0
                                    RecRpt!bparty = vbNullString:    RecRpt!BCODE = vbNullString
                                    RecRpt.Update
                                    RecRpt.MoveFirst
                                    RecRpt.Find "SCODE=''", , adSearchForward
                                    If RecRpt.EOF Then
                                        RecRpt.AddNew:                  RecRpt!BQnty = 0
                                        RecRpt!bparty = vbNullString:   RecRpt!BCODE = vbNullString
                                    End If
                                    RecRpt!Sauda = LSaudaCode:               RecRpt!SQnty = Abs(Val(MQnty)) - LPBQnty
                                    RecRpt!SPARTY = LPartyName:              RecRpt!scode = LPartyCode
                                    RecRpt!BRate = 0:                        RecRpt!setrate = DCloseRate
                                    RecRpt!PRVRate = MPrvCloseRate:          RecRpt!REFLOT = LRegLot
                                    RecRpt.Update
                                End If
                            End If
                        Else
                            RecRpt.AddNew
                            RecRpt!BQnty = 0: RecRpt!bparty = vbNullString
                            RecRpt!BCODE = vbNullString:                    RecRpt!Sauda = LSaudaCode
                            RecRpt!SQnty = Abs(Val(MQnty)):              RecRpt!SPARTY = LPartyName
                            RecRpt!scode = LPartyCode:                   RecRpt!SRate = ((MABAmt - MASAmt) / MQnty)
                            RecRpt!setrate = DCloseRate:                 RecRpt!PRVRate = MPrvCloseRate
                            RecRpt!REFLOT = LRegLot:                     RecRpt.Update
                        End If
                    End If
                End If
                'If Check3.Value = 1 Then Call Share_Sauda_Wise_Standing(LPartyCode, LItemCode, LSaudaCode, MQnty, LExCode, DCloseRate)
                If TRec.EOF Then GoTo FLAG2
            Loop
FLAG2:
            Loop
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    Set TRec = RecRpt.Clone
    If Option3.Value = False Then
        If Option4.Value And Option1.Value Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT.rpt", 1)
        ElseIf Option4.Value And Option2.Value Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "APOUT.rpt", 1)
        End If
        mysql = "'Party wise Sauda wise Standing upto " & vcDTP1.Value & "'"
    Else
        Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MOUT.rpt", 1)
        mysql = "'Sauda wise Party wise Standing upto " & vcDTP1.Value & "'"
    End If
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    Me.MousePointer = 0
    OkCmd.Enabled = True
End Sub
Public Sub Sauda_Wise_Standing_Consolidated()

    On Error GoTo err1
    Dim LPartyName As String:       Dim LItemCode As String:        Dim LFmlyName As String:        Dim LExCode As String:   Dim LPartyCode  As String:  Dim LSaudaCode As String
    Dim TRec As ADODB.Recordset:    Dim TRec2 As ADODB.Recordset:   Dim MPrvCloseRate  As Double:   Dim MQnty As Double:     Dim LCloseRate As Double:   Dim LInstType As String
    Dim MNetAmt As Double:          Dim DCloseRate As Double:       Dim LBrokerName As String:      Dim LSaudaID As Long:    Dim LExID As Integer:       Dim LItemID As Integer
    Dim LSellQty  As Double::       Dim LCalval As Double:          Dim LRefLot As Double:          Dim LShareQty As Double: Dim LBuyQty As Double:      Dim LShRate As Double
    Dim TempRec As ADODB.Recordset: Dim MRec As ADODB.Recordset:    Dim LConCode As String:         Dim LFmlyCode As String: Dim LAvgRate As Double:     Dim LMDT  As Date:
    Dim LPQty As Double:            Dim LBalQty As Double:          Dim LACCID As Long:             Dim BranchRec As ADODB.Recordset
    Dim myRec As ADODB.Recordset:   Dim acexRec As ADODB.Recordset
    Dim LRATE As Double:            Dim LAcExCode As String
                                                                                    
    LSExCodes = Get_ExCodes:    LSFmlyIDs = Get_FmlyCodes
    
    If Check4.Value = 1 Then
        LSParties = Get_ALL_Parties
    Else
        LSParties = Get_Parties
    End If
    
    LSInst = Get_Inst
    
    Me.MousePointer = Val(11): OkCmd.Enabled = False
    GETMAIN.Label1.Caption = "Fetching Data"
    
    
    If Check4.Value = 1 Then  'party and sauda wise and with sharing
        Set TempRec = Nothing
        Set TempRec = New ADODB.Recordset
        TempRec.Fields.Append "PARTY", adVarChar, 15, adFldIsNullable
        TempRec.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
        TempRec.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        TempRec.Fields.Append "EXCODE", adVarChar, 20, adFldIsNullable
        TempRec.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        TempRec.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        TempRec.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        TempRec.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        TempRec.Fields.Append "BUYQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "SELLQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "SHAREQTY", adDouble, , adFldIsNullable
        TempRec.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        TempRec.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        TempRec.Fields.Append "COMPANY", adVarChar, 15, adFldIsNullable
        TempRec.Fields.Append "ACEXCODE", adVarChar, 20, adFldIsNullable
        TempRec.Open , , adOpenKeyset, adLockBatchOptimistic
        
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PARTY", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "NAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "FMLYCODE", adVarChar, 6, adFldIsNullable
        RecRpt.Fields.Append "FMLYNAME", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SHAREQTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "COMPANY", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "ACEXCODE", adVarChar, 20, adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    Else
        Set RecRpt = Nothing
        Set RecRpt = New ADODB.Recordset
        RecRpt.Fields.Append "SAUDA", adVarChar, 50, adFldIsNullable
        RecRpt.Fields.Append "SQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BQNTY", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BPARTY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "EXCODE", adVarChar, 10, adFldIsNullable
        RecRpt.Fields.Append "SETRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "PRVRATE", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "SFMLY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "BFMLY", adVarChar, 100, adFldIsNullable
        RecRpt.Fields.Append "REFLOT", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "BCODE", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "SCODE", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "CALVAL", adDouble, , adFldIsNullable
        RecRpt.Fields.Append "COMPANY", adVarChar, 15, adFldIsNullable
        RecRpt.Fields.Append "ACEXCODE", adVarChar, 20, adFldIsNullable
        RecRpt.Open , , adOpenKeyset, adLockBatchOptimistic
    End If

    
    Dim comploop As Integer
    
    Dim Company As String
    Dim NoCompany As Integer
    NoCompany = 2
    
    Dim tempserver As String
    Dim tempuid As String
    Dim tempwd As String
    
    '>>> get server, uid and pwd from connection string
    tempserver = MServer
    tempserver = Replace(tempserver, "driver={SQL Server};server=", "")
    tempserver = Mid(tempserver, 1, InStr(1, tempserver, ";") - 1)
        
    tempuid = MServer
    tempuid = Replace(tempuid, "driver={SQL Server};server=" & tempserver & ";uid=", "")
    tempuid = Mid(tempuid, 1, InStr(1, tempuid, ";") - 1)
        
    tempwd = MServer
    tempwd = Replace(tempwd, "driver={SQL Server};server=" & tempserver & ";uid=" & tempuid & ";pwd=", "")
    tempwd = Mid(tempwd, 1, InStr(1, tempwd, ";") - 1)
    
    For comploop = 1 To NoCompany
    
    Set CompCnn = Nothing: Set CompCnn = New ADODB.Connection:
    If comploop = 1 Then
        Company = "m1"
        CompCnn.ConnectionString = "driver={SQL Server};server=" & tempserver & ";uid=" & tempuid & ";pwd=" & tempwd & ";database=S-CMK2022"
    ElseIf comploop = 2 Then
        Company = "m2"
        CompCnn.ConnectionString = "driver={SQL Server};server=" & tempserver & ";uid=" & tempuid & ";pwd=" & tempwd & ";database=S-IND2022"
    ElseIf comploop = 3 Then
        Company = "m3"
        CompCnn.ConnectionString = "driver={SQL Server};server=" & tempserver & ";uid=" & tempuid & ";pwd=" & tempwd & ";database=S-SIL2022"
    End If
    CompCnn.Mode = adModeShareExclusive: CompCnn.IsolationLevel = adXactIsolated: CompCnn.CursorLocation = adUseClient
    CompCnn.Open: CompCnn.CommandTimeout = 300
    
    
        LSSaudas = Get_Saudas:
        
        DoEvents
        mysql = "SELECT A.ACCID,A.AC_CODE,A.NAME,S.EXID,S.ITEMCODE,S.MATURITY,S.ITEMID,S.INSTTYPE,S.SAUDAID,S.REFLOT,I.REFLOT AS IREFLOT,S.SAUDACODE,S.EXCODE,C.CALVAL,"
        mysql = mysql & " SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY WHEN 'S' THEN C.QTY*-1 END ) AS SUMOFQTY"
        mysql = mysql & " From CTR_D AS C, SAUDAMAST AS S,ACCOUNTD AS A  ,ITEMMAST AS I WHERE A.COMPCODE =" & GCompCode & " AND A.ACCID =C.ACCID "
        mysql = mysql & " AND C.CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
        mysql = mysql & " AND C.SAUDAID=S.SAUDAID AND S.MATURITY>='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
        If AllExcodes = False And LenB(LSExCodes) > 0 Then mysql = mysql & " AND S.EXID  IN (" & LSExCodes & ")"
        If AllFmly = False And LenB(LSFmlyIDs) > 0 And AllParties = True Then
            mysql = mysql & " AND A.ACCID  IN (SELECT ACCID FROM ACCFMLYD WHERE FMLYID IN (" & LSFmlyIDs & "))"
        End If
        mysql = mysql & " AND S.ITEMID = I.ITEMID "
        If AllParties = False And LenB(LSParties) > 0 Then mysql = mysql & " AND A.AC_CODE IN (" & LSParties & ")"
        If AllSaudas = False And LenB(LSSaudas) > 0 Then mysql = mysql & " AND S.SAUDACODE IN ('" & LSSaudas & "') "
        If AllSaudas = True And AllInst = False Then mysql = mysql & " AND  S.INSTTYPE  IN  (" & LSInst & ") "
        mysql = mysql & " GROUP BY A.ACCID,A.AC_CODE,A.NAME ,S.EXID,S.ITEMCODE,S.MATURITY,S.ITEMID,S.INSTTYPE,S.SAUDAID,S.REFLOT ,S.SAUDACODE ,S.EXCODE ,C.CALVAL,I.REFLOT"
        mysql = mysql & " HAVING ROUND(SUM(CASE C.CONTYPE WHEN 'B' THEN C.QTY * 1 WHEN 'S' THEN C.QTY*-1 END),2) <> 0"
        mysql = mysql & " ORDER BY S.EXCODE,S.ITEMCODE,S.MATURITY,S.INSTTYPE,S.SAUDAID,A.NAME"
    
        Set TRec = Nothing: Set TRec = New ADODB.Recordset
        TRec.Open mysql, CompCnn, adOpenKeyset, adLockReadOnly
        
'        While Not myRec.EOF
'            TRec.AddNew
'            TRec!ACCID = myRec!ACCID:
'            TRec!AC_CODE = myRec!AC_CODE
'            TRec!NAME = myRec!NAME
'            TRec!exid = myRec!exid
'            TRec!ITEMCODE = myRec!ITEMCODE
'            TRec!MATURITY = myRec!: MATURITY
'            TRec!itemid = myRec!itemid
'            TRec!INSTTYPE = myRec!INSTTYPE
'            TRec!SAUDAID = myRec!SAUDAID
'            TRec!REFLOT = myRec!REFLOT
'            TRec!saudacode = myRec!saudacode
'            TRec!EXCODE = myRec!EXCODE
'            TRec!CALVAL = myRec!CALVAL
'            TRec!SUMOFQTY = myRec!SUMOFQTY
'            TRec!Company = comapny
'
'            TRec.Update
'            myRec.MoveNext
'        Wend
'
'    Next
    
        
    Do While Not TRec.EOF
    
        LSaudaCode = TRec!saudacode
        LSaudaID = TRec!SAUDAID
        DCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value), "C", Company)
        MPrvCloseRate = SDCLRATE(LSaudaID, DateValue(vcDTP1.Value - 1), "O", Company)
        GETMAIN.Label1.Caption = LSaudaCode
        
        DoEvents
        Do While LSaudaCode = TRec!saudacode
            LPartyCode = TRec!AC_CODE:          LPartyName = TRec!NAME
            LExCode = TRec!excode:              LRefLot = TRec!REFLOT
            LCalval = TRec!CALVAL::             LExID = TRec!EXID
            LItemID = TRec!itemid:              LInstType = TRec!INSTTYPE
            LConCode = vbNullString:            LBrokerName = vbNullString
            LACCID = TRec!ACCID
                        
            If Check9.Value = 1 Then
                LConCode = TRec!CONCODE
                LBrokerName = TRec!BROKER
            End If
            MQnty = TRec!SUMOFQTY
            If Company = "m2" Then
                'MQnty = MQnty / IIf(TRec!IREFLOT <= 0, 1, TRec!IREFLOT)
            End If

            LAcExCode = TRec!AC_CODE
            Set acexRec = Nothing
            Set acexRec = New ADODB.Recordset
            mysql = "SELECT UCC FROM ACCOUNTD "
            mysql = mysql & " Where COMPCODE=" & GCompCode & " AND  ACCID  =" & LACCID & ""
            acexRec.Open mysql, CompCnn, adOpenForwardOnly, adLockReadOnly
            If Not acexRec.EOF Then
                If Len(acexRec!UCC) > 0 Then
                    LAcExCode = acexRec!UCC
                End If
            End If

            If Check4.Value = 1 Then   'party and sauda wise and with sharing

                If TempRec.RecordCount > 0 Then
                    TempRec.MoveFirst
                End If
                TempRec.Filter = "PARTY = '" & Left(LAcExCode, 6) & "' and Sauda = '" & LSaudaCode & "'"
                If TempRec.EOF Then
                    TempRec.Filter = adFilterNone
                    TempRec.AddNew
                    TempRec!PARTY = Left(LAcExCode, 6)
                    If Len(acexRec!UCC) > 0 Then
                        TempRec!NAME = LAcExCode
                    Else
                        TempRec!NAME = LPartyName
                    End If
                    TempRec!shareqty = 0
                    TempRec!SELLQTY = 0
                    TempRec!BUYQTY = 0
                Else
                    'MQnty = MQnty + TempRec!BUYQTY - TempRec!SELLQTY
                End If
                                
                TempRec!Sauda = LSaudaCode:
                TempRec!excode = LExCode:        TempRec!setrate = DCloseRate
                TempRec!PRVRate = MPrvCloseRate: TempRec!REFLOT = LRefLot
                TempRec!CALVAL = LCalval

                If Round(MQnty, 2) > 0 Then
                    TempRec!BUYQTY = TempRec!BUYQTY + Abs(Val(MQnty))
                Else
                    TempRec!SELLQTY = TempRec!SELLQTY + Abs(Val(MQnty))
                End If
                
                TempRec!Company = Company: TempRec!ACEXCODE = LAcExCode
                TempRec.Update
                TempRec.Filter = adFilterNone
                
                                
                Set BranchRec = Nothing
                Set BranchRec = New ADODB.Recordset
                mysql = "SELECT A.FMLYID ,A.FMLYCODE,A.FMLYNAME,A.FMLYHEAD,A.CONTRA_AC,A.HEADID,A.CONTRAID FROM ACCFMLY AS A, ACCFMLYD AS B"
                mysql = mysql & " Where A.COMPCODE=B.COMPCODE AND A.COMPCODE=" & GCompCode & " AND  A.FMLYID =B.FMLYID AND B.ACCID  =" & LACCID & ""
                BranchRec.Open mysql, CompCnn, adOpenForwardOnly, adLockReadOnly
                If Not BranchRec.EOF Then
                    Do While Not BranchRec.EOF
                        LShRate = 0
                        
                        
                        mysql = " EXEC GET_SHARERATE " & BranchRec!FMLYID & "," & LACCID & "," & LExID & "," & LItemID & ",'" & LInstType & "','" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                        
                        Set MRec = Nothing
                        Set MRec = New ADODB.Recordset
                        MRec.Open mysql, CompCnn, adOpenForwardOnly, adLockReadOnly
                        If Not MRec.EOF Then LShRate = MRec!SHRATE
                        If LShRate <> 0 Then
                        
                            LAcExCode = BranchRec!FMLYHEAD
                            Set acexRec = Nothing
                            Set acexRec = New ADODB.Recordset
                            mysql = "SELECT UCC FROM ACCOUNTD "
                            mysql = mysql & " Where COMPCODE=" & GCompCode & " AND  ACCID  =" & BranchRec!HEADID & ""
                            acexRec.Open mysql, CompCnn, adOpenForwardOnly, adLockReadOnly
                            If Not acexRec.EOF Then
                                If Len(acexRec!UCC) > 0 Then
                                    LAcExCode = acexRec!UCC
                                End If
                            End If
                            
                            If TempRec.RecordCount > 0 Then
                                TempRec.MoveFirst
                            End If
                            TempRec.Filter = "PARTY = '" & Left(LAcExCode, 6) & "' and Sauda = '" & LSaudaCode & "'"
                            If TempRec.EOF Then
                                TempRec.Filter = adFilterNone
                                TempRec.AddNew
                                TempRec!PARTY = Left(LAcExCode, 6)
                                TempRec!SELLQTY = 0: TempRec!BUYQTY = 0
                                If Len(acexRec!UCC) > 0 Then
                                    TempRec!NAME = LAcExCode
                                Else
                                    LPartyName = Get_AccountName(BranchRec!HEADID, Company):      TempRec!NAME = LPartyName:
                                End If
                           ' Else
                                'MQnty = MQnty + TempRec!BUYQTY - TempRec!SELLQTY
                            End If
                        
                            TempRec!Sauda = LSaudaCode::
                            TempRec!excode = LExCode:                               TempRec!setrate = DCloseRate
                            TempRec!PRVRate = MPrvCloseRate:                        TempRec!REFLOT = LRefLot
                            
                            TempRec!CALVAL = LCalval:
                            TempRec!Company = Company
                            TempRec!shareqty = IIf(IsNull(TempRec!shareqty), 0, TempRec!shareqty) + (Round((MQnty * -1) * (LShRate / 100), 2))
                            TempRec.Update

                            'LContr_Ac
                            'If Right(LAcExCode, 2) <> "-1" Then
                            LAcExCode = BranchRec!Contra_Ac
                            Set acexRec = Nothing
                            Set acexRec = New ADODB.Recordset
                            mysql = "SELECT UCC FROM ACCOUNTD "
                            mysql = mysql & " Where COMPCODE=" & GCompCode & " AND  ACCID  =" & BranchRec!CONTRAID & ""
                            acexRec.Open mysql, CompCnn, adOpenForwardOnly, adLockReadOnly
                            If Not acexRec.EOF Then
                                If Len(acexRec!UCC) > 0 Then
                                    LAcExCode = acexRec!UCC
                                End If
                            End If
                            
                            If TempRec.RecordCount > 0 Then
                                TempRec.MoveFirst
                            End If
                            TempRec.Filter = "PARTY = '" & Left(LAcExCode, 6) & "' and Sauda = '" & LSaudaCode & "'"
                            If TempRec.EOF Then
                                TempRec.Filter = adFilterNone
                                TempRec.AddNew
                                TempRec!PARTY = Left(LAcExCode, 6)
                                TempRec!SELLQTY = 0: TempRec!BUYQTY = 0
                                If Len(acexRec!UCC) > 0 Then
                                    TempRec!NAME = LAcExCode
                                Else
                                    LPartyName = Get_AccountName(BranchRec!CONTRAID, Company):      TempRec!NAME = LPartyName:
                                End If
                           ' Else
                                'MQnty = MQnty + TempRec!BUYQTY - TempRec!SELLQTY
                            End If
                            
                            TempRec!Sauda = LSaudaCode:
                            TempRec!excode = LExCode:                              TempRec!setrate = DCloseRate
                            TempRec!PRVRate = MPrvCloseRate:                       TempRec!REFLOT = LRefLot
                            TempRec!CALVAL = LCalval:
                            TempRec!Company = Company
                            TempRec!shareqty = IIf(IsNull(TempRec!shareqty), 0, TempRec!shareqty) + (Round((MQnty) * (LShRate / 100), 2))
                            TempRec.Update
                            'End If
                        End If
GONEXT:
                        BranchRec.MoveNext
                    Loop

                End If
            Else
                If Option4.Value = True Then 'partywise
                    RecRpt.AddNew
                    RecRpt!Sauda = LSaudaCode:
                    RecRpt!bparty = LPartyName:     RecRpt!BCODE = LPartyCode
                    RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                    RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                    RecRpt!CALVAL = LCalval
                    RecRpt!Company = Company
                    LAvgRate = 0
                    If Option2.Value = True Then 'avg rate
                        'If Check3.Value = 1 Then
                            mysql = "SELECT MAX(SETDATE) AS MDT FROM SETTLE WHERE COMPCODE =" & GCompCode & " AND SETDATE <'" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
                            Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                            TRec2.Open mysql, CompCnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec2.EOF Then
                                LMDT = IIf(IsNull(TRec2!MDt), GFinBegin, TRec2!MDt)
                                LPQty = Get_CloseQty(LACCID, LSaudaID, LMDT, Company)
                                LRATE = SDCLRATE(LSaudaID, DateValue(LMDT), "C", Company)
                                MNetAmt = LPQty * LRATE
                                Set TRec2 = Nothing:                        Set TRec2 = New ADODB.Recordset
                                mysql = "SELECT SUM(CASE CONTYPE WHEN 'B' THEN QTY*RATE WHEN 'S' THEN QTY*RATE*-1 END ) AS AMT FROM CTR_D WHERE"
                                mysql = mysql & " ACCID =" & LACCID & " AND CONDATE >'" & Format(LMDT, "yyyy/MM/dd") & "' AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "'"
                                mysql = mysql & " AND SAUDAID=" & LSaudaID & ""
                                TRec2.Open mysql, CompCnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec2.EOF Then
                                    MNetAmt = Abs(MNetAmt + (IIf(IsNull(TRec2!AMT), 0, TRec2!AMT)))
                                End If
                            End If
                    Else
                            LBalQty = Abs(MQnty)
                            If LBalQty <> 0 Then
                                mysql = "SELECT CONTYPE,RATE,QTY FROM CTR_D WHERE ACCID =" & LACCID & ""
                                mysql = mysql & " AND CONDATE <='" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' "
                                'If MQnty > 0 Then
                                '    MYSQL = MYSQL & " AND CONTYPE ='B'"
                                'Else
                                 '   MYSQL = MYSQL & " AND CONTYPE ='S'"
                                'End If
                                mysql = mysql & " AND SAUDAID =" & LSaudaID & " ORDER BY CONDATE DESC ,CONNO DESC "
                                Set TRec2 = Nothing: Set TRec2 = New ADODB.Recordset
                                TRec2.Open mysql, CompCnn, adOpenForwardOnly, adLockReadOnly
                                Do While Not TRec2.EOF
                                    If TRec2!CONTYPE = "B" Then
                                        MNetAmt = MNetAmt + TRec2!QTY * TRec2!Rate
                                    Else
                                        MNetAmt = MNetAmt - TRec2!QTY * TRec2!Rate
                                    End If
                                    TRec2.MoveNext
                                Loop
                                Set TRec2 = Nothing
                            End If
                        'End If
                    End If
                        LAvgRate = MNetAmt / MQnty
                    If Round(MQnty, 2) > 0 Then
                        RecRpt!SQnty = 0:               RecRpt!SRate = 0:
                        RecRpt!BQnty = Abs(Val(MQnty)): RecRpt!BRate = LAvgRate:
                    Else
                        RecRpt!SQnty = Abs(Val(MQnty)): RecRpt!SRate = LAvgRate
                        RecRpt!BQnty = 0:               RecRpt!BRate = 0:
                    End If
                    RecRpt.Update
                Else ' saudawise
                    If MQnty > 0 Then
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "BPARTY ='' AND SAUDA='" & LSaudaCode & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!SPARTY = vbNullString
                            RecRpt!SQnty = 0
                        End If
                        RecRpt!bparty = LPartyName:     RecRpt!BCODE = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LCalval:        RecRpt!Sauda = LSaudaCode
                        RecRpt!BQnty = Abs(Val(MQnty))
                        RecRpt.Update
                        If LExCode = "NSE" Then
                            RecRpt!BRate = LRefLot
                        End If
                    Else
                        RecRpt.Filter = adFilterNone
                        RecRpt.Filter = "SPARTY ='' AND SAUDA='" & LSaudaCode & "'"
                        If RecRpt.EOF Then
                            RecRpt.AddNew
                            RecRpt!bparty = vbNullString
                            RecRpt!BQnty = 0
                        End If
                        RecRpt!SPARTY = LPartyName:     RecRpt!scode = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LRefLot:        RecRpt!Sauda = LSaudaCode
                        RecRpt!SQnty = Abs(Val(MQnty))
                        RecRpt.Update
                        If LExCode = "NSE" Then
                            RecRpt!SRate = LRefLot
                        End If
                    End If
                    RecRpt.Filter = adFilterNone
                End If
            End If
            
            TRec.MoveNext
            If TRec.EOF Then Exit Do
        Loop
        If TRec.EOF Then Exit Do
    Loop  'Do While Not TRec.EOF
    Next  'For comploop = 1 To NoCompany
      
    GETMAIN.Label1.Caption = ""
    DoEvents
    If Check4.Value = 1 Then ' Sharing
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        Set TRec = TempRec.Clone
        
        LSParties = Replace(Replace(LSParties, "'", ""), ", ", ",")
        If (LSParties <> "") Then
            LSParties = "," & LSParties
            LSParties = LSParties & ","
        End If
        
        If TRec.RecordCount > 0 Then
            TRec.Sort = "PARTY,SAUDA"
            TRec.MoveFirst
            Do While Not TRec.EOF
                LPartyCode = TRec!PARTY:                LSaudaCode = TRec!Sauda
                LPartyName = TRec!NAME:                 LExCode = TRec!excode
                DCloseRate = TRec!setrate:              MPrvCloseRate = TRec!PRVRate
                LCalval = TRec!CALVAL:                  LRefLot = TRec!REFLOT
                LFmlyCode = TRec!FMLYCODE & vbNullString
                LFmlyName = TRec!FmlyNAME & vbNullString
                LBuyQty = 0: LSellQty = 0: LShareQty = 0
                GETMAIN.Label1.Caption = "Sharing " & LPartyName & " " & LSaudaCode & ""
                DoEvents
                Do While TRec!PARTY = LPartyCode And TRec!Sauda = LSaudaCode
                    LBuyQty = LBuyQty + TRec!BUYQTY
                    LSellQty = LSellQty + TRec!SELLQTY
                    LShareQty = LShareQty + TRec!shareqty
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
'Partywise
'                If Option4.Value Then  'party wise
                     
                    If (LSParties = "") Or (InStr(1, LSParties, "," & LPartyCode + ",") > 0) Then
                        RecRpt.AddNew
                        
                        RecRpt!Sauda = LSaudaCode:
                        RecRpt!NAME = LPartyName:       RecRpt!PARTY = LPartyCode
                        RecRpt!excode = LExCode:        RecRpt!setrate = DCloseRate
                        RecRpt!PRVRate = MPrvCloseRate: RecRpt!REFLOT = LRefLot
                        RecRpt!CALVAL = LCalval
                        RecRpt!FMLYCODE = LFmlyCode
                        RecRpt!FmlyNAME = LFmlyName
                        MQnty = LBuyQty + (LSellQty * -1)
                        If Round(MQnty, 2) > 0 Then
                            RecRpt!SQnty = 0:
                            RecRpt!BQnty = Abs(Val(MQnty)):
                        Else
                            RecRpt!SQnty = Abs(Val(MQnty)):
                            RecRpt!BQnty = 0:
                        End If
                        RecRpt!shareqty = LShareQty
                        RecRpt.Update
                    End If
            Loop
        End If
    End If
    
    RecRpt.Filter = adFilterNone
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    Set TRec = RecRpt.Clone
    LBuyQty = TRec.RecordCount
    If Option3.Value = False Then  'party wise
        If Option4.Value And Option1.Value Then
            If Check9.Value = 0 Then
                If Check4.Value = 1 Then
                    TRec.Sort = "party,EXCODE,SAUDA"
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT-SHARE.RPT", 1)
                Else
                    Set RDCREPO = RDCAPP.OpenReport(GReportPath & "POUT.RPT", 1)
                End If
            Else
                Set RDCREPO = RDCAPP.OpenReport(GReportPath & "CPOUT.rpt", 1)
            End If
        ElseIf Option4.Value And Option1.Value = False Then
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "APOUT.rpt", 1)
        End If
        mysql = "'Party wise Sauda wise Standing upto " & vcDTP1.Value & "'"
    Else 'sauda wise
        If Check4.Value = 1 Then 'sharing
            TRec.Sort = "SAUDA,party,EXCODE"
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MOUT-SHARE.RPT", 1)
        Else
            Set RDCREPO = RDCAPP.OpenReport(GReportPath & "MOUT.rpt", 1)
        End If
        
        mysql = "'Sauda wise Party wise Standing upto " & vcDTP1.Value & "'"
    End If
    RDCREPO.DiscardSavedData
    RDCREPO.Database.SetDataSource TRec
    RDCREPO.FormulaFields.GetItemByName("COMPANY").text = "'" & GCompanyName & "'"
    RDCREPO.FormulaFields.GetItemByName("TITLE").text = mysql
    CRViewer1.ZOrder
    CRViewer1.Move 0, 0, CInt(GETMAIN.Width - 100), CInt(GETMAIN.Height - GETMAIN.Toolbar1.Height - 1000)
    CRViewer1.Visible = True
    CRViewer1.ReportSource = RDCREPO
    CRViewer1.Zoom 1
    CRViewer1.ViewReport
    Me.MousePointer = 0
    OkCmd.Enabled = True
    Exit Sub
err1:
    If err.Number <> 0 Then
        If InStr(1, err.Description, "Cannot open database") <= 0 Then
            MsgBox err.Description, vbCritical, "Error Number : " & err.Number
            Me.MousePointer = 0
            OkCmd.Enabled = True
        End If
    End If
End Sub



Public Function Get_Saudas_cd() As String
Dim LFSaudas   As String: Dim LCount As Integer: Dim I As Integer

LFSaudas = vbNullString
LCount = SaudaList.ListItems.Count
If AllSaudas = False Then
    For I = 1 To SaudaList.ListItems.Count
        If SaudaList.ListItems(I).Checked = True Then
            LCount = LCount - 1
            If LenB(LFSaudas) <> 0 Then LFSaudas = LFSaudas & "','"
            LFSaudas = LFSaudas & SaudaList.ListItems(I).SubItems(1) & ""
        End If
    Next
    If LCount <> 0 Then
        If LCount <> SaudaList.ListItems.Count Then AllSaudas = False
    Else
        AllSaudas = True
    End If
End If
If FilterChk = True Then AllSaudas = False
Get_Saudas_cd = LFSaudas
End Function

Private Sub Client_INTEREST(LPartyCode As String, LSaudaARRAY As String)

    Dim LFLAG As Boolean: Dim LINTEREST  As Double: Dim LPty As String:
    Dim BRECLONE As ADODB.Recordset: Dim SRECLONE As ADODB.Recordset: Dim IRec As ADODB.Recordset
    Dim LPeakMargin  As Double: Dim BQTY As Double: Dim SQTY As Double
    Dim BDATE As Date: Dim SDATE As Date: Dim LDateDiff As Integer
    Dim BAMT As Double: Dim INTRATE As Double: Dim INTTYPE As String: Dim vSaudaCode As String
    Dim FlagBrec As Boolean, FlagSrec As Boolean: Dim SAUDArray() As String: Dim iloop As Integer
    Dim MSauda As String
    Dim mbrate1 As Double: Dim msqty As Double
    
    FlagBrec = True: FlagSrec = True
        
    INTRATE = 0: INTTYPE = ""
    Set IRec = Nothing: Set IRec = New ADODB.Recordset
    mysql = "SELECT INTRATE,INTTYPE  from accountD where compcode=" & GCompCode & " and ac_code='" & LPartyCode & "'"
    IRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not IRec.EOF Then
        INTRATE = IRec!INTRATE
        INTTYPE = IRec!INTTYPE
    End If

    If INTRATE > 0 Then
        If InStr(1, ";", LSaudaARRAY) <= 0 Then
            LSaudaARRAY = LSaudaARRAY + ";"
        End If
        
        SAUDArray = Split(LSaudaARRAY, ";")
        For iloop = 0 To UBound(SAUDArray)
            LINTEREST = 0
            AccRecSet.Filter = adFilterNone
            If AccRecSet.RecordCount >= 1 Then
                Set BRECLONE = AccRecSet.Clone
                BRECLONE.Filter = adFilterNone
                BRECLONE.Filter = "BINSTYPE='CSH' or BINSTYPE='OPT' "
                BRECLONE.Filter = "SAUDACODE='" & SAUDArray(iloop) & "' and PARTYCODE='" & LPartyCode & "'  " ' AND CTYPE='B'" AND (BINSTYPE='CSH' OR BINSTYPE='OPT')
                If BRECLONE.RecordCount >= 1 Then
                    'AccRecSet.Sort = "CONTDATE asc"
                    'AccRecSet.MoveFirst
                    'Set BRECLONE = AccRecSet.Clone: BRECLONE.MoveFirst
                    FlagBrec = True
                Else
                    FlagBrec = False
                End If
                
                LINTEREST = 0
                
                Set SRECLONE = AccRecSet.Clone:
                SRECLONE.Filter = adFilterNone
                SRECLONE.Filter = "BINSTYPE='CSH' OR BINSTYPE='OPT' "
                SRECLONE.Filter = "PARTYCODE='" & LPartyCode & "' AND SAUDACODE='" & SAUDArray(iloop) & "' "
                MSauda = SAUDArray(iloop)
                If SRECLONE.RecordCount >= 1 Then
                    SRECLONE.Sort = "CONTDATE asc"
                    SRECLONE.MoveFirst
                    'Set SRECLONE = AccRecSet.Clone:
                    'SRECLONE.MoveFirst
                    FlagSrec = True
                Else
                    FlagSrec = False
                End If
                
                If FlagBrec And FlagSrec Then
                    LINTEREST = 0
                    Do While Not BRECLONE.EOF
                        If BRECLONE!BQnty & "" <> "" Then
                            BQTY = BRECLONE!BQnty
                            BDATE = BRECLONE!CONTDATE
                            BAMT = BQTY * BRECLONE!BRate
                            mbrate1 = BRECLONE!BRate
                            If SRECLONE.RecordCount >= 1 Then
                                SRECLONE.MoveFirst
                                Do While Not SRECLONE.EOF
                                
                                    If SRECLONE!SQnty & "" <> "" Then
                                    If SRECLONE!SQnty <> "0" Then
                                        SQTY = Val(SRECLONE!SQnty & "")
                                        msqty = IIf(SQTY > BQTY, BQTY, SQTY)
                                        
                                        SDATE = IIf(IsNull(SRECLONE!CONTDATE1), vcDTP2.Value, SRECLONE!CONTDATE1)

                                        LDateDiff = DateDiff("D", BDATE, SDATE)
                                        If LDateDiff > 0 Then
                                            If UCase(WeekdayName(Weekday(SDATE))) = "MONDAY" Or UCase(WeekdayName(Weekday(SDATE))) = "TUESDAY" Or UCase(WeekdayName(Weekday(SDATE))) = "WEDNESDAY" Then
                                                LDateDiff = LDateDiff + 3
                                            Else
                                                LDateDiff = LDateDiff + 5
                                            End If
                                            LINTEREST = LINTEREST + (Round(((((msqty * mbrate1) * LDateDiff * INTRATE) / 100) / 365), 2) * -1)
                                        End If
                                        BAMT = BAMT - (msqty * mbrate1)
                                        BQTY = BQTY - SQTY
                            SRECLONE!SQnty = SQTY - msqty
                            SRECLONE.Update
                            
                                        If BQTY <= 0 Then
                                            Exit Do
                                        End If
                                    End If
                                    End If

                                    SRECLONE.MoveNext
                                Loop
                                
                            End If
                        End If
                        
                    AccRecSet.Filter = adFilterNone
                    If AccRecSet.RecordCount >= 1 Then
                        AccRecSet.Filter = "BINSTYPE='CSH' OR BINSTYPE='OPT' "
                        AccRecSet.Filter = "PARTYCODE='" & LPartyCode & "' AND SAUDACODE='" & MSauda & "'"
                        If AccRecSet.RecordCount >= 1 Then
                            AccRecSet!MarAmt = Val(LINTEREST)
                            AccRecSet.Update
                        End If
                    End If
                    AccRecSet.Filter = adFilterNone

                        BRECLONE.MoveNext
                    Loop

                End If '>>> If FlagBrec And FlagSrec Then
            End If '>>> If AccRecSet.RecordCount >= 1 Then
        Next '>>> For I = 0 To UBound(SArray)
    End If
End Sub




            'If LAExCode = "LME" Then
            '    Set TRec = Nothing
            '    Set TRec = New ADODB.Recordset
            '    mysql = "SELECT A.CONNO,A.QTY,A.RATE,A.CONTYPE,A.CONDATE FROM CTR_D AS A WHERE A.COMPCODE=" & GCompCode & " AND A.PARTY='" & LPartyCode & "' "
            '    mysql = mysql & " AND A.SAUDA ='" & LSaudaCode & "' AND A.CONDATE<='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' ORDER BY A.CONDATE,A.CONNO"
            '    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            '    Do While Not TRec.EOF
            '        AccRecSet.AddNew
            '        CountRec = CountRec + 1
            '        'common
            '        AccRecSet.Fields("RPTGRP") = 5:                     AccRecSet.Fields("SRNO") = CountRec:
            '        AccRecSet.Fields("CALVAL") = LCalval:
            '        AccRecSet.Fields("CONNO") = TRec!CONNO
            '        AccRecSet.Fields("STANDING") = LCloseRate
            '        AccRecSet.Fields("PrevBal") = LprevBal
            '        AccRecSet.Fields("DEBITAMT") = LNetRecdPay
            '        AccRecSet.Fields("CREDITAMT") = LNetMargin
            '        'buy sell
            '        If TRec!CONTYPE > "B" Then
            '            AccRecSet.Fields("CTYPE") = "B":                AccRecSet.Fields("CONTDATE") = Format(TRec!Condate, "yyyy/MM/dd")
            '            AccRecSet.Fields("BQNTY") = TRec!QTY:           AccRecSet.Fields("BRATE") = TRec!Rate
            '        Else
            '            AccRecSet.Fields("CTYPE") = "S":                AccRecSet.Fields("CONTDATE") = Format(TRec!Condate, "yyyy/MM/dd")
            '            AccRecSet.Fields("SQNTY") = TRec!QTY:           AccRecSet.Fields("SRATE") = TRec!Rate
            '        End If
            '        Call Add_PartyDetails
            '        Call Add_OtherDetails
            '        AccRecSet.Update
            '        TRec.MoveNext
            '    Loop
            'End If

Sub flag_party(LPartyCode1 As String, lpartyname1 As String)
        If CreateChk.Value = 1 Then
            If PartyRec.EOF Then
                Call Client_Margin
                Call CreateReport(lpartyname1)
            Else
                If LPartyCode1 <> PartyRec!AC_CODE Then
                    Call Client_Margin
                    Call CreateReport(lpartyname1)
                    Call AccRecNew
                End If
            End If
        End If

End Sub

Sub updinterest(LPartyCode1 As String, LSaudaCode_muliple1 As String)
            PartyRec.MoveNext
            GETMAIN.ProgressBar1.Value = GETMAIN.ProgressBar1.Value + 1
            Call PERCENTAGE(GETMAIN.ProgressBar1.Max, GETMAIN.ProgressBar1.Value)
            DoEvents
            
            If Check11.Value = 1 And Check12.Value <> 1 Then
                If Not PartyRec.EOF Then
                    If LPartyCode1 <> PartyRec!AC_CODE Then
                        Call Client_INTEREST(LPartyCode1, LSaudaCode_muliple1)
                        LSaudaCode_muliple1 = ""
                    End If
                Else
                    Call Client_INTEREST(LPartyCode1, LSaudaCode_muliple1)
                    LSaudaCode_muliple1 = ""
                End If
             End If

End Sub

Sub getminrate(LPartyCode1 As String, litemid1 As Integer, lexid1 As Integer, lminrate1 As Double)
    mysql = "SELECT MINRATE FROM PITBROK WHERE COMPCODE=" & GCompCode & " AND AC_CODE ='" & LPartyCode1 & "' "
    mysql = mysql & " AND ITEMID =" & litemid1 & " AND UPTOSTDT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND MBROKTYPE='F' ORDER BY UPTOSTDT"
    Dim TRec1 As ADODB.Recordset
    Set TRec1 = Nothing
    Set TRec1 = New ADODB.Recordset
    TRec1.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec1.EOF Then
        lminrate1 = TRec1!MinRate
    Else
        mysql = "SELECT MINRATE FROM PEXBROK WHERE COMPCODE=" & GCompCode & " AND AC_CODE ='" & LPartyCode1 & "' "
        mysql = mysql & " AND EXID =" & lexid1 & " AND UPTOSTDT>='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'AND MBROKTYPE='F' ORDER BY UPTOSTDT"
        Set TRec1 = Nothing
        Set TRec1 = New ADODB.Recordset
        TRec1.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not TRec1.EOF Then
            lminrate1 = TRec1!MinRate
        End If
    End If
    Set TRec1 = Nothing
End Sub


