VERSION 5.00
Object = "{F0D2F211-CCB0-11D0-A316-00AA00688B10}#1.0#0"; "MSDATLST.OCX"
Object = "{0102BD99-4A7D-11D3-AC0E-00C026A22F30}#5.1#0"; "DATECTL.OCX"
Object = "{F9043C88-F6F2-101A-A3C9-08002B2F49FB}#1.2#0"; "comdlg32.ocx"
Object = "{48E59290-9880-11CF-9754-00AA00C00908}#1.0#0"; "MSINET.OCX"
Begin VB.Form frmdata 
   BackColor       =   &H00FFFFFF&
   ClientHeight    =   8415
   ClientLeft      =   225
   ClientTop       =   570
   ClientWidth     =   10560
   KeyPreview      =   -1  'True
   LinkTopic       =   "Form1"
   MDIChild        =   -1  'True
   ScaleHeight     =   12915
   ScaleWidth      =   23760
   WindowState     =   2  'Maximized
   Begin VB.Frame Frame8 
      BackColor       =   &H00FF8080&
      BorderStyle     =   0  'None
      Caption         =   "ERGGHE"
      Height          =   4095
      Left            =   600
      TabIndex        =   114
      Top             =   5400
      Visible         =   0   'False
      Width           =   12135
      Begin VB.CommandButton Command1 
         Appearance      =   0  'Flat
         Caption         =   "x"
         BeginProperty Font 
            Name            =   "Verdana"
            Size            =   20.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   480
         Left            =   11400
         TabIndex        =   116
         ToolTipText     =   "Close"
         Top             =   -15
         Width           =   615
      End
      Begin VB.ListBox List1 
         BeginProperty Font 
            Name            =   "Verdana"
            Size            =   9
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   3420
         ItemData        =   "frmdata.frx":0000
         Left            =   120
         List            =   "frmdata.frx":0002
         TabIndex        =   115
         Top             =   480
         Width           =   11895
      End
      Begin VB.Label Label16 
         BackStyle       =   0  'Transparent
         Caption         =   "Please Check Trade"
         BeginProperty Font 
            Name            =   "Verdana"
            Size            =   9.75
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FFFFFF&
         Height          =   255
         Left            =   80
         TabIndex        =   117
         Top             =   120
         Width           =   2415
      End
   End
   Begin VB.Frame Frame7 
      BackColor       =   &H00FFFFFF&
      BorderStyle     =   0  'None
      Height          =   615
      Left            =   0
      TabIndex        =   108
      Top             =   0
      Width           =   15375
      Begin VB.Label Label7 
         BackColor       =   &H00FF8080&
         Caption         =   "Data Import"
         BeginProperty Font 
            Name            =   "Segoe Script"
            Size            =   18
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   -1  'True
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00400000&
         Height          =   495
         Left            =   120
         TabIndex        =   109
         Top             =   120
         Width           =   14895
      End
   End
   Begin VB.Frame Frame10 
      BackColor       =   &H00E0E0E0&
      BorderStyle     =   0  'None
      Caption         =   "Frame10"
      Height          =   375
      Left            =   0
      TabIndex        =   105
      Top             =   9720
      Visible         =   0   'False
      Width           =   15135
      Begin VB.TextBox Text2 
         Height          =   1215
         Left            =   120
         MultiLine       =   -1  'True
         ScrollBars      =   2  'Vertical
         TabIndex        =   106
         Text            =   "frmdata.frx":0004
         Top             =   120
         Width           =   9255
      End
   End
   Begin InetCtlsObjects.Inet Inet1 
      Left            =   16560
      Top             =   0
      _ExtentX        =   1005
      _ExtentY        =   1005
      _Version        =   393216
      Protocol        =   2
      RemotePort      =   21
      URL             =   "ftp://"
   End
   Begin VB.Frame Frame1 
      BackColor       =   &H00FFFFFF&
      BorderStyle     =   0  'None
      Caption         =   "Trades  &&  Closing  Rate  Import"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00000000&
      Height          =   8895
      Left            =   0
      TabIndex        =   85
      Top             =   600
      Width           =   15255
      Begin VB.CommandButton OkCmd 
         BackColor       =   &H00FFFFFF&
         Caption         =   "&OK"
         BeginProperty Font 
            Name            =   "Verdana"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   400
         Left            =   13200
         Style           =   1  'Graphical
         TabIndex        =   8
         Top             =   240
         Width           =   1560
      End
      Begin VB.CommandButton Command2 
         BackColor       =   &H00FFFFFF&
         Caption         =   "&Cancel"
         BeginProperty Font 
            Name            =   "Verdana"
            Size            =   12
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   400
         Left            =   13200
         Style           =   1  'Graphical
         TabIndex        =   9
         Top             =   720
         Width           =   1560
      End
      Begin vcDateTimePicker.vcDTP vcDTP2 
         Height          =   375
         Left            =   840
         TabIndex        =   1
         Top             =   720
         Width           =   1575
         _ExtentX        =   2778
         _ExtentY        =   661
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Verdana"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Value           =   38190.9758796296
      End
      Begin vcDateTimePicker.vcDTP vcDTP1 
         Height          =   375
         Left            =   840
         TabIndex        =   0
         Top             =   240
         Width           =   1575
         _ExtentX        =   2778
         _ExtentY        =   661
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Verdana"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Value           =   38157.5691319444
      End
      Begin VB.Frame Frame2 
         BackColor       =   &H00FFC0C0&
         BorderStyle     =   0  'None
         Height          =   8775
         Left            =   120
         TabIndex        =   86
         Top             =   0
         Width           =   14925
         Begin VB.CommandButton cmdspecial 
            BackColor       =   &H00FFFFFF&
            Caption         =   "&Live Excel Import"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   12
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   645
            Left            =   11160
            Style           =   1  'Graphical
            TabIndex        =   120
            Top             =   360
            Visible         =   0   'False
            Width           =   1800
         End
         Begin VB.CheckBox Check48 
            BackColor       =   &H00FFFFFF&
            Caption         =   "Party Brokerage Shraring "
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   255
            Left            =   10200
            TabIndex        =   119
            TabStop         =   0   'False
            Top             =   6720
            Visible         =   0   'False
            Width           =   3615
         End
         Begin VB.OptionButton RadioMCX 
            BackColor       =   &H00FFC0C0&
            Caption         =   "MCX Live Rate"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   4200
            TabIndex        =   5
            Top             =   720
            Width           =   1815
         End
         Begin VB.OptionButton RadioNSE 
            BackColor       =   &H00FFC0C0&
            Caption         =   "NSE Live Rate"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   240
            Left            =   6120
            TabIndex        =   6
            Top             =   720
            Width           =   1695
         End
         Begin VB.OptionButton RadioMN 
            BackColor       =   &H00FFC0C0&
            Caption         =   "MCX + NSE Live Rate"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   240
            Left            =   8640
            TabIndex        =   7
            Top             =   720
            Width           =   2415
         End
         Begin VB.CheckBox ChkRate 
            BackColor       =   &H00FFC0C0&
            Caption         =   "Check Rate"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   345
            Left            =   4200
            TabIndex        =   2
            Top             =   120
            Value           =   1  'Checked
            Width           =   1455
         End
         Begin VB.Frame Frame9 
            BackColor       =   &H00FFFFFF&
            BorderStyle     =   0  'None
            Height          =   1050
            Left            =   10200
            TabIndex        =   112
            Top             =   5520
            Visible         =   0   'False
            Width           =   4455
            Begin VB.CheckBox ChkFXCTCLOnLine 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CTCL && OnLine"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2280
               TabIndex        =   84
               Top             =   600
               Visible         =   0   'False
               Width           =   1935
            End
            Begin VB.CheckBox ChkFXTrade 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   120
               TabIndex        =   81
               TabStop         =   0   'False
               Top             =   120
               Width           =   975
            End
            Begin VB.CheckBox CHkFXClosing 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Bhav Copy"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   2280
               TabIndex        =   82
               TabStop         =   0   'False
               Top             =   120
               Width           =   1575
            End
            Begin VB.CheckBox Check21 
               BackColor       =   &H00FFFFFF&
               Caption         =   "All Terminal"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   120
               TabIndex        =   83
               TabStop         =   0   'False
               Top             =   600
               Width           =   1575
            End
         End
         Begin VB.Frame Frame6 
            BackColor       =   &H00FFFFFF&
            BorderStyle     =   0  'None
            Height          =   3090
            Left            =   120
            TabIndex        =   101
            Top             =   5160
            Visible         =   0   'False
            Width           =   9855
            Begin VB.CheckBox Check18 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel Trade File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   7800
               TabIndex        =   76
               TabStop         =   0   'False
               Top             =   1680
               Width           =   1935
            End
            Begin VB.TextBox TxtQtyMultipler 
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   405
               Left            =   8760
               TabIndex        =   79
               Top             =   2160
               Width           =   975
            End
            Begin VB.CheckBox Check46 
               BackColor       =   &H00FFFFFF&
               Caption         =   "R Closing"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   7800
               TabIndex        =   74
               TabStop         =   0   'False
               Top             =   900
               Width           =   1335
            End
            Begin VB.CheckBox Check45 
               BackColor       =   &H00FFFFFF&
               Caption         =   "R2 Closing"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   7800
               TabIndex        =   75
               TabStop         =   0   'False
               Top             =   1290
               Width           =   1335
            End
            Begin VB.CheckBox Check44 
               BackColor       =   &H00FFFFFF&
               Caption         =   "R2 Credit"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   6240
               TabIndex        =   70
               TabStop         =   0   'False
               Top             =   1290
               Width           =   1335
            End
            Begin VB.CheckBox Check42 
               BackColor       =   &H00FFFFFF&
               Caption         =   "R Credit"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   6240
               TabIndex        =   69
               TabStop         =   0   'False
               Top             =   900
               Width           =   1335
            End
            Begin VB.CheckBox Check41 
               BackColor       =   &H00FFFFFF&
               Caption         =   "R2 Deposit"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   7800
               TabIndex        =   73
               TabStop         =   0   'False
               Top             =   510
               Width           =   1455
            End
            Begin VB.CheckBox Check40 
               BackColor       =   &H00FFFFFF&
               Caption         =   "R Deposit"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   7800
               TabIndex        =   72
               TabStop         =   0   'False
               Top             =   120
               Width           =   1335
            End
            Begin VB.CheckBox Check37 
               BackColor       =   &H00FFFFFF&
               Caption         =   "R2 Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   6240
               TabIndex        =   68
               TabStop         =   0   'False
               Top             =   510
               Width           =   1455
            End
            Begin VB.CheckBox Check35 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel File 15"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   120
               TabIndex        =   60
               TabStop         =   0   'False
               Top             =   1680
               Width           =   1575
            End
            Begin VB.CheckBox Check34 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CMX Closing"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   1800
               TabIndex        =   53
               Top             =   120
               Width           =   1815
            End
            Begin VB.CheckBox Check28 
               BackColor       =   &H00FFFFFF&
               Caption         =   "DGCX Trader"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   3720
               TabIndex        =   62
               Top             =   120
               Width           =   1935
            End
            Begin VB.CheckBox Check33 
               BackColor       =   &H00FFFFFF&
               Caption         =   "DGCX Closing"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   3720
               TabIndex        =   63
               Top             =   510
               Width           =   1935
            End
            Begin VB.CheckBox Check32 
               BackColor       =   &H00FFFFFF&
               Caption         =   "DGCX-USDINR Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   3720
               TabIndex        =   65
               TabStop         =   0   'False
               Top             =   1290
               Width           =   2535
            End
            Begin VB.CheckBox Check31 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Vertex History"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   1800
               TabIndex        =   59
               Top             =   1290
               Width           =   1815
            End
            Begin VB.CheckBox Check30 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CME All File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   1800
               TabIndex        =   57
               TabStop         =   0   'False
               Top             =   900
               Width           =   1935
            End
            Begin VB.CheckBox Check23 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Open Pos"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   6240
               TabIndex        =   71
               TabStop         =   0   'False
               Top             =   1680
               Width           =   1335
            End
            Begin VB.CheckBox Check19 
               BackColor       =   &H00FFFFFF&
               Caption         =   "SGX"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   1800
               TabIndex        =   55
               TabStop         =   0   'False
               Top             =   510
               Width           =   1455
            End
            Begin VB.CheckBox Check29 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CME Trader"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   120
               TabIndex        =   52
               TabStop         =   0   'False
               Top             =   120
               Width           =   1575
            End
            Begin VB.CheckBox Check27 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Vertex File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   1800
               TabIndex        =   61
               Top             =   1680
               Width           =   1455
            End
            Begin VB.CheckBox Check26 
               BackColor       =   &H00FFFFFF&
               Caption         =   "DGCX All Files"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   3720
               TabIndex        =   64
               Top             =   900
               Width           =   2055
            End
            Begin VB.CheckBox Check20 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   120
               TabIndex        =   56
               TabStop         =   0   'False
               Top             =   900
               Width           =   1335
            End
            Begin VB.CheckBox Check25 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CME File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   120
               TabIndex        =   58
               Top             =   1290
               Width           =   1455
            End
            Begin VB.CheckBox Check22 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CME 2"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   120
               TabIndex        =   54
               Top             =   510
               Width           =   1455
            End
            Begin VB.CheckBox Check15 
               BackColor       =   &H00FFFFFF&
               Caption         =   "R Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   6240
               TabIndex        =   67
               TabStop         =   0   'False
               Top             =   120
               Width           =   1335
            End
            Begin VB.TextBox Text1 
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   360
               Left            =   960
               Locked          =   -1  'True
               TabIndex        =   80
               Top             =   2640
               Width           =   8775
            End
            Begin MSDataListLib.DataCombo BrokerCombo 
               Height          =   360
               Left            =   960
               TabIndex        =   77
               Top             =   2160
               Width           =   2775
               _ExtentX        =   4895
               _ExtentY        =   635
               _Version        =   393216
               Text            =   ""
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
            End
            Begin VB.CheckBox Check16 
               BackColor       =   &H00FFFFFF&
               Caption         =   "DGCX Terminal"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   3720
               TabIndex        =   66
               TabStop         =   0   'False
               Top             =   1680
               Width           =   2055
            End
            Begin MSDataListLib.DataCombo ClientCombo 
               Height          =   360
               Left            =   4560
               TabIndex        =   78
               Top             =   2160
               Width           =   2775
               _ExtentX        =   4895
               _ExtentY        =   635
               _Version        =   393216
               Text            =   ""
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
            End
            Begin VB.Label Label14 
               BackStyle       =   0  'Transparent
               Caption         =   "Qty MultiPler"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   255
               Left            =   7440
               TabIndex        =   107
               Top             =   2220
               Width           =   1335
            End
            Begin VB.Label Label13 
               BackStyle       =   0  'Transparent
               Caption         =   "Client"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   255
               Left            =   3840
               TabIndex        =   104
               Top             =   2220
               Width           =   615
            End
            Begin VB.Label Label12 
               BackStyle       =   0  'Transparent
               Caption         =   "Broker"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   255
               Left            =   120
               TabIndex        =   103
               Top             =   2213
               Width           =   735
            End
         End
         Begin VB.CheckBox ChkNewSauda 
            BackColor       =   &H00FFC0C0&
            Caption         =   "Create New Scripts/Contracts"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   345
            Left            =   8640
            TabIndex        =   4
            Top             =   120
            Width           =   3375
         End
         Begin VB.Frame Frame17 
            BackColor       =   &H00FFFFFF&
            BorderStyle     =   0  'None
            Height          =   450
            Left            =   120
            TabIndex        =   100
            Top             =   4200
            Width           =   4575
            Begin VB.CheckBox Check4 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Currency Bhav"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2700
               TabIndex        =   44
               TabStop         =   0   'False
               Top             =   120
               Visible         =   0   'False
               Width           =   1815
            End
            Begin VB.CheckBox ChkBSETrade 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   120
               TabIndex        =   42
               TabStop         =   0   'False
               Top             =   120
               Visible         =   0   'False
               Width           =   975
            End
            Begin VB.CheckBox ChkBSEClosing 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Bhav Copy"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   1170
               TabIndex        =   43
               TabStop         =   0   'False
               Top             =   120
               Visible         =   0   'False
               Width           =   1455
            End
         End
         Begin VB.Frame Frame5 
            BackColor       =   &H00FFFFFF&
            BorderStyle     =   0  'None
            Height          =   2295
            Left            =   10200
            TabIndex        =   98
            Top             =   1440
            Width           =   4455
            Begin VB.CheckBox Check38 
               BackColor       =   &H00FFFFFF&
               Caption         =   "FO Margin Rate"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   285
               Left            =   120
               TabIndex        =   32
               TabStop         =   0   'False
               Top             =   480
               Visible         =   0   'False
               Width           =   2415
            End
            Begin VB.CheckBox ChkNseExcel 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel Trade File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   240
               Left            =   2520
               TabIndex        =   39
               Top             =   1584
               Width           =   2055
            End
            Begin VB.CheckBox ChkNSERefLot 
               BackColor       =   &H00FFFFFF&
               Caption         =   "FO Ref Lot Size "
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   2520
               TabIndex        =   41
               TabStop         =   0   'False
               Top             =   1920
               Visible         =   0   'False
               Width           =   2175
            End
            Begin VB.CheckBox ChkNSEExcelClosing 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel Closing"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   2520
               TabIndex        =   37
               Top             =   1200
               Width           =   2295
            End
            Begin VB.CheckBox ChkNSEAllTerminal 
               BackColor       =   &H00FFFFFF&
               Caption         =   "All Terminal"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   120
               TabIndex        =   36
               Top             =   1200
               Visible         =   0   'False
               Width           =   1695
            End
            Begin VB.CheckBox ChkNSEBrokLot 
               BackColor       =   &H00FFFFFF&
               Caption         =   "FO LotSize for Brok"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   285
               Left            =   120
               TabIndex        =   40
               TabStop         =   0   'False
               Top             =   1920
               Visible         =   0   'False
               Width           =   2535
            End
            Begin VB.CheckBox ChkNSESettleRate 
               BackColor       =   &H00FFFFFF&
               Caption         =   "FO Settle Rates"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   120
               TabIndex        =   34
               TabStop         =   0   'False
               Top             =   840
               Visible         =   0   'False
               Width           =   2175
            End
            Begin VB.CheckBox ChkNSETrade 
               BackColor       =   &H00FFFFFF&
               Caption         =   "FO Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   120
               TabIndex        =   30
               TabStop         =   0   'False
               Top             =   120
               Visible         =   0   'False
               Width           =   1575
            End
            Begin VB.CheckBox CHKFutureRemark 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Remark"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   2520
               TabIndex        =   31
               TabStop         =   0   'False
               Top             =   120
               Visible         =   0   'False
               Width           =   1335
            End
            Begin VB.CheckBox ChkNSEBhavCopy 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Bhav Copy"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   2520
               TabIndex        =   35
               TabStop         =   0   'False
               Top             =   852
               Visible         =   0   'False
               Width           =   2175
            End
            Begin VB.CheckBox ChkNSELotSize 
               BackColor       =   &H00FFFFFF&
               Caption         =   "FO Lot Size"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   2520
               TabIndex        =   33
               TabStop         =   0   'False
               Top             =   486
               Visible         =   0   'False
               Width           =   2055
            End
            Begin VB.CheckBox ChkNSECTCLONLine 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CTCL && OnLine"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000040&
               Height          =   255
               Left            =   120
               TabIndex        =   38
               Top             =   1560
               Visible         =   0   'False
               Width           =   2055
            End
         End
         Begin VB.Frame Frame4 
            BackColor       =   &H00FFFFFF&
            BorderStyle     =   0  'None
            Height          =   2295
            Left            =   4920
            TabIndex        =   90
            Top             =   1440
            Width           =   5055
            Begin VB.CheckBox Check47 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CMX Excel Trade File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2400
               TabIndex        =   118
               Top             =   1920
               Visible         =   0   'False
               Width           =   2415
            End
            Begin VB.CheckBox ChkMCXExcelClosing 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel Closing"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2340
               TabIndex        =   28
               Top             =   1560
               Width           =   2415
            End
            Begin VB.CheckBox ChkMCXMarginFile 
               BackColor       =   &H00FFFFFF&
               Caption         =   "MCX_Margin File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   240
               Left            =   120
               TabIndex        =   29
               Top             =   1920
               Width           =   1935
            End
            Begin VB.CheckBox Check2 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   120
               TabIndex        =   19
               Top             =   120
               Width           =   1095
            End
            Begin VB.CheckBox Check6 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Bhav Copy"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   120
               TabIndex        =   21
               Top             =   480
               Width           =   2055
            End
            Begin VB.CheckBox Check12 
               BackColor       =   &H00FFFFFF&
               Caption         =   "With Remark"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2340
               TabIndex        =   20
               Top             =   120
               Width           =   2415
            End
            Begin VB.CheckBox Check24 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CTCL && OnLine "
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   120
               TabIndex        =   23
               Top             =   840
               Width           =   2175
            End
            Begin VB.CheckBox Check17 
               BackColor       =   &H00FFFFFF&
               Caption         =   "All Terminal"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   120
               TabIndex        =   27
               Top             =   1560
               Width           =   2055
            End
            Begin VB.CheckBox Check3 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Contract Master"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2340
               TabIndex        =   24
               Top             =   840
               Width           =   2415
            End
            Begin VB.CheckBox Check11 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Client Wise Margin"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   120
               TabIndex        =   25
               Top             =   1200
               Width           =   2175
            End
            Begin VB.CheckBox Check39 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel Trade File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2340
               TabIndex        =   26
               Top             =   1200
               Visible         =   0   'False
               Width           =   2415
            End
            Begin VB.CheckBox Check43 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Daily Margin Rate"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2340
               TabIndex        =   22
               Top             =   480
               Width           =   2415
            End
         End
         Begin VB.CheckBox Check14 
            BackColor       =   &H00FFC0C0&
            Caption         =   "Overwrite Old Trade"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   345
            Left            =   6120
            TabIndex        =   3
            Top             =   120
            Width           =   2295
         End
         Begin VB.Frame Frame3 
            BackColor       =   &H00FFFFFF&
            BorderStyle     =   0  'None
            Height          =   2295
            Left            =   120
            TabIndex        =   89
            Top             =   1440
            Width           =   4575
            Begin VB.CheckBox Check5 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Copy Closing"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2160
               TabIndex        =   18
               Top             =   1920
               Visible         =   0   'False
               Width           =   1935
            End
            Begin VB.CheckBox CHKNCDXExcelClosing 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Bhav Copy"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   120
               TabIndex        =   12
               Top             =   510
               Width           =   1935
            End
            Begin VB.CheckBox Check1 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Trade "
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   240
               Left            =   120
               TabIndex        =   10
               Top             =   120
               Width           =   1215
            End
            Begin VB.CheckBox Check8 
               BackColor       =   &H00FFFFFF&
               Caption         =   "With Remark"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   240
               Left            =   2160
               TabIndex        =   11
               Top             =   120
               Width           =   1695
            End
            Begin VB.CheckBox Check13 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Daily Bank File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   120
               TabIndex        =   16
               Top             =   1440
               Width           =   1935
            End
            Begin VB.CheckBox Check9 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Client Wise Margin"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2160
               TabIndex        =   15
               Top             =   997
               Width           =   2295
            End
            Begin VB.CheckBox Check7 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Daily Margin Rates"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2160
               TabIndex        =   13
               Top             =   536
               Width           =   2175
            End
            Begin VB.CheckBox ChkNCDXOnlineCTCL 
               BackColor       =   &H00FFFFFF&
               Caption         =   "CTCL && OnLine"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   120
               TabIndex        =   14
               Top             =   975
               Width           =   2055
            End
            Begin VB.CheckBox ChkNCDXAllTerminal 
               BackColor       =   &H00FFFFFF&
               Caption         =   "All Terminal"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   2160
               TabIndex        =   17
               TabStop         =   0   'False
               Top             =   1440
               Width           =   1815
            End
         End
         Begin VB.Frame Frame14 
            BackColor       =   &H00FFFFFF&
            BorderStyle     =   0  'None
            Caption         =   "Frame14"
            Height          =   810
            Left            =   10200
            TabIndex        =   88
            Top             =   4200
            Width           =   4455
            Begin VB.CheckBox Check10 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   1680
               TabIndex        =   49
               TabStop         =   0   'False
               Top             =   120
               Width           =   1335
            End
            Begin VB.CheckBox chkEquityRemark 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Remark"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   240
               TabIndex        =   50
               TabStop         =   0   'False
               Top             =   480
               Width           =   1215
            End
            Begin VB.CheckBox ChkNSEEQClosing 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Bhav Copy"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   1680
               TabIndex        =   51
               TabStop         =   0   'False
               Top             =   480
               Width           =   1575
            End
            Begin VB.CheckBox ChkNSEEQTrade 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   240
               Left            =   240
               TabIndex        =   48
               TabStop         =   0   'False
               Top             =   120
               Width           =   975
            End
         End
         Begin VB.Frame Frame15 
            BackColor       =   &H00FFFFFF&
            BorderStyle     =   0  'None
            Caption         =   "Frame14"
            Height          =   450
            Left            =   4920
            TabIndex        =   87
            Top             =   4200
            Width           =   5055
            Begin VB.CheckBox Check36 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Excel Trade File"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   1080
               TabIndex        =   46
               Top             =   120
               Visible         =   0   'False
               Width           =   1935
            End
            Begin VB.CheckBox ChkBEQTrade 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Trade"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   255
               Left            =   120
               TabIndex        =   45
               TabStop         =   0   'False
               Top             =   120
               Visible         =   0   'False
               Width           =   975
            End
            Begin VB.CheckBox ChkBEQClosing 
               BackColor       =   &H00FFFFFF&
               Caption         =   "Bhav Copy"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   285
               Left            =   3120
               TabIndex        =   47
               TabStop         =   0   'False
               Top             =   120
               Visible         =   0   'False
               Width           =   1575
            End
         End
         Begin VB.Label Label10 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "Please wait, Data Import in progress .... "
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   15.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   495
            Left            =   3480
            TabIndex        =   113
            Top             =   3720
            Visible         =   0   'False
            Width           =   7935
         End
         Begin VB.Label Label4 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "Currency - FX"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FFFFFF&
            Height          =   375
            Left            =   10200
            TabIndex        =   111
            Top             =   5160
            Width           =   4455
         End
         Begin VB.Label Label15 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "BSE Cash"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FFFFFF&
            Height          =   375
            Left            =   4920
            TabIndex        =   110
            Top             =   3840
            Visible         =   0   'False
            Width           =   5055
         End
         Begin VB.Label Label11 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "LME CMX DGCX NYMEX"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FFFFFF&
            Height          =   375
            Left            =   120
            TabIndex        =   102
            Top             =   4800
            Visible         =   0   'False
            Width           =   9855
         End
         Begin VB.Label Label9 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "BSE F&&O"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FFFFFF&
            Height          =   375
            Index           =   7
            Left            =   120
            TabIndex        =   99
            Top             =   3840
            Width           =   4575
         End
         Begin VB.Label Label2 
            AutoSize        =   -1  'True
            BackColor       =   &H00C0C0C0&
            BackStyle       =   0  'Transparent
            Caption         =   "To "
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00400000&
            Height          =   240
            Left            =   120
            TabIndex        =   97
            Top             =   650
            Width           =   330
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackColor       =   &H00C0C0C0&
            BackStyle       =   0  'Transparent
            Caption         =   "From"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00400000&
            Height          =   240
            Left            =   120
            TabIndex        =   96
            Top             =   180
            Width           =   480
         End
         Begin VB.Label Label5 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "NCDEX"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FFFFFF&
            Height          =   375
            Left            =   120
            TabIndex        =   95
            Top             =   1080
            Width           =   4575
         End
         Begin VB.Label Label6 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "MCX"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FFFFFF&
            Height          =   375
            Left            =   4920
            TabIndex        =   94
            Top             =   1080
            Width           =   5055
         End
         Begin VB.Label Label8 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "NSE F&&O"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FFFFFF&
            Height          =   375
            Left            =   10200
            TabIndex        =   93
            Top             =   1080
            Width           =   4455
         End
         Begin VB.Label Label3 
            Alignment       =   2  'Center
            BackColor       =   &H00FFFFFF&
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   9
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   255
            Left            =   -120
            TabIndex        =   92
            Top             =   8400
            Width           =   15255
         End
         Begin VB.Label Label9 
            Alignment       =   2  'Center
            BackColor       =   &H00FF8080&
            Caption         =   "NSE Cash"
            BeginProperty Font 
               Name            =   "Verdana"
               Size            =   11.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FFFFFF&
            Height          =   375
            Index           =   5
            Left            =   10200
            TabIndex        =   91
            Top             =   3840
            Width           =   4455
         End
      End
   End
   Begin MSComDlg.CommonDialog CommonDialog1 
      Left            =   17400
      Top             =   0
      _ExtentX        =   847
      _ExtentY        =   847
      _Version        =   393216
   End
End
Attribute VB_Name = "frmdata"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Const MCXChDt As Date = "19/12/2008"
Const MCXChDt2 As Date = "19/12/2009"
Const GClgDate As Date = "01/02/2019"
Dim hConnection As Long:   Dim hopen As Long
Dim hFile As Long:         Dim dwType As Long
Dim dwSeman As Long:       Dim LFileSystemObject As Scripting.FileSystemObject
Dim LFile As TextStream
Private Declare Function URLDownloadToFile Lib "urlmon" Alias "URLDownloadToFileA" (ByVal pCaller As Long, ByVal szURL As String, ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long
Private Declare Function DeleteUrlCacheEntry Lib "wininet.dll" Alias "DeleteUrlCacheEntryA" (ByVal lpszUrlName As String) As Long
Private Const ERROR_SUCCESS As Long = 0
Private Const BINDF_GETNEWESTVERSION As Long = &H10
Private Const INTERNET_FLAG_RELOAD As Long = &H80000000

Dim LEXCHANGE As String:                Dim LSExCode As String:                     Dim LExCont As String:               Dim LMemberId As String
Dim LClientCode As String:              Dim LCashAcc As String:                     Dim LContraCashAcc As String:        Dim LBrokerType As String
Dim LBrokerType2 As String:             Dim LBrokerType3 As String:                 Dim LBrokerType4 As String:          Dim LBrokerCode As String
Dim LMemId2 As String:                  Dim LMemId3 As String:                      Dim LMemId4 As String:               Dim LMemId5 As String
Dim LContAc2 As String:                 Dim LContAc3 As String:                     Dim LContAc4 As String:              Dim LContAc5 As String
Dim LMemId6 As String:                  Dim LContAc6 As String:                     Dim LBrokerType5 As String:          Dim LLotWise As String
Dim LGCloseFile As String:              Dim TxtRec As ADODB.Recordset:              Dim LPartyAs As String:              Dim LProAs As String
Dim LTMinDate As Date:                  Dim LTMaxDate As Date:                      Dim FlagDataTrf As Boolean:          Dim NewComm As Boolean
Dim LODIN As Boolean:                   Dim SaudaTrade As Boolean:                  Dim lfiletype As String:             Dim LTradeFileType As String
Dim LEXOptions As String:               Dim Jcnn As New ADODB.Connection:           Dim AccRec  As ADODB.Recordset:      Dim LBrokerCode2 As String
Dim LFolderName As String:              Dim GExFileType As Integer:                 Dim lminbilldate  As Date:           Dim LLOT As Double:
Dim LBillExId  As String:               Dim LNoTrd As Long:                         Dim LBillParties As String:          Dim LSItemCode As String
Dim LSMaturity As Date:                 Dim LSSaudaCode As String:                  Dim LSStrike As Double::             Dim LSInstType As String:
Dim LSOptType As String:                Dim LSItemName As String:                   Dim LSEXID As Integer:               Dim LSItemid As Integer
Dim LSSaudaID As Long:                  Dim LCItemCode As String:                   Dim LSEx_Symbol  As String:          Dim Weekdy As Integer
Dim Vdate As String:                    Dim LNEWPARTY As String:
Dim Vitemcode As String
Dim LOPTINDEX As String

Dim LOConNo As String:              Dim LOrdNo As String:               Dim LOrdTime As String:
Dim LPartyName As String:           Dim LSTRCONDATE As String:          Dim lbparty As String
Dim LSCondate As String:            Dim LSPtyContype As String
Dim A As Integer:                   Dim LEXHCODE As String:             Dim LMONTH As String
Dim lyear As String:                Dim LSTR As String:                 Dim LBRate As Double
Dim LSRate As Double:               Dim lsparty As String:              Dim Vexcelcolval As String
Dim LBQty As Double
Dim LMsgBox As String: Dim lexceltype As Integer: Dim LMonthType As String:
Dim Flag_GONext As Boolean



Private Sub BrokerCombo_Validate(Cancel As Boolean)
If LenB(BrokerCombo.BoundText) > 1 Then
    LBrokerCode = BrokerCombo.BoundText
    LBrokerCode = Get_AccountDCode(LBrokerCode)
    If LenB(LBrokerCode) < 1 Then
        MsgBox " Invalid Account"
        Cancel = True
    End If
End If
End Sub

Private Sub ClientCombo_Validate(Cancel As Boolean)
If LenB(ClientCombo.BoundText) > 1 Then
    LClientCode = ClientCombo.BoundText
    LClientCode = Get_AccountDCode(LClientCode)
    If LenB(LBrokerCode) < 1 Then
        MsgBox " Invalid Account"
        Cancel = True
    End If
End If
End Sub
Private Sub Check14_Click()
    If Check14.Value = 0 Then
        Check14.Caption = "Overwrite Existing Contracts"
    Else
        Check14.Caption = "Add to Existing Contracts"
    End If
End Sub

Public Sub okcmdclick()
    Dim LSaudas As String:      Dim MFromDate As Date: Dim TRec As ADODB.Recordset:
    Dim LCNote As Boolean
    Dim LExcelFileType As Integer
    Dim lqtylot As Integer
    Dim LExIDS As String
    LEXCHANGE = vbNullString:                 LTMinDate = vcDTP1.Value:       LTMaxDate = vcDTP2.Value
    lminbilldate = vcDTP1.Value
    LBillParties = vbNullString
    LBillExId = vbNullString
    If GUniqClientId = "2582KOH" Then
        Check39.Value = 1
    End If
    
    LMsgBox = ""
    Frame8.Visible = False
    GETMAIN.Label1.Caption = vbNullString:    FlagDataTrf = False
    
    lminbilldate = vcDTP1.Value
    Call Lock_Screen
    LSaudas = vbNullString
    NewComm = False
    If ChkNewSauda = 1 Then NewComm = True
    If Day(vcDTP1.Value) = 1 Then
        ChkNewSauda = 1
    ElseIf Day(vcDTP1.Value) = 5 Then
        ChkNewSauda = 1
    ElseIf Day(vcDTP1.Value) = 10 Then
        ChkNewSauda = 1
    ElseIf Day(vcDTP1.Value) = 15 Then
        ChkNewSauda = 1
    ElseIf Day(vcDTP1.Value) = 20 Then
        ChkNewSauda = 1
    ElseIf Day(vcDTP1.Value) = 25 Then
        ChkNewSauda = 1
    End If
    Screen.MousePointer = 11
    LSExCode = vbNullString
    LMemberId = vbNullString
    If ChkBEQTrade.Value = 1 Then Call Get_ExDetail("BEQ")
    
    If ChkNSEEQTrade.Value = 1 Then Call Get_ExDetail("EQ")
    If Check1.Value = 1 Or Check5.Value = 1 Or Check9.Value = 1 Or Check13.Value = 1 Or ChkNCDXOnlineCTCL.Value = 1 Then Call Get_ExDetail("NCDX")
    
    If Check2.Value = 1 Or Check3.Value = 1 Or Check6.Value = 1 Or Check17.Value = 1 Or Check24.Value = 1 Or Check11.Value = 1 Or ChkMCXExcelClosing.Value = 1 Then Call Get_ExDetail("MCX")
    DoEvents
    GETMAIN.Label1.Caption = vbNullString
    'NCDX
    If Check1.Value = 1 Or ChkNCDXAllTerminal.Value = 1 Then Call Trade_Ncdex_OnLBkp
    If Check5.Value = 1 Then Call Save_All_BhavCopy("NCDX")
    If Check7.Value = 1 Then Call SAVE_NCDEX_DlyMgn
    If Check9.Value = 1 Then Call SAVE_NCDEX_CLIENT_MGN
    'If Check10.Value = 1 Then Call SAVE_NCDEX_TR02_New
    If CHKNCDXExcelClosing.Value = 1 Then Call Save_All_BhavCopy("NCDX")
    If Check13.Value Then Call SAVE_NCDEX_BK02
    If ChkNCDXOnlineCTCL.Value = 1 Then Call Trade_Ncdex_OnLBkp_ODIN
    'MCX
    If Check2.Value = 1 Or Check17.Value = 1 Then Call Trade_MCX_OnLBkp
    If Check3.Value = 1 Then Call Save_MCX_ContractMaster
    If Check6.Value = 1 Then Call Save_All_BhavCopy("MCX")
    If ChkMCXExcelClosing.Value = 1 Then Call Save_All_BhavCopy("MCX")
    If Check11.Value = 1 Then Call MCX_Daily_Client_Margin
    If Check24.Value = 1 Then Trade_MCX_OnLBkp_ODIN
    If Check43.Value = 1 Then Call SAVE_MCX_DailyMargin
    If ChkMCXMarginFile.Value = 1 Then Call MCX_Margin
    LODIN = False
    'NSE
    If ChkNSESettleRate.Value = 1 Or ChkNSEBhavCopy = 1 Then Save_All_BhavCopy ("NSE")
    If ChkNSEBhavCopy.Value = 1 Then
       ChkNSERefLot.Value = 1
       ChkNSEBrokLot.Value = 1
    End If
    
    If ChkNSEExcelClosing.Value = 1 Then Call Save_All_BhavCopy("NSE")
    If ChkNSETrade.Value = 1 Then Call Save_Fut_Trade
    If Check48.Value = 1 Then Call PARTYBRKSHARE
    If ChkNSEAllTerminal.Value = 1 Then Call Fut_AllTerminal
    If ChkNSELotSize.Value = 1 Then Call SAVE_FO_Lot
    If (ChkNSERefLot.Value = 1 Or ChkNSEBrokLot.Value = 1) Then Call SAVE_FO_Lot
    If ChkNSECTCLONLine.Value = 1 Then Call Save_Fut_Trade_ExMain
    If ChkNSEEQTrade.Value = 1 Then Call Save_EQ_Trade
    If ChkNSEEQClosing.Value = 1 Then Call Save_All_BhavCopy("EQ")
    If Check38.Value = 1 Then Call Save_NSE_MARGIN_RATE
    'FX
    If ChkFXTrade.Value = 1 Or ChkFXCTCLOnLine.Value = 1 Then Call Trade_FX_TRADE
    If CHkFXClosing.Value = 1 Then Call Save_All_BhavCopy("FX")
    
    
    If ChkBEQTrade.Value = 1 Then Call Save_BSE_EQ_Trade
    If ChkBEQClosing.Value = 1 Then Call Save_All_BhavCopy("BEQ")
    If ChkBSEClosing.Value = 1 Then Call Save_All_BhavCopy("BSE")
    If Check4.Value = 1 Then Call Save_All_BhavCopy("BSEFX")
    
    If Check16.Value = 1 Then Call Save_DGCXTerminal
    'If Check15.Value = 1 Then Call Save_JTerminal
    If Check20.Value = 1 Then Save_ExcelOtc
    If Check21.Value = 1 Then Trade_FX_TRADE
    If Check35.Value = 1 Then Save_ExcelOtc15
    If Check19.Value = 1 Then SAVE_SGX_TRADE
    If Check22.Value = 1 Then Save_CME2Trade
    If Check25.Value = 1 Then Save_CMEFILE
    If Check26.Value = 1 Then Save_DGCXFile
    If Check27.Value = 1 Then Save_Vertex_Trade
    
    
    If Check33.Value = 1 Then Call Save_All_BhavCopy("DGCX")
    If Check34.Value = 1 Then Call Save_All_BhavCopy("CMX")
    If Check28.Value = 1 Then SAVE_DGCX_TRADE
    If Check32.Value = 1 Then SAVE_DGCX_USDINR_TRADE
    If Check29.Value = 1 Then Save_CME_Trader
    If Check23.Value = 1 Then Save_Open_Position
    If Check30.Value = 1 Then Save_CME_AllTrader
    If Check31.Value = 1 Then Save_Vertex_Trade2
    If Check15.Value = 1 Then
        LSExCode = "RACE"
        Call Get_ExDetail(LSExCode)
        'Call Save_AllTrade_Excel_1_39
    End If
    If Check42.Value = 1 Then
        LSExCode = "RACE"
        Call Save_Credit
    End If
    If Check44.Value = 1 Then
        LSExCode = "REAL"
        Call Save_Credit
    End If
    If Check40.Value = 1 Then
        LSExCode = "RACE"
        Call Save_Deposit
    End If
    If Check41.Value = 1 Then
        LSExCode = "REAL"
        Call Save_Deposit
    End If
    If Check45.Value = 1 Then Call Save_All_BhavCopy("REAL")
    If Check46.Value = 1 Then Call Save_All_BhavCopy("RACE")
    
    If Check37.Value = 1 Then
        LSExCode = "REAL"
        Call Get_ExDetail(LSExCode)
        'Call Save_AllTrade_Excel_1_39(25)
    End If
    
       
    If Check18.Value = 1 Then
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        mysql = "SELECT * FROM EXFILE WHERE COMPCODE =" & GCompCode & " "
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            LExcelFileType = Val(TRec!EXFILETYPE & vbNullString)
            LClientCode = TRec!CLIENTCODE & vbNullString
            LBrokerCode = TRec!CONTRACTACC
            LFolderName = TRec!FOLDERNAME
            LBrokerCode2 = (TRec!BROKER2 & vbNullString)
            If LExcelFileType > 50 Then
                Call Save_AllTrade_ExcelNew(LExcelFileType)
            ElseIf LExcelFileType = 38 Then
                LClientCode = TRec!CLIENTCODE & vbNullString
                Call Save_AllTrade_Excel38(LExcelFileType, LClientCode)
            Else
                Call Save_AllExFile(LExcelFileType)
            End If
            TRec.MoveNext
        Loop
        'Call Save_AllTrade_Excel(30)
    End If
    
    If Check39.Value = 1 Then
        mysql = "SELECT * FROM EXFILE WHERE COMPCODE =" & GCompCode & " AND EXCODE ='MCX'"
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            LExcelFileType = Val(TRec!EXFILETYPE & vbNullString)
            LClientCode = TRec!CLIENTCODE & vbNullString
            LBrokerCode = TRec!CONTRACTACC
            LFolderName = TRec!FOLDERNAME
            LBrokerCode2 = (TRec!BROKER2 & vbNullString)
            LPartyAs = TRec!PARTYAS
            LNEWPARTY = TRec!NewParty
            lqtylot = TRec!qtylot
            LBrokerType = (TRec!BROKERTYPE & vbNullString)
            If LExcelFileType = 0 Or LExcelFileType = 106 Then
                Call Trade_MCX_OnLBkp(LFolderName, LExcelFileType, LBrokerCode, LClientCode, LBrokerType)
                'Call Save_Fut_Trade(LFolderName)
            ElseIf LExcelFileType = 38 Then
                Call Save_AllTrade_Excel38(LExcelFileType, LClientCode, lqtylot)
            ElseIf LExcelFileType < 37 And LExcelFileType <> 36 Then
                Call Save_AllTrade_Excel_1_39(LExcelFileType, lqtylot)
            Else
                If LExcelFileType = 65 Or LExcelFileType = 66 Or LExcelFileType = 65 Or LExcelFileType = 67 Then
                    Save_All_MTrade_Excel (LExcelFileType)
                Else
                    If LExcelFileType >= 101 Or LExcelFileType = 36 Then
                        Call Save_AllTrade_Excel_101_201(LExcelFileType, LClientCode)
                    Else
                        Call Save_AllTrade_ExcelNew(LExcelFileType)
                    End If
                End If
            End If

            TRec.MoveNext
        Loop
    End If
    
    If Check47.Value = 1 Then
        mysql = "SELECT * FROM EXFILE WHERE COMPCODE =" & GCompCode & " AND EXCODE ='CMX'"
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            LExcelFileType = Val(TRec!EXFILETYPE & vbNullString)
            LClientCode = TRec!CLIENTCODE & vbNullString
            LBrokerCode = TRec!CONTRACTACC
            LFolderName = TRec!FOLDERNAME
            LBrokerCode2 = (TRec!BROKER2 & vbNullString)
            LPartyAs = TRec!PARTYAS
            LNEWPARTY = TRec!NewParty
            lqtylot = TRec!qtylot
            LBrokerType = (TRec!BROKERTYPE & vbNullString)
            
            Call Save_AllTrade_Excel_101_201(LExcelFileType, LClientCode)
            TRec.MoveNext
        Loop
    End If

    If Check36.Value = 1 Then
        LSExCode = "BSE"
        Call Get_ExDetail(LSExCode)
        
        Select Case LMemberId
        Case "15"
            Call Save_AllTrade_Excel_1_39(15)
        End Select
    End If
    If ChkNseExcel.Value = 1 Or Check10.Value = 1 Then
        mysql = "SELECT * FROM EXFILE WHERE COMPCODE =" & GCompCode & " AND EXCODE IN ('NSE','EQ')"
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            LExcelFileType = Val(TRec!EXFILETYPE & vbNullString)
            LClientCode = (TRec!CLIENTCODE & vbNullString)
            LBrokerCode = TRec!CONTRACTACC
            LFolderName = TRec!FOLDERNAME
            LBrokerCode2 = (TRec!BROKER2 & vbNullString)
            LBrokerType = (TRec!BROKERTYPE & vbNullString)
            LPartyAs = (TRec!PARTYAS & vbNullString)
            LNEWPARTY = TRec!NewParty
            If LPartyAs <> "F" Then
                LClientCode = ""
            End If
            If LExcelFileType < 37 Then
                Call Save_AllTrade_Excel_1_39(LExcelFileType)
            ElseIf LExcelFileType = 106 Then
                Call Save_Fut_Trade(LFolderName, LExcelFileType, LBrokerCode, LClientCode)
            ElseIf LExcelFileType = 140 Then
                Call Save_EQ_Trade(LFolderName, LExcelFileType, LBrokerCode, LClientCode)
                If Check10.Value = 1 Then
                    ChkNSEEQTrade = 1
                End If
            Else
                If LExcelFileType >= 101 Or LExcelFileType = 36 Then
                    Call Save_AllTrade_Excel_101_201(LExcelFileType, LClientCode)
                    If Check10.Value = 1 Then
                        ChkNSEEQTrade = 1
                    End If
                Else
                    Call Save_AllTrade_ExcelNew(LExcelFileType)
                End If
            End If
            TRec.MoveNext
        
        Loop
    End If
    MFromDate = vcDTP1.Value
    DoEvents: Label3.Caption = "Updating Brokerage -- Please Wait"
    LExIDS = vbNullString
    LBillExId = vbNullString
    
    'NCDX
    If Check1 = 1 Or Check8 = 1 Or Check5 = 1 Or ChkNCDXOnlineCTCL = 1 Or Check7 = 1 Or ChkNCDXAllTerminal = 1 Or Check13 = 1 Or Check9 = 1 Or Check39 = 1 Or CHKNCDXExcelClosing.Value = 1 Then
        LExIDS = str(Get_ExID("NCDX"))
        LBillExId = LExIDS & ","
    End If
    'MCX
    If Check2 = 1 Or Check12 = 1 Or Check6 = 1 Or Check17 = 1 Or Check24 = 1 Or Check43 = 1 Or Check11 = 1 Or Check4 = 1 Or Check3 = 1 Or Check39 = 1 Or RadioMCX.Value Or RadioNSE.Value Or RadioMN.Value Or ChkMCXExcelClosing.Value = 1 Then
        LExIDS = str(Get_ExID("MCX"))
        LBillExId = LBillExId + LExIDS & ","
        LExIDS = str(Get_ExID("CCMCX"))
        LBillExId = LBillExId + LExIDS & ","
    End If
    
    'NSE
    If ChkNseExcel = 1 Or RadioMCX.Value Or RadioNSE.Value Or RadioMN.Value Or Check38 = 1 Or Check39 = 1 Or ChkNSESettleRate Or ChkNSEBhavCopy = 1 Or ChkNSETrade = 1 Or ChkNSECTCLONLine = 1 Or ChkNSELotSize = 1 Or ChkNSEBrokLot = 1 Or ChkNSECTCLONLine = 1 Or ChkNSEAllTerminal.Value = 1 Or ChkNSEExcelClosing.Value = 1 Or ChkNSERefLot.Value = 1 Then
        LExIDS = str(Get_ExID("NSE"))
        LBillExId = LBillExId + LExIDS & ","
        LExIDS = str(Get_ExID("CMX"))
        LBillExId = LBillExId + LExIDS & ","
    End If
    'cmx
    If Check47 = 1 Then
        LExIDS = str(Get_ExID("CMX"))
        LBillExId = LBillExId + LExIDS & ","
    End If
    'EQ
    If ChkNSEEQTrade = 1 Or ChkNSEEQClosing = 1 Then
        LExIDS = str(Get_ExID("EQ"))
        LBillExId = LBillExId + LExIDS & ","
    End If
    'BSE
    If ChkBEQTrade = 1 Or ChkBEQClosing Or ChkFXCTCLOnLine = 1 Then
        LExIDS = str(Get_ExID("BEQ"))
        LBillExId = LBillExId + LExIDS & ","
    End If
    If Check4.Value = 1 Then
        LExIDS = str(Get_ExID("BSEFX"))
        LBillExId = LBillExId + LExIDS & ","
    End If
    'FX
    If ChkFXTrade = 1 Or CHkFXClosing Then
        LExIDS = str(Get_ExID("FX"))
        LBillExId = LBillExId + LExIDS & ","
    End If
    If Check35 = 1 Then
        LExIDS = str(Get_ExID("DGCX"))
        LBillExId = LBillExId + LExIDS & ","
        LExIDS = str(Get_ExID("CMX"))
        LBillExId = LBillExId + LExIDS & ","
    End If
    If ChkBSEClosing.Value = 1 Then
        LExIDS = str(Get_ExID("BSE"))
        LBillExId = LExIDS & ","
    End If
    LCNote = False
    If Len(LBillExId) > 0 Then
        LBillExId = Left(LBillExId, Len(LBillExId) - 1)
    End If
    
    If RadioMCX.Value Or RadioNSE.Value Or RadioMN.Value Then '>>> import live rate
        DoEvents
        Label3.Caption = "Live rate import..."
        DoEvents
        If GUniqClientId = "MAN-IND" Then
            If RadioMCX.Value Then
                Call Get_CLiveRate(vcDTP1.Value, "MCX", 0)
  
            ElseIf RadioNSE.Value Then
                Call Get_CLiveRate(vcDTP1.Value, "NSE", 0)
     
            ElseIf RadioMN.Value Then
                Call Get_CLiveRate(vcDTP1.Value, "BOTH", 0)
        
            End If
        Else
            If RadioMCX.Value Then
                Call Get_LiveRate(vcDTP1.Value, "MCX", 0)
                'RadioMCX.Value = False
            ElseIf RadioNSE.Value Then
                Call Get_LiveRate(vcDTP1.Value, "NSE", 0)
            '  RadioNSE.Value = False
            ElseIf RadioMN.Value Then
                Call Get_LiveRate(vcDTP1.Value, "BOTH", 0)
            '  RadioMN.Value = False
            End If
        End If
        If Weekday(vcDTP1.Value) = 1 Then
            FlagDataTrf = False
        Else
            FlagDataTrf = True
        End If
    End If
    
    
    If FlagDataTrf = True Then
                
        '>>> Order Execution start
            'Dim LTradeDt As Date
            'Dim LEXCHANGE As String
            'For LTradeDt = vcDTP1.Value To vcDTP2.Value
                '>>>  GET PENDING ORDERS IF ORDER RATE EXISTS BETWEEN CTR_R.HIGH & CTR_R.LOW RATE
             '   mysql = "EXEC ORDER_EXECUTION '" & Format(LTradeDt, "YYYY/MM/DD") & "'," & GCompCode & ",0,'Y'"
              '  Cnn.Execute mysql
           ' Next
        '>>> Order Execution end
                
        If ChkNseExcel.Value = 1 Then LExIDS = vbNullString
        If Check1.Value = 1 Or ChkNCDXOnlineCTCL.Value = 1 Or ChkNCDXAllTerminal.Value = 1 Or Check2.Value = 1 Or Check24.Value = 1 Or Check17.Value = 1 Or ChkNSETrade.Value = 1 Then
            LCNote = True
        End If
        
        If Check1.Value = 1 Or Check5.Value = 1 Or Check6.Value = 1 Or CHKNCDXExcelClosing.Value = 1 Or ChkNCDXOnlineCTCL.Value = 1 Or ChkNCDXAllTerminal.Value = 1 Or Check2.Value = 1 Or Check24.Value = 1 _
        Or Check17.Value = 1 Or Check39.Value = 1 Or ChkMCXExcelClosing.Value = 1 Or ChkNSETrade.Value = 1 Or ChkNSESettleRate.Value = 1 Or ChkNSEAllTerminal.Value = 1 Or ChkNSECTCLONLine.Value = 1 Or ChkNSEBhavCopy.Value = 1 _
        Or ChkNSEExcelClosing Or ChkNseExcel.Value = 1 Or ChkBSETrade.Value = 1 Or ChkBSEClosing.Value = 1 Or ChkBEQTrade.Value = 1 Or ChkBEQClosing.Value = 1 Or Check36.Value = 1 Or Check35.Value = 1 _
        Or ChkNSEEQTrade.Value = 1 Or ChkNSEEQClosing.Value = 1 Then
            If ChkRate.Value = 1 Then Call RATE_TEST(lminbilldate, LBillExId, , frmdata)
        End If
        DoEvents
        If Check39 = 1 Or Check47 = 1 Or Check9.Value = 1 Or Check7.Value = 1 Or Check43.Value = 1 Or Check11.Value = 1 Or Check1.Value = 1 Or ChkNCDXOnlineCTCL.Value = 1 Or ChkNCDXAllTerminal = 1 Or Check2.Value = 1 Or Check24.Value = 1 Or Check17.Value = 1 Or Check39 = 1 Or ChkNSETrade.Value = 1 Or ChkNSECTCLONLine.Value = 1 Or ChkNSEEQTrade = 1 Or ChkBEQTrade.Value = 1 Or ChkFXTrade.Value = 1 Or ChkNSEAllTerminal.Value = 1 Or ChkNSEBrokLot.Value = 1 Or ChkNseExcel = 1 Or Check38.Value = 1 Or Check18.Value = 1 Or Check10.Value = 1 Or Check35.Value = 1 Then
           Cnn.BeginTrans
           CNNERR = True
            If LBrokerType = "T" Then
                Call Update_Charges(vbNullString, LBillExId, vbNullString, vbNullString, lminbilldate, GFinEnd, LCNote)
            Else
                Call Update_Charges(vbNullString, LBillExId, vbNullString, vbNullString, lminbilldate, GFinEnd, LCNote)
                DoEvents
            End If
            Cnn.CommitTrans
            CNNERR = False
        End If
        LBillParties = vbNullString
        If LenB(LBillExId) < 1 Then
            MsgBox "Please Check Exchnage Code "
            Exit Sub
        End If
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        mysql = "SELECT DISTINCT PARTY FROM CTR_D WHERE EXID IN (" & LBillExId & ") "
        mysql = mysql & " AND SAUDAID IN (SELECT DISTINCT SAUDAID FROM SAUDAMAST WHERE EXID IN ( " & LBillExId & " ) AND MATURITY>='" & Format(lminbilldate, "YYYY/MM/DD") & "')"
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            If LenB(LBillParties) > 0 Then LBillParties = LBillParties & ","
            LBillParties = LBillParties & "'" & TRec!PARTY & "'"
            TRec.MoveNext
        Loop
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        mysql = "SELECT DISTINCT PARTY FROM INV_D  WHERE EXID IN (" & LBillExId & ") "
        mysql = mysql & " AND SAUDAID IN (SELECT DISTINCT SAUDAID FROM SAUDAMAST WHERE EXID IN ( " & LBillExId & " ) AND MATURITY>='" & Format(lminbilldate, "YYYY/MM/DD") & "')"
        If LenB(LBillParties) > 0 Then mysql = mysql & " AND PARTY NOT IN (" & LBillParties & ")"
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            If LenB(LBillParties) > 0 Then LBillParties = LBillParties & ","
            LBillParties = LBillParties & "'" & TRec!PARTY & "'"
            TRec.MoveNext
        Loop
        If LBrokerType = "T" Then LEXCHANGE = vbNullString
        
        
        If Check1.Value = 1 Or Check5.Value = 1 Or Check6.Value = 1 Or CHKNCDXExcelClosing.Value = 1 Or ChkNCDXOnlineCTCL.Value = 1 Or ChkNCDXAllTerminal.Value = 1 Or Check2.Value = 1 Or Check24.Value = 1 _
        Or Check17.Value = 1 Or Check39.Value = 1 Or ChkMCXExcelClosing.Value = 1 Or ChkNSETrade.Value = 1 Or ChkNSESettleRate.Value = 1 Or ChkNSEAllTerminal.Value = 1 Or ChkNSECTCLONLine.Value = 1 Or ChkNSEBhavCopy.Value = 1 _
        Or ChkNSEExcelClosing Or ChkNseExcel.Value = 1 Or ChkBSETrade.Value = 1 Or ChkBSEClosing.Value = 1 Or ChkBEQTrade.Value = 1 Or ChkBEQClosing.Value = 1 Or Check36.Value = 1 _
        Or ChkNSEEQTrade.Value = 1 Or ChkNSEEQClosing.Value = 1 Or Check29.Value = 1 Or Check34.Value = 1 Or Check28.Value = 1 Or Check15.Value = 1 Or Check22.Value = 1 Or Check19.Value = 1 _
        Or Check33.Value = 1 Or Check37.Value = 1 Or Check20.Value = 1 Or Check26.Value = 1 Or Check46.Value = 1 Or Check45.Value = 1 Or Check25.Value = 1 Or Check31.Value = 1 Or Check32.Value = 1 _
        Or Check35.Value = 1 Or Check27.Value = 1 Or Check16.Value = 1 Or Check18.Value = 1 Or RadioMCX.Value Or RadioNSE.Value Or RadioMN.Value Then
                DoEvents: Cnn.BeginTrans
            
                If BILL_GENERATION(lminbilldate, GFinEnd, vbNullString, LBillParties, LBillExId) Then
                    Cnn.CommitTrans
                    CNNERR = False
                Else
                    Cnn.RollbackTrans
                    CNNERR = False
                End If
        End If
        'Call Chk_Billing
        CNNERR = False
    End If
        
    
    
    Label3.Caption = vbNullString
    
    '>>>  - 17 JAN 2021 -- Bhavcopy download if not exists -- STARTUK
    If Not FlagLoggedIn Then
        MsgBox "Data Import Completed.", vbInformation
    Else
        Dim VFiledownload As Boolean
        Dim Vdate As String
        Dim Vdate1 As String
        Dim filedate As Date
        
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        
'
'        If Len(month(Date - 1)) = 1 Then
'            Vdate = "0" & month(Date - 1)
'        Else
'            Vdate = month(Date - 1)
'        End If
'        If Len(Day(Date - 1)) = 1 Then
'            Vdate = Vdate & "-" & "0" & Day(Date - 1)
'        Else
'            Vdate = Vdate & "-" & Day(Date - 1)
'        End If
'        Vdate = Vdate & "-" & Year(Date - 1)
'
'        Vdate1 = Year(Date - 1)
'        If Len(month(Date - 1)) = 1 Then
'            Vdate1 = Vdate1 & "0" & month(Date - 1)
'        Else
'            Vdate1 = Vdate1 & month(Date - 1)
'        End If
'        If Len(Day(Date - 1)) = 1 Then
'            Vdate1 = Vdate1 & "0" & Day(Date - 1)
'        Else
'            Vdate1 = Vdate1 & Day(Date - 1)
'        End If
                    
        Dim ERec As ADODB.Recordset
        Dim LFileName As String
        
        Weekdy = Weekday(Date)
        If Weekdy = 1 Then 'Sunday
            filedate = Date - 2 '>> file of Friday
        ElseIf Weekdy = 7 Then 'Saturday
            filedate = Date - 1  '>> file of Friday
        ElseIf Weekdy = 2 Then 'Monday
            filedate = Date - 3  '>> file of Friday
        Else
            filedate = Date - 1
        End If
                
        If Len(month(filedate)) = 1 Then
            Vdate = "0" & month(filedate)
        Else
            Vdate = month(filedate)
        End If
        If Len(Day(filedate)) = 1 Then
            Vdate = Vdate & "-" & "0" & Day(filedate)
        Else
            Vdate = Vdate & "-" & Day(filedate)
        End If
        Vdate = Vdate & "-" & Year(filedate)
        
        Vdate1 = Year(filedate)
        If Len(month(filedate)) = 1 Then
            Vdate1 = Vdate1 & "0" & month(filedate)
        Else
            Vdate1 = Vdate1 & month(filedate)
        End If
        If Len(Day(filedate)) = 1 Then
            Vdate1 = Vdate1 & "0" & Day(filedate)
        Else
            Vdate1 = Vdate1 & Day(filedate)
        End If
        
        mysql = "select excode from EXMAST where COMPCODE =" & GCompCode & " and excode in ('NSE', 'NCDX','EQ', 'MCX') order by excode"
        Set ERec = Nothing
        Set ERec = New ADODB.Recordset
        ERec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        While Not ERec.EOF
            If InStr(1, GEXCODE, ERec("excode")) = 0 Then
                GEXCODE = GEXCODE & "," & ERec("excode")
'                If ERec("excode") = "EQ" Then
'                    LFileName = App.Path & "\" & ERec("excode") & "\" & "cm" & CStr(Left$((Date - 1), 2)) & UCase(Left$(MonthName(Val(month((Date - 1)))), 3)) & CStr(Year((Date - 1))) & "bhav.csv.zip"
'                ElseIf ERec("excode") = "NCDX" Then
'                    LFileName = App.Path & "\" & ERec("excode") & "\" & "FO_" & CStr(Left((Date - 1), 2)) & CStr(month((Date - 1))) & Right(CStr(Year((Date - 1))), 2) & "_FINAL.CSV"
'                ElseIf ERec("excode") = "NSE" Then
'                    LFileName = App.Path & "\" & ERec("excode") & "\" & "fo" & CStr(Left$((Date - 1), 2)) & UCase(Left$(MonthName(Val(month(Date - 1))), 3)) & Year(Date - 1) & "bhav.csv"
'                ElseIf ERec("excode") = "MCX" Then
'                    LFileName = App.Path & "\" & ERec("excode") & "\" & "MCX_MS" & Vdate1 & ".csv"
'                End If


                '>>> create folder if not exists
                If Not LFileSystemObject.FolderExists(App.Path & "\" & ERec("excode")) Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & ERec("excode"))
                End If
                        
                If ERec("excode") = "EQ" Then
                    LFileName = App.Path & "\" & ERec("excode") & "\" & "cm" & CStr(Left$((filedate), 2)) & UCase(Left$(MonthName(Val(month((filedate)))), 3)) & CStr(Year((filedate))) & "bhav.csv.zip"
                ElseIf ERec("excode") = "NCDX" Then
                    LFileName = App.Path & "\" & ERec("excode") & "\" & "FO_" & CStr(Left((filedate), 2)) & CStr(month((filedate))) & Right(CStr(Year((filedate))), 2) & "_FINAL.CSV"
                ElseIf ERec("excode") = "NSE" Then
                    LFileName = App.Path & "\" & ERec("excode") & "\" & "fo" & CStr(Left$((filedate), 2)) & UCase(Left$(MonthName(Val(month(filedate))), 3)) & Year(filedate) & "bhav.csv"
                ElseIf ERec("excode") = "MCX" Then
                    LFileName = App.Path & "\" & ERec("excode") & "\" & "MCX_MS" & Vdate1 & ".csv"
                End If
                
                'If ((Not FileExist(LFileName)) Or (FileExist(LFileName) And GExCode = "MCX")) Then
                If Not FileExist(LFileName) Then
'                    If Weekdy > 2 And Weekdy < 7 Then
'                        vcDTP1.Value = Date - 1
'                        vcDTP2.Value = Date - 1
'                    ElseIf Weekdy = 2 Then 'if Monday -- Get date of last Friday
'                        vcDTP1.Value = Date - 3
'                        vcDTP2.Value = Date - 3
'                    End If
                    vcDTP1.Value = filedate
                    vcDTP2.Value = filedate
                        
                    ChkNSEBhavCopy.Value = 0
                    CHKNCDXExcelClosing.Value = 0
                    If ERec("excode") = "NCDX" Or ERec("excode") = "EQ" Then
                        CHKNCDXExcelClosing.Value = 1
                    ElseIf ERec("excode") = "NSE" Then
                        ChkNSEBhavCopy.Value = 1
                    ElseIf ERec("excode") = "MCX" Then
                        '>>> create folder if not exists
                        If Not LFileSystemObject.FolderExists(App.Path & "\MCX") Then
                            LFileSystemObject.CreateFolder (App.Path & "\" & ERec("excode"))
                        End If
                        VFiledownload = DownloadFile("http://178.33.73.246/mcxbhavcopy.aspx?date=" & Vdate, App.Path & "\" & "MCX\MCX_MS" & Vdate1 & ".csv")
                        DoEvents
                        If Not VFiledownload Then
                            VFiledownload = DownloadFile("http://178.33.73.246/mcxbhavcopy.aspx?date=" & Vdate, App.Path & "\" & "MCX\MCX_MS" & Vdate1 & ".csv")
                            DoEvents
                        End If
                        frmdata.Check6.Value = 1
                    End If
                    frmdata.Label10.Caption = frmdata.Label10.Caption + " -- " & GEXCODE
                    
                    If (ERec("excode") = "MCX" And VFiledownload) Or (ERec("excode") <> "MCX") Then
                        Call okcmdclick
                    End If
                End If
            End If
            ERec.MoveNext
        Wend
    End If
    '>>>  - 17 JAN 2021 -- Bhavcopy download if not exists -- ENDUK
    
    If LMsgBox <> "" Then
        Frame8.Visible = True
        List1.Visible = True
    End If
    
FlagEnd:
    Dim oj As Object
    For Each oj In Me
        If TypeOf oj Is CheckBox Then
            oj.Value = 0
        End If
    Next
    Call UnLock_Screen
    Text1.text = vbNullString
    TxtQtyMultipler.text = "0.00"
    Screen.MousePointer = 0:
    '>>>  - 17 JAN 2021 -- Bhavcopy download if not exists -- STARTUK
    If FlagLoggedIn Then
        'MenuOpt.Show
        MenuOptfrm.Show
        Unload Me
    End If
    '>>>  - 17 JAN 2021 -- Bhavcopy download if not exists -- ENDUK
End Sub

Private Sub cmdspecial_Click()
    frmstartprocess.Show
End Sub

Private Sub Command1_Click()
    Frame8.Visible = False
    OkCmd.SetFocus
End Sub
Sub DownloadMCXfile()
    Dim url As String
    Dim filePath As String
    Dim USERNAME As String
    Dim PASSWORD As String
    
    

'https://sftp.mcxindia.com 'user mcxftp 'pass Mcx@1234
'filePath=


    ' Set the URL of the file you want to download
    'url = "https://www.example.com/file.txt"
    url = "https://sftp.mcxindia.com/Common/Bhavcopy/APR-2023 to MARCH-2024/june/MCX_MS220230613.csv"
    
    ' Set the local file path where you want to save the downloaded file
    'filePath = "C:\Downloaded\file.txt"
    filePath = "D:\saudacode\ujjwal\MCX_MS220230613.csv"
    
    ' Set the username and password
    USERNAME = "mcxftp"
    PASSWORD = "Mcx@1234"
    
    ' Download the file
    If DownloadFileFromHTTPS(url, filePath, USERNAME, PASSWORD) Then
        MsgBox "File downloaded successfully."
    Else
        MsgBox "Failed to download the file."
    End If
End Sub
Private Sub Command3_Click()
    Call DownloadMCXfile
End Sub

Public Sub OkCmd_Click()
    List1.Clear
    Call okcmdclick
End Sub
Private Sub Command2_Click()
    Unload Me
End Sub
Private Sub Form_KeyUp(KeyCode As Integer, Shift As Integer)
    If KeyCode = 13 Then Sendkeys "{TAB}"
End Sub
Private Sub Form_Load()
    
    ChkRate.Value = 1
    vcDTP2.MaxDate = GFinEnd:
    vcDTP2.MinDate = GFinBegin
    vcDTP1.MinDate = GFinBegin:
    vcDTP1.MaxDate = GFinEnd:
    vcDTP1.Value = Date
    vcDTP2.Value = Date
    'Frame2.BackColor = Frame2.BackColor
    Dim TRec As ADODB.Recordset:
    If GSysLockDt >= GFinBegin Then
        vcDTP2.MinDate = GSysLockDt + 1
        vcDTP1.MinDate = GSysLockDt + 1
    End If
    If GUniqClientId = "2582KOH" Then
        cmdspecial.Visible = True
    End If
    SaudaTrade = False:    vcDTP1.Value = Date: vcDTP2.Value = Date:    Check14.Value = 0:
    TxtQtyMultipler.text = "0.00"
    Label5.Visible = False: Frame3.Visible = False: Label6.Visible = False: Frame4.Visible = False: Label8.Visible = False: Frame5.Visible = False: Label4.Visible = False: Frame9.Visible = False
    Label9(5).Visible = False: Frame14.Visible = False: Label15.Visible = False: Frame15.Visible = False:   Label9(7).Visible = False: Frame17.Visible = False
    mysql = "SELECT EXCODE,TRADE,CLOSING,MARGINRATE,MARGINFILE,ONLINECTCL,ONLINECTCLODIN,CONTRACTMASTER,BANKFILE,ALLTERMINAL,REMARK,BANKFILE,SAUDATRADE FROM EXMAST WHERE COMPCODE =" & GCompCode & " ORDER BY EXCODE "
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    Do While Not TRec.EOF
        If TRec!excode = "NCDX" Then
            Frame3.Visible = True: Label5.Visible = True
            Check1.Visible = False:                 Check5.Visible = False
            Check7.Visible = False:                 Check8.Visible = False
            Check9.Visible = False:
            Check13.Visible = False:                ChkNCDXOnlineCTCL.Visible = False
            ChkNCDXAllTerminal.Visible = False:     CHKNCDXExcelClosing.Visible = False
            
            If TRec!trade = "Y" Then Check1.Visible = True
            
            '>>> If TRec!CLOSING = "Y" Then Check5.Visible = True  '>>> 18 Mar. 2021
            
            If TRec!CLOSING = "Y" Then CHKNCDXExcelClosing.Visible = True
            If TRec!MarginRate = "Y" Then Check7.Visible = True
            If TRec!MarginFile = "Y" Then Check9.Visible = True
            If TRec!OnlineCTCL = "Y" Then ChkNCDXOnlineCTCL.Visible = True
            If TRec!BankFile = "Y" Then Check13.Visible = True
            If TRec!AllTerminal = "Y" Then ChkNCDXAllTerminal.Visible = True
            If TRec!Remark = "Y" Then Check8.Visible = True
        ElseIf TRec!excode = "CMX" Then
            If TRec!SaudaTrade = "Y" Then Check47.Visible = True
            Frame9.Visible = True: Label4.Visible = True:
            CHkFXClosing.Visible = True
            ChkFXCTCLOnLine.Visible = False
            ChkFXTrade.Visible = False
            Check21.Visible = False
        ElseIf TRec!excode = "MCX" Then
            Frame4.Visible = True: Label6.Visible = True
            Check2.Visible = False:            Check3.Visible = False
            Check6.Visible = False:            Check11.Visible = False
            Check12.Visible = False:           Check13.Visible = False
            Check17.Visible = False:           Check24.Visible = False
            Check39.Visible = False:           Check43.Visible = False
                
            If TRec!trade = "Y" Then Check2.Visible = True
            If TRec!CLOSING = "Y" Then Check6.Visible = True
            If TRec!MarginRate = "Y" Then Check43.Visible = True
            If TRec!MarginFile = "Y" Then Check11.Visible = True
            If TRec!OnlineCTCL = "Y" Then Check24.Visible = True
            If TRec!ContractMaster = "Y" Then Check3.Visible = True
            If TRec!BankFile = "Y" Then Check13.Visible = True
            If TRec!AllTerminal = "Y" Then Check17.Visible = True
            If TRec!Remark = "Y" Then Check12.Visible = True
            If TRec!SaudaTrade = "Y" Then Check39.Visible = True
        ElseIf TRec!excode = "FX" Then
            Frame9.Visible = True: Label4.Visible = True:           ChkFXTrade.Visible = False
            CHkFXClosing.Visible = False:     ChkFXCTCLOnLine.Visible = False
            
            If TRec!trade = "Y" Then ChkFXTrade.Visible = True
            If TRec!CLOSING = "Y" Then CHkFXClosing.Visible = True
            If TRec!OnlineCTCL = "Y" Then ChkFXCTCLOnLine.Visible = True
        ElseIf TRec!excode = "NSE" Then
            Frame5.Visible = True: Label8.Visible = True
            ChkNSETrade.Visible = False
            ChkNSESettleRate.Visible = False
            ChkNSEBhavCopy.Visible = False
            Check38.Visible = True
            ChkNSELotSize.Visible = True
            ChkNSEBrokLot.Visible = True
            ChkNSERefLot.Visible = True
            ChkNSECTCLONLine.Visible = False
            CHKFutureRemark.Visible = False
            ChkNSEAllTerminal.Visible = False
            
            If TRec!trade = "Y" Then ChkNSETrade.Visible = True
            If TRec!CLOSING = "Y" Then ChkNSESettleRate.Visible = True
            If TRec!CLOSING = "Y" Then ChkNSEBhavCopy.Visible = True
            If TRec!OnlineCTCL = "Y" Then ChkNSECTCLONLine.Visible = True
            If TRec!Remark = "Y" Then CHKFutureRemark.Visible = True
            If TRec!AllTerminal = "Y" Then ChkNSEAllTerminal.Visible = True
            
        ElseIf TRec!excode = "BSE" Or TRec!excode = "BSEFX" Then
            Frame17.Visible = True: Label9(7).Visible = True
            ChkBSETrade.Visible = False
            ChkBSEClosing.Visible = False
            Check4.Visible = False
            
            If TRec!trade = "Y" Then ChkBSETrade.Visible = True
            If TRec!CLOSING = "Y" Then ChkBSEClosing.Visible = True
            If TRec!CLOSING = "Y" Then Check4.Visible = True
            
        ElseIf TRec!excode = "BEQ" Then
             Frame15.Visible = True: Label15.Visible = True
             ChkBEQTrade.Visible = False
             ChkBEQClosing.Visible = False
             Label15.Visible = True
             If TRec!trade = "Y" Then ChkBEQTrade.Visible = True
             If TRec!CLOSING = "Y" Then ChkBEQClosing.Visible = True
            
        ElseIf TRec!excode = "EQ" Then
            Frame14.Visible = True: Label9(5).Visible = True
            ChkNSEEQTrade.Visible = False
            ChkNSEEQClosing.Visible = False
            chkEquityRemark.Visible = False
            If TRec!trade = "Y" Then ChkNSEEQTrade.Visible = True
            If TRec!CLOSING = "Y" Then ChkNSEEQClosing.Visible = True
            If TRec!Remark = "Y" Then chkEquityRemark.Visible = True
        ElseIf TRec!excode = "DGCX" Or TRec!excode = "LME" Or TRec!excode = "XSGE" Or TRec!excode = "RACE" Or TRec!excode = "REAL" Then
            Set AccRec = Nothing
            Text1.text = vbNullString
            Set AccRec = New ADODB.Recordset
            mysql = "SELECT AC_CODE,NAME FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & "  ORDER BY NAME "
            AccRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            
            Set BrokerCombo.RowSource = AccRec
            BrokerCombo.ListField = "NAME"
            BrokerCombo.BoundColumn = "AC_CODE"
            
            Set ClientCombo.RowSource = AccRec
            ClientCombo.ListField = "NAME"
            ClientCombo.BoundColumn = "AC_CODE"
            
            Frame6.Visible = True: Label11.Visible = True
        End If
        TRec.MoveNext
    Loop
    Set TRec = Nothing
    
    If FlagLiveRate = "Y" Then '>>> 18 Mar. 2021
        RadioMN.Visible = True
        RadioMCX.Visible = True
        RadioNSE.Visible = True
    Else
        RadioMN.Visible = False
        RadioMCX.Visible = False
        RadioNSE.Visible = False
    End If
    
End Sub
Private Sub Form_Unload(Cancel As Integer)
        Set TxtRec = Nothing
        Set Jcnn = Nothing
        Unload Me
End Sub
Sub Trade_Ncdex_OnLBkp()
    Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim LFolderName As String
    Dim TxtPath As String:          Dim LFileName As String:        Dim LMFLPath As String
    Dim TRec As ADODB.Recordset
        
    LSExCode = "NCDX"
    On Error GoTo err
    Call GET_JCnn("\NCDX;")
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    CNNERR = True
    LOverwrite = IIf(Check14 = 1, False, True)
                        
    Cnn.BeginTrans
    For ltradedt = vcDTP1.Value To vcDTP2.Value
       If ChkNCDXAllTerminal.Value = 0 Then
            Select Case UCase(LBrokerType)
                Case "M"
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & IIf(LMemberId = "", "", "_" & LMemberId) & ".TXT"
                Case "E"
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                Case Else
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
            End Select
                        
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\NCDX") Then
                LFileSystemObject.CreateFolder (App.Path & "\NCDX")
            End If
            Set LFileSystemObject = Nothing
            
            LFileName = App.Path & "\NCDX\" & TxtPath
            LMFLPath = App.Path & "\NCDX\"
            If Not FileExist(LFileName) Then
                LMsgBox = LFileName & "  file not found" ', vbCritical
                ImportIssues (LMsgBox)
            Else
                If LBrokerType = "X" Then
                    Call Create_SchemaFile_Nextra(LMFLPath, TxtPath)
                Else
                    Call Create_SchemaFile(LMFLPath, TxtPath)
                End If
                Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                Call Save_NCDEX_Trade(LOverwrite)
            End If
        Else
            If MsgBox("Do you want to delete all trade of" & ltradedt & "", vbYesNo) = vbYes Then
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND DATAIMPORT =1 AND EXCODE ='NCDX' AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "'"
                Cnn.Execute mysql
            End If
            TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
            
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\NCDX") Then
                LFileSystemObject.CreateFolder (App.Path & "\NCDX")
            End If
            Set LFileSystemObject = Nothing
            
            LFileName = App.Path & "\NCDX\" & TxtPath
            LMFLPath = App.Path & "\NCDX\"
            If Not FileExist(LFileName) Then
                LMsgBox = LFileName & " File Not Found"
                ImportIssues (LMsgBox)
            Else
                Call Create_SchemaFile(LMFLPath, TxtPath)
                If LBrokerType = "X" Then
                    Call Create_SchemaFile_Nextra(LMFLPath, TxtPath)
                Else
                    Call Create_SchemaFile(LMFLPath, TxtPath)
                End If
                Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                Call Save_NCDEX_Trade(LOverwrite)
            End If
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                mysql = "SELECT FOLDERNAME,CONTRACTACC,BROKERTYPE,PARTYAS,CLIENTCODE FROM EXFILE WHERE COMPCODE =" & GCompCode & " AND EXCODE='NCDX' ORDER BY FILEID "
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                Do While Not TRec.EOF
                    LClientCode = vbNullString
                    LExCont = TRec!CONTRACTACC
                    LBrokerType = TRec!BROKERTYPE
                    LFolderName = TRec!FOLDERNAME
                    LPartyAs = TRec!PARTYAS
                    If LPartyAs = "F" Then LClientCode = TRec!CLIENTCODE
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
                    Call GET_JCnn("\" & LFolderName & "\;")
                    
                    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
                        LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
                    End If
                    Set LFileSystemObject = Nothing
                    
                    LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
                    If Not FileExist(LFileName) Then
                        LMsgBox = LFileName & "  file not found" ', vbCritical
                        ImportIssues (LMsgBox)
                    Else
                        If LBrokerType = "X" Then
                            Call Create_SchemaFile_Nextra(LMFLPath, TxtPath)
                        Else
                            Call Create_SchemaFile(LMFLPath, TxtPath)
                        End If
                        LOverwrite = False
                        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                        Call Save_NCDEX_Trade(False)
                    End If
                    TRec.MoveNext
                Loop
            End If
    Next ltradedt
    Cnn.CommitTrans
    Set Jcnn = Nothing
    CNNERR = False
    Exit Sub
err:
    If err.Number <> 0 Then
        MsgBox err.Description
    End If
    If CNNERR = True Then
        Cnn.RollbackTrans
    End If
End Sub
Sub Trade_MCX_OnLBkp(Optional PFOLDERNAME As String, Optional LExcelFileType As Integer, Optional lLBrokerCode As String, Optional lclientid As String, Optional llbrokertype As String)

    Dim LOverwrite  As Boolean:     Dim ltradedt As Date:       Dim TxtPath As String
    Dim LFileName As String:        Dim LMFLPath As String:     Dim TRec As ADODB.Recordset
    Dim LFolderName As String

    LSExCode = "MCX"

    If Len(PFOLDERNAME) = 0 Then
        LBrokerType = ""
        Call GET_JCnn("\MCX;")
        Call Get_ExDetail(LSExCode)
    Else
        LBrokerCode = lLBrokerCode
        LBrokerType = llbrokertype
        Call GET_JCnn("\" & PFOLDERNAME & "\;")
        ltradedt = vcDTP1.Value
        LExCont = LBrokerCode
    End If
    LFolderName = PFOLDERNAME
    If LenB(LExCont) = 0 Then Exit Sub
    LOverwrite = IIf(Check14 = 1, False, True)
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If Check2.Value = 1 Or Check24.Value = 1 Or LExcelFileType = 106 Then
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & ""
            Select Case UCase(LBrokerType)
                Case "M"
                    TxtPath = "MCX_TRD" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".CSV"
                    mysql = "Select * from " & TxtPath & ""
                Case "I"
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                    mysql = "Select * from " & TxtPath & " "
                Case "D"
                    TxtPath = "TRD" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                    mysql = "Select * from " & TxtPath & " WHERE LEN(F9)=2 "
                Case "S"
                    TxtPath = "MCX_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "TRD.TXT"
                    mysql = "Select * from " & TxtPath & " "
                Case "A"
                    TxtPath = "MCX_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "TRD.TXT"
                    mysql = "Select * from " & TxtPath & " "
                Case "T"
                    TxtPath = "TRADE" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right$(CStr(Year(ltradedt)), 2) & ".CSV"
                    mysql = " SELECT * from " & TxtPath & " WHERE ( UCASE(F5)='BUY'OR UCASE(F5)='SELL')"
                Case "X"
                    TxtPath = "MCX_TRD" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".CSV"
                    mysql = "Select * from " & TxtPath & " "
                Case "C"
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
                    mysql = "Select * from " & TxtPath & " "
                Case "O"
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
                    mysql = "Select * from " & TxtPath & " "
                Case "N"
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                    mysql = " SELECT * from " & TxtPath & " WHERE F7='FUTCOM'"
                Case "E"
                    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                    mysql = "Select * from " & TxtPath & " "
            End Select
            If Check24.Value = 1 Then TxtPath = "TRD" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".CSV"
            
            
            If UCase(LBrokerType) <> "E" Then
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\MCX") Then
                    LFileSystemObject.CreateFolder (App.Path & "\MCX")
                End If
                Set LFileSystemObject = Nothing
                If Len(PFOLDERNAME) > 0 Then
                    LFileName = App.Path & "\" & PFOLDERNAME & "\" & TxtPath
                    LMFLPath = App.Path & "\" & PFOLDERNAME & "\"
                Else
                    LFileName = App.Path & "\MCX\" & TxtPath
                    LMFLPath = App.Path & "\MCX\"
                End If
            Else
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\TRADE") Then
                    LFileSystemObject.CreateFolder (App.Path & "\TRADE")
                End If
                Set LFileSystemObject = Nothing
                    
                LFileName = App.Path & "\TRADE\" & TxtPath
                LMFLPath = App.Path & "\TRADE\"
            End If
            If Not FileExist(LFileName) Then
                LMsgBox = LFileName & "  file not found" ', vbCritical
                ImportIssues (LMsgBox)
            Else
                Call Create_SchemaFileMCX(LMFLPath, TxtPath)
                TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText

                Call Save_MCX_Trade(LOverwrite, ltradedt, LFolderName, LExcelFileType, lLBrokerCode, lclientid, llbrokertype)
            End If
        Else
            If Check17.Value = 1 Then
                If MsgBox("Are you Sure to Delete Trades of MCX All terminals " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND EXCODE ='MCX' AND DATAIMPORT=1 AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "'"
                    Cnn.Execute mysql
                End If
                Select Case LBrokerType
                    Case "M"
                        TxtPath = "TRD" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & "TXT"
                    Case "S"
                        TxtPath = "MCX_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "TRD.TXT"
                    Case "E"
                        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                    Case Else
                        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
                End Select
                If UCase(LBrokerType) <> "E" Then
                    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    If Not LFileSystemObject.FolderExists(App.Path & "\MCX") Then
                        LFileSystemObject.CreateFolder (App.Path & "\MCX")
                    End If
                    Set LFileSystemObject = Nothing
                    
                    LFileName = App.Path & "\MCX\" & TxtPath
                    LMFLPath = App.Path & "\MCX\"
                Else
                    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    If Not LFileSystemObject.FolderExists(App.Path & "\TRADE") Then
                        LFileSystemObject.CreateFolder (App.Path & "\TRADE")
                    End If
                    Set LFileSystemObject = Nothing
                    
                    LFileName = App.Path & "\TRADE\" & TxtPath
                    LMFLPath = App.Path & "\TRADE\"
                    Call GET_JCnn("\TRADE;")
                End If
                If Not FileExist(LFileName) Then
                    LMsgBox = LFileName & "  file not found" ', vbCritical
                    ImportIssues (LMsgBox)
                Else
                    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                    TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                    Call Save_MCX_Trade(LOverwrite, ltradedt)
                End If
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                mysql = "SELECT FOLDERNAME,CONTRACTACC,BROKERTYPE,PARTYAS,CLIENTCODE,EXFILETYPE FROM EXFILE WHERE COMPCODE =" & GCompCode & " AND EXCODE='MCX' ORDER BY FILEID "
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                Do While Not TRec.EOF
                    LClientCode = vbNullString
                    LExCont = TRec!CONTRACTACC
                    LBrokerType = TRec!BROKERTYPE
                    LFolderName = TRec!FOLDERNAME
                    GExFileType = Val(TRec!EXFILETYPE & vbNullString)
                    LPartyAs = TRec!PARTYAS
                    If LPartyAs = "F" Then
                        LClientCode = TRec!CLIENTCODE
                    End If
                    Select Case LBrokerType
                    Case "M"
                        TxtPath = "TRD" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & "TXT"
                    Case "S"
                        TxtPath = "MCX_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "TRD.TXT"
                    Case "E"
                        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                    Case Else
                        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
                    End Select
                    Call GET_JCnn("\" & LFolderName & "\;")
                    
                    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
                        LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
                    End If
                    Set LFileSystemObject = Nothing
                    
                    LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
                    If Not FileExist(LFileName) Then
                        LMsgBox = LFileName & "  file not found" ', vbCritical
                        ImportIssues (LMsgBox)
                    Else
                        LOverwrite = False
                        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                        Call Save_MCX_Trade(LOverwrite, ltradedt)
                    End If
                    TRec.MoveNext
                Loop
                
            End If
        End If
        Next ltradedt
        Set Jcnn = Nothing
    End Sub
Sub SAVE_NCDEX_DlyMgn()
    Dim LAddLongRate  As Double:    Dim ltradedt As Date:           Dim TxtPath As String:              Dim LFileName As String
    Dim AMarRate As Double:         Dim TMarRate As Double:         Dim MAddLong As Double:             Dim MAddShort As Double
    Dim MSPCashMGLong As Double:    Dim MSPCashMGShort As Double:   Dim LIMarRate As Double:             Dim TRec As ADODB.Recordset:
    Dim LExMarRate  As Double:      Dim LAddShortRate  As Double:   Dim LELMLong  As Double:            Dim LELMShort As Double
    Dim LDelMarRate As Double:
    Dim LEXHCODE As String
    
    On Error GoTo err1
    Call GET_JCnn("\NCDX;")
    LSExCode = "NCDX"
    Cnn.BeginTrans:
    CNNERR = True
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "DLYMGN_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right$(CStr(Year(ltradedt)), 4) & "_03.CSV"
        
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "NCDX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "NCDX")
        End If
        Set LFileSystemObject = Nothing
        
        LFileName = App.Path & "\NCDX\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                LSEXID = Get_ExID("NCDX")
                If InStr(LBillExId, str(LSEXID)) = 0 Then
                    If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                    LBillExId = LBillExId & str(LSEXID)
                End If
                Cnn.Execute "DELETE FROM DLYMGN WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(ltradedt, "yyyy/MM/dd") & "' AND EXID =" & LSEXID & ""
                TxtRec.MoveFirst
                While Not TxtRec.EOF
                    LELMLong = 0:                   LELMShort = 0:              LIMarRate = 0
                    LDelMarRate = 0:                MAddLong = 0:               MAddShort = 0
                    LSItemCode = vbNullString:      LSItemid = 0:               LSSaudaCode = vbNullString
                    LSSaudaID = 0:                  LEXHCODE = vbNullString:    LSInstType = "FUT"
                    LSStrike = 0:                   LSOptType = vbNullString:   LExMarRate = 0
                    
                    If TxtRec!F2 = "FUTCOM" Then
                        LEXHCODE = Trim$(TxtRec!f3)
                        If Not IsDate(TxtRec!F4) Then
                            LMsgBox = "Pls Check Date" & TxtRec!F4 & ""
                            ImportIssues (LMsgBox)
                        End If
                        LSMaturity = DateValue(TxtRec!F4)
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, "NCDX", 1, True, False, 1)
                        If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                        Call Get_Sauda_Details(LEXHCODE, False, False, ltradedt, 1)
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        LIMarRate = Val(TxtRec!F5 & vbNullString):             LExMarRate = Val(TxtRec!f6 & vbNullString)
                        LDelMarRate = Val(TxtRec!F7 & vbNullString):           MAddLong = Val(TxtRec!F9 & vbNullString):
                        MAddShort = Val(TxtRec!F10 & vbNullString):            MSPCashMGLong = Val(TxtRec!f11 & vbNullString)
                        MSPCashMGShort = Val(TxtRec!f12 & vbNullString)
                        If lminbilldate > ltradedt Then lminbilldate = ltradedt
                        Call PINSERT_DLYMGN(ltradedt, LSSaudaCode, LIMarRate, LExMarRate, 0, (LIMarRate + LExMarRate), MAddLong, MAddShort, MSPCashMGLong, MSPCashMGShort, LSItemCode, LSExCode, LSMaturity, LELMLong, LELMShort, LDelMarRate, LSSaudaID, LSItemid, LSEXID)
                    End If
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub SAVE_NCDEX_CLIENT_MGN()
    'date 20/07/2004
    Dim TxtRec As ADODB.Recordset:    Dim TXTREC2 As ADODB.Recordset:        Dim TRec As ADODB.Recordset:
    Dim TxtPath As String:              Dim LFileName As String:          Dim TxtPath2 As String
    Dim MMarginAc As String:            Dim LCMargin As Double:           Dim ltradedt As Date
    Dim LCAM As Boolean:                Dim LMFLPath  As String:          Dim TotMamt As Double:
    Dim MAMT As Double:                 Dim MVouNo As String:             Dim MClient As String:
    Dim MCLCODE As String:              Dim LSCondate As Date:            Dim LParty As String
    Dim LIMargin As Double:             Dim LMMargin As Double:           Dim LPreExpMargin As Double
    Dim TxtRec3 As ADODB.Recordset:     Dim TxtPath3 As String:           Dim LMG23 As Boolean
    Dim LTotPreExpMargin As Double:     Dim LDelMargin As Double:
    Dim LPEAKM As Double:               Dim LPEAKE As Double:             Dim LExID As Integer
    
    On Error GoTo err1
    LSExCode = "NCDX"
    Call GET_JCnn("\NCDX;")
    Call Get_ExDetail("NCDX")
    CNNERR = True
    Cnn.BeginTrans
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "NCDEX_MG19" & IIf(LMemberId = "", "", "_" & LMemberId) & "_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".LIS.CSV"
        
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "NCDX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "NCDX")
        End If
        Set LFileSystemObject = Nothing
        
        LFileName = App.Path & "\NCDX\" & TxtPath
        
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            LMFLPath = App.Path & "\NCDX\"
            LCAM = False
            TxtPath2 = "NCDEX_CAM10" & IIf(LMemberId = "", "", "_" & LMemberId) & "_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
            LFileName = App.Path & "\NCDX\" & TxtPath2
            If FileExist(LFileName) Then
                Set TXTREC2 = Nothing: Set TXTREC2 = New ADODB.Recordset
                TXTREC2.Open "Select * from " & TxtPath2 & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                LCAM = True
            End If
            TxtPath3 = "NCDEX_MG19" & IIf(LMemberId = "", "", "_" & LMemberId) & "_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".LIS.CSV"
            Call Create_MG23_SchemaFile(LMFLPath, TxtPath3)
            LFileName = App.Path & "\NCDX\" & TxtPath3
            If FileExist(LFileName) Then
                Set TxtRec3 = Nothing: Set TxtRec3 = New ADODB.Recordset
                TxtRec3.Open "Select * from " & TxtPath3 & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                LMG23 = True
            End If
            If Not TxtRec3.EOF Then
                LExID = Get_ExID(LSExCode)
                FlagDataTrf = True
                Cnn.Execute "DELETE FROM DLYCLMGN WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(ltradedt, "yyyy/MM/dd") & "' AND EXID=" & LExID & ""
                TxtRec3.MoveFirst
                TotMamt = 0
                While Not TxtRec3.EOF
                    MAMT = 0:       LIMargin = 0: LMMargin = 0: LPreExpMargin = 0: LDelMargin = 0
                    LPEAKM = 0:     LPEAKE = 0
                    
                    MClient = TxtRec3!F2
                        LSCondate = DateValue(TxtRec3!F1)
                    LParty = Get_ACCT_EX(LExID, MClient)
                    If LenB(LParty) < 1 Then GoTo EFlag_Next
                    LIMargin = Val(TxtRec3!F5)
                    LMMargin = Val(TxtRec3!f6)
                    MAMT = LIMargin + LMMargin
                    TotMamt = TotMamt + MAMT
                    LPreExpMargin = Val(TxtRec3!F7) + Val(TxtRec3!F8) + Val(TxtRec3!F9)
                    LDelMargin = Val(TxtRec3!F10 & vbNullString)
                    LCMargin = 0
                    If LCAM = True Then
                        TXTREC2.MoveFirst
                        Do While Not TXTREC2.EOF
                            If TXTREC2!F1 = MClient Then LCMargin = LCMargin + Val(TXTREC2!F15)
                            TXTREC2.MoveNext
                        Loop
                    End If
                    'LPEAKM = Val(TxtRec3!F16 & vbNullString)
                    'LPEAKE = Val(TxtRec3!F17 & vbNullString)
                    MAMT = MAMT + LCMargin
                    
                    mysql = "INSERT INTO DLYCLMGN (COMPCODE, Condate, CLIENT, IMargin, MMARGIN, CMARGIN, PREEXPMARGIN,DeliveryMargin,EXCODE,EXID,PEAKINITIAL,PEAKEXTREME) "
                    mysql = mysql & "VALUES (" & GCompCode & ",'" & Format(LSCondate, "yyyy/MM/dd") & "','" & LParty & "'," & Val(LIMargin) & "," & LMMargin & ","
                    mysql = mysql & LCMargin & "," & LPreExpMargin & "," & LDelMargin & ",'" & LSExCode & "' ," & LExID & "," & LPEAKM & "," & LPEAKE & " )"
                    Cnn.Execute mysql
EFlag_Next:
                    TxtRec3.MoveNext
                Wend
            End If
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
       
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub SAVE_NCDEX_BK02()
    Dim LNarr As String:            Dim MBankCli As String:         Dim MBankAcc As String:   Dim DtStr As String
    Dim LContra As String:          Dim MVouNo As String:           Dim LCTTAcc As String:    Dim MSPARTY As String
    Dim TxtPath As String:          Dim LFileName As String:        Dim MDt As Date:          Dim TotMamt As Double
    Dim MAMT As Double:             Dim ltradedt As Date:           Dim LMVNo As Long: Dim LExID As Integer
    Dim MDR As String:              Dim MCR As String: Dim TRec As ADODB.Recordset:
    Dim LBankAccID As Long
     Dim LACCID As Long
     
                        
    On Error GoTo err1
    Call GET_JCnn("\NCDX;")
    LSExCode = "NCDX"
    Get_ExDetail (LSExCode)
    CNNERR = True
    If LenB(LExCont) = 0 Then Exit Sub
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    TRec.Open "SELECT BANKACC,BANKCLI,TRANTAX FROM EXMAST WHERE COMPCODE =" & GCompCode & " AND EXCODE = '" & LSExCode & "'", Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then
        MBankAcc = TRec!BANKACC:         MBankCli = TRec!BANKCLI:                    LCTTAcc = TRec!TRANTAX
        LBankAccID = Get_AccID(MBankAcc)
    Else
        MsgBox "Please Import Again as Exchange Bank Account not Defined for " & LSExCode, vbInformation
        Exit Sub
    End If
    CNNERR = True:    Cnn.BeginTrans
    MSPARTY = LExCont
    For ltradedt = vcDTP1.Value To vcDTP2.Value
    
        
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "NCDX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "NCDX")
        End If
        Set LFileSystemObject = Nothing
    
        TxtPath = "NCDEX_BK02" & IIf(LMemberId = "", "", "_" & LMemberId) & "_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = App.Path & "\NCDX\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & " WHERE F2 NOT LIKE 'NET SETTLEMENT%' ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                Cnn.Execute "DELETE FROM VOUCHER WHERE COMPCODE =" & GCompCode & " AND VOU_DT = '" & Format(ltradedt, "yyyy/MM/dd") & "' AND VOU_TYPE='K'"
                Cnn.Execute "DELETE FROM VCHAMT  WHERE COMPCODE =" & GCompCode & " AND VOU_DT = '" & Format(ltradedt, "yyyy/MM/dd") & "'AND VOU_TYPE='K'"
                TxtRec.MoveFirst
                TotMamt = 0:                MAMT = 0
                DtStr = TxtRec!F1
                DtStr = Left$(TxtRec!F1, Len(TxtRec!F1) - 6)
                LNarr = Trim(TxtRec!F2)
                If Len(DtStr) = 8 Then
                    MDt = DateValue(Left$(DtStr, 2) & "/" & Mid(DtStr, 3, 2) & "/" & Mid(DtStr, 5, 4))
                Else
                    MDt = DateValue(Left$(DtStr, 1) & "/" & Mid(DtStr, 2, 2) & "/" & Mid(DtStr, 4, 4))
                End If
                MVouNo = Get_VouNo("BKFL", GFinYear)
                LExID = Get_ExID("NCDX")
                LMVNo = PInsert_Voucher(MVouNo, MDt, "K", "P", 0, "ADD", "NCDX", 0, "Bank File", "NCDX", "0", LExID, 0)
                TotMamt = 0
                TxtRec.MoveFirst
                While Not TxtRec.EOF
                    LNarr = Trim(TxtRec!F2)
                    If Left$(TxtRec!F2, 3) = "CTT" Then
                        LContra = LCTTAcc
                    Else
                        LContra = MBankCli
                    End If
                    LACCID = Get_AccID(LContra)
                    If TxtRec!F4 = "C" Then
                        MDR = "D"
                        MCR = "C"
                    Else
                        MDR = "C"
                        MCR = "D"
                    End If
                    Call PInsert_Vchamt(MVouNo, "K", MDt, MDR, MBankAcc, Val(TxtRec!F7), vbNullString, MDt, Trim(TxtRec!F2), vbNullString, vbNullString, 0, "NCDX", LMVNo, LExID, 0, LBankAccID)
                    Call PInsert_Vchamt(MVouNo, "K", MDt, MCR, LContra, Val(TxtRec!F7), vbNullString, MDt, Trim(TxtRec!F2), vbNullString, vbNullString, 0, "NCDX", LMVNo, LExID, 0, LACCID)
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
        MsgBox err.Description, vbCritical, "Error Number : " & err.Number
        
        If CNNERR = True Then Cnn.RollbackTrans: CNNERR = False
End Sub
Sub Save_MCX_ContractMaster()
    Dim LNoCode As Double:          Dim LOverwrite As Boolean
    Dim TxtPath As String:          Dim LFileName As String:
    Dim LEXHCODE As String:
    Dim ltradedt As Date:           Dim ldate As Date:
    
    On Error GoTo err1
    Call GET_JCnn("\MCX;")
    TxtPath = "MCX_PRODUCTMASTER.CSV"
    LOverwrite = IIf(Check14 = 1, False, True)
    ltradedt = vcDTP1.Value
    LFileName = App.Path & "\MCX\" & TxtPath
    LSExCode = "MCX"
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "MCX") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "MCX")
    End If
    Set LFileSystemObject = Nothing
    
    If Not FileExist(LFileName) Then
        LMsgBox = LFileName & "  file not found" ', vbCritical
        ImportIssues (LMsgBox)
        Exit Sub
    Else
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & " WHERE (F1='FUTCOM' OR  F1='OPTFUT' )  ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
    End If
    If Not TxtRec.EOF Then
        FlagDataTrf = True
        Cnn.BeginTrans
        CNNERR = True:
        ldate = vcDTP1.Value
        TxtRec.MoveFirst
        LSEXID = Get_ExID(LSExCode)
        While Not TxtRec.EOF
            LSItemCode = vbNullString:  LSSaudaCode = vbNullString:     LLOT = 1:
            LSInstType = "FUT":         LSOptType = vbNullString:       LSStrike = 0
            LSItemid = 0:               LSSaudaID = 0
            If TxtRec!f11 <> 0 Then
                If LLotWise = "Y" Then LLOT = ((Val(TxtRec!F47) / Val(TxtRec!F48)) * Val(TxtRec!f19) * (Val(TxtRec!F49) / Val(TxtRec!F50)))
                LEXHCODE = RTrim(LTrim(TxtRec!F5))
                LSInstType = Left$(TxtRec!F1, 3)
                LNoCode = TxtRec!f3:
                LSMaturity = DateValue(Left$(TxtRec!F10, 2) & "/" & Mid(TxtRec!F10, 3, 3) & "/" & Right$(TxtRec!F10, 4))
                If LSInstType = "OPT" Then LSOptType = TxtRec!F8: LSStrike = Val(TxtRec!F9)
                Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, LLOT, True, False, 1)
                
                Call Get_Sauda_Details(LEXHCODE, True, False, vcDTP1.Value, 1)
                mysql = "UPDATE SCRIPTMASTER SET LOT =" & LLOT & " ,NOCODE =" & LNoCode & " WHERE  EXCODE ='" & LSExCode & "' AND EX_SYMBOL ='" & LEXHCODE & "' "
                mysql = mysql & " AND MATURITY ='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE='" & LSInstType & "' AND OPTTYPE ='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                Cnn.Execute mysql
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LLOT = ((Val(TxtRec!F47) / Val(TxtRec!F48)) * Val(TxtRec!f19) * (Val(TxtRec!F49) / Val(TxtRec!F50)))
                mysql = "UPDATE SAUDAMAST SET TRADEABLELOT =" & LLOT & " ,NOCODE =" & LNoCode & " WHERE saudaid =" & LSSaudaID & ""
                Cnn.Execute mysql
            End If
EFlag_Next:
            TxtRec.MoveNext
        Wend
        MsgBox "Task Over Succesfully"
        Cnn.CommitTrans
        CNNERR = False
    End If
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Trade_MCX_SAUDA()
    Dim LOverwrite As Boolean
    SaudaTrade = True
    LSExCode = "MCX"
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    LOverwrite = IIf(Check14 = 1, False, True)
    Call Save_SaudaTradeFile(LOverwrite, LSExCode)
End Sub
Sub Trade_NSE_SAUDA()
    Dim LOverwrite As Boolean
    SaudaTrade = True
    LSExCode = "NSE"
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    LOverwrite = IIf(Check14 = 1, False, True)
    Call Save_SaudaTradeFile(LOverwrite, LSExCode)
End Sub

Sub Save_EQ_Trade(Optional PFOLDERNAME As String, Optional LExcelFileType As Integer, Optional LBrokerCode As String, Optional lclientid As String)
    Dim ltradedt As Date:           Dim TxtPath As String:              Dim LFileName As String: Dim TRec As ADODB.Recordset:
    Dim LSCondate As Date:          Dim MCount As Long:                 Dim LQTY As Double:                 Dim LRATE As Double:
    Dim LUserId As String:          Dim LOConNo As String:              Dim LOrdNo As String:               Dim LOrdTime As String:
    Dim LContime As String:         Dim LStrMaturity As String:         Dim LPartyName As String:           Dim LOverwrite As Boolean
    Dim mparty As String:           Dim LClient As String:          Dim LConType As String:                 Dim LSPtyContype As String:
    Dim LEXHCODE As String:         Dim MSPARTY As String:              Dim mbparty As String:              Dim LSConSno As Long
    Dim lsparty As String:          Dim LMFLPath As String
    Dim LNoTrd  As Long
    Dim LACCID As Long
    Dim Lbrokerid As Long
    
    On Error GoTo err1
    If Len(PFOLDERNAME) > 0 Then
        If LExcelFileType <> 140 Then
            PFOLDERNAME = "EQ"
        End If
    Else
        PFOLDERNAME = "EQ"
        'Call GET_JCnn("\NSE;")
    End If
    
    If LExcelFileType <> 140 Then
        LExcelFileType = "0"
    End If
    
    
    LOverwrite = IIf(Check14 = 1, False, True)
    Call GET_JCnn("\" & PFOLDERNAME & ";")
    'Call GET_JCnn("\EQ;")
    LSExCode = "EQ"
    Cnn.BeginTrans
    CNNERR = True:
    If LenB(LExCont) = 0 Then Exit Sub
    lsparty = LExCont
    If Len(LBrokerCode) > 1 Then
        lsparty = LBrokerCode
    End If
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If LBrokerType = "X" Then
            TxtPath = "EQ" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        Else
            TxtPath = "EQ" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
        End If
        On Error GoTo err1
        LFileName = App.Path & "\" & PFOLDERNAME & "\" & TxtPath
                   
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & PFOLDERNAME) Then
            LFileSystemObject.CreateFolder (App.Path & "\" & PFOLDERNAME)
        End If
        Set LFileSystemObject = Nothing

        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            LMFLPath = App.Path & "\" & PFOLDERNAME & "\"
            Call Create_SchemaFile(LMFLPath, TxtPath)
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                LSCondate = DateValue(Left$(TxtRec!F20, 2) & "/" & Mid(TxtRec!F20, 4, 3) & "/" & Mid(TxtRec!F20, 8, 4))
                MCount = Get_Max_ConNo(LSCondate, 0)
                CNNERR = True:
                If LExcelFileType <> 140 Then
                  If LOverwrite = True Then Call PDelete_CTR_D(LSCondate, LSExCode, vbNullString)
                End If
                TxtRec.MoveFirst
                LSEXID = Get_ExID(LSExCode)
                LNoTrd = 0
                While Not TxtRec.EOF
                    DoEvents
                    LQTY = 0:                   LRATE = 0:                  LUserId = vbNullString:           LOConNo = vbNullString:       LSItemCode = vbNullString:
                    LSItemName = vbNullString:  LSSaudaCode = vbNullString: LSStrike = 0:                     LClient = vbNullString:       LConType = vbNullString:
                    LOrdNo = vbNullString:      LContime = vbNullString:    LOrdTime = vbNullString:          LSPtyContype = "B":
                    LLOT = 1:                   LSInstType = "CSH":         LSOptType = vbNullString:         LSStrike = 0
                    LSSaudaID = 0:              LSItemid = 0
                    
                    LEXHCODE = TxtRec!f3 & " " & TxtRec!F4:           LOConNo = Trim(TxtRec!F1)
                    LContime = Right$(TxtRec!F20, 12):                      LRATE = Val(Format(TxtRec!F13, "0.00"))
                    LQTY = Val(TxtRec!f12):                                 LSItemName = TxtRec!F5
                    LClient = TxtRec!F15:                                   mparty = TxtRec!F15
                    LPartyName = Trim(TxtRec!F15):                          LUserId = TxtRec!F9
                    LConType = TxtRec!f11:
                    If LPartyAs = "U" Then mparty = LUserId
                    LSItemName = Replace(LSItemName, "'", "")
                    LSMaturity = DateValue(GFinEnd)
                    If LConType = "B" Then
                        LConType = "1"
                    ElseIf LConType = "S" Then
                        LConType = "2"
                    End If
                    If LBrokerType = "A" Then lsparty = LClient
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LSItemName, LSExCode, 1, True, True, 1)
                    If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                    Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
                    If LenB(LSSaudaCode) = 0 Then GoTo EFlag_Next
                    If chkEquityRemark.Value = 1 Then
                        If LenB(TxtRec!F24) <> 0 Then
                            mparty = Trim(TxtRec!F24)
                            LPartyName = Trim(TxtRec!F24)
                        End If
                    End If
                    If LConType = "2" Then LSPtyContype = "S"
                    mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, True)
                    MSPARTY = NewParty(LSExCode, lsparty, lsparty & " " & LSExCode, LUserId, True)
                    If LenB(mbparty) < 1 Then
                        LMsgBox = " Please Create Account For  " & mparty & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    If LenB(MSPARTY) < 1 Then
                        LMsgBox = " Please Create Account For  " & lsparty & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    
                    If InStr(LBillExId, str(LSEXID)) = 0 Then
                        If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                        LBillExId = LBillExId & str(LSEXID)
                    End If
                    If lminbilldate > LSCondate Then lminbilldate = LSCondate
                    LACCID = Get_AccID(mbparty)
                    Lbrokerid = Get_AccID(MSPARTY)
                    If LACCID = 0 Or Lbrokerid = 0 Then
                        LMsgBox = "Invalid Party / Broker Code "
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    LNoTrd = LNoTrd + 1
                    
                    If LExcelFileType = 140 Then
                        Dim MCLCODE As String
                        Dim MCONCODE As String
                        mysql = "SELECT ROWNO1,CLCODE,CONCODE from  CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND filetype =  '" & LExcelFileType & "' AND  PARTY = '" & mbparty & "' and CONTYPE = '" & LSPtyContype & "'  AND ROWNO1 ='" & LOConNo & "'"
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec.EOF Then
                            MCLCODE = TRec!CLCODE
                            MCONCODE = TRec!CONCODE
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND CLCODE = '" & MCLCODE & "' AND CONCODE = '" & MCONCODE & "' AND ROWNO1 ='" & LOConNo & "'"
                            Cnn.Execute mysql
                        End If
                        
                    End If

                    
                    GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                    DoEvents
                    MCount = MCount + 1
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                    Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, LExcelFileType, "Y", LSEXID, LSItemid, LSSaudaID)
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next
    Set TxtRec = Nothing
    Cnn.CommitTrans
    
    LMsgBox = " No Of Trade:  " & LNoTrd & " Imported From Folder " & PFOLDERNAME & ""
    ImportIssues (LMsgBox)
    
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Save_Fut_Trade(Optional PFOLDERNAME As String, Optional LExcelFileType As Integer, Optional LBrokerCode As String, Optional lclientid As String)

    Dim ltradedt As Date:           Dim LOverwrite As Boolean:         Dim TRec As ADODB.Recordset:
    Dim LUserId As String:          Dim LOConNo As String:              Dim LOrdNo As String:               Dim LOrdTime As String:
    Dim LSCondate As Date:          Dim MCount As Long:                 Dim B As Integer:                   Dim LPartyName As String
    Dim LQTY As Double:             Dim LRATE As Double:                Dim A As Integer:                   Dim LStrMaturity As String:
    Dim mparty As String:           Dim LClient As String:              Dim LContime As String:             Dim LSPtyContype As String:
    Dim mbparty As String:          Dim LSConSno As Long:               Dim LConType As String:             Dim lyear As String
    Dim TxtPath As String:          Dim LMFLPath As String:             Dim LFileName As String:            Dim LMONTH As String:
    Dim LMultiRate As Double:       Dim LMultiQty  As Double:           Dim LNoTrd As Long:                 Dim MSPARTY As String
    Dim LEXHCODE As String:
    Dim LACCID As Long
    Dim Lbrokerid As Long
    Dim LSTR As String
    Dim lday As Integer
    Dim LEXCONTO As String

    
    On Error GoTo err1
    If Len(PFOLDERNAME) > 0 Then
        If LExcelFileType <> 106 Then
            PFOLDERNAME = "NSE"
        End If
    Else
        PFOLDERNAME = "NSE"
        'Call GET_JCnn("\NSE;")
    End If
    
    If LExcelFileType <> 106 Then
        LExcelFileType = "0"
    End If
    
    Call GET_JCnn("\" & PFOLDERNAME & ";")
    
    LSExCode = "NSE"
    Cnn.BeginTrans
    CNNERR = True:
    
    If LExcelFileType <> "106" Then
        Call Get_ExDetail(LSExCode)
    Else
        LExCont = LBrokerCode
    End If
    LEXCONTO = LExCont

    If LenB(LExCont) = 0 Then Exit Sub
    LOverwrite = IIf(Check14 = 1, False, True)
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If LBrokerType = "M" Then
            If LenB(LMemberId) > 0 Then
                TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "_" & LMemberId & ".TXT"
            Else
                TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".txt"
            End If
        ElseIf LBrokerType = "Z" Then
            TxtPath = "Z" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        ElseIf LBrokerType = "N" Then
            TxtPath = "N" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        ElseIf LBrokerType = "W" Or LBrokerType = "1" Then
            TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        ElseIf LBrokerType = "X" Or LBrokerType = "C" Then
            TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        Else
            TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
        End If
        LFileName = App.Path & "\" & PFOLDERNAME & "\" & TxtPath
                   
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & PFOLDERNAME) Then
            LFileSystemObject.CreateFolder (App.Path & "\" & PFOLDERNAME)
        End If
        Set LFileSystemObject = Nothing
                        
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            'If LExcelFileType = 106 Then
            '    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LTradeDt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='" & LExcelFileType & "'"
            'End If

            LMFLPath = App.Path & "\" & PFOLDERNAME & "\"
            Call Create_SchemaNSEFile(LMFLPath, TxtPath)
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "SELECT * FROM " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                If LBrokerType = "M" Then
                    If LenB(LMemberId) > 0 Then
                        LSCondate = DateValue(Left$(TxtRec!F20, 2) & "/" & Mid(TxtRec!F20, 4, 3) & "/" & Mid(TxtRec!F20, 8, 4))
                    Else
                        LSCondate = DateValue(Left$(TxtRec!F20, 111))
                    End If
                Else
                    LSCondate = ltradedt
                End If
                
                If LExcelFileType <> 106 Then
                    If ChkNSEAllTerminal.Value <> 1 Then
                        If LOverwrite = True Then Call PDelete_CTR_D(LSCondate, LSExCode, vbNullString)
                    End If
                End If
                TxtRec.MoveFirst
                LNoTrd = 0
                While Not TxtRec.EOF
                    LQTY = 0:                       LRATE = 0:                    LUserId = vbNullString:    LOConNo = vbNullString:   LSItemCode = vbNullString:
                    LSItemName = vbNullString:      LSSaudaCode = vbNullString:   LSStrike = 0:              LOrdNo = vbNullString:    LContime = vbNullString:
                    LSPtyContype = "B":              LOrdTime = vbNullString:      LSInstType = "CSH":        LSOptType = vbNullString
                    LClient = vbNullString:         LConType = vbNullString:      LLOT = 1:                  LSItemid = 0
                    LMultiQty = 0:                  LSSaudaID = 0
                    LMultiRate = 1
                    MCount = Get_Max_ConNo(LSCondate, 0)
                    If Not IsNull(TxtRec!F1) Then
                        If LBrokerType = "M" Then
                            LEXHCODE = Trim(TxtRec!f3):                            LContime = Right$(TxtRec!F20, 8)
                            LUserId = Trim(TxtRec!f11):                            LConType = Trim(TxtRec!F13)
                            LRATE = Val(TxtRec!F15):                               LQTY = Val(TxtRec!F14)
                            mparty = Trim(TxtRec!F18):                             LPartyName = Trim(TxtRec!F17)
                            LSInstType = Left$(TxtRec!F4, 3)
                            LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 4, 3) & "/" & Mid(TxtRec!F5, 8, 4))
                            LOConNo = Trim(TxtRec!F1)
                        ElseIf LBrokerType = "N" Then
                            If Not IsNumeric(TxtRec!F10) Then GoTo FFlag_Next
                            LOConNo = Trim(TxtRec!F14)
                            LEXHCODE = LTrim$(RTrim$((TxtRec!F4))):                 LOrdNo = TxtRec!F17
                            LSItemName = LEXHCODE:                                  LContime = Trim$(TxtRec!F15)
                            LUserId = TxtRec!F2:                                    LConType = TxtRec!F8
                            LRATE = Val(TxtRec!F9):                                 LQTY = Val(TxtRec!F10)
                            LClient = Trim(TxtRec!f3):
                            LSCondate = DateValue(Left$(TxtRec!f16, 2) & "/" & Mid(TxtRec!f16, 4, 3) & "/" & Right$(TxtRec!f16, 4))
                            LSOptType = IIf(IsNull(TxtRec!f6), vbNullString, TxtRec!f6):       LSStrike = IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)
                            If LenB(LSOptType) > 0 Then
                                LSInstType = "OPT"
                            Else
                                LSInstType = "FUT"
                            End If
                            If Left(LConType, 1) = "S" Then LSPtyContype = "S"
                            LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Mid(TxtRec!F5, 6, 4))
                            If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then LQTY = LQTY * Val(TxtQtyMultipler.text)
                            If LPartyAs = "U" Then
                                mparty = LUserId
                                LPartyName = LUserId
                            Else
                                mparty = Left$(Trim(TxtRec!f3), 6)
                            End If
                        ElseIf LBrokerType = "1" Then
                            If Not IsNumeric(TxtRec!F8) Then GoTo FFlag_Next
                            LOConNo = Trim(TxtRec!f12)
                            If TxtRec!F1 = "NFO" Then
                                LSExCode = "NSE"
                            Else
                                LSExCode = "FX"
                            End If
                            LSEXID = Get_ExID(LSExCode)
                            LEXHCODE = LTrim$(RTrim$((TxtRec!F5))):                 LOrdNo = ""
                            LSItemName = LEXHCODE:                                  LContime = Trim$(TxtRec!F9)
                            LUserId = "":                                           LConType = Left(TxtRec!f3, 1)
                            LRATE = Val(TxtRec!F7):                                 LQTY = Val(TxtRec!F8)
                            LClient = Trim(TxtRec!F2):
                            LSCondate = DateValue(Left$(TxtRec!F13, 2) & "/" & Mid(TxtRec!F13, 4, 3) & "/" & Right$(TxtRec!F13, 4))
                            If Right(LEXHCODE, 2) = "CE" Or Right(LEXHCODE, 2) = "PE" Then
                                LSInstType = "OPT"
                                LSOptType = Right(LEXHCODE, 2)
                                LEXHCODE = Left(TxtRec!F5, Len(TxtRec!F5) - 2)
                                If IsNumeric(Right(LEXHCODE, 6)) Then
                                    LSStrike = Right(LEXHCODE, 6)
                                    LSTR = Right(Left(LEXHCODE, Len(LEXHCODE) - 6), 5)
                                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 11)
                                ElseIf IsNumeric(Right(LEXHCODE, 5)) Then
                                    LSStrike = Right(LEXHCODE, 5)
                                    LSTR = Right(Left(LEXHCODE, Len(LEXHCODE) - 5), 5)
                                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 10)
                                ElseIf IsNumeric(Right(LEXHCODE, 4)) Then
                                    LSStrike = Right(LEXHCODE, 4)
                                    LSTR = Right(Left(LEXHCODE, Len(LEXHCODE) - 4), 5)
                                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 9)
                                ElseIf IsNumeric(Right(LEXHCODE, 3)) Then
                                    LSStrike = Right(LEXHCODE, 3)
                                    LSTR = Right(Left(LEXHCODE, Len(LEXHCODE) - 3), 5)
                                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 8)
                                ElseIf IsNumeric(Right(LEXHCODE, 2)) Then
                                    LSStrike = Right(LEXHCODE, 2)
                                    LSTR = Right(Left(LEXHCODE, Len(LEXHCODE) - 2), 5)
                                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 7)
                                End If
                                lyear = Year(LSCondate)
                            Else
                                LSInstType = "FUT"
                                LEXHCODE = Left(TxtRec!F5, Len(TxtRec!F5) - 8)
                                LSTR = Right(Left(TxtRec!F5, Len(TxtRec!F5) - 3), 5)
                                lyear = Year(LSCondate)
                            End If
                            LSMaturity = DateValue(Left$(TxtRec!F14, 2) & "/" & Mid(TxtRec!F14, 3, 3) & "/" & Right$(TxtRec!F14, 4))
                            LSItemName = LEXHCODE
                            If Left(LConType, 1) = "S" Then LSPtyContype = "S"
                            
                            If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then LQTY = LQTY * Val(TxtQtyMultipler.text)
                            mparty = Left$(Trim(TxtRec!F2), 6)
                        ElseIf LBrokerType = "W" Then
                            If Not IsDate(TxtRec!f12) Then GoTo FFlag_Next
                            LOConNo = Trim(TxtRec!F10)
                            LOrdNo = TxtRec!F1

                            LSTR = Right(TxtRec!F5, 10)
                            A = InStr(TxtRec!F5, "FUT")
                            If A <> 0 Then
                                LSInstType = "FUT"
                                LEXHCODE = Left(TxtRec!F5, Len(TxtRec!F5) - 10)
                                lday = Mid(TxtRec!F5, Len(TxtRec!F5) - 9, 2)
                                LMONTH = Mid(TxtRec!F5, Len(TxtRec!F5) - 7, 3)
                                lyear = "20" & Mid(TxtRec!F5, Len(TxtRec!F5) - 4, 2)
                            Else
                                LSInstType = "OPT"
                                LSTR = Right(TxtRec!F5, 2)
                                If LSTR = "PE" Then
                                    LSOptType = "PE"
                                Else
                                    LSOptType = "CE"
                                End If
                                Dim I As Integer
                                I = 1
                                Do While I <= 12
                                    Select Case I
                                        Case 1
                                            A = InStr(TxtRec!F5, "JAN")
                                            LMONTH = "JAN"
                                        Case 2
                                            A = InStr(TxtRec!F5, "FEB")
                                            LMONTH = "FEB"
                                        Case 3
                                            A = InStr(TxtRec!F5, "MAR")
                                            LMONTH = "MAR"
                                        Case 4
                                            A = InStr(TxtRec!F5, "APR")
                                            LMONTH = "APR"
                                        Case 5
                                            A = InStr(TxtRec!F5, "MAY")
                                            LMONTH = "MAY"
                                        Case 6
                                            A = InStr(TxtRec!F5, "JUN")
                                            LMONTH = "JUN"
                                        Case 7
                                            A = InStr(TxtRec!F5, "JUL")
                                            LMONTH = "JUL"
                                        Case 8
                                            A = InStr(TxtRec!F5, "AUG")
                                            LMONTH = "AUG"
                                        Case 9
                                            A = InStr(TxtRec!F5, "SEP")
                                            LMONTH = "SEP"
                                        Case 10
                                            A = InStr(TxtRec!F5, "OCT")
                                            LMONTH = "OCT"
                                        Case 11
                                            A = InStr(TxtRec!F5, "NOV")
                                            LMONTH = "NOV"
                                        Case 12
                                            A = InStr(TxtRec!F5, "DEC")
                                            LMONTH = "DEC"
                                    End Select
                                    I = I + 1
                                    If A <> 0 Then Exit Do
                                Loop
                                If IsNumeric(Mid(TxtRec!F5, A - 2, 1)) Then
                                    LEXHCODE = Left(TxtRec!F5, A - 3)
                                    lday = Mid(TxtRec!F5, A - 2, 2)
                                    LSStrike = Mid(TxtRec!F5, A + 5, Len(TxtRec!F5) - (A + 6))
                                Else
                                    LEXHCODE = Left(TxtRec!F5, A - 2)
                                    lday = Mid(TxtRec!F5, A - 1, 1)
                                    LSStrike = Mid(TxtRec!F5, A + 5, Len(TxtRec!F5) - (A + 6))
                                End If

                                
                                
                            End If
                            
                            LSItemName = LEXHCODE:                                  LContime = ""
                            LUserId = TxtRec!F4:                                    LConType = Left(TxtRec!f6, 1)
                            LRATE = Val(TxtRec!F8):                                 LQTY = Val(TxtRec!F7)
                            LClient = Trim(TxtRec!f3):
                            LSCondate = DateValue(TxtRec!f12)
                           ' LSCondate = DateValue(Left$(TxtRec!F12, 2) & "/" & Mid(TxtRec!F12, 4, 3) & "/" & Right$(TxtRec!F12, 4))
                            'LSOptType = IIf(IsNull(TxtRec!f6), vbNullString, TxtRec!f6):       LSStrike = IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)
                            If LenB(LSOptType) > 0 Then
                                LSInstType = "OPT"
                            Else
                                LSInstType = "FUT"
                            End If
                            If Left(LConType, 1) = "S" Then LSPtyContype = "S"
                            LSMaturity = DateValue(Left$(lday, 2) & "/" & LMONTH & "/" & lyear)
                            If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then LQTY = LQTY * Val(TxtQtyMultipler.text)
                            If LPartyAs = "U" Then
                                mparty = LUserId
                                LPartyName = LUserId
                            Else
                                mparty = Left$(Trim(TxtRec!f3), 6)
                            End If
                        ElseIf LBrokerType = "X" Or LBrokerType = "C" Then
                            If LBrokerType = "C" Then
                                If Not IsNumeric(TxtRec!F7) Then GoTo FFlag_Next
                                LSInstType = "FUT"
                                LEXHCODE = Left(TxtRec!F1, Len(TxtRec!F1) - 10)
                                LSMaturity = DateValue(TxtRec!F4)
                                LConType = Left(TxtRec!F2, 1)
                                LRATE = Val(TxtRec!F8)
                                LQTY = Val(TxtRec!F7)
                                LContime = Right(TxtRec!F13, 8)
                                'LCondate = Left(Trim(TxtRec!f13), 10)
                                'LSCondate = DateValue(Left$(LCondate, 2) & "/" & Mid(LCondate, 4, 3) & "/" & Right(LCondate, 4))
                                If Len(LClientCode) > 0 Then
                                    mparty = LClientCode
                                Else
                                    mparty = TxtRec!f12
                                End If
                                If LConType = "B" Then
                                    LConType = "1"
                                Else
                                    LConType = "2"
                                End If
                            Else
                                If IsNull(TxtRec!F2) Then GoTo FFlag_Next
                                If Not IsNumeric(TxtRec!f6) Then GoTo FFlag_Next
                                If Not IsNumeric(TxtRec!F7) Then GoTo FFlag_Next
                                LSInstType = "FUT"
                                LEXHCODE = TxtRec!F2
                                LSMaturity = DateValue(Left$(TxtRec!f3, 2) & "/" & Mid(TxtRec!f3, 4, 3) & "/20" & Right(TxtRec!f3, 2))
                                LConType = Left(TxtRec!F5, 1)
                                LRATE = Val(TxtRec!f6)
                                LQTY = Val(TxtRec!F7)
                                LContime = TxtRec!F8
                                LSCondate = DateValue(Left$(TxtRec!f11, 2) & "/" & Mid(TxtRec!f11, 4, 3) & "/20" & Right(TxtRec!f11, 2))
                                mparty = TxtRec!f12
                                If LConType = "B" Then
                                    LConType = "1"
                                Else
                                    LConType = "2"
                                End If
                           End If
                        ElseIf LBrokerType = "T" Then
                            'If Not IsNumeric(TxtRec!f6) Then GoTo FFlag_Next
                            LSCondate = DateValue(Left(TxtRec!F20, 2) & "/" & Mid(TxtRec!F20, 4, 3) & "/" & Mid(TxtRec!F20, 8, 4))
                            LOConNo = Trim(TxtRec!F1)
                            LEXHCODE = TxtRec!f3
                            LSInstType = Left(TxtRec!F4, 3)
                            If LSInstType = "OPT" Then
                                LSOptType = TxtRec!F7
                                LSStrike = TxtRec!f6
                            End If
                            mparty = TxtRec!F17
                            LSMaturity = DateValue(Left(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 4, 3) & "/20" & Right(TxtRec!F5, 2))
                            LConType = TxtRec!F13
                            LQTY = Val(TxtRec!F14):      LRATE = Val(TxtRec!F15)
                            LContime = Right(TxtRec!F20, 8):           LOrdNo = ""
                        ElseIf LBrokerType = "Z" Then
                            If Not IsNumeric(TxtRec!f6) Then GoTo FFlag_Next
                            LSCondate = DateValue(Left(TxtRec!F1, 2) & "/" & Mid(TxtRec!F1, 4, 3) & "/20" & Right(TxtRec!F1, 2))
                            If Not IsNull(TxtRec!F9) Then
                                LEXHCODE = TxtRec!f3
                                A = Len(LEXHCODE)
                                B = Len(TxtRec!F9)
                                B = B + 7
                                LEXHCODE = Left(LEXHCODE, A - B)
                                LSInstType = "OPT"
                                LSOptType = TxtRec!F7
                                LSStrike = Val(TxtRec!F9)
                            Else
                                LEXHCODE = TxtRec!f3
                                A = Len(LEXHCODE)
                                LEXHCODE = Left(LEXHCODE, A - 8)
                                LSInstType = "FUT"
                                LSOptType = vbNullString
                                LSStrike = 0
                            End If
                            mparty = "1"
                            LSMaturity = DateValue(Left(TxtRec!F4, 2) & "/" & Mid(TxtRec!F4, 4, 3) & "/20" & Right(TxtRec!F4, 2))
                            LConType = Left(TxtRec!F10, 1)
                            If LConType = "B" Then
                                LConType = "1"
                            Else
                                LConType = "2"
                            End If
                            LQTY = Val(TxtRec!F5):      LRATE = Val(TxtRec!f6)
                            LContime = Time:            LOrdNo = Trim(TxtRec!f11)
                        Else
                            If TxtRec!F4 = "FUTCUR" Or TxtRec!F4 = "OPTCUR" Then
                                LSExCode = "FX"
                                LOConNo = Trim(TxtRec!F1)
                                LEXHCODE = LTrim$(RTrim$((TxtRec!f3))):
                                LOrdNo = ""
                                LSItemName = LEXHCODE:
                                LSCondate = DateValue(Left$(TxtRec!F20, 2) & "/" & Mid(TxtRec!F20, 4, 3) & "/" & Mid(TxtRec!F20, 8, 4))
                                LContime = Right$(TxtRec!F20, 8)
                                LUserId = TxtRec!f11:
                                LConType = TxtRec!F13
                                LQTY = Val(TxtRec!F14)
                                LRATE = Val(TxtRec!F15):
                                LClient = Trim(TxtRec!F17):
                                LSInstType = IIf(TxtRec!F4 = "FUTCUR", "FUT", "OPT")
                                If LSInstType = "OPT" Then
                                    LSOptType = IIf(IsNull(TxtRec!F7), vbNullString, TxtRec!F7)
                                    LSStrike = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
                                End If
                                If InStr(TxtRec!F5, "-") Or Mid(TxtRec!F5, 3, 1) = " " Then
                                    LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 4, 3) & "/20" & Right(TxtRec!F5, 2))
                                Else
                                    LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/20" & Right(TxtRec!F5, 2))
                                End If
                            Else
                                If TxtRec!f3 = "FUTCUR" Or TxtRec!f3 = "OPTCUR" Then
                                    LSExCode = "FX"
                                End If
                                If Not IsNumeric(TxtRec!f16) Then GoTo FFlag_Next
                                If Not IsDate(TxtRec!f22) Then GoTo FFlag_Next
                                LSCondate = DateValue(TxtRec!f22)
                                LOConNo = Trim(TxtRec!F1)
                                LEXHCODE = LTrim$(RTrim$((TxtRec!F4))):                     LOrdNo = TxtRec!F24
                                LSItemName = LEXHCODE:                                      LContime = Right$(TxtRec!f22, 8)
                                LUserId = TxtRec!f12:                                       LConType = TxtRec!F14
                                LRATE = Val(TxtRec!f16):                                    LQTY = Val(TxtRec!F15)
                                LSInstType = IIf(IsNull(TxtRec!f3), "FUT", TxtRec!f3)
                                If Len(lclientid) <= 0 Then
                                    LClient = Trim(TxtRec!F18)
                                Else
                                    LClient = lclientid
                                End If
                                LSOptType = IIf(IsNull(TxtRec!F7), vbNullString, TxtRec!F7): LSStrike = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
                                
                                If GUniqClientId = "543UJN" And (TxtRec!f3 = "FUTCUR" Or TxtRec!f3 = "OPTCUR") Then
                                    LQTY = LQTY * 1000
                                End If
                               
                                If InStr(TxtRec!F5, "/") Then
                                    LSMaturity = DateValue(TxtRec!F5)
                                ElseIf Len(TxtRec!F5) = 8 Then
                                    LSMaturity = DateValue(Right$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 5, 2) & "/" & Left(TxtRec!F5, 4))
                                Else
                                    If InStr(TxtRec!F5, "-") Or Mid(TxtRec!F5, 3, 1) = " " Then
                                        LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 4, 3) & "/20" & Right(TxtRec!F5, 2))
                                    Else
                                        LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/20" & Right(TxtRec!F5, 2))
                                    End If
                                End If
                            End If
                            If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then LQTY = LQTY * Val(TxtQtyMultipler.text)
                            If LPartyAs = "U" Then
                                mparty = LUserId
                                LPartyName = LUserId
                            Else
                                If LBrokerType = "C" Then
                                    If LPartyAs = "C" Then
                                        mparty = Trim(TxtRec!F18)
                                    Else
                                        mparty = LUserId
                                    End If
                                Else
                                    mparty = Trim(TxtRec!F18)
                                End If
                            End If
                            If Left$(LSInstType, 3) = "FUT" Then
                                LSInstType = "FUT"
                            Else
                                LSInstType = "OPT"
                            End If
                        End If
                        If Len(lclientid) > 1 Then
                            mparty = lclientid
                        End If
                        LExCont = LEXCONTO
                        If LSInstType = "OPT" Then

                            mparty = mparty + "O"
                            If Len(lclientid) > 1 Then
                                LExCont = LExCont + "O"
                            End If
                           
                            mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, False)
                            If Len(mbparty) < 1 Then
                                mparty = Left(mparty, Len(mparty) - 1)
                            End If
                        End If
                        
                        If LenB(LSItemName) < 1 Then LSItemName = LEXHCODE
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LSItemName, LSExCode, 1, True, True, 1)
                        If LenB(LSItemCode) = 0 Then GoTo FFlag_Next
                        Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
                        If LenB(LSSaudaCode) = 0 Then GoTo FFlag_Next
                        
                        LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)

                        If LBrokerType = "Z" Then
                            If Not IsNull(TxtRec!F13) Then
                                If TxtRec!F13 = "CDS" Then
                                    LQTY = LQTY * 1000
                                End If
                            Else
                                If LLotWise = "Y" Then LQTY = LQTY / LLOT
                            End If
                        Else
                            If LLotWise = "Y" Then LQTY = LQTY / LLOT
                        End If
                        'MSPARTY = LExCont
                        MSPARTY = NewParty(LSExCode, LExCont, LExCont & " " & LSExCode, LUserId, False)
                        If Len(MSPARTY) < 1 Then
                            MSPARTY = LEXCONTO
                        End If
                        If CHKFutureRemark.Value = 1 Then
                            If LenB(TxtRec!f29) <> 0 Then
                                mparty = Trim(TxtRec!f29)
                                LPartyName = Trim(TxtRec!f29)
                            End If
                        End If
                        If LConType = "2" Then LSPtyContype = "S"
                        If LTradeFileType = "666" Then
                            mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, False)
                        Else
                            mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, True)
                        End If

                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Please Create Account for" & mparty & ""
                            ImportIssues (LMsgBox)
                            GoTo FFlag_Next
                        End If
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT MULTIPLIER FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & mbparty & "'"
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec.EOF Then
                            If TRec!MULTIPLIER = "1" Then
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                mysql = "SELECT RATE FROM PARTYMULTI WHERE COMPCODE =" & GCompCode & " AND PARTY='" & mbparty & "' AND ITEMID =" & LSItemid & ""
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec.EOF Then
                                    LMultiQty = (LQTY * TRec!Rate) - LQTY
                                Else
                                    Set TRec = Nothing
                                    Set TRec = New ADODB.Recordset
                                    mysql = "SELECT RATE FROM PARTYMULTI WHERE COMPCODE =" & GCompCode & " AND PARTY='" & mbparty & "' AND EXID =" & LSEXID & " AND ITEMCODE ='' "
                                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                    If Not TRec.EOF Then
                                        LMultiQty = (LQTY * TRec!Rate) - LQTY
                                    End If
                                End If
                            End If
                        End If
                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LSEXID)
                        End If
                        If LBrokerType = "A" Then
                            MSPARTY = LClient
                            MSPARTY = NewParty(LSExCode, MSPARTY, MSPARTY, LUserId, True)
                        End If
                        If LenB(MSPARTY) < 1 Then
                            LMsgBox = " Please Create Account for" & LClient & ""
                            ImportIssues (LMsgBox)
                            GoTo FFlag_Next
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        
                        'If LPartyAs = "F" Then lclientcode = TRec!CLIENTCODE
                        If LOverwrite = False Then If Chk_Trade(LSSaudaCode, LOConNo, LSCondate, MSPARTY, LSPtyContype) = True Then GoTo FFlag_Next
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                        MCount = MCount + 1
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
                        LACCID = Get_AccID(mbparty)
                        Lbrokerid = Get_AccID(MSPARTY)
                        If LACCID = 0 Or Lbrokerid = 0 Then
                            LMsgBox = "Invalid Party / Broker Code "
                            ImportIssues (LMsgBox)
                            GoTo FFlag_Next
                        End If
                        If LExcelFileType = 106 Then
                            Dim MCLCODE As String
                            Dim MCONCODE As String
                            mysql = "SELECT ROWNO1,CLCODE,CONCODE from  CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND filetype =  '" & LExcelFileType & "' AND  PARTY = '" & mbparty & "' and CONTYPE = '" & LSPtyContype & "'  AND ROWNO1 ='" & LOConNo & "'"
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec.EOF Then
                                MCLCODE = TRec!CLCODE
                                MCONCODE = TRec!CONCODE
                                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND CLCODE = '" & MCLCODE & "' AND CONCODE = '" & MCONCODE & "' AND ROWNO1 ='" & LOConNo & "'"
                                Cnn.Execute mysql
                            End If
                        End If
                        
                        Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, LExcelFileType, "Y", LSEXID, LSItemid, LSSaudaID)
                        If LMultiQty <> 0 Then
                            MCount = MCount + 1
                            MSPARTY = LExCont
                            Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LMultiQty, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, LExcelFileType, "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If
FFlag_Next:
                    TxtRec.MoveNext
                Wend
            End If
        End If
        If LBrokerType = "Z" Then
            mysql = "SELECT CONNO,ORDNO FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "' AND EXCODE='NSE' And DATAIMPORT = 1 AND CONCODE <>PARTY "
            mysql = mysql & " ORDER BY ORDNO"
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            Do While Not TRec.EOF
                LOrdNo = TRec!ORDNO
                MCount = TRec!CONNO
                mysql = "UPDATE CTR_D SET BROKFLAG='N' ,BROKRATE =0 WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "'"
                mysql = mysql & " AND EXCODE='NSE' And DATAIMPORT = 1 AND ORDNO ='" & LOrdNo & "' AND CONNO <>" & MCount & ""
                Cnn.Execute mysql
                Do While LOrdNo = TRec!ORDNO
                    TRec.MoveNext
                    If TRec.EOF Then Exit Do
                Loop
                If TRec.EOF Then Exit Do
            Loop
        End If
    Next
    
    Cnn.CommitTrans
    CNNERR = False
    LMsgBox = " No Of Trade:  " & LNoTrd & " Imported From Folder " & PFOLDERNAME & ""
    ImportIssues (LMsgBox)
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Trade_Ncdex_OnLBkp_ODIN()
    Dim ltradedt As Date:    Dim TxtPath As String:    Dim LFileName As String:    Dim LMFLPath As String:    Dim LOverwrite As Boolean
    Call GET_JCnn("\NCDX;")
    Cnn.BeginTrans
    LSExCode = "NCDX"
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        LOverwrite = IIf(Check14 = 1, False, True)
        LMFLPath = App.Path & "\NCDX\"
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "_" & LMemberId & ".TXT"
        Call Create_SchemaFile(LMFLPath, TxtPath)
        LFileName = App.Path & "\NCDX\" & TxtPath
            
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "NCDX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "NCDX")
        End If
        Set LFileSystemObject = Nothing
                
        ' MAINBROKER FILE NCDEX DIRECT
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            Call Save_NCDEX_Trade(LOverwrite)
        End If
        ' MAINBROKER FILE ODIN DIRECT
        Call GET_JCnn("\NCDX;")
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "NCDEX" & ".TXT"
        LMFLPath = App.Path & "\NCDX\"
        Call Create_SchemaFile(LMFLPath, TxtPath)
        LFileName = App.Path & "\NCDX\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            Call Save_NCDEX_M_ODIN
        End If
        
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
End Sub
Sub Save_NCDEX_M_ODIN()
    Dim MSPARTY As String:     Dim LSCondate As Date
    Dim LOConNo As String:     Dim mparty As String
    Dim mbparty As String:     Dim LUserId As String:
    Dim LConType As String:    Dim LClient As String:
    
    If Not TxtRec.EOF Then
        FlagDataTrf = True:        CNNERR = True:
        LSExCode = "NCDX":
        'Call Get_ExDetail(LSExCode)
        If LenB(LExCont) = 0 Then Exit Sub
        MSPARTY = LExCont
        TxtRec.MoveFirst
        DoEvents
        GETMAIN.Label1.Caption = "Updating ODIN NCDEX File Trade "
        While Not TxtRec.EOF
            If TxtRec!F18 = LMemberId Then
                LConType = "B"
                LOConNo = Mid(TxtRec!F1, 9, Len(TxtRec!F1) - 8)
                LConType = TxtRec!F14
                If IsNull(TxtRec!F18) Then
                    mparty = TxtRec!f19
                Else
                    mparty = TxtRec!F18
                End If
                LUserId = TxtRec!f12
                If Right$(LMemberId, 3) = Right$(mparty, 3) Then mparty = TxtRec!f12
                LSCondate = DateValue(TxtRec!f22)
                If LConType = "1" Then
                    LConType = "B"
                Else
                    LConType = "S"
                End If
                LClient = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, True)
                mysql = "UPDATE CTR_D SET PARTY='" & LClient & "', USERID='" & LUserId & "' WHERE COMPCODE =" & GCompCode & " AND CONDATE='" & Format(LSCondate, "YYYY/MM/DD") & "' "
                mysql = mysql & " AND CONTYPE='" & LConType & "' AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS AND PARTY <> '" & LExCont & "'"
                Cnn.Execute mysql
            End If
            TxtRec.MoveNext
            DoEvents
        Wend
        FlagDataTrf = True
    End If
End Sub
Sub Trade_MCX_OnLBkp_ODIN()
    Dim LOverwrite As Boolean:    Dim ltradedt As Date:    Dim TxtPath As String:       Dim LFileName As String
    Dim LMFLPath As String
    LOverwrite = True
    Call GET_JCnn("\MCX;")
    Cnn.BeginTrans
    LSExCode = "MCX"
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        LOverwrite = IIf(Check14 = 1, False, True)
        TxtPath = "MCX_TRD" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".CSV"
        LFileName = App.Path & "\MCX\" & TxtPath
        LMFLPath = App.Path & "\MCX\"
        
        
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "MCX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "MCX")
        End If
        Set LFileSystemObject = Nothing
        
            ' MAINBROKER FILE MCX DIRECT
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            Call Save_MCX_ODIN(LOverwrite, ltradedt)
            FlagDataTrf = True
        End If
            ' MAINBROKER FILE ODIN DIRECT
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "MCX.TXT"
        Call Create_SchemaFileMCX(LMFLPath, TxtPath)
        LFileName = App.Path & "\MCX\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            Call SAVE_MCX_M_ODIN
            FlagDataTrf = True
        End If
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
End Sub
Sub Save_MCX_ODIN(MOVERWRITE As Boolean, LPTradedt As Date)
    Dim LOrdParty  As String:       Dim LOverwrite As Boolean: Dim TRec As ADODB.Recordset:
    Dim LSCondate As Date:          Dim MCount As Long:                 Dim LQTY As Double:                 Dim LRATE As Double:
    Dim LFileName As String:        Dim LUserId As String:              Dim LOConNo As String:              Dim MSPARTY As String
    Dim LSItemName As String:       Dim LOrdNo As String:               Dim LOrdTime As String:             Dim TxtPath As String
    Dim LContime As String:         Dim LStrMaturity As String:         Dim LPartyName As String:           Dim LConType As String:
    Dim mparty As String:           Dim LClient As String:              Dim LEXHCODE As String:             Dim LSPtyContype As String:
    Dim mbparty As String:          Dim LSConSno As Long:               Dim LMFLPath As String::            Dim LNoTrd  As Long
    Dim LACCID As Long
    Dim Lbrokerid As Long
    
    On Error GoTo err1
    If Not TxtRec.EOF Then
        FlagDataTrf = True
        If LBrokerType = "9" Then 'Murli Bhaiya File
            LSCondate = Format(TxtRec!F2, "yyyy/MM/dd")
        ElseIf LODIN = True Then
            If LBrokerType = "N" Then
                LSCondate = Format(TxtRec!F21, "yyyy/MM/dd")
            Else
                LSCondate = Format(TxtRec!f22, "yyyy/MM/dd")
            End If
        ElseIf LPTradedt > "18/02/2005" And LBrokerType <> "N" Then
            LSCondate = DateValue(Format(TxtRec!f25, "yyyy/MM/dd"))
        Else
            LSCondate = Format(TxtRec!f22, "yyyy/MM/dd")
        End If
        MCount = Get_Max_ConNo(LSCondate, 0)
        LSExCode = "MCX"
        If MOVERWRITE = True Then  ' OVERWRITE
            If LODIN = False Then
                 Call PDelete_CTR_D(LSCondate, LSExCode, vbNullString)
            Else
                Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE  = '" & Format(LSCondate, "yyyy/MM/dd") & "'  AND DATAIMPORT =1 AND EXCODE IN ('NCDX''MCX')"
            End If
        End If
        TxtRec.MoveFirst
        LNoTrd = 0
        While Not TxtRec.EOF
            LSPtyContype = "B"
            LOConNo = vbNullString:       LOrdTime = vbNullString:          LOrdNo = vbNullString:      LContime = vbNullString:
            LUserId = vbNullString:       mparty = vbNullString:            LQTY = 0:                   LRATE = 0:                   LLOT = 1:
            LPartyName = vbNullString:    LSItemCode = vbNullString:        LSItemName = vbNullString:  LSSaudaCode = vbNullString:
            LSExCode = "MCX":             LSInstType = "FUT":               LSOptType = vbNullString:              LSStrike = 0:                LOrdParty = vbNullString
            LSEXID = 0:                   LSItemid = 0:                     LSSaudaID = 0
            If LODIN = True Then
                If LBrokerType = "N" Then
                    LSCondate = DateValue(TxtRec!F21):          LContime = Right$(TxtRec!F21, 8)
                    LEXHCODE = TxtRec!F8:                       LOConNo = Trim(TxtRec!F28)
                    LSExCode = TxtRec!F4
                Else
                    LSCondate = DateValue(TxtRec!f22):          LContime = Right$(TxtRec!f22, 8)
                    LEXHCODE = TxtRec!F8:                       LOConNo = Trim(TxtRec!F28)
                    LSExCode = TxtRec!F4:                       LOrdNo = Trim(TxtRec!f25)
                End If
                LSMaturity = DateValue(Left$(TxtRec!F9, 2) & "/" & Mid(TxtRec!F9, 4, 3) & "/" & Right$(TxtRec!F9, 2))
                LUserId = TxtRec!f3:                LConType = TxtRec!F14
                If LConType = "B" Then
                    LConType = "1"
                Else
                    LConType = "2"
                End If
                mparty = Trim(TxtRec!F18):                      LPartyName = Trim(TxtRec!F18):
                LQTY = Val(TxtRec!F15) * LLOT:                  LRATE = Val(TxtRec!f16)
            ElseIf LPTradedt > "18/02/2005" And LBrokerType <> "N" Then
                LSCondate = Format(TxtRec!f25, "yyyy/MM/dd"):                LContime = Right$(TxtRec!f25, 8)
                LEXHCODE = TxtRec!F5:                                   LOConNo = Trim(TxtRec!F1)
                LUserId = TxtRec!f11:                                        LConType = TxtRec!f16
                LRATE = Val(TxtRec!F18):                                     LQTY = Val(TxtRec!F17)
                LClient = TxtRec!F20:                                        LOrdNo = TxtRec!f27 & ""
                LOrdTime = TxtRec!F26:                                       LSStrike = Val(TxtRec!F8 & vbNullString)
                LSOptType = (TxtRec!F9 & vbNullString):                      LSInstType = Left$(TxtRec!F4, 3)
                If IsDate(TxtRec!f6) Then
                    LSMaturity = DateValue(TxtRec!f6)
                Else
                    LSMaturity = DateValue(Left$(TxtRec!f6, 2) & "/" & Mid(TxtRec!f6, 3, 3) & "/" & Right$(TxtRec!f6, 4))
                End If
                If LBrokerType = "M" Then
                    If LProAs = "U" Then
                        mparty = Trim(TxtRec!F14)
                        LPartyName = Trim(TxtRec!F14)
                    Else
                        mparty = Trim(TxtRec!F20)
                        LPartyName = Trim(TxtRec!F20)
                    End If
                End If
            Else
                LSCondate = Format(TxtRec!f22, "yyyy/MM/dd"):       LContime = Right$(TxtRec!f22, 8)
                LEXHCODE = TxtRec!F4:                               LOConNo = Trim(TxtRec!F28)
                LOrdNo = IIf(IsNull(TxtRec!F26), "", TxtRec!F26):   LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Right$(TxtRec!F5, 4))
                LUserId = TxtRec!F13:                               LConType = TxtRec!F14
                LRATE = Val(TxtRec!f16):                            LQTY = Val(TxtRec!F15)
            End If
            DoEvents
            GETMAIN.Label1.Caption = "Importing Trades " & LSCondate & " " & LOConNo & " "
            LSEXID = Get_ExID(LSExCode)
            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, True, 1)
            If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
            Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
            If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
            LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
            If LLotWise = "N" Then
                Set TRec = Nothing:                Set TRec = New ADODB.Recordset
                mysql = "SELECT TRADEABLELOT FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & "  AND SAUDAID=" & LSSaudaID & ""
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then LQTY = LQTY * TRec!TRADEABLELOT
            End If
            MSPARTY = LExCont
            '--WITH REMARKS
            LOrdParty = vbNullString
            If Check12.Value Then LOrdParty = TxtRec!f27 & vbNullString
            If LConType = "2" Then LSPtyContype = "S"
            mbparty = NewParty(LSExCode, mparty, LPartyName & " " & LSExCode, LUserId, True)
            If LenB(mbparty) < 1 Then GoTo EFlag_Next
            If MOVERWRITE = False Then If Chk_Trade(LSSaudaCode, LOConNo, LSCondate, MSPARTY, LSPtyContype) = True Then GoTo EFlag_Next
            
            If InStr(LBillExId, str(LSEXID)) = 0 Then
                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
            MCount = MCount + 1
            LNoTrd = LNoTrd + 1
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
            DoEvents
            LACCID = Get_AccID(mbparty)
            Lbrokerid = Get_AccID(MSPARTY)
            If LACCID = 0 Or Lbrokerid = 0 Then
                LMsgBox = "Invalid Party / Broker Code "
                ImportIssues (LMsgBox)
                GoTo EFlag_Next
            End If
                        
            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
            Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
EFlag_Next:
        TxtRec.MoveNext
    Wend
End If
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
        
    End If
End Sub
Sub SAVE_MCX_M_ODIN()
    Dim LOConNo As String:    Dim LConType As String:   Dim mparty As String:       Dim LUserId As String
    Dim LSCondate As Date:    Dim LClient As String:
    
    If Not TxtRec.EOF Then
        FlagDataTrf = True
        CNNERR = True
        LSExCode = "MCX"
        Call Get_ExDetail(LSExCode)
        If LenB(LExCont) = 0 Then Exit Sub
        TxtRec.MoveFirst
        GETMAIN.Label1.Caption = "Updating ODIN MCX file " & LSCondate & " "
        While Not TxtRec.EOF
            LOConNo = TxtRec!F1
            LConType = TxtRec!f16:              mparty = TxtRec!F20
            LUserId = TxtRec!F14
            If TxtRec!f19 = "2" Then mparty = TxtRec!F14
            LSCondate = DateValue(TxtRec!f25)
            If LConType = "1" Then
                LConType = "B"
            Else
                LConType = "S"
            End If
            LClient = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, True)
            mysql = "UPDATE CTR_D SET PARTY='" & LClient & "', USERID ='" & LUserId & "' WHERE COMPCODE =" & GCompCode & " AND CONDATE='" & Format(LSCondate, "YYYY/MM/DD") & "' AND CONTYPE ='" & LConType & "' AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS  AND PARTY<>'" & LExCont & "'"
            Cnn.Execute mysql
            TxtRec.MoveNext
        Wend
        FlagDataTrf = True
    End If
End Sub

Sub Save_MCX_Trade(MOVERWRITE As Boolean, LTTradeDt As Date, Optional PFOLDERNAME As String, Optional LExcelFileType As Integer, Optional LBrokerCode As String, Optional lclientid As String, Optional LBrokerType As String)
    Dim MRec As ADODB.Recordset:    Dim LSTRCONDATE  As String:         Dim LADate As Date:                 Dim TRec As ADODB.Recordset:
    Dim LLCODE As String:           Dim LMarginAcc As String:           Dim LCONTIME2 As String:            Dim LRate2 As Double
    Dim LSCondate As Date:          Dim MCount As Long:                 Dim LQTY As Double:                 Dim LRATE As Double
    Dim fld As ADODB.Field:         Dim TxtPath As String:              Dim LMONTH As String:               Dim lyear As Integer:
    Dim LFieldName As String:       Dim LOrdParty  As String:           Dim LMFLPath As String:             Dim LFileName As String
    Dim LUserId As String:          Dim LOConNo As String:              Dim LStrMonth As String:            Dim LOrdNo As String
    Dim LContime As String:         Dim LStrMaturity As String:         Dim LPartyName As String:           Dim LCMONTH  As String:
    Dim mparty As String:           Dim LClient As String:              Dim LSPtyContype As String:
    Dim LEXHCODE As String:         Dim MSPARTY As String:              Dim LMultiQty As Double:            Dim LNoTrd  As Long
    Dim mbparty As String:          Dim LSConSno As Long:               Dim LConType As String:             Dim LOverwrite As Boolean
    Dim LOrdTime As String:         Dim LSTR As String:                 Dim A  As String:
    
    On Error GoTo err1
    If Len(PFOLDERNAME) > 0 Then
        If LExcelFileType <> 106 Then
            PFOLDERNAME = "MCX"
        End If
    Else
        PFOLDERNAME = "MCX"
        'Call GET_JCnn("\NSE;")
    End If
    
    If LExcelFileType <> 106 Then
        LExcelFileType = "0"
    End If

    Call GET_JCnn("\" & PFOLDERNAME & ";")

    LSExCode = "MCX"
    On Error GoTo err1
    LMarginAcc = vbNullString
    Set TRec = Nothing:    Set TRec = New ADODB.Recordset
    mysql = "SELECT MARGINACC,MEMBERID FROM EXMAST WHERE COMPCODE =" & GCompCode & "  AND  EXCODE ='MCX'"
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        LMarginAcc = IIf(IsNull(TRec!MarginACC), vbNullString, TRec!MarginACC)
        If LBrokerType = "E" Then
            lexceltype = IIf(TRec!MemberId = "", 0, TRec!MemberId & vbNullString)
            'If lexceltype = 0 Then
            '    MsgBox "Please Define Excel Type in MCX Exchange "
            '    Exit Sub
            'End If
        End If

        
    End If
    If LenB(LMarginAcc) = 0 Then
        MsgBox "Please Define Margin Account in MCX Exchange "
        Exit Sub
    End If
    If Not TxtRec.EOF Then
        FlagDataTrf = True
        If IsNull(TxtRec!F2) Then TxtRec.MoveNext
        If LBrokerType = "I" Then
            LSTRCONDATE = Left$(TxtRec!F4, 10)
            LSCondate = DateValue(Mid(LSTRCONDATE, 4, 2) & "/" & Left$(LSTRCONDATE, 2) & "/" & Right$(LSTRCONDATE, 4))
        ElseIf LBrokerType = "X" Then
            LSCondate = DateValue(DateValue(TxtRec!f25))
        ElseIf LBrokerType = "E" Then
            LSCondate = LTTradeDt
        ElseIf LBrokerType = "D" Then
            LSCondate = DateValue(Left$(TxtRec!f11, 10))
        ElseIf LBrokerType = "T" Then
            If LPartyAs = "C" Then
                LSTRCONDATE = Left$(TxtRec!F9, 10)
                LSCondate = DateValue(Mid(LSTRCONDATE, 4, 2) & "/" & Left$(LSTRCONDATE, 2) & "/" & Right$(LSTRCONDATE, 4))
                LTMinDate = LSCondate:                LTMaxDate = LSCondate
            Else
                LSTRCONDATE = Left$(TxtRec!F9, 10)
                If Right$(LSTRCONDATE, 4) = "2013" Or Right$(LSTRCONDATE, 4) = "2014" Then
                    LSCondate = DateValue(Left$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 2) & "/" & Right$(LSTRCONDATE, 4))
                Else
                    LSCondate = DateValue(Right$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left$(LSTRCONDATE, 4))
                End If
                LTMinDate = LSCondate
                LTMaxDate = LSCondate
            End If
        ElseIf LBrokerType = "X" Then
            LSCondate = DateValue(TxtRec!F20)
        ElseIf LODIN = True Then
            If LBrokerType = "N" Then
                LSCondate = DateValue(TxtRec!f22)
            ElseIf LBrokerType = "C" Then
                LSCondate = DateValue(TxtRec!F24)
            ElseIf LBrokerType = "S" Then
                LSCondate = DateValue(TxtRec!f25)
            Else
                LSCondate = DateValue(TxtRec!F21)
            End If
        ElseIf LTTradeDt > "18/02/2005" And LTTradeDt <= "19/12/2008" And LBrokerType <> "N" Then
            LSCondate = DateValue(TxtRec!F24)
        ElseIf LTTradeDt > "19/12/2008" And LBrokerType <> "N" Then
            If IsDate(TxtRec!f25) Then
                LSCondate = DateValue(TxtRec!f25)
            Else
                LSCondate = DateValue(TxtRec!f22)
            End If
        Else
            LSCondate = DateValue(TxtRec!f22)
        End If
        Cnn.BeginTrans
        CNNERR = True
        MCount = Get_Max_ConNo(LSCondate, 0)
        If MOVERWRITE = True And LExcelFileType <> 106 Then
            If LBrokerType <> "T" Then
                If LBrokerType = "D" Then
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT =1 "
                ElseIf LBrokerType = "E" Then
                 '   Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT =1 and FILETYPE ='" & LExcelType & "'"
                ElseIf LODIN = False And LBrokerType <> "I" Then
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND FILETYPE = '" & Trim(lexceltype) & "'  AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT =1 AND EXCODE ='" & LSExCode & "'"
                    Cnn.Execute mysql
                    
                ElseIf LBrokerType = "I" Then
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT =1 AND EXCODE IN ('NCDX','MCX') "
                Else
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT =1 AND EXCODE ='MCX'"
                End If
            Else
                Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "'  AND DATAIMPORT =1 AND EXCODE ='MCX'"
            End If
        End If
        TxtRec.MoveFirst
        LNoTrd = 0
        While Not TxtRec.EOF
            LSPtyContype = "B"
            LOConNo = vbNullString:     LOrdTime = vbNullString:    LOrdNo = vbNullString:    LContime = vbNullString:
            LQTY = 0:                   LRATE = 0:                  LLOT = 1:                 LPartyName = vbNullString:   LSItemCode = vbNullString
            LSExCode = "MCX":           LSInstType = "FUT":         LSOptType = vbNullString:  LSStrike = 0:                LOrdParty = vbNullString
            LRate2 = 0:                 LCONTIME2 = vbNullString:   LUserId = vbNullString:   mparty = vbNullString:       LSItemName = vbNullString
            LSSaudaCode = vbNullString: LSEXID = 0: LSItemid = 0:   LSSaudaID = 0
            LMultiQty = 0
            If IsNull(TxtRec!F1) Then GoTo EFlag_Next
            If TxtRec!F1 = "Trade Date" Then GoTo EFlag_Next
            MCount = MCount + 1
            If LBrokerType = "X" Then
                 LSCondate = Format(TxtRec!f25, "yyyy/MM/dd"):       LContime = Right$(TxtRec!f25, 8)
                 LEXHCODE = TxtRec!F5:                               LOConNo = Trim(TxtRec!F1)
                 LOrdNo = IIf(IsNull(TxtRec!F26), "", TxtRec!F26):   LUserId = TxtRec!F14
                 LConType = TxtRec!f16:                              mparty = Trim(TxtRec!F20) 'USERID
                 LPartyName = Trim(TxtRec!F20):                      LRATE = Val(TxtRec!F18)
                 LQTY = Val(TxtRec!F17)
                 If Len(TxtRec!f6) = 10 Then
                    LSMaturity = DateValue(Left$(TxtRec!f6, 2) & "/" & Mid(TxtRec!f6, 4, 2) & "/" & Right$(TxtRec!f6, 4))
                 Else
                   LSMaturity = DateValue(Left$(TxtRec!f6, 2) & "/" & Mid(TxtRec!f6, 3, 3) & "/" & Right$(TxtRec!f6, 4))
                 End If
            ElseIf LBrokerType = "D" Then
                LSCondate = Format(Left$(TxtRec!f11, 10), "yyyy/MM/dd"):                LContime = Right$(TxtRec!f11, 8)
                LEXHCODE = TxtRec!f3:                                                   LQTY = Val(TxtRec!F7)
                LOConNo = str(MCount):                                                  LOrdNo = LOConNo
                LSMaturity = DateValue(Left$(TxtRec!F4, 10)):                           LUserId = TxtRec!F1
                LConType = Left$(TxtRec!f6, 1):                                         mparty = Trim(TxtRec!F1) 'USERID
                LPartyName = Trim(TxtRec!F2):                                           LRATE = Val(TxtRec!F8)
                If LConType = "B" Then
                    LConType = "1"
                Else
                    LConType = "2"
                End If
            ElseIf LBrokerType = "I" Then
                If TxtRec!F1 = "" Then GoTo EFlag_Next
                mysql = "SELECT ACEXCODE FROM ACCT_EX WHERE COMPCODE =" & GCompCode & "  AND ACEXCODE ='" & LUserId & "'"
                Set MRec = Nothing:                    Set MRec = New ADODB.Recordset
                MRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If MRec.EOF Then GoTo EFlag_Next
                LSCondate = DateValue(TxtRec!f25):                   LContime = Right$(TxtRec!f25, 11)
                LEXHCODE = TxtRec!F5:                                LOConNo = Trim(TxtRec!F1):
                LSMaturity = DateValue(TxtRec!f6):                   LUserId = TxtRec!F14:
                mparty = Trim(TxtRec!F20):                           LPartyName = Trim(TxtRec!F20)
                LQTY = Val(TxtRec!F17) * LLOT:                       LRATE = Val(TxtRec!F18)
                LConType = Left$(TxtRec!f16, 1):
                
            ElseIf LBrokerType = "C" Then
                    LSCondate = DateValue(TxtRec!F24):                               LContime = Right$(TxtRec!F24, 8)
                    LEXHCODE = TxtRec!F4:
                    LOConNo = Trim(TxtRec!F1):                                      LSExCode = "MCX"
                    LOrdNo = Trim(TxtRec!F26):                                       LConType = TxtRec!F15
                    mparty = Trim(TxtRec!f19):                                       LPartyName = Trim(TxtRec!f19)
                    LQTY = Val(TxtRec!f16) * LLOT:                                   LRATE = Val(TxtRec!F17)
                    LClient = mparty
                    LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Right$(TxtRec!F5, 4))
            ElseIf LODIN = True Then
                If LBrokerType = "N" Then
                    LSCondate = DateValue(TxtRec!f22):                               LContime = Right$(TxtRec!f22, 8)
                    LEXHCODE = TxtRec!F8:                                            LOConNo = Trim(TxtRec!F21)
                    LSExCode = TxtRec!F4:                                            If LSExCode = "NCDEX" Then LSExCode = "NCDX"
                    LOrdNo = Trim(TxtRec!F21):                                       LConType = TxtRec!F14
                    LUserId = Trim(TxtRec!F1):                                       mparty = Trim(TxtRec!F18) 'USERID
                    LQTY = Val(TxtRec!F15) * LLOT:                                   LRATE = Val(TxtRec!f16)
                    LPartyName = Trim(TxtRec!F18)
                ElseIf LBrokerType = "C" Then
                    LSCondate = DateValue(TxtRec!F24):                               LContime = Right$(TxtRec!F24, 8)
                    LEXHCODE = TxtRec!F4:
                    LOConNo = Trim(TxtRec!F1):                                       LSExCode = "MCX"
                    LOrdNo = Trim(TxtRec!F26):                                       LConType = TxtRec!F15
                    mparty = Trim(TxtRec!f19):                                       LPartyName = Trim(TxtRec!f19)
                    LQTY = Val(TxtRec!f16) * LLOT:                                   LRATE = Val(TxtRec!F17)
                Else
                    LSCondate = DateValue(TxtRec!F21):                               LContime = Right$(TxtRec!F21, 8)
                    LEXHCODE = TxtRec!F8:
                    LOConNo = Trim(TxtRec!F20):                                      LSExCode = TxtRec!F4
                    LOrdNo = Trim(TxtRec!f19):                                       LConType = TxtRec!F14
                    mparty = Trim(TxtRec!F18):                                       LPartyName = Trim(TxtRec!F18)
                    LQTY = Val(TxtRec!F15) * LLOT:                                   LRATE = Val(TxtRec!f16)
                End If
                LClient = mparty
                LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Right$(TxtRec!F5, 4))
                'If LConType = "B" Then
                 '   LConType = "1"
                'Else
                 '   LConType = "2"
                'End If
            ElseIf LTTradeDt > "18/02/2005" And LTTradeDt <= "19/12/2008" And LBrokerType <> "N" Then
                LSCondate = DateValue(TxtRec!F24):                LContime = Right$(TxtRec!F24, 8)
                LEXHCODE = TxtRec!F5:                      LOConNo = Trim(TxtRec!F1)
                LUserId = TxtRec!F14:                             LConType = TxtRec!F15
                LRATE = Val(TxtRec!F17):                          LQTY = Val(TxtRec!f16)
                If LBrokerType = "C" Then
                    LOrdNo = IIf(IsNull(TxtRec!F30), "", TxtRec!F26)
                Else
                    LOrdNo = IIf(IsNull(TxtRec!f25), "", TxtRec!f25)
                End If
            ElseIf LTTradeDt > "19/12/2008" And LBrokerType <> "N" Then
                LOConNo = Trim(TxtRec!F1):                LSInstType = Left$(TxtRec!F4, 3)
                LEXHCODE = TxtRec!F5:
                If LSInstType <> "FUT" Then
                    LSStrike = Val(TxtRec!F8 & "")
                    LSOptType = TxtRec!F9 & ""
                End If
                If Len(TxtRec!f6) = 10 Then
                    LSMaturity = DateValue(Left$(TxtRec!f6, 2) & "/" & Mid(TxtRec!f6, 4, 2) & "/" & Right$(TxtRec!f6, 4))
                Else
                    If Mid(TxtRec!f6, 3, 1) = "-" Then
                        LSMaturity = DateValue(Left$(TxtRec!f6, 2) & "/" & Mid(TxtRec!f6, 4, 3) & "/20" & Right$(TxtRec!f6, 2))
                    Else
                        LSMaturity = DateValue(Left$(TxtRec!f6, 2) & "/" & Mid(TxtRec!f6, 3, 3) & "/20" & Right$(TxtRec!f6, 2))
                    End If
                End If
                If LBrokerType <> "O" Then
                    LUserId = TxtRec!F14
                Else
                    LUserId = TxtRec!F14
                    If LBrokerType = "O" Then
                        LUserId = TxtRec!F14
                        LFieldName = "F35"
                        For Each fld In TxtRec.Fields
                            If UCase(fld.NAME) = LFieldName Then
                                If Not IsNull(TxtRec!F35) Then LUserId = Right$(TxtRec!F35, 5)
                                Exit For
                            End If
                        Next
                    End If
                End If
                LConType = TxtRec!f16:                    LQTY = Val(TxtRec!F17)
                LRATE = Val(TxtRec!F18):                  mparty = Trim(TxtRec!F20)
                LPartyName = Trim(TxtRec!F20):            LClient = Trim(TxtRec!F20)
                LSCondate = DateValue(TxtRec!f25):        LContime = Right$(TxtRec!f25, 8)
                If LBrokerType = "C" Then
                    LOrdNo = IIf(IsNull(TxtRec!F26), "", TxtRec!F26)
                Else
                    LOrdNo = IIf(IsNull(TxtRec!f27), "", TxtRec!f27)
                End If
                LOrdTime = TxtRec!F26
            
            ElseIf LBrokerType = "N" Then
                LContime = Right$(TxtRec!f22, 8):               LEXHCODE = TxtRec!F8
                LOConNo = Trim(TxtRec!F21):                     LOrdNo = IIf(IsNull(TxtRec!F20), "", TxtRec!F20)
                LUserId = TxtRec!f3:                            LConType = TxtRec!F14
                LClient = Trim(TxtRec!F18):                     mparty = Trim(TxtRec!F18)
                LPartyName = Trim(TxtRec!f19):                  LRATE = Val(TxtRec!f16)
                LQTY = Val(TxtRec!F15)
                If Len(TxtRec!F9) = 10 Then
                    LSMaturity = DateValue(Left$(TxtRec!F9, 2) & "/" & Mid(TxtRec!F9, 4, 2) & "/" & Right$(TxtRec!F9, 4))
                Else
                    LSMaturity = DateValue(Left$(TxtRec!F9, 2) & "/" & Mid(TxtRec!F9, 4, 3) & "/20" & Right$(TxtRec!F9, 2))
                End If
                If LConType = "B" Then
                    LConType = "1"
                Else
                    LConType = "2"
                End If
            Else
                LSCondate = DateValue(TxtRec!f22):                 LContime = Right$(TxtRec!f22, 8)
                LEXHCODE = TxtRec!F4:
                LOConNo = Trim(TxtRec!F28):                        LOrdNo = IIf(IsNull(TxtRec!F26), "", TxtRec!F26)
                LUserId = Trim(TxtRec!F13):                        LClient = Trim(TxtRec!F20)
                mparty = Trim(Trim(TxtRec!F20)):                   LPartyName = Trim(TxtRec!F20)
                LRATE = Val(TxtRec!F18):                           LQTY = Val(TxtRec!F17)
                LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Right$(TxtRec!F5, 4))
            End If
            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, True, 1)
            If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
            Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
            If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
            If LBrokerType <> "T" Then
                If LLotWise = "N" Then
                    mysql = "SELECT TRADEABLELOT FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND SAUDAID =" & LSSaudaID & ""
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then LQTY = LQTY * TRec!TRADEABLELOT
                End If
            End If
            MSPARTY = LExCont
            If LPartyAs = "U" And LBrokerType <> "T" Then
                mparty = LUserId
                LPartyName = LUserId
            End If
            If LPartyAs = "F" Then mparty = LClientCode
            
            If Check12.Value = 1 Then
                If Not IsNull(TxtRec!f29) Then
                    If LenB(TxtRec!F28) <> 0 Then
                        mparty = TxtRec!f29
                        LPartyName = TxtRec!f29
                    End If
                End If
            End If
            If LConType = "2" Then LSPtyContype = "S"
            If LenB(mparty) = 0 Then GoTo EFlag_Next
            If LPartyAs = "F" Then
                mbparty = mparty
            Else
                mbparty = NewParty(LSExCode, mparty, LPartyName, LUserId, True)
            End If
            
            If LenB(mbparty) = 0 Then GoTo EFlag_Next
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT BROKER FROM EXBROKCLIENT WHERE COMPCODE =" & GCompCode & " AND CLIENT ='" & mbparty & "'"
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            If Not TRec.EOF Then MSPARTY = TRec!BROKER
            If LBrokerType = "T" Or LBrokerType = "E" Or LExcelFileType = 106 Then
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & "  AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS AND CONDATE='" & Format(LSCondate, "YYYY/MM/DD") & "' AND SAUDA='" & LSSaudaCode & "' AND CONCODE ='" & LExCont & "'"
                Cnn.Execute mysql
            End If
            
            If LenB(mbparty) = 0 Then GoTo EFlag_Next
            If MOVERWRITE = False Then If Chk_Trade(LSSaudaCode, LOConNo, LSCondate, MSPARTY, LSPtyContype) = True Then GoTo EFlag_Next
            LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
            MCount = MCount + 1
            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
            If LBrokerType = "A" Then
                MSPARTY = LClient
                MSPARTY = NewParty(LSExCode, MSPARTY, MSPARTY, LUserId, True)
            End If
            If LSCondate > LSMaturity Then
                LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                ImportIssues (LMsgBox)
                'GoTo EFlag_Next
            End If
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT MULTIPLIER FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & mbparty & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                If TRec!MULTIPLIER = "1" Then
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    mysql = "SELECT RATE FROM PARTYMULTI WHERE COMPCODE =" & GCompCode & " AND PARTY='" & mbparty & "' AND ITEMID =" & LSItemid & ""
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LMultiQty = (LQTY * TRec!Rate) - LQTY
                    Else
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT RATE FROM PARTYMULTI WHERE COMPCODE =" & GCompCode & " AND PARTY='" & mbparty & "' AND EXCODE ='MCX'  AND ITEMCODE ='' "
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec.EOF Then
                            LMultiQty = (LQTY * TRec!Rate) - LQTY
                        End If
                    End If
                End If
            End If
            If InStr(LBillExId, str(LSEXID)) = 0 Then
                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
            LNoTrd = LNoTrd + 1
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
            DoEvents
            
            If LExcelFileType = 106 Then
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND filetype =  '" & LExcelFileType & "' AND   ROWNO1 ='" & LOConNo & "'"
            End If
            Call Add_To_Ctr_D(LSPtyContype, mparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, lexceltype, "Y", LSEXID, LSItemid, LSSaudaID)
            If LMultiQty <> 0 Then
                MCount = MCount + 1
                MSPARTY = LExCont
                Call Add_To_Ctr_D(LSPtyContype, mparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LMultiQty, LRATE, MSPARTY, LCONTIME2, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
            End If
            If LRate2 <> 0 Then
                MCount = MCount + 1
                LOConNo = str(MCount)
                If LSPtyContype = "B" Then
                    LSPtyContype = "S"
                Else
                    LSPtyContype = "B"
                End If
                    
                If MOVERWRITE = False Then If Chk_Trade(LSSaudaCode, LOConNo, LSCondate, MSPARTY, LSPtyContype) = True Then GoTo EFlag_Next
                MCount = MCount + 1
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                Call Add_To_Ctr_D(LSPtyContype, mparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRate2, MSPARTY, LCONTIME2, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
            End If
EFlag_Next:
            TxtRec.MoveNext
        Wend
        Cnn.CommitTrans
        CNNERR = False
        LMsgBox = " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
        ImportIssues (LMsgBox)
    End If
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Save_BSE_EQ_Trade()
    Dim LOverwrite As Boolean:      Dim MCount As Long:             Dim LSConSno As Long:
    Dim ltradedt As Date:           Dim LSCondate As Date:          Dim MRec As ADODB.Recordset:
    Dim LQTY As Double:             Dim LRATE As Double:            Dim LUserId As String
    Dim LOConNo As String:          Dim LSItemName As String:       Dim LOrdNo As String
    Dim LContime As String:         Dim LOrdTime As String:         Dim LPtyContype As String
    Dim MSPARTY As String:          Dim LClient As String:          Dim mbparty As String
    Dim mparty As String:           Dim LEXHCODE As String:         Dim TRec As ADODB.Recordset
    Dim TxtPath As String:          Dim LFileName As String:        Dim LConType As String
    Dim LNoTrd As Long
    Dim MFILETYPE As String
    
    On Error GoTo err1
    LSExCode = "BEQ"
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    MSPARTY = LExCont
    If Check14.Value = 0 Then
        LOverwrite = True
    Else
        LOverwrite = False
    End If
    ''
    LSEXID = Get_ExID(LSExCode)
    mysql = "SELECT BROKERTYPE FROM EXMAST WHERE EXID = " & LSEXID & " "
    Set TRec = Nothing:                        Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    
    MFILETYPE = TRec!BROKERTYPE
    
    Cnn.BeginTrans
    CNNERR = True:
     On Error GoTo err1
    Call GET_JCnn("\BEQ;")
    If LenB(LExCont) = 0 Then Exit Sub
    
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "TR" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
        LFileName = App.Path & "\BEQ\" & TxtPath
        
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "BEQ") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "BEQ")
        End If
        Set LFileSystemObject = Nothing
        
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                If MFILETYPE = "O" Then
                    TxtRec.MoveNext
                    A = InStr(TxtRec!F1, "/")
                    LSTRCONDATE = Mid(TxtRec!F1, A - 4, 10)
                    LSCondate = DateValue(LSTRCONDATE)
                Else
                    LSCondate = DateValue(Left(TxtRec!F21, 11))
                    TxtRec.MoveFirst
                End If
                
                LNoTrd = 0
                MCount = Get_Max_ConNo(LSCondate, 0)
                
                If LOverwrite = True Then Cnn.Execute "DELETE FROM CTR_D WHERE EXID =" & LSEXID & "  AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "'  AND DATAIMPORT =1 "
                
                While Not TxtRec.EOF
                    LQTY = 0:       LRATE = 0:      LUserId = vbNullString:           LOConNo = vbNullString:           LSItemCode = vbNullString:
                    LSItemName = vbNullString:      LSSaudaCode = vbNullString:       LSStrike = 0:                     LPtyContype = "B":
                    LOrdNo = vbNullString:          LContime = vbNullString:          LSInstType = "CSH":               LSStrike = 0
                    LSOptType = vbNullString:       LClient = vbNullString:           LConType = vbNullString:          LOrdTime = vbNullString:
                    LSItemid = 0:                    LLOT = 1:                        LSSaudaID = 0
                    
                    If MFILETYPE = "O" Then
                        A = InStr(TxtRec!F1, "|")
                        LSTR = Mid(TxtRec!F1, A + 1, Len(TxtRec!F1) - A)
                        
                        A = InStr(LSTR, "|")
                        LEXHCODE = Left(LSTR, A - 1)
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        LOConNo = Left(LSTR, A - 1)
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        LRATE = Val(Left(LSTR, A - 1))
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        LQTY = Val(Left(LSTR, A - 1))
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        LContime = Left(LSTR, A - 1)
                        
                        
                        A = InStr(LSTR, "|")
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        mparty = Left(LSTR, A - 1)
                        LClient = mparty
                        
                        A = InStr(LSTR, "|")
                        LSTR = Mid(LSTR, A + 1, Len(LSTR) - A)
                        
                        A = InStr(LSTR, "|")
                        LConType = Left(LSTR, A - 1)
                        
                        LSMaturity = DateValue(GFinEnd)
                        MCount = MCount + 1
                        LUserId = ""
                        
                        
                        'LEXHCODE = LSTR
                        'LEXHCODE = LSTR:                     LSItemName = Trim(TxtRec!f3)
                        'LOConNo = Trim(TxtRec!F15):               MCount = MCount + 1
                        'LContime = Trim(TxtRec!F9):               LUserId = TxtRec!f1
                        'LConType = TxtRec!F14:                    LRATE = Val(TxtRec!F5)
                        'LQTY = Val(TxtRec!f6):                    MParty = Trim(TxtRec!F11)
                        'LSMaturity = DateValue(GFinEnd):          LClient = MParty:
                    Else
                        LEXHCODE = TxtRec!f3:                     LSItemName = Trim(TxtRec!f3)
                        LOConNo = Trim(TxtRec!F15):               MCount = MCount + 1
                        LContime = Trim(TxtRec!F9):               LUserId = TxtRec!F1
                        LConType = TxtRec!F14:                    LRATE = Val(TxtRec!F5)
                        LQTY = Val(TxtRec!f6):                    mparty = Trim(TxtRec!f11)
                        LSMaturity = DateValue(GFinEnd):          LClient = mparty:
                   End If
                    
                    Call Get_Item_Details(LEXHCODE, LSItemName, LSItemName, LSExCode, 1, True, True, 1)
                    If Len(LSItemCode) < 0 Then GoTo EFlag_Next
                    Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
                    If Len(LSSaudaCode) < 0 Then GoTo EFlag_Next
                    If InStr(LBillExId, str(LSEXID)) = 0 Then
                        If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                        LBillExId = LBillExId & str(LSEXID)
                    End If
                    If lminbilldate > LSCondate Then lminbilldate = LSCondate
                    
                    LNoTrd = LNoTrd + 1
                    GETMAIN.Label1.Caption = "Trade No " & LNoTrd
                    DoEvents
                    If LConType = "S" Then LPtyContype = "S"
                    mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, True)
                    If LOverwrite = False Then If Chk_Trade(LSSaudaCode, LOConNo, LSCondate, MSPARTY, LPtyContype) = True Then GoTo EFlag_Next
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                    Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub MCX_Daily_Client_Margin()
Dim ltradedt As Date:           Dim LSCondate As Date: Dim TRec As ADODB.Recordset:
Dim TxtPath  As String:             Dim LFileName As String:        Dim LClient As String
Dim LParty As String:               Dim LInitialMargin As Double:   Dim LAddMargin As Double
Dim LSpMargin As Double:            Dim LTenderMargin  As Double:   Dim LDeliveryMargin As Double
Dim LExtremeLoss As Double:         Dim LSpreadMargin  As Double:   Dim LPeakMargin As Double
Dim LNetBuyPremium  As Double:      Dim TXTREC2 As ADODB.Recordset: Dim LPeakTxtPath As String
Dim LCount As Integer

On Error GoTo err1

    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    LSExCode = "MCX"
    Call GET_JCnn("\MCX;")
    Call Get_ExDetail("MCX")
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "MCX_MRG_" & LMemberId & "_" & Right$(CStr(Year(ltradedt)), 4) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".CSV"
        LPeakTxtPath = "MCX_PEAKMARGIN" & LMemberId & "_" & Right$(CStr(Year(ltradedt)), 4) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & "02.CSV"
        LFileName = App.Path & "\MCX\" & TxtPath
                
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "MCX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "MCX")
        End If
        Set LFileSystemObject = Nothing
                        
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & " WHERE F1=30"
            TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True:                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                LSEXID = Get_ExID("MCX")
                Cnn.Execute "DELETE FROM DLYCLMGN WHERE EXID  =" & LSEXID & " AND CONDATE  = '" & Format(LSCondate, "yyyy/MM/dd") & "'"
                TxtRec.MoveFirst
                While Not TxtRec.EOF
                    LClient = Trim(TxtRec!F4)
                    LParty = Get_ACCT_EX(LSEXID, LClient)
                    If LenB(LParty) < 1 Then GoTo FLAG_NEXT
                    LInitialMargin = Val(TxtRec!F5 & vbNullString)
                    LSpMargin = Val(TxtRec!f6 & vbNullString)
                    LAddMargin = Val(TxtRec!F7 & vbNullString)
                    LTenderMargin = Val(TxtRec!F8 & vbNullString)
                    LDeliveryMargin = Val(TxtRec!F9 & vbNullString)
                    LExtremeLoss = Val(TxtRec!F17 & vbNullString)
                    LNetBuyPremium = Val(TxtRec!f16 & vbNullString)
                    LSpreadMargin = Val(TxtRec!F10 & vbNullString) * -1
                    
                    mysql = "INSERT INTO DLYCLMGN(COMPCODE, CONDATE, EXCODE, CLIENT,IMARGIN,MMARGIN,SPMARGIN,PreExpMargin,DeliveryMargin ,ExtremeLOSS,SPREADMARGIN,NETBUYPREMIUM,EXID)"
                    mysql = mysql & " VALUES (" & GCompCode & ",'" & Format(LSCondate, "yyyy/MM/dd") & "', '" & LSExCode & "','" & LParty & "',"
                    mysql = mysql & LInitialMargin & "," & LAddMargin & "," & LSpMargin & "," & LTenderMargin & "," & LDeliveryMargin & "," & LExtremeLoss & "," & LSpreadMargin & "," & LNetBuyPremium & "," & LSEXID & ")"
                    Cnn.Execute mysql
FLAG_NEXT:
                    TxtRec.MoveNext
                Wend
            End If
        End If
        LCount = 2
        
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "MCX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "MCX")
        End If
        Set LFileSystemObject = Nothing
        
        Do While LCount <= 6
            LPeakTxtPath = "MCX_PEAKMARGIN" & LMemberId & "_" & Right$(CStr(Year(ltradedt)), 4) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & "_0" & Trim(str(LCount)) & ".CSV"
            LFileName = App.Path & "\MCX\" & LPeakTxtPath
            If FileExist(LFileName) Then
               Set TXTREC2 = Nothing: Set TXTREC2 = New ADODB.Recordset
                mysql = "Select * from " & LPeakTxtPath & ""
                TXTREC2.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                Do While Not TXTREC2.EOF
                    LClient = Trim(TXTREC2!F5)
                    LParty = Get_ACCT_EX(LSEXID, LClient)
                    If LenB(LParty) < 1 Then GoTo FLAG_NEXT2
                    If Val(TXTREC2!F9 & vbNullString) <> 0 Then
                        LPeakMargin = Val(TXTREC2!F9 & vbNullString)
                        mysql = "UPDATE DLYCLMGN SET PEAKMARGIN =" & LPeakMargin & " WHERE EXID =" & LSEXID & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND CLIENT ='" & LParty & "' AND PEAKMARGIN <" & LPeakMargin & ""
                        Cnn.Execute mysql
                    End If
FLAG_NEXT2:
                    TXTREC2.MoveNext
                Loop
            End If
            LCount = LCount + 1
        Loop
                    
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If

End Sub
Sub SAVE_FX_TRADE(ltradedt As Date)
    Dim LIFLAG As Boolean:          Dim LOverwrite As Boolean:      Dim LSCondate As Date
    Dim TxtPath As String:          Dim LFileName As String:        Dim LClient As String
    Dim LConType As String:         Dim LQTY As Double:             Dim LRATE As Double
    Dim LUserId As String:          Dim LOConNo As String:          Dim LSItemName  As String
    Dim LOrdNo As String:           Dim LContime As String:         Dim LOrdTime As String
    Dim LPtyContype  As String:     Dim MCount As Long:             Dim mparty As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LPartyName As String
    Dim LEXHCODE As String:         Dim LSConSno As Long: Dim TRec As ADODB.Recordset:
    Dim LNoTrd  As Long
    
    On Error GoTo err1
    
    LSExCode = "FX"
    If LenB(LExCont) = 0 Then Exit Sub
    Cnn.BeginTrans
    CNNERR = True:
    If Not TxtRec.EOF Then
        FlagDataTrf = True
        TxtRec.MoveFirst
        Select Case LBrokerType
        Case "O"
            'LSCondate = DateValue(TxtRec!F20)
            LSCondate = DateValue(ltradedt)
        Case "C"
            LSCondate = DateValue(TxtRec!f25)
        Case "N"
            LSCondate = DateValue(TxtRec!f29)
        Case "S"
            LSCondate = DateValue(ltradedt)
        Case "T"
            LSCondate = DateValue(ltradedt)
        Case "M"
            LSCondate = DateValue(ltradedt)
        Case Else
            LSCondate = DateValue(TxtRec!f25)
        End Select
        MCount = Get_Max_ConNo(LSCondate, 0)
        LNoTrd = 0
        LSEXID = Get_ExID(LSExCode)
        While Not TxtRec.EOF
            LQTY = 0:                       LRATE = 0:                      LUserId = vbNullString:     LOConNo = vbNullString:     LSItemCode = vbNullString
            LSItemName = vbNullString:      LSSaudaCode = vbNullString:     LSStrike = 0:               LOrdNo = vbNullString:      LContime = vbNullString
            LPtyContype = "B":              LOrdTime = vbNullString:        LSInstType = "FUT":         LSOptType = vbNullString: LSItemid = 0
            LClient = vbNullString:         LConType = vbNullString:        LLOT = 1:                   LSSaudaID = 0
            Select Case LBrokerType
                Case "O"
                    If Not IsNumeric(TxtRec!f11) Then GoTo EFlag_Next
'                    LOConNo = Trim(TxtRec!f1):                        LContime = Right$(TxtRec!F20, 8)
'                    ITExchangeCode = RTrim(LTrim(TxtRec!f3)):         LUserId = TxtRec!F11
'                    LConType = TxtRec!F13:                            LRate = Val(TxtRec!F15)
'                    LQty = Val(TxtRec!F14):                           MParty = TxtRec!F17
'                    LClient = TxtRec!F17:                             LPartyName = Trim(TxtRec!F17)
'                    LSMaturity = DateValue(Left$(TxtRec!f5, 2) & "/" & Mid(TxtRec!f5, 4, 3) & "/" & Right$(TxtRec!f5, 4))
                     LOConNo = Trim(TxtRec!f3):                        LContime = Right$(TxtRec!f16, 8)
                     LEXHCODE = RTrim(LTrim(TxtRec!f6)):          LUserId = TxtRec!F2
                     LConType = TxtRec!F10:                            LRATE = Val(TxtRec!f12)
                     LQTY = Val(TxtRec!f11):                           mparty = TxtRec!F14
                     LClient = TxtRec!F14:                             LPartyName = Trim(TxtRec!F15)
                     LSMaturity = DateValue(Left$(TxtRec!F7, 2) & "/" & Mid(TxtRec!F7, 4, 3) & "/20" & Right$(TxtRec!F7, 2))
                Case "N"
                    LOConNo = Trim$(TxtRec!F13):                      LContime = Trim$(TxtRec!f16)
                    LEXHCODE = RTrim(LTrim(TxtRec!F10)):              LUserId = TxtRec!F18
                    LConType = TxtRec!F9:                             LRATE = Val(TxtRec!F14)
                    LQTY = Val(TxtRec!F15):                           mparty = TxtRec!F18
                    LClient = TxtRec!F18:                             LPartyName = Trim(TxtRec!F18)
                    LSMaturity = DateValue(TxtRec!F30)
                    If LConType = "BUY" Then
                        LConType = "1"
                    Else
                        LConType = "2"
                    End If
                Case "S"
                    LSInstType = Left$(TxtRec!f3, 3)
                    LOConNo = Trim(TxtRec!F1):                        LContime = Right(TxtRec!f22, 8)
                    LEXHCODE = RTrim(LTrim(TxtRec!F4)):         LUserId = TxtRec!f12
                    LConType = TxtRec!F14:                            LRATE = Val(TxtRec!f16)
                    LQTY = Val(TxtRec!F15):                           mparty = TxtRec!F18
                    LClient = TxtRec!F18:
                    LSCondate = DateValue(Left$(TxtRec!f22, 2) & "/" & Mid(TxtRec!f22, 4, 3) & "/" & Mid$(TxtRec!f22, 8, 4))
                    If LSInstType <> "FUT" Then
                        LSOptType = TxtRec!F7:                            LSStrike = Val(TxtRec!f6)
                    End If
                    LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Right$(TxtRec!F5, 4))
                    If LPartyAs = "U" Then
                        mparty = LUserId
                    End If
                Case "M"
                    LSInstType = Left$(TxtRec!F28, 3)
                    LOConNo = Trim(TxtRec!F8):                        LContime = (TxtRec!F9)
                    LEXHCODE = RTrim(LTrim(TxtRec!F14)):              LUserId = TxtRec!f12
                    LConType = Left(TxtRec!F4, 1):                    LRATE = Val(TxtRec!F7)
                    LQTY = Val(TxtRec!F5):                           mparty = TxtRec!f22
                    LClient = TxtRec!f22:
                    LSCondate = DateValue(Left$(TxtRec!F26, 2) & "/" & Mid(TxtRec!F26, 4, 2) & "/20" & Right$(TxtRec!F26, 2))
                    If LSInstType <> "FUT" Then
                        LSOptType = TxtRec!F7:                            LSStrike = Val(TxtRec!f6)
                    End If
                    LSMaturity = DateValue(Left$(TxtRec!f27, 2) & "/" & Mid(TxtRec!f27, 4, 2) & "/20" & Right$(TxtRec!f27, 2))
                    If LPartyAs = "U" Then
                        mparty = LUserId
                    End If
                    If LConType = "B" Then
                        LConType = "1"
                    Else
                        LConType = "2"
                    End If
                Case "T"
                    LSInstType = Left$(TxtRec!F5, 3)
                    LOConNo = Trim(TxtRec!F18):                        LContime = (TxtRec!f19)
                    LEXHCODE = RTrim(LTrim(TxtRec!F7)):                LUserId = TxtRec!f3
                    LConType = Left(TxtRec!F4, 1):                     LRATE = Val(TxtRec!F7)
                    LQTY = Val(TxtRec!F5):                             mparty = TxtRec!f22
                    LClient = TxtRec!f22:
                    LSCondate = DateValue(Left$(TxtRec!F26, 2) & "/" & Mid(TxtRec!F26, 4, 2) & "/20" & Right$(TxtRec!F26, 2))
                    If LSInstType <> "FUT" Then
                        LSOptType = TxtRec!F7:                            LSStrike = Val(TxtRec!f6)
                    End If
                    LSMaturity = DateValue(Left$(TxtRec!f27, 2) & "/" & Mid(TxtRec!f27, 4, 2) & "/20" & Right$(TxtRec!f27, 2))
                    If LPartyAs = "U" Then
                        mparty = LUserId
                    End If
                    If LConType = "B" Then
                        LConType = "1"
                    Else
                        LConType = "2"
                    End If
                Case Else
                    LSInstType = Left$(TxtRec!F4, 3)
                    LOConNo = Trim(TxtRec!F1):                        LContime = Trim(TxtRec!f16)
                    LEXHCODE = RTrim(LTrim(TxtRec!F5)):               LUserId = TxtRec!F18
                    LConType = TxtRec!F9:                             LRATE = Val(TxtRec!F18)
                    LQTY = Val(TxtRec!F17):                           mparty = TxtRec!F20
                    LClient = TxtRec!F21:                             LPartyName = Trim(TxtRec!F20)
                    If LSInstType <> "FUT" Then
                        LSOptType = TxtRec!F9:                            LSStrike = Val(TxtRec!F8)
                    End If
                    LSMaturity = DateValue(Left$(TxtRec!f6, 2) & "/" & Mid(TxtRec!f6, 3, 3) & "/" & Right$(TxtRec!f6, 4))
            End Select
            
            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, True, 1)
            If LenB(LSItemCode) = 0 Then GoTo EFlag_Next
            Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
            If LenB(LSSaudaCode) = 0 Then GoTo EFlag_Next
            LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
            MSPARTY = LExCont
            If LConType = "2" Then LPtyContype = "S"
            If LConType = "S" Then LPtyContype = "S"
            If LPartyAs = "F" Then mparty = LClientCode
            If LPartyAs = "F" Then
                mbparty = mparty
            Else
                mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, True)
            End If
            If LenB(mbparty) = 0 Then GoTo EFlag_Next
            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
            DoEvents
            
            If InStr(LBillExId, str(LSEXID)) = 0 Then
                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
            LNoTrd = LNoTrd + 1
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
            DoEvents
            

            MCount = MCount + 1
            Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
EFlag_Next:
            TxtRec.MoveNext
        Wend
    End If
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Private Sub vcDTP1_Validate(Cancel As Boolean)
    If SYSTEMLOCK(DateValue(vcDTP1.Value)) Then
        MsgBox "Sorry System Locked.  No Addition, Modification or Deletion Allowed"
        Cancel = True
    End If
End Sub
Private Sub vcDTP2_Validate(Cancel As Boolean)
    If SYSTEMLOCK(DateValue(vcDTP2.Value)) Then
        MsgBox "Sorry System Locked.  No Addition, Modification or Deletion Allowed"
        Cancel = True
    End If
End Sub
Sub SAVE_MCX_DailyMargin()
    Dim ltradedt As Date:           Dim TxtPath As String:          Dim LFileName As String
    Dim LRenameFile As Boolean:     Dim LOverwrite As Boolean:      Dim MAddLong As Double:
    Dim MAddShort As Double:        Dim AMarRate As Double:         Dim TMarRate As Double:
    Dim MSPCashMGLong As Double:    Dim MSPCashMGShort As Double:
    Dim MELMLong As Double:         Dim MELMShort As Double:        Dim LDelivery As Double
    Dim LFILEID As Integer:         Dim LFolder  As String:        Dim LFileSource As String
    Dim TXTREC2 As ADODB.Recordset: Dim LEXHCODE As String
    
    On Error GoTo err1
    Call GET_JCnn("\MCX;")
    LSExCode = "MCX"
    
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "MCX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "MCX")
        End If
        Set LFileSystemObject = Nothing
    
    ltradedt = DateValue(vcDTP1.Value)
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "MARGIN_DETAIL_REPORT_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
        LFileName = App.Path & "\MCX\" & TxtPath
        'LRenameFile = RenameFileOrDir(LFileName, App.Path & "\MCX\" & "MARGIN DETAIL REPORT " & CStr(Year(LTradeDt)) & Mid(LTradeDt, 4, 2) & Left$(LTradeDt, 2) & ".CSV")
        TxtPath = "MARGIN_DETAIL_REPORT_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
        LFileName = App.Path & "\MCX\" & TxtPath
        LOverwrite = IIf(Check14 = 1, False, True)
        LFileName = App.Path & "\MCX\" & TxtPath
        If Not FileExist(LFileName) Then
            CommonDialog1.InitDir = App.Path
            CommonDialog1.ShowOpen
            If CommonDialog1.FileName <> "" Then
                Text1.text = CommonDialog1.FileName
                LFileName = Text1.text
            Else
                LMsgBox = LFileName & "  file not found" ', vbCritical
                ImportIssues (LMsgBox)
                GoTo EFlag_Next
            End If
            TxtPath = CommonDialog1.FileTitle
            LFileName = CommonDialog1.FileName
            LFolder = Left$(LFileName, (Len(LFileName) - Len(TxtPath) - 1)) & ""
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
           ' LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath))) & ";"
            If Not FileExist(LFileName) Then
                LMsgBox = "FILE NOT FOUND"
                ImportIssues (LMsgBox)
                Exit Sub
            Else
                Set Jcnn = Nothing
                Set Jcnn = New ADODB.Connection
                Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
                "Data Source=" & LFileSource & _
                "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            End If
        End If
        
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            TxtRec.MoveLast
            LFILEID = Val(TxtRec!F2)
            TxtRec.Filter = "F3='FUTCOM'"
            TxtRec.Filter = "F2=" & LFILEID & ""
            Cnn.BeginTrans
            CNNERR = True:
            LSEXID = Get_ExID(LSExCode)
            If InStr(LBillExId, str(LSEXID)) = 0 Then
                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
                    
            
            mysql = "DELETE FROM DLYMGN WHERE  CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "' AND EXID =" & LSEXID & ""
            Cnn.Execute mysql
            TxtRec.MoveFirst
            While Not TxtRec.EOF
                LEXHCODE = RTrim(LTrim(TxtRec!F4))
                If Len(TxtRec!F5) < 10 Then
                    If Mid(TxtRec!F5, 3, 1) <> "-" Then
                        If Mid(TxtRec!F5, 2, 1) = "-" Then
                            LSMaturity = DateValue("0" & Left$(TxtRec!F5, 1) & "/" & Mid(TxtRec!F5, 3, 3) & "/20" & Right$(TxtRec!F5, 2))
                        Else
                            LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Right$(TxtRec!F5, 4))
                        End If
                    Else
                        If Mid(TxtRec!F5, 2, 1) = "-" Then
                            LSMaturity = DateValue("0" & Left$(TxtRec!F5, 1) & "/" & Mid(TxtRec!F5, 3, 3) & "/20" & Right$(TxtRec!F5, 2))
                        Else
                            LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 4, 3) & "/20" & Right$(TxtRec!F5, 2))
                        End If
                    End If
                Else
                    LSMaturity = DateValue(TxtRec!F5)
                End If
                LSItemCode = Get_ItemMaster(LSEXID, LEXHCODE)
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                LSItemid = Get_ITEMID(LSItemCode)
                LSSaudaCode = Get_SaudaMaster(LSEXID, LSItemid, LSMaturity, "FUT", vbNullString, 0)
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LSSaudaID = Get_SaudaID(LSSaudaCode)
                AMarRate = Val(0):                                    TMarRate = Val(TxtRec!F8 & vbNullString)
                MAddLong = Val(TxtRec!F9 & vbNullString):             MAddShort = Val(TxtRec!F10 & vbNullString)
                MSPCashMGLong = Val(TxtRec!f11 & vbNullString):       MSPCashMGShort = Val(TxtRec!f12 & vbNullString)
                MELMLong = Val(TxtRec!F13 & vbNullString):            MELMShort = Val(TxtRec!F14 & vbNullString)
                LDelivery = Val(TxtRec!F15 & vbNullString)
                If lminbilldate > ltradedt Then lminbilldate = ltradedt
                mysql = "INSERT INTO DLYMGN(COMPCODE,CONDATE,EXCODE,ITEMCODE,SAUDA,IMRATE,EMRATE,AMRATE,TMRATE,ADDLONG,ADDSHORT,SPCASHMGLONG,SPCASHMGSHORT,MATURITY,ELMLONG,ELMSHORT,DELIVERY,SAUDAID,EXID,ITEMID)"
                mysql = mysql & " VALUES   (" & GCompCode & ",'" & Format(ltradedt, "yyyy/MM/dd") & "','" & LSExCode & "','" & LSItemCode & "','" & LSSaudaCode & "',"
                mysql = mysql & Format(Val(TMarRate & ""), "0.000") & ", " & Val(0) & ", " & Val(0) & ", " & Format(Val(TMarRate & ""), "0.000") & ", " & MAddLong & ","
                mysql = mysql & MAddShort & "," & MSPCashMGLong & "," & MSPCashMGShort & ",'" & Format(LSMaturity, "yyyy/mm/dd") & "'," & MELMLong & "," & MELMShort & "," & LDelivery & "," & LSSaudaID & "," & LSEXID & "," & LSItemid & ")"
                Cnn.Execute mysql
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
        Cnn.CommitTrans
        CNNERR = False
    Next
    MsgBox "Task Over Succesfully"
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Sub SAVE_FO_Lot()
    On Error GoTo err1
    Dim LFileDate As String:        Dim LReName As Boolean:         Dim LFiledownload As Boolean:       Dim TxtPath As String:          Dim LFileName As String:        Dim LLotFileName As String
    Dim LTargetFileName As String:  Dim LMonth1 As String:          Dim LMonth2  As String:             Dim LMonth3 As String:          Dim LYear1 As String:           Dim LYear2 As String
    Dim LYear3 As String::          Dim LLot1 As Double:            Dim LLot2 As Double:                Dim LLot3 As Double:            Dim LRefLot1 As Double:         Dim LRefLot2 As Double
    Dim LRefLot3 As Double:         Dim LFileDt As Date:            Dim A As TextStream:                Dim LSTR As String:             Dim LEXHCODE As String
    Dim LSaudaID As Double:        Dim TXTSREC As ADODB.Recordset
    Dim mnewfile As String
    
    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
    LSExCode = "NSE"
    Call Get_ExDetail(LSExCode)
    Call GET_JCnn("\NSE;")
    Cnn.BeginTrans
    CNNERR = True:
    TxtPath = "Fo_mktlots.CSV"
    LFileName = App.Path & "\NSE\" & TxtPath

    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "NSE") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "NSE")
    End If
    Set LFileSystemObject = Nothing
    
'    If FileExist(LFileName) Then
'        'Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
'        'Set A = LFileSystemObject.CreateTextFile(LFileName)
'        'LFileDt = A.DateCreated
'        'LSTR = FileDateTime(LFileName)
'        'LFileDt = DateValue(Left(LSTR, 10))
'        'If LFileDt <= Date - 3 Then
'          '  LReName = RenameFileOrDir(LFileName, App.Path & "\NSE\" & "fo_mktlots_" & Left(LSTR, 2) & Mid(LSTR, 4, 2) & Mid(LSTR, 7, 4) & ".csv")
'            'LReName = RenameFileOrDir(LFileName, App.Path & "\FX\" & "MCX_SX_SettlementPrice_" & CStr(Year(LTradeDt)) & Mid(LTradeDt, 4, 2) & Left$(LTradeDt, 2) & ".CSV")
'            'LLotFileName = "https://www1.nseindia.com/content/fo/fo_mktlots.csv"
'            'LTargetFileName = App.Path & "\" & LSExCode & "\" & "fo_mktlots.csv"
'            'LFiledownload = DownloadFile(LLotFileName, LTargetFileName)
'            'LFileName = App.Path & "\" & LSExCode & "\" & TxtPath
'        'End If
'        'A.close
'    Else
         '>>> Always delete existing NSE/LOTfile and download
        
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        
        mnewfile = App.Path & "\NSE\" & "Fo_mktlots" & Replace(Replace(Replace(CStr(Now), " ", "T"), "/", "_"), ":", "_") & ".CSV"
        If FileExist(LFileName) Then
            LFileSystemObject.CopyFile LFileName, mnewfile
        End If
        If Gautoupdlot = "Y" Then
        Set LFileSystemObject = Nothing
        LLotFileName = "https://nsearchives.nseindia.com/content/fo/fo_mktlots.csv"
        'https://archives.nseindia.com/content/fo/fo_mktlots.csv
        LTargetFileName = App.Path & "\" & LSExCode & "\" & "fo_mktlots.csv"
        LFiledownload = DownloadFile(LLotFileName, LTargetFileName)
        If LFiledownload = False Then
            If FileExist(mnewfile) Then
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                LFileSystemObject.CopyFile mnewfile, LFileName
            End If
        End If
        LFileName = App.Path & "\" & LSExCode & "\" & TxtPath
        End If

''    End If
        
    If FileExist(LFileName) Then
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        mysql = "Select * from " & TxtPath & ""
        TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        FlagDataTrf = True
        If IsNull(TxtRec!f3) Then GoTo EFlag_Next
        If Not TxtRec.EOF Then
            CNNERR = True
            TxtRec.MoveFirst
            If IsNumeric(Right$(TxtRec!f3, 2)) Then
                LMonth1 = month(DateValue("20/" & Mid(TxtRec!f3, 1, 3) & "/20" & Right$(TxtRec!f3, 2)))
                LMonth2 = month(DateValue("20/" & Mid(TxtRec!F4, 1, 3) & "/20" & Right$(TxtRec!F4, 2)))
                LMonth3 = month(DateValue("20/" & Mid(TxtRec!F5, 1, 3) & "/20" & Right$(TxtRec!F5, 2)))
                LYear1 = "20" & Right$(TxtRec!f3, 2)
                LYear2 = "20" & Right$(TxtRec!F4, 2)
                LYear3 = "20" & Right$(TxtRec!F5, 2)
            Else
                LMonth1 = month(DateValue("20/" & Mid(TxtRec!f3, 4, 3) & "/20" & Left$(TxtRec!f3, 2)))
                LMonth2 = month(DateValue("20/" & Mid(TxtRec!F4, 4, 3) & "/20" & Left$(TxtRec!F4, 2)))
                LMonth3 = month(DateValue("20/" & Mid(TxtRec!F5, 4, 3) & "/20" & Left$(TxtRec!F5, 2)))
                LYear1 = "20" & Left$(TxtRec!f3, 2)
                LYear2 = "20" & Left$(TxtRec!F4, 2)
                LYear3 = "20" & Left$(TxtRec!F5, 2)
            End If
            LSEXID = Get_ExID(LSExCode)
            While Not TxtRec.EOF
                LEXHCODE = vbNullString:          LSItemCode = vbNullString
                LLot1 = 1:                          LLot2 = 1:                  LLot3 = 1
                LCItemCode = vbNullString
                LSItemid = 0
                If Left(TxtRec!F2, 6) = "Symbol" Then
                    If IsNumeric(Right$(TxtRec!f3, 2)) Then
                        LMonth1 = month(DateValue("20/" & Mid(TxtRec!f3, 1, 3) & "/20" & Right$(TxtRec!f3, 2)))
                        LMonth2 = month(DateValue("20/" & Mid(TxtRec!F4, 1, 3) & "/20" & Right$(TxtRec!F4, 2)))
                        LMonth3 = month(DateValue("20/" & Mid(TxtRec!F5, 1, 3) & "/20" & Right$(TxtRec!F5, 2)))
                        LYear1 = "20" & Right$(TxtRec!f3, 2)
                        LYear2 = "20" & Right$(TxtRec!F4, 2)
                        LYear3 = "20" & Right$(TxtRec!F5, 2)
                    Else
                        LMonth1 = month(DateValue("20/" & Mid(TxtRec!f3, 4, 3) & "/20" & Left$(TxtRec!f3, 2)))
                        LMonth2 = month(DateValue("20/" & Mid(TxtRec!F4, 4, 3) & "/20" & Left$(TxtRec!F4, 2)))
                        LMonth3 = month(DateValue("20/" & Mid(TxtRec!F5, 4, 3) & "/20" & Left$(TxtRec!F5, 2)))
                        LYear1 = "20" & Left$(TxtRec!f3, 2)
                        LYear2 = "20" & Left$(TxtRec!F4, 2)
                        LYear3 = "20" & Left$(TxtRec!F5, 2)
                    End If
               End If
                If IsNull(TxtRec!F2) Then GoTo EFlag_Next

                LEXHCODE = RTrim(LTrim(TxtRec!F2))
                Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, False, 1)

                LRefLot1 = Val(IIf(IsNull(TxtRec!f3), 0, TxtRec!f3))
                LRefLot2 = Val(IIf(IsNull(TxtRec!F4), 0, TxtRec!F4))
                LRefLot3 = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
                If GAmtDivide = 1 Then
                    LLot1 = (Val(IIf(IsNull(TxtRec!f3), 0, TxtRec!f3))) / 100
                    LLot2 = (Val(IIf(IsNull(TxtRec!F4), 0, TxtRec!F4))) / 100
                    LLot3 = (Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))) / 100
                Else
                    LLot1 = Val(IIf(IsNull(TxtRec!f3), 0, TxtRec!f3))
                    LLot2 = Val(IIf(IsNull(TxtRec!F4), 0, TxtRec!F4))
                    LLot3 = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
                End If
                If LRefLot1 > 0 Then
                    mysql = "UPDATE SCRIPTMASTER SET REFLOT =" & Val(LRefLot1) & " WHERE EX_SYMBOL  ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth1) & " And Year(MATURITY) = " & Val(LYear1) & ""
                    Cnn.Execute mysql
                    mysql = "UPDATE SCRIPTMASTER SET REFLOT =" & Val(LRefLot2) & " WHERE EX_SYMBOL ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth2) & " AND YEAR(MATURITY)=" & Val(LYear2) & ""
                    Cnn.Execute mysql
                    mysql = "UPDATE SCRIPTMASTER SET REFLOT =" & Val(LRefLot3) & " WHERE EX_SYMBOL ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth3) & " AND YEAR(MATURITY)=" & Val(LYear3) & ""
                    Cnn.Execute mysql
                
                    Label3.Caption = "Updating Lot size " & LSItemCode & " " & LMonth1 & " " & LYear1 & ""
                    DoEvents
                    If LenB(LSItemCode) > 0 And LRefLot1 <> 0 And LRefLot2 <> 0 And LRefLot3 <> 0 Then
                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth1) & " And Year(MATURITY) = " & Val(LYear1) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                            mysql = "UPDATE SAUDAMAST SET REFLOT =" & Val(LRefLot1) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If
                    
                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth2) & " And Year(MATURITY) = " & Val(LYear2) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                            mysql = "UPDATE SAUDAMAST SET REFLOT =" & Val(LRefLot2) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If
                    
                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth3) & " And Year(MATURITY) = " & Val(LYear3) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                       
                            mysql = "UPDATE SAUDAMAST SET REFLOT =" & Val(LRefLot3) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If
                End If
                If ChkNSELotSize.Value = 1 And LLot1 > 0 Then ' LotSize Tradeablelot
                    mysql = "UPDATE SCRIPTMASTER SET LOT =" & Val(LLot1) & " WHERE  EX_SYMBOL ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth1) & " And Year(MATURITY) = " & Val(LYear1) & ""
                    Cnn.Execute mysql
                    mysql = "UPDATE SCRIPTMASTER SET LOT =" & Val(LLot2) & " WHERE  EX_SYMBOL ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth2) & " AND YEAR(MATURITY)=" & Val(LYear2) & ""
                    Cnn.Execute mysql
                    mysql = "UPDATE SCRIPTMASTER SET LOT =" & Val(LLot3) & " WHERE  EX_SYMBOL ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth3) & " AND YEAR(MATURITY)=" & Val(LYear3) & ""
                    Cnn.Execute mysql
                    If LenB(LSItemCode) <> 0 Then
                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth1) & " And Year(MATURITY) = " & Val(LYear1) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                            mysql = "UPDATE SAUDAMAST SET TRADEABLELOT =" & Val(LLot1) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If
                        
                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth2) & " And Year(MATURITY) = " & Val(LYear2) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                            mysql = "UPDATE SAUDAMAST SET TRADEABLELOT =" & Val(LLot2) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If

                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth3) & " And Year(MATURITY) = " & Val(LYear3) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                            mysql = "UPDATE SAUDAMAST SET TRADEABLELOT =" & Val(LLot3) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If
                    End If
                End If
                If ChkNSEBrokLot.Value = 1 Then
                    LLot1 = Val(IIf(IsNull(TxtRec!f3), 0, TxtRec!f3))
                    LLot2 = Val(IIf(IsNull(TxtRec!F4), 0, TxtRec!F4))
                    LLot3 = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
                    If LenB(LSItemCode) <> 0 And LLot1 > 0 Then
                    
                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth1) & " And Year(MATURITY) = " & Val(LYear1) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                            mysql = "UPDATE SAUDAMAST SET BROKLOT =" & Val(LLot1) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If
                        
                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth2) & " And Year(MATURITY) = " & Val(LYear2) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                            mysql = "UPDATE SAUDAMAST SET BROKLOT =" & Val(LLot2) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If
                        
                        
                        Set TXTSREC = Nothing: Set TXTSREC = New ADODB.Recordset
                        mysql = "SELECT TOP 1 SAUDAID FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MONTH(MATURITY)=" & Val(LMonth3) & " And Year(MATURITY) = " & Val(LYear3) & " ORDER BY MATURITY DESC "
                        TXTSREC.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TXTSREC.EOF Then
                            LSaudaID = TXTSREC!SAUDAID
                            mysql = "UPDATE SAUDAMAST SET BROKLOT =" & Val(LLot3) & " WHERE SAUDAID = " & LSaudaID & ""
                            Cnn.Execute mysql
                        End If
                    End If
                    mysql = "UPDATE SCRIPTMASTER SET BROKLOT = " & Val(LLot1) & " WHERE  EXCODE ='NSE' AND EX_SYMBOL  ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth1) & " And Year(MATURITY) = " & Val(LYear1) & ""
                    Cnn.Execute mysql
                    mysql = "UPDATE SCRIPTMASTER SET BROKLOT = " & Val(LLot2) & " WHERE  EXCODE ='NSE' AND  EX_SYMBOL ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth2) & " AND YEAR(MATURITY)=" & Val(LYear2) & ""
                    Cnn.Execute mysql
                    mysql = "UPDATE SCRIPTMASTER SET BROKLOT = " & Val(LLot3) & " WHERE  EXCODE ='NSE' AND  EX_SYMBOL ='" & LEXHCODE & "' AND MONTH(MATURITY)=" & Val(LMonth3) & " AND YEAR(MATURITY)=" & Val(LYear3) & ""
                    Cnn.Execute mysql
                End If
            End If
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
    Else
        MsgBox "Lot Size File Does not Exists"
    End If
FEnd:
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Sub Save_Fut_Trade_ExMain()
    Dim ltradedt As Date:           Dim TxtPath As String:          Dim LFileName As String:        Dim LConType As String
    Dim LQTY As Double:             Dim LRATE As Double:            Dim LSCondate As Date:          Dim LSPtyContype As String:
    Dim MCount As Long:             Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
    Dim LContime As String:         Dim LUserId As String:          Dim LNoTrd As Long:             Dim LOrdTime As String:
    Dim LPartyName As String:       Dim LOConNo As String:          Dim LSItemName As String:       Dim LSConSno As Long
    Dim LEXHCODE As String:         Dim LClient As String:          Dim LOrdNo As String: Dim TRec As ADODB.Recordset:
        
    On Error GoTo err1
    
    LSExCode = "NSE"
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    Call SAVE_FUT_TRADE_CTCL
    Call GET_JCnn("\NSE;")
        
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "NSE") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "NSE")
    End If
    Set LFileSystemObject = Nothing
    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & "_" & LMemberId & ".TXT"
        LFileName = App.Path & "\NSE\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                LSCondate = DateValue(Left$(TxtRec!F21, 2) & "/" & Mid(TxtRec!F21, 4, 3) & "/" & Mid(TxtRec!F21, 8, 4))
                MCount = Get_Max_ConNo(LSCondate, 0)
                TxtRec.MoveFirst
                LNoTrd = 0
                LSEXID = Get_ExID(LSExCode)
                While Not TxtRec.EOF
                    DoEvents
                    LSPtyContype = "B":          LEXHCODE = vbNullString:    LSInstType = "FUT":         LSSaudaCode = vbNullString
                    LSOptType = vbNullString:   LSStrike = 0:               LOrdNo = vbNullString:      LLOT = 1:
                    LSSaudaID = 0:              LSItemid = 0:               LSItemCode = vbNullString
                    
                    LSCondate = DateValue(Left$(TxtRec!F21, 2) & "/" & Mid(TxtRec!F21, 4, 3) & "/" & Mid(TxtRec!F21, 8, 4))
                    If LBrokerType = "M" Then
                        LEXHCODE = Trim(TxtRec!f3)
                        LSInstType = Left$(TxtRec!F4, 3)
                        If LSInstType <> "FUT" Then
                            LSInstType = "OPT":     LSOptType = TxtRec!F7:   LSStrike = Val(TxtRec!f6)
                        End If
                        LContime = Right$(TxtRec!F21, 8):    LUserId = Trim(TxtRec!f11)
                        LConType = Trim(TxtRec!F13):        LRATE = Val(TxtRec!F15)
                        LQTY = Val(TxtRec!F14):             mparty = Trim(TxtRec!F17)
                        LPartyName = Trim(TxtRec!F17)
                        LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 4, 3) & "/" & Mid(TxtRec!F5, 8, 4))
                    Else
                        LEXHCODE = Trim(TxtRec!F4):            LContime = Right$(TxtRec!f22, 8)
                        LUserId = TxtRec!f12:                  LConType = TxtRec!F14
                        LRATE = Val(TxtRec!f16):               LQTY = Val(TxtRec!F15)
                        mparty = Trim(TxtRec!F18):             LPartyName = Trim(TxtRec!F18)
                        LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Mid(TxtRec!F5, 6, 4))
                    End If
                    LOConNo = Trim(TxtRec!F1):
                    LSItemCode = LEXHCODE:                   LSItemName = LEXHCODE
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, True, 1)
                    If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                    Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    MSPARTY = LExCont
                    If LConType = "2" Then LSPtyContype = "S"
                    mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, False)
                    If LenB(mbparty) = 0 Then GoTo EFlag_Next
                    mysql = "SELECT CONNO FROM CTR_D WHERE  SAUDAID = " & LSSaudaID & " And ROWNO ='" & LOConNo & "'  AND CONDATE ='" & Format(LSCondate, "yyyy/MM/dd") & "'AND PARTY='" & MSPARTY & "' AND CONTYPE<> '" & LSPtyContype & "'"
                    Set TRec = Nothing:                        Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    DoEvents
                    If TRec.EOF Then
                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LSEXID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                    
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                        MCount = MCount + 1
                        Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
                    End If
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub SAVE_FUT_TRADE_CTCL()
    Dim ltradedt As Date:           Dim TxtPath As String:          Dim LFileName As String:        Dim LConType As String
    Dim LQTY As Double:             Dim LRATE As Double:            Dim LSCondate As Date:          Dim LSPtyContype As String:
    Dim MCount As Long:             Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
    Dim LContime As String:         Dim LUserId As String:          Dim LOrdTime As String:         Dim LNoTrd As Long
    Dim LPartyName As String:       Dim LOConNo As String:          Dim LSItemName As String:       Dim LSConSno As Long
    Dim LEXHCODE As String:         Dim LClient As String:          Dim LOrdNo As String: Dim TRec As ADODB.Recordset:
    On Error GoTo err1
    Call GET_JCnn("\NSE;")
    Cnn.BeginTrans
    CNNERR = True:
    LSExCode = "NSE"
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "NSE") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "NSE")
    End If
    Set LFileSystemObject = Nothing
        
        
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".TXT"
        LFileName = App.Path & "\NSE\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & " WHERE F2='11' ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                LSCondate = DateValue(Left$(TxtRec!f22, 2) & "/" & Mid(TxtRec!f22, 4, 3) & "/" & Mid(TxtRec!f22, 8, 4))
                MCount = Get_Max_ConNo(LSCondate, 0)
                LSEXID = Get_ExID(LSExCode)
                Cnn.Execute "DELETE FROM CTR_D WHERE CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT =1 AND EXID=" & LSEXID & ""
                TxtRec.MoveFirst
                LNoTrd = 0
                While Not TxtRec.EOF
                    LSPtyContype = "B":              LOrdNo = vbNullString:      LSSaudaID = 0:              LSItemid = 0
                    LSSaudaCode = vbNullString:      LSItemCode = vbNullString:  LSOptType = vbNullString:   LSStrike = 0
                    LOrdTime = vbNullString:
                    
                    LSCondate = DateValue(Left$(TxtRec!f22, 2) & "/" & Mid(TxtRec!f22, 4, 3) & "/" & Mid(TxtRec!f22, 8, 4))
                    LEXHCODE = Trim(TxtRec!F4)
                    LSInstType = Left$(TxtRec!f3, 3)
                    If LSInstType <> "FUT" Then
                        LSInstType = "OPT":               LSOptType = TxtRec!F7:                        LSStrike = Val(TxtRec!f6)
                    End If
                    LOConNo = Trim(TxtRec!F1):                    LContime = Right$(TxtRec!f22, 8)
                    LLOT = 1
                    LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Mid(TxtRec!F5, 6, 4))
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, True, 1)
                    If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                    Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    
                    MSPARTY = LExCont:                    LUserId = Trim(TxtRec!f12)
                    LRATE = Val(TxtRec!f16):              LQTY = Val(TxtRec!F15)
                    LConType = Trim(TxtRec!F14):          mparty = TxtRec!f12
                    LPartyName = Trim(TxtRec!f12):
                    If LConType = "2" Then LSPtyContype = "S"
                    mbparty = Get_ACCT_EX(LSEXID, Trim(mparty))
                    If LenB(mbparty) < 1 Then
                        LMsgBox = "Generating New Party for " & mparty & " Exchange Code." ', vbInformation
                        ImportIssues (LMsgBox)
                        mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, False)
                    End If
                    DoEvents
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                    If lminbilldate > LSCondate Then lminbilldate = LSCondate
                    LNoTrd = LNoTrd + 1
                    GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                    DoEvents
            
                    If InStr(LBillExId, str(LSEXID)) = 0 Then
                        If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                        LBillExId = LBillExId & str(LSEXID)
                    End If
                    MCount = MCount + 1
                    Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Sub SAVE_NCDEX_ODIN(MOVERWRITE As Boolean)
    On Error GoTo err1
    Dim TRec As ADODB.Recordset:
    Dim TxtPath As String:          Dim LFileName As String:        Dim LConType As String:         Dim LQ As Double
    Dim LQTY As Double:             Dim LRATE As Double:            Dim LSCondate As Date:          Dim LSPtyContype As String:
    Dim MCount As Long:             Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
    Dim LContime As String:         Dim LLOT As Double:             Dim LUserId As String:          Dim LNoTrd As Long
    Dim LPartyName As String:       Dim LOConNo As String:          Dim LSItemName As String:       Dim LSConSno As Long
    Dim LEXHCODE As String:         Dim LClient As String:          Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LPty As String:             Dim LRemark As String
    Dim LMarginAcc As String:
    
    
    LSExCode = "NCDX"
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then
        If CNNERR = True Then
            Cnn.RollbackTrans: CNNERR = False
        End If
        Exit Sub
    End If
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    mysql = " SELECT MARGINACC FROM EXMAST WHERE COMPCODE =" & GCompCode & " AND EXCODE = '" & LSExCode & "'"
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then
        LMarginAcc = IIf(IsNull(TRec!MarginACC), "", Trim(TRec!MarginACC))
    End If
    If LMarginAcc = "" Then
        MsgBox "Please Import Again After Defining Exchange Margin A/c "
        Exit Sub
    End If
    MSPARTY = LExCont
    If Not TxtRec.EOF Then
        FlagDataTrf = True
        LSCondate = TxtRec!f22
        CNNERR = True
        LSEXID = Get_ExID(LSExCode)
        MCount = Get_Max_ConNo(LSCondate, 0)
        If MOVERWRITE = True Then Cnn.Execute "DELETE FROM CTR_D WHERE CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "'  AND DATAIMPORT =1 AND  EXID= " & LSEXID & ""
        TxtRec.MoveFirst
        LNoTrd = 0
        While Not TxtRec.EOF
            LSPtyContype = "B":             LOrdNo = vbNullString:       LSSaudaID = 0:              LSItemid = 0
            LSSaudaCode = vbNullString:     LSItemCode = vbNullString:   LSOptType = vbNullString:   LSStrike = 0
            LOrdTime = vbNullString:        LRemark = vbNullString:
            
            MCount = MCount + 1:                        LSCondate = DateValue(TxtRec!f22)
            LEXHCODE = TxtRec!F4 & vbNullString:        LOConNo = Trim(TxtRec!F1)
            LUserId = TxtRec!f12:                       LClient = Trim(TxtRec!F18)
            LConType = TxtRec!F14:                      LQTY = Val(TxtRec!F15)
            LRATE = Val(TxtRec!f16):                    LRemark = Trim(IIf(IsNull(TxtRec!f29), "", TxtRec!f29))
            LSMaturity = DateValue(Mid(TxtRec!F5, 1, 2) & " " & Mid(TxtRec!F5, 3, 3) & " " & Right$(TxtRec!F5, 4))
            LOrdNo = Trim(TxtRec!F24)
            If Right$(TxtRec!F21, 8) = "UNCOVER" Then
                LContime = Right$(TxtRec!f22, 8)
            Else
                LContime = Right$(TxtRec!F21, 8)
            End If
            LLOT = 1:
            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, True, 1)
            If LenB(LSItemCode) = 0 Then GoTo EFlag_Next
            Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
            If LenB(LSSaudaCode) = 0 Then GoTo EFlag_Next
            LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
            mparty = LUserId
            LPartyName = LUserId
            If LConType = "2" Then LSPtyContype = "S"
            mbparty = NewParty(LSExCode, mparty, LPartyName & " " & LSExCode, LUserId, False)
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
            If InStr(LBillExId, str(LSEXID)) = 0 Then
                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
            
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
            LNoTrd = LNoTrd + 1
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
            DoEvents
            
            If MOVERWRITE = False Then 'ADD TO EXSIST
                mysql = "SELECT CONNO FROM CTR_D WHERE SAUDAID = '" & LSSaudaID & "' And CONNO =" & MCount & "  AND CONDATE ='" & Format(LSCondate, "yyyy/MM/dd") & "' "
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                    Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
                End If
            End If
EFlag_Next:
            TxtRec.MoveNext
        Wend
    End If
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Public Sub Create_SchemaFile(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 100"):           A.WriteLine ("Col2 = F2 Text Width 100")
    A.WriteLine ("Col3 = F3 Text Width 100"):           A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100"):           A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100"):           A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100"):           A.WriteLine ("Col10 = F10 Text Width 100")
    A.WriteLine ("Col11 = F11 Text Width 100"):         A.WriteLine ("Col12 = F12 Text Width 100")
    A.WriteLine ("Col13 = F13 Text Width 100"):         A.WriteLine ("Col14 = F14 Text Width 100")
    A.WriteLine ("Col15 = F15 Text Width 100"):         A.WriteLine ("Col16 = F16 Text Width 100")
    A.WriteLine ("Col17 = F17 Text Width 100"):         A.WriteLine ("Col18 = F18 Text Width 100")
    A.WriteLine ("Col19 = F19 Text Width 100"):         A.WriteLine ("Col20 = F20 Text Width 100")
    A.WriteLine ("Col21 = F21 Text Width 100"):         A.WriteLine ("Col22 = F22 Text Width 100")
    A.WriteLine ("Col23 = F23 Text Width 100"):         A.WriteLine ("Col24 = F24 Text Width 100")
    A.WriteLine ("Col25 = F25 Text Width 100"):         A.WriteLine ("Col26 = F26 Text Width 100")
    A.WriteLine ("Col27 = F27 Text Width 100"):         A.WriteLine ("Col28 = F28 Text Width 100")
    A.WriteLine ("Col29 = F29 Text Width 100"):         A.WriteLine ("Col30 = F30 Text Width 100")
    A.WriteLine ("Col31 = F31 Text Width 100"):         A.WriteLine ("Col32 = F32 Text Width 100")
    
    A.close
End Sub
Public Sub Create_SchemaFile_Nextra(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 100"):    A.WriteLine ("Col2 = F2 Text Width 100")
    A.WriteLine ("Col3 = F3 Text Width 100"):    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100"):    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100"):    A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100"):    A.WriteLine ("Col10 = F10 Text Width 100")
    A.WriteLine ("Col11 = F11 Text Width 100"):  A.WriteLine ("Col12 = F12 Text Width 100")
    A.WriteLine ("Col13 = F13 Text Width 100"):    A.WriteLine ("Col14 = F14 Text Width 100")
    A.WriteLine ("Col15 = F15 Text Width 100"):    A.WriteLine ("Col16 = F16 Text Width 100")
    A.WriteLine ("Col17 = F17 Text Width 100"):    A.WriteLine ("Col18 = F18 Text Width 100")
    A.WriteLine ("Col19 = F19 Text Width 100"):    A.WriteLine ("Col20 = F20 Text Width 100")
    A.WriteLine ("Col21 = F21 Text Width 100"):    A.WriteLine ("Col22 = F22 Text Width 100")
    A.WriteLine ("Col23 = F23 Text Width 100"):    A.WriteLine ("Col24 = F24 Text Width 100")
    A.WriteLine ("Col25 = F25 Text Width 100"):    A.WriteLine ("Col26 = F26 Text Width 100")
    A.WriteLine ("Col27 = F27 Text Width 100"):    A.WriteLine ("Col28 = F28 Text Width 100")
    A.WriteLine ("Col29 = F29 Text Width 100"):    A.WriteLine ("Col30 = F30 Text Width 100")
    A.WriteLine ("Col31 = F31 Text Width 100"):    A.WriteLine ("Col32 = F32 Text Width 100")
    A.WriteLine ("Col33 = F33 Text Width 100"):    A.WriteLine ("Col34 = F34 Text Width 100")
    A.WriteLine ("Col35 = F35 Text Width 100"):    A.WriteLine ("Col36 = F36 Text Width 100")
    A.WriteLine ("Col37 = F37 Text Width 100"):    A.WriteLine ("Col38 = F38 Text Width 100")
    A.WriteLine ("Col39 = F39 Text Width 100"):    A.WriteLine ("Col40 = F40 Text Width 100")
    A.WriteLine ("Col41 = F41 Text Width 100"):    A.WriteLine ("Col42 = F42 Text Width 100")
    A.WriteLine ("Col43 = F43 Text Width 100"):    A.WriteLine ("Col44 = F44 Text Width 100")
    A.WriteLine ("Col45 = F45 Text Width 100")
    A.close
End Sub

Sub SAVE_DGCX_TRADE()
    Dim TxtPath As String:          Dim LFileName As String:        Dim LConType As String:         Dim B As Integer
    Dim LQTY As Double:             Dim LRATE As Double:            Dim LSCondate As Date:          Dim LNoTrd As Long
    Dim MCount As Long:             Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
    Dim LContime As String:         Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String
    Dim LOConNo As String:          Dim LSConSno As Long:           Dim LEXHCODE As String:         Dim TRec As ADODB.Recordset
    Dim LClient As String:          Dim LOrdNo As String:           Dim LOrdTime As String:         Dim LPty As String:
    Dim LOverwrite As Boolean:      Dim LSTRCONDATE As String:      Dim ltradedt As Date:           Dim LFolder As String
    Dim LParty As String:           Dim LFileSource As String:      Dim lday As String:             Dim LMONTH As String
    Dim lyear As String:            Dim A As Integer:               Dim LSPtyContype As String:
    
    LOverwrite = True
    LSExCode = "DGCX"
    On Error GoTo err1
    Call GET_JCnn("\DGCX;")
    Call Get_ExDetail(LSExCode)
    If LTradeFileType = "1" Or LTradeFileType = "3" Or LTradeFileType = "4" Or LTradeFileType = "6" Then
        If LenB(BrokerCombo.BoundText) > 1 Then
            LExCont = BrokerCombo.BoundText
        Else
            MsgBox " Please Select Broker Account"
            Exit Sub
        End If
        If LTradeFileType <> "6" Then
            If LenB(ClientCombo.BoundText) > 1 Then
                LParty = ClientCombo.BoundText
            Else
                MsgBox " Please Select Client Account"
                Exit Sub
            End If
        End If
    End If
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "DGCX") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "DGCX")
    End If
    Set LFileSystemObject = Nothing
               
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If LTradeFileType = "1" Or LTradeFileType = "3" Or LTradeFileType = "4" Or LTradeFileType = "6" Then
            CommonDialog1.InitDir = App.Path
            CommonDialog1.ShowOpen
            If CommonDialog1.FileName <> "" Then
                Text1.text = CommonDialog1.FileName
                LFileName = Text1.text
            Else
                LMsgBox = LFileName & "  file not found" ', vbCritical
                ImportIssues (LMsgBox)
                GoTo flag210
            End If
            TxtPath = CommonDialog1.FileTitle
            LFileName = CommonDialog1.FileName
            LFolder = Left$(LFileName, (Len(LFileName) - Len(TxtPath) - 1)) & ""
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        ElseIf LTradeFileType = "2" Then
            TxtPath = "DGCX" & CStr(Left$(ltradedt, 2)) & Mid(CStr(ltradedt), 4, 2) & Year(ltradedt) & ".CSV"
            LFileName = App.Path & "\DGCX\" & TxtPath
            LSExCode = "DGCX"
        ElseIf LTradeFileType = "5" Then
            TxtPath = "DGCX" & CStr(Left$(ltradedt, 2)) & Mid(CStr(ltradedt), 4, 2) & Year(ltradedt) & ".CSV"
            LFileName = App.Path & "\DGCX\" & TxtPath
            LSExCode = "DGCX"
        End If
        
        
        If Not FileExist(LFileName) Then
            CommonDialog1.InitDir = App.Path
            CommonDialog1.ShowOpen
            If CommonDialog1.FileName <> "" Then
                Text1.text = CommonDialog1.FileName
            Else
                LMsgBox = LFileName & "  file not found" ', vbCritical
                ImportIssues (LMsgBox)
                GoTo flag210
            End If
            LFileName = Text1.text
            TxtPath = CommonDialog1.FileTitle
            LFileName = CommonDialog1.FileName
            LFolder = Left$(LFileName, (Len(LFileName) - (Len(TxtPath)) + 1)) & ""
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        End If
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        Else
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath))) & ";"
            Set Jcnn = Nothing
            Set Jcnn = New ADODB.Connection
            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
            "Data Source=" & LFileSource & _
            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True:
            TxtRec.MoveFirst:
            If LTradeFileType = "1" Or LTradeFileType = "3" Then
                LSCondate = ltradedt
            ElseIf LTradeFileType = "4" Then
                TxtRec.Filter = "f13='FUT'"
                If Not TxtRec.EOF Then
                    A = InStr(TxtRec!F26, "/")
                    LMONTH = Left(TxtRec!F26, A - 1)
                    B = InStr(A + 1, TxtRec!F26, "/")
                    lday = Mid(TxtRec!F26, A + 1, ((B - A) - 1))
                    lyear = Mid(TxtRec!F26, B + 1, 4)
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    LSCondate = DateValue(lday & "/" & LMONTH & "/" & lyear)
                Else
                    LSCondate = ltradedt
                End If
            ElseIf LTradeFileType = "2" Then
                TxtRec.Filter = "f9='USD'"
                If Not TxtRec.EOF Then
                    LSCondate = DateValue(TxtRec!F10)
                Else
                    LSCondate = ltradedt
                End If
            ElseIf LTradeFileType = "5" Then
                TxtRec.Filter = "f16='Filled'"
                If Not TxtRec.EOF Then
                    LSCondate = DateValue(Left(TxtRec!F14, 10))
                Else
                    LSCondate = ltradedt
                End If
            
            End If
            CNNERR = True
            LSEXID = Get_ExID(LSExCode)
            If LTradeFileType = "1" Or LTradeFileType = "3" Then
                mysql = "DELETE FROM CTR_D WHERE CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "' "
                mysql = mysql & " AND FILETYPE='" & LTradeFileType & "' AND EXID  =" & LSEXID & " AND CONCODE ='" & LExCont & "'"
                Cnn.Execute mysql
            ElseIf LTradeFileType = "4" Then
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' "
                mysql = mysql & " AND FILETYPE='" & LTradeFileType & "'"
                Cnn.Execute mysql
            ElseIf LTradeFileType = "5" Then
                mysql = "DELETE FROM CTR_D WHERE  CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' "
                mysql = mysql & " AND EXID=" & LSEXID & " AND FILETYPE='" & LTradeFileType & "'"
                Cnn.Execute mysql
                'Call PDelete_CTR_D(LSCondate, LSExCode, LTradeFileType)
            Else
                mysql = "DELETE FROM CTR_D WHERE CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' "
                mysql = mysql & " AND EXID='" & LSEXID & " AND FILETYPE='" & LTradeFileType & "'"
                Cnn.Execute mysql
                'Call PDelete_CTR_D(LSCondate, LSExCode, LTradeFileType)
            End If
            MCount = Get_Max_ConNo(LSCondate, 0)
            If TxtRec.RecordCount > 0 Then TxtRec.MoveFirst
            LNoTrd = 0
            While Not TxtRec.EOF
                LContime = vbNullString:    LOConNo = vbNullString:         LQTY = 0:      LRATE = 0:             LOrdNo = vbNullString
                LSInstType = "FUT":         LSOptType = vbNullString:       LSStrike = 0:  LSPtyContype = "B":    LSSaudaID = 0:
                LSItemid = 0:               LSSaudaCode = vbNullString:     LSItemCode = vbNullString:            LOrdTime = vbNullString:
            
                
                If LTradeFileType = "1" Then
                    If IsNull(TxtRec!f3) Then GoTo EFlag_Next
                    If Not IsNumeric(TxtRec!f3) Then GoTo EFlag_Next
                End If
                Select Case LTradeFileType
                Case "1"
                    MCount = MCount + 1:                    LContime = Right$(TxtRec!F15, 8)
                    LEXHCODE = Left$(Trim$(TxtRec!F1), Len(TxtRec!F1) - 9)
                    LSTRCONDATE = Right$(TxtRec!F1, 8):                LSMaturity = DateValue(Right$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 5, 2) & "/" & Left$(LSTRCONDATE, 4))
                    LSPtyContype = Left$(TxtRec!F2, 1):                LRATE = Val(TxtRec!f3)
                    If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                        LQTY = Val(TxtRec!F4) * Val(TxtQtyMultipler.text)
                    Else
                        LQTY = Val(TxtRec!F4)
                    End If
                    LLOT = 1
                    LUserId = TxtRec!F13
                Case "2"
                    MCount = MCount + 1
                    LContime = Right$(TxtRec!F15, 8):       LEXHCODE = Left$(Trim$(TxtRec!F5), Len(TxtRec!F5) - 9)
                    LSTRCONDATE = Right$(TxtRec!F5, 8):     LSMaturity = DateValue(Right$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 5, 2) & "/" & Left$(LSTRCONDATE, 4))
                    LSPtyContype = Left$(TxtRec!f6, 1):      LRATE = Val(TxtRec!F8)
                    LQTY = Val(TxtRec!F7):                  LLOT = 1
                    LUserId = TxtRec!f3:                    mparty = Trim(TxtRec!f3) 'USERID
                    LPartyName = Trim(TxtRec!f3):
                Case "3"
                    MCount = MCount + 1:                    LContime = Right$(TxtRec!F24, 11)
                    LEXHCODE = Left$(Trim$(TxtRec!F5), Len(TxtRec!F5) - 9)
                    LSTRCONDATE = TxtRec!f6:                LSMaturity = DateValue(LSTRCONDATE)
                    LConType = Left$(TxtRec!F15, 1)
                    If LConType = "1" Then
                        LSPtyContype = "B"
                    Else
                        LSPtyContype = "S"
                    End If
                    LRATE = Val(TxtRec!F17):
                    If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                        LQTY = Val(TxtRec!f16) * Val(TxtQtyMultipler.text)
                    Else
                        LQTY = Val(TxtRec!f16)
                    End If
                    LLOT = 1
                    LUserId = TxtRec!F20:
                Case "4"
                    MCount = MCount + 1
                    A = InStr(TxtRec!F26, "/")
                    LMONTH = Left(TxtRec!F26, A - 1)
                    B = InStr(A + 1, TxtRec!F26, "/")
                    lday = Mid(TxtRec!F26, A + 1, ((B - A) - 1))
                    lyear = Mid(TxtRec!F26, B + 1, 4)
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    LSCondate = DateValue(lday & "/" & LMONTH & "/" & lyear)
                    LContime = Mid$(TxtRec!F26, 11, Len(TxtRec!F26))
                    LSExCode = TxtRec!F2
                    If LSExCode = "BSECD" Then LSExCode = "FX"
                    Call Get_ExDetail(LSExCode)
                    If LSExCode = "FX" Then
                        LEXHCODE = TxtRec!F9
                    Else
                        LEXHCODE = Left$(Trim$(TxtRec!F9), Len(TxtRec!F9) - 9)
                    End If
                    LSTRCONDATE = Left$(TxtRec!F10, 10)
                    
                    A = InStr(LSTRCONDATE, "/")
                    LMONTH = Left(LSTRCONDATE, A - 1)
                    B = InStr(A + 1, LSTRCONDATE, "/")
                    lday = Mid(LSTRCONDATE, A + 1, ((B - A) - 1))
                    lyear = Mid(LSTRCONDATE, B + 1, 4)
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                    LConType = Left$(TxtRec!f16, 1)
                    LSPtyContype = Left$(TxtRec!f16, 1)
                    LRATE = Val(TxtRec!F18)
                    If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                        LQTY = Val(TxtRec!F21) * Val(TxtQtyMultipler.text)
                    Else
                        LQTY = Val(TxtRec!F21)
                    End If
                    LLOT = 1
                    LUserId = TxtRec!F30:       mparty = LParty
                          MSPARTY = LExCont
                Case "5"
                    MCount = MCount + 1
                    LSTRCONDATE = Left(TxtRec!F14, 10)
                    LSCondate = DateValue(LSTRCONDATE)
                    LContime = Mid$(TxtRec!F14, 11, Len(TxtRec!F14))
                    LSExCode = TxtRec!F21
                    Call Get_ExDetail(LSExCode)
                    LSTRCONDATE = Right$(TxtRec!f23, 8)
                    LSTRCONDATE = Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 5, 2) & "/" & Left(LSTRCONDATE, 4)
                    LSMaturity = DateValue(LSTRCONDATE)
                    LConType = Left$(TxtRec!F9, 1)
                    If LConType = "1" Then
                        LSPtyContype = "B"
                    Else
                        LSPtyContype = "S"
                    End If
                    LRATE = Val(TxtRec!f12)
                    If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                        LQTY = Val(TxtRec!F13) * Val(TxtQtyMultipler.text)
                    Else
                        LQTY = Val(TxtRec!F13)
                    End If
                    LLOT = 1
                    LUserId = TxtRec!f3:       mparty = TxtRec!f25
                    MSPARTY = LExCont
                End Select
                LSEXID = Get_ExID(LSExCode)
                DoEvents
                Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, True, 1)
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                MSPARTY = LExCont
                
                If LTradeFileType = "1" Or LTradeFileType = "3" Or LTradeFileType = "4" Then
                    mbparty = LParty
                Else
                     mbparty = Get_ACCT_EX(LSEXID, mparty)
                End If
                
                If LenB(mbparty) < 1 Then mbparty = NewParty(LSExCode, mparty, mparty, mparty, True)
                If LenB(mbparty) < 1 Then
                    LMsgBox = "Please create  Account For  " & mparty & ""
                    ImportIssues (LMsgBox)
                    GoTo EFlag_Next
                End If
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                If InStr(LBillExId, str(LSEXID)) = 0 Then
                    If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                    LBillExId = LBillExId & str(LSEXID)
                End If
                If lminbilldate > LSCondate Then lminbilldate = LSCondate
                LNoTrd = LNoTrd + 1
                GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                DoEvents
            
                LClient = mbparty
                Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, LTradeFileType, "Y", LSEXID, LSItemid, LSSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
flag210:
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
      
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Public Sub Create_SchemaFileMCX(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 100"):    A.WriteLine ("Col2 = F2 Text Width 100")
    A.WriteLine ("Col3 = F3 Text Width 100"):    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100"):    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100"):    A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100"):    A.WriteLine ("Col10 = F10 Text Width 100")
    A.WriteLine ("Col11 = F11 Text Width 100"):    A.WriteLine ("Col12 = F12 Text Width 100")
    A.WriteLine ("Col13 = F13 Text Width 100"):    A.WriteLine ("Col14 = F14 Text Width 100")
    A.WriteLine ("Col15 = F15 Text Width 100"):    A.WriteLine ("Col16 = F16 Text Width 100")
    A.WriteLine ("Col17 = F17 Text Width 100"):    A.WriteLine ("Col18 = F18 Text Width 100")
    A.WriteLine ("Col19 = F19 Text Width 100"):    A.WriteLine ("Col20 = F20 Text Width 100")
    A.WriteLine ("Col21 = F21 Text Width 100"):    A.WriteLine ("Col22 = F22 Text Width 100")
    A.WriteLine ("Col23 = F23 Text Width 100"):    A.WriteLine ("Col24 = F24 Text Width 100")
    A.WriteLine ("Col25 = F25 Text Width 100"):    A.WriteLine ("Col26 = F26 Text Width 100")
    A.WriteLine ("Col27 = F27 Text Width 100"):    A.WriteLine ("Col28 = F28 Text Width 100")
    A.WriteLine ("Col29 = F29 Text Width 100")
    A.WriteLine ("Col30 = F30 Text Width 100")
    A.WriteLine ("Col31 = F31 Text Width 100")
    A.WriteLine ("Col32 = F32 Text Width 100")
    A.WriteLine ("Col33 = F33 Text Width 100")
    A.WriteLine ("Col34 = F34 Text Width 100")
    A.WriteLine ("Col35 = F35 Text Width 100")
    
    
    A.close
End Sub

Public Sub Create_SchemaFileMCX_ONLINE_NEW(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 100"):    A.WriteLine ("Col2 = F2 Text Width 100")
    A.WriteLine ("Col3 = F3 Text Width 100"):    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100"):    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100"):    A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100"):    A.WriteLine ("Col10 = F10 Text Width 100")
    A.WriteLine ("Col11 = F11 Text Width 100"):    A.WriteLine ("Col12 = F12 Text Width 100")
    A.WriteLine ("Col13 = F13 Text Width 100"):    A.WriteLine ("Col14 = F14 Text Width 100")
    A.WriteLine ("Col15 = F15 Text Width 100"):    A.WriteLine ("Col16 = F16 Text Width 100")
    A.WriteLine ("Col17 = F17 Text Width 100"):    A.WriteLine ("Col18 = F18 Text Width 100")
    A.WriteLine ("Col19 = F19 Text Width 100"):    A.WriteLine ("Col20 = F20 Text Width 100")
    A.WriteLine ("Col21 = F21 Text Width 100"):    A.WriteLine ("Col22 = F22 Text Width 100")
    A.WriteLine ("Col23 = F23 Text Width 100"):    A.WriteLine ("Col24 = F24 Text Width 100")
    A.WriteLine ("Col25 = F25 Text Width 100"):    A.WriteLine ("Col26 = F26 Text Width 100")
    A.WriteLine ("Col27 = F27 Text Width 100"):    A.WriteLine ("Col28 = F28 Text Width 100")
    A.WriteLine ("Col29 = F29 Text Width 100")
    A.close
End Sub

Public Sub GET_JCnn(LPDSource As String)

    Dim LFolderName As String
    LFolderName = Replace(LPDSource, "\", "")
    LFolderName = Replace(LFolderName, ";", "")
        
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
        LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
    End If
    Set LFileSystemObject = Nothing


    Set Jcnn = Nothing
    Set Jcnn = New ADODB.Connection
    Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
    "Data Source=" & App.Path & LPDSource & _
    "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""

err1:

    If err.Number <> 0 Then
        '&& LFileName & "  file not found" ', vbCritical
        LMsgBox = err.Description
        ImportIssues (LMsgBox)
        'MsgBox err.Description
        DoEvents
        Label11.Visible = False
    End If
End Sub
Public Function Chk_Trade(LPSauda As String, LPTrdNo As String, LPCondate As Date, LPSParty As String, LPConType As String) As Boolean
Dim NewRec As ADODB.Recordset
    Chk_Trade = False
    mysql = "SELECT CONNO FROM CTR_D WHERE COMPCODE=" & GCompCode & " "
    mysql = mysql & " And ROWNO1 ='" & LPTrdNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS AND CONDATE ='" & Format(LPCondate, "yyyy/MM/dd") & "'"
    mysql = mysql & " AND PARTY='" & LPSParty & "'AND CONTYPE <>'" & LPConType & "'"
    Set NewRec = Nothing:   Set NewRec = New ADODB.Recordset
    NewRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not NewRec.EOF Then Chk_Trade = True
End Function
Public Sub Get_ExDetail(LPExCode As String)
Dim ExRec As ADODB.Recordset
    If LPExCode = "FX" Then
        mysql = "SELECT * FROM SAUDAMAST WHERE SAUDACODE=  'USDINR' "
        Set ExRec = Nothing: Set ExRec = New ADODB.Recordset
        ExRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not ExRec.EOF Then
            LPExCode = ExRec!excode
        End If
    End If
    Set ExRec = Nothing: Set ExRec = New ADODB.Recordset
    mysql = " SELECT EXID,CLOSEFILE,Brokertype,PARTYAS,MEMBERID,CONTRACTACC,CASHACC,BANKCLI,TRADEDI,LOTWISE,OPTIONS,OPTINDEX,"
    mysql = mysql & " CONTAC2,BROKTYPE2,MEMID2,CONTAC2,MEMID3,CONTAC3,BROKTYPE3,MEMID4,CONTAC4,BROKTYPE4,MEMID5, CONTAC5,BROKTYPE5,MEMID6,CONTAC6,TFILETYPE "
    mysql = mysql & " FROM EXMAST WHERE COMPCODE =" & GCompCode & " AND EXCODE = '" & LPExCode & "'"
    ExRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not ExRec.EOF Then
        If InStr(LBillExId, ExRec!EXID) = 0 Then
            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
            LBillExId = LBillExId & str(ExRec!EXID)
        End If
        LExCont = IIf(IsNull(ExRec!CONTRACTACC), vbNullString, Trim(ExRec!CONTRACTACC))
        LCashAcc = IIf(IsNull(ExRec!CASHACC), vbNullString, Trim(ExRec!CASHACC))
        LContraCashAcc = IIf(IsNull(ExRec!BANKCLI), vbNullString, Trim(ExRec!BANKCLI))
        
        LMemberId = IIf(IsNull(ExRec!MemberId), vbNullString, ExRec!MemberId)
        LPartyAs = IIf(IsNull(ExRec!PARTYAS), "C", Left$(ExRec!PARTYAS, 1))
        LProAs = IIf(IsNull(ExRec!TRADEDI), "Client", ExRec!TRADEDI)
        LLotWise = IIf(IsNull(ExRec!LOTWISE), "N", ExRec!LOTWISE)
        LBrokerType = UCase(Trim(ExRec!BROKERTYPE & vbNullString))
        LMemId2 = Trim(IIf(IsNull(ExRec!MEMID2), vbNullString, ExRec!MEMID2))
        LMemId3 = Trim(IIf(IsNull(ExRec!MEMID3), vbNullString, ExRec!MEMID3))
        LMemId4 = Trim(IIf(IsNull(ExRec!MEMID4), vbNullString, ExRec!MEMID4))
        LMemId5 = Trim(IIf(IsNull(ExRec!MEMID5), vbNullString, ExRec!MEMID5))
        LMemId6 = Trim(IIf(IsNull(ExRec!MEMID6), vbNullString, ExRec!MEMID6))
        LContAc2 = Trim(IIf(IsNull(ExRec!CONTAC2), vbNullString, ExRec!CONTAC2))
        LContAc3 = Trim(IIf(IsNull(ExRec!CONTAC3), vbNullString, ExRec!CONTAC3))
        LContAc4 = Trim(IIf(IsNull(ExRec!CONTAC4), vbNullString, ExRec!CONTAC4))
        LContAc5 = Trim(IIf(IsNull(ExRec!CONTAC5), vbNullString, ExRec!CONTAC5))
        LContAc6 = Trim(IIf(IsNull(ExRec!CONTAC6), vbNullString, ExRec!CONTAC6))
        LBrokerType2 = IIf(IsNull(ExRec!BROKTYPE2), vbNullString, ExRec!BROKTYPE2)
        LBrokerType3 = IIf(IsNull(ExRec!BROKTYPE3), vbNullString, ExRec!BROKTYPE3)
        LBrokerType4 = IIf(IsNull(ExRec!BROKTYPE4), vbNullString, ExRec!BROKTYPE4)
        LBrokerType5 = IIf(IsNull(ExRec!BROKTYPE5), vbNullString, ExRec!BROKTYPE5)
        LEXOptions = IIf(IsNull(ExRec!Options), "N", ExRec!Options)
        LOPTINDEX = IIf(IsNull(ExRec!Optindex), "N", ExRec!Optindex)
        LGCloseFile = ExRec!CLOSEFILE
        LTradeFileType = Trim$(ExRec!TFILETYPE & vbNullString)
    Else
        LExCont = vbNullString
        MsgBox "Please Import again as Exchange contract account not defined for " & LSExCode, vbInformation
    End If
End Sub

Public Sub Create_MG13_SchemaFile(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 100"):    A.WriteLine ("Col2 = F2 Text Width 100")
    A.WriteLine ("Col3 = F3 Text Width 100"):    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100"):    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100"):    A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100"):    A.WriteLine ("Col10 = F10 Text Width 100")
    A.close
End Sub
Public Sub Create_MG23_SchemaFile(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 100"):    A.WriteLine ("Col2 = F2 Text Width 100")
    A.WriteLine ("Col3 = F3 Text Width 100"):    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100"):    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100"):    A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100"):    A.WriteLine ("Col10 = F10 Text Width 100")
    A.WriteLine ("Col11 = F11 Text Width 100"):   A.WriteLine ("Col12 = F12 Text Width 100")
    A.WriteLine ("Col13 = F13 Text Width 100"):    A.WriteLine ("Col14 = F14 Text Width 100")
    A.WriteLine ("Col5 = F15 Text Width 100")
    A.WriteLine ("Col6 = F15 Text Width 100")
    A.WriteLine ("Col7 = F15 Text Width 100")
    A.WriteLine ("Col8 = F15 Text Width 100")
    A.WriteLine ("Col9 = F15 Text Width 100")
    
    
    A.close
End Sub
Sub MCX_Margin()
On Error GoTo err1
Dim LRegMargin As Double:       Dim LAddMargin As Double:       Dim LTenMargin As Double:       Dim LDelMargin As Double
Dim LSpMargin As Double:        Dim LNetBuyMargin As Double:    Dim LTotalMargin As Double:     Dim LTotMTMLoss As Double
Dim MBal As Double:             Dim MOpBal As Double:           Dim LBal As Double:             Dim RecOpBal As ADODB.Recordset
Dim ltradedt As Date:           Dim LSCondate As Date:          Dim TxtPath As String:          Dim LFileName As String
Dim LMFLPath As String:         Dim LClient As String:          Dim TRec As ADODB.Recordset:    Dim LParty As String
Dim LExID As Integer
Dim LPeakPer As Double
Dim LPeakMargin  As Double
    
    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    LSExCode = "MCX"
    Call Get_ExDetail(LSExCode)
    Call GET_JCnn("\MCX;")
        
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "MCX") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "MCX")
    End If
    Set LFileSystemObject = Nothing
    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "MCX_Margin_" & LMemberId & "_" & Right$(CStr(Year(ltradedt)), 4) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".CSV"
        LFileName = App.Path & "\MCX\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            LMFLPath = App.Path & "\MCX\"
            Call Create_Schema_Mcx_Margin_File(LMFLPath, TxtPath)
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & " "
            TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                LExID = Get_ExID(LSExCode)
                Cnn.Execute "DELETE FROM DAILYMARGIN WHERE COMPCODE =" & GCompCode & " AND CONDATE  = '" & Format(LSCondate, "yyyy/MM/dd") & "'  AND EXCODE='MCX'"
                TxtRec.MoveFirst
                While Not TxtRec.EOF
                    LClient = Trim(TxtRec!f3 & vbNullString):       LRegMargin = Val(TxtRec!F4 & vbNullString)
                    LAddMargin = Val(TxtRec!F5 & vbNullString):     LTotMTMLoss = Val(TxtRec!f6 & vbNullString):
                    LTotalMargin = Val(LRegMargin + LAddMargin)
                    LPeakPer = Val(TxtRec!f12 & vbNullString)
                    LPeakMargin = Val(TxtRec!F13 & vbNullString)
                    
                    LParty = Get_ACCT_EX(LExID, LClient)
                    If LenB(LParty) < 1 Then GoTo EFlag_Next
                    Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                    mysql = "SELECT OP_BAL FROM ACCOUNTM WHERE COMPCODE =" & GCompCode & " AND AC_CODE='" & LParty & "'"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then MOpBal = Val(TRec!OP_BAL & "")
                    MBal = MOpBal:                    LBal = 0
                    LBal = Net_DrCr(LParty, DateValue(LSCondate))
                    MBal = MBal + LBal
                    
                    mysql = "INSERT INTO DAILYMARGIN(COMPCODE,EXCODE,CONDATE,PARTY,ACEXCODE,REGMARGIN,ADDMARGIN,TENMARGIN,DELMARGIN,SPMARGIN,"
                    mysql = mysql & " NETBUYMARGIN,TOTALMARGIN,NETBAL,TOTALMTM,EXID,PEAKPER,PEAKMARGIN)"
                    mysql = mysql & " VALUES (" & GCompCode & ",'" & LSExCode & "','" & Format(LSCondate, "yyyy/MM/dd") & "','" & LParty & "','" & LClient & "'"
                    mysql = mysql & " ," & Val(LRegMargin) & "," & Val(LAddMargin) & "," & Val(LTenMargin) & "," & Val(LDelMargin) & "," & Val(LSpMargin) & ""
                    mysql = mysql & ", " & Val(LNetBuyMargin) & "," & Val(LTotalMargin) & "," & MBal & "," & Val(LTotMTMLoss) & " ," & LExID & "," & LPeakPer & "," & LPeakMargin & ")"
                    Cnn.Execute mysql
EFlag_Next:
                    TxtRec.MoveNext
                Wend
                Set TRec = Nothing
            End If
        End If
    Next
    Set TxtRec = Nothing
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Public Sub Create_SchemaNSEFile(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]"):                   A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited"):              A.WriteLine ("Col1 = F1 Text Width 50")
    A.WriteLine ("Col2 = F2 Text Width 50"):            A.WriteLine ("Col3 = F3 Text Width 50")
    A.WriteLine ("Col4 = F4 Text Width 100"):           A.WriteLine ("Col5 = F5 Text Width 100")
    A.WriteLine ("Col6 = F6 Text Width 100"):           A.WriteLine ("Col7 = F7 Text Width 100")
    A.WriteLine ("Col8 = F8 Text Width 100"):           A.WriteLine ("Col9 = F9 Text Width 100")
    A.WriteLine ("Col10 = F10 Text Width 100"):         A.WriteLine ("Col11 = F11 Text Width 100")
    A.WriteLine ("Col12 = F12 Text Width 50"):          A.WriteLine ("Col13 = F13 Text Width 100")
    A.WriteLine ("Col14 = F14 Text Width 100"):         A.WriteLine ("Col15 = F15 Text Width 100")
    A.WriteLine ("Col16 = F16 Text Width 100"):         A.WriteLine ("Col17 = F17 Text Width 100")
    A.WriteLine ("Col18 = F18 Text Width 100"):         A.WriteLine ("Col19 = F19 Text Width 100")
    A.WriteLine ("Col20 = F20 Text Width 100"):         A.WriteLine ("Col21 = F21 Text Width 100")
    A.WriteLine ("Col22 = F22 Text Width 100"):         A.WriteLine ("Col23 = F23 Text Width 100")
    A.WriteLine ("Col24 = F24 Text Width 100"):         A.WriteLine ("Col25 = F25 Text Width 100")
    A.WriteLine ("Col26 = F26 Text Width 100"):         A.WriteLine ("Col27 = F27 Text Width 100")
    A.WriteLine ("Col28 = F28 Text Width 100"):         A.WriteLine ("Col29 = F29 Text Width 100")
    A.WriteLine ("Col30 = F30 Text Width 100"):         A.WriteLine ("Col31 = F31 Text Width 100")
    A.close
End Sub
Sub Fut_AllTerminal()
    Dim LMFLPath As String:     Dim LOverwrite As Boolean:    Dim ltradedt As Date:         Dim TxtPath As String
    Dim LFileName As String:    Dim LSCondate As Date:        Dim TRec As ADODB.Recordset:  Dim LFolderName As String
    
    On Error GoTo ERR21
    Call GET_JCnn("\NSE;")
    LSExCode = "NSE"
        
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "NSE") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "NSE")
    End If
    Set LFileSystemObject = Nothing
    
    Cnn.BeginTrans
    CNNERR = True:
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    
    LOverwrite = IIf(Check14 = 1, False, True)
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If MsgBox("Are you Sure to Delete Trades of NSE All terminals " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND EXCODE ='NSE' AND DATAIMPORT=1 AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "'"
            Cnn.Execute mysql
        End If
        If LBrokerType = "M" Then
            TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "_" & LMemberId & ".TXT"
        Else
            TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
        End If
        LFileName = App.Path & "\NSE\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            LMFLPath = App.Path & "\NSE\"
            Call Create_SchemaNSEFile(LMFLPath, TxtPath)
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "SELECT * FROM " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                If LBrokerType = "M" Then
                    LSCondate = DateValue(Left$(TxtRec!F21, 2) & "/" & Mid(TxtRec!F21, 4, 3) & "/" & Mid(TxtRec!F21, 8, 4))
                Else
                    LSCondate = ltradedt
                End If
                If LOverwrite = True Then Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "'  AND DATAIMPORT =1 AND  EXCODE='" & LSExCode & "'"
                'Call Save_Fut_Trade
                Call Save_Fut_AllTerminal(LSCondate, LBrokerType)
            End If
        End If
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        mysql = "SELECT FOLDERNAME,CONTRACTACC,BROKERTYPE,PARTYAS,CLIENTCODE,EXFILETYPE FROM EXFILE WHERE COMPCODE =" & GCompCode & " AND EXCODE='NSE' ORDER BY FILEID "
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            LClientCode = vbNullString
            LExCont = TRec!CONTRACTACC
            LBrokerType = TRec!BROKERTYPE
            LFolderName = TRec!FOLDERNAME
            GExFileType = Val(TRec!EXFILETYPE & vbNullString)
            LPartyAs = TRec!PARTYAS
            If LPartyAs = "F" Then LClientCode = TRec!CLIENTCODE
            If LBrokerType = "M" Then
                TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "_" & LMemberId & ".TXT"
            ElseIf LBrokerType = "X" Then
                TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
            ElseIf LBrokerType = "E" Then
                TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
            Else
                TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
            End If
            Call GET_JCnn("\" & LFolderName & "\;")
            LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
            
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
                LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
            End If
            Set LFileSystemObject = Nothing
            
            If Not FileExist(LFileName) Then
                LMsgBox = LFileName & "  file not found" ', vbCritical
                ImportIssues (LMsgBox)
            Else
                LOverwrite = False
                Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                If Not TxtRec.EOF Then
                    FlagDataTrf = True
                    If LBrokerType = "M" Then
                        LSCondate = DateValue(Left$(TxtRec!F21, 2) & "/" & Mid(TxtRec!F21, 4, 3) & "/" & Mid(TxtRec!F21, 8, 4))
                    ElseIf LBrokerType = "X" Then
                        LSCondate = ltradedt
                    Else
                        'LSCondate = DateValue(Left$(TxtRec!F22, 2) & "/" & Mid(TxtRec!F22, 4, 3) & "/" & Mid(TxtRec!F22, 8, 4))
                        LSCondate = ltradedt
                    End If
                    'Call Save_Fut_Trade
                    Call Save_Fut_AllTerminal(LSCondate, LBrokerType)
                End If
            End If
            TRec.MoveNext
        Loop
    Next
    Cnn.CommitTrans
    CNNERR = False
Exit Sub
ERR21:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If

End Sub
Sub Save_Fut_AllTerminal(LMDT As Date, LBrkType As String)
    Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
    Dim MCount As Long:             Dim LConType As String:         Dim LSConSno As Long:           Dim LQTY As Double
    Dim LContime As String:         Dim LOrdNo As String:           Dim LOrdTime As String:         Dim lyear As String
    Dim LSCondate As Date:          Dim LOConNo As String:          Dim StrDateLen As Integer:      Dim LSTRDATE As String
    Dim LClient As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
    Dim TRec As ADODB.Recordset:    Dim LUserId As String:          Dim LPartyName As String:
    Dim LEXHCODE As String:         Dim LMULTI  As Double:          Dim LRATE As Double:            Dim LMONTH As String
    Dim LSPtyContype As String:
    LSCondate = LMDT
    MCount = Get_Max_ConNo(LSCondate, 0)
    TxtRec.MoveFirst
    LSExCode = "NSE"
    LSEXID = Get_ExID(LSExCode)
    While Not TxtRec.EOF
        LOrdNo = vbNullString:      LSItemCode = vbNullString:      LSSaudaCode = vbNullString:  mparty = vbNullString:
        LContime = vbNullString:    LOConNo = vbNullString:         LQTY = 0:                    LOrdNo = vbNullString
        LSInstType = "FUT":         LSOptType = vbNullString:       LSStrike = 0:                LSPtyContype = "B":
        LSSaudaID = 0:              LOConNo = vbNullString:         LOrdTime = vbNullString:     LLOT = 1:
        LRATE = 0:                  LSItemid = 0:
        If Not IsNull(TxtRec!F1) Then
            LSCondate = LMDT
            If LBrokerType = "M" Then
                LEXHCODE = Trim(TxtRec!f3):               LContime = Right$(TxtRec!F21, 8)
                LUserId = Trim(TxtRec!f11):               LConType = Trim(TxtRec!F13)
                LRATE = Val(TxtRec!F15):                  LQTY = Val(TxtRec!F14)
                mparty = Trim(TxtRec!F18):                LPartyName = Trim(TxtRec!F17)
                LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 4, 3) & "/" & Mid(TxtRec!F5, 8, 4))
                LOConNo = Trim(TxtRec!F1)
            ElseIf LBrokerType = "X" Then
                If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                If Not IsNumeric(TxtRec!F7) Then GoTo EFlag_Next
                LSInstType = "FUT":                LOConNo = Trim(TxtRec!F1)
                LEXHCODE = TxtRec!f3:              LSMaturity = DateValue(Left$(TxtRec!F4, 2) & "/" & Mid(TxtRec!F4, 4, 3) & "/20" & Right(TxtRec!F4, 2))
                LConType = Left(TxtRec!f6, 1):     LRATE = Val(TxtRec!F7)
                LQTY = Val(TxtRec!F8):             LContime = TxtRec!F9
                LSCondate = DateValue(Left$(TxtRec!f12, 2) & "/" & Mid(TxtRec!f12, 4, 3) & "/20" & Right(TxtRec!f12, 2))
                mparty = TxtRec!F13
                If LConType = "S" Then LSPtyContype = "S"
            Else
                LOConNo = Trim(TxtRec!F1)
                LEXHCODE = LTrim$(RTrim$((TxtRec!F4))):                LOrdNo = TxtRec!F24
                LContime = Right$(TxtRec!f22, 8)
                LUserId = TxtRec!f12:                                       LConType = TxtRec!F14
                LRATE = Val(TxtRec!f16):                                    LQTY = Val(TxtRec!F15)
                LClient = Trim(TxtRec!F18):                                 LSInstType = IIf(IsNull(TxtRec!f3), "FUT", TxtRec!f3)
                LSOptType = IIf(IsNull(TxtRec!F7), vbNullString, TxtRec!F7): LSStrike = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
                If InStr(TxtRec!F5, "/") Then
                    LSMaturity = DateValue(TxtRec!F5)
                Else
                    LSMaturity = DateValue(Left$(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 3, 3) & "/" & Mid(TxtRec!F5, 6, 4))
                End If
                If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then LQTY = LQTY * Val(TxtQtyMultipler.text)
                If LPartyAs = "U" Then
                    mparty = LUserId
                    LPartyName = LUserId
                Else
                    If LBrokerType = "C" Then
                        If LPartyAs = "C" Then
                            mparty = Trim(TxtRec!F18)
                        Else
                            mparty = LUserId
                        End If
                    Else
                        mparty = Trim(TxtRec!F18)
                    End If
                End If
                If Left$(LSInstType, 3) = "FUT" Then
                    LSInstType = "FUT"
                Else
                    LSInstType = "OPT"
                End If
            End If
            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, True, True, 1)
            If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
            Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
            If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
            LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
            If LLotWise = "Y" Then LQTY = LQTY / LLOT
            MSPARTY = LExCont
            If CHKFutureRemark.Value = 1 Then
                If LenB(TxtRec!f29) <> 0 Then
                    mparty = Trim(TxtRec!f29)
                    LPartyName = Trim(TxtRec!f29)
                End If
            End If
            If LConType = "2" Then LSPtyContype = "S"
            mbparty = vbNullString
            mbparty = NewParty(LSExCode, mparty, mparty & " " & LSExCode, LUserId, True)
            If LenB(mbparty) = 0 Then GoTo EFlag_Next
            LMULTI = 1
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT MULTIPLIER FROM ACCOUNTD WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & mbparty & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                If TRec!MULTIPLIER = "1" Then
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    mysql = "SELECT RATE FROM PARTYMULTI WHERE COMPCODE =" & GCompCode & " AND PARTY='" & mbparty & "' AND ITEMCODE ='" & LSItemCode & "'"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LQTY = LQTY * TRec!Rate
                        LMULTI = TRec!Rate
                    Else
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT RATE FROM PARTYMULTI WHERE COMPCODE =" & GCompCode & " AND PARTY='" & mbparty & "' AND EXID =" & LSEXID & " AND ITEMCODE =''"
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec.EOF Then
                            LQTY = LQTY * TRec!Rate
                            LMULTI = TRec!Rate
                        End If
                    End If
                End If
            End If
            If LBrokerType = "A" Then
                MSPARTY = LClient
                MSPARTY = NewParty(LSExCode, MSPARTY, MSPARTY, LUserId, True)
            End If
            If LenB(MSPARTY) < 1 Then
                MSPARTY = LExCont
            End If
            If LPartyAs = "F" Then mbparty = LClientCode
            
            If LClient <> "8601" And GCINNo = "2000" Then GoTo EFlag_Next
            
            If Chk_Trade(LSSaudaCode, LOConNo, LSCondate, MSPARTY, LSPtyContype) = False Then
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                MCount = MCount + 1
                If InStr(LBillExId, str(LSEXID)) = 0 Then
                    If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                    LBillExId = LBillExId & str(LSEXID)
                End If
                If lminbilldate > LSCondate Then lminbilldate = LSCondate
                LNoTrd = LNoTrd + 1
                GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                DoEvents
            
                Call Add_To_Ctr_D(LSPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
                If LMULTI <> 1 Then
                    mysql = "UPDATE CTR_D SET MULTI =" & LMULTI & " WHERE COMPCODE =" & GCompCode & " AND CONSNO =" & LSConSno & " AND CONNO =" & MCount & " "
                    Cnn.Execute mysql
                End If
            End If
        End If
EFlag_Next:
            TxtRec.MoveNext
        Wend
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
       
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Public Sub Create_Schema_Mcx_Margin_File(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 50")
    A.WriteLine ("Col2 = F2 Text Width 50")
    A.WriteLine ("Col3 = F3 Text Width 50")
    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100")
    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100")
    A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100")
    A.WriteLine ("Col10 = F10 Text Width 100")
    A.WriteLine ("Col11 = F11 Text Width 100")
    A.WriteLine ("Col12 = F12 Text Width 100")
    A.WriteLine ("Col13 = F13 Text Width 100")
    A.WriteLine ("Col14 = F14 Text Width 100")
    A.WriteLine ("Col15 = F15 Text Width 100")

    A.close
    
End Sub

Public Sub Create_Schema_Excel10(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 50")
    A.WriteLine ("Col2 = F2 Text Width 50")
    A.WriteLine ("Col3 = F3 Text Width 50")
    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100")
    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100")
    A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100")
    A.WriteLine ("Col10 = F10 Text Width 100")
    A.close
End Sub

Public Function Create_CItemMast(ByVal LCItemCode As String, ByVal LCItemName As String, ByVal LCExhCode As String, ByVal LCLot As Double, ByVal LCExCode As String) As String
Dim LCItemCode1 As String
LCItemCode1 = vbNullString
LCItemCode1 = Get_ContractMaster(LCExCode, LCExhCode)
If LenB(LCItemCode1) < 1 Then
    If Duplicate_CItem_Chk(LCItemCode) Then
        LCItemCode1 = Trim(LCExCode) & " " & Trim(LCItemCode)
        If Duplicate_CItem_Chk(LCItemCode1) Then
            MsgBox "Please Check Entry for " & LCExhCode & ""
            Create_CItemMast = vbNullString
            Exit Function
        End If
    Else
        LCItemCode1 = LCItemCode
    End If
    Call PInsert_ContractMaster(LCExCode, LCItemCode1, LCItemName, LCExhCode, LCLot, vbNullString, vbNullString, vbNullString, vbNullString, 0)
    Label3.Caption = "Creating New Item/Script in ContractMaster" & LCItemName & ""
    'DoEvents
End If
Create_CItemMast = LCItemCode1
End Function
Public Function Create_SSaudaMast(LPExhCode As String, LPMDate As Date, LPExCode As String, LPInstType As String, LPOptType As String, LPStrike As Double, LPItemCode As String) As String
Dim LPSaudaCode As String: LPSaudaCode = vbNullString: Dim LPLLOT As Double
Dim TRec  As ADODB.Recordset
LPSaudaCode = Get_ScriptMaster(LPExhCode, LPMDate, LPExCode, LPInstType, LPOptType, LPStrike)
If LenB(LPSaudaCode) < 1 Then
    If LenB(LPItemCode) < 1 Then
        mysql = "SELECT ITEMCODE FROM CONTRACTMASTER WHERE EXCODE='" & LPExCode & "'AND EX_SYMBOL ='" & LPExhCode & "'"
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If TRec.EOF Then
            LPItemCode = LPExhCode
        Else
            LPItemCode = TRec!ITEMCODE
        End If
    End If
    Set TRec = Nothing
    
    If LPInstType = "FUT" Then
        LPSaudaCode = Trim(LPItemCode) & " " & Left$(CStr(Day(LPMDate)), 2) & UCase(Left$(MonthName(Val(month(LPMDate))), 3)) & Right$(Year(LPMDate), 2)
    ElseIf LPInstType = "OPT" Then
        LPSaudaCode = Trim(LPItemCode) & " " & LPInstType & " " & LPOptType & " " & Trim(CStr(LPStrike)) & " " & Left$(CStr(Day(LPMDate)), 2) & UCase(Left$(MonthName(Val(month(LPMDate))), 3)) & Right$(Year(LPMDate), 2)
    Else
        LPSaudaCode = Trim(LPItemCode) & " " & LPInstType
    End If
    If Duplicate_SSauda_Chk(LPSaudaCode) = True Then
        LPSaudaCode = LPExCode & " " & LPSaudaCode
        If Duplicate_SSauda_Chk(LPSaudaCode) = True Then
            MsgBox "Please Check Entry for " & LPSaudaCode & ""
            Create_SSaudaMast = vbNullString
            Exit Function
        End If
    End If
    LPLLOT = 1
    If GAmtDivide = "1" Then LPLLOT = LPLLOT / 100
    Call PInsert_SCRIPTMASTER(LPExCode, LPExhCode, LPItemCode, LPLLOT, LPSaudaCode, LPSaudaCode, LPMDate, LPStrike, LPOptType, LPInstType, 0, 1, 1)
    Label3.Caption = "Creating new Contract in ScriptMaster " & LPSaudaCode & ""
   ' DoEvents
End If
Create_SSaudaMast = LPSaudaCode
End Function
Public Function Create_SaudaMast(ByVal LPExhCode As String, ByVal LPMDate As Date, ByVal LPExCode As String, ByVal LPInstType As String, ByVal LPOptType As String, _
ByVal LPStrike As Double, LPEXID As Integer, lpitemid As Integer) As String
Dim TRec As ADODB.Recordset:    Dim LPSaudaCode As String
Dim LPLot As Double:            Dim LPBrokLot As Double:        Dim LRefLot As Double

LPSaudaCode = Get_SaudaMaster(LPEXID, lpitemid, LPMDate, LPInstType, LPOptType, LPStrike)
If LenB(LPSaudaCode) < 1 Then
    If LPInstType = "FUT" Then
        LPSaudaCode = Trim(LPExhCode) & " " & Left$(CStr(Day(LPMDate)), 2) & UCase(Left$(MonthName(Val(month(LPMDate))), 3)) & Right$(Year(LPMDate), 2)
    ElseIf LPInstType = "OPT" Then
        LPSaudaCode = Trim(LPExhCode) & " " & LPInstType & " " & LPOptType & " " & LPStrike & " " & Left$(CStr(Day(LPMDate)), 2) & UCase(Left$(MonthName(Val(month(LPMDate))), 3)) & Right$(Year(LPMDate), 2)
    Else
        If LPExCode = "BEQ" Or LPExCode = "EQ" Then LPSaudaCode = Trim(LPExhCode) & " " & LPInstType
    End If
    If Duplicate_Sauda_Chk(LPSaudaCode) = True Then
        LPSaudaCode = LPExCode & " " & LPSaudaCode
        If Duplicate_Sauda_Chk(LPSaudaCode) = True Then
            MsgBox "Please Check Entry for " & LPSaudaCode & ""
            Create_SaudaMast = vbNullString
            Exit Function
        End If
    End If
    LPLot = 1: LRefLot = 1
    mysql = "SELECT LOT,BROKLOT,REFLOT FROM SCRIPTMASTER WHERE EX_SYMBOL='" & LPExhCode & "'"
    mysql = mysql & " AND MATURITY='" & Format(LPMDate, "yyyy/MM/dd") & "' AND EXCODE ='" & LPExCode & "'AND INSTTYPE ='" & LPInstType & "' AND OPTTYPE='" & LPOptType & "' AND STRIKEPRICE = " & LPStrike & ""
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then
        LPLot = TRec!lot
        LPBrokLot = TRec!BROKLOT
        LRefLot = TRec!REFLOT
    End If
    
   ' MsgBox " Create New Contract " & LPSaudaCode & " " & LPExCode & " " & LPExhCode & " " & LPMDate & " " & LPInstType & " " & LPOptType & " " & LPStrike & " " & LPLot & " " & LRefLot & " " & LPBrokLot & " "
    Call PInsert_Saudamast(LPSaudaCode, LPSaudaCode, LPExhCode, LPMDate, LPLot, LPBrokLot, 0, LPInstType, LPOptType, LPStrike, LPExCode, LRefLot, LPEXID, lpitemid)
End If
Create_SaudaMast = LPSaudaCode
End Function

Sub Save_All_BhavCopy(LTExCode As String)

    Dim ltradedt As Date:               Dim LSCondate As Date:              Dim TxtPath As String:              Dim LFileName As String:
    Dim LEXHCODE As String:             Dim LSConSno As Long:               Dim lOpRate As Double:              Dim TxtoPath As String:
    Dim LCloseRate As Double:           Dim LLOT As Double:                 Dim LVol As Double:                 Dim LRemoteFileName As String:
    Dim LHighRate As Double:            Dim LLowRate As Double:             Dim LSettleRate As Double:          Dim LCL As Double
    Dim LFiledownload As Boolean:       Dim LClosingFileName As String:     Dim LTargetFileName As String:      Dim LReName As Boolean
    Dim lfiletype As String:            Dim LMONTH As String:               Dim A As Integer:                   Dim LNewItem As String
    Dim LOFileName As String:           Dim LSTRCONDATE As String:          Dim TRec As ADODB.Recordset:        Dim LNewFileName As String
    Dim McxDateWise As Boolean:         Dim lyear As String:                Dim LCMONTH As String:              Dim LMinSaudaDate  As String
    Dim LZipFileName As String:         Dim LBSEFXFile As Integer:          Dim LStrMonth As String:           Dim LStrYear As String:
    Dim LRenameFile As Boolean::        Dim B As Integer:                   Dim TRec2 As ADODB.Recordset
    Dim NseFTPFILE As Boolean
    Dim LSCONTIME As String
    Dim lday As String
    Dim MURL As String
    Dim MFILE  As Integer
    MFILE = 1
    'Dim LOFileName As String
    
    GLOBALFLAG = True
    Dim VFiledownload As Boolean:    Dim Vdate As String:    Dim Vdate1 As String
    
   On Error GoTo err1
    Call GET_JCnn("\" & LTExCode & ";")
            
    Call Get_ExDetail(LTExCode)
    McxDateWise = False
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        NseFTPFILE = False
        Select Case LTExCode
        Case "MCX"
            
            If Len(Day(ltradedt)) = 1 Then
                Vdate = "0" & Day(ltradedt)
            Else
                Vdate = Day(ltradedt)
            End If

    
            If Len(month(ltradedt)) = 1 Then
                Vdate = Vdate & "-" & "0" & month(ltradedt)
            Else
                Vdate = Vdate & "-" & month(ltradedt)
            End If
            Vdate = Vdate & "-" & Year(ltradedt)
            
            Vdate1 = Year(ltradedt)
            If Len(month(ltradedt)) = 1 Then
                Vdate1 = Vdate1 & "0" & month(ltradedt)
            Else
                Vdate1 = Vdate1 & month(ltradedt)
            End If
            If Len(Day(ltradedt)) = 1 Then
                Vdate1 = Vdate1 & "0" & Day(ltradedt)
            Else
                Vdate1 = Vdate1 & Day(ltradedt)
            End If
        
            If ChkMCXExcelClosing.Value = 1 Then
                If LGCloseFile = 2 Then
                    TxtPath = "CLOSE" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                Else
                    TxtPath = "MCXBHAV" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                End If
                
            Else
                If ltradedt <= MCXChDt Then
                    TxtPath = "BC" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".CSV"
                ElseIf ltradedt <= MCXChDt2 Then
                    TxtPath = "MS" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".CSV"
                Else
                    LStrMonth = MonthName(month(ltradedt))
                    TxtPath = "MCX_MS" & CStr(Year(ltradedt)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Left$(ltradedt, 2)) & ".csv"
                    LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                        
                    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                        LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
                    End If
                    Set LFileSystemObject = Nothing
            
                    'If FileExist(LFileName) Then '>>> IF EXISTS THEN DELETE THE FILE
                    '        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    '        LFileSystemObject.DeleteFile LFileName
'                    End If
                        
                    If Not FileExist(LFileName) Then
                        '>> Closing Rate
                        'MURL = "http://" & IP_closing_rate & "/mcxbhavcopy.aspx?date=" & Vdate , App.Path & "\" & "MCX\MCX_MS" & Vdate1 & ".csv"
                        
                        VFiledownload = DownloadFile("http://" & IP_closing_rate & "/mcxbhavcopy.aspx?date= " & Vdate, App.Path & "\" & "MCX\MCX_MS" & Vdate1 & ".csv")
                        If Not VFiledownload Then
                            VFiledownload = DownloadFile("http://" & IP_closing_rate & "/mcxbhavcopy.aspx?date=" & Vdate, App.Path & "\" & "MCX\MCX_MS" & Vdate1 & ".csv")
                            DoEvents
                        End If
                                                                    
                        ''https://sftp.mcxindia.com/?user=mcxftp&password=Mcx@1234&dir=Common/Bhavcopy/APR-2020%20to%20MARCH-2021/September/&file=MCX_MS20200904.csv
                       ' LClosingFileName = "https://sftp.mcxindia.com/?user=mcxftp&password=Mcx@1234&dir=Common/Bhavcopy/APR-2020%20to%20MARCH-2021/" & LStrMonth & "/&file=" & TxtPath & ""
                        'LClosingFileName = "https://sftp.mcxindia.com/?user=mcxftp&password=Mcx@1234&dir=Common/Bhavcopy/APR-2023%20to%20MARCH-2024/april/&file=MCX_MS20230410.csv"
                        'L TargetFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                        'LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                        'TxtPath = "BhavCopyDateWise_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                        'LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                        'If Not FileExist(LFileName) Then McxDateWise = True
                    End If
                End If
                LSExCode = LTExCode
            End If
            LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
        Case "NCDX"
            If CHKNCDXExcelClosing.Value = 1 Then
                
                ''
                
'                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
'                If Not LFileSystemObject.FolderExists(App.Path & "\" & "NCDX") Then
'                    LFileSystemObject.CreateFolder (App.Path & "\" & "NCDX")
'                End If
'                Set LFileSystemObject = Nothing
'
'                TxtPath = "NCDEX_CN01_" & CStr(Left$(LTradeDt, 2)) & CStr(Mid(LTradeDt, 4, 2)) & CStr(Year(LTradeDt)) & ".CSV"
'                LFileName = App.Path & "\NCDX\" & TxtPath
'                LRemoteFileName = "/common/reports/" & TxtPath & ""
'                If Not FileExist(LFileName) Then
'                    Call Connect_Ftp("extranet.ncdex.com", "member", "ncdex123", LRemoteFileName, LFileName)
'                    If Not FileExist(LFileName) Then
'                        Call Connect_Ftp("drextranet.ncdex.com", "member", "ncdex123", LRemoteFileName, LFileName)
'                    End If
'                End If
                
                ''
                LMONTH = IIf(month(ltradedt) <= 9, "0" + CStr(month(ltradedt)), CStr(month(ltradedt)))
                TxtPath = "FO_" & CStr(Left(ltradedt, 2)) & LMONTH & Right(CStr(Year(ltradedt)), 2) & "_FINAL.CSV"
                LFileName = App.Path & "\NCDX\" & TxtPath
                
                'If FileExist(LFileName) Then '>>> IF EXISTS THEN DELETE THE FILE
                '        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                '        LFileSystemObject.DeleteFile LFileName
               ' End If
               
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\" & "NCDX") Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & "NCDX")
                End If
                Set LFileSystemObject = Nothing
                
                If Not FileExist(LFileName) Then
                    'https://ncdex.com/markets/bhavcopy?file_type=final&type=bhavcopy&filedate=01-Dec-2020&format=csv_file
                    'https://ncdex.com/Downloads/Bhavcopy_Summary_File/Export_csv/11-18-2020.csv
                    LOFileName = TxtPath
                    
                    'OLD
                    'LClosingFileName = "https://ncdex.com/markets/bhavcopy?file_type=final&type=bhavcopy&filedate=" & CStr(Left(LTradeDt, 2)) & "-" & Left(MonthName(month(LTradeDt)), 3) & "-" & Year(LTradeDt) & "&format=csv_file"
                    'MEW
                    LClosingFileName = "http://178.33.73.246/ncdexbhavcopy.aspx?date=" & CStr(month(ltradedt)) & "-" & CStr(Left(ltradedt, 2)) & "-" & Year(ltradedt) & "&format=csv_file"
                    LTargetFileName = App.Path & "\" & LTExCode & "\" & LOFileName
                    Call TDownloadFile(LClosingFileName, LTargetFileName)
                    If FTPerr <> "" Then
                        ImportIssues (FTPerr)
                        FTPerr = ""
                    End If
                    DoEvents
                    If Not GLOBALFLAG Then
                        LClosingFileName = "http://178.33.73.246/ncdexbhavcopy.aspx?date=" & CStr(month(ltradedt)) & "-" & CStr(Left(ltradedt, 2)) & "-" & Year(ltradedt) & "&format=csv_file"
                        LTargetFileName = App.Path & "\" & LTExCode & "\" & LOFileName
                        Call TDownloadFile(LClosingFileName, LTargetFileName)
                        If FTPerr <> "" Then
                            ImportIssues (FTPerr)
                            FTPerr = ""
                        End If
                        DoEvents
                    End If
                    
                    If Not GLOBALFLAG Then
                        GoTo NO_FILE
                    End If
                    'LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                    If FileExist(LTargetFileName) Then
                        'LReName = RenameFileOrDir(LTargetFileName, App.Path & "\NCDX\" & "BHAV" & Left$(LTradeDt, 2) & Mid(LTradeDt, 4, 2) & CStr(Year(LTradeDt)) & ".CSV")
                    End If
                    LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                End If
            Else
                    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                    If Not LFileSystemObject.FolderExists(App.Path & "\" & "NCDX") Then
                        LFileSystemObject.CreateFolder (App.Path & "\" & "NCDX")
                    End If
                    Set LFileSystemObject = Nothing
                    
                TxtPath = "NCDEX_CN01_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                LFileName = App.Path & "\NCDX\" & TxtPath
                LRemoteFileName = "/common/reports/" & TxtPath & ""
                If Not FileExist(LFileName) Then
                    Call Connect_Ftp("extranet.ncdex.com", "member", "ncdex123", LRemoteFileName, LFileName)
                    If Not FileExist(LFileName) Then
                        Call Connect_Ftp("drextranet.ncdex.com", "member", "ncdex123", LRemoteFileName, LFileName)
                    End If
                End If
            End If
        Case "FX"
            TxtPath = "MCX-SX_SettlementPrice_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
            LFileName = App.Path & "\FX\" & TxtPath
            LReName = RenameFileOrDir(LFileName, App.Path & "\FX\" & "MCX_SX_SettlementPrice_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV")
            TxtPath = "MCX_SX_SettlementPrice_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
            LFileName = App.Path & "\FX\" & TxtPath
            
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\" & "FX") Then
                LFileSystemObject.CreateFolder (App.Path & "\" & "FX")
            End If
            Set LFileSystemObject = Nothing
                    
            If Not FileExist(LFileName) Then
            
                'lfiletype = "C"
                'TxtPath = "CDSETT_PRCE_" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
                'LFileName = App.Path & "\FX\" & TxtPath

                'If Not FileExist(LFileName) Then
                    '12032018.csv
                '    LMONTH = CStr(month(ltradedt))
                '    If Len(LMONTH) = 1 Then LMONTH = "0" & LMONTH
                    
                   
                  '  LClosingFileName = " https://archives.nseindia.com/archives/cd/sett/CDSett_prce_" & CStr(Left$(ltradedt, 2)) & LMONTH & CStr(Year(ltradedt)) & ".csv"
                    
                   ' LTargetFileName = App.Path & "\" & LTExCode & "\" & "CDSett_prce_" & CStr(Left$(ltradedt, 2)) & LMONTH & CStr(Year(ltradedt)) & ".csv"
                   ' LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
               ' End If
               'https://archives.nseindia.com/archives/cd/bhav/CD_Bhavcopy230623.zip
                lfiletype = "C"
                TxtPath = "CD_NSE_FO" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right(CStr(Year(ltradedt)), 2) & ".CSV"
                LFileName = App.Path & "\FX\" & TxtPath

                If Not FileExist(LFileName) Then
                    LClosingFileName = "https://archives.nseindia.com/archives/cd/bhav/CD_Bhavcopy" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right(CStr(Year(ltradedt)), 2) & ".zip"
                    LTargetFileName = App.Path & "\" & LTExCode & "\" & "CD_Bhavcopy" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right(CStr(Year(ltradedt)), 2) & ".zip"
                    LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                    If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
                End If
            End If
        Case "DGCX"
            TxtPath = "MARKETSTATS_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
            LFileName = App.Path & "\DGCX\" & TxtPath
            
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\" & "DGCX") Then
                LFileSystemObject.CreateFolder (App.Path & "\" & "DGCX")
            End If
            Set LFileSystemObject = Nothing
            
            
            If Not FileExist(LFileName) Then
                TxtPath = "MARKETSTATS-" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
                LFileName = App.Path & "\DGCX\" & TxtPath
                If FileExist(LFileName) Then
                    LRenameFile = RenameFileOrDir(LFileName, App.Path & "\DGCX\" & "MARKETSTATS_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV")
                End If
                TxtPath = "MARKETSTATS_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
                LFileName = App.Path & "\DGCX\" & TxtPath
                                               
                If Not FileExist(LFileName) Then
                    LMONTH = CStr(month(ltradedt))
                    Select Case LMONTH
                        Case "1"
                            LMONTH = "Jan-" & Right(ltradedt, 2)
                        Case "12"
                            LMONTH = "Dec-" & Right(ltradedt, 2)
                    End Select
                    TxtPath = "MARKETSTATS_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
                    If Year(ltradedt) = 2018 Then
                        LClosingFileName = "https://www.dgcx.ae/download/295/" & LMONTH & "/7764/" & TxtPath & ""
                    Else
                        LClosingFileName = "https://www.dgcx.ae/download/301/" & LMONTH & "/7876/" & TxtPath & ""
                    End If
                    LTargetFileName = App.Path & "\" & LTExCode & "\" & "MARKETSTATS_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left$(ltradedt, 2) & ".CSV"
                    LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                End If
            End If
        Case "REAL"
            TxtPath = "REAL_CLOSING_" & Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & Right$(ltradedt, 4) & ".CSV"
            LFileName = App.Path & "\REAL\" & TxtPath
        Case "CMX"
        
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\" & "CMX") Then
                LFileSystemObject.CreateFolder (App.Path & "\" & "CMX")
            End If
            Set LFileSystemObject = Nothing
            
            TxtPath = "COMEX_FUTURES_" & Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & Right$(ltradedt, 4) & ".CSV"
            LFileName = App.Path & "\CMX\" & TxtPath
            
           
            If Not FileExist(LFileName) Then
                'ftp://ftp.cmegroup.com/pub/settle/comex_future.csv
                LClosingFileName = "ftp://ftp.cmegroup.com/pub/settle/comex_future.csv"
                'https://www.dgcx.ae/download/295/dec-18/7764/marketstats-20181219.csv
                'LClosingFileName = "https://www.nseindia.com/archives/nsccl/sett/" & "FOSett_prce_" & CStr(LEFT$(LTradedt, 2)) & LMonth & CStr(Year(LTradedt)) & ".csv"
                LTargetFileName = App.Path & "\" & LTExCode & "\" & "COMEX_FUTURES" & ".CSV"
                LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                LOFileName = App.Path & "\" & LTExCode & "\" & "COMEX_FUTURES.CSV"
                If FileExist(LOFileName) Then
                    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                    TxtoPath = "COMEX_FUTURES.CSV"
                    TxtRec.Open "Select * from " & TxtoPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                    If Not TxtRec.EOF Then
                        TxtRec.Filter = "F20 <>'TRADEDATE'"
                        If Not TxtRec.EOF Then
                            LSTRCONDATE = TxtRec!F20
                            LSCondate = DateValue(Mid(LSTRCONDATE, 4, 2) & "/" & Left(LSTRCONDATE, 2) & "/" & Right(LSTRCONDATE, 4))
                            LSTRCONDATE = Left(LSCondate, 2) & Mid(LSCondate, 4, 2) & Right(LSCondate, 4)
                            LNewFileName = "Comex_Futures_" & LSTRCONDATE & ".CSV"
                            If Not FileExist(LNewFileName) Then
                                Set TxtRec = Nothing
                                LReName = RenameFileOrDir(LOFileName, LNewFileName)
                            End If
                        End If
                    End If
                End If
            End If
        Case "RACE"
            TxtPath = "fo" & CStr(Left$(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv"
            LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
            
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
            End If
            Set LFileSystemObject = Nothing
                        
            If Not FileExist(LFileName) Then
                LClosingFileName = "https://www1.nseindia.com/content/historical/DERIVATIVES/" & Year(ltradedt) & "/" & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & "/" & "fo" & CStr(Left$(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv.zip"
                LTargetFileName = App.Path & "\" & LTExCode & "\" & "fo" & CStr(Left$(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv.zip"
                LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
            End If
        Case "NSE"
            If ChkNSESettleRate.Value = 1 Then
                LMONTH = CStr(month(ltradedt))
                If Len(LMONTH) = 1 Then LMONTH = "0" & LMONTH
                TxtPath = "FOSett_prce_" & CStr(Left$(ltradedt, 2)) & LMONTH & CStr(Year(ltradedt)) & ".csv"
                LFileName = App.Path & "\" & LTExCode & "\" & TxtPath

                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
                End If
                Set LFileSystemObject = Nothing
            
                'If FileExist(LFileName) Then '>>> IF EXISTS THEN DELETE THE FILE
                '        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                '        LFileSystemObject.DeleteFile LFileName
'                End If
                
                If Not FileExist(LFileName) Then
                    'LClosingFileName = "https://www1.nseindia.com/archives/nsccl/sett/" & "FOSett_prce_" & CStr(Left$(ltradedt, 2)) & LMONTH & CStr(Year(ltradedt)) & ".csv"
                    
                    LClosingFileName = "https://nsearchives.nseindia.com/archives/nsccl/sett/" & "FOSett_prce_" & CStr(Left$(ltradedt, 2)) & LMONTH & CStr(Year(ltradedt)) & ".csv"
                    
                    LTargetFileName = App.Path & "\" & LTExCode & "\" & "FOSett_prce_" & CStr(Left$(ltradedt, 2)) & LMONTH & CStr(Year(ltradedt)) & ".csv"
                    LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                End If
            ElseIf ChkNSEExcelClosing.Value = 1 Then
                TxtPath = "NSEBHAV" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
            Else
                TxtPath = "fo" & CStr(Left$(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv"
                LFileName = App.Path & "\" & LTExCode & "\" & TxtPath & ".zip"
                
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
                End If
                Set LFileSystemObject = Nothing
                
                'If FileExist(LFileName) Then '>>> IF EXISTS THEN DELETE THE FILE
                '        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                '        LFileSystemObject.DeleteFile LFileName
               ' End If
                    
                If Not FileExist(LFileName) Then
                    'LClosingFileName = "https://www1.nseindia.com/content/historical/DERIVATIVES/" & Year(LTradeDt) & "/" & UCase(Left$(MonthName(Val(month(LTradeDt))), 3)) & "/" & "fo" & CStr(Left$(LTradeDt, 2)) & UCase(Left$(MonthName(Val(month(LTradeDt))), 3)) & Year(LTradeDt) & "bhav.csv.zip"
                    
                    'LClosingFileName = "https://www1.nseindia.com/content/historical/DERIVATIVES/" & Year(ltradedt) & "/" & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & "/" & "fo" & CStr(Left$(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv.zip"
                    LClosingFileName = "https://nsearchives.nseindia.com/content/historical/DERIVATIVES/" & Year(ltradedt) & "/" & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & "/" & "fo" & CStr(Left$(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv.zip"
                 'https://archives.nseindia.com/content/historical/DERIVATIVES/2023/MAR/fo31MAR2023bhav.csv.zip
                                        
                    LTargetFileName = App.Path & "\" & LTExCode & "\" & "fo" & CStr(Left(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv.zip"
                    Call TDownloadFile(LClosingFileName, LTargetFileName)
                    If FTPerr <> "" Then
                        ImportIssues (FTPerr)
                        FTPerr = ""
                    End If
                    '
                    
                    
                    If Not GLOBALFLAG Then
                        TxtPath = "fo" & CStr(Left$(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv"
                        LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                        If Not FileExist(LFileName) Then
                            GoTo NO_FILE
                        End If
                    End If
                     LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                     LTargetFileName = App.Path & "\" & LTExCode & "\" & "fo" & CStr(Left(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv.zip"
                     If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
                    
                    'LRenameFile = RenameFileOrDir(LFileName, App.Path & "\" & LTExCode & "\" & "F_CN01_NSE_" & CStr(Left$(LTradeDt, 2)) & CStr(Mid(LTradeDt, 4, 2)) & Year(LTradeDt) & ".csv")
                    'LTargetFileName = App.Path & "\" & LTExCode & "\" & "F_CN01_NSE_" & CStr(Left$(LTradeDt, 2)) & CStr(Mid(LTradeDt, 4, 2)) & Year(LTradeDt) & ".csv"
                    'If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
                    'TxtPath = "F_CN01_NSE_" & CStr(Left$(LTradeDt, 2)) & CStr(Mid(LTradeDt, 4, 2)) & Year(LTradeDt) & ".csv"
                Else
                    'LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                     LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                     LTargetFileName = App.Path & "\" & LTExCode & "\" & "fo" & CStr(Left(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & Year(ltradedt) & "bhav.csv.zip"
                     If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
                End If
            End If
        Case "EQ"
            TxtPath = "cm" & CStr(Left$(ltradedt, 2)) & UCase(Left$(MonthName(Val(month(ltradedt))), 3)) & CStr(Year(ltradedt)) & "bhav.csv.zip"
            LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
            
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
                End If
                Set LFileSystemObject = Nothing
                
            'If FileExist(LFileName) Then '>>> IF EXISTS THEN DELETE THE FILE
            '        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            '        LFileSystemObject.DeleteFile LFileName
           ' End If
            
            If Not FileExist(LFileName) Then
                ''LClosingFileName = "https://www1.nseindia.com/content/historical/EQUITIES/" & Year(LTradeDt) & "/" & UCase$(Left$(MonthName(Val(month(LTradeDt))), 3)) & "/" & TxtPath
                'LClosingFileName = "https://archives.nseindia.com/content/historical/EQUITIES/" & Year(ltradedt) & "/" & UCase$(Left$(MonthName(Val(month(ltradedt))), 3)) & "/" & TxtPath
                LClosingFileName = "https://nsearchives.nseindia.com/content/historical/EQUITIES/" & Year(ltradedt) & "/" & UCase$(Left$(MonthName(Val(month(ltradedt))), 3)) & "/" & TxtPath
                LTargetFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
            End If
            TxtPath = "cm" & CStr(Left$(ltradedt, 2)) & Left$(MonthName(Val(month(ltradedt))), 3) & CStr(Year(ltradedt)) & "bhav.csv"
        Case "BEQ"
            TxtPath = "EQ" & CStr(Left$(ltradedt, 2)) & Mid(CStr(ltradedt), 4, 2) & Right$(CStr(Year(ltradedt)), 2) & "_csv"
            LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
            
            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
            End If
            Set LFileSystemObject = Nothing
                                
            If Not FileExist(LFileName) Then
                LClosingFileName = "http://www.bseindia.com/download/BhavCopy/Equity/" & TxtPath & ".zip"
                LTargetFileName = App.Path & "\" & LTExCode & "\" & TxtPath & ".zip"
                LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
                'RenameFileOrDir(LFileName, App.Path & "\MCX\" & "MARGIN DETAIL REPORT " & CStr(Year(LTradeDt)) & Mid(LTradeDt, 4, 2) & Left$(LTradeDt, 2) & ".CSV")
            End If
            TxtPath = "EQ" & CStr(Left$(ltradedt, 2)) & Mid(CStr(ltradedt), 4, 2) & Right$(CStr(Year(ltradedt)), 2) & ".csv"
        Case "BSEFX"
            TxtPath = "CDSETT_PRCE_" & CStr(Left$(ltradedt, 2)) & Mid(CStr(ltradedt), 4, 2) & Right$(CStr(Year(ltradedt)), 2) & ".csv"
            LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
            
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
                End If
                Set LFileSystemObject = Nothing
                
            LBSEFXFile = 1
            If Not FileExist(LFileName) Then
                LBSEFXFile = 2
                TxtPath = "CurrencyBhavCopy_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left(CStr(ltradedt), 2) & ".csv"
                LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
                
                If Not FileExist(LFileName) Then
                    LClosingFileName = "https://www.bseindia.com/bsedata/CIML_bhavcopy/CurrencyBhavCopy_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left(CStr(ltradedt), 2) & ".zip"
                    LZipFileName = "CurrencyBhavCopy_" & CStr(Year(ltradedt)) & Mid(ltradedt, 4, 2) & Left(CStr(ltradedt), 2) & ".ZIP"
                    LTargetFileName = App.Path & "\" & LTExCode & "\" & LZipFileName & ""
                    LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                    If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
                End If
            End If
        Case "BSE"
            TxtPath = "bhavcopy" & CStr(Left$(ltradedt, 2)) & "-" & Mid(CStr(ltradedt), 4, 2) & "-" & Right$(CStr(Year(ltradedt)), 2) & ".zip"
            LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
            
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
                End If
                Set LFileSystemObject = Nothing
            'https://www.bseindia.com/download/Bhavcopy/Derivative/bhavcopy19-10-23.zip
            If Not FileExist(LFileName) Then
                LClosingFileName = "https://www.bseindia.com/download/Bhavcopy/Derivative/" & TxtPath
                LTargetFileName = App.Path & "\" & LTExCode & "\" & TxtPath & ".zip"
                LFiledownload = DownloadFile(LClosingFileName, LTargetFileName)
                If FileExist(LTargetFileName) Then Call LUnZipFile(LTargetFileName, App.Path & "\" & LTExCode & "")
            End If
            TxtPath = "bhavcopy" & CStr(Left$(ltradedt, 2)) & "-" & Mid(CStr(ltradedt), 4, 2) & "-" & Right$(CStr(Year(ltradedt)), 2) & ".csv"
            LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
            LRenameFile = RenameFileOrDir(LFileName, App.Path & "\BSE\" & "BHAVCOPY" & CStr(Left$(ltradedt, 2)) & Mid(CStr(ltradedt), 4, 2) & Right$(CStr(Year(ltradedt)), 2) & ".csv")
            TxtPath = "bhavcopy" & CStr(Left$(ltradedt, 2)) & Mid(CStr(ltradedt), 4, 2) & Right$(CStr(Year(ltradedt)), 2) & ".csv"
        End Select
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\" & LTExCode) Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & LTExCode)
                End If
                Set LFileSystemObject = Nothing
        LFileName = App.Path & "\" & LTExCode & "\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            If LTExCode = "NSE" Then
                If ChkNSESettleRate = 1 Then
                    TxtRec.Open "Select * from " & TxtPath & "  WHERE  LEFT$(F2,3) ='FUT' ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                ElseIf ChkNSEExcelClosing.Value = 1 Then
                    If LGCloseFile = "1" Or LGCloseFile = "2" Then
                        If GUniqClientId = "1706HYD" Then
                            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                        Else
                            TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                        End If
                    ElseIf LGCloseFile = "5" Then
                        TxtRec.Open "Select * from " & TxtPath & "  WHERE  F1='NSEFO' ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                    Else
                        TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                    End If
                Else
                    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                    If LEXOptions <> "Y" Then
                        If NseFTPFILE Then
                            mysql = "Select * from " & TxtPath & "  WHERE LEFT$(F2,3)='FUT' "
                        Else
                            mysql = "Select * from " & TxtPath & "  WHERE LEFT$(F1,3)='FUT' "
                        End If
                    Else
                        If LOPTINDEX = "Y" Then
                            mysql = "Select * from " & TxtPath & " WHERE (LEFT$(F1,3)='FUT' OR (LEFT$(F1,3)='OPT') AND (F2= 'NIFTY' OR F2 = 'BANKNIFTY'))"
                        Else
                            mysql = "Select * from " & TxtPath & " WHERE (LEFT$(F1,3)='FUT' OR LEFT$(F1,3)='OPT')"
                        End If
                    End If
                    TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                End If
            ElseIf LTExCode = "RACE" Then
                Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                If LEXOptions <> "Y" Then
                    mysql = "Select * from " & TxtPath & "  WHERE LEFT$(F1,3)='FUT' "
                Else
                    mysql = "Select * from " & TxtPath & " WHERE (LEFT$(F1,3)='FUT' OR LEFT$(F1,3)='OPT')"
                End If
                TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                
            ElseIf LTExCode = "EQ" Then
                TxtRec.Open "SELECT * FROM " & TxtPath & " WHERE LEN(F2)=2 ", Jcnn, adOpenForwardOnly, adLockReadOnly
            ElseIf LTExCode = "FX" Then
                TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            Else
                TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            End If
            If Not TxtRec.EOF Then
                
                If (LTExCode = "MCX" And Not IsNull(TxtRec!F1) And InStr(1, TxtRec!F1, ">") <= 0 And InStr(1, TxtRec!F1, "<") <= 0) Or (LTExCode <> "MCX") Then
                    LSCondate = DateValue(ltradedt)
                    FlagDataTrf = True
                    Select Case LTExCode
                    Case "MCX"
                        If ChkMCXExcelClosing.Value = 1 Then
                            LSCondate = DateValue(ltradedt)
                        Else
                            If McxDateWise = True Then
                                'LSCondate = DateValue(Left$(TxtRec!F1, 2) & "/" & Mid(TxtRec!F1, 4, 3) & "/20" & Right$(TxtRec!F1, 2))
                                LSCondate = ltradedt
                            Else
                                If Len(TxtRec!F1) = 10 Then
                                    LSCondate = DateValue(TxtRec!F1)
                                Else
                                    LSCondate = DateValue(Left$(TxtRec!F1, 2) & "/" & Mid(TxtRec!F1, 3, 3) & "/" & Right$(TxtRec!F1, 4))
                                End If
                            End If
                        End If
                    Case "NCDX"
                        If CHKNCDXExcelClosing.Value = 1 Then
                            LSCondate = ltradedt
                        Else
                            LSCondate = DateValue(TxtRec!F1)
                        End If
                    Case "DGCX"
                        LSCondate = DateValue(ltradedt)
                    Case "NSE"
                        If ChkNSESettleRate = 1 Then
                            LSCondate = DateValue(TxtRec!F1)
                        ElseIf ChkNSEBhavCopy = 1 Then
                            If NseFTPFILE Then
                                LSCondate = DateValue(TxtRec!F1)
                            Else
                                LSCondate = DateValue(TxtRec!F15)
                            End If
                        Else
                            LSCondate = ltradedt
                        End If
                    Case "EQ"
                        If Len(TxtRec!f11) = 10 Then
                            LSCondate = DateValue(TxtRec!f11)
                        Else
                            LSCondate = DateValue(Left$(TxtRec!f11, 2) & "/" & Mid(TxtRec!f11, 4, 3) & "/" & Right$(TxtRec!f11, 4))
                        End If
                    Case "FX"
                        LSCondate = DateValue(ltradedt)
                    Case "BEQ"
                        LSCondate = ltradedt
                    Case "BSE"
                        LSCondate = ltradedt
                    Case "BSEFX"
                        LSCondate = ltradedt
                    Case "REAL"
                        LSCondate = ltradedt
                    Case "RACE"
                        LSCondate = ltradedt
                    End Select
                End If
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                While Not TxtRec.EOF
                    DoEvents
                    'If Not IsNull(TxtRec!f1) And InStr(1, TxtRec!f1, ">") <= 0 And InStr(1, TxtRec!f1, "<") <= 0 Then
                    If (LTExCode = "MCX" And Not IsNull(TxtRec!F1) And InStr(1, TxtRec!F1, ">") <= 0 And InStr(1, TxtRec!F1, "<") <= 0) Or (LTExCode <> "MCX") Then

                        LSItemCode = vbNullString:  LSSaudaCode = vbNullString:     LSInstType = "FUT":     LSOptType = vbNullString
                        LSStrike = 0:               LCloseRate = 0:                 LLOT = 1:               LSettleRate = 0
                        lOpRate = 0:                LHighRate = 0:                  LLowRate = 0:           LSSaudaID = 0
                        LSEXID = 0:                 LSItemid = 0:                   LSExCode = vbNullString
                        LEXHCODE = vbNullString
                        If LTExCode = "MCX" Then
                            If ChkMCXExcelClosing.Value <> 1 Then
                                If Trim(TxtRec!F5) = "COM" Then GoTo EFlag_Next
                            End If
                            If McxDateWise = True Then
                                If Not IsNumeric(TxtRec!F10) Then GoTo EFlag_Next
                            End If
                        End If
                        If LTExCode = "NCDX" Then
                            If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                            If CHKNCDXExcelClosing.Value = 1 Then
                                If Not IsNumeric(TxtRec!f12) Then GoTo EFlag_Next
                            End If
                        End If
                        If LTExCode = "REAL" Then
                            If Not IsNumeric(TxtRec!f3) Then GoTo EFlag_Next
                        End If
                        If LTExCode = "BEQ" Then
                            If Not IsNumeric(TxtRec!F1) Then GoTo EFlag_Next
                        End If
                        If LTExCode = "BSEFX" Then
                            If LBSEFXFile = 1 Then
                                If TxtRec!F2 <> "FUTCUR" Then GoTo EFlag_Next
                            Else
                                If Not IsNumeric(TxtRec!F9) Then GoTo EFlag_Next
                            End If
                        End If
                        
                        If LTExCode = "DGCX" Then
                            If Left(TxtRec!F5, 3) <> "FUT" Then GoTo EFlag_Next
                            If Not IsNumeric(TxtRec!F20) Then GoTo EFlag_Next
                        End If
                        Select Case LTExCode
                        Case "MCX"
                            If ChkMCXExcelClosing.Value = 1 Then
                                If LGCloseFile = "1" Then
                                    If IsNumeric(TxtRec!f12) Then
                                        LEXHCODE = TxtRec!f3
                                        LSTRCONDATE = Right$(TxtRec!F2, 9)
                                        LSMaturity = DateValue(Left$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/20" & Right$(LSTRCONDATE, 2))
                                        LEXHCODE = Mid(TxtRec!F2, 9, Len(TxtRec!F2) - 19)
                                        LSettleRate = Val(Trim(TxtRec!f12))
                                        lOpRate = 0:    LHighRate = 0:          LLowRate = 0
                                        LSettleRate = Val(Trim(TxtRec!f12)):    LCloseRate = 0
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                ElseIf LGCloseFile = "2" Then
                                    If Not IsNull(TxtRec!F1) And TxtRec!F1 <> "Script" And InStr(TxtRec!F1, "MCX") <> 0 And IsDate(TxtRec!F2) Then
                                        LEXHCODE = Left(TxtRec!F1, Len(TxtRec!F1) - 8)
                                        LSMaturity = DateValue(Left$(TxtRec!F2, 2) & "/" & Mid(TxtRec!F2, 4, 2) & "/" & Mid(TxtRec!F2, 7, 4))
                                        LSMaturity = LSMaturity - 1
                                        lOpRate = Val(Trim(TxtRec!F9)):                        LHighRate = Val(Trim(TxtRec!F7))
                                        LLowRate = Val(Trim(TxtRec!f6)):                       LSettleRate = Val(Trim(TxtRec!F5))
                                        LCloseRate = Val(Trim(TxtRec!F5))
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                ElseIf LGCloseFile = "3" Then
                                    If Not IsNull(TxtRec!F1) And TxtRec!F1 <> "Symbol" Then
                                        LEXHCODE = TxtRec!F1:
                                        LSMaturity = DateValue(Left$(TxtRec!F2, 2) & "/" & Mid(TxtRec!F2, 4, 3) & "/20" & Right$(TxtRec!F2, 2))
                                        lOpRate = 0:                        LHighRate = 0
                                        LLowRate = 0:                       LSettleRate = Val(Trim(TxtRec!F5))
                                        LCloseRate = 0
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                Else
                                    If Not IsNull(TxtRec!F1) And TxtRec!F1 <> "Symbol" Then
                                        LEXHCODE = TxtRec!F1:
                                        LSMaturity = DateValue(Left$(TxtRec!F2, 2) & "/" & Mid(TxtRec!F2, 4, 3) & "/20" & Right$(TxtRec!F2, 2))
                                        lOpRate = 0:                        LHighRate = 0
                                        LLowRate = 0:                       LSettleRate = Val(Trim(TxtRec!F7))
                                        LCloseRate = 0
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                End If
                            Else
                                If McxDateWise = True Then
                                   LSExCode = "MCX":
                                   LSCondate = DateValue(Left$(TxtRec!F1, 2) & "/" & Mid(TxtRec!F1, 4, 3) & "/20" & Right$(TxtRec!F1, 2))
                                   LSInstType = Left$(TxtRec!F2, 3)
                                   LEXHCODE = Trim(TxtRec!f3)
                                   LSMaturity = DateValue(Left$(TxtRec!F4, 2) & "/" & Mid(TxtRec!F4, 3, 3) & "/20" & Right$(TxtRec!F4, 2))
                                   If LSInstType = "OPT" Then
                                        LSOptType = TxtRec!F5
                                        LSStrike = Val(TxtRec!f6)
                                    End If
                                    lOpRate = Val(Trim(TxtRec!F7)):        LHighRate = Val(Trim(TxtRec!F8))
                                    LLowRate = Val(Trim(TxtRec!F9)):       LSettleRate = Val(Trim(TxtRec!F10)):         LCloseRate = Val(Trim(TxtRec!F10))
                                    
                                Else
                                    LSExCode = "MCX"
                                    If Len(TxtRec!F1) = 10 Then
                                        LSCondate = DateValue(TxtRec!F1)
                                    Else
                                        LSCondate = DateValue(Left$(TxtRec!F1, 2) & "/" & Mid(TxtRec!F1, 3, 3) & "/" & Right$(TxtRec!F1, 4))
                                    End If
                                    LSInstType = Left$(TxtRec!F5, 3)
                                    If LSInstType = "OPT" Then
                                        LSOptType = TxtRec!F10:  LSStrike = Val(TxtRec!F9)
                                    End If
                                    LEXHCODE = Trim(TxtRec!f6)
                                    If Len(TxtRec!F7) = 9 Then
                                        If Mid(TxtRec!F7, 3, 1) = "-" Then
                                            LSMaturity = DateValue(Left$(TxtRec!F7, 2) & "/" & Mid(TxtRec!F7, 4, 3) & "/20" & Right$(TxtRec!F7, 2))
                                        Else
                                            LSMaturity = DateValue(Left$(TxtRec!F7, 2) & "/" & Mid(TxtRec!F7, 3, 3) & "/20" & Right$(TxtRec!F7, 2))
                                        End If
                                    Else
                                        LSMaturity = DateValue(Left$(TxtRec!F7, 2) & "/" & Mid(TxtRec!F7, 4, 2) & "/" & Right$(TxtRec!F7, 4))
                                    End If
                                    If ltradedt <= MCXChDt Then
                                        lOpRate = Val(Trim(TxtRec!f11)):        LHighRate = Val(Trim(TxtRec!f12))
                                        LLowRate = Val(Trim(TxtRec!F13)):       LSettleRate = Val(Trim(TxtRec!F14))
                                    Else
                                        lOpRate = Val(Trim(TxtRec!f12)):        LHighRate = Val(Trim(TxtRec!F13))
                                        LLowRate = Val(Trim(TxtRec!F14)):       LSettleRate = Val(Trim(TxtRec!F21)):         LCloseRate = Val(Trim(TxtRec!F15))
                                    End If
                                End If
                            End If
                        Case "NCDX"
                            LSExCode = "NCDX"
                            If CHKNCDXExcelClosing.Value = 1 Then
                                LSCondate = ltradedt
                                LSInstType = Left(TxtRec!F1, 3)
                                LEXHCODE = TxtRec!F2
                                If LSInstType = "OPT" Then
                                    LSOptType = Left$(Trim$(TxtRec!f6), 2):  LSStrike = Val(TxtRec!F5)
                                End If
                                LSMaturity = DateValue(TxtRec!f3)
                                lOpRate = Val(TxtRec!F9):                            LHighRate = Val(TxtRec!F10)
                                LLowRate = Val(TxtRec!f11):                           LCloseRate = Val(TxtRec!f12)
                                LSettleRate = LCloseRate
                            Else
                                LSCondate = DateValue(TxtRec!F1)
                                LEXHCODE = Trim$(TxtRec!f3)
                                LSInstType = Left$(Trim$(TxtRec!F2), 3)
                                If LSInstType = "OPT" Then
                                    LSOptType = Left$(Trim$(TxtRec!f6), 2):  LSStrike = Val(TxtRec!F5)
                                End If
                                LLOT = Val(TxtRec!F8) / Val(TxtRec!F9)
                                If GAmtDivide <> "1" Then
                                    mysql = "UPDATE CONTRACTMASTER  SET PriceUnit='" & Trim$(TxtRec!F10) & "',QtyUnit='" & Trim$(TxtRec!F13) & "',RegularLot= " & Val(TxtRec!f12) & " ,LOT =" & Val(LLOT) & " WHERE  EX_SYMBOL ='" & LEXHCODE & "' AND EXCODE ='NCDX'"
                                    Cnn.Execute mysql
                                    mysql = "UPDATE ITEMMAST SET PriceUnit='" & Trim$(TxtRec!F10) & "',QtyUnit='" & Trim$(TxtRec!F13) & "',RegularLot= " & Val(TxtRec!f12) & " ,LOT =" & Val(LLOT) & " WHERE COMPCODE = " & GCompCode & " AND EXHCODE ='" & LEXHCODE & "' AND EXCHANGECODE ='NCDX'"
                                    Cnn.Execute mysql
                                End If
                                LSMaturity = DateValue(TxtRec!F4)
                                lOpRate = Val(TxtRec!F21):                            LHighRate = Val(TxtRec!f22)
                                LLowRate = Val(TxtRec!f23):                           LCloseRate = Val(TxtRec!F24)
                                LSettleRate = IIf(LSMaturity = LSCondate, TxtRec!F26, TxtRec!f25)
                            End If
                        Case "RACE"
                            LEXHCODE = RTrim(LTrim(TxtRec!F2)):       LSInstType = Left$(TxtRec!F1, 3):       LVol = Val(TxtRec!f11)
                            If LSInstType <> "FUT" Then
                                LSStrike = Val(TxtRec!F4):   LSOptType = TxtRec!F5
                            End If
                            LSMaturity = DateValue(TxtRec!f3)
                            lOpRate = Val(TxtRec!f6): LCloseRate = Val(TxtRec!F9): LHighRate = Val(TxtRec!F7): LLowRate = Val(TxtRec!F8): LSettleRate = Val(TxtRec!F10)
                            If LSInstType = "OPT" Then If LSCondate = LSMaturity Then LSettleRate = Val(TxtRec!F9)
                        Case "NSE"
                            If ChkNSEExcelClosing.Value = 1 Then
                                If LGCloseFile = "1" Then
                                    If Not IsNull(TxtRec!F1) And (TxtRec!F1 = "NSE" Or TxtRec!F1 = "MCX" Or TxtRec!F1 = "NCDEX") Then
                                        If Left(TxtRec!F2, 3) <> "FUT" Then GoTo EFlag_Next
                                        If IsNumeric(TxtRec!f3) Then
                                            LSettleRate = Val(Trim(TxtRec!f12)):    LCloseRate = 0
                                            LCloseRate = 0:                 lOpRate = 0:                            LHighRate = 0
                                            LLowRate = 0:                   LSTRCONDATE = Right$(TxtRec!F2, 9)
                                            LSMaturity = DateValue(Left$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/20" & Right$(LSTRCONDATE, 2))
                                            LEXHCODE = Mid(TxtRec!F2, 9, Len(TxtRec!F2) - 19)
                                        Else
                                            GoTo EFlag_Next
                                        End If
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                ElseIf LGCloseFile = "2" Then
                                    If Not IsNull(TxtRec!F1) And TxtRec!F1 <> "Symbol" Then
                                        LEXHCODE = TxtRec!F1
                                        If InStr(TxtRec!F2, "-") Then
                                            LSMaturity = DateValue(Left$(TxtRec!F2, 2) & "/" & Mid(TxtRec!F2, 4, 3) & "/20" & Right$(TxtRec!F2, 2))
                                        Else
                                            LSMaturity = DateValue(Left$(TxtRec!F2, 2) & "/" & Mid(TxtRec!F2, 3, 3) & "/" & Right$(TxtRec!F2, 4))
                                        End If
                                        lOpRate = 0: LHighRate = 0:   LLowRate = 0
                                        If GUniqClientId = "1706HYD" Or GUniqClientId = "1996GWL" Then
                                            LSettleRate = Val(Trim(TxtRec!F5)):
                                        Else
                                            LSettleRate = Val(Trim(TxtRec!F7)):
                                        End If
                                        LCloseRate = 0
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                ElseIf LGCloseFile = "3" Then
                                    If Not IsNull(TxtRec!F1) And TxtRec!F1 <> "Symbol" Then
                                        LEXHCODE = TxtRec!F1
                                        If IsNull(TxtRec!F2) Then GoTo EFlag_Next
                                        LSMaturity = DateValue(Left$(TxtRec!F2, 2) & "/" & Mid(TxtRec!F2, 4, 3) & "/20" & Right$(TxtRec!F2, 2))
                                        LCloseRate = 0
                                        lOpRate = 0:       LHighRate = 0
                                        LLowRate = 0:      LSettleRate = Val(Trim(TxtRec!F10))
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                ElseIf LGCloseFile = "4" Then
                                    If Not IsNull(TxtRec!F1) And TxtRec!F1 <> "Symbol" Then
                                        LEXHCODE = TxtRec!F1
                                        LSMaturity = DateValue(Left$(TxtRec!F2, 2) & "/" & Mid(TxtRec!F2, 4, 3) & "/20" & Right$(TxtRec!F2, 2))
                                        lOpRate = 0:                                    LHighRate = 0:    LLowRate = 0
                                        LSettleRate = Val(Trim(TxtRec!F9)):  LCloseRate = 0
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                    
                                ElseIf LGCloseFile = "5" Then
                                    If Not IsNull(TxtRec!F1) And TxtRec!F1 = "NSEFO" Then
                                        LEXHCODE = Left$(TxtRec!F2, Len(TxtRec!F2) - 12)
                                        LSTRCONDATE = Right$(TxtRec!F2, 11)
                                        LSMaturity = DateValue(Left$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 3) & "/20" & Right$(LSTRCONDATE, 2))
                                        lOpRate = 0
                                        LHighRate = 0:    LLowRate = 0
                                        LSettleRate = Val(Trim(TxtRec!F7)):  LCloseRate = 0
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                ElseIf LGCloseFile = "6" Then
                                    If Not IsNull(TxtRec!F1) And IsNumeric(TxtRec!f11) Then
                                        If Left(TxtRec!F1, 3) = "FUT" Then
                                            LEXHCODE = Trim(TxtRec!F2)
                                            LSTRCONDATE = TxtRec!f3
                                            If InStr(LSTRCONDATE, "/") = 3 And Len(LSTRCONDATE) = 10 Then
                                                LSMaturity = DateValue(LSTRCONDATE)
                                            ElseIf InStr(LSTRCONDATE, "/") = 0 Then
                                                If InStr(LSTRCONDATE, "-") > 0 And Len(LSTRCONDATE) = 9 Then
                                                    LSMaturity = DateValue(Left$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 3) & "/20" & Right$(LSTRCONDATE, 2))
                                                Else
                                                    LSMaturity = DateValue(Left$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/20" & Right$(LSTRCONDATE, 2))
                                                End If
                                            Else
                                                LSMaturity = DateValue(Left$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 3) & "/20" & Right$(LSTRCONDATE, 2))
                                            End If
                                            lOpRate = (TxtRec!F10 & vbNullString)
                                            LHighRate = 0:     LLowRate = 0
                                            LSettleRate = Val(Trim(TxtRec!f11)):  LCloseRate = 0
                                        Else
                                            GoTo EFlag_Next
                                        End If
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                ElseIf LGCloseFile = "7" Then
                                    If Not IsNumeric(TxtRec!F2) Then GoTo EFlag_Next
                                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                                    LEXHCODE = RTrim(LTrim(TxtRec!F1)):      LSInstType = Right$(TxtRec!F1, 3):       LVol = Val(TxtRec!f11)
                                    If LSInstType = "OPT" Then
                                        LSStrike = Val(TxtRec!F4):
                                        LSOptType = TxtRec!F5
                                    End If
                                    LEXHCODE = Left(TxtRec!F1, Len(TxtRec!F1) - 8)
                                    lday = "25"
                                    LSTRCONDATE = lday & "/" & Mid(Right(TxtRec!F1, 8), 3, 3) & "/20" & Left(Right(TxtRec!F1, 8), 2)
                                    LSMaturity = DateValue(LSTRCONDATE)
                                    lOpRate = TxtRec!F8: LCloseRate = TxtRec!f12: LHighRate = TxtRec!f6: LLowRate = TxtRec!F7: LSettleRate = TxtRec!f12
                                    If LSInstType = "OPT" And LSCondate = LSMaturity And GAutoBrok = True Then
                                         LSettleRate = Val(TxtRec!f12)
                                    End If
                                ElseIf LGCloseFile = "10" Then
                                    If Not IsNull(TxtRec!F1) Then
                                        LEXHCODE = TxtRec!f3
                                        LSTRCONDATE = TxtRec!F4
                                        LSInstType = Left(TxtRec!F2, 3)
                                        If LSInstType = "OPT" Then
                                            If LEXOptions = "Y" Then
                                                LSStrike = Val(TxtRec!F5 & vbNullString)
                                                LSOptType = (TxtRec!f6 & vbNullString)
                                            Else
                                                GoTo EFlag_Next
                                            End If
                                        End If
                                        LSMaturity = DateValue(LSTRCONDATE)
                                        lOpRate = Val(TxtRec!F8)
                                        LHighRate = Val(TxtRec!F9):
                                        LLowRate = Val(TxtRec!F10)
                                        LSettleRate = Val(Trim(TxtRec!f11)):  LCloseRate = LSettleRate
                                    Else
                                        GoTo EFlag_Next
                                    End If
                                End If
                            ElseIf ChkNSESettleRate.Value = 1 Then
                                LSExCode = "NSE"
                                If Left(TxtRec!F2, 3) <> "FUT" Then GoTo EFlag_Next
                                LEXHCODE = RTrim(LTrim(TxtRec!f3)):      LSInstType = "FUT":                    LVol = 1
                                LSMaturity = DateValue(TxtRec!F4)
                                LSettleRate = Val(TxtRec!F5)
                            ElseIf ChkNSEBhavCopy = 1 Then
                                LSExCode = "NSE"
                                If NseFTPFILE Then
                                    LEXHCODE = RTrim(LTrim(TxtRec!f3)):      LSInstType = Left$(TxtRec!F2, 3):       LVol = 0
                                    If LSInstType = "OPT" Then
                                        LSStrike = Val(TxtRec!F5):
                                        LSOptType = TxtRec!f6
                                    End If
                                    LSMaturity = DateValue(TxtRec!F4)
                                    lOpRate = TxtRec!F15: LCloseRate = TxtRec!F18: LHighRate = TxtRec!f16: LLowRate = TxtRec!F17: LSettleRate = TxtRec!f19
                                    'If LSInstType = "OPT" And LSCondate = LSMaturity And GAutoBrok = True Then
                                    If LSInstType = "OPT" And LSCondate = LSMaturity Then
                                         LSettleRate = Val(TxtRec!F18)
                                    End If
                                
                                Else
                                    LEXHCODE = RTrim(LTrim(TxtRec!F2)):      LSInstType = Left$(TxtRec!F1, 3):       LVol = Val(TxtRec!f11)
                                    If LSInstType = "OPT" Then
                                        LSStrike = Val(TxtRec!F4):
                                        LSOptType = TxtRec!F5
                                    End If
                                    LSMaturity = DateValue(TxtRec!f3)
                                    lOpRate = TxtRec!f6: LCloseRate = TxtRec!F9: LHighRate = TxtRec!F7: LLowRate = TxtRec!F8: LSettleRate = TxtRec!F10
                                    'If LSInstType = "OPT" And LSCondate = LSMaturity And GAutoBrok = True Then
                                    If LSInstType = "OPT" And LSCondate = LSMaturity Then
                                         LSettleRate = Val(TxtRec!F9)
                                    End If
                               End If
                            End If
                        Case "REAL"
                            LSInstType = "FUT"
                            If Left(TxtRec!F2, 4) = "GOLD" Then
                                LEXHCODE = "GOLD-" & Right(TxtRec!F2, 5)
                                lyear = Year(LSCondate)
                                LCMONTH = Mid(TxtRec!F2, 5, 3)
                                LSTRCONDATE = "01" & "/" & Mid(TxtRec!F2, 5, 3) & "/" & lyear
                                LSMaturity = DateValue(LSTRCONDATE)
                                If month(LSMaturity) < month(LSCondate) Then
                                    lyear = (Year(LSCondate) + 1)
                                    LSTRCONDATE = "01" & "/" & month(LSMaturity) & "/" & lyear
                                    LSMaturity = DateValue(LSTRCONDATE)
                                End If
                            Else
                                LEXHCODE = Left$(TxtRec!F2, Len(TxtRec!F2) - 3)
                                LSTRCONDATE = Right$(TxtRec!F2, 3)
                                LCMONTH = Left(LSTRCONDATE, 1)
                                lyear = "20" & Right(LSTRCONDATE, 2)
                                LMONTH = Get_CMX_Month(Left(LSTRCONDATE, 1))
                                LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                LSMaturity = DateValue(LSTRCONDATE)
                            End If
                            LSettleRate = Val(TxtRec!f3)
                        Case "EQ"
                            LSExCode = "EQ"
                            LSInstType = "CSH"
                            LEXHCODE = RTrim(LTrim(TxtRec!F1)) & " " & Trim(TxtRec!F2)
                            LSMaturity = DateValue(Left$(GFinEnd, 2) & "/" & Mid(GFinEnd, 4, 2) & "/" & Right$(GFinEnd, 4))
                            lOpRate = Val(TxtRec!f3):                        LLowRate = Val(TxtRec!F5)
                            LHighRate = Val(TxtRec!F4):                      LCloseRate = 0:                   LSettleRate = Val(TxtRec!f6)
                        Case "DGCX"
                            LSExCode = "DGCX"
                            LSInstType = Left(TxtRec!F5, 3)
                            A = InStr(TxtRec!f6, "-")
                            If A <> 0 Then
                                B = InStr(A + 1, TxtRec!f6, "-")
                                If B <> 0 Then GoTo EFlag_Next
                            End If
                            If A <> 0 Then
                                LEXHCODE = Left$(TxtRec!f6, A - 1)
                            Else
                                LEXHCODE = TxtRec!f6
                            End If
                            LSMaturity = DateValue(TxtRec!F7)
                            
                            lOpRate = Val(TxtRec!f11 & vbNullString):                        LLowRate = Val(TxtRec!F13 & vbNullString)
                            LHighRate = Val(TxtRec!f12 & vbNullString):                      LCloseRate = Val(TxtRec!F14 & vbNullString):
                            LSettleRate = Val(TxtRec!F20 & vbNullString)
                        Case "BEQ"
                            LSExCode = "BEQ"
                            LSInstType = "CSH":                              LEXHCODE = RTrim(LTrim(TxtRec!F1))
                            LSItemCode = LEXHCODE
                            LSItemName = RTrim(LTrim(TxtRec!F2)) & " (" & RTrim(LTrim(TxtRec!f3)) & ")"
                            LSItemName = Replace(LSItemName, "'", " ")
                            LCItemCode = Create_CItemMast(LSItemCode, LSItemName, LEXHCODE, LLOT, LSExCode)
                            LSMaturity = DateValue(Left$(GFinEnd, 2) & "/" & Mid(GFinEnd, 4, 2) & "/" & Right$(GFinEnd, 4))
                            mysql = "SELECT EXCODE FROM SCRIPTMASTER WHERE EXCODE='BEQ' AND ITEMCODE ='" & LSItemCode & "'"
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If TRec.EOF Then
                                LSSaudaCode = LSItemName & " " & LTExCode & ""
                                Call PInsert_SCRIPTMASTER(LSExCode, LEXHCODE, LSItemCode, LLOT, LSSaudaCode, LSSaudaCode, LSMaturity, LSStrike, LSOptType, LSInstType, 0, 1, 1)
                            End If
                            LSEXID = Get_ExID(LSExCode)
                            LSItemCode = Get_ItemMaster(LSEXID, LEXHCODE)
                            If LenB(LSItemCode) = 0 Then GoTo EFlag_Next
                            LSItemid = Get_ITEMID(LSItemCode)
                            LSSaudaCode = Get_SaudaMaster(LSEXID, LSItemid, LSMaturity, "CSH", LSOptType, LSStrike)
                            
                            If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                            LSSaudaID = Get_SaudaID(LSSaudaCode)
                            LLOT = 1
                            LSExCode = LTExCode
                            LSettleRate = Val(TxtRec!F8):   lOpRate = Val(TxtRec!F5)
                            LHighRate = Val(TxtRec!f6):     LLowRate = Val(TxtRec!F7): LCloseRate = Val(TxtRec!F9)
                        Case "BSE"
                            If TxtRec!F1 = "IF" Or TxtRec!F1 = "EF" Or TxtRec!F1 = "IO" Then
                                A = InStr(TxtRec!F2, "23")
                                LEXHCODE = Left(TxtRec!F2, A - 1)
                                
                                'LEXHCODE = Left$(RTrim(LTrim(IIf(IsNull(TxtRec!F2), "", TxtRec!F2))), Len(TxtRec!F2) - 7)
                                LSMaturity = DateValue(TxtRec!f3):  LSCondate = DateValue(ltradedt)
                                lOpRate = Val(TxtRec!f6):           LHighRate = Val(TxtRec!F7)
                                LLowRate = Val(TxtRec!F8):          LCloseRate = Val(TxtRec!F9)
                                LSettleRate = LCloseRate
                                LSExCode = "BSE"
                                If TxtRec!F5 = "CALL" Or TxtRec!F5 = "PUT" Then
                                    LSInstType = "OPT"
                                    LSStrike = Val(TxtRec!F4):
                                    If TxtRec!F5 = "CALL" Then
                                        LSOptType = "CE"
                                    Else
                                        LSOptType = "PE"
                                    End If
                                End If
                            Else
                                GoTo EFlag_Next
                            End If
                        Case "BSEFX"
                                LSExCode = "BSEFX"
                                If LBSEFXFile = 1 Then
                                    LSInstType = "FUT"
                                    LEXHCODE = RTrim(LTrim(TxtRec!f3))
                                    LSMaturity = DateValue(Left(TxtRec!f3, 2) & "/" & Mid(TxtRec!f3, 4, 3) & "/20" & Right(TxtRec!f3, 2))
                                    LSCondate = ltradedt
                                    lOpRate = 0:            LHighRate = 0
                                    LLowRate = 0:          LCloseRate = Val(TxtRec!F5)
                                    LSettleRate = LCloseRate
                                Else
                                    LSInstType = Left$(TxtRec!F1, 3)
                                    LEXHCODE = RTrim(LTrim(TxtRec!F2))
                                    LSOptType = (TxtRec!F5 & vbNullString)
                                    If LSOptType = "CALL" Then
                                        LSOptType = "CE"
                                    ElseIf LSOptType = "PUT" Then
                                        LSOptType = "PE"
                                    End If
                                    LSStrike = Val(TxtRec!F4 & vbNullString)
                                    LSMaturity = DateValue(TxtRec!f3):  LSCondate = ltradedt
                                    lOpRate = Val(TxtRec!f6):           LHighRate = Val(TxtRec!F7)
                                    LLowRate = Val(TxtRec!F8):          LCloseRate = Val(TxtRec!F9)
                                    LSettleRate = LCloseRate
                                End If
                        Case "FX"
                            LSExCode = "FX"
                            If Not IsNumeric(TxtRec!f6) Then GoTo EFlag_Next
                            If MFILE = 1 Then
                                LEXHCODE = Mid(TxtRec!F1, 7, 6)
                                LSMaturity = DateValue(Mid$(TxtRec!F1, 13, 2) & "/" & Mid(TxtRec!F1, 16, 3) & "/" & CStr(Right$(TxtRec!F1, 4)))
                                LSInstType = "FUT"
                                LSettleRate = Val(TxtRec!F7)
                            Else
                                LEXHCODE = Mid(TxtRec!F1, 7, 6)
                                LSMaturity = DateValue(Mid$(TxtRec!F1, 13, 2) & "/" & Mid(TxtRec!F1, 16, 3) & "/" & Mid(TxtRec!F1, 20, 4))
                                LSInstType = "OPT"
                                LSOptType = Mid(TxtRec!F1, 24, 2)
                                LSStrike = Mid(TxtRec!F1, 26, Len(TxtRec!F1) - 25)
                            End If
                            LSettleRate = Val(TxtRec!F7)
                            lOpRate = Val(TxtRec!f3)
                            LHighRate = Val(TxtRec!F4)
                            LLowRate = Val(TxtRec!F5)
                            LCloseRate = Val(TxtRec!f6)
                        End Select

                        If LEXOptions = "N" And LSInstType = "OPT" Then GoTo EFlag_Next

                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LSItemName, LSExCode, 1, NewComm, False, 1)
                        'If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                        
                        If LTExCode = "RACE" Or LTExCode = "REAL" And LSItemid <> 0 Then
                            mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'FUT'" & ",'',0"
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec.EOF Then
                                LSSaudaID = TRec!SAUDAID
                                LSSaudaCode = TRec!saudacode
                                LSMaturity = TRec!MATURITY
                            End If
                        End If
                        If LGCloseFile = "7" Then
                            Call Get_Sauda_Details(LEXHCODE, NewComm, False, LSCondate, 2)
                        Else
                            Call Get_Sauda_Details(LEXHCODE, NewComm, False, LSCondate, 1)
                        End If
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        
                        Label3.Caption = CStr(LSCondate) & " " & LEXHCODE & " " & LSMaturity & " " & LSInstType & " " & LSOptType & " " & LSStrike
                        LMinSaudaDate = Get_Min_Sauda_Condate(GCompCode, LSSaudaID)
                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LSEXID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        
                        If LenB(LMinSaudaDate) > 0 Then
                            If LSCondate >= DateValue(LMinSaudaDate) Then
                                LSCONTIME = Time
                                mysql = "DELETE FROM CTR_R WHERE SAUDAID =" & LSSaudaID & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                                Cnn.Execute mysql
                                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                                Call PInsert_Ctr_R(LSConSno, LSSaudaCode, LSCondate, lOpRate, LHighRate, LLowRate, LSettleRate, LCloseRate, LSExCode, LSItemCode, LSSaudaID, LSItemid, LSEXID, 0, LSCONTIME)
                            End If
                        Else
                            If LSItemCode = "GOLD" Or LSItemCode = "SILVER" Or LSItemCode = "CRUDEOIL" Or LSItemCode = "COPPER" Or LSItemCode = "LEAD" Or LSItemCode = "ZINC" Or LSItemCode = "NATURALGAS" Or LSItemCode = "USDINR" Then
                                mysql = "DELETE FROM CTR_R WHERE SAUDAID =" & LSSaudaID & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                                Cnn.Execute mysql
                                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                                Call PInsert_Ctr_R(LSConSno, LSSaudaCode, LSCondate, lOpRate, LHighRate, LLowRate, LSettleRate, LCloseRate, LSExCode, LSItemCode, LSSaudaID, LSItemid, LSEXID, 0, LSCONTIME)
                            End If
                        End If
                    
                    End If '>>> If Not IsNull(TxtRec!f1) And InStr(1, TxtRec!f1, ">") < 0 Then
                                        
EFlag_Next:
                    TxtRec.MoveNext
                    
                    '''
                    If LTExCode = "FX" And MFILE = 1 And TxtRec.EOF Then
                        TxtPath = "CD_NSE_OP" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right(CStr(Year(ltradedt)), 2) & ".CSV"
                        LFileName = App.Path & "\FX\" & TxtPath
                        If FileExist(LFileName) Then
                            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                            TxtRec.Open "SELECT * FROM " & TxtPath & " ", Jcnn, adOpenForwardOnly, adLockReadOnly
                            If Not TxtRec.EOF Then
                                MFILE = 2
                                TxtRec.MoveFirst
                            End If
                        End If
                    End If
                Wend
                TxtRec.close
                
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                mysql = "SELECT S.SAUDAID,I.CITEMID,S.SAUDACODE,S.EXCODE,I.ITEMCODE,I.ITEMID,I.EXID,S.MATURITY FROM SAUDAMAST AS S, ITEMMAST AS I"
                mysql = mysql & " WHERE s.COMPCODE =" & GCompCode & " AND S.ITEMID =I.ITEMID AND I.ITEMID <>I.CITEMID   "
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                Do While Not TRec.EOF
                    Set TRec2 = Nothing
                    Set TRec2 = New ADODB.Recordset
                    mysql = "SELECT OPRATE,HGRATE,LOWRATE,CLOSERATE FROM CTR_R WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND SAUDAID ="
                    mysql = mysql & " (SELECT SAUDAID FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND  ITEMID =" & TRec!CITEMID & " AND MATURITY ='" & Format(TRec!MATURITY, "YYYY/MM/DD") & "')"
                    TRec2.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec2.EOF Then
                        LSConSno = Get_ConSNo(LSCondate, TRec!saudacode, TRec!ITEMCODE, TRec!excode, TRec!SAUDAID, TRec!itemid, TRec!EXID)
                        mysql = "DELETE FROM CTR_R WHERE COMPCODE =" & GCompCode & " AND SAUDAID =" & TRec!SAUDAID & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                        Cnn.Execute mysql
                        Call PInsert_Ctr_R(LSConSno, TRec!saudacode, LSCondate, TRec2!OPRATE, TRec2!HGRATE, TRec2!LOWRATE, TRec2!CLOSERATE, 0, TRec!excode, TRec!ITEMCODE, TRec!SAUDAID, TRec!itemid, TRec!EXID, 0, "")
                    End If
                    TRec.MoveNext
                    
                Loop
                
            End If
            Set TxtRec = Nothing
        End If
NO_FILE:
            If Not GLOBALFLAG Then
                If Not FlagLoggedIn Then
                        LMsgBox = "File not found!!! on date " & ltradedt ', vbInformation
                        ImportIssues (LMsgBox)
                End If
            End If
       
    Next
    Cnn.CommitTrans
    CNNERR = False
    Set Jcnn = Nothing
    Exit Sub
err1:
errhandlr:
    Select Case err.Number
         Case 35754  'Unable to connect
            Resume Next
        Case 3265
            MsgBox LFileName & "  file not Uploaded by Exchange", vbCritical
        Case Else
'            If InStr(1, err.Description, "Access") >= 0 Then
'                GoTo NO_FILE
'            Else
                MsgBox LEXHCODE & " " & LSMaturity
                 MsgBox err.Number & " - " & err.Description
'            End If
        End Select
        
    If err.Number <> 0 Then
        MsgBox "File Not Uploaded Yet,Try After some Time"
        'MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    End If
    Cnn.RollbackTrans: CNNERR = False
End Sub
Public Function DownloadFile(sSourceUrl As String, sLocalFile As String) As Boolean
  '//'Download the file. BINDF_GETNEWESTVERSION forces
  '//'the API to download from the specified source.
  '//'Passing 0& as dwReserved causes the locally-cached
  '//'copy to be downloaded, if available. If the API
  '//'returns ERROR_SUCCESS (0), DownloadFile returns True.
    DeleteUrlCacheEntry (sSourceUrl)
   DownloadFile = URLDownloadToFile(0&, sSourceUrl, sLocalFile, BINDF_GETNEWESTVERSION, 0&) = ERROR_SUCCESS
      
    'get file size
    If DownloadFile Then
        DownloadFile = CheckFileSize(sLocalFile)
    End If
    '>>> if file does not downloaded from above source then download from our server c:/saudasoftwarefiles/
    If Not DownloadFile Then
        
        'Call Connect_Ftp("185.184.70.148", "", "", "/" & Replace(Replace(sLocalFile, App.Path & "\", ""), "\", "/"), sLocalFile)
        'Call Connect_Ftp("5.135.219.225", "", "", "/" & Replace(Replace(sLocalFile, App.Path & "\", ""), "\", "/"), sLocalFile)
        'Call Connect_Ftp("178.33.73.246", "administrator", "Om@12345", "/" & "MCX/textcsv.CSV", sLocalFile)
        
        'Call Connect_Ftp("50.62.169.103", "saudasoftware", "Khushi@12345", "/S-BKP/Files/" & Replace(Replace(sLocalFile, App.Path & "\", ""), "\", "/"), sLocalFile)
        Call Connect_Ftp("50.63.8.230", "saudasoftware", "Reet@73284", "/S-BKP/Files/" & Replace(Replace(sLocalFile, App.Path & "\", ""), "\", "/"), sLocalFile)
        
        DownloadFile = FlagDownloadedFromOurFTP
    End If
End Function
Private Sub LUnZipFile(LPZipFile As String, LPTarget As String)
Dim oUnZip As CGUnzipFiles
    Set oUnZip = New CGUnzipFiles
    With oUnZip
        .ZipFileName = LPZipFile
        .ExtractDir = LPTarget
        .HonorDirectories = False
        If .Unzip <> 0 Then MsgBox .GetLastMessage
    End With
    Set oUnZip = Nothing
    Exit Sub
End Sub
Sub Save_SaudaTradeFile(MOVERWRITE As Boolean, LTExCode As String)
    Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
    Dim MCount As Long:             Dim LConType As String:         Dim LPtyContype As String:      Dim LOrdTime As String:
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LOrdNo As String
    Dim LSCondate As Date:          Dim LOConNo As String:          Dim LContime As String:
    Dim StrDateLen As Integer:      Dim LSTRDATE As String:         Dim LMONTH As String:           Dim lyear As String
    Dim LClient As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
    Dim TRec As ADODB.Recordset:    Dim LUserId As String:          Dim LPartyName As String:       Dim LEXHCODE As String:
    
    On Error GoTo err1
    Call GET_JCnn("\TRADE;")
    Cnn.BeginTrans
    Get_ExDetail (LTExCode)
    CNNERR = True
    If LenB(LExCont) < 1 Then Exit Sub
    MSPARTY = LExCont
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If LTExCode = "MCX" Then
            TxtPath = "TRDMCX" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
        ElseIf LTExCode = "NSE" Then
            TxtPath = "TRDNSE" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
        ElseIf LTExCode = "NCDX" Then
            TxtPath = "TRDNCDX" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
        End If
        LFileName = App.Path & "\TRADE\" & TxtPath

        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "TRADE") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "TRADE")
        End If
        Set LFileSystemObject = Nothing
                
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & " "
            TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                LSCondate = DateValue(TxtRec!F5)
                MCount = Get_Max_ConNo(LSCondate, 0)
                If MOVERWRITE = True Then Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "'  AND DATAIMPORT =1 AND EXCODE='" & LTExCode & "'"
                TxtRec.MoveFirst
                LSExCode = LTExCode
                LSEXID = Get_ExID(LSExCode)
                While Not TxtRec.EOF
                    LSItemCode = vbNullString:                       LSSaudaCode = vbNullString:
                    LSItemid = 0:                                    LSSaudaID = 0
                    LOrdNo = vbNullString:                           mbparty = vbNullString:
                    LSInstType = "FUT":                              LSOptType = vbNullString
                    LSStrike = 0
                    LPtyContype = "B":                               LLOT = 1
                    LOConNo = Trim(Right$(TxtRec!F1, 7)):            LContime = Time
                    LSCondate = Format(TxtRec!F5, "yyyy/MM/dd"):     LEXHCODE = TxtRec!F4
                    LContime = Time:                                 LSItemName = LSItemCode
                    LRATE = Val(TxtRec!f6):                          LQTY = Val(TxtRec!F7)
                    mparty = Trim(TxtRec!F2):                        LPartyName = Trim(TxtRec!F2)
                    LConType = TxtRec!F8:                            LUserId = TxtRec!F2
                    LSMaturity = DateValue(Left$(TxtRec!f3, 2) & "/" & Mid(TxtRec!f3, 4, 2) & "/" & Right$(TxtRec!f3, 4))
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                    If LenB(LSItemCode) = 0 Then GoTo FFlag_Next
                    Call Get_Sauda_Details(LEXHCODE, False, True, LSCondate, 1)
                    If LenB(LSSaudaCode) = 0 Then GoTo FFlag_Next
                    LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                    If LConType = "S" Then LPtyContype = "S"
                    mbparty = NewParty(LSExCode, mparty, LPartyName & " " & LTExCode, LUserId, True)
                    If LenB(mbparty) = 0 Then GoTo FFlag_Next
                    MCount = MCount + 1
                    If InStr(LBillExId, str(LSEXID)) = 0 Then
                        If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                        LBillExId = LBillExId & str(LSEXID)
                    End If
                    If lminbilldate > LSCondate Then lminbilldate = LSCondate
                    LNoTrd = LNoTrd + 1
                    GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                    DoEvents
            
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LTExCode, LSSaudaID, LSItemid, LSEXID)
                    Call Add_To_Ctr_D(LPtyContype, mparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LTExCode, LLOT, 2, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
                   
FFlag_Next:
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
      
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Public Sub PDelete_CTR_D(LNCondate As Date, LNExCode As String, LNFileType As String)
mysql = "EXEC DELETE_CTR_D " & GCompCode & ",'" & Format(LNCondate, "YYYY/MM/DD") & "','" & LNExCode & "',1,'" & LNFileType & "'"
Cnn.Execute mysql
End Sub

Sub Save_Vertex()
    'date 20/07/2004
    Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
    Dim MCount As Long:             Dim LConType As String:         Dim LPtyContype As String:      Dim TRec As ADODB.Recordset
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSExCode As String
    Dim LContime As String:         Dim LOrdNo As String:           Dim LEXHCODE As String:         Dim LOrdTime As String
    Dim LSCondate As Date:          Dim LOConNo As String:          Dim LSTRDATE As String:         Dim LClient As String
    Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:          Dim LLOT As Double
    Dim LUserId As String:          Dim LPartyName As String:       Dim LFileSource As String:
    
    LOverwrite = True
    On Error GoTo err1
    'Call GET_JCnn("\SAP;")
    Cnn.BeginTrans
    CNNERR = True:
    Call Get_ExDetail(LSExCode)
    LSExCode = "CMX"
    If LenB(LBrokerCode) > 1 Then
        LExCont = LBrokerCode
        MSPARTY = LExCont
    Else
        Call Get_ExDetail(LSExCode)
        MSPARTY = LExCont
    End If
                        
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & " "
            TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            TxtRec.MoveFirst
            CNNERR = True
            MCount = Get_Max_ConNo(ltradedt, 0)
            TxtRec.MoveFirst
            While Not TxtRec.EOF
                LPtyContype = "B": LOrdTime = vbNullString: LSOptType = vbNullString: LSStrike = 0: LSInstType = "FUT"
                LSItemCode = vbNullString: LSSaudaCode = vbNullString
                LSItemid = 0:                LSSaudaID = 0
                LSExCode = vbNullString
                
                MCount = MCount + 1
                If Not IsNull(TxtRec!F4) Then
                    If IsNumeric(TxtRec!F4) Then
                        LSTRDATE = Trim$(TxtRec!F1)
                        LSCondate = DateValue(Left$(LSTRDATE, 2) & "/" & Mid$(LSTRDATE, 3, 2) & "/" & Mid$(LSTRDATE, 5, 4))
                        LContime = Right$(LSTRDATE, 4)
                        LSExCode = "CMX"
                        LEXHCODE = Left$(Trim$(TxtRec!F10), Len(Trim$(TxtRec!F10)) - 4)
                        LOConNo = Trim$(TxtRec!F4):                        LOrdNo = Trim$(TxtRec!F4)
                        LSTRDATE = Right$(Trim$(TxtRec!F10), 2):
                        
                        LConType = Left$(Trim$(TxtRec!f6), 1)
                        If LConType = "S" Then LPtyContype = "S"
                        If Val(LSTRDATE) > Val(month(LSCondate)) Then
                            LSMaturity = DateValue("28" & "/" & LSTRDATE & "/" & Year(LSCondate))
                        Else
                            LSMaturity = DateValue("28" & "/" & LSTRDATE & "/" & CStr(Val(Year(LSCondate)) + 1))
                        End If
                        
                        LSExCode = vbNullString
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 2)
                        If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                        Call Get_Sauda_Details(LEXHCODE, False, True, LSCondate, 1)
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If LConType = "S" Then LPtyContype = "S"
                        If LenB(LClientCode) > 1 Then
                            mbparty = LClientCode:
                            LClient = mparty:                    LUserId = mparty
                            LPartyName = vbNullString
                        Else
                            mparty = Left$(TxtRec!F7, 6)
                            mbparty = Get_ACCT_EX(LSEXID, mparty)
                            If LenB(mbparty) < 1 Then GoTo EFlag_Next
                        End If
                        LRATE = Val(TxtRec!f11)
                        LQTY = Val(TxtRec!F9)
                        MCount = MCount + 1
                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LSEXID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                           
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                        mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND EXCODE ='" & LSExCode & "'"
                        Cnn.Execute mysql
                        Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, "", LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)
                    End If
                End If
            
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
flag210:
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Function FTPDownloadFile(ByVal HostName As String, ByVal USERNAME As String, ByVal PASSWORD As String, ByVal RemoteFileName As String, ByVal LocalFileName As String) As Boolean

    Dim LFTP As Inet

    Set LFTP = Me.Inet1
    With LFTP
        .AccessType = icDirect
        .Protocol = icFTP
        .RemoteHost = HostName
        .USERNAME = USERNAME
        .PASSWORD = PASSWORD
        .Execute "DIR"
        Do While .StillExecuting
            DoEvents
        Loop
        FTPDownloadFile = (.ResponseCode = 0)
    End With
    Set LFTP = Nothing
End Function

Private Sub inet1_StateChanged(ByVal State As Integer)
 Select Case State
   Case 0
     Label3.Caption = "No state to report"
   Case 1
     Label3.Caption = "Looking IP address of host"
   Case 2
     Label3.Caption = "Found the IP address of host"
   Case 3
     Label3.Caption = "Connecting to host"
   Case 4
     Label3.Caption = "Successfully connected to host"
   Case 5
     Label3.Caption = "Sending request to host"
   Case 6
     Label3.Caption = "Successfully sent request to host"
   Case 7
     Label3.Caption = "Receiving response from host"
   Case 8
     Label3.Caption = "Successfully received a response from host"
   Case 9
     Label3.Caption = "Disconnecting from host"
   Case 10
     Label3.Caption = "Successfully disconected from host"
   Case 11
     Label3.Caption = "Error during communication with host"
   Case 12
     Label3.Caption = "Request completed and all data has been received"
 End Select
End Sub
Private Sub Save_DGCXTerminal()

On Error GoTo err1
    
    Dim lbparty As String:          Dim lsparty As String:          Dim ltradedt As Date:
    Dim TxtPath As String:          Dim LFileName As String:        Dim MCount As Long:
    Dim LConType As String:         Dim LPtyContype As String:      Dim LSConSno As Long
    Dim LQTY As Double:             Dim LRATE As Double:            Dim LOrdTime As String
    Dim LSCondate As Date:          Dim LOConNo As String:          Dim mbparty As String
    Dim MSPARTY As String:          Dim LContime As String:         Dim LOrdNo As String
    Dim LUserId As String:          Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
    Dim LFileSource As String:
    
    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    LSExCode = "DGCX"
    Call GET_JCnn("\DGCXT;")
    Call Get_ExDetail(LSExCode)
    Set TxtRec = Nothing:
    Set TxtRec = New ADODB.Recordset
    
    If LenB(BrokerCombo.BoundText) < 1 Then
        MsgBox "Please Select Broker"
        BrokerCombo.SetFocus
        Exit Sub
    Else
        LBrokerCode = BrokerCombo.BoundText
    End If
    
    If LenB(ClientCombo.BoundText) < 1 Then
        MsgBox "Please Select Client "
        ClientCombo.SetFocus
        Exit Sub
    Else
        LClientCode = ClientCombo.BoundText
    End If
    
    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        Else
            MsgBox "Please Select Valid File"
            Cnn.RollbackTrans
            Exit Sub
        End If
    
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = DateValue(ltradedt)
            If MsgBox("Are you Sure to Delete Trades from " & vcDTP1.Value & " to " & vcDTP2.Value & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE  >= '" & Format(vcDTP1.Value, "yyyy/MM/dd") & "' AND CONDATE  <= '" & Format(vcDTP2.Value, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND CONCODE ='" & LBrokerCode & "' AND EXCODE ='" & LSExCode & "' AND FILETYPE='T'"
            End If
            MCount = Get_Max_ConNo(LSCondate, 0)
            While Not TxtRec.EOF
                lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
                LOrdTime = vbNullString:      LSOptType = vbNullString:                LSStrike = 0:                  LLOT = 0:
                LSItemCode = vbNullString:                LSSaudaCode = vbNullString:                LSItemid = 0:                LSSaudaID = 0
                
                LQTY = 0::                    LRATE = 0:
                If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                LSTRCONDATE = IIf(IsNull(TxtRec!F24), vbNullString, TxtRec!F24)
                LContime = Right$(LSTRCONDATE, 12)
                LSTRCONDATE = Left$(LSTRCONDATE, 10)
                If IsDate(LSTRCONDATE) Then
                    LSCondate = DateValue(LSTRCONDATE)
                Else
                    GoTo EFlag_Next
                End If
                'LBParty = Trim(IIf(IsNull(TxtRec!f14), vbNullString, (TxtRec!f14)))
                lbparty = LClientCode
                LEXHCODE = Trim(IIf(IsNull(TxtRec!F5), vbNullString, TxtRec!F5))
                LEXHCODE = Left$(LEXHCODE, Len(LEXHCODE) - 9)
                Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                
                LSMaturity = DateValue(TxtRec!f6)
                Call Get_Sauda_Details(LEXHCODE, False, False, LSCondate, 1)
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LQTY = Val(IIf(IsNull(TxtRec!f16), 0, TxtRec!f16))
                LRATE = Val(IIf(IsNull(TxtRec!F17), 0, TxtRec!F17)):
                LConType = TxtRec!F15
                If LConType = "1" Then
                    LPtyContype = "B"
                Else
                    LPtyContype = "S"
                End If
                LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                mbparty = Get_ACCT_EX(LSEXID, lbparty)
                MSPARTY = LBrokerCode
                If LenB(mbparty) < 1 Then
                    mbparty = NewParty(LSExCode, lbparty, lbparty, vbNullString, True)
                End If
                If LenB(mbparty) < 1 Then GoTo EFlag_Next
                MCount = MCount + 1
                If InStr(LBillExId, str(LSEXID)) = 0 Then
                    If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                    LBillExId = LBillExId & str(LSEXID)
                End If
                If lminbilldate > LSCondate Then lminbilldate = LSCondate
                LNoTrd = LNoTrd + 1
                GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                DoEvents
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                LOConNo = Trim(str(MCount))
                Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "T", "Y", LSEXID, LSItemid, LSSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Private Sub Save_ExcelOtc()
On Error GoTo err1
    Dim lbparty As String:          Dim lsparty As String:          Dim ltradedt As Date:       Dim LStrike As Double:
    Dim TxtPath As String:          Dim LFileName As String:        Dim LContime As String:     Dim LOrdNo As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:     Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:        Dim LSInstType As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LCITEM As String:       Dim LSSauda As String
    Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim LOConNo As String:      Dim ITExchangeCode As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LOptType As String:     Dim lyear As Integer
    Dim LLOT As Double:             Dim LUserId As String:          Dim LEXHCODE As String:     Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LNo As Integer:             Dim LStrMonth As String:    Dim LString As String:
    Dim LMONTH As Integer:          Dim LSaudaID As Long
    Dim LExID As Integer:           Dim LItemID As Integer
    
    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    Call GET_JCnn("\TRADE;")
                    

        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "TRADE") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "TRADE")
        End If
        Set LFileSystemObject = Nothing
                    
                    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "TRD" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = App.Path & "\TRADE\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                If MsgBox("Are you Sure to Delete Trades of  " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(ltradedt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='1O'"
                End If
                MCount = Get_Max_ConNo(LSCondate, 0)
                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                    LSaudaID = 0
                    LQTY = 0::                    LRATE = 0:
                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                    If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                    LSCondate = DateValue(TxtRec!F1)
                    LContime = Time
                    LString = Right$(TxtRec!F2, 3)
                    LEXHCODE = Left$(TxtRec!F2, Len(TxtRec!F2) - 3)
                    If Not IsNull(TxtRec!F9) Then
                        If Val(TxtRec!F9) <> 0 Then
                            LSInstType = "OPT"
                            LOptType = TxtRec!F8
                            LStrike = Val(TxtRec!F9)
                        End If
                    End If
                    LStrMonth = Left$(LString, 1)
                    Select Case LStrMonth
                        Case "F"
                            LMONTH = 1
                        Case "G"
                            LMONTH = 2
                        Case "H"
                            LMONTH = 3
                        Case "J"
                            LMONTH = 4
                        Case "K"
                            LMONTH = 5
                        Case "M"
                            LMONTH = 6
                        Case "N"
                            LMONTH = 7
                        Case "Q"
                            LMONTH = 8
                        Case "U"
                            LMONTH = 9
                        Case "V"
                            LMONTH = 10
                        Case "X"
                            LMONTH = 11
                        Case "Z"
                            LMONTH = 12
                    End Select
                    If LMONTH >= month(ltradedt) Then
                        lyear = Year(ltradedt)
                    Else
                        lyear = Year(ltradedt) + 1
                    End If
                    mysql = "SELECT ITEMID,ITEMCODE,EXCHANGECODE,LOT,EXID FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        LSItemCode = TRec!ITEMCODE
                        LLOT = TRec!lot
                        LSExCode = TRec!EXCHANGECODE
                        LExID = TRec!EXID
                        LItemID = TRec!itemid
                    Else
                        LMsgBox = " Create New Commodity " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                    'MYSQL = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE =" & LItemID & ""
                    'MYSQL = MYSQL & " AND MONTH(MATURITY)=" & LMonth & " AND YEAR(MATURITY)=" & LYEAR & ""
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",''," & LMONTH & "," & lyear & ",'FUT'" & ",'',0"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode
                        LSaudaID = TRec!SAUDAID
                    Else
                        LSMaturity = DateValue("20/" & LMONTH & "/" & lyear & "")
                        If LSInstType = "FUT" Then
                            LSSaudaCode = LSItemCode & " " & LStrMonth & " " & lyear
                        Else
                            LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LStrMonth & " " & lyear
                        End If
                        LExID = Get_ExID(LSExCode)
                        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                        LSaudaID = Get_SaudaID(LSSaudaCode)
                    End If
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    
                    LQTY = Val(IIf(IsNull(TxtRec!f3), 0, TxtRec!f3))
                    LRATE = Val(IIf(IsNull(TxtRec!F4), 0, TxtRec!F4)):
                    LConType = Left$(TxtRec!F5, 1)
                    If LConType = "B" Then
                        LPtyContype = "B"
                    Else
                        LPtyContype = "S"
                    End If
                    lbparty = TxtRec!f6
                    lsparty = TxtRec!F7
                    mbparty = Get_ACCT_EX(LExID, lbparty)
                    If LenB(mbparty) < 1 Then
                        mbparty = NewParty(LSExCode, lbparty, lbparty, vbNullString, True)
                    End If
                    If LenB(mbparty) < 1 Then GoTo EFlag_Next
                    MSPARTY = Get_ACCT_EX(LExID, lsparty)
                    If LenB(MSPARTY) < 1 Then
                        MSPARTY = NewParty(LSExCode, lsparty, lsparty, vbNullString, True)
                    End If
                    If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
                    MCount = MCount + 1
                    LOConNo = str(MCount)
                    If InStr(LBillExId, str(LExID)) = 0 Then
                                    If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                    LBillExId = LBillExId & str(LExID)
                                End If
                                
                                If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                           
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                    Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "1O", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            'End If
        End If
    End If
Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Private Sub Save_CMEFILE()
    On Error GoTo err1
    Dim lbparty As String:          Dim lsparty As String:          Dim ltradedt As Date:           Dim MSPARTY As String
    Dim TxtPath As String:          Dim LFileName As String:        Dim LSaudaID As Long:        Dim mbparty As String:
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOptType As String:         Dim LStrike As Double:          Dim LContime As String:         Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LCITEM As String:           Dim LSSauda As String
    Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
    Dim LLOT As Double:             Dim LUserId As String:          Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LNo As Integer:             Dim LStrMonth As String:        Dim LMONTH As Integer
    Dim LString As String:          Dim lyear As Integer:           Dim LBrokerCode  As String:     Dim LClientCode  As String
    Dim LFileSource  As String:     Dim LStrYear As String:         Dim LDT As Date
    Dim LExID As Integer: Dim LItemID As Integer
    
    Set TxtRec = Nothing:
    Set TxtRec = New ADODB.Recordset
    If LenB(BrokerCombo.BoundText) < 1 Then
        MsgBox "Please Select Broker"
        BrokerCombo.SetFocus
        Exit Sub
    Else
        LBrokerCode = BrokerCombo.BoundText
    End If
    
    If LenB(ClientCombo.BoundText) < 1 Then
        MsgBox "Please Select Client "
        ClientCombo.SetFocus
        Exit Sub
    Else
        LClientCode = ClientCombo.BoundText
    End If
    'Call GET_JCnn("\CME;")
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        Else
            MsgBox "Please Select Valid File"
            Cnn.RollbackTrans
            Exit Sub
        End If
    
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = DateValue(ltradedt)
            If MsgBox("Are you Sure to Delete Trades of  " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(ltradedt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND CONCODE='" & LBrokerCode & "'AND FILETYPE ='C'"
            End If
            MCount = Get_Max_ConNo(LSCondate, 0)
            While Not TxtRec.EOF
                lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                LQTY = 0::                    LRATE = 0:
                LItemID = 0
                If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                If TxtRec!f3 <> "CME" Then GoTo EFlag_Next
                LSTRCONDATE = TxtRec!F13
                LSCondate = DateValue(Mid(LSTRCONDATE, 9, 2) & "/" & Mid(LSTRCONDATE, 5, 3) & "/" & Right$(LSTRCONDATE, 4))
                LContime = Mid(LSTRCONDATE, 12, 8)
                LEXHCODE = TxtRec!F4
                LStrMonth = Left$(TxtRec!F5, 3)
                LStrYear = "20" & Right$(TxtRec!F5, 2)
                LDT = DateValue("20" & "/" & LStrMonth & "/" & LStrYear)
                LMONTH = month(LDT)
                lyear = Year(LDT)
                mysql = "SELECT LITEMID,EXID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    LSItemCode = TRec!ITEMCODE
                    LLOT = TRec!lot
                    LSExCode = TRec!EXCHANGECODE
                    LExID = TRec!EXID
                    LItemID = TRec!itemid
                    
                Else
                    LMsgBox = " Create New Commodity " & LEXHCODE & ""
                    ImportIssues (LMsgBox)
                    GoTo EFlag_Next
                End If
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                'MYSQL = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE =" & LItemID & ""
                'MYSQL = MYSQL & " AND MONTH(MATURITY)=" & LMonth & " AND YEAR(MATURITY)=" & LYEAR & ""
                mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",''," & LMONTH & "," & lyear & ",'FUT'" & ",'',0"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode
                Else
                    LSMaturity = DateValue("20/" & LMONTH & "/" & lyear & "")
                    If LSInstType = "FUT" Then
                        LSSaudaCode = LSItemCode & " " & LStrMonth & " " & lyear
                    Else
                        LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LStrMonth & " " & lyear
                    End If
                    LExID = Get_ExID(LSExCode)
                    Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                End If
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LSaudaID = Get_SaudaID(LSSaudaCode)
                LQTY = Val(TxtRec!f11)
                LQTY = LQTY * 4
                LRATE = Val(TxtRec!f12)
                LConType = Left$(TxtRec!f6, 1)
                If LConType = "B" Then
                    LPtyContype = "B"
                Else
                    LPtyContype = "S"
                End If
                lbparty = LClientCode
                lsparty = LBrokerCode
                mbparty = Get_ACCT_EX(LExID, lbparty)
                If LenB(mbparty) < 1 Then GoTo EFlag_Next
                MSPARTY = Get_ACCT_EX(LExID, lsparty)
                If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
                MCount = MCount + 1
                LOConNo = str(MCount)
                If InStr(LBillExId, str(LExID)) = 0 Then
                    If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                    LBillExId = LBillExId & str(LExID)
                End If
                If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                           
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "C", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Private Sub Save_DGCXFile()

    On Error GoTo err1
    Dim TxtPath As String:          Dim LFileName As String:        Dim LFileSource As String:       Dim LFolderName As String
    Dim LMFLPath As String:         Dim ltradedt As Date:           Dim LExcelFileType As Integer:    Dim TRec As ADODB.Recordset
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        ltradedt = vcDTP1.Value
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        mysql = "SELECT EXFILETYPE,FOLDERNAME,CONTRACTACC,BROKERTYPE,PARTYAS,CLIENTCODE FROM EXFILE WHERE COMPCODE =" & GCompCode & " "
        mysql = mysql & " AND EXCODE='DGCX' ORDER BY FILEID "
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not TRec.EOF
            LClientCode = TRec!CLIENTCODE
            LExCont = TRec!CONTRACTACC
            LBrokerType = TRec!BROKERTYPE
            LFolderName = TRec!FOLDERNAME
            LPartyAs = TRec!PARTYAS
            LExcelFileType = Val(TRec!EXFILETYPE & vbNullString)
            If LPartyAs = "F" Then LClientCode = TRec!CLIENTCODE
            TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
            'CommonDialog1.InitDir = App.Path & LFolderName
            'CommonDialog1.ShowOpen
            'If CommonDialog1.FileName <> "" Then
            '    Text1.text = CommonDialog1.FileName
            'Else
            '    MsgBox "Please Select Valid File"
            '    Cnn.RollbackTrans
            '    Exit Sub
            'End If
            'TxtPath = CommonDialog1.FileTitle
            LFileName = App.Path & "\" & LFolderName & "\" & TxtPath & ""
            

            Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
            If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
                LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
            End If
            Set LFileSystemObject = Nothing
        
            'LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ""
            Call GET_JCnn("\" & LFolderName & "\;")
            If Not FileExist(LFileName) Then
                LMsgBox = LFileName & "  file not found" ', vbCritical
                ImportIssues (LMsgBox)
            Else
                Call Create_SchemaFile(LMFLPath, TxtPath)
                Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                Call Save_DGCXAll_File(LExcelFileType, ltradedt)
            End If
            TRec.MoveNext
        Loop
    Next
    Exit Sub
err1:
    
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Private Sub Save_AllTradeFile()
    On Error GoTo err1
    Dim lbparty As String:          Dim lsparty As String:          Dim ltradedt As Date:           Dim LStrDay As String
    Dim TxtPath As String:          Dim LFileName As String:        Dim LConType As String:         Dim LPtyContype As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LStrYear As String:         Dim LSaudaID As Long
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOptType As String:         Dim LStrike As Double:          Dim LFilepath  As String:       Dim LSTRCONDATE  As String
    Dim LContime As String:         Dim LOrdNo As String:           Dim LDT As Date:                Dim LMONTH As Integer
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LCITEM As String:           Dim LSSauda As String
    Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LBrokerCode  As String:     Dim LClientCode  As String
    Dim LLOT As Double:             Dim LUserId As String:          Dim LEXHCODE As String:         Dim lyear As Integer:
    Dim TRec As ADODB.Recordset:    Dim LNo As Integer:             Dim LStrMonth As String:        Dim LString As String:
    Dim LExID As Integer:           Dim LItemID As Integer
    
    Set TxtRec = Nothing:
    Set TxtRec = New ADODB.Recordset
    If Check26.Value = 1 Or Check25.Value = 1 Then
        If LenB(BrokerCombo.BoundText) < 1 Then
            MsgBox "Please Select Broker"
            BrokerCombo.SetFocus
            Exit Sub
        Else
            LBrokerCode = BrokerCombo.BoundText
        End If
    End If
    If Check25.Value = 1 Then
        If LenB(ClientCombo.BoundText) < 1 Then
            MsgBox "Please Select Client "
            ClientCombo.SetFocus
            Exit Sub
        Else
            LClientCode = ClientCombo.BoundText
        End If
    End If
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If lfiletype = "DGCX FILE" Then
        Call GET_JCnn("\DGCX;")
        LFilepath = App.Path & "\DGCX\"
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "DGCX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "DGCX")
        End If
    ElseIf lfiletype = "CME FILE" Then
        Call GET_JCnn("\CME;")
        LFilepath = App.Path & "\CME\"
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "CME") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "CME")
        End If
    ElseIf lfiletype = "VERTEX FILE" Then
        Call GET_JCnn("\VERTEX;")
        LFilepath = App.Path & "\VERTEX\"
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "VERTEX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "VERTEX")
        End If
    End If
    Set LFileSystemObject = Nothing
                                    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "TR" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = LFilepath & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                If MsgBox("Are you Sure to Delete Trades From   " & ltradedt & " Till Date", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE >= '" & Format(ltradedt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE ='" & Left$(lfiletype, 1) & "'"
                End If
                MCount = Get_Max_ConNo(LSCondate, 0)
                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                    LQTY = 0::                    LRATE = 0:                        LSaudaID = 0: LItemID = 0
                    
                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                    
                    If TxtRec!F1 <> "DGCX" Then GoTo EFlag_Next
                    Select Case lfiletype
                        Case "DGCX FILE"
                            LSCondate = ltradedt
                            LContime = Time
                            LEXHCODE = TxtRec!f3
                            LStrDay = Left$(TxtRec!F4, 2)
                            LStrMonth = Mid(TxtRec!F4, 3, 3)
                            LStrYear = Right$(TxtRec!F4, 4)
                            LSMaturity = DateValue(LStrDay & "/" & LStrMonth & "/" & LStrYear)
                        Case "CME FILE"
                            LSCondate = ltradedt
                            LContime = Time
                            LEXHCODE = TxtRec!f3
                            LStrDay = Left$(TxtRec!F4, 2)
                            LStrMonth = Mid(TxtRec!F4, 3, 3)
                            LStrYear = Right$(TxtRec!F4, 4)
                            LSMaturity = DateValue(LStrDay & "/" & LStrMonth & "/" & LStrYear)
                            LQTY = Val(TxtRec!F10)
                            LRATE = Val(TxtRec!F8)
                            LConType = Left$(TxtRec!F7, 1)
                            If LConType = "B" Then
                                LPtyContype = "B"
                            Else
                                LPtyContype = "S"
                            End If
                            lbparty = TxtRec!f12
                            lsparty = LBrokerCode
                            
                            mbparty = Get_ACCT_EX(LExID, lbparty)
                            If LenB(mbparty) < 1 Then GoTo EFlag_Next
                            MSPARTY = Get_ACCT_EX(LSExCode, lsparty)
                            If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
                        Case "VERTEX FILE"
                            LSCondate = ltradedt
                            LContime = Time
                            LEXHCODE = TxtRec!f3
                            LStrDay = Left$(TxtRec!F4, 2)
                            LStrMonth = Mid(TxtRec!F4, 3, 3)
                            LStrYear = Right$(TxtRec!F4, 4)
                            LSMaturity = DateValue(LStrDay & "/" & LStrMonth & "/" & LStrYear)
                            LQTY = Val(TxtRec!F10)
                            LRATE = Val(TxtRec!F8)
                            LConType = Left$(TxtRec!F7, 1)
                            If LConType = "B" Then
                                LPtyContype = "B"
                            Else
                                LPtyContype = "S"
                            End If
                            lbparty = TxtRec!f12
                            lsparty = LBrokerCode
                            mbparty = Get_ACCT_EX(LExID, lbparty)
                            If LenB(mbparty) < 1 Then GoTo EFlag_Next
                            MSPARTY = Get_ACCT_EX(LExID, lsparty)
                            If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
                    End Select
                    mysql = "SELECT ITEMID,EXID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        LSItemCode = TRec!ITEMCODE
                        LLOT = TRec!lot
                        LSExCode = TRec!EXCHANGECODE
                        LItemID = TRec!itemid
                        LExID = TRec!EXID
                    Else
                        LMsgBox = " Create New Commodity " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    
                    Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                    'MYSQL = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMID =" & LItemID & ""
                    'MYSQL = MYSQL & " AND MATURITY='" & Format(LSMaturity, "yyyy/mm/dd") & "'"
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",'" & Format(LSMaturity, "yyyy/mm/dd") & "',0,0,'FUT'" & ",'',0"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode
                    Else
                        If LSInstType = "FUT" Then
                            LSSaudaCode = LSItemCode & " " & month(LSMaturity) & " " & Year(LSMaturity)
                        Else
                            LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LStrMonth & " " & lyear
                        End If
                        LExID = Get_ExID(LSExCode)
                        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                    End If
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        LSaudaID = Get_SaudaID(LSSaudaCode)
                        MCount = MCount + 1
                        LOConNo = str(MCount)
                        If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                        Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "0", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            'End If
        End If
    End If
Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Private Sub Save_VertexFile()
    On Error GoTo err1
    Dim lbparty As String:          Dim lsparty As String:          Dim ltradedt As Date:           Dim mbparty As String
    Dim TxtPath As String:          Dim LFileName As String:        Dim LSaudaID As Long:        Dim MSPARTY As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOptType As String:         Dim LStrike As Double:          Dim LContime As String:         Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LCITEM As String:           Dim LSSauda As String
    Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
    Dim LLOT As Double:             Dim LUserId As String:          Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LNo As Integer:             Dim LStrMonth As String:        Dim LMONTH As Integer
    Dim LString As String:          Dim lyear As Integer:           Dim LBrokerCode  As String:     Dim LClientCode  As String
    Dim LStrYear As String:         Dim Llen  As Integer:           Dim LDT As Date
    Dim LExID  As Integer:          Dim LItemID As Integer
    
    Set TxtRec = Nothing:
    Set TxtRec = New ADODB.Recordset
    If LenB(BrokerCombo.BoundText) < 1 Then
        MsgBox "Please Select Broker"
        BrokerCombo.SetFocus
        Exit Sub
    Else
        LBrokerCode = BrokerCombo.BoundText
    End If
    
    If LenB(ClientCombo.BoundText) < 1 Then
        MsgBox "Please Select Client "
        ClientCombo.SetFocus
        Exit Sub
    Else
        LClientCode = ClientCombo.BoundText
    End If
    
    Call GET_JCnn("\VERTEX;")
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "VERTEX") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "VERTEX")
    End If
    Set LFileSystemObject = Nothing
                    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "TR" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = App.Path & "\VERTEX\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                If MsgBox("Are you Sure to Delete Trades of  " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE >= '" & Format(ltradedt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FileType ='V' "
                End If
                MCount = Get_Max_ConNo(LSCondate, 0)
                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                    LSaudaID = 0
                    LQTY = 0::                    LRATE = 0:
                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                    If TxtRec!F5 <> "Buy" Then
                        If TxtRec!F5 <> "Sell" Then GoTo EFlag_Next
                    End If
                        
                    LSCondate = DateValue(Left$(TxtRec!F4, 10))
                    LContime = Right$(TxtRec!F4, 5)
                    LEXHCODE = TxtRec!F7
                    Llen = Len(LEXHCODE)
                    If Mid(LEXHCODE, 1, Llen - 4) = "DG INR" Then
                        LEXHCODE = "DINR"
                    ElseIf Mid(LEXHCODE, 1, Llen - 4) = "SILVER" Then
                        LEXHCODE = "CMX SIL"
                    ElseIf Mid(LEXHCODE, 1, Llen - 4) = "GOLD" Then
                        LEXHCODE = "CMX GLD"
                    ElseIf Mid(LEXHCODE, 1, Llen - 4) = "CRUDE" Then
                        LEXHCODE = "CMX CRUDE"
                    ElseIf Mid(LEXHCODE, 1, Llen - 4) = "COPPER" Then
                        LEXHCODE = "CMX COPPER"
                    End If
                    LStrMonth = Right$(TxtRec!F7, 2)
                    LSTRCONDATE = "01/" & LStrMonth & "/2018"
                    If month(ltradedt) <= month(DateValue(LSTRCONDATE)) Then
                        LStrYear = Year(ltradedt)
                    Else
                        LStrYear = Year(ltradedt) + 1
                    End If
                    
                    LDT = DateValue("20" & "/" & LStrMonth & "/" & LStrYear)
                    LMONTH = month(LDT)
                    lyear = Year(LDT)
                    mysql = "SELECT ITEMID,EXID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        LSItemCode = TRec!ITEMCODE
                        LLOT = TRec!lot
                        LSExCode = TRec!EXCHANGECODE
                        LExID = TRec!EXID
                        LItemID = TRec!itemid
                    Else
                        LMsgBox = " Create New Commodity " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                    'MYSQL = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE =" & LItemID & ""
                    'MYSQL = MYSQL & " AND MONTH(MATURITY)=" & LMonth & " AND YEAR(MATURITY)=" & LYEAR & ""
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",''," & LMONTH & "," & lyear & ",'FUT'" & ",'',0"
                    'MYSQL = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'FUT'" & ",'',0"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode
                        LSaudaID = TRec!SAUDAID
                    Else
                        LSMaturity = DateValue("20/" & LMONTH & "/" & lyear & "")
                        If LSInstType = "FUT" Then
                            LSSaudaCode = LSItemCode & " " & LStrMonth & " " & lyear
                        Else
                            LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LStrMonth & " " & lyear
                        End If
                        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                        LSaudaID = Get_SaudaID(LSSaudaCode)
                    End If
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    
                        LQTY = Val(TxtRec!f6)
                        LRATE = Val(TxtRec!F8)
                        LConType = Left$(TxtRec!F5, 1)
                        If LConType = "B" Then
                            LPtyContype = "B"
                        Else
                            LPtyContype = "S"
                        End If
                        lbparty = LClientCode
                        lsparty = LBrokerCode
                        mbparty = Get_ACCT_EX(LExID, lbparty)
                        If LenB(mbparty) < 1 Then GoTo EFlag_Next
                        
                        MSPARTY = Get_ACCT_EX(LExID, lsparty)
                        
                        If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
                        
                        MCount = MCount + 1
                        LOConNo = str(MCount)
                        If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                        Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "V", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            'End If
        End If
    End If
Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Private Sub Save_DGCX_Trader()
    On Error GoTo err1
    Dim ltradedt As Date:           Dim TxtPath As String:          Dim LFileName As String
    Dim LFileSource As String:      Dim lbparty As String:          Dim lsparty As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String
    Dim LPtyContype As String:      Dim LSConSno As Long:           Dim LQTY As Double
    Dim LSInstType As String:       Dim LOptType As String:         Dim LStrike As Double
    Dim LOrdNo As String:           Dim LOrdTime As String:         Dim LSSaudaCode As String:
    Dim LCITEM As String:           Dim LSSauda As String:          Dim LSCondate As Date
    Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LLOT As Double
    Dim LUserId As String:          Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LContime As String:         Dim LRATE As Double
    Dim LSaudaID As Long:        Dim LExID As Integer:           Dim LItemID As Integer

    Set TxtRec = Nothing:
    Set TxtRec = New ADODB.Recordset
    Call Get_ExDetail("DGCX")
    If LenB(LExCont) < 1 Then
        MsgBox "Please Select Contract A/c"
        Exit Sub
    End If
                    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        Else
            MsgBox "Please Select Valid File"
            Cnn.RollbackTrans
            Exit Sub
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = DateValue(ltradedt)
            If MsgBox("Are you Sure to Delete Trades of  " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(ltradedt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 " & " AND FILETYPE='DT' AND EXCODE='DGCX'"
            End If
            MCount = Get_Max_ConNo(LSCondate, 0)
            While Not TxtRec.EOF
                lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString:      LSaudaID = 0
                LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                LQTY = 0:                     LRATE = 0:                       LItemID = 0
                If IsNull(TxtRec!F10) Then GoTo EFlag_Next
                If TxtRec!F10 <> "FUT" Then GoTo EFlag_Next
                LSCondate = DateValue(Left$(TxtRec!F14, 10))
                LContime = Right$(TxtRec!F14, Len(TxtRec!F14) - 10)
                LEXHCODE = Left$(TxtRec!f23, Len(TxtRec!f23) - 9)
                LSTRCONDATE = Right$(TxtRec!f23, 8)
                LSExCode = TxtRec!F21
                Call Get_ExDetail(LSExCode)
                If LenB(LExCont) < 1 Then
                    MsgBox "Please Select Contract A/c"
                    Exit Sub
                End If
                LSMaturity = DateValue(Right$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 5, 2) & "/" & Left$(LSTRCONDATE, 4))
                mysql = "SELECT EXID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "' AND EXCHANGECODE  ='" & LSExCode & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSItemCode = TRec!ITEMCODE
                    LLOT = TRec!lot
                    LSExCode = TRec!EXCHANGECODE
                    LExID = TRec!EXID
                    LItemID = TRec!itemid
                Else
                    LExID = Get_ExID(LSExCode)
                    LSItemCode = Create_TItemMast(LEXHCODE, LEXHCODE, LEXHCODE, 1, LSExCode)
                    LItemID = Get_ITEMID(LSItemCode)
                    'MsgBox " Create New Commodity/Script " & LExhCode & ""
                    'GoTo EFlag_Next
                End If
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                'MYSQL = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE =" & LItemID & ""
                'MYSQL = MYSQL & " AND MATURITY='" & Format(LSMaturity, "yyyy/mm/dd") & "'"
                mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",'" & Format(LSMaturity, "yyyy/mm/dd") & "',0,0,'FUT'" & ",'',0"
                'MYSQL = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'FUT'" & ",'',0"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode
                Else
                    If LSInstType = "FUT" Then
                        LSSaudaCode = LSExCode & " " & LSItemCode & " " & LSMaturity & ""
                    Else
                        LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LSMaturity & " "
                    End If
                    
                    Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                End If
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LSaudaID = Get_SaudaID(LSSaudaCode)
                LQTY = Val(TxtRec!F13)
                LRATE = Val(TxtRec!f12)
                LConType = Left$(TxtRec!F9, 1)
                If LConType = "1" Then
                    LPtyContype = "B"
                Else
                    LPtyContype = "S"
                End If
                lbparty = TxtRec!f25
                mbparty = NewParty(LSExCode, lbparty, lbparty, vbNullString, True)
                MSPARTY = LExCont
                
                mbparty = Get_ACCT_EX(LExID, lbparty)
                If LenB(mbparty) < 1 Then GoTo EFlag_Next
                If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
                MCount = MCount + 1
                LOConNo = str(MCount)
                If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                
                Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "DT", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Private Sub Save_CME_Trader()
    On Error GoTo err1
    Dim ltradedt As Date:           Dim TxtPath As String:          Dim LFileName As String:  Dim LFileSource As String:      Dim lbparty As String:          Dim lsparty As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:   Dim LPtyContype As String:      Dim LSConSno As Long:           Dim LQTY As Double
    Dim LSInstType As String:       Dim LOptType As String:         Dim LStrike As Double:    Dim LOrdNo As String:           Dim LOrdTime As String:         Dim LSSaudaCode As String:
    Dim LCITEM As String:           Dim LSSauda As String:          Dim LSCondate As Date:    Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LLOT As Double:       Dim LUserId As String:          Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LContime As String:         Dim LRATE As Double:      Dim LConNo As Long:             Dim lyear As String:            Dim LMONTH As String
    Dim LSettleRate As Double:      Dim A As Integer:               Dim B As Integer:         Dim lday As String:             Dim C As Integer:               Dim LParty As String
    Dim LSaudaID As Long:        Dim LExID As Integer:           Dim LItemID As Integer
    
    Set TxtRec = Nothing:
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT EXCODE FROM EXMAST WHERE COMPCODE =" & GCompCode & "AND EXNAME LIKE 'C%'"
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then
        Do While Not TRec.EOF
            If TRec!excode = "CMX" Then
                LSExCode = "CMX"
                Exit Do
            End If
            If TRec!excode = "CME" Then
                LSExCode = "CME"
                Exit Do
            End If
            TRec.MoveNext
        Loop
    End If
    Set TxtRec = New ADODB.Recordset
    
    Call Get_ExDetail(LSExCode)
    If LTradeFileType = "3" Then
        If LenB(BrokerCombo.BoundText) > 1 Then
            LExCont = BrokerCombo.BoundText
        Else
            MsgBox " Please Select Broker Account"
            Exit Sub
        End If
        If LenB(ClientCombo.BoundText) > 1 Then
            LParty = ClientCombo.BoundText
        Else
            MsgBox " Please Select client Account"
            Exit Sub
        End If
    End If
    If LTradeFileType = "6" Then
        If LenB(BrokerCombo.BoundText) > 1 Then
            LExCont = BrokerCombo.BoundText
        End If
    End If
    If LTradeFileType = "7" Then
        If LenB(BrokerCombo.BoundText) > 1 Then
            LExCont = BrokerCombo.BoundText
        End If
    End If
    Cnn.BeginTrans
    CNNERR = True
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If LTradeFileType = "1" Or LTradeFileType = "3" Or LTradeFileType = "5" Or LTradeFileType = "7" Then
            CommonDialog1.InitDir = App.Path
            CommonDialog1.ShowOpen
            If CommonDialog1.FileName <> "" Then
                Text1.text = CommonDialog1.FileName
            Else
                MsgBox "Please Select Valid File"
                Cnn.RollbackTrans
                Exit Sub
            End If
            TxtPath = CommonDialog1.FileTitle
            LFileName = CommonDialog1.FileName
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
            
        ElseIf LTradeFileType = "6" Then
            TxtPath = "TradeDetailsCSV_REVIVE_" & Mid(ltradedt, 4, 2) & Left(ltradedt, 2) & Right(ltradedt, 4) & "_06_55_01.csv"
            LFileName = App.Path & "\CME\" & TxtPath
            LFileSource = App.Path & "\CME;"
        Else
            TxtPath = "CME" & Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & Right(ltradedt, 4) & ".CSV"
            LFileName = App.Path & "\CME\" & TxtPath
            LFileSource = App.Path & "\CME;"
        End If
            
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "CME") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "CME")
        End If
        Set LFileSystemObject = Nothing
        
        If Not FileExist(LFileName) Then
            CommonDialog1.InitDir = App.Path
            CommonDialog1.ShowOpen
            If CommonDialog1.FileName <> "" Then
                Text1.text = CommonDialog1.FileName
            Else
                MsgBox "Please Select Valid File"
                Cnn.RollbackTrans
                Exit Sub
            End If
            TxtPath = CommonDialog1.FileTitle
            LFileName = CommonDialog1.FileName
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
            Set Jcnn = Nothing
            Set Jcnn = New ADODB.Connection
            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
            "Data Source=" & LFileSource & _
            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        Else
            Set Jcnn = Nothing
            Set Jcnn = New ADODB.Connection
            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
            "Data Source=" & LFileSource & _
            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = ltradedt
            'LScondate = DateValue(Mid(LStrConDate, 4, 2) & "/" & Left$(LStrConDate, 2) & "/" & Right(LStrConDate, 4))
            If LTradeFileType = "5" Then
                If MsgBox("Are you Sure to Delete Trades From  " & vcDTP1.Value & " to" & vcDTP2.Value & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE >='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "' AND CONDATE <='" & Format(vcDTP2.Value, "YYYY/MM/DD") & "' AND FILETYPE ='" & LTradeFileType & "'"
                    Cnn.Execute mysql
                End If
            ElseIf LTradeFileType = "6" Or LTradeFileType = "7" Then
                If MsgBox("Are you Sure to Delete Trades of " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "' AND DATAIMPORT =1 AND CONCODE ='" & LExCont & "' AND FILETYPE ='" & LTradeFileType & "'"
                    Cnn.Execute mysql
                End If
            ElseIf LTradeFileType = "7" Then
                If MsgBox("Are you Sure to Delete Trades of " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "' AND DATAIMPORT =1 AND FILETYPE ='" & LTradeFileType & "'"
                    Cnn.Execute mysql
                End If
                
            ElseIf LTradeFileType = "3" Then
                If MsgBox("Are you Sure to Delete Trades of " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "' AND FILETYPE ='" & LTradeFileType & "' AND EXCODE ='" & LSExCode & "' AND CONCODE ='" & LExCont & "'"
                    Cnn.Execute mysql
                End If
            Else
                If MsgBox("Are you Sure to Delete Trades of  " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    If LTradeFileType = "1" Then
                        Call PDelete_CTR_D(LSCondate, vbNullString, LTradeFileType)
                    ElseIf LTradeFileType = "3" Then
                        Call PDelete_CTR_D(LSCondate, LSExCode, LTradeFileType)
                    ElseIf LTradeFileType = "2" Then
                        Call PDelete_CTR_D(LSCondate, LSExCode, LTradeFileType)
                    End If
                End If
            End If
            MCount = Get_Max_ConNo(ltradedt, 0)
            LConNo = MCount
            While Not TxtRec.EOF
                lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                LQTY = 0:                     LRATE = 0
                LSaudaID = 0
                LItemID = 0
                LSettleRate = 0
                If LTradeFileType = "1" Then
                    If IsNull(TxtRec!F10) Then GoTo EFlag_Next
                    If TxtRec!F10 <> "FUT" Then GoTo EFlag_Next
                    LSCondate = DateValue(Left$(TxtRec!F14, 10))
                    LContime = Right$(TxtRec!F14, Len(TxtRec!F14) - 10)
                    LSExCode = TxtRec!F21
                    Call Get_ExDetail(LSExCode)
                    If LenB(LExCont) < 1 Then
                        MsgBox "Please Select Contract A/c"
                        Exit Sub
                    End If
                    If LSExCode = "LME" Or LSExCode = "CME" Or LSExCode = "MCX" Or LSExCode = "NDF" Then
                        LEXHCODE = Trim$(TxtRec!f23)
                    ElseIf LSExCode = "DGCX" Then
                        LEXHCODE = Left$(TxtRec!f23, Len(TxtRec!f23) - 9)
                    ElseIf LSExCode = "shanghai" Then
                        LEXHCODE = Left$(TxtRec!f23, Len(TxtRec!f23) - 4)
                    End If
                    LSTRCONDATE = TxtRec!f22
                    If LSExCode = "shanghai" Then LSTRCONDATE = "20" & TxtRec!f22
                    If Len(LSTRCONDATE) <= 6 Then
                        If Not IsNull(TxtRec!F24) Then
                            If TxtRec!F24 = "31" And Mid$(LSTRCONDATE, 5, 2) = "11" Then
                                LSMaturity = DateValue("30/" & Mid$(LSTRCONDATE, 5, 2) & "/" & Left$(LSTRCONDATE, 4))
                            Else
                                LSMaturity = DateValue(Left$(TxtRec!F24, 2) & "/" & Mid$(LSTRCONDATE, 5, 2) & "/" & Left$(LSTRCONDATE, 4))
                            End If
                        Else
                            LSMaturity = DateValue("28/" & Right$(LSTRCONDATE, 2) & "/" & Left$(LSTRCONDATE, 4))
                        End If
                    Else
                        LSMaturity = DateValue(Right$(LSTRCONDATE, 2) & "/" & Mid$(LSTRCONDATE, 5, 2) & "/" & Left$(LSTRCONDATE, 4))
                    End If
                    LQTY = Val(TxtRec!F13):      LRATE = Val(TxtRec!f12):                    LConType = Left$(TxtRec!F9, 1)
                    If LConType = "1" Then
                        LPtyContype = "B"
                    Else
                        LPtyContype = "S"
                    End If
                    lbparty = TxtRec!f25
                ElseIf LTradeFileType = "3" Then
                    If Not IsNumeric(TxtRec!F2) Then GoTo EFlag_Next
                    LPtyContype = Left$(TxtRec!F1, 1)
                    If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                        LQTY = Val(TxtRec!F2) * Val(TxtQtyMultipler.text)
                    Else
                        LQTY = Val(TxtRec!F2)
                    End If
                    LConNo = LConNo + 1:                    LOConNo = str(LConNo)
                    LRATE = Val(TxtRec!F5):                 LSCondate = DateValue(Left$(TxtRec!f19, 10))
                    LContime = Right$(TxtRec!f19, 8):       lbparty = LParty
                    lyear = Right$(TxtRec!f3, 2):           LMONTH = Left(Right$(TxtRec!f3, 3), 1)
                    LMONTH = Get_CME_Month(LMONTH):         LSMaturity = DateValue("28/" & LMONTH & "/20" & lyear)
                    LEXHCODE = Left$(TxtRec!f3, Len(TxtRec!f3) - 3)
                    If LEXHCODE = "CLT" Then LEXHCODE = "CLE"
                ElseIf LTradeFileType = "2" Then
                    If Not IsNumeric(TxtRec!F2) Then GoTo EFlag_Next
                    LPtyContype = Left$(TxtRec!F1, 1)
                    LQTY = Val(TxtRec!F2)
                    LRATE = Val(TxtRec!F5)
                    LSCondate = DateValue(Left$(TxtRec!f19, 10))
                    LContime = Right$(TxtRec!f19, 8)
                    lbparty = TxtRec!F14
                    LEXHCODE = Left$(TxtRec!f3, Len(TxtRec!f3) - 3)
                    lyear = Right$(TxtRec!f3, 2)
                    LMONTH = Left(Right$(TxtRec!f3, 2), 1)
                    LMONTH = Get_CME_Month(LMONTH)
                    LSMaturity = DateValue("28/" & LMONTH & "/" & lyear)
                ElseIf LTradeFileType = "5" Then
                    If Not IsNumeric(TxtRec!F18) Then GoTo EFlag_Next
                    LPtyContype = Left$(TxtRec!F1, 1)
                    LQTY = Val(TxtRec!F18)
                    LRATE = Val(TxtRec!F20)
                    LSTRCONDATE = Left$(TxtRec!F10, 8)
                    LSCondate = DateValue(Right$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 5, 2) & "/" & Left$(LSTRCONDATE, 4))
                    LContime = Right$(TxtRec!F10, 13)
                    lbparty = TxtRec!F2
                    LSExCode = Left$(TxtRec!f11, 3)
                    If LSExCode = "CME" Then
                        LEXHCODE = Left$(TxtRec!F13, Len(TxtRec!F13) - 6)
                    Else
                        LEXHCODE = TxtRec!F13
                    End If
                    LSTRCONDATE = Left$(TxtRec!F14, 14)
                    LSMaturity = DateValue(LSTRCONDATE)
                ElseIf LTradeFileType = "6" Then
                    If Not IsNumeric(TxtRec!f11) Then GoTo EFlag_Next
                    LOConNo = Trim(TxtRec!F17):                    LConNo = Val(TxtRec!F17)
                    If Not IsNull(TxtRec!F18) Then
                        If TxtRec!F18 = "Carry" Then
                            LOrdNo = "Carry"
                        End If
                    End If
                    LPtyContype = Left$(TxtRec!F10, 1):                    LQTY = Abs(Val(TxtRec!f11))
                    LRATE = Val(TxtRec!f12):                               LSettleRate = Val(TxtRec!F13)
                    LSTRCONDATE = Left$(TxtRec!F1, 10):                    lyear = Right(LSTRCONDATE, 4)
                    A = InStr(LSTRCONDATE, "/"):                           LMONTH = Left(LSTRCONDATE, A - 1)
                    B = InStr(A + 1, LSTRCONDATE, "/")
                    If A = 2 Then
                        If B = 4 Then
                            lday = Mid(LSTRCONDATE, 3, 1)
                        ElseIf B = 5 Then
                            lday = Mid(LSTRCONDATE, 3, 2)
                        End If
                    ElseIf A = 3 Then
                        If B = 5 Then
                            lday = Mid(LSTRCONDATE, 4, 1)
                        ElseIf B = 6 Then
                            lday = Mid(LSTRCONDATE, 4, 2)
                        End If
                    End If
                    LSCondate = DateValue(lday & "/" & LMONTH & "/" & lyear)
                    LContime = Time
                    lbparty = TxtRec!F2
                    LSExCode = TxtRec!F5
                    If LSExCode = "DGC" Then LSExCode = "DGCX"
                    LEXHCODE = TxtRec!f6
                    If LEXHCODE = "DINR_F" Then LEXHCODE = "DINR"
                    If LEXHCODE = "DINRM_F" Then LEXHCODE = "DINRM"
                    LSTRCONDATE = Left(TxtRec!F7, 10)
                    
                    A = InStr(LSTRCONDATE, "/")
                    LMONTH = Left(LSTRCONDATE, A - 1)
                    B = InStr(A + 1, LSTRCONDATE, "/")
                    lyear = Mid(LSTRCONDATE, B + 1, 4)
                    If A = 2 Then
                        If B = 4 Then
                            lday = Mid(LSTRCONDATE, 3, 1)
                        ElseIf B = 5 Then
                            lday = Mid(LSTRCONDATE, 3, 2)
                        End If
                    ElseIf A = 3 Then
                        If B = 5 Then
                            lday = Mid(LSTRCONDATE, 4, 1)
                        ElseIf B = 6 Then
                            lday = Mid(LSTRCONDATE, 4, 2)
                        End If
                    End If
                    LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                ElseIf LTradeFileType = "7" Then
                    If Not IsNumeric(TxtRec!F8) Then GoTo EFlag_Next
                    LConNo = LConNo + 1
                    LOConNo = TxtRec!F1
                    
                    A = InStr(TxtRec!F2, " ")
                    LSTRCONDATE = Left(TxtRec!F2, A - 1)
                    C = Len(LSTRCONDATE)
                    lyear = Right(LSTRCONDATE, 4)
                    A = InStr(LSTRCONDATE, "/")
                    LMONTH = Left(LSTRCONDATE, A - 1)
                    B = InStr(A + 1, LSTRCONDATE, "/")
                    lday = Mid(LSTRCONDATE, A + 1, (B - 1) - A)
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear & ""
                    LSCondate = DateValue(LSTRCONDATE)
                    LContime = Mid(TxtRec!F2, C + 1, Len(TxtRec!F2))
                    lbparty = TxtRec!f3
                    LSExCode = TxtRec!F4
                    Call Get_ExDetail(LSExCode)
                    If LSExCode = "DGCX" Then
                        A = InStr(TxtRec!F5, "-")
                        LEXHCODE = Left(TxtRec!F5, A - 1)
                        LSTRCONDATE = Mid(TxtRec!F5, A + 1, Len(TxtRec!F5))
                        LSMaturity = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 5, 2) & "/" & Left(LSTRCONDATE, 4))
                    Else
                        A = InStr(TxtRec!F5, "_")
                        If A > 0 Then
                            LEXHCODE = Left(TxtRec!F5, A - 1)
                            Else
                            LEXHCODE = TxtRec!F5
                        End If
                        LSMaturity = DateValue("28/" & Right$(TxtRec!f6, 2) & "/" & Left$(TxtRec!f6, 4))
                    End If
                    If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                        LQTY = Val(TxtRec!F8) * Val(TxtQtyMultipler.text)
                    Else
                        LQTY = Val(TxtRec!F8)
                    End If
                    LRATE = TxtRec!F9
                    If LSExCode = "CME" Then
                        If LEXHCODE = "SI" Then LRATE = LRATE / 1000
                        If LEXHCODE = "GC" Then LRATE = LRATE / 10
                        If LEXHCODE = "CL" Then LRATE = LRATE / 100
                        If LEXHCODE = "NG" Then LRATE = LRATE / 1000
                        If LEXHCODE = "HG" Then LRATE = LRATE / 10000
                    End If
                    LPtyContype = Left(TxtRec!F7, 1)
                End If
                If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                LExID = Get_ExID(LSExCode)
                mysql = "SELECT EXID,ITEMID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "' AND EXID  =" & LExID & ""
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSItemCode = TRec!ITEMCODE
                    LLOT = TRec!lot
                    LSExCode = TRec!EXCHANGECODE
                    LItemID = TRec!itemid
                    LExID = TRec!EXID
                Else
                     LSItemCode = Create_TItemMast(LEXHCODE, LEXHCODE, LEXHCODE, 1, LSExCode)
                     LItemID = Get_ITEMID(LSItemCode)
                End If
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                'MYSQL = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE =" & LItemID & ""
                If LSExCode = "DGCX" Then
                '    MYSQL = MYSQL & " AND MATURITY='" & Format(LSMaturity, "yyyy/mm/dd") & "'"
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",'" & Format(LSMaturity, "yyyy/mm/dd") & "',0,0,'FUT'" & ",'',0"
                Else
                '    MYSQL = MYSQL & " AND MONTH(MATURITY)=" & month(LSMaturity) & " AND YEAR(MATURITY)=" & Year(LSMaturity) & "  "
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'FUT'" & ",'',0"
                End If
                
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode
                    LSaudaID = TRec!SAUDAID
                Else
                    If LSInstType = "FUT" Then
                        LSSaudaCode = LSExCode & " " & LEXHCODE & " " & Left$(CStr(LSMaturity), 2) & " " & Left$(MonthName(month(LSMaturity)), 3) & " " & Year(LSMaturity) & ""
                    Else
                        LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LSMaturity & " "
                    End If
                    Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                    LSaudaID = Get_SaudaID(LSSaudaCode)
                End If
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                
                If LTradeFileType = "3" Then
                    mbparty = LParty
                Else
                    mbparty = NewParty(LSExCode, lbparty, lbparty, vbNullString, True)
                End If
                MSPARTY = LExCont
                If LenB(mbparty) < 1 Then GoTo EFlag_Next
                If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, LConNo, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, LTradeFileType, "Y", LExID, LItemID, LSaudaID)
                If LSettleRate <> 0 Then
                    LRATE = SDCLRATE(0, LSCondate, "C")
                    If LRATE = 0 And LSettleRate <> 0 Then Call PInsert_Ctr_R(LSConSno, LSSaudaCode, LSCondate, 0, 0, 0, LSettleRate, 0, LSExCode, LSItemCode, LSaudaID, LItemID, LExID, 0, "")
                End If
                
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Private Sub Save_NCDEX_Trade(MOVERWRITE As Boolean)
    
    Dim LSCondate As Date:      Dim MCount As Long:         Dim LQTY As Double:         Dim LRATE As Double:
    Dim LUserId As String:      Dim LOConNo As String:      Dim LOrdNo As String:       Dim LOrdTime As String:
    Dim LContime As String:     Dim LStrMaturity As String: Dim LPartyName As String:   Dim LPtyContype As String
    Dim mparty As String:       Dim LClient As String:      Dim LEXHCODE As String:     Dim MSPARTY As String
    Dim mbparty As String:      Dim LSConSno As Long:       Dim LConType As String::    Dim TRec As ADODB.Recordset
            
    On Error GoTo err1
    LSExCode = "NCDX"
    If Not TxtRec.EOF Then
        'Call Get_ExDetail(LSExCode)
        If LenB(LExCont) < 1 Then
            If CNNERR = True Then Cnn.RollbackTrans: CNNERR = False
            Exit Sub
        End If
        MSPARTY = LExCont
        FlagDataTrf = True
        Select Case UCase(LBrokerType)
            Case "M"
                LSCondate = DateValue(TxtRec!F21)
            Case "X"
                LSCondate = DateValue(TxtRec!F2)
            Case "9"
                LSCondate = DateValue(TxtRec!F2)
            Case "E"
                LSCondate = DateValue(TxtRec!F2)
            Case Else
                If IsDate(Left(TxtRec!F24, 10)) Then
                    LSCondate = DateValue(Left(TxtRec!F24, 10))
                ElseIf IsDate(Left(TxtRec!f23, 11)) Then
                    LSCondate = DateValue(Left(TxtRec!f23, 11))
                ElseIf IsDate(Left(TxtRec!f22, 10)) Then
                    LSCondate = DateValue(Left(TxtRec!f22, 10))
                Else
                    MsgBox "Pls specifty Condate Field Broker Type " & LBrokerType & ""
                End If
            
        End Select
        LSEXID = Get_ExID(LSExCode)
        If MOVERWRITE = True Then Call PDelete_CTR_D(LSCondate, LSExCode, vbNullString)
        MCount = Get_Max_ConNo(LSCondate, 0)
        TxtRec.MoveFirst
        While Not TxtRec.EOF
            DoEvents
            LQTY = 0:                   LRATE = 0:                  LSStrike = 0:                      LSSaudaID = 0
            LUserId = vbNullString:     LOConNo = vbNullString:     LSItemCode = vbNullString:         LSItemName = vbNullString:
            LSSaudaCode = vbNullString: LOrdNo = vbNullString:      LContime = vbNullString:
            LOrdTime = vbNullString::   LOrdTime = vbNullString:    LClient = vbNullString:             LConType = vbNullString:
            LSInstType = "FUT":         LSOptType = vbNullString:   LPtyContype = "B":                 LSSaudaID = 0
            
            Select Case UCase(LBrokerType)
            
            Case "M"
                LSCondate = DateValue(TxtRec!F21):                LEXHCODE = TxtRec!f3 & vbNullString
                MCount = MCount + 1:                              LOConNo = Trim(TxtRec!F1)
                LSMaturity = DateValue(TxtRec!F5):                LUserId = TxtRec!f11
                LClient = Trim(TxtRec!F17):                       LConType = Left$(TxtRec!F13, 1)
                LQTY = Val(TxtRec!F14):                           LRATE = Val(TxtRec!F15)
                LContime = Right$(TxtRec!F21, 8):                 LOrdNo = TxtRec!f22
                LOrdTime = Trim(TxtRec!F20):                      LSInstType = Left$(TxtRec!F4, 3)
                LSStrike = Val(TxtRec!f6):                        If TxtRec!F7 <> "XX" Then LSOptType = TxtRec!F7
            Case "C"
                LSCondate = TxtRec!f22:                           LEXHCODE = TxtRec!F4 & vbNullString
                MCount = MCount + 1:                              LOConNo = Trim(TxtRec!F1)
                LUserId = Trim$(TxtRec!f12):                      LClient = Trim(TxtRec!F18)
                LConType = Left$(TxtRec!F14, 1):                  LQTY = Val(TxtRec!F15)
                LRATE = Val(TxtRec!f16):                          LSMaturity = DateValue(Mid(TxtRec!F5, 1, 2) & " " & Mid(TxtRec!F5, 3, 3) & " " & Right$(TxtRec!F5, 4))
                If Right$(TxtRec!F21, 8) = "UNCOVER" Then
                    LContime = Right$(TxtRec!f22, 8)
                Else
                    LContime = Right$(TxtRec!F21, 8)
                End If
                If Check8.Value = 1 Then mparty = (TxtRec!F30 & vbNullString)
                
                LClient = mparty
            Case "X"
                LSCondate = DateValue(TxtRec!F2):                LEXHCODE = TxtRec!f6
                MCount = MCount + 1:                             LOConNo = Trim(TxtRec!F1)
:               LSMaturity = DateValue(Mid(TxtRec!F7, 1, 2) & " " & Mid(TxtRec!F7, 4, 3) & " " & Right$(TxtRec!F7, 4))
                LQTY = Val(TxtRec!F15):                         LRATE = Val(TxtRec!F13)
                LContime = Right$(TxtRec!F14, 8):                LSInstType = Left$(TxtRec!F5, 3)
                If LSInstType = "OPT" Then
                    LSOptType = Left$(TxtRec!F9, 2)
                    LSStrike = Val(TxtRec!F8) / 100
                End If
                If Not IsNull(TxtRec!F31) Then
                    LClient = Trim(TxtRec!F31):                    LUserId = TxtRec!F18:                    LConType = "1"
                Else
                    LClient = Trim(TxtRec!F32):                    LUserId = TxtRec!f19:                    LConType = "2"
                End If
            Case "E"
                LSCondate = Format(TxtRec!F2, "yyyy/MM/dd"):                    LEXHCODE = TxtRec!F5
                LOConNo = Trim(Right$(TxtRec!F1, 7)):                           LContime = Right$(TxtRec!F4, 5)
                LOrdNo = Trim(TxtRec!f3):                                       LStrMaturity = DateValue(TxtRec!F7)
                LUserId = TxtRec!f12:                                           LRATE = Val(TxtRec!f11)
                LQTY = Val(TxtRec!F9):
                If TxtRec!F8 = "BUY" Then
                    LConType = "1"
                Else
                    LConType = "2"
                End If
            Case "X2"
                LSCondate = DateValue(TxtRec!F14):                                 LEXHCODE = TxtRec!f6
                LOConNo = Trim(Right$(TxtRec!F1, 7)):                              LContime = Right$(TxtRec!F14, 8)
                LSInstType = Left$(TxtRec!F5, 3)
                If LSInstType = "OPT" Then
                    LSOptType = Left$(TxtRec!F8, 2):                    LSStrike = Val(TxtRec!F7) / 100
                End If
                If Not IsNull(TxtRec!F18) Then
                    LOrdNo = Trim(TxtRec!F33):               mparty = Trim(TxtRec!F35)
                    LPartyName = Trim(TxtRec!F35):           LConType = "1"
                    LUserId = TxtRec!F44:
                Else
                    LOrdNo = Trim(TxtRec!F34):               mparty = Trim(TxtRec!F36)
                    LPartyName = Trim(TxtRec!F36):           LConType = "2"
                    LUserId = TxtRec!F45:
                End If
                LStrMaturity = DateValue(TxtRec!F7):                              LRATE = Val(TxtRec!F13)
                LQTY = Val(TxtRec!F15):                                           LClient = mparty
            Case "O"
                If IsDate(Left(TxtRec!F24, 10)) Then
                    LSCondate = DateValue(Left(TxtRec!F24, 10))
                ElseIf IsDate(Left(TxtRec!f23, 10)) Then
                    LSCondate = DateValue(Left(TxtRec!f23, 10))
                ElseIf IsDate(Left(TxtRec!f22, 10)) Then
                    LSCondate = DateValue(Left(TxtRec!f22, 10))
                Else
                    MsgBox "Pls specifty Condate Field Broker Type " & LBrokerType & ""
                End If
                LEXHCODE = TxtRec!F5
                LOConNo = Trim(Right$(TxtRec!F1, 7)):                              LContime = Right$(TxtRec!F24, 5)
                LOrdNo = Trim(TxtRec!F26):                                         LStrMaturity = TxtRec!f6
                LUserId = TxtRec!F13:                                              LConType = Left$(TxtRec!F15, 1)
                LRATE = Val(TxtRec!F17):                                           LQTY = Val(TxtRec!f16)
                mparty = Trim(TxtRec!f19):                                         LPartyName = Trim(TxtRec!f19)
                LClient = mparty
                LSInstType = Left$(TxtRec!f3, 3)
                If LSInstType = "OPT" Then
                    LSOptType = Left$(TxtRec!F7, 2):                    LSStrike = Val(TxtRec!f6)
                End If
            Case "C"
'                LSCondate = Format(TxtRec!F22, "yyyy/MM/dd"):                      ITExchangeCode = TxtRec!F4
'                If Left$(TxtRec!f1, 3) = "201" Then
'                    LOConNo = Trim$(Mid$(TxtRec!f1, 9, Len(TxtRec!f1))):
'                Else
'                    LOConNo = Trim(TxtRec!f1):
'                End If
'                    'LOConNo = Trim(RIGHT$(TxtRec!F1, 7)):
'                LContime = Right$(TxtRec!F22, 8)
'                LOrdNo = Trim(TxtRec!F24):                                         LStrMaturity = TxtRec!f5
'                LUserId = TxtRec!f12:                                              LConType = Left$(TxtRec!F14, 1)
'                LRate = Val(TxtRec!F16):                                           LQty = Val(TxtRec!F15)
'                MParty = Trim(TxtRec!F18):                                         LPartyName = Trim(TxtRec!F18)
'                LClient = MParty
'                LSInstType = Left$(TxtRec!F3, 3)
'                If LSInstType = "OPT" Then
'                    LOptType = Left$(TxtRec!f7, 2)
'                    LStrike = Val(TxtRec!f6)
'                End If
            Case Else
                LSCondate = TxtRec!f22:                         LEXHCODE = TxtRec!F4 & vbNullString
                'MCount = MCount + 1
                LOConNo = Right(Trim(TxtRec!F1), 20):

                LStrMaturity = TxtRec!F5:                       LUserId = TxtRec!f12
                LSMaturity = DateValue(Left$(LStrMaturity, 2) & "/" & Mid(LStrMaturity, 3, 3) & "/" & Right$(LStrMaturity, 4))
                LClient = Trim(TxtRec!F18):                     LConType = TxtRec!F14
                LQTY = Val(TxtRec!F15):                         LRATE = Val(TxtRec!f16)
                mparty = Trim(TxtRec!F18)
                LSInstType = Left(TxtRec!f3, 3)
                If LSInstType = "OPT" Then
                    LSOptType = TxtRec!F7
                    LSStrike = Val(TxtRec!f6)
                End If
                If Right$(TxtRec!F21, 8) = "UNCOVER" Then
                    LContime = Right$(TxtRec!f22, 8)
                Else
                    LContime = Right$(TxtRec!F21, 8)
                End If
                If Check8.Value = 1 Then mparty = (TxtRec!F26 & vbNullString)
                If LenB(mparty) < 1 Then
                    mparty = LUserId
                End If
                'LOrdNo = Trim(TxtRec!F1)
                'If Len(LOrdNo) >= 20 Then
                '    LOrdNo = Right(LOrdNo, 20)
                'End If
                LClient = mparty
                'MCount = Get_Max_ConNo(LSCondate, 0)
                'LOConNo = MCount
            End Select
            
            LLOT = 1
            Call Get_Item_Details(LEXHCODE, LSExCode, LEXHCODE, LSExCode, 1, True, True, 1)
            If LenB(LSItemCode) = 0 Then GoTo EFlag_Next
            Call Get_Sauda_Details(LEXHCODE, True, True, LSCondate, 1)
            If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
            If LPartyAs = "C" Then
                mparty = LClient
                LPartyName = LClient
            Else
                mparty = LUserId
                LPartyName = LUserId
            End If
            
            LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
            If LConType = "2" Then LPtyContype = "S"
            mbparty = NewParty(LSExCode, mparty, mparty, LUserId, True)
            If LPartyAs = "F" Then mbparty = LClientCode
            If LenB(mbparty) < 1 Then GoTo EFlag_Next
            If MOVERWRITE = False Then If Chk_Trade(LSSaudaCode, LOConNo, LSCondate, MSPARTY, LPtyContype) = True Then GoTo EFlag_Next
            MCount = MCount + 1
            If LBrokerType = "A" Then
                MSPARTY = LClient
                MSPARTY = NewParty(LSExCode, MSPARTY, MSPARTY, LUserId, True)
            End If
            If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
            
            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
            If InStr(LBillExId, str(LSEXID)) = 0 Then
                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
            GETMAIN.Label1.Caption = "Trade No " & MCount & ""
            DoEvents
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
            LNoTrd = LNoTrd + 1
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
            DoEvents
            Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, "0", "Y", LSEXID, LSItemid, LSSaudaID)

EFlag_Next:
            TxtRec.MoveNext
        Wend
    End If
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub


Private Function Get_CME_Month(LSMonth As String) As String
    Select Case LSMonth
        Case "F"
            Get_CME_Month = "JAN"
        Case "G"
            Get_CME_Month = "FEB"
        Case "H"
            Get_CME_Month = "MAR"
        Case "J"
            Get_CME_Month = "APR"
        Case "K"
            Get_CME_Month = "MAY"
        Case "M"
            Get_CME_Month = "JUN"
        Case "N"
            Get_CME_Month = "JUL"
        Case "Q"
            Get_CME_Month = "AUG"
        Case "U"
            Get_CME_Month = "SEP"
        Case "V"
            Get_CME_Month = "OCT"
        Case "X"
            Get_CME_Month = "NOV"
        Case "Z"
            Get_CME_Month = "DEC"
        End Select
End Function
Private Sub TxtQtyMultipler_KeyPress(KeyAscii As Integer)
    KeyAscii = NUMBERChk(KeyAscii)
End Sub
Private Sub TxtQtyMultipler_Validate(Cancel As Boolean)
    TxtQtyMultipler.text = Format(TxtQtyMultipler.text, "0.00")
End Sub

Private Sub TxtQtyMultipler_GotFocus()
    TxtQtyMultipler.SelStart = 0
    TxtQtyMultipler.SelLength = Len(TxtQtyMultipler.text)
End Sub
Private Sub Save_Open_Position()
    On Error GoTo err1
    Dim ltradedt As Date:           Dim TxtPath As String:          Dim LFileName As String:    Dim LFileSource As String:  Dim lbparty As String
    Dim lsparty As String:          Dim MCount As Long:             Dim LSItemCode As String:   Dim LConType As String:     Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LSInstType As String:   Dim LOptType As String:     Dim LStrike As Double
    Dim LOrdNo As String:           Dim LOrdTime As String:         Dim LSCondate As Date:      Dim LSSaudaCode As String:  Dim LCITEM As String
    Dim LSSauda As String::         Dim LSMaturity As Date:         Dim LOConNo As String:      Dim LLOT As Double:         Dim ITExchangeCode As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LUserId As String:      Dim LEXHCODE As String:     Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LContime As String:         Dim LRATE As Double:        Dim lyear As String:        Dim LMONTH As String
    Dim LSettleRate As Double:      Dim LSaudaID As Long:        Dim A As Integer:           Dim B As Integer:           Dim lday As String
    Dim LStd As String:             Dim LConNo As Long:             Dim mparty As String:       Dim LItemID As Integer: Dim LExID As Integer
    
    LStd = "N"
    Set TxtRec = Nothing:
    Set TxtRec = New ADODB.Recordset
    
    Cnn.BeginTrans
    CNNERR = True
    LSExCode = "CME"
    Call Get_ExDetail(LSExCode)
    
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        Else
            MsgBox "Please Select Valid File"
            Cnn.RollbackTrans
            Exit Sub
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        If Not FileExist(LFileName) Then
            MsgBox " No File Selected "
            Exit Sub
        Else
            Set Jcnn = Nothing
            Set Jcnn = New ADODB.Connection
            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
            "Data Source=" & LFileSource & _
            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
       
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = ltradedt
            While Not TxtRec.EOF
                LSaudaID = 0
                If TxtRec!F2 <> LMemberId Then GoTo EFlag_Next
                LEXHCODE = vbNullString
                LUserId = vbNullString:                   LSInstType = "FUT"
                LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                LSettleRate = 0
                If Not IsNumeric(TxtRec!F15) Then GoTo EFlag_Next
                LSettleRate = Val(TxtRec!F15)
                LSExCode = TxtRec!f3
                'If LSExCode = "CMX" Then LSExCode = "CME"
                If LSExCode = "DGC" Then LSExCode = "DGCX"
                LEXHCODE = TxtRec!F4
                If LEXHCODE = "DINR_F" Then
                    LEXHCODE = "DINR"
                ElseIf LEXHCODE = "DINRM_F" Then
                    LEXHCODE = "DINRM"
                End If
                LSTRCONDATE = TxtRec!F5
                LSMaturity = DateValue(LSTRCONDATE)
                If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                mysql = "SELECT ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "' AND EXCHANGECODE  ='" & LSExCode & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSItemCode = TRec!ITEMCODE
                    LLOT = TRec!lot
                    LSExCode = TRec!EXCHANGECODE
                Else
                    LMsgBox = " Create New Commodity/Script " & LEXHCODE & ""
                    ImportIssues (LMsgBox)
                    GoTo EFlag_Next
                End If
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                LItemID = Get_ITEMID(LSItemCode)
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                'MYSQL = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE ='" & LSItemCode & "'"
                'MYSQL = MYSQL & " AND MATURITY='" & Format(LSMaturity, "yyyy/mm/dd") & "'"
                mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",'" & Format(LSMaturity, "yyyy/mm/dd") & "',0,0,'FUT'" & ",'',0"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode
                    LSaudaID = TRec!SAUDAID
                Else
                    'If LSInstType = "FUT" Then
                    '    LSSaudaCode = LSExCode & " " & LExhCode & " " & Left(LSMaturity, 2) & " " & Left$(MonthName(month(LSMaturity)), 3) & " " & Year(LSMaturity) & ""
                    'Else
                    '    LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LSMaturity & " "
                    'End If
                    LMsgBox = " Create New Contract " & LSSaudaCode & ""
                    ImportIssues (LMsgBox)
                    GoTo EFlag_Next
                    
                End If
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                mysql = "DELETE FROM CTR_R WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND SAUDA ='" & LSSaudaCode & "'"
                Cnn.Execute mysql
                Call PInsert_Ctr_R(LSConSno, LSSaudaCode, LSCondate, 0, 0, 0, LSettleRate, 0, LSExCode, LSItemCode, LSaudaID, LItemID, LExID, 0, "")
                
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
'Private Sub Save_Ledger_Entry()
'    On Error GoTo ERR1
'    Dim LTradeDt As Date:           Dim TxtPath As String:          Dim LFileName As String
'    Dim LFileSource As String:      Dim LPtyDrCr As String:         Dim LConDrCr As String
'    Dim LPtyNarr As String:         Dim LConNarr As String:         Dim VchNo As String
'    Dim LSCondate As Date::         Dim LUserId As String:          Dim LStrConDate  As String
'    Dim LYEAR As String:            Dim LMonth As String:           Dim LSettleRate As Double
'    Dim LAmount As Double:          Dim MBParty As String:          Dim MSParty As String
'    Dim LIMargin As Double:         Dim LMVNo As Long:              Dim LMaxDt As Date
'    Dim LEXID As Integer
'
'    Dim TRec As ADODB.Recordset:
'    Set TxtRec = Nothing:
'    Set TxtRec = New ADODB.Recordset
'
'    Cnn.BeginTrans
'    CNNERR = True
'    LSExCode = "CME"
'    Call Get_ExDetail(LSExCode)
'
'    For LTradeDt = vcDTP1.Value To vcDTP2.Value
'        CommonDialog1.InitDir = App.Path
'        CommonDialog1.ShowOpen
'        If CommonDialog1.FileName <> "" Then
'            Text1.text = CommonDialog1.FileName
'        Else
'            MsgBox "Please Select Valid File"
'            Cnn.RollbackTrans
'            Exit Sub
'        End If
'        TxtPath = CommonDialog1.FileTitle
'        LFileName = CommonDialog1.FileName
'        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
'        If Not FileExist(LFileName) Then
'            MsgBox " No File Selected "
'            Exit Sub
'        Else
'            Set Jcnn = Nothing
'            Set Jcnn = New ADODB.Connection
'            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
'            "Data Source=" & LFileSource & _
'            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
'            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
'            TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
'        End If
'
'        If Not TxtRec.EOF Then
'            FlagDataTrf = True
'            CNNERR = True
'            TxtRec.MoveFirst
'            LSCondate = LTradeDt
'            MYSQL = "DELETE FROM VOUCHER WHERE COMPCODE =" & GCompCode & " AND VOU_TYPE='JV' AND VOU_DT ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND NARRATION ='Import'"
'            Cnn.Execute MYSQL
'
'            MYSQL = "DELETE FROM DLYCLMGN WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND EXCODE ='CME'"
'            Cnn.Execute MYSQL
'            LEXID = Get_ExID(LSExCode)
'
'            While Not TxtRec.EOF
'                MBParty = vbNullString
'                LAmount = 0
'                LIMargin = 0
'
'                If Not IsNumeric(TxtRec!F2) Then GoTo EFlag_Next
'                LUserId = TxtRec!f1
'                LAmount = Val(TxtRec!F3)
'                LIMargin = Val(TxtRec!F15)
'                MBParty = NewParty(LSExCode, LUserId, LUserId, vbNullString, True)
'                If LAmount <> 0 Then
'
'                    MSParty = LExCont
'                    If LenB(MBParty) < 1 Then GoTo EFlag_Next
'                    If LenB(MSParty) < 1 Then GoTo EFlag_Next
'                    If LAmount > 0 Then
'                        LPtyDrCr = "C"
'                        LConDrCr = "D"
'                        LPtyNarr = "Amount Deposited "
'                        LConNarr = " Amount Recd From " & LUserId & ""
'                        LAmount = Abs(LAmount)
'                    Else
'                        LPtyDrCr = "D"
'                        LConDrCr = "C"
'                        LAmount = Abs(LAmount)
'                        LPtyNarr = "Amount Withdrawn "
'                        LConNarr = " Amount Paid to " & LUserId & ""
'                    End If
'                    VchNo = Get_VouNo("JRNL", GFinYear)
'                    LMVNo = PInsert_Voucher(VchNo, DateValue(LSCondate), "JV", "P", 0, "ADD", LSExCode, 0, "Import", LSExCode, "0", LEXID, 0)
'                    Call PInsert_Vchamt(VchNo, "JV", LSCondate, LPtyDrCr, MBParty, Abs(LAmount), vbNullString, vbNullString, LPtyNarr, vbNullString, LSExCode, 0, LSExCode, LMVNo, LEXID, 0)
'                    Call PInsert_Vchamt(VchNo, "JV", LSCondate, LConDrCr, MSParty, Abs(LAmount), vbNullString, vbNullString, LConNarr, vbNullString, LSExCode, 0, LSExCode, LMVNo, LEXID, 0)
'                End If
'                If LIMargin <> 0 Then
'                    MYSQL = "INSERT INTO DLYCLMGN (COMPCODE,EXCODE,CONDATE,CLIENT,IMARGIN)"
'                    MYSQL = MYSQL & " VALUES (" & GCompCode & ",'CME','" & Format(LSCondate, "YYYY/MM/DD") & "','" & MBParty & "'," & LIMargin & ")"
'                    Cnn.Execute MYSQL
'                End If
'
'EFlag_Next:
'                TxtRec.MoveNext
'            Wend
'        End If
'    Next
'    Cnn.CommitTrans
'    CNNERR = False
'    Exit Sub
'ERR1:
'
'    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
'    If CNNERR = True Then
'
'        Cnn.RollbackTrans: CNNERR = False
'    End If
'End Sub
Sub Save_Vertex_history()
    'date 20/07/2004
    Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOptType As String:         Dim LStrike As Double:          Dim LContime As String:         Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LSCondate As Date:          Dim LSMaturity As Date
    Dim ITExchangeCode As String:   Dim LOConNo As String:          Dim LSTRDATE As String:         Dim LClient As String
    Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:          Dim TRec As ADODB.Recordset
    Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String:       Dim LSExCode As String
    Dim LFileSource As String:      Dim LEXHCODE  As String:        Dim lyear As String:            Dim LMONTH As String
    Dim LSaudaID As Long:        Dim A As Integer
    Dim LItemID As Integer
    Dim LExID As Integer
    LOverwrite = True
    On Error GoTo err1
    'Call GET_JCnn("\SAP;")
    LSExCode = "CMX"
    Call Get_ExDetail(LSExCode)
    
    If LenB(LBrokerCode) > 1 Then
        LExCont = LBrokerCode
        MSPARTY = LExCont
    Else
        MsgBox " Please Select Broker "
        Exit Sub
    End If
    If LenB(LClientCode) < 1 Then
        MsgBox " Please Select Client"
        Exit Sub
    End If
    Cnn.BeginTrans
    CNNERR = True:
                        
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        'TxtPath = "P013_" & LEFT$(CStr(LTradedt), 2) & Mid$(CStr(LTradedt), 4, 2) & Right$(CStr(Year(LTradedt)), 4) & ".CSV"
        
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & " "
            TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            TxtRec.MoveFirst
            CNNERR = True
            MCount = Get_Max_ConNo(ltradedt, 0)
            'DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode  & " AND CONDATE='" & Format(LTradedt, "yyyy/MM/dd") & "' AND DATAIMPORT =1 AND EXCODE IN ('LME','SHA')"
            TxtRec.MoveFirst
            While Not TxtRec.EOF
                LPtyContype = "B": LOrdTime = vbNullString: LOptType = vbNullString: LStrike = 0: LSInstType = "FUT"
                LSaudaID = 0
                If TxtRec!F4 <> "Close" Then GoTo EFlag_Next
                    LOConNo = TxtRec!F1
                    LSCondate = DateValue(Left$(TxtRec!F9, 10))
                    LContime = Right(TxtRec!F2, Len(TxtRec!F9) - 10)
                    
                    A = InStr(TxtRec!f6, "/")
                    LEXHCODE = Left(TxtRec!F5, A - 2)
                    LPtyContype = Left$(Trim$(TxtRec!F8), 1)
                    lyear = Year(LSCondate)
                    LMONTH = Right(TxtRec!F5, 2)
                    If Val(LMONTH) >= Val(month(LSCondate)) Then
                        LSMaturity = DateValue("28" & "/" & LMONTH & "/" & Year(LSCondate))
                    Else
                        LSMaturity = DateValue("28" & "/" & LMONTH & "/" & CStr(Val(Year(LSCondate)) + 1))
                    End If
                    Select Case LEXHCODE
                        Case "DG INR"
                            LEXHCODE = "DINR"
                        Case "GOLD"
                            LEXHCODE = "GCE"
                        Case "SILVER"
                            LEXHCODE = "SIE"
                    End Select
                    mysql = "SELECT EXID,ITEMID,ITEMCODE,LOT,EXCHANGECODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSItemCode = TRec!ITEMCODE
                        LLOT = TRec!lot
                        LSExCode = TRec!EXCHANGECODE
                        LItemID = TRec!itemid
                        LExID = TRec!EXID
                    Else
                        LMsgBox = "Please Create new Item " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE=" & GCompCode & " AND ITEMCODE ='" & LSItemCode & "' "
                    mysql = mysql & " AND MONTH(MATURITY) ='" & month(LSMaturity) & "'AND YEAR (MATURITY) ='" & Year(LSMaturity) & "' AND INSTTYPE ='" & LSInstType & "'"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode
                    Else
                        LSSaudaCode = Create_TSaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, vbNullString, 0)
                    End If
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    LSaudaID = Get_SaudaID(LSSaudaCode)
                    mbparty = LClientCode:
                    LClient = mbparty:
                    LUserId = mbparty
                    LRATE = Val(TxtRec!f6)
                    If LSExCode = "CME" Then
                        LRATE = LRATE * 10
                    End If
                    LQTY = Val(TxtRec!F4)
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND EXCODE ='" & LSExCode & "'"
                    Cnn.Execute mysql
                    MCount = MCount + 1
                    If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                    Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, "", LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "VH", "Y", LExID, LItemID, LSaudaID)
                
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
flag210:
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Save_Vertex_history2()
    'date 20/07/2004
    Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOptType As String:         Dim LStrike As Double:          Dim LContime As String:         Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LSCondate As Date:          Dim LSMaturity As Date
    Dim ITExchangeCode As String:   Dim LOConNo As String:          Dim LSTRDATE As String:         Dim LClient As String
    Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:          Dim TRec As ADODB.Recordset
    Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String:       Dim LSExCode As String
    Dim LFileSource As String:      Dim LEXHCODE  As String:        Dim lyear As String:            Dim LMONTH As String
    Dim LSTRCONDATE As String:     Dim A As Integer:                Dim LSaudaID As Long
    Dim LItemID As Integer
    Dim LExID As Integer
    
    LOverwrite = True
    On Error GoTo err1
    'Call GET_JCnn("\SAP;")
    LSExCode = "CME"
    Call Get_ExDetail(LSExCode)
    
    If LenB(LBrokerCode) > 1 Then
        LExCont = LBrokerCode
        MSPARTY = LExCont
    Else
        MsgBox " Please Select Broker "
        Exit Sub
    End If
    If LenB(LClientCode) < 1 Then
        MsgBox " Please Select Client"
        Exit Sub
    End If
    Cnn.BeginTrans
    CNNERR = True:
                        
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & " "
            TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            TxtRec.MoveFirst
            CNNERR = True
            MCount = Get_Max_ConNo(ltradedt, 0)
            TxtRec.MoveFirst
            While Not TxtRec.EOF
                LPtyContype = "B": LOrdTime = vbNullString: LOptType = vbNullString: LStrike = 0: LSInstType = "FUT"
                LSaudaID = 0
                If IsNull(TxtRec!F4) Then GoTo EFlag_Next
                'If TxtRec!f4 <> "Close" Then GoTo EFlag_Next
                If (TxtRec!F4 <> "L" Or TxtRec!F2 <> "SL/TP") Then GoTo EFlag_Next
                
                    LOConNo = TxtRec!F5
                    LSTRCONDATE = Left$(TxtRec!F9, 10)
                    
                    LSCondate = DateValue(Right$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 2) & "/20" & Left(LSTRCONDATE, 2))
                    LContime = Right(TxtRec!F9, Len(TxtRec!F9) - 10)
                    
                    A = InStr(TxtRec!f6, "/")
                    LEXHCODE = Left(TxtRec!f6, A - 2)
                    LPtyContype = Left$(Trim$(TxtRec!F8), 1)
                    lyear = Year(LSCondate)
                    LMONTH = Right(TxtRec!f6, 2)
                    If Val(LMONTH) >= Val(month(LSCondate)) Then
                        LSMaturity = DateValue("28" & "/" & LMONTH & "/" & Year(LSCondate))
                    Else
                        LSMaturity = DateValue("28" & "/" & LMONTH & "/" & CStr(Val(Year(LSCondate)) + 1))
                    End If
                    If LEXHCODE = "DG INR" Then
                        LEXHCODE = "DINR"
                    End If
                    mysql = "SELECT EXID,ITEMID,ITEMCODE,LOT,EXCHANGECODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSItemCode = TRec!ITEMCODE
                        LLOT = TRec!lot
                        LSExCode = TRec!EXCHANGECODE
                        LItemID = TRec!itemid
                        LExID = TRec!EXID
                    Else
                        LMsgBox = "Please Create new Item " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE=" & GCompCode & " AND ITEMCODE ='" & LSItemCode & "' "
                    mysql = mysql & " AND MONTH(MATURITY) ='" & month(LSMaturity) & "'AND YEAR (MATURITY) ='" & Year(LSMaturity) & "' AND INSTTYPE ='" & LSInstType & "'"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode
                    Else
                        LSSaudaCode = Create_TSaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, vbNullString, 0)
                    End If
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    LSaudaID = Get_SaudaID(LSSaudaCode)
                    mbparty = LClientCode:
                    LClient = mbparty:
                    LUserId = mbparty
                    LRATE = Val(TxtRec!F10)
                    'If LSExCode = "CME" Then
                    '    LRate = LRate * 10
                    'End If
                    LQTY = Val(TxtRec!F7)
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS "
                    mysql = mysql & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND EXCODE ='" & LSExCode & "'AND FILETYPE ='VH'"
                    Cnn.Execute mysql
                    MCount = MCount + 1
                    If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                    Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, "", LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "VH", "Y", LExID, LItemID, LSaudaID)
                    If LPtyContype = "B" Then
                        LPtyContype = "S"
                    Else
                        LPtyContype = "B"
                    End If
                    LOConNo = LOConNo & "A"
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS"
                    mysql = mysql & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND EXCODE ='" & LSExCode & "' AND FILETYPE ='VH'"
                    Cnn.Execute mysql
                    LRATE = Val(TxtRec!f11)
                    LSTRCONDATE = Left$(TxtRec!F9, 10)
                    
                    LSCondate = DateValue(Right$(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 2) & "/20" & Left(LSTRCONDATE, 2))
                    LContime = Right(TxtRec!F1, Len(TxtRec!F1) - 10)
                    MCount = MCount + 1
                    Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, "", LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "VH", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
flag210:
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Private Sub CANCEL_CMD()
Call UnLock_Screen
End Sub

Sub SAVE_DGCX_USDINR_TRADE()
    Dim TxtPath As String:          Dim LFileName As String:        Dim LConType As String
    Dim LPtyContype As String:      Dim ITExchangeCode As String:   Dim LSInstType As String:       Dim LOptType As String:
    Dim LStrike As Double:          Dim LQTY As Double:             Dim LRATE As Double:            Dim LSCondate As Date
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LCITEM As String:           Dim LSSaudaCode As String
    Dim LSSauda As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
    Dim LContime As String:         Dim LLOT As Double:             Dim LUserId As String:          Dim LSMaturity As Date
    Dim LPartyName As String:       Dim LOConNo As String:          Dim LSItemName As String:       Dim LSConSno As Long
    Dim LEXHCODE As String:         Dim TRec As ADODB.Recordset:    Dim LClient As String:          Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LPty As String:             Dim LOverwrite As Boolean:      Dim LSTRCONDATE As String:
    Dim ltradedt As Date:           Dim LFolder As String:          Dim LParty As String:           Dim LFileSource As String
    Dim lday As String:             Dim LMONTH As String:           Dim lyear As String:            Dim A As Integer
    Dim B As Integer:               Dim LSaudaID As Long:        Dim LExID As Integer:           Dim LItemID As Integer
    
    LOverwrite = True
    LSExCode = "DGCX"
    On Error GoTo err1
    Call GET_JCnn("\DGCX;")
    Call Get_ExDetail(LSExCode)
    LTradeFileType = "4"
        If LenB(BrokerCombo.BoundText) > 1 Then
            LExCont = BrokerCombo.BoundText
        Else
            MsgBox " Please Select Broker Account"
            Exit Sub
        End If
        If LenB(ClientCombo.BoundText) > 1 Then
            LParty = ClientCombo.BoundText
        Else
            MsgBox " Please Select Client Account"
            Exit Sub
        End If
    'End If
    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
            LFileName = Text1.text
        Else
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFolder = Left$(LFileName, (Len(LFileName) - Len(TxtPath) - 1)) & ""
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        Else
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath))) & ";"
            Set Jcnn = Nothing
            Set Jcnn = New ADODB.Connection
            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
            "Data Source=" & LFileSource & _
            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True:
            TxtRec.MoveFirst:
            TxtRec.Filter = "f13='FUT'"
            If Not TxtRec.EOF Then
                A = InStr(TxtRec!F26, "/")
                LMONTH = Left(TxtRec!F26, A - 1)
                B = InStr(A + 1, TxtRec!F26, "/")
                lday = Mid(TxtRec!F26, A + 1, ((B - A) - 1))
                lyear = Mid(TxtRec!F26, B + 1, 4)
                LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                LSCondate = DateValue(lday & "/" & LMONTH & "/" & lyear)
            Else
                LSCondate = ltradedt
            End If
            CNNERR = True
            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' "
            mysql = mysql & " AND FILETYPE='" & LTradeFileType & "'AND CONCODE ='" & LExCont & "'"
            Cnn.Execute mysql
            MCount = Get_Max_ConNo(LSCondate, 0)
            TxtRec.MoveFirst
            While Not TxtRec.EOF
                LContime = vbNullString:    ITExchangeCode = vbNullString:   LOConNo = vbNullString
                LQTY = 0:                   LRATE = 0:                      LOrdNo = vbNullString
                LSInstType = "FUT":         LOptType = vbNullString:        LStrike = 0
                    MCount = MCount + 1
                    A = InStr(TxtRec!F26, "/")
                    LMONTH = Left(TxtRec!F26, A - 1)
                    B = InStr(A + 1, TxtRec!F26, "/")
                    lday = Mid(TxtRec!F26, A + 1, ((B - A) - 1))
                    lyear = Mid(TxtRec!F26, B + 1, 4)
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    LSCondate = DateValue(lday & "/" & LMONTH & "/" & lyear)
                    LContime = Mid$(TxtRec!F26, 11, Len(TxtRec!F26))
                    LSExCode = TxtRec!F2
                    If LSExCode = "BSECD" Then LSExCode = "FX"
                    'Call Get_ExDetail(LSExCode)
                    If LSExCode = "FX" Then
                        ITExchangeCode = TxtRec!F9
                    Else
                        ITExchangeCode = Left$(Trim$(TxtRec!F9), Len(TxtRec!F9) - 9)
                    End If
                    LSTRCONDATE = Left$(TxtRec!F10, 10)
                    
                    A = InStr(LSTRCONDATE, "/")
                    LMONTH = Left(LSTRCONDATE, A - 1)
                    B = InStr(A + 1, LSTRCONDATE, "/")
                    lday = Mid(LSTRCONDATE, A + 1, ((B - A) - 1))
                    lyear = Mid(LSTRCONDATE, B + 1, 4)
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                    LConType = Left$(TxtRec!f16, 1)
                    LPtyContype = Left$(TxtRec!f16, 1)
                    LRATE = Val(TxtRec!F18)
                    If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                        LQTY = Val(TxtRec!F21) * Val(TxtQtyMultipler.text)
                    Else
                        LQTY = Val(TxtRec!F21)
                    End If
                    LLOT = 1
                    LUserId = TxtRec!F30
                    mparty = LParty
                    LEXHCODE = ITExchangeCode
                    LSItemCode = LEXHCODE
                    LSItemName = LEXHCODE
                    MSPARTY = LExCont
                DoEvents
                LExID = Get_ExID(LSExCode)
                LCITEM = Create_CItemMast(LSItemCode, LSItemName, LEXHCODE, LLOT, LSExCode)
                LSItemCode = Create_ItemMast(LSItemCode, LSItemName, LEXHCODE, LLOT, LSExCode, LExID)
                DoEvents
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                LItemID = Get_ITEMID(LSItemCode)
                LSSauda = Create_SSaudaMast(LEXHCODE, LSMaturity, LSExCode, LSInstType, LOptType, LStrike, LSItemCode)
                LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LOptType, LStrike, LExID, LItemID)
                LSaudaID = Get_SaudaID(LSSaudaCode)
                LLOT = Get_LotSize(LItemID, LSaudaID, LExID)
                MSPARTY = LExCont
                mbparty = LParty
                If LenB(mbparty) < 1 Then mbparty = NewParty(LSExCode, mparty, mparty, mparty, True)
                If LenB(mbparty) < 1 Then
                    LMsgBox = "Create  Account For  " & mparty & ""
                    ImportIssues (LMsgBox)
                    GoTo EFlag_Next
                End If
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                LClient = mbparty
                Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, LTradeFileType, "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
flag210:
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
      
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Sub SAVE_SGX_TRADE()
    Dim TxtPath As String:          Dim LFileName As String:        Dim LConType As String
    Dim LPtyContype As String:      Dim ITExchangeCode As String:   Dim LSInstType As String:    Dim LOptType As String:
    Dim LStrike As Double:          Dim LQTY As Double:             Dim LRATE As Double:            Dim LSCondate As Date
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LCITEM As String:           Dim LSSaudaCode As String
    Dim LSSauda As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
    Dim LContime As String:         Dim LLOT As Double:             Dim LUserId As String:          Dim LSMaturity As Date
    Dim LPartyName As String:       Dim LOConNo As String:          Dim LSItemName As String:       Dim LSConSno As Long
    Dim LEXHCODE As String:         Dim TRec As ADODB.Recordset:    Dim LClient As String:          Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LPty As String:             Dim LOverwrite As Boolean:      Dim LSTRCONDATE As String:
    Dim ltradedt As Date:           Dim LFolder As String:          Dim LParty As String:           Dim LFileSource As String
    Dim lday As String:             Dim LMONTH As String:           Dim lyear As String:            Dim A As Integer
    Dim B As Integer:               Dim LSaudaID As Long:        Dim LExID As Integer
    Dim LItemID As Integer
    
    LOverwrite = True
    LSExCode = "SGX"
    On Error GoTo err1
    Call GET_JCnn("\SGX;")
    Call Get_ExDetail(LSExCode)
    LTradeFileType = "1"
    If LenB(BrokerCombo.BoundText) > 1 Then
        LExCont = BrokerCombo.BoundText
    Else
        MsgBox " Please Select Broker Account"
        Exit Sub
    End If
    If LenB(ClientCombo.BoundText) > 1 Then
        LParty = ClientCombo.BoundText
    Else
        MsgBox " Please Select Client Account"
        Exit Sub
    End If
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
            LFileName = Text1.text
        Else
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFolder = Left$(LFileName, (Len(LFileName) - Len(TxtPath) - 1)) & ""
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        Else
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath))) & ";"
            Set Jcnn = Nothing
            Set Jcnn = New ADODB.Connection
            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
            "Data Source=" & LFileSource & _
            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True:
            TxtRec.MoveFirst:
            TxtRec.Filter = "f13='Filled'"
            If Not TxtRec.EOF Then
                LSTRCONDATE = Left(TxtRec!f19, 10)
                LSCondate = DateValue(LSTRCONDATE)
            Else
                LSCondate = ltradedt
            End If
            CNNERR = True
            If MsgBox("Are you Sure to Delete Trades of  " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND EXCODE ='" & LSExCode & "'"
                mysql = mysql & " AND FILETYPE='" & LTradeFileType & "'"
                Cnn.Execute mysql
            End If
            MCount = Get_Max_ConNo(LSCondate, 0)
            TxtRec.MoveFirst
            While Not TxtRec.EOF
                LContime = vbNullString:    ITExchangeCode = vbNullString:   LOConNo = vbNullString
                LQTY = 0:                   LRATE = 0:                      LOrdNo = vbNullString
                LSInstType = "FUT":         LOptType = vbNullString:        LStrike = 0
                MCount = MCount + 1
                LSTRCONDATE = Left(TxtRec!f19, 10)
                LSCondate = DateValue(LSTRCONDATE)
                LContime = Mid$(TxtRec!f19, 11, Len(TxtRec!f19))
                ITExchangeCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LSTRCONDATE = Right(TxtRec!f3, 3)
                lday = "28"
                LMONTH = Left(LSTRCONDATE, 1)
                LMONTH = Get_CMX_Month(LMONTH)
                
                lyear = Right(LSTRCONDATE, 2)
                LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                LConType = Left$(TxtRec!F1, 1)
                LPtyContype = Left$(TxtRec!F1, 1)
                LRATE = Val(TxtRec!F5)
                If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                    LQTY = Val(TxtRec!F2) * Val(TxtQtyMultipler.text)
                Else
                    LQTY = Val(TxtRec!F2)
                End If
                LLOT = 1
                LUserId = TxtRec!F14
                mparty = LParty
                LEXHCODE = ITExchangeCode
                LSItemCode = LEXHCODE
                LSItemName = LEXHCODE
                MSPARTY = LExCont
                DoEvents
                LExID = Get_ExID(LSExCode)
                LCITEM = Create_CItemMast(LSItemCode, LSItemName, LEXHCODE, LLOT, LSExCode)
                
                LSItemCode = Create_ItemMast(LSItemCode, LSItemName, LEXHCODE, LLOT, LSExCode, LExID)
                DoEvents
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                LItemID = Get_ITEMID(LSItemCode)
                LSSauda = Create_SSaudaMast(LEXHCODE, LSMaturity, LSExCode, LSInstType, LOptType, LStrike, LSItemCode)
                LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LOptType, LStrike, LExID, LItemID)
                LSaudaID = Get_SaudaID(LSSaudaCode)
                LLOT = Get_LotSize(LItemID, LSaudaID, LExID)
                MSPARTY = LExCont
                mbparty = LParty
                If LenB(mbparty) < 1 Then mbparty = NewParty(LSExCode, mparty, mparty, mparty, True)
                If LenB(mbparty) < 1 Then
                    LMsgBox = "Create  Account For  " & mparty & ""
                    ImportIssues (LMsgBox)
                    GoTo EFlag_Next
                End If
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                LClient = mbparty
                If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, LTradeFileType, "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
flag210:
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
      
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub


Public Function Get_RMN_Month(LStrMonth As String) As String
    Select Case LStrMonth
        Case "I"
            Get_RMN_Month = "1"
        Case "II"
            Get_RMN_Month = "2"
        Case "III"
            Get_RMN_Month = "3"
        Case "IV"
            Get_RMN_Month = "4"
        Case "V"
            Get_RMN_Month = "5"
        Case "VI"
            Get_RMN_Month = "6"
        Case "VII"
            Get_RMN_Month = "7"
        Case "VIII"
            Get_RMN_Month = "8"
        Case "IX"
            Get_RMN_Month = "9"
        Case "X"
            Get_RMN_Month = "10"
        Case "XI"
            Get_RMN_Month = "11"
        Case "XII"
            Get_RMN_Month = "12"
    End Select
End Function


Public Function Get_CMX_Month(LStrMonth As String) As String
    Select Case LStrMonth
        Case "F"
            Get_CMX_Month = "1"
        Case "G"
            Get_CMX_Month = "2"
        Case "H"
            Get_CMX_Month = "3"
        Case "J"
            Get_CMX_Month = "4"
        Case "K"
            Get_CMX_Month = "5"
        Case "M"
            Get_CMX_Month = "6"
        Case "N"
            Get_CMX_Month = "7"
        Case "Q"
            Get_CMX_Month = "8"
        Case "U"
            Get_CMX_Month = "9"
        Case "V"
            Get_CMX_Month = "10"
        Case "X"
            Get_CMX_Month = "11"
        Case "Z"
            Get_CMX_Month = "12"
    End Select
End Function

Private Sub Save_ExcelOtc15()
    On Error GoTo err1
    Dim lbparty As String:          Dim lsparty As String:          Dim ltradedt As Date:           Dim LPtyContype As String
    Dim TxtPath As String:          Dim LFileName As String:        Dim MCount As Long:             Dim LSItemCode As String:
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOptType As String:         Dim LStrike As Double:          Dim LConType As String:         Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LCITEM As String:           Dim LSSauda As String
    Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LContime As String:         Dim lyear As Integer
    Dim LLOT As Double:             Dim LUserId As String:          Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LNo As Integer:             Dim LStrMonth As String:        Dim LItemID As Integer
    Dim LMONTH As Integer:          Dim LString As String:          Dim LSaudaID As Long:        Dim LExID As Integer
    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    Call GET_JCnn("\TRADE;")
                    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "TRADE") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "TRADE")
    End If
    Set LFileSystemObject = Nothing
    
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = "TRD" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = App.Path & "\TRADE\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                If MsgBox("Are you Sure to Delete Trades of  " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(ltradedt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='15'"
                End If
                MCount = Get_Max_ConNo(LSCondate, 0)
                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                    LSSaudaCode = vbNullString:   LSaudaID = 0
                    LItemID = 0
                    LQTY = 0::                    LRATE = 0:
                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                    If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                    LSCondate = DateValue(TxtRec!F1)
                    lbparty = TxtRec!F2
                    
                    LContime = Time
                    LEXHCODE = TxtRec!f3
                    LSMaturity = DateValue(TxtRec!F4)
                    
                    If Not IsNull(TxtRec!F9) Then
                        If Val(TxtRec!F9) <> 0 Then
                            LSInstType = "OPT"
                            LOptType = TxtRec!F8
                            LStrike = Val(TxtRec!F9)
                        End If
                    End If
                    mysql = "SELECT ITEMID,EXID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        LSItemCode = TRec!ITEMCODE
                        LLOT = TRec!lot
                        LSExCode = TRec!EXCHANGECODE
                        LItemID = TRec!itemid
                        LExID = TRec!EXID
                    Else
                        LMsgBox = " Create New Commodity " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                    mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMID =" & LItemID & ""
                    mysql = mysql & " AND MATURITY ='" & Format(LSMaturity, "YYYY/MM/DD") & "'"
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode
                    Else
                        LStrMonth = Left(MonthName(month(LSMaturity)), 3)
                        lyear = Year(LSMaturity)
                        
                        If LSInstType = "FUT" Then
                            LSSaudaCode = LSItemCode & " " & Left(LSMaturity, 2) & " " & LStrMonth & " " & lyear
                        Else
                            LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LStrMonth & " " & lyear
                        End If
                        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                    End If
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    LSaudaID = Get_SaudaID(LSSaudaCode)
                    LQTY = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
                    LRATE = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):
                    If LQTY > 0 Then
                        LPtyContype = "B"
                    Else
                        LPtyContype = "S"
                        LQTY = Abs(LQTY)
                    End If
                    lsparty = TxtRec!F7
                    mbparty = Get_AccountDCode(lbparty)
                    If LenB(mbparty) < 1 Then
                        LMsgBox = "No Account with Code " & lbparty & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    MSPARTY = Get_AccountDCode(lsparty)
                    If LenB(MSPARTY) < 1 Then
                        LMsgBox = "No Broker Account with Code " & lsparty & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    MCount = MCount + 1
                    LOConNo = str(MCount)
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                    If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                    Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "15", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                    TxtRec.MoveNext
                Wend
            'End If
        End If
    End If
Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Save_Vertex_Trade()
    'date 20/07/2004
    Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOptType As String:         Dim LStrike As Double:          Dim LContime As String:         Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LSCondate As Date:          Dim LSMaturity As Date
    Dim ITExchangeCode As String:   Dim LOConNo As String:          Dim LSTRDATE As String:         Dim LClient As String
    Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:          Dim TRec As ADODB.Recordset
    Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String:       Dim LSExCode As String
    Dim LFileSource As String:      Dim LEXHCODE  As String:        Dim lyear As String:            Dim LMONTH As String
    Dim LSTRCONDATE As String:      Dim LSaudaID As Long:        Dim A As Integer
    Dim LItemID As Integer:         Dim LExID As Integer
    LOverwrite = True
    On Error GoTo err1
    LSExCode = "CMX"
    Call Get_ExDetail(LSExCode)
    
    If LenB(LBrokerCode) > 1 Then
        LExCont = LBrokerCode
        MSPARTY = LExCont
    Else
        MsgBox " Please Select Broker "
        Exit Sub
    End If
    If LenB(LClientCode) < 1 Then
        MsgBox " Please Select Client"
        Exit Sub
    End If
    Cnn.BeginTrans
    CNNERR = True:
                        
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & " "
            TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            TxtRec.MoveFirst
            CNNERR = True
            MCount = Get_Max_ConNo(ltradedt, 0)
            TxtRec.MoveFirst
            While Not TxtRec.EOF
                LPtyContype = "B": LOrdTime = vbNullString: LOptType = vbNullString: LStrike = 0: LSInstType = "FUT"
                If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                'If TxtRec!f4 <> "Close" Then GoTo EFlag_Next
                If IsNull(TxtRec!f3) Then GoTo EFlag_Next
                If TxtRec!f3 <> "Buy" Then
                    If TxtRec!f3 <> "Sell" Then
                         GoTo EFlag_Next
                    End If
                End If
                        
                LOConNo = TxtRec!F1
                LSCondate = DateValue(Left$(TxtRec!F2, 10))
                LContime = Right(TxtRec!F2, Len(TxtRec!F2) - 10)
                A = InStr(TxtRec!F5, "/")
                LEXHCODE = Left(TxtRec!F5, A - 2)
                LPtyContype = Left$(Trim$(TxtRec!f3), 1)
                LRATE = Val(TxtRec!f6)
                LQTY = Val(TxtRec!F4)
                lyear = Year(LSCondate)
                LMONTH = Right(TxtRec!F5, 2)
                If Val(LMONTH) >= Val(month(LSCondate)) Then
                    LSMaturity = DateValue("28" & "/" & LMONTH & "/" & Year(LSCondate))
                Else
                    LSMaturity = DateValue("28" & "/" & LMONTH & "/" & CStr(Val(Year(LSCondate)) + 1))
                End If
                If LEXHCODE = "DG INR" Then LEXHCODE = "DINR"
                mysql = "SELECT ITEMCODE,LOT,EXCHANGECODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSItemCode = TRec!ITEMCODE
                    LLOT = TRec!lot
                    LSExCode = TRec!EXCHANGECODE
                    LItemID = TRec!itemid
                    LExID = TRec!EXID
                Else
                    LMsgBox = "Please Create new Item " & LEXHCODE & ""
                    ImportIssues (LMsgBox)
                    GoTo EFlag_Next
                End If
                Set TRec = Nothing: Set TRec = New ADODB.Recordset
                mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE=" & GCompCode & " AND ITEMCODE ='" & LSItemCode & "' "
                mysql = mysql & " AND MONTH(MATURITY) ='" & month(LSMaturity) & "'AND YEAR (MATURITY) ='" & Year(LSMaturity) & "' AND INSTTYPE ='" & LSInstType & "'"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode
                Else
                    LSSaudaCode = Create_TSaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, vbNullString, 0)
                End If
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LSaudaID = Get_SaudaID(LSSaudaCode)
                mbparty = LClientCode:
                LClient = mbparty:
                LUserId = mbparty
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS "
                mysql = mysql & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND EXCODE ='" & LSExCode & "'AND FILETYPE ='VH'"
                Cnn.Execute mysql
                MCount = MCount + 1
                If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, "", LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "VH", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
        Set TxtRec = Nothing
flag210:
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub


Sub Save_Credit()
    Dim LTran_No As Long:           Dim LPtyDrCr As String:    Dim LCPtyDrCr As String:        Dim LAmount As Double
    Dim LSCondate As Date:          Dim LName As String:       Dim ltradedt As Date:           Dim TxtPath  As String
    Dim LFileName As String:        Dim LSTRCONDATE As String: Dim LAcCode As String:          Dim LTime As String
    Dim LNarr  As String:           Dim LCURR As String:       Dim MPartyCode As String:       Dim MCParty As String
    Dim LNarration As String:       Dim MVouNo As String:      Dim LMVNo As Long
    Dim LExID As Integer
    Dim LACCID As Long
    Cnn.BeginTrans
    CNNERR = True:
    
    If Check42.Value = 1 Then LSExCode = "RACE"
    If Check44.Value = 1 Then LSExCode = "REAL"
    
    If Check42.Value = 1 Then Call GET_JCnn("\RACE;")
    If Check44.Value = 1 Then Call GET_JCnn("\REAL;")
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "RACE") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "RACE")
    End If
    Set LFileSystemObject = Nothing
                
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "REAL") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "REAL")
    End If
    Set LFileSystemObject = Nothing
    
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If Check42.Value = 1 Then
            TxtPath = "CREDIT" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right$(CStr(Year(ltradedt)), 2) & "_RACE.CSV"
        Else
            TxtPath = "CREDIT" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right$(CStr(Year(ltradedt)), 2) & "_REAL.CSV"
        End If
        
        If Check42.Value = 1 Then
            LFileName = App.Path & "\RACE\" & TxtPath
        ElseIf Check44.Value = 1 Then
            LFileName = App.Path & "\REAL\" & TxtPath
        End If
        
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                While Not TxtRec.EOF
                    If Not IsNumeric(TxtRec!f6) Then GoTo FLAG_NEXT
                    LSTRCONDATE = Left(TxtRec!F4, 10)
                    LSTRCONDATE = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                    LSCondate = DateValue(LSTRCONDATE)
                    LTran_No = Val(TxtRec!F1)
                    mysql = "DELETE FROM VOUCHER WHERE COMPCODE =" & GCompCode & " AND VOU_TYPE='JV' AND VOU_DT='" & Format(LSCondate, "yyyy/MM/dd") & "' "
                    mysql = mysql & " AND IMPORT  ='1' AND EXCODE ='" & LSExCode & "' AND BILLNO=" & LTran_No & ""
                    Cnn.Execute mysql
                    LAcCode = Trim(TxtRec!F2):                    LName = Trim(TxtRec!f3)
                    LTime = Right(TxtRec!F4, 8):                    LNarr = Trim(TxtRec!F5)
                    LAmount = Val(TxtRec!f6)
                    LCURR = Trim(TxtRec!F7)
                    LExID = Get_ExID(LSExCode)
                    MPartyCode = Get_ACCT_EX(LExID, LAcCode)
                    MCParty = Get_ACCT_EX(LExID, "C" & LAcCode)
                    If LenB(MPartyCode) < 1 Then
                        MPartyCode = NewParty(LSExCode, LAcCode, LAcCode & " " & LName, "1", True)
                        If LenB(MPartyCode) < 1 Then
                            If LSExCode = "RACE" Then
                                mysql = "UPDATE ACCOUNTM SET PTYHEAD =1 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & MPartyCode & "'"
                                Cnn.Execute mysql
                            Else
                                mysql = "UPDATE ACCOUNTM SET PTYHEAD =2 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & MPartyCode & "'"
                                Cnn.Execute mysql
                            End If
                        End If
                    End If
                    If LenB(MCParty) < 1 Then
                        MCParty = NewParty(LSExCode, "C" & LAcCode, "C" & LAcCode & " " & LName, "1", True)
                        If LenB(MPartyCode) < 1 Then
                            If LSExCode = "RACE" Then
                                mysql = "UPDATE ACCOUNTM SET PTYHEAD =1 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & MCParty & "'"
                                Cnn.Execute mysql
                            Else
                                mysql = "UPDATE ACCOUNTM SET PTYHEAD =2 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & MCParty & "'"
                                Cnn.Execute mysql
                            End If
                        End If
                    End If
                    If LenB(MPartyCode) < 1 Then GoTo FLAG_NEXT
                    If LenB(MCParty) < 1 Then GoTo FLAG_NEXT
                    If LAmount > 0 Then
                        LPtyDrCr = "C"
                        LCPtyDrCr = "D"
                        LNarration = "Credit In for Client " & LAcCode & " " & LName & ""
                    Else
                        LPtyDrCr = "D"
                        LCPtyDrCr = "C"
                        LNarration = "Credit Out for Client " & LAcCode & " " & LName & ""
                    End If
                    GMaxVouNo = Val(Right$(Get_VouNo("JRNL", GFinYear), 7))
                    MVouNo = Get_Next_Vou_No(GMaxVouNo, "JRNL", Right$(GFinBegin, 2) & Right$(GFinEnd, 2))
                    
                    LMVNo = PInsert_Voucher(MVouNo, LSCondate, "JV", "P", LTran_No, "ADD", "I", 0, LNarration, LSExCode, "1", LExID, 0)
                    LACCID = Get_AccID(MPartyCode)
                    Call PInsert_Vchamt(MVouNo, "JV", LSCondate, LPtyDrCr, MPartyCode, Abs(LAmount), vbNullString, LSCondate, LNarration, LSExCode, str(LTran_No), 0, LSExCode, LMVNo, LExID, 0, LACCID)
                    LACCID = Get_AccID(MCParty)
                    Call PInsert_Vchamt(MVouNo, "JV", LSCondate, LCPtyDrCr, MCParty, Abs(LAmount), vbNullString, LSCondate, LNarration, LSExCode, str(LTran_No), 0, LSExCode, LMVNo, LExID, 0, LACCID)
                    
FLAG_NEXT:
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Save_Deposit()
    Dim LTran_No As Long:           Dim LPtyDrCr As String:       Dim LCPtyDrCr As String:        Dim LAmount As Double
    Dim LSCondate As Date:          Dim LName As String:          Dim ltradedt As Date:           Dim TxtPath  As String
    Dim LFileName As String:        Dim LSTRCONDATE As String:    Dim LAcCode As String:          Dim LTime As String
    Dim LCURR As String:            Dim MPartyCode As String:     Dim LNarration As String:       Dim MVouNo As String:
    Dim LCParty As String:    Dim LMVNo As Long: Dim LExID As Integer
    Dim LACCID  As Long
    
    Cnn.BeginTrans
    CNNERR = True:
    If Check40.Value = 1 Then LSExCode = "RACE"
    If Check41.Value = 1 Then LSExCode = "REAL"
    If Check40.Value = 1 Then Call GET_JCnn("\RACE;")
    If Check41.Value = 1 Then Call GET_JCnn("\REAL;")
    
                
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "RACE") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "RACE")
    End If
    Set LFileSystemObject = Nothing
                
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & "REAL") Then
        LFileSystemObject.CreateFolder (App.Path & "\" & "REAL")
    End If
    Set LFileSystemObject = Nothing
    
    Call Get_ExDetail(LSExCode)
    LCParty = LContraCashAcc
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If Check40.Value = 1 Then
            TxtPath = "DEP" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right$(CStr(Year(ltradedt)), 2) & "_RACE.CSV"
        Else
            TxtPath = "DEP" & CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & Right$(CStr(Year(ltradedt)), 2) & "_REAL.CSV"
        End If
        
        If Check40.Value = 1 Then
            LFileName = App.Path & "\RACE\" & TxtPath
        ElseIf Check41.Value = 1 Then
            LFileName = App.Path & "\REAL\" & TxtPath
        End If
        
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                While Not TxtRec.EOF
                    If Not IsNumeric(TxtRec!f6) Then GoTo FLAG_NEXT
                    LSTRCONDATE = Left(TxtRec!F4, 10)
                    LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                    LTran_No = Val(TxtRec!F1)
                    mysql = "DELETE FROM VOUCHER WHERE COMPCODE =" & GCompCode & " AND VOU_TYPE='CV' AND VOU_DT='" & Format(LSCondate, "yyyy/MM/dd") & "' "
                    mysql = mysql & " AND IMPORT  ='1' AND EXCODE ='" & LSExCode & "' AND BILLNO=" & LTran_No & ""
                    Cnn.Execute mysql
                    LAcCode = Trim(TxtRec!F2)
                    LName = Trim(TxtRec!f3)
                    LTime = Right(TxtRec!F4, 8)
                    LNarration = Trim(TxtRec!F5)
                    LAmount = Val(TxtRec!f6)
                    LCURR = Trim(TxtRec!F7)
                    LExID = Get_ExID(LSExCode)
                    MPartyCode = Get_ACCT_EX(LExID, LAcCode)
                    
                    If LenB(MPartyCode) < 1 Then
                        MPartyCode = NewParty(LSExCode, LAcCode, LAcCode & " " & LName, "1", True)
                        If LenB(MPartyCode) < 1 Then
                            If LSExCode = "RACE" Then
                                mysql = "UPDATE ACCOUNTM SET PTYHEAD =1 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & MPartyCode & "'"
                                Cnn.Execute mysql
                            Else
                                mysql = "UPDATE ACCOUNTM SET PTYHEAD =2 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & MPartyCode & "'"
                                Cnn.Execute mysql
                            End If
                        End If
                    End If
                    If LenB(MPartyCode) < 1 Then
                        LMsgBox = " Party Code Not Found" & MPartyCode & ""
                        ImportIssues (LMsgBox)
                        GoTo FLAG_NEXT
                    End If
                    If LAmount > 0 Then
                        LPtyDrCr = "C"
                        LCPtyDrCr = "D"
                    Else
                        LPtyDrCr = "D"
                        LCPtyDrCr = "C"
                    End If
                    GMaxVouNo = Val(Right$(Get_VouNo("CASP", GFinYear), 7))
                    MVouNo = Get_Next_Vou_No(GMaxVouNo, "CASP", Right$(GFinBegin, 2) & Right$(GFinEnd, 2))
                    
                    LMVNo = PInsert_Voucher(MVouNo, LSCondate, "CV", "P", LTran_No, "ADD", LCParty, 0, LNarration, LSExCode, "1", LExID, 0)
                    LACCID = Get_AccID(MPartyCode)
                    
                    Call PInsert_Vchamt(MVouNo, "CV", LSCondate, LPtyDrCr, MPartyCode, Abs(LAmount), vbNullString, LSCondate, LNarration, LSExCode, str(LTran_No), 0, LSExCode, LMVNo, LExID, 0, LACCID)
                    LACCID = Get_AccID(LCParty)
                    Call PInsert_Vchamt(MVouNo, "CV", LSCondate, LCPtyDrCr, LCParty, Abs(LAmount), vbNullString, LSCondate, LNarration, LSExCode, str(LTran_No), 0, LSExCode, LMVNo, LExID, 0, LACCID)
FLAG_NEXT:
                    TxtRec.MoveNext
                Wend
            End If
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Public Function Chk_TradeNo(ByVal LPSauda As String, ByVal LPTrdNo As String, ByVal LPCondate As Date) As Boolean
Dim NewRec As ADODB.Recordset
    Chk_TradeNo = False
    mysql = "SELECT CONNO FROM CTR_D WHERE COMPCODE=" & GCompCode & " AND SAUDA = '" & LPSauda & "'"
    mysql = mysql & " And ROWNO1 ='" & LPTrdNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS AND CONDATE ='" & Format(LPCondate, "yyyy/MM/dd") & "'"
    Set NewRec = Nothing:   Set NewRec = New ADODB.Recordset
    NewRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not NewRec.EOF Then Chk_TradeNo = True
End Function
Sub Trade_FX_TRADE()
    Dim LOverwrite  As Boolean:     Dim ltradedt As Date:       Dim TxtPath As String
    Dim LFileName As String:        Dim LMFLPath As String:     Dim TRec As ADODB.Recordset
    Dim LFolderName As String
    
    LSExCode = "FX"
    Call GET_JCnn("\FX;")
    Call Get_ExDetail(LSExCode)
    If LenB(LExCont) = 0 Then Exit Sub
    LOverwrite = IIf(Check14 = 1, False, True)
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        If Check21.Value = 1 Then
            If MsgBox("Are you Sure to Delete Trades of FX All terminals " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND EXCODE ='FX' AND DATAIMPORT=1 AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "'"
                Cnn.Execute mysql
            End If
        End If
        Select Case LBrokerType
            Case "O"
                TxtPath = "X_" & Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & "_" & LMemberId & ".TXT"
                LFileName = App.Path & "\FX\" & TxtPath
            Case "C"
                'TxtPath = "MCX_SX_" & Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & "TRD.TXT"
                TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".TXT"
                LFileName = App.Path & "\FX\" & TxtPath
            Case "N"
                TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".CSV"
                LFileName = App.Path & "\FX\" & TxtPath
            Case "S"
                TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".TXT"
                LFileName = App.Path & "\FX\" & TxtPath
            Case "M"
                TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".TXT"
                LFileName = App.Path & "\FX\" & TxtPath
            Case Else
                TxtPath = "TR" & Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".TXT"
                LFileName = App.Path & "\FX\" & TxtPath
            End Select
                
        Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
        If Not LFileSystemObject.FolderExists(App.Path & "\" & "FX") Then
            LFileSystemObject.CreateFolder (App.Path & "\" & "FX")
        End If
        Set LFileSystemObject = Nothing
                    
        LFileName = App.Path & "\FX\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If LOverwrite = True Then
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND EXCODE ='FX' AND DATAIMPORT=1 AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "'"
                Cnn.Execute mysql
            End If
            Call SAVE_FX_TRADE(ltradedt)
        End If
        If Check21.Value = 1 Then
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT FOLDERNAME,CONTRACTACC,BROKERTYPE,PARTYAS,CLIENTCODE FROM EXFILE WHERE COMPCODE =" & GCompCode & " AND EXCODE='FX' ORDER BY FILEID "
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            Do While Not TRec.EOF
                LClientCode = vbNullString
                LExCont = TRec!CONTRACTACC
                LBrokerType = TRec!BROKERTYPE
                LFolderName = TRec!FOLDERNAME
                LPartyAs = TRec!PARTYAS
                If LPartyAs = "F" Then LClientCode = TRec!CLIENTCODE
                Select Case LBrokerType
                    Case "O"
                        'TxtPath = "X_" & Left$(LTradeDt, 2) & Mid(LTradeDt, 4, 2) & CStr(Year(LTradeDt)) & "_" & LMemberId & ".TXT"
                        TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".CSV"
                    Case "C"
                        TxtPath = "MCX_SX_" & Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & "TRD.TXT"
                    Case "N"
                        TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".CSV"
                    Case "S"
                        TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".TXT"
                    Case "M"
                        TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".TXT"
                    Case "T"
                        TxtPath = Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".CSV"
                    Case Else
                        TxtPath = "TR" & Left$(ltradedt, 2) & Mid(ltradedt, 4, 2) & CStr(Year(ltradedt)) & ".TXT"
                End Select
                Call GET_JCnn("\" & LFolderName & "\;")
                
                Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
                If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
                    LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
                End If
                Set LFileSystemObject = Nothing
                
                LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
                If Not FileExist(LFileName) Then
                    LMsgBox = LFileName & "  file not found" ', vbCritical
                    ImportIssues (LMsgBox)
                Else
                    LOverwrite = False
                    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
                    TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
                    Call SAVE_FX_TRADE(ltradedt)
                End If
                TRec.MoveNext
            Loop
        End If
    Next ltradedt
    Set Jcnn = Nothing
End Sub
Private Sub Save_CME2Trade()
On Error GoTo err1
    
    Dim lbparty As String:          Dim lsparty As String:          Dim ltradedt As Date:           Dim LOptType As String:
    Dim TxtPath As String:          Dim LFileName As String:        Dim LStrike As Double:          Dim LOrdNo As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LCITEM As String:           Dim LSSauda As String
    Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LContime As String:         Dim LFileSource  As String
    Dim LLOT As Double:             Dim LUserId As String:          Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LNo As Integer:             Dim LStrMonth As String:        Dim LMONTH As Integer
    Dim LString As String:          Dim lyear As Integer:           Dim LBrokerCode  As String:     Dim LClientCode  As String
    Dim LStrYear As String:         Dim LDT As Date::               Dim lday As String:             Dim LSaudaID As Long
    Dim LExID  As Integer:          Dim LItemID As Integer
    
    Set TxtRec = Nothing:
    Set TxtRec = New ADODB.Recordset
    If LenB(BrokerCombo.BoundText) < 1 Then
        MsgBox "Please Select Broker"
        Call UnLock_Screen
        BrokerCombo.SetFocus
        Exit Sub
    Else
        LBrokerCode = BrokerCombo.BoundText
    End If
    
    If LenB(ClientCombo.BoundText) < 1 Then
        MsgBox "Please Select Client "
        
        Call UnLock_Screen
        ClientCombo.SetFocus
        Exit Sub
    Else
        LClientCode = ClientCombo.BoundText
    End If
    'Call GET_JCnn("\CME;")
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        Else
            MsgBox "Please Select Valid File"
            Call UnLock_Screen
            Cnn.RollbackTrans
            Exit Sub
        End If
    
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = DateValue(ltradedt)
            If MsgBox("Are you Sure to Delete Trades of  " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(ltradedt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND CONCODE='" & LBrokerCode & "'AND FILETYPE ='10'"
            End If
            MCount = Get_Max_ConNo(LSCondate, 0)
            While Not TxtRec.EOF
                lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                LQTY = 0::                    LRATE = 0:
                LSaudaID = 0
                LItemID = 0
                If IsNull(TxtRec!f11) Then GoTo EFlag_Next
                If Not IsNumeric(TxtRec!f11) Then GoTo EFlag_Next
                If Val(TxtRec!f11) < 1 Then GoTo EFlag_Next
                If TxtRec!f3 <> "CME" Then GoTo EFlag_Next
                LOConNo = TxtRec!F1
                lyear = Right(TxtRec!F13, 4)
                LStrMonth = Mid(TxtRec!F13, 5, 3)
                lday = Mid(TxtRec!F13, 9, 2)
                
                LSCondate = DateValue(lday & "/" & LStrMonth & "/" & lyear)
                LContime = Mid(TxtRec!F13, 12, 12)
                LEXHCODE = TxtRec!F4
                LStrMonth = Left$(TxtRec!F5, 3)
                LStrYear = "20" & Right$(TxtRec!F5, 2)
                LDT = DateValue("20" & "/" & LStrMonth & "/" & LStrYear)
                LMONTH = month(LDT)
                lyear = Year(LDT)
                If LEXHCODE = "CMX GLD" Then LEXHCODE = "GC"
                mysql = "SELECT EXID,ITEMID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                If Not TRec.EOF Then
                    LSItemCode = TRec!ITEMCODE
                    LLOT = TRec!lot
                    LSExCode = TRec!EXCHANGECODE
                    LItemID = TRec!itemid
                    LExID = TRec!EXID
                Else
                    LMsgBox = " Create New Commodity " & LEXHCODE & ""
                    ImportIssues (LMsgBox)
                    GoTo EFlag_Next
                End If
                Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE =" & LItemID & ""
                mysql = mysql & " AND MONTH(MATURITY)=" & LMONTH & " AND YEAR(MATURITY)=" & lyear & ""
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode
                Else
                    LSMaturity = DateValue("20/" & LMONTH & "/" & lyear & "")
                    If LSInstType = "FUT" Then
                        LSSaudaCode = LSItemCode & " " & LStrMonth & " " & lyear
                    Else
                        LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LStrMonth & " " & lyear
                    End If
                    Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                End If
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LSaudaID = Get_SaudaID(LSSaudaCode)
                LQTY = Val(TxtRec!f11)
                If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                    LQTY = LQTY * Val(TxtQtyMultipler.text)
                End If
                LRATE = Val(TxtRec!f12)
                LConType = Left$(TxtRec!f6, 1)
                If LConType = "B" Then
                    LPtyContype = "B"
                Else
                    LPtyContype = "S"
                End If
                lbparty = LClientCode
                lsparty = LBrokerCode
                mbparty = Get_AccountMCode(lbparty)
                If LenB(mbparty) < 1 Then GoTo EFlag_Next
                MSPARTY = Get_AccountMCode(lsparty)
                If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
                MCount = MCount + 1
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "10", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Private Sub Save_CME_AllTrader()
    On Error GoTo err1
    Dim ltradedt As Date:           Dim TxtPath As String:          Dim LFileName As String:  Dim LFileSource As String:      Dim lbparty As String:          Dim lsparty As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:   Dim LPtyContype As String:      Dim LSConSno As Long:           Dim LQTY As Double
    Dim LSInstType As String:       Dim LOptType As String:         Dim LStrike As Double:    Dim LOrdNo As String:           Dim LOrdTime As String:         Dim LSSaudaCode As String:
    Dim LCITEM As String:           Dim LSSauda As String:          Dim LSCondate As Date:    Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
    Dim mbparty As String:          Dim MSPARTY As String:          Dim LLOT As Double:       Dim LUserId As String:          Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
    Dim TRec As ADODB.Recordset:    Dim LContime As String:         Dim LRATE As Double:      Dim LConNo As Long:             Dim lyear As String:            Dim LMONTH As String
    Dim LSettleRate As Double:      Dim A As Integer:               Dim B As Integer:         Dim lday As String:             Dim C As Integer:               Dim LParty As String
    Dim LCounter As Integer:        Dim LSaudaID As Long:        Dim LExID As Integer:    Dim LItemID As Integer
    
    Set TxtRec = Nothing:
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT EXCODE FROM EXMAST WHERE COMPCODE =" & GCompCode & "AND EXNAME LIKE 'C%'"
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then
        Do While Not TRec.EOF
            If TRec!excode = "CMX" Then
                LSExCode = "CMX"
                Exit Do
            End If
            If TRec!excode = "CME" Then
                LSExCode = "CME"
                Exit Do
            End If
            TRec.MoveNext
        Loop
    End If
    Set TxtRec = New ADODB.Recordset
    
    Call Get_ExDetail(LSExCode)
    
    Cnn.BeginTrans
    CNNERR = True
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        Else
            MsgBox "Please Select Valid File"
            Cnn.RollbackTrans
            Exit Sub
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        If Not FileExist(LFileName) Then
            CommonDialog1.InitDir = App.Path
            CommonDialog1.ShowOpen
            If CommonDialog1.FileName <> "" Then
                Text1.text = CommonDialog1.FileName
            Else
                MsgBox "Please Select Valid File"
                Cnn.RollbackTrans
                Exit Sub
            End If
            TxtPath = CommonDialog1.FileTitle
            LFileName = CommonDialog1.FileName
            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
            Set Jcnn = Nothing
            Set Jcnn = New ADODB.Connection
            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
            "Data Source=" & LFileSource & _
            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        Else
            Set Jcnn = Nothing
            Set Jcnn = New ADODB.Connection
            Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
            "Data Source=" & LFileSource & _
            "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & " ", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = ltradedt
            If MsgBox("Are you Sure to Delete Trades of " & ltradedt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(ltradedt, "YYYY/MM/DD") & "' AND DATAIMPORT =1 AND FILETYPE ='" & LTradeFileType & "'"
                Cnn.Execute mysql
            End If
            MCount = Get_Max_ConNo(ltradedt, 0)
            LConNo = MCount
            LCounter = 1
            Do While LCounter <= 2
                TxtRec.MoveFirst
                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
                    LQTY = 0:                     LRATE = 0:                       LSaudaID = 0: LItemID = 0
                    If Not IsNumeric(TxtRec!F8) Then GoTo EFlag_Next
                    LConNo = LConNo + 1
                    LOConNo = TxtRec!F1:                            A = InStr(TxtRec!F2, " ")
                    LSTRCONDATE = Left(TxtRec!F2, A - 1):           C = Len(LSTRCONDATE)
                    lyear = Right(LSTRCONDATE, 4):                  A = InStr(LSTRCONDATE, "/")
                    LMONTH = Left(LSTRCONDATE, A - 1):              B = InStr(A + 1, LSTRCONDATE, "/")
                    lday = Mid(LSTRCONDATE, A + 1, (B - 1) - A):    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear & ""
                    LSCondate = DateValue(LSTRCONDATE):             LContime = Mid(TxtRec!F2, C + 1, Len(TxtRec!F2))
                    lbparty = TxtRec!f3:                            LSExCode = TxtRec!F4
                    Call Get_ExDetail(LSExCode)
                    If LCounter = 1 Then
                        MSPARTY = LExCont
                    Else
                        MSPARTY = LContAc2
                    End If
                    If LSExCode = "DGCX" Then
                        A = InStr(TxtRec!F5, "-")
                        LEXHCODE = Left(TxtRec!F5, A - 1)
                        LSTRCONDATE = Mid(TxtRec!F5, A + 1, Len(TxtRec!F5))
                        LSMaturity = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 5, 2) & "/" & Left(LSTRCONDATE, 4))
                    Else
                        A = InStr(TxtRec!F5, "_")
                        If A > 0 Then
                            LEXHCODE = Left(TxtRec!F5, A - 1)
                        Else
                            LEXHCODE = TxtRec!F5
                        End If
                        LSMaturity = DateValue("28/" & Right$(TxtRec!f6, 2) & "/" & Left$(TxtRec!f6, 4))
                    End If
                    If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then
                        LQTY = Val(TxtRec!F8) * Val(TxtQtyMultipler.text)
                    Else
                        LQTY = Val(TxtRec!F8)
                    End If
                    LRATE = TxtRec!F9
                    If LSExCode = "CME" Then
                        If LEXHCODE = "SI" Then LRATE = LRATE / 1000
                        If LEXHCODE = "GC" Then LRATE = LRATE / 10
                        If LEXHCODE = "CL" Then LRATE = LRATE / 100
                        If LEXHCODE = "NG" Then LRATE = LRATE / 1000
                        If LEXHCODE = "HG" Then LRATE = LRATE / 10000
                    End If
                    LPtyContype = Left(TxtRec!F7, 1)
                    If LenB(LEXHCODE) < 1 Then
                        GoTo EFlag_Next
                    End If
                    mysql = "SELECT EXID,ITEMID ,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "' AND EXCHANGECODE  ='" & LSExCode & "'"
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSItemCode = TRec!ITEMCODE
                        LLOT = TRec!lot
                        LSExCode = TRec!EXCHANGECODE
                        LExID = TRec!EXID
                        LItemID = TRec!itemid
                    Else
                        LSItemCode = Create_TItemMast(LEXHCODE, LEXHCODE, LEXHCODE, 1, LSExCode)
                        LItemID = Get_ITEMID(LSItemCode)
                        LExID = Get_ExID(LSExCode)
                    End If
                    If LenB(LSItemCode) < 1 Then
                        GoTo EFlag_Next
                    End If
                    Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
                    mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND INSTTYPE ='FUT' AND ITEMCODE =" & LItemID & ""
                    If LSExCode = "DGCX" Then
                        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "yyyy/mm/dd") & "'"
                    Else
                        mysql = mysql & " AND MONTH(MATURITY)=" & month(LSMaturity) & " AND YEAR(MATURITY)=" & Year(LSMaturity) & "  "
                    End If
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode
                    Else
                        If LSInstType = "FUT" Then
                            LSSaudaCode = LSExCode & " " & LEXHCODE & " " & Left$(CStr(LSMaturity), 2) & " " & Left$(MonthName(month(LSMaturity)), 3) & " " & Year(LSMaturity) & ""
                        Else
                            LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LSMaturity & " "
                        End If
                        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                    End If
                    If LenB(LSSaudaCode) < 1 Then
                        LMsgBox = "SAUDA CODE NOT FOUND " & LSExCode & LEXHCODE & LSMaturity & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    LSaudaID = Get_SaudaID(LSSaudaCode)
                    If LTradeFileType = "3" Then
                        mbparty = LParty
                    Else
                        mbparty = NewParty(LSExCode, lbparty, lbparty, vbNullString, True)
                    End If
                    If LenB(mbparty) < 1 Then
                        GoTo EFlag_Next
                    End If
                    If LenB(MSPARTY) < 1 Then
                        GoTo EFlag_Next
                    End If
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                    If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                    Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, LConNo, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, LTradeFileType, "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                    TxtRec.MoveNext
                Wend
                LCounter = LCounter + 1
            Loop
        End If
    Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Private Sub Lock_Screen()
    Frame2.Enabled = False
    'Frame2.BackColor = &HC0C0C0
End Sub

Private Sub UnLock_Screen()
    Frame2.Enabled = True
    'Frame2.BackColor = &HFFC0C0
End Sub
Sub Save_Vertex_Trade2()
    'date 20/07/2004
    Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
    Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
    Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
    Dim LOptType As String:         Dim LStrike As Double:          Dim LContime As String:         Dim LOrdNo As String
    Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LSCondate As Date:          Dim LSMaturity As Date
    Dim ITExchangeCode As String:   Dim LOConNo As String:          Dim LSTRDATE As String:         Dim LClient As String
    Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:          Dim TRec As ADODB.Recordset
    Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String:       Dim LSExCode As String
    Dim LFileSource As String:      Dim LEXHCODE  As String:        Dim lyear As String:            Dim LMONTH As String
    Dim LSTRCONDATE As String:      Dim A As Integer:               Dim LSaudaID As Long:           Dim LItemID As Integer
    Dim LExID As Integer
    
    LOverwrite = True
    On Error GoTo err1
    LSExCode = "CMX"
    Call Get_ExDetail(LSExCode)
    
    If LenB(LBrokerCode) > 1 Then
        LExCont = LBrokerCode
        MSPARTY = LExCont
    Else
        LExCont = LBrokerCode
        MSPARTY = LExCont
    End If
    Cnn.BeginTrans
    CNNERR = True:
                        
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        CommonDialog1.InitDir = App.Path
        CommonDialog1.ShowOpen
        If CommonDialog1.FileName <> "" Then
            Text1.text = CommonDialog1.FileName
        End If
        TxtPath = CommonDialog1.FileTitle
        LFileName = CommonDialog1.FileName
        LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
        Set Jcnn = Nothing
        Set Jcnn = New ADODB.Connection
        Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
        "Data Source=" & LFileSource & _
        "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
            GoTo flag210
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            mysql = "Select * from " & TxtPath & " "
            TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        End If
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            TxtRec.MoveFirst
            CNNERR = True
            MCount = Get_Max_ConNo(ltradedt, 0)
            TxtRec.MoveFirst
            While Not TxtRec.EOF
                LPtyContype = "B": LOrdTime = vbNullString: LOptType = vbNullString: LStrike = 0: LSInstType = "FUT"
                LSaudaID = 0
                If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                If TxtRec!F5 <> "New" Then GoTo EFlag_Next
                If IsNull(TxtRec!F8) Then GoTo EFlag_Next
                If TxtRec!F8 <> "Buy" Then
                    If TxtRec!F8 <> "Sell" Then
                         GoTo EFlag_Next
                    End If
                End If
                        
                LOConNo = TxtRec!F4
                LSCondate = DateValue(Left$(TxtRec!F1, 10))
                LContime = Right(TxtRec!F1, Len(TxtRec!F1) - 10)
                A = InStr(TxtRec!F10, "/")
                LEXHCODE = Left(TxtRec!F10, A - 2)
                LPtyContype = Left$(Trim$(TxtRec!F8), 1)
                mparty = Left(TxtRec!F7, 6)
                LPartyName = Trim(TxtRec!F7)
                If TxtRec!f6 = "N" Then
                    LRATE = Val(TxtRec!f11)
                Else
                    If LPtyContype = "B" Then
                        LPtyContype = "S"
                    Else
                        LPtyContype = "B"
                    End If
                    LRATE = Val(TxtRec!f12)
                End If
                LQTY = Val(TxtRec!F9)
                lyear = Year(LSCondate)
                LMONTH = Right(TxtRec!F10, 2)
                If Val(LMONTH) >= Val(month(LSCondate)) Then
                    LSMaturity = DateValue("28" & "/" & LMONTH & "/" & Year(LSCondate))
                Else
                    LSMaturity = DateValue("28" & "/" & LMONTH & "/" & CStr(Val(Year(LSCondate)) + 1))
                End If
                mysql = "SELECT ITEMCODE,LOT,EXCHANGECODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSItemCode = TRec!ITEMCODE
                    LLOT = TRec!lot
                    LSExCode = TRec!EXCHANGECODE
                    LItemID = TRec!itemid
                    LExID = TRec!EXID
                Else
                    LSItemCode = Create_TItemMast(LEXHCODE, LEXHCODE, LEXHCODE, 1, "CMX")
                End If
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                Set TRec = Nothing: Set TRec = New ADODB.Recordset
                mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE=" & GCompCode & " AND ITEMCODE ='" & LSItemCode & "' "
                mysql = mysql & " AND MONTH(MATURITY) ='" & month(LSMaturity) & "'AND YEAR (MATURITY) ='" & Year(LSMaturity) & "' AND INSTTYPE ='" & LSInstType & "'"
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode
                Else
                    LSSaudaCode = Create_TSaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, vbNullString, 0)
                End If
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LSaudaID = Get_SaudaID(LSSaudaCode)
                mbparty = NewParty(LSExCode, mparty, LPartyName, vbNullString, True)
                If LenB(mbparty) < 1 Then GoTo EFlag_Next
                LUserId = mbparty
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND ROWNO1 ='" & LOConNo & "' COLLATE SQL_Latin1_General_CP1_CS_AS "
                mysql = mysql & " AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "' AND EXCODE ='" & LSExCode & "'AND FILETYPE ='VT'"
                Cnn.Execute mysql
                MCount = MCount + 1
                If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                Call Add_To_Ctr_D(LPtyContype, LClient, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, "", LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, "VT", "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
                TxtRec.MoveNext
            Wend
        End If
        Set TxtRec = Nothing
flag210:
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Save_NSE_MARGIN_RATE()
    'date 20/07/2004
    Dim TxtPath As String:          Dim LFileName As String:        Dim MCount As Long:             Dim LSItemCode As String:
    Dim LMRate As Double:           Dim LSInstType As String:       Dim LOptType As String:         Dim LStrike As Double:
    Dim ITExchangeCode As String:   Dim TRec As ADODB.Recordset:    Dim LSExCode As String:         Dim LFileSource As String
    Dim LEXHCODE  As String:        Dim LSSaudaCode As String:      Dim A As Integer:               Dim LSaudaID As Long
    Dim LSMaturity As Date:         Dim LExID As Integer:           Dim LItemID As Integer
    Dim LIMRate As Double:          Dim LEMRate As Double: Dim LAMRate As Double: Dim ltotrate As Double
    Dim LSTR As String
    
    On Error GoTo err1
    LSExCode = "NSE"
    Cnn.BeginTrans
    CNNERR = True:
    CommonDialog1.InitDir = App.Path
    CommonDialog1.ShowOpen
    If CommonDialog1.FileName <> "" Then
        Text1.text = CommonDialog1.FileName
    End If
    TxtPath = CommonDialog1.FileTitle
    LFileName = CommonDialog1.FileName
    LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ";"
    Set Jcnn = Nothing
    Set Jcnn = New ADODB.Connection
    Jcnn.Open "Provider=Microsoft.Jet.OLEDB.4.0;" & _
    "Data Source=" & LFileSource & _
    "Extended Properties=""TEXT;HDR=No;IMEX=1;FMT=Delimited"""
    If Not FileExist(LFileName) Then
        LMsgBox = LFileName & "  file not found" ', vbCritical
        ImportIssues (LMsgBox)
        GoTo flag210
    Else
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        mysql = "Select * from " & TxtPath & " "
        TxtRec.Open mysql, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
    End If
    If Not TxtRec.EOF Then
        FlagDataTrf = True
        TxtRec.MoveFirst
        CNNERR = True
        mysql = "DELETE FROM DLYMGN WHERE COMPCODE =" & GCompCode & " AND EXCODE ='NSE' AND CONDATE ='" & Format(vcDTP1.Value, "YYYY/MM/DD") & "'"
        Cnn.Execute mysql
        While Not TxtRec.EOF
            LIMRate = 0:            LIMRate = 0:            LAMRate = 0: ltotrate = 0
            If IsNull(TxtRec!F1) Then GoTo EFlag_Next
            If GUniqClientId = "2369KOL" Then
                If Not IsNumeric(TxtRec!F5) Then GoTo EFlag_Next
            ElseIf GUniqClientId = "MJR-BIK" Then
                If Not IsDate(TxtRec!F2) Then GoTo EFlag_Next
                If Not IsNumeric(TxtRec!f3) Then GoTo EFlag_Next
                'If Not IsNumeric(TxtRec!F5) Then GoTo EFlag_Next
            End If
            LEXHCODE = TxtRec!F1
            If GUniqClientId = "2369KOL" Then
                LSMaturity = DateValue(Left(TxtRec!f3, 10))
                LSTR = Replace(TxtRec!F5, "%", "")
                LIMRate = Val(LSTR)
                LSTR = Replace(TxtRec!f6, "%", "")
                LEMRate = Val(LSTR)
            ElseIf GUniqClientId = "MJR-BIK" Then
                LSTR = Replace(TxtRec!F9, "%", "")
                ltotrate = Val(LSTR)
                If ltotrate <= 0 Then GoTo EFlag_Next
                
                LSMaturity = DateValue(Left(TxtRec!F2, 10))
                LSTR = Replace(TxtRec!f6, "%", "")
                LIMRate = Val(LSTR)
                LSTR = Replace(TxtRec!F7, "%", "")
                LEMRate = Val(LSTR)
                LSTR = Replace(TxtRec!F8, "%", "")
                LAMRate = Val(LSTR)
                

            Else
                LSMaturity = DateValue(Left(TxtRec!F2, 2) & "/" & Mid(TxtRec!F2, 4, 3) & "/20" & Right(TxtRec!F2, 2))
                LSTR = Replace(TxtRec!F4, "%", "")
                LIMRate = Val(LSTR)
                LSTR = Replace(TxtRec!F5, "%", "")
                LEMRate = Val(LSTR)
                LSTR = Replace(TxtRec!f6, "%", "")
                LAMRate = Val(LSTR)
            End If
            mysql = "SELECT ITEMID,EXID,ITEMCODE,LOT,EXCHANGECODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                LSItemCode = TRec!ITEMCODE
                LSExCode = TRec!EXCHANGECODE
                LExID = TRec!EXID
                LItemID = TRec!itemid
                mysql = "SELECT SAUDACODE,SAUDAID,MATURITY FROM SAUDAMAST WHERE COMPCODE  =" & GCompCode & " AND ITEMID =" & LItemID & " "
                mysql = mysql & "  AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "'"
                Set TRec = Nothing
                Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    'Do While Not TRec.EOF
                        LSSaudaCode = TRec!saudacode
                        LSaudaID = TRec!SAUDAID
                        LSMaturity = TRec!MATURITY
                        mysql = "INSERT INTO DLYMGN(COMPCODE,CONDATE,EXCODE,ITEMCODE,SAUDA,IMRATE,EMRATE,AMRATE,TMRATE,ADDLONG,ADDSHORT,SPCASHMGLONG,SPCASHMGSHORT,MATURITY,ELMLONG,ELMSHORT,DELIVERY,SAUDAID,EXID,ITEMID) "
                        mysql = mysql & " VALUES (" & GCompCode & ",'" & Format(vcDTP1.Value, "yyyy/MM/dd") & "','" & LSExCode & "','" & LSItemCode & "','" & LSSaudaCode & "', " & Val(LIMRate) & ", " & LEMRate & "," & LAMRate & " ,0, 0,0,0,0,'" & Format(LSMaturity, "YYYY/MM/DD") & "',0,0,0," & LSaudaID & "," & LExID & "," & LItemID & " )"
                        Cnn.Execute mysql
                     '   TRec.MoveNext
                    'Loop
                End If
            End If
EFlag_Next:
            TxtRec.MoveNext
        Wend
    End If
    Set TxtRec = Nothing
flag210:
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        
       Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Public Sub Create_Schema_Excel25(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 50")
    A.WriteLine ("Col2 = F2 Text Width 50")
    A.WriteLine ("Col3 = F3 Text Width 50")
    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100")
    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100")
    A.WriteLine ("Col8 = F8 Text Width 100")
    A.WriteLine ("Col9 = F9 Text Width 100")
    A.WriteLine ("Col10 = F10 Text Width 100")
    A.WriteLine ("Col11 = F11 Text Width 50")
    A.WriteLine ("Col12 = F12 Text Width 50")
    A.WriteLine ("Col13 = F13 Text Width 50")
    A.WriteLine ("Col14 = F14 Text Width 100")
    A.WriteLine ("Col15 = F15 Text Width 100")
    A.WriteLine ("Col16 = F16 Text Width 100")
    A.WriteLine ("Col17 = F17 Text Width 100")
    A.WriteLine ("Col18 = F18 Text Width 100")
    A.WriteLine ("Col19 = F19 Text Width 100")
    A.WriteLine ("Col20 = F20 Text Width 100")
    
    A.close
End Sub
Public Sub Create_Schema_Excel1(FLPATH As String, FLNAME As String)
    Dim LFileName As String
    Dim A As TextStream
    
    LFileName = FLPATH & "SCHEMA.INI"
    If FileExist(LFileName) Then Kill LFileName
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    Set A = LFileSystemObject.CreateTextFile(LFileName, True)
    A.WriteLine ("[" & FLNAME & "]")
    A.WriteLine ("ColNameHeader=False")
    A.WriteLine ("Format = CSVDelimited")
    A.WriteLine ("Col1 = F1 Text Width 50")
    A.WriteLine ("Col2 = F2 Text Width 50")
    A.WriteLine ("Col3 = F3 Text Width 50")
    A.WriteLine ("Col4 = F4 Text Width 100")
    A.WriteLine ("Col5 = F5 Text Width 100")
    A.WriteLine ("Col6 = F6 Text Width 100")
    A.WriteLine ("Col7 = F7 Text Width 100")
    A.WriteLine ("Col8 = F8 Text Width 100")
    
    A.close
End Sub


Private Sub Save_DGCXAll_File(LExFileType As Integer, LCTradeDt As Date)

Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
Dim LOptType As String:         Dim LStrike As Double:          Dim LContime As String:         Dim LOrdNo As String
Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LCITEM As String:           Dim LSSauda As String
Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
Dim mbparty As String:          Dim MSPARTY As String:          Dim LLOT As Double:             Dim LUserId As String
Dim LEXHCODE As String:         Dim LSTRCONDATE  As String:     Dim LStrDay As String:          Dim LSaudaID As Long
Dim lbparty As String:          Dim lsparty As String:          Dim LStrMonth As String:        Dim LStrYear As String
Dim TRec As ADODB.Recordset:    Dim A As Integer:               Dim LExID As Integer:           Dim LItemID  As Integer
Cnn.BeginTrans
CNNERR = True:
If Not TxtRec.EOF Then
    FlagDataTrf = True
    CNNERR = True
    TxtRec.MoveFirst
    LSCondate = DateValue(LCTradeDt)
    If MsgBox("Are you Sure to Delete Trades of  " & LCTradeDt & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
        mysql = " DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LCTradeDt, "yyyy/MM/dd") & "' AND DATAIMPORT=1 "
        mysql = mysql & " AND FILETYPE='" & LExFileType & "'"
        Cnn.Execute mysql
    End If
    MCount = Get_Max_ConNo(LSCondate, 0)
    While Not TxtRec.EOF
        lbparty = vbNullString:       lsparty = vbNullString:          LEXHCODE = vbNullString
        LOrdNo = vbNullString:        LUserId = vbNullString:          LContime = Time:              LSInstType = "FUT"
        LOrdTime = vbNullString:      LOptType = vbNullString:         LStrike = 0:                  LLOT = 0:
        LPtyContype = "B"
        LQTY = 0::                    LRATE = 0:
        LItemID = 0
        If LExFileType = "35" Then
            If IsNull(TxtRec!F1) Then GoTo EFlag_Next
            If TxtRec!F1 <> "DGCX" Then GoTo EFlag_Next
            LSCondate = LCTradeDt:                   LContime = Time
            LEXHCODE = TxtRec!f3:                    LStrDay = Left$(TxtRec!F4, 2)
            LStrMonth = Mid(TxtRec!F4, 3, 3):        LStrYear = Right$(TxtRec!F4, 4)
            LQTY = Val(TxtRec!F10):                  LRATE = Val(TxtRec!F8)
            LConType = Left$(TxtRec!F7, 1)
            If LConType = "S" Then LPtyContype = "S"
            LSMaturity = DateValue(LStrDay & "/" & LStrMonth & "/" & LStrYear)
            mysql = "SELECT ITEMID,EXID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            If Not TRec.EOF Then
                LSItemCode = TRec!ITEMCODE
                LLOT = TRec!lot
                LSExCode = TRec!EXCHANGECODE
                LExID = TRec!EXID
                LItemID = TRec!itemid
            Else
                LMsgBox = " Create New Commodity " & LEXHCODE & ""
                ImportIssues (LMsgBox)
                GoTo EFlag_Next
            End If
            Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
            mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE =" & LItemID & ""
            mysql = mysql & " AND INSTTYPE ='" & LSInstType & "'AND OPTTYPE='" & LOptType & "' And STRIKEPRICE =" & LStrike & ""
            mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "yyyy/mm/dd") & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                LSSaudaCode = TRec!saudacode
            Else
                If LSInstType = "FUT" Then
                    LSSaudaCode = LSItemCode & " " & month(LSMaturity) & " " & Year(LSMaturity)
                Else
                    LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LStrMonth & " " & LStrYear
                End If
                
                Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
            End If
            If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
            LSaudaID = Get_SaudaID(LSSaudaCode)
            lbparty = LClientCode
            lsparty = LBrokerCode
            mbparty = Get_ACCT_EX(LExID, lbparty)
            If LenB(mbparty) < 1 Then GoTo EFlag_Next
            MSPARTY = Get_ACCT_EX(LExID, lsparty)
            If LenB(MSPARTY) < 1 Then GoTo EFlag_Next
            MCount = MCount + 1
            LOConNo = str(MCount)
        ElseIf LExFileType = "36" Then
            If IsNull(TxtRec!F1) Then GoTo EFlag_Next
            LOConNo = TxtRec!F1
            A = InStr(TxtRec!F5, "-")
            LEXHCODE = Left(TxtRec!F5, A - 1)
            If InStr(TxtRec!f6, "/") Then
                LSMaturity = DateValue(Left(TxtRec!f6, 10))
            Else
                LSMaturity = DateValue(Left(TxtRec!f6, 2) & "/" & Mid(TxtRec!f6, 4, 3) & "/" & Right(TxtRec!f6, 2))
            End If
            If TxtRec!F15 = "2" Then LPtyContype = "S"
            LQTY = Val(TxtRec!f16):                    LRATE = Val(TxtRec!F17)
            If Val(TxtQtyMultipler.text & vbNullString) <> 0 Then LQTY = LQTY * Val(TxtQtyMultipler.text)
            LSCondate = DateValue(Left(TxtRec!F24, 10))
            LContime = Right(TxtRec!F24, 5)
            mysql = "SELECT EXID,ITEMID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE ='" & LEXHCODE & "'"
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            If Not TRec.EOF Then
                LSItemCode = TRec!ITEMCODE
                LLOT = TRec!lot
                LSExCode = TRec!EXCHANGECODE
                LExID = TRec!EXID
                LItemID = TRec!itemid
            Else
                LMsgBox = " Create New Commodity " & LEXHCODE & ""
                ImportIssues (LMsgBox)
                GoTo EFlag_Next
            End If
            Set TRec = Nothing:                    Set TRec = New ADODB.Recordset
            mysql = "SELECT SAUDACODE FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE =" & LItemID & " "
            mysql = mysql & " AND INSTTYPE ='" & LSInstType & "'AND OPTTYPE='" & LOptType & "' And STRIKEPRICE =" & LStrike & ""
            mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "yyyy/mm/dd") & "'"
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If Not TRec.EOF Then
                LSSaudaCode = TRec!saudacode
            Else
                If LSInstType = "FUT" Then
                    LSSaudaCode = LSItemCode & " " & month(LSMaturity) & " " & Year(LSMaturity)
                Else
                    LSSaudaCode = LSItemCode & " OPT" & LOptType & " " & LStrike & " " & LStrMonth & " " & LStrYear
                End If
                LExID = Get_ExID(LSExCode)
                Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LEXHCODE, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
            End If
            If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
            LSaudaID = Get_SaudaID(LSSaudaCode)
            mbparty = LClientCode
            MSPARTY = LExCont
            MCount = MCount + 1
        End If
        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
        If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
        Call Add_To_Ctr_D(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LQTY, LRATE, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, LExFileType, "Y", LExID, LItemID, LSaudaID)
EFlag_Next:
        TxtRec.MoveNext
    Wend
End If
Cnn.CommitTrans
    CNNERR = False
    Exit Sub
End Sub
'Private Sub Save_NCDEX_AllFile()
'    On Error GoTo ERR1
'    Dim TxtPath As String:          Dim LFileName As String:        Dim LFileSource As String:       Dim LFolderName As String
'    Dim LMFLPath As String:         Dim LTradeDt As Date:           Dim LExcelFileType As String:    Dim TRec As ADODB.Recordset
'    For LTradeDt = vcDTP1.Value To vcDTP2.Value
'        LTradeDt = vcDTP1.Value
'        Set TRec = Nothing
'        Set TRec = New ADODB.Recordset
'        MYSQL = "SELECT EXFILETYPE,FOLDERNAME,CONTRACTACC,BROKERTYPE,PARTYAS,CLIENTCODE FROM EXFILE WHERE COMPCODE =" & GCompCode & " "
'        MYSQL = MYSQL & " AND EXCODE='NCDX' ORDER BY FILEID "
'        TRec.Open MYSQL, Cnn, adOpenForwardOnly, adLockReadOnly
'        Do While Not TRec.EOF
'            LClientCode = vbNullString
'            LExCont = TRec!ContractACC
'            LBrokerType = TRec!BROKERTYPE
'            LFolderName = TRec!FOLDERNAME
'            LPartyAs = TRec!PARTYAS
'            LExcelFileType = TRec!EXFILETYPE
'            If LPartyAs = "F" Then LClientCode = TRec!CLIENTCODE
'            Select Case UCase(LBrokerType)
'                Case "M"
'                    TxtPath = CStr(Left$(LTradeDt, 2)) & CStr(Mid(LTradeDt, 4, 2)) & CStr(Year(LTradeDt)) & IIf(LMemberId = "", "", "_" & LMemberId) & ".TXT"
'                Case "E"
'                    TxtPath = CStr(Left$(LTradeDt, 2)) & CStr(Mid(LTradeDt, 4, 2)) & CStr(Year(LTradeDt)) & ".CSV"
'                Case Else
'                    TxtPath = CStr(Left$(LTradeDt, 2)) & CStr(Mid(LTradeDt, 4, 2)) & CStr(Year(LTradeDt)) & ".TXT"
'            End Select
'            LFileName = App.Path & LFolderName & TxtPath
'            LMFLPath = App.Path & LFolderName
'
'            LFileSource = Left$(LFileName, (Len(LFileName) - Len(TxtPath)) - 1) & ""
'            Call GET_JCnn("\" & LFolderName & "\;")
'
'            If Not FileExist(LFileName) Then
'                MsgBox LFileName & "  file not found", vbCritical
'            Else
'                If LBrokerType = "X" Then
'                    Call Create_SchemaFile_Nextra(LMFLPath, TxtPath)
'                Else
'                    Call Create_SchemaFile(LMFLPath, TxtPath)
'                End If
'                Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
'                TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
'                Call Save_NCDEX_Trade(LOverwrite)
'            End If
'
'            TRec.MoveNext
'        Loop
'    Next
'    Exit Sub
'ERR1:
'
'    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
'    If CNNERR = True Then
        
'        Cnn.RollbackTrans: CNNERR = False
'    End If
'End Sub

Sub Save_AllExFile(lexceltype As Integer)
'Dim LIFLAG As Boolean:
Dim lbparty As String:          Dim lsparty As String:          Dim LBQty As Double
Dim LSQty As Double:            Dim LBRate As Double:           Dim LSRate As Double:           Dim ldate As Date
Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
Dim MCount As Long:             Dim LSItemCode As String:       Dim LConType As String:         Dim LPtyContype As String
Dim LSConSno As Long:           Dim LQTY As Double:             Dim LRATE As Double:            Dim LSInstType As String
Dim LOptType As String:         Dim LStrike As Double:          Dim LContime As String:         Dim LOrdNo As String
Dim LOrdTime As String:         Dim LSSaudaCode As String:      Dim LCITEM As String:           Dim LSSauda As String
Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim ITExchangeCode As String:   Dim LOConNo As String
Dim StrDateLen As Integer:      Dim LSTRDATE As String:         Dim LMONTH As String:           Dim lyear As String
Dim LClient As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
Dim TRec As ADODB.Recordset:    Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String
Dim LEXHCODE As String:         Dim LSItemName As String:       Dim LSTRCONDATE  As String:     Dim A As Integer
Dim LFieldName As String:       Dim fld As ADODB.Field:         Dim LEx_Symbol  As String:      Dim LCMONTH As String
Dim LSaudaID As Long:           Dim LMFLPath As String:         Dim B As Integer:               Dim LSTR As String
Dim LExID As Integer:           Dim LItemID  As Integer
Dim LStrMonth As String
On Error GoTo err1
    
    ltradedt = vcDTP1.Value
    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
    Call GET_JCnn("\" & LFolderName & "\;")
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
        LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
    End If
    Set LFileSystemObject = Nothing
    
    LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
    If Not FileExist(LFileName) Then
        MsgBox LFileName & "  file not found", vbCritical
        Exit Sub
    Else
        LOverwrite = False
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
     End If
    Cnn.BeginTrans
    CNNERR = True
    LSCondate = ltradedt
    If lexceltype <> 50 Then
        If MsgBox("Are you Sure to Delete Trades of  " & LSCondate & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
            Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='" & lexceltype & "'"
        End If
    End If
    MCount = Get_Max_ConNo(LSCondate, 0)
    Do While Not TxtRec.EOF
        lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString
        LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
        LOrdTime = vbNullString:      LOptType = vbNullString:      LStrike = 0:                  LLOT = 0:
        LBQty = 0::                   LSQty = 0:                    LBRate = 0:                   LSRate = 0
        LSaudaID = 0
        LItemID = 0
        
        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
        Select Case lexceltype
            Case 40
                If IsNull(TxtRec!F7) Then GoTo EFlag_Next
                If Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s") Then GoTo EFlag_Next
                    LOConNo = TxtRec!F1:                        LOrdNo = (TxtRec!f3 & vbNullString)
                    lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
                    LPartyName = lbparty & " " & TxtRec!F5:                      LSTRCONDATE = Left$(TxtRec!f6, 10)
                    LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                    LPtyContype = UCase(Left(TxtRec!F7, 1))
                    lsparty = LBrokerCode
                    DoEvents
                   ' If Right(TxtRec!F9, 4) = "JUNE" Or Right(TxtRec!F9, 4) = "JULY" Then
                        A = Len(TxtRec!F9)
                        LEXHCODE = Left$(TxtRec!F9, A - 5)
                        LSTR = Right(TxtRec!F9, 5)
                        LStrMonth = Left(LSTR, 3)
                        lyear = "20" & Right(LSTR, 2)
                   ' ElseIf Right(TxtRec!F9, 3) = "JUN" Or Right(TxtRec!F9, 3) = "AUG" Or Right(TxtRec!F9, 3) = "JUL" Or Right(TxtRec!F9, 3) = "SEP" Or Right(TxtRec!F9, 3) = "OCT" Then
                    '    A = Len(TxtRec!F9)
                    '    LExhCode = Left$(TxtRec!F9, A - 3)
                    '    LStrMonth = Right(TxtRec!F9, 3)
                    'End If
                    'LYEAR = Year(LSCondate)
                    LSMaturity = DateValue("28/" & LStrMonth & "/" & lyear)
                    'If month(LSCondate) > month(LSMaturity) Then
                    '    LYEAR = (Year(LSCondate) + 1)
                    '    LSMaturity = DateValue("28/" & LStrMonth & "/" & LYEAR)
                    '    LMonth = month(LSMaturity)
                    'End If
                    If Right(TxtRec!F10, 1) = "K" Then
                        LBQty = Val(Left(TxtRec!F10, Len(TxtRec!F10) - 1)) * 1000
                    Else
                        LBQty = Val(TxtRec!F10)
                    End If
                    LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)):
                    LSRate = LBRate
                    'LSParty = LExCont
                    LLOT = 1
                    LEx_Symbol = LEXHCODE
                    mysql = "SELECT EXID,ITEMID ,ITEMCODE,EXCHANGECODE,LOT,EXHCODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE ='" & LEXHCODE & "'"
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If TRec.EOF Then
                        mysql = "SELECT ITEMCODE,EXCODE,LOT FROM CONTRACTMASTER WHERE EX_SYMBOL ='" & LEXHCODE & "'"
                        Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        Else
                            LSExCode = TRec!excode
                            LSItemCode = TRec!ITEMCODE
                            LEx_Symbol = LEXHCODE
                            LExID = Get_ExID(LSExCode)
                            LLOT = TRec!lot
                            LSItemCode = Create_ItemMast(LSItemCode, LSItemCode, LEXHCODE, LLOT, LSExCode, LExID)
                            LItemID = Get_ITEMID(LSItemCode)
                        End If
                    Else
                        LSExCode = TRec!EXCHANGECODE
                        LSItemCode = TRec!ITEMCODE
                        LEx_Symbol = TRec!EXHCODE
                        LExID = TRec!EXID
                        LItemID = TRec!itemid
                        LLOT = TRec!lot
                    End If
                    If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                    Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LItemID & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LOptType & "'," & LStrike & ""
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode
                        LSMaturity = TRec!MATURITY
                        LSaudaID = TRec!SAUDAID
                    Else
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                        If LSInstType <> "FUT" Then
                            mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                            mysql = mysql & " AND OPTTYPE='" & LOptType & "' AND STRIKEPRICE =" & LStrike & ""
                        Else
                            mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                        End If
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TRec.EOF Then
                            LSMaturity = TRec!MATURITY
                            LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LOptType, LStrike, LExID, LItemID)
                        Else
                            LMsgBox = "Please Import/Create New Contracts for Item/Script " & LEXHCODE & " " & LSMaturity & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        LSaudaID = Get_SaudaID(LSSaudaCode)
                    End If
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    If LSCondate > LSMaturity Then
                        LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                        ImportIssues (LMsgBox)
                            'GoTo EFlag_Next
                    End If
                    If LBQty <> 0 Then
                        mbparty = Get_ACCT_EX(LExID, lbparty)
                        If LenB(mbparty) < 1 Then
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                        End If
                        MSPARTY = lsparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        If LenB(MSPARTY) < 1 Then
                            LMsgBox = " Broker does Not Exist " & lsparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                        Cnn.Execute mysql
                        MCount = MCount + 1:
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                        If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
                        Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, Trim(str(lexceltype)), "Y", LExID, LItemID, LSaudaID)
                    End If
            Case 50
                If IsNull(TxtRec!F4) Then GoTo EFlag_Next
                If Not (Left(TxtRec!F4, 1) = "b" Or Left(TxtRec!F4, 1) = "s") Then GoTo EFlag_Next
                LOConNo = (TxtRec!F2 & vbNullString)
                LOrdNo = (TxtRec!F2 & vbNullString)
                lbparty = LClientCode
               
                
                LSTRCONDATE = Left$(TxtRec!F1, 10)
                LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                LPtyContype = UCase(Left(TxtRec!F4, 1))
                If IsNull(TxtRec!f3) Then GoTo EFlag_Next
                If LenB(TxtRec!f3) < 1 Then GoTo EFlag_Next
                A = InStr(TxtRec!f3, "-")
                If A <> 0 Then
                    LEXHCODE = Trim(Left(TxtRec!f3, A - 1))
                    LSTRCONDATE = Right(TxtRec!f3, 3)
                    LCMONTH = Left(LSTRCONDATE, 1)
                    lyear = "20" & Right(LSTRCONDATE, 2)
                    LMONTH = Get_CMX_Month(Left(LSTRCONDATE, 1))
                    LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                    LSMaturity = DateValue(LSTRCONDATE)
                    If Right(TxtRec!f6, 1) = "K" Then
                        LBQty = Val(Left(TxtRec!f6, Len(TxtRec!f6) - 1)) * 1000
                    Else
                        LBQty = Val(TxtRec!f6)
                    End If
                    LBRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                    LSRate = LBRate
                    lsparty = LExCont
                Else
                    A = Len(TxtRec!f3)
                    LEXHCODE = Left(TxtRec!f3, A - 3)
                    LSTRCONDATE = Right(TxtRec!f3, 3)
                    LCMONTH = Left(LSTRCONDATE, 1)
                    lyear = "20" & Right(LSTRCONDATE, 2)
                    LMONTH = Get_CMX_Month(Left(LSTRCONDATE, 1))
                    LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                    LSMaturity = DateValue(LSTRCONDATE)
                    LBRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                    LBQty = Val(TxtRec!f6)
                    LSRate = LBRate
                    lsparty = LBrokerCode
                End If
                LLOT = 1
                LEx_Symbol = LEXHCODE
                mysql = "SELECT EXID,ITEMID,ITEMCODE,EXCHANGECODE,LOT,EXHCODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE ='" & LEXHCODE & "'"
                Set TRec = Nothing: Set TRec = New ADODB.Recordset
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If TRec.EOF Then
                    mysql = "SELECT ITEMCODE,EXCODE,LOT FROM CONTRACTMASTER WHERE EX_SYMBOL ='" & LEXHCODE & "'"
                    Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If TRec.EOF Then
                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    Else
                        LSExCode = TRec!excode
                        LSItemCode = TRec!ITEMCODE
                        LEx_Symbol = LEXHCODE
                        LLOT = TRec!lot
                        
                        LExID = Get_ExID(LSExCode)
                        LSItemCode = Create_ItemMast(LSItemCode, LSItemCode, LEXHCODE, LLOT, LSExCode, LExID)
                        LItemID = Get_ITEMID(LSItemCode)
                    End If
                Else
                    LSExCode = TRec!EXCHANGECODE
                    LSItemCode = TRec!ITEMCODE
                    LEx_Symbol = TRec!EXHCODE
                    LLOT = TRec!lot
                    LExID = TRec!EXID
                    LItemID = TRec!itemid
                End If
                If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
                mysql = "SELECT SAUDACODE,MATURITY FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE=" & LItemID & " "
                mysql = mysql & " AND MATURITY >= LSCondate AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode
                    LSMaturity = TRec!MATURITY
                Else
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                    If LSInstType <> "FUT" Then
                        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                        mysql = mysql & " AND OPTTYPE='" & LOptType & "' AND STRIKEPRICE =" & LStrike & ""
                    Else
                        mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                    End If
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        LSMaturity = TRec!MATURITY
                        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LOptType, LStrike, LExID, LItemID)
                    Else
                        LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & lyear
                        If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                            LSSaudaCode = LSExCode & " " & LSSaudaCode
                            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                        End If
                        LExID = Get_ExID(LSExCode)
                        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LOptType, LStrike, LSExCode, 1, LExID, LItemID)
                    End If
                End If
                If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                LSaudaID = Get_SaudaID(LSSaudaCode)
                If LBQty <> 0 Then
                    mbparty = Get_AccountDCode(lbparty)
                    If LenB(mbparty) < 1 Then
                        MsgBox "Client A/c not found Pls Create Client A/C  "
                        Cnn.RollbackTrans
                        Exit Sub
                    Else
                       MSPARTY = LBrokerCode
                       If LenB(MSPARTY) < 1 Then
                            MsgBox " Client does Not Exist " & lbparty & ""
                            Cnn.RollbackTrans
                            Exit Sub
                        End If
                        mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                        Cnn.Execute mysql
                        MCount = MCount + 1:
                        If InStr(LBillExId, str(LExID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LExID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
            
                
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                        Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, Trim(str(lexceltype)), "Y", LExID, LItemID, LSaudaID)
                        MSPARTY = LBrokerCode2
                        
                        LOConNo = LOConNo & "A"
                        mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                        Cnn.Execute mysql
                        MCount = MCount + 1:
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSaudaID, LItemID, LExID)
                        Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LOptType, LStrike, Trim(str(lexceltype)), "Y", LExID, LItemID, LSaudaID)
                    End If
                End If
        End Select
EFlag_Next:
        TxtRec.MoveNext
    Loop
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub

err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
     
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub


Sub Save_AllTrade_ExcelNew(lexceltype As Integer)
Dim LIFLAG As Boolean:          Dim LSQty As Double:          Dim ldate As Date: Dim ltradedt As Date:          Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String: Dim MCount As Long:            Dim LConType As String:         Dim LSConSno As Long:           Dim LQTY As Double:
Dim LRATE As Double:            Dim LContime As String:: Dim StrDateLen As Integer: Dim LClient As String:         Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:    Dim LLOT As Double:             Dim LUserId As String:
Dim LSItemName As String:       Dim LFieldName As String:      Dim fld As ADODB.Field:         Dim LCMONTH As String
Dim LMFLPath As String:         Dim B As Integer:              Dim LStrMonth As String:  Dim lday As Integer:            Dim LAcExCode As String:        Dim C As Integer
Dim LMXDate As Date:            Dim LSettleRate As Double:     Dim Vday As Integer:            Dim Vmonth As String: Dim Vrate As Double:           Dim Vlastchar As String:       Dim VYear As String:
Dim TRec As ADODB.Recordset:
Dim TempRec1 As ADODB.Recordset


On Error GoTo err1
Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset: Call GET_JCnn("\" & LFolderName & "\;"): MSPARTY = LBrokerCode
Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
    LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
End If
Set LFileSystemObject = Nothing: Cnn.BeginTrans:   CNNERR = True:
For ltradedt = vcDTP1.Value To vcDTP2.Value
    LNoTrd = 0: TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV": LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
    If Not FileExist(LFileName) Then
        LMsgBox = LFileName & "  file not found" ', vbCritical
        ImportIssues (LMsgBox)
    Else
        If lexceltype = 25 Then
            LMFLPath = App.Path & "\" & LFolderName & "\":                Call Create_Schema_Excel25(LMFLPath, TxtPath)
        End If
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset: TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        If Not TxtRec.EOF Then
                TxtRec.MoveFirst
                If TxtRec.RecordCount > 1 Then
                    TxtRec.MoveNext
                End If
                If UCase(Trim(TxtRec!F4)) = "POSITION" Then
                    Set TempRec1 = Nothing
                    Set TempRec1 = TxtRec.Clone
                    TempRec1.MoveFirst
                    TempRec1.MoveNext
                
                    Set TxtRec = Nothing
                    Set TxtRec = New ADODB.Recordset
                    TxtRec.Fields.Append "f1", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f2", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f3", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f4", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f5", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f6", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f7", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f8", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f9", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f10", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f11", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f12", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f13", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f14", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f15", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f16", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f17", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f18", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f19", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f20", adVarChar, 100, adFldIsNullable
                    TxtRec.Open , , adOpenKeyset, adLockOptimistic
    
                    TempRec1.MoveNext
                    While Not TempRec1.EOF
                        TxtRec.AddNew
                        TxtRec.Fields(0).Value = TempRec1!F1
                        TxtRec.Fields(1).Value = TempRec1!F2
                        TxtRec.Fields(2).Value = TempRec1!f3
                        TxtRec.Fields(3).Value = TempRec1!F5
                        TxtRec.Fields(4).Value = TempRec1!f6
                        TxtRec.Fields(5).Value = TempRec1!F7
                        TxtRec.Fields(6).Value = TempRec1!F8
                        TxtRec.Fields(7).Value = TempRec1!F9
                        TxtRec.Fields(8).Value = TempRec1!F10
                        TxtRec.Fields(9).Value = TempRec1!f11
                        TxtRec.Fields(10).Value = TempRec1!f12
                        TxtRec.Fields(11).Value = TempRec1!F13
                        TxtRec.Fields(12).Value = TempRec1!F14
                        TxtRec.Fields(13).Value = TempRec1!F15
                        TxtRec.Fields(14).Value = TempRec1!f16
                        TxtRec.Fields(15).Value = TempRec1!F17
                        TxtRec.Fields(16).Value = TempRec1!F18
                        TxtRec.Fields(17).Value = TempRec1!f19
                        TxtRec.Fields(18).Value = TempRec1!F20
                        TxtRec.Fields(19).Value = TempRec1!F21
                        TxtRec.Update
                        TempRec1.MoveNext
                    Wend
                End If
        
        
        
            FlagDataTrf = True: CNNERR = True
            TxtRec.MoveFirst: LSCondate = DateValue(ltradedt): ldate = LSCondate
             'If MsgBox("Do You Want to Delete Trades of  Folder " & LFolderName & "  File Type " & lexceltype & " Of " & LSCondate, vbQuestion + vbYesNo, "Confirm") = vbYes Then
                If lexceltype = 25 Then
                 '   If Check39.Value = 1 Then
                  '      Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='" & lexceltype & "'"
                   ' Else
                    '    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND EXCODE ='" & LSExCode & "'AND FILETYPE='" & lexceltype & "'"
                   ' End If
                Else
                    If lexceltype = 37 Or lexceltype = 38 Or lexceltype = 45 Or lexceltype = 60 Then
            'Else
                 '   Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT = 1 AND FILETYPE='" & Trim(str(lexceltype)) & "'"
            'End If
            End If
        End If
        LNoTrd = 0:  MCount = Get_Max_ConNo(CDate(LSCondate), 0)
        While Not TxtRec.EOF
            lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString:                    LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
            LMONTH = "": lyear = "": LSMaturity = "01/01/1900"
            LOrdTime = vbNullString:      LSOptType = vbNullString:     LSStrike = 0:                 LLOT = 0:                    LBQty = 0:                    LSQty = 0:                    LBRate = 0:                   LSRate = 0
            LSSaudaID = 0:                LSItemid = 0: LSEx_Symbol = vbNullString:                    LMonthType = "M"
            Vexcelcolval = "":
            Vitemcode = "":                    Vday = 0:                    Vmonth = "":                    Vrate = 0:                    Vlastchar = "":                    Vdate = "01/01/1900"
            If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                Select Case lexceltype
                    Case 37, 45, 46, 50
                        LSExCode = vbNullString
                        If IsNull(TxtRec!F7) Then GoTo EFlag_Next
                        If Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s") Or TxtRec!F14 = "Rollover" Or (TxtRec!F20 = "[rollover close]" Or TxtRec!F20 = "[rollover open]") Then GoTo EFlag_Next
                        LOConNo = TxtRec!F1: LOrdNo = (TxtRec!f3 & vbNullString)
                                                                                           
                        If LPartyAs = "F" Then
                            lbparty = LClientCode
                        Else
                            LAcExCode = TxtRec!F4: lbparty = TxtRec!F4 & vbNullString:
                            If InStr(lbparty, " ") Then
                                lbparty = Replace(lbparty, " ", vbNullString)
                            End If
                            LPartyName = lbparty & " " & TxtRec!F5:
                        End If
                        LSTRCONDATE = Left$(TxtRec!f6, 10): LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4)): LSPtyContype = UCase(Left(TxtRec!F7, 1))

                        A = InStr(TxtRec!F9, "/")
                        
                        If lexceltype = 50 Then

                            If Right(TxtRec!F9, 5) <> "JAN24" And Right(TxtRec!F9, 5) <> "JUN23" And ((Right(TxtRec!F9, 3) = "Z23" Or Right(TxtRec!F9, 3) = "F23" Or Right(TxtRec!F9, 3) = "G23" Or Right(TxtRec!F9, 3) = "Q23" Or Right(TxtRec!F9, 3) = "H23" _
                                Or Right(TxtRec!F9, 3) = "J23" Or Right(TxtRec!F9, 3) = "K23" Or Right(TxtRec!F9, 3) = "M23" Or Right(TxtRec!F9, 3) = "N23" _
                                Or Right(TxtRec!F9, 3) = "U23" Or Right(TxtRec!F9, 3) = "V23" Or Right(TxtRec!F9, 3) = "X23" _
                                Or Right(TxtRec!F9, 3) = "Z24" Or Right(TxtRec!F9, 3) = "F24" Or Right(TxtRec!F9, 3) = "G24" Or Right(TxtRec!F9, 3) = "Q24" Or Right(TxtRec!F9, 3) = "H24" _
                                Or Right(TxtRec!F9, 3) = "J24" Or Right(TxtRec!F9, 3) = "K24" Or Right(TxtRec!F9, 3) = "M24" Or Right(TxtRec!F9, 3) = "N24" _
                                Or Right(TxtRec!F9, 3) = "U24" Or Right(TxtRec!F9, 3) = "V24" Or Right(TxtRec!F9, 3) = "X24") And Right(TxtRec!F9, 5) <> "NOV23" And Right(TxtRec!F9, 5) <> "AUG23") Then
                                A = Len(TxtRec!F9): LEXHCODE = Left(TxtRec!F9, A - 3)
                                LSTR = Right(TxtRec!F9, 3): LMONTH = Get_CMX_Month(Left(LSTR, 1))
                                lyear = "20" & Right(LSTR, 2): LSMaturity = DateValue("28/" & LMONTH & "/" & lyear)
                            ElseIf Left(TxtRec!F9, 9) = "GIFTNIFTY" And (Right(TxtRec!F9, 3) <> "JAN" And Right(TxtRec!F9, 3) <> "JUN") And (Right(TxtRec!F9, 1) = "Z" Or Right(TxtRec!F9, 1) = "F" Or Right(TxtRec!F9, 1) = "G" Or Right(TxtRec!F9, 1) = "Q" _
                                Or Right(TxtRec!F9, 1) = "J" Or Right(TxtRec!F9, 1) = "K" Or Right(TxtRec!F9, 1) = "M" Or Right(TxtRec!F9, 1) = "N" _
                                Or Right(TxtRec!F9, 1) = "U" Or Right(TxtRec!F9, 1) = "V" Or Right(TxtRec!F9, 1) = "X" Or Right(TxtRec!F9, 1) = "H") Then
                                A = Len(TxtRec!F9): LEXHCODE = Left(TxtRec!F9, A - 1)
                                LMONTH = Get_CMX_Month(Right(TxtRec!F9, 1))
                                lyear = str(Year(LSCondate))
                                lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                            Else
                                A = InStr(TxtRec!F9, "_")
                                If Left(TxtRec!F9, 6) = "BAJAJ_" Then
                                    A = InStr(7, TxtRec!F9, "_"):                                    LEXHCODE = Left(TxtRec!F9, A - 1)
                                ElseIf Left(TxtRec!F9, 3) = "M_M" Then
                                    A = InStr(3, TxtRec!F9, "_"):                                    LEXHCODE = Left(TxtRec!F9, A - 1)
                                ElseIf Left(TxtRec!F9, 3) = "L_T" Then
                                    A = InStr(3, TxtRec!F9, "_"):                                    LEXHCODE = Left(TxtRec!F9, A - 1)
                                Else
                                    If Right(TxtRec!F9, 3) = "JAN" Or Right(TxtRec!F9, 3) = "FEB" Or Right(TxtRec!F9, 3) = "MAR" Or Right(TxtRec!F9, 3) = "APR" Or _
                                        Right(TxtRec!F9, 3) = "MAY" Or Right(TxtRec!F9, 3) = "JUN" Or Right(TxtRec!F9, 3) = "JUL" Or Right(TxtRec!F9, 3) = "AUG" Or _
                                        Right(TxtRec!F9, 3) = "SEP" Or Right(TxtRec!F9, 3) = "OCT" Or Right(TxtRec!F9, 3) = "NOV" Or Right(TxtRec!F9, 3) = "DEC" Then
                                        A = Len(TxtRec!F9)
                                        'If Left(TxtRec!f9, 9) = "GIFTNIFTY" Then
                                         '   MsgBox ""
                                       ' End If
                                        If InStr(TxtRec!F9, "-") And Left(TxtRec!F9, 10) <> "MCDOWELL-N" And Left(TxtRec!F9, 10) <> "BAJAJ-AUTO" Then
                                            If Left(TxtRec!F9, 9) = "GIFTNIFTY" Then
                                                 LEXHCODE = Left(TxtRec!F9, A - 3)
                                            Else
                                                 LEXHCODE = Left(TxtRec!F9, A - 4)
                                            End If

                                            LMONTH = Right(TxtRec!F9, 3): lyear = str(Year(LSCondate))
                                        '    lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                         '   LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                                        Else
                                            LEXHCODE = Left(TxtRec!F9, A - 3)
                                        
                                            LMONTH = Right(TxtRec!F9, 3): lyear = str(Year(LSCondate))
                                          ''  lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                           '' LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                                        End If
                                   ElseIf Right(TxtRec!F9, 5) = "JAN24" Or Right(TxtRec!F9, 5) = "FEB24" Or Right(TxtRec!F9, 5) = "MAR24" Or Right(TxtRec!F9, 5) = "APR24" Or _
                                        Right(TxtRec!F9, 5) = "MAY23" Or Right(TxtRec!F9, 5) = "JUN23" Or Right(TxtRec!F9, 5) = "JUL23" Or Right(TxtRec!F9, 5) = "AUG23" Or _
                                        Right(TxtRec!F9, 5) = "SEP23" Or Right(TxtRec!F9, 5) = "OCT23" Or Right(TxtRec!F9, 5) = "NOV23" Or Right(TxtRec!F9, 5) = "DEC23" Or _
                                        Right(TxtRec!F9, 4) = "FEB2" Or Right(TxtRec!F9, 4) = "JAN2" Or Right(TxtRec!F9, 4) = "MAR2" Or Right(TxtRec!F9, 4) = "APR2" Or _
                                        Right(TxtRec!F9, 4) = "MAY2" Or Right(TxtRec!F9, 4) = "JUN2" Or Right(TxtRec!F9, 4) = "JUL2" Or Right(TxtRec!F9, 4) = "AUG2" Or _
                                        Right(TxtRec!F9, 4) = "SEP2" Or Right(TxtRec!F9, 4) = "OCT2" Or Right(TxtRec!F9, 4) = "NOV2" Or Right(TxtRec!F9, 4) = "DEC2" Or TxtRec!F9 = "SGXNIFTY" Or TxtRec!F9 = "GIFTNIFTYQ" Or TxtRec!F9 = "GIFTNIFTYU" Or TxtRec!F9 = "GIFTNIFTYV" Or TxtRec!F9 = "GIFTNIFTYN" Or Left(TxtRec!F9, 9) = "SGXNIFTYN" Then
                                       

                                            If (Right(TxtRec!F9, 4) = "FEB2" Or Right(TxtRec!F9, 4) = "JAN2" Or Right(TxtRec!F9, 4) = "MAR2" Or Right(TxtRec!F9, 4) = "APR2" Or _
                                                Right(TxtRec!F9, 4) = "MAY2" Or Right(TxtRec!F9, 4) = "JUN2" Or Right(TxtRec!F9, 4) = "JUL2" Or Right(TxtRec!F9, 4) = "AUG2" Or _
                                                Right(TxtRec!F9, 4) = "SEP2" Or Right(TxtRec!F9, 4) = "OCT2" Or Right(TxtRec!F9, 4) = "NOV2" Or Right(TxtRec!F9, 4) = "DEC2") And Right(TxtRec!F9, 2) <> "22" Then
                                                A = Len(TxtRec!F9)
                                                LEXHCODE = Left(TxtRec!F9, A - 4)
                                                LMONTH = Left(Right(TxtRec!F9, 4), 3):
                                                lyear = Year(LSCondate)
                                             ''   lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                               '' LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                                            Else
                                                If TxtRec!F9 = "SGXNIFTY" Then
                                                    LEXHCODE = "SGXNIFTYPM"
                                                    LMONTH = "MAR"
                                                    lyear = Year(LSCondate)
                                                ElseIf TxtRec!F9 = "SGXNIFTYQ" Then
                                                    LEXHCODE = "SGXNIFTY"
                                                    LMONTH = month(GFinEnd)
                                                    lyear = Year(GFinEnd)
                                                    LMonthType = "C"
                                                ElseIf TxtRec!F9 = "GIFTNIFTYN" Or TxtRec!F9 = "GIFTNIFTYQ" Or TxtRec!F9 = "GIFTNIFTYU" Or TxtRec!F9 = "GIFTNIFTYV" Then
                                                    LEXHCODE = "GIFTNIFTYN"
                                                    LMONTH = month(GFinEnd)
                                                    lyear = Year(GFinEnd)
                                                    LMonthType = "C"
                                                ElseIf TxtRec!F9 = "SGXNIFTYN" Then
                                                    LEXHCODE = "SGXNIFTYN"
                                                    LMONTH = month(LSCondate)
                                                    lyear = Year(LSCondate)
                                                    LMonthType = "C"
                                                ElseIf TxtRec!F9 = "SGXNIFTYN2" Then
                                                    LEXHCODE = "SGXNIFTYN"
                                                    LMONTH = month(LSCondate) + 1
                                                    lyear = Year(LSCondate)
                                                    If LMONTH = 13 Then
                                                        LMONTH = 1
                                                        lyear = lyear + 1
                                                    End If
                                                    LMonthType = "N"
                                                Else
                                                    A = Len(TxtRec!F9)
                                                    LEXHCODE = Left(TxtRec!F9, A - 5)
                                                    LMONTH = Left(Right(TxtRec!F9, 5), 3): lyear = Year(LSCondate)
                                                End If
                                               '' lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                                ''LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                                           End If
                                   ElseIf InStr(TxtRec!F9, "JANUARY") <> 0 Or InStr(TxtRec!F9, "FEBUARY") <> 0 Or InStr(TxtRec!F9, "OCTOBER") <> 0 Then
                                            If Right(TxtRec!F9, 2) = "22" Or Right(TxtRec!F9, 2) = "23" Then
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 9)
                                                LMONTH = Left(Right(TxtRec!F9, 9), 3)
                                                lyear = Right(TxtRec!F9, 2)
                                            Else
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 7)
                                                LMONTH = Left(Right(TxtRec!F9, 7), 3)
                                                lyear = Year(ltradedt)
                                            End If
                                    ElseIf InStr(TxtRec!F9, "MARCH") <> 0 Or InStr(TxtRec!F9, "APRIL") <> 0 Then
                                            If Right(TxtRec!F9, 2) = "22" Or Right(TxtRec!F9, 2) = "23" Then
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 7)
                                                LMONTH = Left(Right(TxtRec!F9, 7), 3)
                                                lyear = Right(TxtRec!F9, 2)
                                            Else
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 5)
                                                LMONTH = Left(Right(TxtRec!F9, 5), 3)
                                                lyear = Year(ltradedt)
                                            End If
                                    ElseIf InStr(TxtRec!F9, "MAY") <> 0 Then
                                            If Right(TxtRec!F9, 2) = "22" Or Right(TxtRec!F9, 2) = "23" Then
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 5)
                                                LMONTH = Left(Right(TxtRec!F9, 5), 3)
                                                lyear = Right(TxtRec!F9, 2)
                                            Else
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 3)
                                                LMONTH = Left(Right(TxtRec!F9, 3), 3)
                                                lyear = Year(ltradedt)
                                            End If
                                    ElseIf InStr(TxtRec!F9, "JUNE") <> 0 Or InStr(TxtRec!F9, "JULY") <> 0 Then
                                            If Right(TxtRec!F9, 2) = "22" Or Right(TxtRec!F9, 2) = "23" Then
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 6)
                                                LMONTH = Left(Right(TxtRec!F9, 6), 3)
                                                lyear = Right(TxtRec!F9, 2)
                                            Else
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 4)
                                                LMONTH = Left(Right(TxtRec!F9, 4), 3)
                                                lyear = Year(ltradedt) 'Right(TxtRec!f9, 2)
                                            End If
                                    ElseIf InStr(TxtRec!F9, "AUGUST") <> 0 Then
                                            If Right(TxtRec!F9, 2) = "22" Or Right(TxtRec!F9, 2) = "23" Then
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 8)
                                                LMONTH = Left(Right(TxtRec!F9, 8), 3)
                                                lyear = Right(TxtRec!F9, 2)
                                            Else
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 6)
                                                LMONTH = Left(Right(TxtRec!F9, 6), 3)
                                                lyear = Year(ltradedt)
                                            End If
                                    ElseIf InStr(TxtRec!F9, "SEPTEMBER") <> 0 Or InStr(TxtRec!F9, "NOVEMBER") <> 0 Or InStr(TxtRec!F9, "DECEMBER") <> 0 Then
                                            If Right(TxtRec!F9, 2) = "22" Or Right(TxtRec!F9, 2) = "23" Then
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 10)
                                                LMONTH = Left(Right(TxtRec!F9, 10), 3)
                                                lyear = Right(TxtRec!F9, 2)
                                            Else
                                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 8)
                                                LMONTH = Left(Right(TxtRec!F9, 8), 3)
                                                lyear = Year(ltradedt)
                                            End If
                                    End If
                                End If
                                lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)

                            End If
                            LMonthType = "M"
                        ElseIf lexceltype = 46 Then
                            Call proc_46
                        ElseIf lexceltype = 45 Then
                            LSExCode = vbNullString: A = InStr(TxtRec!F9, "-")
                            
                            If (Left(TxtRec!F9, 2) = "YM" Or Left(TxtRec!F9, 2) = "DD" Or Left(TxtRec!F9, 2) = "NQ" Or Left(TxtRec!F9, 2) = "CL" Or Left(TxtRec!F9, 2) = "ES" Or Left(TxtRec!F9, 3) = "NKD" Or Left(TxtRec!F9, 2) = "HG" _
                            Or Left(TxtRec!F9, 3) = "NAS" Or Left(TxtRec!F9, 4) = "NASD" Or Left(TxtRec!F9, 3) = "DOW" Or Left(TxtRec!F9, 2) = "ES" Or Left(TxtRec!F9, 2) = "GC" Or Left(TxtRec!F9, 2) = "SI" _
                            Or Left(TxtRec!F9, 4) = "NIKK" Or Left(TxtRec!F9, 3) = "DAX" Or Left(TxtRec!F9, 3) = "GBP" Or Left(TxtRec!F9, 2) = "SP") _
                            And Left(TxtRec!F9, 6) <> "SILVER" And Left(TxtRec!F9, 3) <> "SIE" And A <> 0 And Left(TxtRec!F9, 6) <> "ESCORT" And Left(TxtRec!F9, 7) <> "SIEMENS" Then
                                    A = InStr(TxtRec!F9, "-"): LEXHCODE = Left(TxtRec!F9, A - 4)
                                    LSTR = Right(TxtRec!F9, 5): lyear = "20" & Mid(LSTR, 2, 2): LCMONTH = Left(LSTR, 1): LMONTH = Get_CMX_Month(LCMONTH)
                                    
                                    'if lmonth
                                    lyear = lyear + 1
                                    LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE): LMonthType = "M"
                            Else
                                A = InStr(TxtRec!F9, "-")
                                If InStr(TxtRec!F9, "MCDOWELL-N") <> 0 And TxtRec!F9 <> "MCDOWELL-NOV" And TxtRec!F9 <> "NAM-INDIA" And InStr(TxtRec!F9, "SGX-NIFTY") <> 0 And InStr(TxtRec!F9, "BAJAJ-AUTO") <> 0 Then
                                    A = 0
                                End If
                                
                                If A <> 0 Then
                                    'LSTR = UCase(Left(TxtRec!f9, A - 1))
                                    LSTR = TxtRec!F9
                                    If Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "MAR" Or Right(LSTR, 3) = "APR" _
                                    Or Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" _
                                    Or Right(LSTR, 3) = "SEP" Or Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then
                                        LEXHCODE = Mid(TxtRec!F9, 1, A - 1)
                                        LMONTH = Right(LSTR, 3): lyear = Year(LSCondate)
                                        
                                        lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                        
                                        LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                        If month(LSMaturity) < month(LSCondate) Then
                                            lyear = (Year(LSCondate) + 1): LSTRCONDATE = lday & "/" & month(LSMaturity) & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                        End If
                                        LMonthType = "M":
                                    Else
                                        If (Right(UCase(TxtRec!F9), 5) <> "-NXAN" Or Right(UCase(TxtRec!F9), 4) <> "-NXM" Or Right(UCase(TxtRec!F9), 4) <> "-NXV" Or Right(UCase(TxtRec!F9), 4) <> "-NXC") Then
                                            If Right(UCase(TxtRec!F9), 4) = "-NXC" Or Right(UCase(TxtRec!F9), 4) = "-NXM" Or Right(UCase(TxtRec!F9), 4) = "-NXV" Or Right(UCase(TxtRec!F9), 4) = "-NXD" Then
                                                LEXHCODE = Mid(TxtRec!F9, 1, Len(TxtRec!F9) - 4):                                                LMonthType = "N"
                                            ElseIf Right(UCase(TxtRec!F9), 5) = "-NXAN" Then
                                                LEXHCODE = Mid(TxtRec!F9, 1, Len(TxtRec!F9) - 5):                                                LMonthType = "N"
                                            Else
                                                If Right(UCase(TxtRec!F9), 2) = "-D" Then
                                                    LMonthType = "C": LEXHCODE = Mid(TxtRec!F9, 1, A - 1)
                                                Else
                                                    If Right(TxtRec!F9, 2) = "23" Or Right(TxtRec!F9, 2) = "22" Then
                                                        LEXHCODE = Mid(TxtRec!F9, 1, A - 1): LMonthType = "C": LSTR = Right(TxtRec!F9, 3): lyear = "20" & Mid(LSTR, 2, 2)
                                                        LCMONTH = Left(LSTR, 1): LMONTH = Get_CMX_Month(LCMONTH): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE):
                                                        LMonthType = "M"
                                                    ElseIf Right(TxtRec!F9, 3) = "-AN" Then
                                                        A = Len(TxtRec!F9)
                                                        LSTR = Left(TxtRec!F9, A - 3)
                                                        If Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "MAR" Or Right(LSTR, 3) = "APR" _
                                                            Or Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" _
                                                            Or Right(LSTR, 3) = "SEP" Or Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then
                                                            A = Len(LSTR)
                                                            LEXHCODE = Mid(LSTR, 1, A - 3): LMonthType = "M":
                                                            LMONTH = Right(LSTR, 3): lyear = Year(LSCondate)
                                                            If LMONTH = "JAN" Or LMONTH = "FEB" Or LMONTH = "MAR" Then
                                                                LSTR = Val(month(LSCondate))
                                                                If LSTR >= 9 And LSTR <= 12 Then
                                                                    lyear = lyear + 1
                                                                End If
                                                            End If
                                                            LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear:
                                                            LSMaturity = DateValue(LSTRCONDATE):
                                                        Else
                                                            If Left(TxtRec!F9, 3) = "SGX" Then  '>>> in reference to discuss with Umesh on date 20 NOV 2021 11:15AM
                                                                If Right(UCase(TxtRec!F9), 3) = "-AN" Then
                                                                    LSTR = UCase(Left(MonthName(month(ltradedt)), 3))
                                                                ElseIf Right(UCase(TxtRec!F9), 5) = "-NXAN" Then
                                                                    If month(ltradedt) = 12 Then
                                                                        LMONTH = 1
                                                                        lyear = Year(ltradedt) + 1
                                                                    Else
                                                                        LMONTH = month(ltradedt)
                                                                    End If
                                                                    LSTR = UCase(Left(MonthName(LMONTH), 3))
                                                                End If
                                                                A = Len(LSTR)
                                                                LEXHCODE = Left(TxtRec!F9, InStr(1, TxtRec!F9, "-") - 1): LMonthType = "M":
                                                                LMONTH = Right(LSTR, 3): lyear = Year(LSCondate)
                                                                LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear:
                                                                LSMaturity = DateValue(LSTRCONDATE):
                                                            Else
                                                                LEXHCODE = Mid(TxtRec!F9, 1, A - 3): LMonthType = "C":
                                                            End If
                                                        End If
                                                    Else
                                                        LEXHCODE = Mid(TxtRec!F9, 1, A - 1): LMonthType = "C": LSTR = Right(TxtRec!F9, 5):
                                                        lyear = "20" & Mid(LSTR, 2, 2)
                                                        LCMONTH = Left(LSTR, 1): LMONTH = Get_CMX_Month(LCMONTH): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE):
                                                        LMonthType = "M"
                                                    End If
                                                End If
                                                'If LMONTH > month(LSCondate) Then LMonthType = "N"
                                            End If
                                        Else
                                            If (Right(UCase(TxtRec!F9), 2) = "-V" Or Right(UCase(TxtRec!F9), 2) = "-C" Or _
                                            Right(UCase(TxtRec!F9), 2) = "-D" Or Right(UCase(TxtRec!F9), 2) = "-M" Or Right(UCase(TxtRec!F9), 3) = "-VS" Or Right(UCase(TxtRec!F9), 3) = "-AN") Then
                                                LMonthType = "C": LEXHCODE = Mid(TxtRec!F9, 1, A - 1)
                                            Else
                                                LMsgBox = "No Code Defines for " & TxtRec!F9 & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                                            End If
                                        End If
                                    End If
                                Else
                                    A = InStr(TxtRec!F9, "_")
                                    If A = 0 Then
                                        LSTR = TxtRec!F9
                                        If Right(LSTR, 3) = "F22" Or Right(LSTR, 3) = "G22" Or Right(LSTR, 3) = "H22" _
                                            Or Right(LSTR, 3) = "J22" Or Right(LSTR, 3) = "K22" Or Right(LSTR, 3) = "M22" _
                                            Or Right(LSTR, 3) = "N22" Or Right(LSTR, 3) = "Q22" Or Right(LSTR, 3) = "U22" _
                                            Or Right(LSTR, 3) = "V22" Or Right(LSTR, 3) = "X22" Or Right(LSTR, 3) = "Z22" Then
                                            LMonthType = "M"
                                            LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 3)
                                            LCMONTH = Right(LSTR, 3)
                                            LMONTH = Get_CMX_Month(Left(LCMONTH, 1))
                                            lyear = Year(LSCondate)
                                            lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                            LSMaturity = lday & "/" & LMONTH & "/" & lyear

                                        ElseIf (InStr(LSTR, "JAN") = 0 And InStr(LSTR, "FEB") = 0 And InStr(LSTR, "MAR") = 0 And InStr(LSTR, "APR") = 0 _
                                            And InStr(LSTR, "MAY") = 0 And InStr(LSTR, "JUN") = 0 And InStr(LSTR, "JUL") = 0 And InStr(LSTR, "AUG") = 0 _
                                            And InStr(LSTR, "SEP") = 0 And InStr(LSTR, "OCT") = 0 And InStr(LSTR, "NOV") = 0 And InStr(LSTR, "DEC") = 0) _
                                            Or InStr(LSTR, "USD") = 0 Then
                                                If Left(TxtRec!F9, 9) = "SGX-NIFTY" Then
                                                    LMonthType = "M"
                                                    LEXHCODE = Left(TxtRec!F9, 9)
                                                    LMONTH = Right(TxtRec!F9, 2)
                                                    lyear = Year(LSCondate)
                                                    lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                                    LSMaturity = lday & "/" & LMONTH & "/" & lyear
                                                Else
                                                    LMonthType = "M"
                                                    LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 10)
                                                    LSTR = Right(TxtRec!F9, 9)
                                                    lday = Left(LSTR, 2)
                                                    LSMaturity = Left(LSTR, 2) & "/" & Mid(LSTR, 3, 3) & "/" & Right(LSTR, 4)
                                                    LMONTH = month(LSMaturity)
                                                    lyear = Year(LSMaturity)
                                                End If
                                        ElseIf Right(UCase(TxtRec!F9), 3) = "20M" Or Right(UCase(TxtRec!F9), 3) = "21M" Then
                                                LEXHCODE = Left(TxtRec!F9, (Len(TxtRec!F9) - 4)): LSTR = Right(TxtRec!F9, 4): lyear = "20" & Mid(LSTR, 2, 2)
                                                LCMONTH = Left(LSTR, 1): LMONTH = Get_CMX_Month(LCMONTH): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE): LMonthType = "M"
                                        ElseIf Right(UCase(TxtRec!F9), 3) <> "NXM" And Right(UCase(TxtRec!F9), 1) = "M" Then
                                                LMonthType = "C": LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 1)
                                        ElseIf Left(LSTR, 3) = "JAN" Or Left(LSTR, 3) = "FEB" Or Left(LSTR, 3) = "MAR" Or Left(LSTR, 3) = "APR" _
                                                Or Left(LSTR, 3) = "MAY" Or Left(LSTR, 3) = "JUN" Or Left(LSTR, 3) = "JUL" Or Left(LSTR, 3) = "AUG" _
                                                Or Left(LSTR, 3) = "SEP" Or Left(LSTR, 3) = "OCT" Or Left(LSTR, 3) = "NOV" Or Left(LSTR, 3) = "DEC" Then
                                                GoTo EFlag_Next
                                        ElseIf Right(TxtRec!F9, 3) = "USD" Then
                                                LMonthType = "C": LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 3)
                                        Else
                                                LMonthType = "N": LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 3)
                                        End If

                                    Else
                                        If InStr(TxtRec!F9, "SGNIFTY") = 0 Then
                                           
                                            
                                            LSTR = Right(TxtRec!F9, Len(TxtRec!F9) - A): LEXHCODE = Left(TxtRec!F9, A - 1): LMONTH = Left(LSTR, 3)
                                            'If Len(LSTR) = 5 Then
                                            '    lyear = "20" & Right(LSTR, 2)
                                            'Else
                                                lyear = Year(LSCondate)
                                            'End If
                                        Else
                                            LEXHCODE = Left(TxtRec!F9, A - 1): LSTR = Right(TxtRec!F9, Len(TxtRec!F9) - A): LMONTH = Right(LSTR, 3): lyear = Year(LSCondate)
                                        End If
                                        lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
                                        LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
                                    End If
                                End If
                            End If
                        Else
                            LSExCode = vbNullString
                            If A = 0 Then
                                If (Left(TxtRec!F9, 2) = "YM" Or Left(TxtRec!F9, 2) = "SI" Or Left(TxtRec!F9, 2) = "GC" Or Left(TxtRec!F9, 2) = "CL" Or Left(TxtRec!F9, 2) = "NG" _
                                Or Left(TxtRec!F9, 2) = "6A" Or Left(TxtRec!F9, 2) = "6B" Or Left(TxtRec!F9, 2) = "6E" Or Left(TxtRec!F9, 2) = "6N" Or Left(TxtRec!F9, 2) = "YM" Or Left(TxtRec!F9, 5) = "DGINR" Or Left(TxtRec!F9, 2) = "ES" _
                                Or Left(TxtRec!F9, 2) = "HG" Or Left(TxtRec!F9, 2) = "ES" Or Left(TxtRec!F9, 2) = "NQ") And Left(TxtRec!F9, 6) <> "SILVER" And Left(TxtRec!F9, 7) <> "ESCORTS" And Left(TxtRec!F9, 7) <> "SIEMENS" Then
                                    If Right(TxtRec!F9, 1) = "d" Then
                                        B = Len(TxtRec!F9): LEXHCODE = Left(TxtRec!F9, B - 4): LSTR = Right(TxtRec!F9, 3): lyear = Left(LSTR, 2)
                                        LSTR = Right(TxtRec!F9, 4): LCMONTH = Left(LSTR, 1): LMONTH = Get_CMX_Month(LCMONTH): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                        LSMaturity = DateValue(LSTRCONDATE)
                                    Else
                                        B = Len(TxtRec!F9): LEXHCODE = Left(TxtRec!F9, B - 3): LSTR = Right(TxtRec!F9, 3): lyear = Right(LSTR, 2)
                                        LCMONTH = Left(LSTR, 1): LMONTH = Get_CMX_Month(LCMONTH): LSTRCONDATE = "28" & "/" & LMONTH & "/20" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                    End If
                                Else
                                    A = Len(TxtRec!F9)
                                    If Right(TxtRec!F9, 2) = "20" Then
                                        LEXHCODE = Left$(TxtRec!F9, A - 5): LSTR = Right$(TxtRec!F9, 5): LMONTH = Left(LSTR, 3): lyear = "20" & Left(LSTR, 2): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                        If month(LSMaturity) < month(LSCondate) Then
                                            lyear = (Year(LSCondate) + 1): LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                        End If
                                    Else
                                        If Left(TxtRec!F9, 5) = "DGINR" Then
                                            LSTR = Right$(TxtRec!F9, 4): LMONTH = Get_CMX_Month(Left(LSTR, 1)): lyear = 20 & Mid(LSTR, 2, 2): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                        Else
                                            LEXHCODE = Left$(TxtRec!F9, A - 4): LSTR = Right$(TxtRec!F9, 4): LMONTH = Left(LSTR, 3): lyear = Year(LSCondate): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                            If month(LSMaturity) < month(LSCondate) Then
                                                lyear = (Year(LSCondate) + 1): LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                            End If
                                        End If
                                    End If
                                End If
                            Else
                                LEXHCODE = Trim(Left(TxtRec!F9, A - 1)): LMONTH = Right(TxtRec!F9, 2): lyear = Year(LSCondate): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                If month(LSMaturity) < month(LSCondate) Then
                                    lyear = (Year(LSCondate) + 1): LSTRCONDATE = "01" & "/" & month(LSMaturity) & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                                End If
                            End If
                        End If
                        If Right(TxtRec!F10, 1) = "K" Then
                            LBQty = Val(Left(TxtRec!F10, Len(TxtRec!F10) - 1)) * 1000
                        Else
                            LBQty = Val(TxtRec!F10)
                        End If
                        LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)): LSRate = LBRate: lsparty = MSPARTY
                    Case 47
                        LSExCode = vbNullString: If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not IsNumeric(TxtRec!F5) Then GoTo EFlag_Next
                        LOConNo = TxtRec!F2: LOrdNo = (TxtRec!F2 & vbNullString)
                        LSTRCONDATE = Left$(TxtRec!f3, 10): LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                        LContime = Right(TxtRec!f3, 8): LSPtyContype = UCase(Left(TxtRec!F4, 1))
                        If Right(TxtRec!F5, 1) = "K" Then
                            LBQty = Val(Left(TxtRec!F5, Len(TxtRec!F5) - 1)) * 1000
                        Else
                            LBQty = Val(TxtRec!F5)
                        End If
                        LBRate = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)): LSRate = LBRate: lbparty = (TxtRec!f12 & vbNullString):
                        If LenB(lbparty) < 1 Then
                            LMsgBox = "Comment Blank party for Trade No " & LOConNo & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                        End If
                        LPartyName = lbparty: A = InStr(TxtRec!F1, "/"): LEXHCODE = Trim(Left(TxtRec!F1, A - 1))
                        LMONTH = Right(TxtRec!F1, 2): lyear = Year(LSCondate): LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                        If month(LSMaturity) < month(LSCondate) Then
                            lyear = (Year(LSCondate) + 1): LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                        End If
                        LMonthType = "M": lsparty = MSPARTY
                    Case 48 ' Sauda Standing Excel 8.0
                        'Call excel_48
                    Case 49
                        'CALL EXCEL_49
                    Case 52
                        Call proc_52
                    Case 60
                        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                        LSCondate = DateValue(TxtRec!f11)
                        lbparty = TxtRec!F2: LPartyName = lbparty & " ": LSExCode = TxtRec!F5: LEXHCODE = TxtRec!f6
                        LSMaturity = DateValue(Left(TxtRec!F7, 10)):     LSInstType = Left(TxtRec!F8, 3)
                        LSPtyContype = UCase(Left(TxtRec!F10, 1)):       LBQty = Val(TxtRec!f11)
                        LBRate = Val(TxtRec!f12): LOConNo = TxtRec!F17
                        LSettleRate = TxtRec!F13: lsparty = LBrokerCode: LSRate = LBRate: LMonthType = "M"
                    Case 61
                        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not IsNumeric(TxtRec!F10) Then GoTo EFlag_Next
                        LSCondate = DateValue(TxtRec!f11)
                        lbparty = TxtRec!F2:                        LPartyName = lbparty & " "
                        LSExCode = Left(TxtRec!F1, 3):                        LEXHCODE = TxtRec!f3
                        LSMaturity = DateValue(Left(TxtRec!F4, 10)):                        LSInstType = "FUT"
                        LSPtyContype = UCase(Left(TxtRec!F7, 1))
                        If Val(TxtRec!F8) <> 0 Then
                            LBQty = Val(TxtRec!F8)
                        Else
                            LBQty = Val(TxtRec!F9)
                        End If
                        LContime = TxtRec!f12: LBRate = Val(TxtRec!F10): LOConNo = TxtRec!F14: lsparty = LBrokerCode
                        LSRate = LBRate: LMonthType = "M"
                    Case 62
                        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not IsNumeric(TxtRec!F8) Then GoTo EFlag_Next
                        LSCondate = DateValue(Left(TxtRec!f11, 10)): LContime = Right(TxtRec!f11, 5): lbparty = TxtRec!F1: LPartyName = lbparty & " "
                        LSExCode = Left(TxtRec!F2, 3): LEXHCODE = TxtRec!f3
                        If Len(TxtRec!F4) = 9 Then
                            LSMaturity = DateValue(Left(TxtRec!F4, 2) & "/" & Mid(TxtRec!F4, 3, 3) & "/" & Right(TxtRec!F4, 4))
                        Else
                            LSMaturity = DateValue(Left(TxtRec!F4, 10))
                        End If
                        LSInstType = "FUT": LSPtyContype = UCase(Left(TxtRec!F7, 1)): LBQty = Val(TxtRec!F8): LBRate = Val(TxtRec!F9)
                        LOConNo = TxtRec!F14: lsparty = LBrokerCode: LSRate = LBRate: LMonthType = "M"
                    Case 72
                            If IsNull(TxtRec!F5) Then GoTo EFlag_Next
                            If (TxtRec!F5 <> "Buy" And TxtRec!F5 <> "Sell") Then GoTo EFlag_Next
                            lbparty = (TxtRec!f6 & vbNullString):
                            If LenB(lbparty) < 1 Then
                                LMsgBox = "Comment Blank party for Trade No " & LOConNo & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                            End If
                            A = InStr(TxtRec!f6, ":")
                            lbparty = Trim(Left(TxtRec!f6, A - 1))
                            If LenB(lbparty) < 1 Then
                                LMsgBox = "Comment Blank party for Trade No " & LOConNo & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                            End If
                    Case 71
                        'Call excel_71
                    Case 38
'                        If TxtRec.Fields.Count > 20 Then
 '                           If (Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s")) Or (IsNull(TxtRec!F7) Or (TxtRec!f21 = "[rollover close]" Or TxtRec!f21 = "[rollover open]")) Then
  '                              GoTo EFlag_Next
   '                         Else
                                
                                If Trim(TxtRec!F21) = "[rollover open]" Or Trim(TxtRec!F21) = "[rollover close]" Then GoTo EFlag_Next
                                Call EXCEL_38(LClientCode)
     '                       End If
      '                  Else
       '                     If (Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s")) Or (IsNull(TxtRec!F7)) Then
        '                        GoTo EFlag_Next
         '                   Else
          '                          Call EXCEL_38
           '                     End If
            '                End If
                    Case 40
                    
                        LSInstType = "FUT"
                        LSExCode = vbNullString
                        If IsNull(TxtRec!F7) Then GoTo EFlag_Next
                        If Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s") Then GoTo EFlag_Next
                        LOConNo = TxtRec!F1:                        LOrdNo = (TxtRec!f3 & vbNullString)
                        lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
                        LPartyName = lbparty & TxtRec!F5:                     LSTRCONDATE = Left$(TxtRec!f6, 10)
                        
                        
                        LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                        LSPtyContype = UCase(Left(TxtRec!F7, 1))
                        If ((Right(TxtRec!F9, 1) = "C" And Right(TxtRec!F9, 3) <> "DEC") Or (Right(TxtRec!F9, 1) = "P") And Right(TxtRec!F9, 3) <> "SEP") And InStr(TxtRec!F9, "_") = 0 Then
                            LEXHCODE = Left(TxtRec!F9, 3)
                            
            '>>>>>>>>> temp
            Vexcelcolval = "":            Vitemcode = "":            Vday = 0:            Vmonth = "":            Vrate = 0:            Vlastchar = "":            Vdate = "01/01/1900":            Vexcelcolval = TxtRec!F9
            If IsNumeric(Right(Mid(Vexcelcolval, 1, 4), 1)) Then
                Vitemcode = Left(Vexcelcolval, 3)
            Else
                Vitemcode = Left(Vexcelcolval, 4)
            End If
            Vexcelcolval = Replace(Vexcelcolval, Vitemcode, ""):            Vlastchar = Right(Vexcelcolval, 1):            Vexcelcolval = Mid(Vexcelcolval, 1, Len(Vexcelcolval) - 1)
            If IsNumeric(Left(Vexcelcolval, 2)) Then  '>>> 2 char day
                Vday = Left(Vexcelcolval, 2):                Vexcelcolval = Mid(Vexcelcolval, 3, Len(Vexcelcolval))
                Vmonth = UCase(Left(Vexcelcolval, 2)) '>>> 2 char month like JA, FE, MA ...
                Vexcelcolval = Mid(Vexcelcolval, 3, Len(Vexcelcolval))
            Else
                Vday = Left(Vexcelcolval, 1)  '>>> 1 char day
                Vexcelcolval = Mid(Vexcelcolval, 2, Len(Vexcelcolval)):                Vmonth = UCase(Left(Vexcelcolval, 3)) '>>> 3 char month like JAN, FEB, MAR ...
                Vexcelcolval = Mid(Vexcelcolval, 4, Len(Vexcelcolval))
            End If
            Vrate = Vexcelcolval:            Vdate = getdate(Vmonth, Vday)
            If Vitemcode = "NIY" Then
                LEXHCODE = "NIFTY"
            ElseIf Vitemcode = "BNTY" Then
                LEXHCODE = "BANKNIFTY"
            Else
                GoTo EFlag_Next
            End If
            LSOptType = Vlastchar + "E":            LSStrike = Vrate
            End If
                        If Right(TxtRec!F9, 4) = "JUNE" Or Right(TxtRec!F9, 4) = "JULY" Then
                            A = Len(TxtRec!F9): LEXHCODE = Left$(TxtRec!F9, A - 4): LSTR = Right(TxtRec!F9, 4): LStrMonth = Left(LSTR, 3)
                        ElseIf UCase(Right(TxtRec!F9, 3)) = "JAN" Or UCase(Right(TxtRec!F9, 3)) = "FEB" Or UCase(Right(TxtRec!F9, 3)) = "MAR" Or UCase(Right(TxtRec!F9, 3)) = "APR" _
                        Or UCase(Right(TxtRec!F9, 3)) = "MAY" Or UCase(Right(TxtRec!F9, 3)) = "JUN" Or UCase(Right(TxtRec!F9, 3)) = "AUG" Or UCase(Right(TxtRec!F9, 3)) = "JUL" _
                        Or UCase(Right(TxtRec!F9, 3)) = "SEP" Or UCase(Right(TxtRec!F9, 3)) = "OCT" Or UCase(Right(TxtRec!F9, 3)) = "NOV" Or UCase(Right(TxtRec!F9, 3)) = "DEC" Then
                            A = Len(TxtRec!F9)
                            If lexceltype = 40 Then
                                B = InStr(TxtRec!F9, "_")
                                If B <> 0 Then
                                    LEXHCODE = Left$(TxtRec!F9, A - 4)
                                Else
                                    LEXHCODE = Left$(TxtRec!F9, A - 3)
                                End If
                            Else
                                LEXHCODE = Left$(TxtRec!F9, A - 3)
                            End If
                            LStrMonth = Right(TxtRec!F9, 3)
                        ElseIf Right(TxtRec!F9, 1) = "2" Then
                            LSTR = Right(TxtRec!F9, 4): A = Len(TxtRec!F9): LEXHCODE = Left$(TxtRec!F9, A - 4): LStrMonth = Left(LSTR, 3)
                        ElseIf Right(TxtRec!F9, 2) = "23" Or Right(TxtRec!F9, 2) = "22" Then
                            A = Len(TxtRec!F9):                            LEXHCODE = Left$(TxtRec!F9, A - 5): LSTR = Right(TxtRec!F9, 5):                           LStrMonth = Left(LSTR, 3)
                        ElseIf Right(TxtRec!F9, 3) = "INR" Then
                            A = Len(TxtRec!F9):                            LEXHCODE = Left$(TxtRec!F9, A - 6): LSTR = Mid(TxtRec!F9, 4, 3):                           LStrMonth = Left(LSTR, 3)
                        End If
                        If Vrate > 0 Then
                            LSMaturity = Vdate:                            LSInstType = "OPT"
                            If Right(TxtRec!F10, 1) = "K" Then
                                LBQty = Val(Left(TxtRec!F10, Len(TxtRec!F10) - 1)) * 1000
                            Else
                                LBQty = Val(TxtRec!F10)
                            End If
                        Else
                            LSInstType = "FUT": lyear = Year(LSCondate): LSMaturity = DateValue("28/" & LStrMonth & "/" & lyear)
                            If month(LSCondate) > month(LSMaturity) Then
                                lyear = (Year(LSCondate) + 1): LSMaturity = DateValue("28/" & LStrMonth & "/" & lyear)
                            End If
                            If Right(TxtRec!F10, 1) = "K" Then
                                LBQty = Val(Left(TxtRec!F10, Len(TxtRec!F10) - 1)) * 1000
                            Else
                                LBQty = Val(TxtRec!F10)
                            End If
                       End If
                        LMONTH = month(LSMaturity):                        LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)):
                        LSRate = LBRate:                        lsparty = LBrokerCode
                    Case 41
                        Call EXCEL41
                    End Select
                    
                    If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                    If lexceltype = 42 Then
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 3)
                        If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                        Call Get_Sauda_Details(LEXHCODE, False, True, CDate(LSCondate), 2)
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired ": ImportIssues (LMsgBox)
                        End If
                        If LBQty <> 0 Then
                            mbparty = Get_ACCT_EX(LSEXID, lbparty)
                            If LNEWPARTY = "Y" Then
                                If LenB(mbparty) < 1 Then
                                    mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                                End If
                            End If
                            MSPARTY = lsparty
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                            End If
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                            Cnn.Execute mysql
                            MCount = MCount + 1:
                            If InStr(LBillExId, str(LSEXID)) = 0 Then
                                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            LNoTrd = LNoTrd + 1: GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9: DoEvents: LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    ElseIf lexceltype = 25 Or lexceltype = 71 Or lexceltype = 29 Or lexceltype = 37 Or lexceltype = 38 Or lexceltype = 39 Or lexceltype = 40 Or lexceltype = 41 Or lexceltype = 45 Or lexceltype = 46 Or lexceltype = 47 Or lexceltype = 49 Or lexceltype = 50 Or lexceltype = 52 Or lexceltype = 60 Or lexceltype = 61 Or lexceltype = 62 Then
                        If lexceltype <> 52 Then
                            Call GetItem_Sauda_Detail(lexceltype)
                            If Flag_GONext Then
                                Flag_GONext = False
                                GoTo EFlag_Next
                            End If
                        End If
                                                
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If lexceltype = 41 Then
                            Call Get_ExDetail(LSExCode): lsparty = LExCont
                        End If
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired ": ImportIssues (LMsgBox)
                        End If
                        If LBQty <> 0 Then
                            LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                            If lexceltype = 46 Or lexceltype = 40 Or lexceltype = 38 Then
                                If LSInstType = "OPT" Then
                                    mysql = "SELECT REFLOT FROM SAUDAMAST WHERE SAUDAID=" & LSSaudaID & "": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                    If Not TRec.EOF Then
                                        LBQty = LBQty * TRec!REFLOT
                                    End If
                                End If
                            End If
                            mbparty = Get_ACCT_EX(LSEXID, lbparty)
                            If LenB(mbparty) < 1 Then
                                LPartyName = Replace(LPartyName, "'", "")
                                If LNEWPARTY = "Y" Then
                                    mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                                Else
                                    GoTo EFlag_Next
                                End If
                                If LenB(mbparty) > 1 Then
                                    If LSExCode = "RACE" Then
                                        mysql = "UPDATE ACCOUNTM SET PTYHEAD =1 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & mbparty & "'": Cnn.Execute mysql
                                    Else
                                        mysql = "UPDATE ACCOUNTM SET PTYHEAD =2 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & mbparty & "'": Cnn.Execute mysql
                                    End If
                                End If
                            End If
                            MSPARTY = lsparty: mysql = "SELECT BROKER FROM EXBROKCLIENT WHERE COMPCODE =" & GCompCode & " AND CLIENT ='" & mbparty & "'": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then MSPARTY = TRec!BROKER
                            If LenB(MSPARTY) < 1 Then
                                Call Get_ExDetail(LSExCode): MSPARTY = LExCont
                            End If
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                            End If
                            If LenB(MSPARTY) < 1 Then
                                LMsgBox = " Broker does Not Exist " & lsparty & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                            End If
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'": Cnn.Execute mysql
                            MCount = Get_Max_ConNo(CDate(LSCondate), 0): MCount = MCount + 1:
                            If InStr(LBillExId, str(LSEXID)) = 0 Then
                                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            LNoTrd = LNoTrd + 1: GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                            DoEvents: LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            If lexceltype = 60 Then
                                LRATE = SDCLRATE(LSSaudaID, LSCondate, "C")
                                If LRATE = 0 Then
                                    Call PInsert_Ctr_R(LSConSno, LSSaudaCode, LSCondate, 0, 0, 0, LSettleRate, LSettleRate, LSExCode, LSItemCode, LSSaudaID, LSItemid, LSEXID, 0, "")
                                End If
                            End If
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    ElseIf lexceltype = 6 Or lexceltype = 7 Or lexceltype = 15 Or lexceltype = 30 Or lexceltype = 31 Or lexceltype = 32 Then
                        LLOT = 1
                        LSExCode = vbNullString
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                        If LenB(LSItemCode) > 1 Then GoTo EFlag_Next
                        Call Get_Sauda_Details(LEXHCODE, False, True, CDate(LSCondate), 1)
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If InStr(LEXCHANGE, LSExCode) < 1 Then
                            If LenB(LEXCHANGE) > 0 Then LEXCHANGE = LEXCHANGE & ","
                            LEXCHANGE = LEXCHANGE & "'" & LSExCode & "'"
                        End If
                        If LConType = "B" Then
                            LSPtyContype = "B"
                        Else
                            LSPtyContype = "S"
                        End If
                        If lexceltype = 32 And LSExCode = "NSE" Then
                            mysql = "SELECT REFLOT FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND SAUDACODE ='" & LSSaudaCode & "'": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec.EOF Then
                                LBQty = LBQty * TRec!REFLOT
                            End If
                        End If
                        LBQty = Abs(LBQty)
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired ": ImportIssues (LMsgBox)
                        End If
                        If LBQty <> 0 Then
                            mbparty = Get_ACCT_EX(LSEXID, lbparty): MSPARTY = Get_ACCT_EX(LSEXID, lsparty)
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                            End If
                            If LenB(MSPARTY) < 1 Then
                                LMsgBox = " Broker does Not Exist " & lsparty & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                            End If
                            MCount = MCount + 1:
                            If InStr(LBillExId, str(LSEXID)) = 0 Then
                                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            LNoTrd = LNoTrd + 1: GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                            DoEvents: LSConSno = Get_ConSNo(CDate(LSCondate), LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            LOConNo = Trim(str(MCount)):
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, CDate(LSCondate), MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If
EFlag_Next:
                    TxtRec.MoveNext
                Wend
                'If LExcelType = "41" Then
                 '   mysql = "SELECT CONNO,ORDNO FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(LTradeDt, "YYYY/MM/DD") & "' AND EXCODE='NSE' And DATAIMPORT = 1 AND CONCODE <>PARTY ORDER BY ORDNO": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                  '  Do While Not TRec.EOF
                   '     LOrdNo = TRec!ORDNO: MCount = TRec!CONNO
                    '    mysql = "UPDATE CTR_D SET BROKFLAG='N' ,BROKRATE =0 WHERE COMPCODE =" & GCompCode & " AND CONDATE ='" & Format(LTradeDt, "YYYY/MM/DD") & "' AND EXCODE='NSE' And DATAIMPORT = 1 AND ORDNO ='" & LOrdNo & "' AND CONNO <>" & MCount & "": Cnn.Execute mysql
                     '   Do While LOrdNo = TRec!ORDNO
                     '       TRec.MoveNext: If TRec.EOF Then Exit Do
                     '   Loop
                     '   If TRec.EOF Then Exit Do
                   ' Loop
               ' End If
        End If
    End If
    LMsgBox = " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
    ImportIssues (LMsgBox)
    'MsgBox " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
Next
    Cnn.CommitTrans:    CNNERR = False:    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Sub Save_AllTrade_Excel_101_201(lexceltype As Integer, Optional lclientid As String)

If lexceltype = 102 Then
    Save_AllTrade_Excel_102 (lexceltype)
    Exit Sub
End If

Dim LIFLAG As Boolean:          Dim lbparty As String:          Dim lsparty As String:          Dim LBQty As Double:        Dim LSQty As Double:           Dim LBRate As Double:           Dim LSRate As Double:           Dim ldate As Date
Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String:    Dim MCount As Long:            Dim LConType As String:         Dim LSConSno As Long:           Dim LQTY As Double:
Dim LRATE As Double:            Dim LContime As String:         Dim LOrdNo As String:           Dim LOrdTime As String:     Dim StrDateLen As Integer:     Dim LSTRDATE As String:         Dim LMONTH As String:           Dim lyear As String
Dim LClient As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:      Dim TRec As ADODB.Recordset:   Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String
Dim LEXHCODE As String:         Dim LSItemName As String:       Dim LSTRCONDATE  As String:     Dim A As Integer:           Dim LFieldName As String:      Dim fld As ADODB.Field:         Dim LCMONTH As String
Dim LMFLPath As String:         Dim B As Integer:               Dim LSTR As String:             Dim LStrMonth As String:       Dim lday As Integer:            Dim LAcExCode As String:        Dim C As Integer
Dim LMXDate As Date:            Dim LSCondate As Date:          Dim LOConNo As String:          Dim LSPtyContype As String: Dim LSettleRate As Double:      Dim Vexcelcolval As String:          Dim Vitemcode As String:            Dim Vday As Integer:            Dim Vmonth As String
Dim Vrate As Double:            Dim Vlastchar As String:        Dim Vdate As Date:              Dim VYear As String:        Dim Vexchange As String
Dim MDt As String
Dim MstrDt As String
Dim MOPEN As String
Dim LTRADECOL As String
Dim BUYSELLCOLNO As Integer
Dim txteqrec As New ADODB.Recordset


Dim LArray() As String: Dim Lmaturity As String: Dim LParty As String
On Error GoTo err1
Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
Call GET_JCnn("\" & LFolderName & "\;")
MSPARTY = LBrokerCode
BUYSELLCOLNO = 11

Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
    LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
End If
Set LFileSystemObject = Nothing


 '>> read "EQUITY_L.CSV" from app.path & insert in DB table
 If lexceltype = "119" Then
    TxtPath = "EQUITY_L.CSV"
    LFileName = App.Path & "\" & TxtPath
    If Not FileExist(LFileName) Then
        Set txteqrec = Nothing: Set txteqrec = New ADODB.Recordset
        txteqrec.Open "Select * from " & TxtPath, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        'If TXTEQREC.RecordCount = 0 Then
            Cnn.Execute "DELETE FROM EQUITY"
            txteqrec.MoveFirst
            txteqrec.MoveNext
            While Not txteqrec.EOF
                Cnn.Execute "insert into EQUITY (SYMBOL,NAME) VALUES ('" & Replace(txteqrec!F1, "'", "''") & "',LEFT('" & Replace(txteqrec!F2, "'", "''") & "',50))"
                txteqrec.MoveNext
            Wend
        'End If
    End If
End If
'********************

Cnn.BeginTrans
CNNERR = True:
For ltradedt = vcDTP1.Value To vcDTP2.Value

    LNoTrd = 0
    If lexceltype = 108 Then
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "STD.CSV"
        LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
        
        'If GUniqClientId = "PRM-MUM" Then
         '   TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        'Else
            If Not FileExist(LFileName) Then
                TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "OPEN.CSV"
                MOPEN = "O"
            Else
                MOPEN = "S"
            End If
        'End If
        LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
    ElseIf lexceltype = 115 Then
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".TXT"
        LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
    Else
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
    End If
    If Not FileExist(LFileName) Then
        LMsgBox = LFileName & "  file not found" ', vbCritical
        ImportIssues (LMsgBox)
    Else
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = DateValue(ltradedt)
            ldate = LSCondate
            
            TxtRec.MoveFirst
            MOPEN = ""
            LNoTrd = 0
            While Not TxtRec.EOF
                lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString
                LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
                LOrdTime = vbNullString:      LSOptType = vbNullString:     LSStrike = 0:                 LLOT = 0:
                LBQty = 0:                    LSQty = 0:                    LBRate = 0:                   LSRate = 0
                
                LSSaudaID = 0:                LSItemid = 0: LSEx_Symbol = vbNullString
                LMonthType = "M": LBillExId = ""
                Vexcelcolval = "":                    Vitemcode = "":                    Vday = 0:                    Vmonth = "":                    Vrate = 0:                    Vlastchar = "":                    Vdate = "01/01/1900"
                If lexceltype = "118" And MOPEN = "" Then
                    If TxtRec!f3 = "MAINTradeID" Then
                        MOPEN = "3"
                    Else
                        MOPEN = "4"
                    End If
                End If
                
               
                If IsNull(TxtRec!F1) And lexceltype <> 124 And lexceltype <> 130 And lexceltype <> 131 And lexceltype <> 132 Then GoTo EFlag_Next
                If Left(TxtRec!F1, 3) = "###" Then GoTo EFlag_Next
                
                
                Select Case lexceltype
                Case 101
                    LSTRCONDATE = Left$(TxtRec!F2, 10)
                Case 103
                    LSTRCONDATE = Left$(TxtRec!F1, 10)
                Case 104
                    LSTRCONDATE = Left$(TxtRec!f3, 10)
                Case 105
                    LSTRCONDATE = Left$(TxtRec!f11, 10)
                Case 107
                    LSTRCONDATE = Left$(Replace(TxtRec!F1, "'", ""), 10)
                Case 108
                    LSTRCONDATE = ltradedt
                Case 109 ' TJ KINGDOM CLIENT FILE
                     If IsNull(TxtRec!f11) Then GoTo EFlag_Next
                    LSTRCONDATE = Left$(TxtRec!f11, 10)

                    LSTRCONDATE = Left(LSTRCONDATE, 2) + "/" + Mid(LSTRCONDATE, 4, 3) + "/" + "20" + Right(LSTRCONDATE, 2)
                    If IsDate(LSTRCONDATE) Then
                        LSTRCONDATE = DateValue(LSTRCONDATE)
                    End If
                Case 110 Or 111
                    If lexceltype = 110 Then
                        LSTRCONDATE = Left$(TxtRec!F1, 10)
                     Else
                        LSTRCONDATE = Left$(TxtRec!f3, 10)
                     End If
                Case 112
                    LSTRCONDATE = ltradedt
                Case 113
                    LSTRCONDATE = Left$(TxtRec!f3, 10)
                Case 114
                    LSTRCONDATE = ltradedt
                Case 115
                    LSTRCONDATE = ltradedt
                Case 116 ' Smartgain
                    LSTRCONDATE = Left$(TxtRec!F5, 10)
                 Case 117 ' VERTEX
                    LSTRCONDATE = Left$(TxtRec!F1, 8)
                    If TxtRec!F2 <> "L" Then
                        If TxtRec!f3 <> "B" And TxtRec!f3 <> "S" Then GoTo EFlag_Next
                    End If
                        
                    If TxtRec!f3 = "B" Or TxtRec!f3 = "S" Then
                        LSTRCONDATE = Left$(TxtRec!F2, 10)
                        LSTRCONDATE = DateValue(LSTRCONDATE)
                    Else
                        LSTRCONDATE = Right(LSTRCONDATE, 2) + "/" + Mid(LSTRCONDATE, 4, 2) + "/20" + Left(LSTRCONDATE, 2)
                    End If

                Case 118
                    LSTRCONDATE = Left$(TxtRec!F10, 8)
                    LSTRCONDATE = Right(LSTRCONDATE, 2) + "/" + Mid(LSTRCONDATE, 5, 2) + "/" + Left(LSTRCONDATE, 4)
                Case 119
                    LSTRCONDATE = ltradedt
                Case 120
                    LSTRCONDATE = TxtRec!F1
                Case 121
                    LSTRCONDATE = ltradedt
                Case 122 ' DELTA MNGR
                     If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                     LSTRCONDATE = Left$(Replace(TxtRec!F1, "'", ""), 10)
                     If Not IsDate(LSTRCONDATE) Then GoTo EFlag_Next
                    'LSTRCONDATE = Left$(TxtRec!F1, 10)
                Case 123 ' VERTEX
                     If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                     If Not IsDate(TxtRec!F1) Then
                        If Not IsDate(TxtRec!F2) Then GoTo EFlag_Next
                        LSTRCONDATE = Left$(TxtRec!F2, 10)
                        Vdate = LSTRCONDATE
                     Else
                        LSTRCONDATE = Mid(TxtRec!F1, 7, 2) + "/" + Mid(TxtRec!F1, 4, 2) + "/" + "20" + Left(TxtRec!F1, 2)
                        MstrDt = Mid(TxtRec!F7, 7, 2) + "/" + Mid(TxtRec!F7, 4, 2) + "/" + "20" + Left(TxtRec!F7, 2)
                     End If
                Case 124 ' TJ MNGR
                     If IsNull(TxtRec!f3) Then GoTo EFlag_Next
                     If Not IsDate(TxtRec!F14) Then GoTo EFlag_Next
                    LSTRCONDATE = Left$(TxtRec!F14, 10)
                Case 125 ' ODIN
                     If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                    LSTRCONDATE = Left$(TxtRec!F1, 10)
                Case 130 ' money ocean tradebook
                    If Not IsDate(TxtRec!F8) Then GoTo EFlag_Next
                    If Not (Left(TxtRec!F7, 1) = "B" Or Left(TxtRec!F7, 1) = "S") Then GoTo EFlag_Next
                    If GUniqClientId <> "NIK-NGP" Then
                        If TxtRec!F18 = "Settlement Close" Or TxtRec!F18 = "Settlement Open" Then GoTo EFlag_Next
                    End If
                    LSTRCONDATE = Left$(TxtRec!F8, 10)
                Case 131 ' money ocean CMX tradebook
                    If Not IsDate(TxtRec!F8) Then GoTo EFlag_Next
                    If Not (Left(TxtRec!F7, 1) = "B" Or Left(TxtRec!F7, 1) = "S") Then GoTo EFlag_Next
                    LSTRCONDATE = Left$(TxtRec!F8, 10)
                    
                Case 132 ' gold mine
                

                    If Not IsDate(TxtRec!F13) Then GoTo EFlag_Next
                    If Not (Left(TxtRec!F5, 1) = "B" Or Left(TxtRec!F5, 1) = "S") Then GoTo EFlag_Next
                    If Left(TxtRec!f6, 2) = "BF" Then GoTo EFlag_Next
                    If Not Left(TxtRec!f11, 8) = "Executed" Then GoTo EFlag_Next


                    LSTRCONDATE = Left$(TxtRec!F13, 10)
                Case 133, 134 ' vertex NEW
                    If lexceltype = 134 Then
                        If Not IsDate(TxtRec!F2) Then GoTo EFlag_Next
                        If Left(TxtRec!F4, 3) <> "New" And Left(TxtRec!F4, 5) <> "Close" Then GoTo EFlag_Next
                        If TxtRec!F5 <> "Buy" And TxtRec!F5 <> "Sell" Then GoTo EFlag_Next
                        LSTRCONDATE = Left$(TxtRec!F2, 10)
                    Else
                    If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                    If Left(TxtRec!f3, 3) <> "New" Then GoTo EFlag_Next
                    If IsNull(TxtRec!f6) Then GoTo EFlag_Next
                    If TxtRec!f6 = "Buy Limit" Or TxtRec!f6 = "Sell Limit" Then GoTo EFlag_Next
                    If TxtRec!f6 = "Buy Stop" Or TxtRec!f6 = "Sell Stop" Then GoTo EFlag_Next

                    LSTRCONDATE = Left$(TxtRec!F1, 10)
                    End If
                Case 338
                    LSTRCONDATE = ltradedt
                Case 135
                     LSTRCONDATE = Mid(TxtRec!F10, 7, 2) + "/" + Mid(TxtRec!F10, 5, 2) + "/" + Left(TxtRec!F10, 4)
                Case 136 ' Zerodha
                     If Not IsDate(TxtRec!f3) Then GoTo EFlag_Next
                     LSTRCONDATE = DateValue(TxtRec!f3)
                Case 137 ' bunty new mcx file
                     If Not IsDate(TxtRec!f16) Then GoTo EFlag_Next
                     LSTRCONDATE = DateValue(TxtRec!f16)
                Case 138 ' SKYLINE
                    If IsNull(TxtRec!F14) Then GoTo EFlag_Next
                    'LSTRCONDATE = Mid(TxtRec!F13, 9, 2) + "/" + Mid(TxtRec!F13, 6, 2) + "/" + Mid(TxtRec!F13, 1, 4)
                    LSTRCONDATE = Mid(TxtRec!F14, 1, 2) + "/" + Mid(TxtRec!F14, 4, 2) + "/" + Mid(TxtRec!F14, 7, 4)
                Case 139 ' BUY SELL IN ONE ROW
                    If TxtRec!f3 <> "MCX" And TxtRec!f3 <> "NSE" Then GoTo EFlag_Next
                    If Not IsDate(TxtRec!F14) And Not IsDate(TxtRec!F15) Then GoTo EFlag_Next
                     If IsDate(TxtRec!F14) Then
                        LSTRCONDATE = DateValue(TxtRec!F14)
                     End If
                Case 140 ' new client
                    LSTRCONDATE = ltradedt
                Case 141 ' 2582KOH
                    If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                    If IsNull(TxtRec!F2) Then GoTo EFlag_Next
                    If Not IsDate(TxtRec!f3) Then GoTo EFlag_Next
                    If (Not IsNumeric(TxtRec!F5) And Not IsNumeric(TxtRec!f6)) And ((Not IsNumeric(TxtRec!F10) And Not IsNumeric(TxtRec!f11))) Then GoTo EFlag_Next
                    If IsNull(TxtRec!F8) Then GoTo EFlag_Next
                    If Not IsNull(TxtRec!F14) Then
                        'If TxtRec!f14 = "OP" Or TxtRec!f14 = "CL" Then GoTo EFlag_Next
                    End If
                    LSTRCONDATE = TxtRec!F1
                End Select
                
                If Not IsDate(LSTRCONDATE) Then GoTo EFlag_Next
                
                LSCondate = DateValue(LSTRCONDATE)
                If lexceltype <> 104 And lexceltype <> 108 And lexceltype <> 113 And lexceltype <> 130 And lexceltype <> 131 And lexceltype <> 133 Then
                    If InStr(MDt, LSTRCONDATE) = 0 Then
                        If InStr(MDt, "-") = 0 Then
                            MDt = MDt + Left(LSTRCONDATE, 10) + ","
                        Else
                            MDt = MDt + Left(LSTRCONDATE, 12) + ","
                        End If
                        'If MsgBox("Do You Want to Delete Trades of  Folder " & LFolderName & "  File Type " & LExcelType & " Of " & LSTRCONDATE, vbQuestion + vbYesNo, "Confirm") = vbYes Then
                        If lexceltype = 141 Or lexceltype = 109 Or lexceltype = 107 Or lexceltype = 116 Or lexceltype = 117 Or lexceltype = 124 Or lexceltype = 132 Then
                            Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSTRCONDATE, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND ordno = '" & LFolderName & "' and FILETYPE='" & lexceltype & "'"
                        Else
                            Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSTRCONDATE, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='" & lexceltype & "'"
                        End If
                        'End If
                    End If
                    If Len(MstrDt) > 0 Then
                        If InStr(MDt, MstrDt) = 0 Then
                            MDt = MDt + Left(Vdate, 10) + ","
                            Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(Vdate, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='" & lexceltype & "'"
                        End If
                    End If
                    If lexceltype = 139 Then
                        If IsDate(TxtRec!F15) Then
                            LSTRCONDATE = DateValue(TxtRec!F15)
                        End If
                        If InStr(MDt, LSTRCONDATE) = 0 Then
                            MDt = MDt + Left(LSTRCONDATE, 10) + ","
                            Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSTRCONDATE, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND ordno = '" & LFolderName & "' and FILETYPE='" & lexceltype & "'"
                        End If
                        If Len(MstrDt) > 0 Then
                            If InStr(MDt, MstrDt) = 0 Then
                                MDt = MDt + Left(Vdate, 10) + ","
                                Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(Vdate, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='" & lexceltype & "'"
                            End If
                        End If
                    End If
               End If
                MCount = Get_Max_ConNo(LSCondate, 0)
                Select Case lexceltype
                Case 101
                    If IsNull(TxtRec!F5) Then GoTo EFlag_Next
                    If (TxtRec!F5 <> "Buy" And TxtRec!F5 <> "Sell") Then GoTo EFlag_Next
                
                    LSExCode = vbNullString
                
                    LOConNo = TxtRec!F1:                        LOrdNo = "" '(TxtRec!F2 & vbNullString)
                    LSTRCONDATE = Left$(TxtRec!F2, 10)
                    LSCondate = DateValue(Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 2) & "/" & Right(LSTRCONDATE, 4))
                    LContime = Right(TxtRec!F2, 8)
                    LSPtyContype = UCase(Left(TxtRec!F5, 1)):                        LBQty = Val(TxtRec!F8)
                    LBRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)):
                    LSRate = LBRate:
                    lbparty = (TxtRec!f6 & vbNullString):
                    A = InStr(TxtRec!f6, ":")
                    lbparty = Trim(Left(TxtRec!f6, A - 1))
                    B = Len(TxtRec!f6)
                    B = B - A
                    LPartyName = Mid(TxtRec!f6, A + 1, B)
                    If InStr(1, TxtRec!F9, "MX1") > 0 Then
                        LEXHCODE = Replace(TxtRec!F9, " MX1", ""):                            Vexchange = "MCX"
                    ElseIf InStr(1, TxtRec!F9, "MX2") > 0 Then
                        LEXHCODE = Replace(TxtRec!F9, " MX2", ""):                            Vexchange = "MCX"
                    ElseIf InStr(1, TxtRec!F9, "NE1") > 0 Then
                        LEXHCODE = Replace(TxtRec!F9, " NE1", ""):                            Vexchange = "NSE"
                    ElseIf InStr(1, TxtRec!F9, "NE2") > 0 Then
                        LEXHCODE = Replace(TxtRec!F9, " NE2", ""):                            Vexchange = "NSE"
                    End If
                    
                    LMONTH = Mid(LSTRCONDATE, 4, 2)
                    lyear = Year(LSCondate)
                    
                    lday = GET_DAYS(LMONTH, lyear, LSCondate)
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    LSMaturity = DateValue(LSTRCONDATE)
                    If month(LSMaturity) < month(LSCondate) Then
                        lyear = (Year(LSCondate) + 1)
                        LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                    End If
                    LMonthType = "M"
                    lsparty = MSPARTY
                    
                    If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                    If LenB(LSItemCode) < 1 Then
                        GoTo EFlag_Next
                    End If

                  
                    
                    Call Get_Sauda_Details(LEXHCODE, False, True, LSCondate, 2)
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    If LSCondate > LSMaturity Then
                        LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                        ImportIssues (LMsgBox)
                    End If
                    LSEXID = Get_ExID(LSExCode)
                    If LBQty <> 0 Then
                        mbparty = Get_ACCT_EX(LSEXID, lbparty)
                        If LenB(mbparty) < 1 Then
                        mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                    End If
                    MSPARTY = lsparty
                    If LenB(mbparty) < 1 Then
                        LMsgBox = " Client does Not Exist " & lbparty & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                    Cnn.Execute mysql
                    MCount = MCount + 1:
                    If InStr(LBillExId, str(LSEXID)) = 0 Then
                        If LenB(LBillExId) > 0 Then
                            LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LSEXID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                        DoEvents
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                        Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                    End If
               End If

               'Buy SEll In One Row
               Case 102
                    If Not IsNumeric(TxtRec!F5) Then GoTo EFlag_Next
                    LSCondate = DateValue(TxtRec!F1)
                    lbparty = Trim(IIf(IsNull(TxtRec!F2), vbNullString, (TxtRec!F2))):
                    LEXHCODE = Trim(IIf(IsNull(TxtRec!f3), vbNullString, TxtRec!f3))
                    LSMaturity = DateValue(TxtRec!F4)
                    LBQty = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
                    If LBQty > 0 Then
                        LConType = "B"
                    Else
                        LConType = "S"
                        LBQty = Abs(LBQty)
                    End If
                    LBRate = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):
                    LSRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                    lsparty = Trim$(IIf(IsNull(TxtRec!F8), vbNullString, (TxtRec!F8))):
                    If Not IsNull(TxtRec!F9) Then
                        If TxtRec!F9 = "CSH" Then
                            LSInstType = "CSH"
                            LSOptType = vbNullString
                            LSStrike = 0
                        End If
                    End If
                    If Not IsNull(TxtRec!F10) Then
                        If IsNumeric(TxtRec!F10) Then
                            If Val(TxtRec!F10) <> 0 Then
                                LSInstType = "OPT": LSOptType = Left$(TxtRec!F9, 2): LSStrike = Val(TxtRec!F10 & vbNullString)
                        End If
                        End If
                    End If
                    LFieldName = "F11"
                    For Each fld In TxtRec.Fields
                        If UCase(fld.NAME) = LFieldName Then
                            If Not IsNull(TxtRec!f11) Then LContime = TxtRec!f11
                            Exit For
                        End If
                    Next
               Case 141
                    Call EXCEL_141(MCount, lexceltype, ltradedt, lclientid)
                Case 36
                    LBQty = 0: LSQty = 0
                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                    If UCase(TxtRec!F1) = "SAUDA" Then
                        TxtRec.MoveNext
                        LParty = (TxtRec!F1 & vbNullString):
                        TxtRec.MoveNext
                        TxtRec.MoveNext
                        LArray = Split(TxtRec!F1, " ")
                        LSItemCode = LArray(0)
                        Lmaturity = LArray(1)
                        If (Right(LArray(1), 2) = Right(Year(Date), 2)) Then
                            lyear = Left(Year(Date), 2) & Right(LArray(1), 2)
                            Lmaturity = Mid(Lmaturity, 1, Len(Lmaturity) - 2)
                            LMONTH = Right(Lmaturity, 3)
                            Lmaturity = Mid(Lmaturity, 1, Len(Lmaturity) - 3)
                            
                            If UCase(LMONTH) = "JAN" Or UCase(LMONTH) = "JA" Then
                                LMONTH = "01"
                            ElseIf UCase(LMONTH) = "FEB" Or UCase(LMONTH) = "FE" Then
                                LMONTH = "02"
                            ElseIf UCase(LMONTH) = "MAR" Or UCase(LMONTH) = "MA" Then
                                LMONTH = "03"
                            ElseIf UCase(LMONTH) = "APR" Or UCase(LMONTH) = "AP" Then
                               LMONTH = "04"
                            ElseIf UCase(LMONTH) = "MAY" Or UCase(LMONTH) = "MA" Then
                                LMONTH = "05"
                            ElseIf UCase(LMONTH) = "JUN" Or UCase(LMONTH) = "JU" Then
                                LMONTH = "06"
                            ElseIf UCase(LMONTH) = "JUL" Or UCase(LMONTH) = "JU" Then
                               LMONTH = "07"
                            ElseIf UCase(LMONTH) = "AUG" Or UCase(LMONTH) = "AU" Then
                               LMONTH = "08"
                            ElseIf UCase(LMONTH) = "SEP" Or UCase(LMONTH) = "SE" Then
                                LMONTH = "09"
                            ElseIf UCase(LMONTH) = "OCT" Or UCase(LMONTH) = "OC" Then
                                LMONTH = "10"
                            ElseIf UCase(LMONTH) = "NOV" Or UCase(LMONTH) = "NO" Then
                                LMONTH = "11"
                            ElseIf UCase(LMONTH) = "DEC" Or UCase(LMONTH) = "DE" Then
                                LMONTH = "12"
                            End If
                            LSMaturity = DateValue(Lmaturity & "/" & LMONTH & "/" & lyear)
                        End If
                        LBQty = Val(TxtRec!f6 & vbNullString): LSQty = Val(TxtRec!F5 & vbNullString): LBRate = (TxtRec!F7 & vbNullString)
                    ElseIf TxtRec!F1 <> "" Then
                        LArray = Split(TxtRec!F1, " ")
                        If UBound(LArray) = 0 Then
                            LParty = (TxtRec!F1 & vbNullString): LPartyName = (TxtRec!F2 & vbNullString)
                        End If
                        If UBound(LArray) > 0 Then
                            LSItemCode = LArray(0)
                            Lmaturity = LArray(1)
                            If (Right(LArray(1), 2) = Right(Year(Date), 2)) Then
                                lyear = Left(Year(Date), 2) & Right(LArray(1), 2)
                                Lmaturity = Mid(Lmaturity, 1, Len(Lmaturity) - 2)
                                LMONTH = Right(Lmaturity, 3)
                                Lmaturity = Mid(Lmaturity, 1, Len(Lmaturity) - 3)
                                   
                                If UCase(LMONTH) = "JAN" Or UCase(LMONTH) = "JA" Then
                                    LMONTH = "01"
                                ElseIf UCase(LMONTH) = "FEB" Or UCase(LMONTH) = "FE" Then
                                    LMONTH = "02"
                                ElseIf UCase(LMONTH) = "MAR" Or UCase(LMONTH) = "MA" Then
                                    LMONTH = "03"
                                ElseIf UCase(LMONTH) = "APR" Or UCase(LMONTH) = "AP" Then
                                    LMONTH = "04"
                                ElseIf UCase(LMONTH) = "MAY" Or UCase(LMONTH) = "MA" Then
                                    LMONTH = "05"
                                ElseIf UCase(LMONTH) = "JUN" Or UCase(LMONTH) = "JU" Then
                                    LMONTH = "06"
                                ElseIf UCase(LMONTH) = "JUL" Or UCase(LMONTH) = "JU" Then
                                    LMONTH = "07"
                                ElseIf UCase(LMONTH) = "AUG" Or UCase(LMONTH) = "AU" Then
                                    LMONTH = "08"
                                ElseIf UCase(LMONTH) = "SEP" Or UCase(LMONTH) = "SE" Then
                                    LMONTH = "09"
                                ElseIf UCase(LMONTH) = "OCT" Or UCase(LMONTH) = "OC" Then
                                    LMONTH = "10"
                                ElseIf UCase(LMONTH) = "NOV" Or UCase(LMONTH) = "NO" Then
                                    LMONTH = "11"
                                ElseIf UCase(LMONTH) = "DEC" Or UCase(LMONTH) = "DE" Then
                                    LMONTH = "12"
                                End If
                                LSMaturity = DateValue(Lmaturity & "/" & LMONTH & "/" & lyear)
                            End If
                            If IsNull(TxtRec!f6) And IsNull(TxtRec!F5) Then
                                GoTo EFlag_Next
                            End If
                            LBQty = Val(TxtRec!f6 & vbNullString): LSQty = Val(TxtRec!F5 & vbNullString): LBRate = (TxtRec!F7 & vbNullString)
                        End If
                    End If
                                          
                    If (LBQty = 0 And LSQty = 0) Then GoTo EFlag_Next
                        
                        LSExCode = vbNullString
                        LSCondate = ltradedt
                        LOConNo = Get_Max_ConNo(LSCondate, 0)
                        LOrdNo = "" '(TxtRec!F2 & vbNullString)
                        LSTRCONDATE = ltradedt
                     
                        LContime = "" 'Right(TxtRec!f2, 8)
                        If LBQty > 0 Then
                            LSPtyContype = "B"
                        ElseIf LSQty > 0 Then
                            LSPtyContype = "S"
                        End If
                        LSRate = LBRate:
    
                        lbparty = LParty
                        LEXHCODE = LSItemCode
                        LMonthType = "M"
                        lsparty = LBrokerCode
                        MSPARTY = LBrokerCode
                     
                        If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                     
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                     
                        If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                     
                        Call Get_Sauda_Details(LEXHCODE, False, True, LSCondate, 2)
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If LSCondate > LSMaturity Then
                             LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                        End If
                        LSEXID = Get_ExID(LSExCode)

                        If LBQty <> 0 Or LSQty <> 0 Then
                            mbparty = Get_ACCT_EX(LSEXID, lbparty)
                            If LenB(mbparty) < 1 Then
                                mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                            End If
                            MSPARTY = lsparty
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                                End If
                                'mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                                'Cnn.Execute mysql
                         If InStr(LBillExId, str(LSEXID)) = 0 Then
                             If LenB(LBillExId) > 0 Then
                                 LBillExId = LBillExId & ","
                                 LBillExId = LBillExId & str(LSEXID)
                             
                             End If
                             If lminbilldate > LSCondate Then lminbilldate = LSCondate
                                MCount = MCount + 1:
                                LNoTrd = LNoTrd + 1
                                GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                                DoEvents
                                
                                If LBQty = 0 Then
                                    LBQty = LSQty
                                End If
                         
                                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                                Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                            End If
                        End If
                Case 103  'Ganesh CSV
                        LBQty = 0: LSQty = 0: LSExCode = ""
                        If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                        LSCondate = TxtRec!F1
                        
                        LPartyName = (TxtRec!f3 & vbNullString)
                        LSItemCode = TxtRec!F4
                        Lmaturity = TxtRec!F5
                        LBQty = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
                        LSQty = IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)
                        If LBQty > 0 Then
                            LSPtyContype = "B"
                        Else
                            LSPtyContype = "S"
                        End If
                        LBRate = TxtRec!F8
                        LSRate = TxtRec!F8
                                                            
                        If (LBQty = 0 And LSQty = 0) Then GoTo EFlag_Next

                        LOConNo = Get_Max_ConNo(LSCondate, 0)
                        LOrdNo = "" '(TxtRec!F2 & vbNullString)
                        LSTRCONDATE = ltradedt
                        LContime = "" 'Right(TxtRec!f2, 8)
                        LEXHCODE = LSItemCode
                        LMonthType = "M"
                        lsparty = LBrokerCode
                        MSPARTY = LBrokerCode
                     
                        If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                     
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                     
                        If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                        Call Get_Sauda_Details(LEXHCODE, False, True, DateValue(Lmaturity), 2)
                        
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                        End If
                        LSEXID = Get_ExID(LSExCode)

                     If LBQty <> 0 Or LSQty <> 0 Then
                        lbparty = Left(LPartyName, 15)
                        mbparty = Get_ACCT_EX(LSEXID, lbparty)
                        If LenB(mbparty) < 1 Then
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                        End If
                        MSPARTY = lsparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                       ' mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                       ' Cnn.Execute mysql

                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then
                                LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            LNoTrd = LNoTrd + 1
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            DoEvents
                            
                            If LBQty = 0 Then
                               LBQty = LSQty
                            End If
                            
                            MCount = MCount + 1:
                            LOConNo = Trim(str(MCount))
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If
                    ''Mera Trade
            Case 104
                    LLOT = 1
                    A = Len(TxtRec!F4)
                    LSExCode = vbNullString
                    LBQty = 0: LSQty = 0: LSExCode = ""
                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                    If Not IsDate(TxtRec!f3) Then GoTo EFlag_Next
                    
                    LOConNo = TxtRec!F1
                    LSCondate = TxtRec!f3
                    LPartyName = Trim((TxtRec!F2 & vbNullString))
                    LSItemCode = Left(TxtRec!F4, A - 8)
                    LBRate = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
                    LBQty = IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)
                    LSPtyContype = Left(TxtRec!F5, 1)
                    LSRate = LBRate

                    LSTR = Right(TxtRec!F4, 8)
                    LMONTH = Mid(LSTR, 3, 3)
                    lyear = Left(LSTR, 2)
                    LSTRCONDATE = DateValue("28" & "/" & LMONTH & "/" & lyear)
                    LSMaturity = DateValue(LSTRCONDATE)
                    If month(LSMaturity) < month(LSCondate) Then
                        lyear = (Year(LSCondate) + 1)
                        LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                    End If
                    
                    LMonthType = "M"
                    If (LBQty = 0 And LSQty = 0) Then GoTo EFlag_Next
                    'Check Party Name In Accountd
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    mysql = "SELECT Ac_code from ACCOUNTD WHERE COMPCODE = " & GCompCode & "  AND NAME = '" & LPartyName & "'"
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If TRec.EOF Then
                        mbparty = NewPartyNM(LSExCode, mparty, LPartyName & " " & LSExCode, LUserId, True)
                    Else
                        mbparty = TRec!AC_CODE
                    End If
                    
                    LOrdNo = ""
                    LSTRCONDATE = ltradedt
                    LContime = Right(TxtRec!f3, 8)
                    LEXHCODE = LSItemCode
                    LMonthType = "M"
                    lsparty = LBrokerCode
                    MSPARTY = LBrokerCode
                    If LEXHCODE = "GOLD" Or LEXHCODE = "SILVER" Or LEXHCODE = "CRUDEOIL" Or LEXHCODE = "COPPER" Or LEXHCODE = "NATURALGAS" Or LEXHCODE = "CRUDEOILM" Then LSExCode = "MCX"
                    If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                    If LenB(LSItemCode) < 1 Then GoTo EFlag_Next

                    '''
                    If LSExCode = "MCX" Then
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT LOT from ITEMMAST WHERE COMPCODE = " & GCompCode & "  AND ITEMCODE = '" & LSItemCode & "'"
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If TRec.EOF Then
                            GoTo EFlag_Next
                        Else
                            LLOT = TRec!lot
                            LBQty = Round(LBQty / TRec!lot, 3)
                        End If
                    End If

                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                    Else
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                        If LSInstType <> "FUT" Then
                            mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                            mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                        Else
                            mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                        End If
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TRec.EOF Then
                            LSMaturity = TRec!MATURITY
                            LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                        Else
                            If LSInstType = "FUT" Then
                                LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                    LSSaudaCode = LSExCode & " " & LSSaudaCode
                                    If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                            LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                            ImportIssues (LMsgBox)
                                            GoTo EFlag_Next
                                    End If
                                End If
                            Else
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                        End If
                    End If
                    LSSaudaID = Get_SaudaID(LSSaudaCode)
                    
                    
                    'Call Get_Sauda_Details(LEXHCODE, False, True, LSMaturity - 5, 2)

                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    If Left(LSCondate, 10) > LSMaturity Then
                        LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                        ImportIssues (LMsgBox)
                    End If
                    LSEXID = Get_ExID(LSExCode)

                    If LBQty <> 0 Or LSQty <> 0 Then
                        If LenB(mbparty) < 1 Then
                            lbparty = Left(LPartyName, 6)
                        ' MBParty = Get_ACCT_EX(LSEXID, lbparty)
                                'If LenB(MBParty) < 1 Then
                                '   MBParty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                                'End If
                            mbparty = Get_ACCT_EX(LSEXID, lbparty)
                            If LenB(mbparty) < 1 Then
                                mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                            End If
                        End If
                        MSPARTY = lsparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        MSPARTY = lsparty
                        lbparty = mbparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND contype =  '" & Trim(LSPtyContype) & "' and party = '" & Trim(lbparty) & "' AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND FILETYPE = 104 AND SAUDAID = " & LSSaudaID & " AND ROWNO1 ='" & LOConNo & "'"
                        Cnn.Execute mysql

                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then
                                LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            DoEvents

                            If LBQty = 0 Then
                                LBQty = LSQty
                            End If
                            MCount = MCount + 1:
                            LNoTrd = LNoTrd + 1
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                 End If

            Case 105  '2210 File Delta,sawariya
                    If IsNull(TxtRec!F7) Then GoTo EFlag_Next
                    If Left(TxtRec!F7, 1) <> "B" And Left(TxtRec!F7, 1) <> "S" Then GoTo EFlag_Next

                    A = Len(TxtRec!F4)

                    LBQty = 0: LSQty = 0: LSExCode = ""
                    LSInstType = "FUT"
                    LOConNo = (TxtRec!F14 & vbNullString):
                    LSCondate = TxtRec!f11
                    If InStr(TxtRec!F2, "(") <> 0 Then
                        If InStr(TxtRec!F2, ")") <> 0 Then
                            A = InStr(TxtRec!F2, "(")
                            B = InStr(TxtRec!F2, ")")
                            lbparty = Mid(TxtRec!F2, A + 1, B - (A + 1))
                            LPartyName = Trim(Left(TxtRec!F2, A - 1))
                            LPartyName = LPartyName & " " & lbparty
                        End If
                    Else
                        If Not IsNull(TxtRec!F2) Then
                            If IsNumeric(TxtRec!F2) Then
                                lbparty = TxtRec!F2
                                LPartyName = lbparty & " " & (TxtRec!F2 & vbNullString)
                            End If
                        End If
                    End If

                    LSExCode = IIf(Left(TxtRec!F1, 3) = "GLO", "NSE", Left(TxtRec!F1, 3))
                    LSItemCode = TxtRec!f3

                    LBRate = IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)
                    LBQty = IIf(IsNull(TxtRec!F9), 0, TxtRec!F9)
                    If LSExCode = "MCX" Then
                        LBQty = IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)
                    End If
                    If TxtRec!F5 = "CE" Or TxtRec!F5 = "P" Then
                        LSInstType = "OPT"
                        LSOptType = TxtRec!F5
                        LSStrike = TxtRec!f6
                    End If
                    
                    LSPtyContype = Left(TxtRec!F7, 1)
                    LSRate = LBRate
                    LSMaturity = DateValue(TxtRec!F4)
                    If month(LSMaturity) < month(LSCondate) Then
                        lyear = (Year(LSCondate) + 1)
                        LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                    End If
                    LMonthType = "M"
                    If (LBQty = 0 And LSQty = 0) Then GoTo EFlag_Next
                    LOrdNo = (TxtRec!F13 & vbNullString):
                    LSTRCONDATE = ltradedt
                    LContime = Right(TxtRec!f12, 8)
                    LEXHCODE = LSItemCode
                    LMonthType = "M"
                    lsparty = LBrokerCode
                    MSPARTY = LBrokerCode
                    If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                    If LenB(LSItemCode) < 1 Then
                        LMsgBox = " Script Missing " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If

                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset

                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                       LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                    Else
                       Set TRec = Nothing
                       Set TRec = New ADODB.Recordset
                       mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                       If LSInstType <> "FUT" Then
                           mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                           mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                       Else
                           mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                       End If
                       TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                       If Not TRec.EOF Then
                           LSMaturity = TRec!MATURITY
                           LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                       Else
                           If LSInstType = "FUT" Then
                                LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                    LSSaudaCode = LSExCode & " " & LSSaudaCode
                                    If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                        LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    End If
                                End If
                            Else
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                        End If
                    End If
                    LSSaudaID = Get_SaudaID(LSSaudaCode)

                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    If LSCondate > LSMaturity Then
                       LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                       ImportIssues (LMsgBox)
                   End If
                   LSEXID = Get_ExID(LSExCode)

                    If LBQty <> 0 Or LSQty <> 0 Then
                      '  lbparty = Left(LPartyName, 6)
                        LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                        mbparty = Get_ACCT_EX(LSEXID, lbparty)
                        If LenB(mbparty) < 1 Then
                            LMsgBox = "New Party " & LPartyName
                            ImportIssues (LMsgBox)
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                        End If
                        MSPARTY = lsparty
                        lbparty = mbparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        If lexceltype = 105 And LOConNo = "" Then
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND contime ='" & LContime & "'"
                        Else
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                        End If
                        Cnn.Execute mysql

                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then
                                LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            DoEvents

                            If LBQty = 0 Then LBQty = LSQty
                            MCount = MCount + 1:
                            LNoTrd = LNoTrd + 1
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If
                Case 108  'ARK
'                    If GUniqClientId = "PRM-MUM" Then
'                        Call ARK_TRD_SingleFile(LSCondate, "O")
'                    Else
                        If MOPEN = "S" Then
                            Call ARK_TRD(LSCondate, "S")
                        Else
                            Call ARK_TRD(LSCondate, "O")
                        End If
'                    End If
                Case 107  '2210 File bazaar
                    If Left(TxtRec!F4, 1) <> "B" And Left(TxtRec!F4, 1) <> "S" Then GoTo EFlag_Next
                    LLOT = 1
                    LNoTrd = LNoTrd + 1
                    LBQty = 0: LSQty = 0
                    lbparty = (Replace(TxtRec!F2, "'", "") & vbNullString):
                    LSCondate = DateValue(LSTRCONDATE)
                    
                    LSTR = Replace(TxtRec!F1, "'", "")
                    'A = InStr(LSTR, ":")
                    'If A = 14 Then
                    '    LOConNo = Left(LSTR, 2) + Trim(Left(LSTR, 2)) + Mid(LSTR, 12, 2) + Mid(LSTR, 15, 2)
                    'Else
                    '    LOConNo = Left(LSTR, 2) + Trim(Left(TxtRec!F5, 2)) + Mid(LSTR, 12, 1) + Mid(LSTR, 14, 2)
                    'End If
                    LOConNo = MCount + 1
                    LPartyName = lbparty & " " & (Replace(TxtRec!F2, "'", "") & vbNullString)
                    LBQty = IIf(IsNull(TxtRec!F5), 0, TxtRec!F5)
                    LBRate = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
                    LSRate = LBRate
                    LSPtyContype = Left(TxtRec!F4, 1)

                    A = Len(TxtRec!f3)
                    LSExCode = Left(TxtRec!f3, 3)
                    If LSExCode = "SGX" Then
                        LSExCode = "NSE"
                    End If
                    If LSExCode = "COM" Then
                        LSExCode = "CMX"
                        LSItemCode = Mid(TxtRec!f3, 7, A - 13)
                        LMONTH = Left(Right(TxtRec!f3, 6), 3)
                    Else
                        LSItemCode = Mid(TxtRec!f3, 5, A - 11)
                        LMONTH = Left(Right(TxtRec!f3, 6), 3)
                    End If
                    lyear = Year(LSCondate)
                    
                    lday = GET_DAYS(LMONTH, lyear, LSCondate)
                    LSTRCONDATE = DateValue(lday & "/" & LMONTH & "/" & lyear)
                    LSMaturity = DateValue(LSTRCONDATE)

                    If month(LSMaturity) < month(LSCondate) Then
                        lyear = (Year(LSCondate) + 1)
                        LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                    End If
                    LMonthType = "M"
                    If (LBQty = 0 And LSQty = 0) Then GoTo EFlag_Next
                    LOrdNo = ""
                    LSTRCONDATE = ltradedt
                    LContime = Right(LSTR, 5)
                    LEXHCODE = LSItemCode
                    lsparty = LBrokerCode
                    MSPARTY = LBrokerCode
                    If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, LLOT, False, True, 1)
                    If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                    If LSExCode = "MCX" Then
                        'LBQty = IIf(IsNull(TxtRec!f8), 0, TxtRec!f8)
                    End If

                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset

                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                       LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                    Else
                       Set TRec = Nothing
                       Set TRec = New ADODB.Recordset
                       mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                       If LSInstType <> "FUT" Then
                           mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                           mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                       Else
                           mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                       End If
                       TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                       If Not TRec.EOF Then
                           LSMaturity = TRec!MATURITY
                           LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                       Else
                           If LSInstType = "FUT" Then
                                LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                    LSSaudaCode = LSExCode & " " & LSSaudaCode
                                    If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                        LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    End If
                                End If
                            Else
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                        End If
                    End If
                    LSSaudaID = Get_SaudaID(LSSaudaCode)

                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    If Left(LSCondate, 10) > LSMaturity Then
                       LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                       ImportIssues (LMsgBox)
                   End If
                   LSEXID = Get_ExID(LSExCode)

                    If LBQty <> 0 Or LSQty <> 0 Then
                      '  lbparty = Left(LPartyName, 6)
                        LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                        mbparty = Get_ACCT_EX(LSEXID, lbparty)
                        If LenB(mbparty) < 1 Then
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                        End If
                        MSPARTY = lsparty
                        lbparty = mbparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If

                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then
                                LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            DoEvents
                            LOrdNo = LFolderName

                            If LBQty = 0 Then LBQty = LSQty
                            MCount = MCount + 1:

                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If
                Case 109  'trader juction oval -TJ'
                    'MCount = LExcelType
                    Call EXCEL_109(MCount, lexceltype)
                Case 110 Or 111
                    Call EXCEL_110(MCount, lexceltype)
                Case 112
                    A = Len(TxtRec!F4)
                    LSExCode = vbNullString
                    LBQty = 0: LSQty = 0: LSExCode = ""
                    If Not IsNumeric(TxtRec!F7) Then GoTo EFlag_Next
                    If TxtRec!F7 = 0 Then GoTo EFlag_Next
                    
                    MCount = MCount + 1
                    LOConNo = MCount
                    LSCondate = ltradedt
                    mbparty = LClientCode
                   ' LPartyName = Trim((TxtRec!F2 & vbNullString))
                    LSItemCode = TxtRec!f22
                    LBRate = IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)
                    LBQty = IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)
                    LSPtyContype = Left(TxtRec!f3, 1)
                    LSRate = LBRate
                    A = Len(LSItemCode)
                    B = Len(TxtRec!F2)
                    
                    If TxtRec!f23 = "FS" Then
                        A = Len(LSItemCode)
                        B = Len(TxtRec!F2)
                        LSTRCONDATE = Mid(TxtRec!F2, A + 2, B - A)
                        LSTRCONDATE = Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/" & Right(LSTRCONDATE, 4)
                    Else
                        A = Len(LSItemCode)
                        B = A + 9
                        LSTRCONDATE = Mid(TxtRec!F2, A + 2, B - A)
                        LSTRCONDATE = Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/" & Right(LSTRCONDATE, 4)
                        LSOptType = Mid(TxtRec!F2, 17, 2)
                        LSInstType = "OPT"
                        LSStrike = Mid(TxtRec!F2, 19, 10)
                    End If
                    LSMaturity = DateValue(LSTRCONDATE)
                    If month(LSMaturity) < month(LSCondate) Then
                        lyear = (Year(LSCondate) + 1)
                        LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                    End If
                    
                    LMonthType = "M"
                    If (LBQty = 0 And LSQty = 0) Then GoTo EFlag_Next
                    'Check Party Name In Accountd
                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    mysql = "SELECT NAME from ACCOUNTD WHERE COMPCODE = " & GCompCode & "  AND AC_CODE = '" & mbparty & "'"
                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If TRec.EOF Then
                        mbparty = NewPartyNM(LSExCode, mparty, LPartyName & " " & LSExCode, LUserId, True)
                    Else
                        LPartyName = TRec!NAME
                    End If
                    
                    LOrdNo = ""
                    LSTRCONDATE = ltradedt
                    LContime = Mid(TxtRec!F15, 12, 5)
                    LEXHCODE = LSItemCode
                    LMonthType = "M"
                    lsparty = LBrokerCode
                    MSPARTY = LBrokerCode
                    If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)

                    If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                    
                    If LSExCode = "MCX" Then
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT LOT from ITEMMAST WHERE COMPCODE = " & GCompCode & "  AND ITEMCODE = '" & LSItemCode & "'"
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If TRec.EOF Then
                            GoTo EFlag_Next
                        Else
                            LBQty = Round(LBQty / TRec!lot, 2)
                        End If
                    End If

                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                    Else
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                        If LSInstType <> "FUT" Then
                            mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                            mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                        Else
                            mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                        End If
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TRec.EOF Then
                            LSMaturity = TRec!MATURITY
                            LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                        Else
                            If LSInstType = "FUT" Then
                                LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                    LSSaudaCode = LSExCode & " " & LSSaudaCode
                                    If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                            LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                            ImportIssues (LMsgBox)
                                            GoTo EFlag_Next
                                    End If
                                End If
                            Else
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                        End If
                    End If
                    LSSaudaID = Get_SaudaID(LSSaudaCode)
                    
                    
                    'Call Get_Sauda_Details(LEXHCODE, False, True, LSMaturity - 5, 2)

                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    If Left(LSCondate, 10) > LSMaturity Then
                        LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                        ImportIssues (LMsgBox)
                    End If
                    LSEXID = Get_ExID(LSExCode)

                    If LBQty <> 0 Or LSQty <> 0 Then
                        If LenB(mbparty) < 1 Then
                            lbparty = Left(LPartyName, 6)
                        ' MBParty = Get_ACCT_EX(LSEXID, lbparty)
                                'If LenB(MBParty) < 1 Then
                                '   MBParty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                                'End If
                            mbparty = Get_ACCT_EX(LSEXID, lbparty)
                            If LenB(mbparty) < 1 Then
                                mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                            End If
                        End If
                        MSPARTY = lsparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        MSPARTY = lsparty
                        lbparty = mbparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                      '  mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                       ' Cnn.Execute mysql

                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then
                                LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            DoEvents

                            If LBQty = 0 Then
                                LBQty = LSQty
                            End If
                            LNoTrd = LNoTrd + 1
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                 End If
                Case 113  'ARK CLIENT
                    Call ARK_TRD(LSCondate, "G", lclientid, LBrokerCode)
                Case 114  'ASHIKA
                    'MCount = LExcelType
                    Call EXCEL_114(MCount, lexceltype, ltradedt)
                Case 115  'ASHIKA
                    'MCount = LExcelType
                    Call EXCEL_114(MCount, lexceltype, ltradedt)
                Case 116  'SMARTGAIN
                    'MCount = LExcelType
                    Call EXCEL_116(MCount, lexceltype, LSCondate, lclientid)
                    
                Case 117  'vertex
                    'MCount = LExcelType
                    Call EXCEL_116(MCount, lexceltype, ltradedt, lclientid)
                Case 118  'NEWARK
                        Call NEWARK(LSCondate, MOPEN, lclientid)
                Case 119  'NEWARK
                        Call NEWARK(LSCondate, "5")
                Case 120 ' CCRUDE OPTION
                        Call EXCEL_120(LSCondate, "120", lclientid, LBrokerCode)
                Case 121
                        If InStr(TxtRec!F1, "(") <> 0 Then
                            If InStr(TxtRec!F1, ")") <> 0 Then
                                 A = InStr(TxtRec!F1, "(")
                                 B = InStr(TxtRec!F1, ")")
                                lclientid = Mid(TxtRec!F1, A + 1, B - (A + 1))
                                LPartyName = Trim(Left(TxtRec!F1, A - 1))
                                LPartyName = LPartyName & " " & lclientid
                             End If
                        Else
                            If Not IsNull(TxtRec!F1) Then
                                If IsNumeric(TxtRec!F1) Then
                                    lclientid = TxtRec!F1
                                End If
                            End If
                        End If
                        Call SAUDA_STD(LSCondate, "121", lclientid, LPartyName)
                Case 122
                    Call EXCEL_122(LSCondate, "120", lclientid, LBrokerCode)
                Case 123
                    Call EXCEL_123(LSCondate, "123", lclientid, LBrokerCode)
                Case 124
                    Call EXCEL_109(MCount, lexceltype)
                Case 125
                    Call EXCEL_123(LSCondate, "123", lclientid, LBrokerCode, lexceltype)
                Case 130 ' mOCEAN/ark TRADEBOOK
                    Call EXCEL_116(MCount, lexceltype, ltradedt, lclientid)
                Case 131 ' mOCEAN TRADEBOOK CMX
                    Call EXCEL_116(MCount, lexceltype, ltradedt, lclientid)
                Case 132 ' goldmine
                    Call EXCEL_116(MCount, lexceltype, ltradedt, lclientid)
                Case 133, 134 ' vertex
                    Call EXCEL_116(MCount, lexceltype, ltradedt, lclientid)
                Case 135 'NEWARK
                        Call NEWARK(LSCondate, "135")
                Case 136 'Zerodha Trade
                        Call NEWARK(LSCondate, "136", lclientid)
                Case 137
                        Call NEWARK(LSCondate, "137", lclientid)
                Case 138 'SKYLINE
                        Call EXCEL_116(MCount, lexceltype, ltradedt, lclientid)
                Case 139 'BUY SELL IN ONE ROW
                        Call EXCEL_139(MCount, lexceltype, ltradedt, lclientid)
                Case 140 'SPECIAL EXCEL
                        Call EXCEL_140(MCount, lexceltype, ltradedt, lclientid)
                Case 338  'Meta Standing
                        LBQty = 0: LSQty = 0: LSExCode = ""
                        If IsNull(TxtRec!F4) Then GoTo EFlag_Next
                        LSPtyContype = TxtRec!F4
                        If LSPtyContype <> "buy" And LSPtyContype <> "sell" Then GoTo EFlag_Next
                        LSExCode = TxtRec!F10
                        If Left(LSPtyContype, 1) = "b" Then
                            LSPtyContype = "B"
                        Else
                            LSPtyContype = "S"
                        End If
                        lbparty = TxtRec!F1
                        LPartyName = (TxtRec!F1 & vbNullString)
                        LSExCode = TxtRec!F10
                        LOConNo = TxtRec!F2
                        If LSExCode = "MCX" Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Right(TxtRec!f3, 3)
                            lyear = Year(ltradedt)
                        ElseIf LSExCode = "CMX" Then
                            LSTR = Right(TxtRec!f3, 3)
                            If InStr(LSTR, "01") <> 0 Or InStr(LSTR, "02") <> 0 Or InStr(LSTR, "03") <> 0 Or _
                                InStr(LSTR, "04") <> 0 Or InStr(LSTR, "05") <> 0 Or InStr(LSTR, "06") <> 0 Or _
                                InStr(LSTR, "07") <> 0 Or InStr(LSTR, "08") <> 0 Or InStr(LSTR, "09") <> 0 Or _
                                InStr(LSTR, "10") <> 0 Or InStr(LSTR, "11") <> 0 Or InStr(LSTR, "12") <> 0 Then
                    
                                LMONTH = Right(LSTR, 2)
                                lyear = Year(ltradedt)
                            Else
                                LMONTH = Get_CMX_Month(Left(LSTR, 1))
                                lyear = "20" + Right(LSTR, 2)
                            End If
                        
                            LSItemCode = "CMX " + Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            
                        ElseIf LSExCode = "NSE" Then
                            If InStr(TxtRec!f3, "SGXNIFTY") = 0 Then
                                If Right(TxtRec!f3, 1) = "Q" Then
                                    LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                                    LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                    lyear = Year(ltradedt)
                                Else
                                    LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                                    LMONTH = Right(TxtRec!f3, 3)
                                    lyear = Year(ltradedt)
                                End If
                            Else
                                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                                LMONTH = Right(TxtRec!f3, 3)
                                lyear = Year(ltradedt)
                            End If
                        End If
                        If Right(TxtRec!F5, 1) = "K" Then
                            LBQty = Val(Left(TxtRec!F5, Len(TxtRec!F5) - 1)) * 1000
                        Else
                            LBQty = Val(TxtRec!F5)
                        End If
                        
                        LBRate = TxtRec!f6
                        lday = GET_DAYS(LMONTH, lyear, LSCondate)
                        LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                        
                                                            
                        If (LBQty = 0 And LSQty = 0) Then GoTo EFlag_Next

                        'LOConNo = Get_Max_ConNo(LSCondate, 0)
                        LOrdNo = ""
                        LSTRCONDATE = ltradedt
                        LContime = ""
                        LEXHCODE = LSItemCode
                        LMonthType = "M"
                        lsparty = LBrokerCode
                        MSPARTY = LBrokerCode
                     
                        If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
                     
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                     
                        If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                        
                        ''
                        If LMonthType = "M" Then
                            Set TRec = Nothing: Set TRec = New ADODB.Recordset
                            If LSInstType = "FUT" Then
                                mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                            Else
                                mysql = "SELECT SAUDACODE ,SAUDAID,MATURITY FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE = " & LSStrike & ""
                            End If
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec.EOF Then
                                LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                            Else
                                mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                                If LSInstType <> "FUT" Then
                                    mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                                    mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                                Else
                                    mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                                End If
                                Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                                If Not TRec.EOF Then
                                    LSMaturity = TRec!MATURITY: LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                Else
                                    If LSInstType = "FUT" Then
                                        LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                        If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                            LSSaudaCode = LSExCode & " " & LSSaudaCode
                                            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                                LMsgBox = "Please Check Entry for " & LSSaudaCode & "": ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                                            End If
                                        End If
                                    Else
                                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & "": ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                                    End If
                                    Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                                End If
                                LSSaudaID = Get_SaudaID(LSSaudaCode)
                            End If
                        End If
                        
                        ''''
                        'Call Get_Sauda_Details(LEXHCODE, False, True, DateValue(LMaturity), 2)
                       
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                        End If
                        LSEXID = Get_ExID(LSExCode)

                     If LBQty <> 0 Or LSQty <> 0 Then
                        lbparty = Left(LPartyName, 15)
                        mbparty = Get_ACCT_EX(LSEXID, lbparty)
                        If LenB(mbparty) < 1 Then
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                        End If
                        MSPARTY = lsparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                       ' mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                       ' Cnn.Execute mysql

                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then
                                LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            LNoTrd = LNoTrd + 1
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            DoEvents
                            
                            If LBQty = 0 Then
                               LBQty = LSQty
                            End If
                            LSRate = LBRate
                            
                            MCount = MCount + 1:
                            LOConNo = Trim(str(MCount))
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If
                    
               End Select
EFlag_Next:
               TxtRec.MoveNext
            Wend
        End If
    End If
    
    If lexceltype = 108 Then
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & "CLOSE.CSV"
        LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
        
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                ldate = LSCondate
            

                MCount = Get_Max_ConNo(LSCondate, 0)
                            
                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LSOptType = vbNullString:     LSStrike = 0:                 LLOT = 0:
                    LBQty = 0:                    LSQty = 0:                    LBRate = 0:                   LSRate = 0
                    LSSaudaID = 0:                LSItemid = 0: LSEx_Symbol = vbNullString
                    LMonthType = "M": LBillExId = ""
                    Vexcelcolval = "":                    Vitemcode = "":                    Vday = 0:                    Vmonth = "":                    Vrate = 0:                    Vlastchar = "":                    Vdate = "01/01/1900"
                    If IsNull(TxtRec!F2) Then GoTo EFlag_Next1
                    LSTRCONDATE = ltradedt
                    
                    Call ARK_TRD(LSCondate, "C")
                    
EFlag_Next1:
               TxtRec.MoveNext
                Wend
            End If
        End If
    
    End If
    LMsgBox = " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
    ImportIssues (LMsgBox)
    'MsgBox " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
Next
    Cnn.CommitTrans
    CNNERR = False
    Set TxtRec = Nothing
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Sub Save_AllTrade_Excel_102(lexceltype As Integer)
 
Dim LIFLAG As Boolean:          Dim lbparty As String:          Dim lsparty As String:          Dim LBQty As Double:        Dim LSQty As Double:           Dim LBRate As Double:           Dim LSRate As Double:           Dim ldate As Date
Dim ltradedt As Date: Dim LTradeDt1 As Date:          Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String:    Dim MCount As Long:            Dim LConType As String:         Dim LSConSno As Long:           Dim LQTY As Double:
Dim LRATE As Double:            Dim LContime As String:         Dim LOrdNo As String:           Dim LOrdTime As String:     Dim StrDateLen As Integer:     Dim LSTRDATE As String:         Dim LMONTH As String:           Dim lyear As String
Dim LClient As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:      Dim TRec As ADODB.Recordset:   Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String
Dim LEXHCODE As String:         Dim LSItemName As String:       Dim LSTRCONDATE  As String:     Dim A As Integer:           Dim LFieldName As String:      Dim fld As ADODB.Field:         Dim LCMONTH As String
Dim LMFLPath As String:         Dim B As Integer:               Dim LSTR As String:             Dim LStrMonth As String:       Dim lday As Integer:            Dim LAcExCode As String:        Dim C As Integer
Dim LMXDate As Date:            Dim LSCondate As Date:          Dim LOConNo As String:          Dim LSPtyContype As String: Dim LSettleRate As Double:      Dim Vexcelcolval As String:          Dim Vitemcode As String:            Dim Vday As Integer:            Dim Vmonth As String
Dim Vrate As Double:            Dim Vlastchar As String:        Dim Vdate As Date:              Dim VYear As String:        Dim Vexchange As String
On Error GoTo err1
Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
Call GET_JCnn("\" & LFolderName & "\;")
MSPARTY = LBrokerCode

Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
    LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
End If
Set LFileSystemObject = Nothing
                
LFileName = ""
Cnn.BeginTrans
CNNERR = True:
For ltradedt = vcDTP1.Value To vcDTP2.Value
        
    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        
    LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
    LNoTrd = 0
    If Not FileExist(LFileName) Then
        LMsgBox = LFileName & "  file not found" ', vbCritical
        ImportIssues (LMsgBox)
    Else
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
        TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        If Not TxtRec.EOF Then
            FlagDataTrf = True
            CNNERR = True
            TxtRec.MoveFirst
            LSCondate = DateValue(ltradedt)
            ldate = LSCondate
            If MsgBox("Do You Want to Delete Trades of  Folder " & LFolderName & "  File Type " & lexceltype & " Of " & str(LSCondate) & " ", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='" & lexceltype & "'"
            End If
            LNoTrd = 0
            MCount = Get_Max_ConNo(LSCondate, 0)
            While Not TxtRec.EOF

               If (TxtRec!f3 & vbNullString) <> "Expiry" Then
                    lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LSOptType = vbNullString:     LSStrike = 0:                 LLOT = 0:
                    LBQty = 0:                    LSQty = 0:                    LBRate = 0:                   LSRate = 0
                    LSSaudaID = 0:                LSItemid = 0: LSEx_Symbol = vbNullString
                    LMonthType = "M"
                    Vexcelcolval = "":                    Vitemcode = "":                    Vday = 0:                    Vmonth = "":                    Vrate = 0:                    Vlastchar = "":                    Vdate = "01/01/1900"
                    
                   
                    '>>> LSExCode, LBParty, LPartyName, LBParty
                    LSExCode = vbNullString
                    lbparty = Trim(TxtRec!F1)
                    LSItemCode = Trim(TxtRec!F2 & vbNullString)
                    LOConNo = "" '>>>LOConNo = TxtRec!f1:
                    LOrdNo = ""     '>>>(TxtRec!F2 & vbNullString)
                    
                    'LStrConDate = Left$(TxtRec!F3, 10)
                   If (TxtRec!f3 & vbNullString) <> "" And (TxtRec!f3 & vbNullString) <> "Expiry" Then
                        Vday = Left(Left$(TxtRec!f3, 10), 2)  '>>> 2 char day
                        Vmonth = Mid(Left$(TxtRec!f3, 10), 4, 3)  '>>> 3 char month like JAN, FEB, MAR ...
                        VYear = CStr(Left(Year(Date), 2)) + Mid(Left$(TxtRec!f3, 10), 8, Len(Left$(TxtRec!f3, 10)))
                                    
                        If UCase(Vmonth) = "JAN" Or UCase(Vmonth) = "JA" Then
                            Vdate = CStr(Vday) + "/01/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "FEB" Or UCase(Vmonth) = "FE" Then
                            Vdate = CStr(Vday) + "/02/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "MAR" Or UCase(Vmonth) = "MA" Then
                            Vdate = CStr(Vday) + "/03/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "APR" Or UCase(Vmonth) = "AP" Then
                            Vdate = CStr(Vday) + "/04/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "MAY" Or UCase(Vmonth) = "MA" Then
                            Vdate = CStr(Vday) + "/05/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "JUN" Or UCase(Vmonth) = "JU" Then
                            Vdate = CStr(Vday) + "/06/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "JUL" Or UCase(Vmonth) = "JU" Then
                            Vdate = CStr(Vday) + "/07/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "AUG" Or UCase(Vmonth) = "AU" Then
                            Vdate = CStr(Vday) + "/08/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "SEP" Or UCase(Vmonth) = "SE" Then
                            Vdate = CStr(Vday) + "/09/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "OCT" Or UCase(Vmonth) = "OC" Then
                            Vdate = CStr(Vday) + "/10/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "NOV" Or UCase(Vmonth) = "NO" Then
                            Vdate = CStr(Vday) + "/11/" + CStr(Year(Date))
                        ElseIf UCase(Vmonth) = "DEC" Or UCase(Vmonth) = "DE" Then
                            Vdate = CStr(Vday) + "/12/" + CStr(Year(Date))
                        End If
                        LSMaturity = DateValue(Vdate)
                    End If
                    
                    LContime = "" '>>>Right(TxtRec!F2, 8)
                    LSPtyContype = "" '>>>UCase(Left(TxtRec!F5, 1)):
                   
                    If Val(TxtRec!F4 & vbNullString) > 0 Then
                        LSPtyContype = "B"
                    Else
                        LSPtyContype = "S"
                        lsparty = lbparty
                    End If
                                        
                    LBQty = Abs(Val(TxtRec!F4 & vbNullString))
                    LBRate = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5)):
                    LSRate = LBRate
                        
                    LPartyName = lbparty

                    Vexchange = "MCX"
                    


                    LSTRCONDATE = DateValue(ltradedt) '>>>"26/03/2021"
                    LSMaturity = DateValue(LSTRCONDATE)
                    LEXHCODE = LSItemCode
                    
                    If month(LSMaturity) < month(LSCondate) Then
                        lyear = (Year(LSCondate) + 1)
                        LSTRCONDATE = "26" & "/" & month(LSMaturity) & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                    End If
                    LMonthType = "M"
                                        
                    
                    'If LenB(LExhCode) < 1 Then GoTo EFlag_Next
                    
                    If LSItemCode <> "" Then
                            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                            
                            If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                            
                            Call Get_Sauda_Details(LEXHCODE, False, True, LSCondate, 2)
                                
                            If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                            If LSCondate > LSMaturity Then
                                LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                                ImportIssues (LMsgBox)
                            End If
                            LSEXID = Get_ExID(LSExCode)
                    End If
                    
                 
                                
                
                If lbparty = "ABHISHEK TRADES" Then
                    lbparty = Trim(TxtRec!F1)
                End If
                mbparty = Get_ACCT_EX(LSEXID, lbparty)
                If LenB(mbparty) < 1 Then
                    mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                End If
                
                'If IsNull(TxtRec!F4) = True Or MBParty = "" Then GoTo EFlag_Next
                    
                    
                    If (TxtRec!f3 & vbNullString) <> "" And (TxtRec!f3 & vbNullString) <> "Expiry" Then
                         If LBQty <> 0 Or LSQty <> 0 Then
                             lsparty = mbparty
                             If LenB(mbparty) < 1 Then
                                 LMsgBox = " Client does Not Exist " & lbparty & ""
                                 ImportIssues (LMsgBox)
                                 GoTo EFlag_Next
                             End If
                             MCount = MCount + 1:
                             If InStr(LBillExId, str(LSEXID)) = 0 Then
                                 If LenB(LBillExId) > 0 Then
                                     LBillExId = LBillExId & ","
                                     LBillExId = LBillExId & str(LSEXID)
                                 End If
                                 If lminbilldate > LSCondate Then lminbilldate = LSCondate
                                 LNoTrd = LNoTrd + 1
                                 GETMAIN.Label1.Caption = "Trade No " & LNoTrd '>>>& " " & TxtRec!F9
                                 DoEvents
                                 LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                                 Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                             End If
                        End If
                         End If
               End If  '>>> If TxtRec!F3 <> "" Then
EFlag_Next:
               TxtRec.MoveNext
            Wend
        End If
    End If
Next
    MsgBox " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
     MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub
Sub Save_AllTrade_Excel_1_39(lexceltype As Integer, Optional lqtylot As Integer)
Dim LIFLAG As Boolean:          Dim lbparty As String:          Dim lsparty As String:          Dim LBQty As Double
Dim LSQty As Double:            Dim LBRate As Double:           Dim LSRate As Double:           Dim ldate As Date
Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
Dim MCount As Long:             Dim LConType As String:         Dim LPtyContype As String:      Dim LSConSno As Long
Dim LQTY As Double:             Dim LRATE As Double:            Dim LContime As String:         Dim LOrdNo As String
Dim LOrdTime As String::        Dim LSCondate As Date:          Dim LOConNo As String:          Dim LCONTIME2 As String
Dim StrDateLen As Integer:      Dim LSTRDATE As String:         Dim LMONTH As String:           Dim lyear As String
Dim LClient As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
Dim TRec As ADODB.Recordset:    Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String
Dim LSItemName As String:       Dim LSTRCONDATE  As String:     Dim A As Integer
Dim LFieldName As String:       Dim fld As ADODB.Field:         Dim LEx_Symbol  As String:      Dim LCMONTH As String
Dim LMFLPath As String:         Dim B As Integer:               Dim LSTR As String:
Dim LStrMonth As String:        Dim lday As Integer:            Dim LAcExCode As String:        Dim C As Integer
Dim Vexchange As String:        Dim CF As Integer:              Dim lfiletype As Integer
Dim MDt As String
Dim LSTR2 As String

On Error GoTo err1
    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    Call GET_JCnn("\" & LFolderName & "\;")
    MSPARTY = LBrokerCode
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
        LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
    End If
    Set LFileSystemObject = Nothing
                
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
 
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            '>>> ADDED CONDITION LExcelType = 29 HERE TO CREATE SCHEMA FILE
            If lexceltype = 25 Or lexceltype = 29 Then
                LMFLPath = App.Path & "\" & LFolderName & "\"
                Call Create_Schema_Excel25(LMFLPath, TxtPath)
            ElseIf lexceltype = 1 Then
                Call Create_Schema_Excel1(LMFLPath, TxtPath)
            End If
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                ldate = LSCondate
                lfiletype = 0
                If lexceltype = 14 Then
                    lfiletype = lexceltype
                    lexceltype = 15
                End If
                If lexceltype = 25 Or lexceltype = 10 Or lexceltype = 29 Or lexceltype = 2 Then
                Else
                    'If MsgBox("Are you Sure to Delete Trades of  " & LSCondate & " of File Type  " & lexceltype & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT = 1 AND FILETYPE='" & Trim(str(lexceltype)) & "'"
                    'End If
                End If
                LNoTrd = 1
                MCount = Get_Max_ConNo(LSCondate, 0)

                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LSOptType = vbNullString:     LSStrike = 0:                 LLOT = 0:
                    LBQty = 0:                    LSQty = 0:                    LBRate = 0:                   LSRate = 0
                    LSSaudaID = 0:                LSItemid = 0:                 LSExCode = vbNullString:      LCONTIME2 = Time
                    LSEXID = 0: CF = 0
                    LMonthType = "M":
                    
                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                    Select Case lexceltype
                    Case 10
                        If IsNull(TxtRec!F7) Then GoTo EFlag_Next
                        If Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s") Then GoTo EFlag_Next
                        LSExCode = "NSE"
                        If ChkNseExcel.Value = 1 Then LSExCode = "NSE"
                        If Check39.Value = 1 Then LSExCode = "MCX"
                        LOConNo = TxtRec!F1
                        LOrdNo = (TxtRec!f3 & vbNullString)
                        lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
                        LPartyName = TxtRec!F5
                        LSTRCONDATE = Left$(TxtRec!f6, 10)
                        LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                        LPtyContype = UCase(Left(TxtRec!F7, 1))
                        A = InStr(TxtRec!F9, "-")
                        If A = 0 Then
                            A = InStr(TxtRec!F9, "/")
                            If A = 0 Then
                                LSTR = UCase(Right(TxtRec!F9, 5))
                                If Left(LSTR, 3) = "JAN" Or Left(LSTR, 3) = "FEB" Or Left(LSTR, 3) = "MAR" Or Left(LSTR, 3) = "APR" _
                                Or Left(LSTR, 3) = "MAY" Or Left(LSTR, 3) = "JUN" Or Left(LSTR, 3) = "JUL" Or Left(LSTR, 3) = "AUG" _
                                Or Left(LSTR, 3) = "SEP" Or Left(LSTR, 3) = "OCT" Or Left(LSTR, 3) = "NOV" Or Left(LSTR, 3) = "DEC" Then
                                    A = Len(TxtRec!F9)
                                    LEXHCODE = Left(TxtRec!F9, A - 5)
                                    LMONTH = Left(LSTR, 3)
                                    lyear = "20" & Right(LSTR, 2)
                                    LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                    LSMaturity = DateValue(LSTRCONDATE)
                                Else
                                    LEXHCODE = Left(TxtRec!F9, 2)
                                    LSTRCONDATE = Right(TxtRec!F9, 3)
                                    lyear = "20" & Right(LSTRCONDATE, 2)
                                    LMONTH = Get_CMX_Month(Left(LSTRCONDATE, 1))
                                    LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                    LSMaturity = DateValue(LSTRCONDATE)
                                End If
                            Else
                                LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                lyear = Year(LSCondate)
                                LMONTH = Right(TxtRec!F9, 2)
                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                            End If
                        Else
                            B = InStr(TxtRec!F9, "/")
                            If B = 0 Then
                                LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                LSTRCONDATE = Right(TxtRec!F9, 3)
                                lyear = "20" & Right(LSTRCONDATE, 2)
                                LMONTH = Get_CMX_Month(Left(LSTRCONDATE, 1))
                                LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                LSMaturity = DateValue(LSTRCONDATE)
                            Else
                                LEXHCODE = Trim(Left(TxtRec!F9, B - 1))
                                lyear = Year(LSCondate)
                                LMONTH = Right(TxtRec!F9, 2)
                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")

                            End If
                        End If
                        If Right(TxtRec!F10, 1) = "K" Then
                            LBQty = Val(Left(TxtRec!F10, Len(TxtRec!F10) - 1)) * 1000
                        Else
                            LBQty = Val(TxtRec!F10)
                        End If
                        If month(LSMaturity) < month(LSCondate) Then
                            lyear = Year(LSCondate) + 1
                            LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                        End If
                        LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)):
                        LSRate = LBRate
                        lsparty = LBrokerCode
                    Case 1
                        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                        LSCondate = DateValue(TxtRec!F1):                        LEXHCODE = TxtRec!F2
                        LSMaturity = DateValue(GFinEnd):                         lbparty = Get_AccountMCode(TxtRec!f3)
                        LSInstType = "CSH"
                        If LenB(lbparty) < 1 Then
                            LMsgBox = "Accountcode not defined for" & TxtRec!f3 & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        LConType = UCase(Left(TxtRec!F4, 1))
                        LBQty = Val(TxtRec!F5 & vbNullString):                    LBRate = Val(TxtRec!f6 & vbNullString)
                        LSRate = LBRate
                        lsparty = (TxtRec!F7 & vbNullString)
                        'If LenB(LSParty) < 1 Then
                        '    MsgBox "Broker Code not defined for" & TxtRec!f7 & ""
                        '    GoTo EFlag_Next
                        'End If
                    Case 2
                        lbparty = Trim(IIf(IsNull(TxtRec!F1), vbNullString, (TxtRec!F1))):
                        If Not IsNull(TxtRec!F1) Then LSTRCONDATE = IIf(IsNull(TxtRec!F2), vbNullString, TxtRec!F2)
                        If Not IsDate(LSTRCONDATE) Then GoTo EFlag_Next
                        LSCondate = DateValue(TxtRec!F2)
                        LConType = Left$(TxtRec!f3, 1)
                        LEXHCODE = Trim(IIf(IsNull(TxtRec!F4), vbNullString, TxtRec!F4)):
                        LSMaturity = DateValue(TxtRec!F5)
                        LBQty = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6))
                        LBRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                        LSRate = LBRate
                        LSInstType = "FUT"
                        lsparty = LBrokerCode
                        
                        If InStr(MDt, LSCondate) = 0 Then
                            MDt = MDt + Left(LSCondate, 10) + ","
                            Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT=1 AND FILETYPE='" & lexceltype & "'"
                        End If
                    Case 31
                        LSCondate = DateValue(TxtRec!F1)
                        LEXHCODE = Trim(IIf(IsNull(TxtRec!F2), vbNullString, TxtRec!F2))
                        LSMaturity = DateValue(TxtRec!f3)
                        lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
                        LBQty = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7))
                        If LBQty > 0 Then
                            LConType = "B"
                        Else
                            LConType = "S"
                        End If
                        LBRate = Val(IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)):
                        LSRate = LBRate
                        lsparty = Trim(IIf(IsNull(TxtRec!F9), vbNullString, (TxtRec!F9)))
                    Case 11
                        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not (UCase(TxtRec!F7) = "BUY" Or UCase(TxtRec!F7) = "SELL") Then GoTo EFlag_Next
                        lbparty = Trim(IIf(IsNull(TxtRec!F1), vbNullString, (TxtRec!F1))):
                        LPartyName = lbparty:                        LSExCode = Left(TxtRec!F2, 3)
                        LEXHCODE = Trim(TxtRec!f3)
                        LSMaturity = DateValue(Left(TxtRec!F4, 2) & "/" & Mid(TxtRec!F4, 4, 3) & "/20" & Right(TxtRec!F4, 2))
                        LPtyContype = UCase(Left(TxtRec!F7, 1))
                        LBQty = Val(TxtRec!F8):                        LBRate = Val(TxtRec!F9)
                        LSRate = LBRate:                               LOConNo = TxtRec!F14
                        LOrdNo = (TxtRec!F14 & vbNullString)
                        LSTRCONDATE = Left$(TxtRec!f11, 10)
                        LSCondate = DateValue(LSTRCONDATE)
                        LContime = Right(TxtRec!f11, 5)
                        lsparty = LBrokerCode
                    Case 12
                        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not (UCase(TxtRec!F7) = "BUY" Or UCase(TxtRec!F7) = "SELL") Then GoTo EFlag_Next
                        lbparty = Trim(IIf(IsNull(TxtRec!F1), vbNullString, (TxtRec!F1))):
                        LPartyName = TxtRec!F2:                        LSExCode = TxtRec!f3
                        LEXHCODE = Trim(TxtRec!F4)
                        LSMaturity = DateValue(Left(TxtRec!F5, 2) & "/" & Mid(TxtRec!F5, 4, 3) & "/" & Right(TxtRec!F5, 4))
                        LPtyContype = UCase(Left(TxtRec!F8, 1))
                        LQTY = Val(TxtRec!F9):                        LRATE = Val(TxtRec!F10)
                        LOConNo = TxtRec!F14:                         LOrdNo = (TxtRec!F14 & vbNullString)
                        LSTRCONDATE = Left$(TxtRec!f11, 10)
                        LSCondate = DateValue(ltradedt)
                        LContime = TxtRec!F13
                    Case 15
                        If Not IsNumeric(TxtRec!f6) Then GoTo EFlag_Next
                        LSCondate = DateValue(TxtRec!F1)
                        lbparty = Trim(IIf(IsNull(TxtRec!F2), vbNullString, (TxtRec!F2))):
                        LEXHCODE = Trim(IIf(IsNull(TxtRec!f3), vbNullString, TxtRec!f3))
                        LSMaturity = DateValue(TxtRec!F4)
                        If IsNumeric(TxtRec!F5) Then
                            LBQty = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
                            If LBQty > 0 Then
                                LConType = "B"
                            Else
                                LConType = "S"
                                LBQty = Abs(LBQty)
                            End If
                            LBRate = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):
                            LSRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                            If LSRate = 0 Then
                                LSRate = LBRate
                            End If
                            lsparty = Trim$(IIf(IsNull(TxtRec!F8), vbNullString, (TxtRec!F8))):
                            If Not IsNull(TxtRec!F9) Then
                                If TxtRec!F9 = "CSH" Then
                                    LSInstType = "CSH"
                                    LSOptType = vbNullString
                                    LSStrike = 0
                                End If
                            End If
                            If Not IsNull(TxtRec!F10) Then
                                If IsNumeric(TxtRec!F10) Then
                                    If Val(TxtRec!F10) <> 0 Then
                                        LSInstType = "OPT": LSOptType = Left$(TxtRec!F9, 2): LSStrike = Val(TxtRec!F10 & vbNullString)
                                    End If
                                End If
                            End If
                            LFieldName = "F11"
                            For Each fld In TxtRec.Fields
                                If UCase(fld.NAME) = LFieldName Then
                                    If Not IsNull(TxtRec!f11) Then
                                        LContime = TxtRec!f11
                                        Exit For
                                    End If
                                End If
                            Next
                         Else
                            If TxtRec!F5 <> "B" And TxtRec!F5 <> "S" Then GoTo EFlag_Next
                            LBQty = Abs(Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)))
                            LConType = TxtRec!F5
                            LBRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                            LSRate = Val(IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)):
                            If LSRate = 0 Then LSRate = LBRate
                            lsparty = Trim$(IIf(IsNull(TxtRec!F9), vbNullString, (TxtRec!F9))):
                            If Not IsNull(TxtRec!F10) Then
                                If TxtRec!F10 = "CSH" Then
                                    LSInstType = "CSH"
                                    LSOptType = vbNullString
                                    LSStrike = 0
                                End If
                            End If
                            If Not IsNull(TxtRec!f11) Then
                                If IsNumeric(TxtRec!f11) Then
                                    If Val(TxtRec!f11) <> 0 Then
                                        LSInstType = "OPT": LSOptType = Left$(TxtRec!F10, 2): LSStrike = Val(TxtRec!f11 & vbNullString)
                                    End If
                                End If
                            End If
                            LFieldName = "F12"
                            For Each fld In TxtRec.Fields
                                If UCase(fld.NAME) = LFieldName Then
                                    If Not IsNull(TxtRec!f12) Then
                                        LContime = TxtRec!f12
                                        Exit For
                                    End If
                                End If
                            Next
                        End If
                    Case 16
                        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not IsNumeric(TxtRec!F5) Then GoTo EFlag_Next
                        LSCondate = DateValue(TxtRec!F1)
                        lbparty = Trim(IIf(IsNull(TxtRec!F2), vbNullString, (TxtRec!F2))):
                        A = InStr(TxtRec!f3, "|")
                        LEXHCODE = Left$(Trim(IIf(IsNull(TxtRec!f3), vbNullString, TxtRec!f3)), A - 1)
                        LMONTH = Mid(TxtRec!f3, A + 1, Len(TxtRec!f3) - A)
                        lyear = Year(LSCondate)
                        ldate = DateValue("28/" & LMONTH & "/" & lyear)
                        If month(ldate) < month(LSCondate) Then
                            lyear = str(Val(lyear) + 1)
                            ldate = DateValue("28/" & LMONTH & "/" & lyear)
                        End If
                        LSMaturity = DateValue(ldate)
                        LConType = Left(TxtRec!F4, 1)
                        LPtyContype = LConType
                        LBQty = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
                        LBRate = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):
                        LSRate = LBRate
                        lsparty = Trim$(IIf(IsNull(TxtRec!F7), vbNullString, (TxtRec!F7))):
                        LOConNo = TxtRec!F8

                    'case17function
                    Case 20
                        If Not IsNumeric(TxtRec!F4) Then GoTo EFlag_Next
                        LSExCode = "MCX"
                        A = InStr(TxtRec!F1, "-")
                        LSTRCONDATE = Left(TxtRec!F1, A - 1) & "/" & Mid(TxtRec!F1, A + 1, 3) & "/20" & Right(TxtRec!F1, 2) & ""
                        LSCondate = DateValue(LSTRCONDATE)
                        A = InStr(TxtRec!F2, " ")
                        LEXHCODE = Left(TxtRec!F2, A - 1)
                        LMONTH = Right(RTrim(TxtRec!F2), 3)
                        LSMaturity = DateValue("28/" & LMONTH & "/" & Year(ltradedt))
                        If month(LSMaturity) < month(ltradedt) Then
                            LSMaturity = DateValue("28/" & LMONTH & "/" & Year(ltradedt) + 1)
                        End If
                        LPtyContype = Left(TxtRec!f3, 1)
                        LBQty = Val(TxtRec!F4)
                        LBRate = Val(TxtRec!F5)
                        LSRate = LBRate
                        lbparty = Trim(IIf(IsNull(TxtRec!f6), vbNullString, (TxtRec!f6))):
                        lsparty = Trim$(IIf(IsNull(TxtRec!F7), vbNullString, (TxtRec!F7))):
                        LOConNo = TxtRec!F8
                    Case 21
                        LSExCode = vbNullString
                        LSEXID = 0
                        LSInstType = "FUT"
                        If Not IsNumeric(TxtRec!F7) Then GoTo EFlag_Next
                        LSExCode = "NSE"
                        LSTRCONDATE = Left(TxtRec!F1, 2) & "/" & Mid(TxtRec!F1, 4, 3) & "/20" & Right(TxtRec!F1, 2) & ""
                        LSCondate = DateValue(LSTRCONDATE)
                        LEXHCODE = Trim(TxtRec!F2)
                        LSTRCONDATE = Left(TxtRec!f3, 2) & "/" & Mid(TxtRec!f3, 4, 3) & "/20" & Right(TxtRec!f3, 2) & ""
                        LSMaturity = DateValue(LSTRCONDATE)
                        If Not IsNull(TxtRec!F5) Then LSOptType = Trim(TxtRec!F5)
                        
                        If LSOptType = "CE" Or LSOptType = "PE" Then
                            LSInstType = "OPT"
                            LSStrike = Val(TxtRec!F4)
                        End If
                        LPtyContype = Left(TxtRec!f6, 1)
                        LBQty = Val(TxtRec!F7)
                        LBRate = Val(TxtRec!F8)
                        LSRate = LBRate
                        lbparty = Trim(IIf(IsNull(TxtRec!F9), vbNullString, (TxtRec!F9))):
                        lsparty = Trim$(IIf(IsNull(TxtRec!F10), vbNullString, (TxtRec!F10))):
                        LOConNo = TxtRec!f11
                    Case 22
                        LSOptType = vbNullString
                        LSStrike = 0
                        LSInstType = "FUT"
                        If IsNull(TxtRec!f11) Then GoTo EFlag_Next
                        If Not IsNumeric(TxtRec!F10) Then GoTo EFlag_Next
                        LSExCode = "MCX"
                        LSTRCONDATE = Left(TxtRec!f6, 10)
                        LSTRCONDATE = Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4) & ""
                        LSCondate = DateValue(LSTRCONDATE)
                        A = InStr(TxtRec!F9, "-")

                        LEXHCODE = Left(TxtRec!F9, A - 1)
                        LMONTH = Right(LEXHCODE, 3)
                        LEXHCODE = Left(TxtRec!F9, A - 4)
                        lyear = Year(LSCondate)
                        LSTRCONDATE = "28/" & LMONTH & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                        LPtyContype = UCase(Left(TxtRec!F7, 1))
                        LBQty = Val(TxtRec!F10)
                        LBRate = Val(TxtRec!f11)
                        LSRate = LBRate
                        lbparty = Trim(TxtRec!F4):
                        lsparty = LExCont
                        LOConNo = TxtRec!F1
                    Case 28
                        If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                        If Not IsDate(TxtRec!F1) Then GoTo EFlag_Next
                        If Not IsDate(TxtRec!f3) Then GoTo EFlag_Next
                        LBQty = IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)
                        LSQty = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
                        
                        LSRate = IIf(IsNull(TxtRec!F5), 0, TxtRec!F5)
                        LBRate = IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)
                       
                        If LBQty = 0 And LSQty = 0 Then GoTo EFlag_Next
                        If LBRate = 0 And LSRate = 0 Then GoTo EFlag_Next
                        
                        LSTRCONDATE = Left$(TxtRec!F1, 10)
                        LEXHCODE = (TxtRec!F2 & vbNullString)
                        LSMaturity = TxtRec!f3
                        LCONTIME2 = IIf(IsNull(Trim(TxtRec!F4)), "", Trim(TxtRec!F4))
                        lbparty = Trim(TxtRec!F8)
                        LContime = IIf(IsNull(Trim(TxtRec!F9)), "", Trim(TxtRec!F9))
                        lsparty = LBrokerCode
                    Case 29
                        If IsNull(TxtRec!F4) Then GoTo EFlag_Next

                        If Not (Left(TxtRec!F4, 1) = "b" Or Left(TxtRec!F4, 1) = "s") Then GoTo EFlag_Next
                        If InStr(1, TxtRec!F5, "in") = 0 And InStr(1, TxtRec!F5, "out") = 0 Then GoTo EFlag_Next
                        If IsNull(TxtRec!F2) Then GoTo EFlag_Next
                        

                        LOConNo = TxtRec!F2
                        LOrdNo = (TxtRec!F2 & vbNullString)
                        lbparty = LClientCode
                        LSTRCONDATE = Left$(TxtRec!F1, 10)
                        If IsDate(LSTRCONDATE) Then
                            LSCondate = DateValue(LSTRCONDATE)
                        Else
                            LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                        End If
                        
                        LPtyContype = UCase(Left(TxtRec!F4, 1))
                        If IsNull(TxtRec!f3) Then GoTo EFlag_Next
                        If LenB(TxtRec!f3) < 1 Then GoTo EFlag_Next
                        A = 0
                        
'        ElseIf InStr(TxtRec!f9, "_I") <> 0 Or InStr(TxtRec!f9, "_II") <> 0 Or InStr(TxtRec!f9, "_III") Or InStr(TxtRec!f9, "_IV") _
'            Or InStr(TxtRec!f9, "_V") <> 0 Or InStr(TxtRec!f9, "_VI") <> 0 Or InStr(TxtRec!f9, "_VII") Or InStr(TxtRec!f9, "_VIII") _
'            Or InStr(TxtRec!f9, "_IX") <> 0 Or InStr(TxtRec!f9, "_X") <> 0 Or InStr(TxtRec!f9, "_XI") Or InStr(TxtRec!f9, "_XII") Then
                        
                        
                        If InStr(TxtRec!f3, "SGX-NIFTY") = 0 And InStr(TxtRec!f3, "MCDOWELL-N") = 0 And InStr(TxtRec!f3, "BAJAJ-AUTO") = 0 And InStr(TxtRec!f3, "NAM-INDIA") = 0 Then
                            A = InStr(TxtRec!f3, "-")
                        End If
                        LSTR = Right(TxtRec!f3, 2)
                        If A <> 0 Then
                            If Right(TxtRec!f3, 3) = "-VS" Or Right(TxtRec!f3, 3) = "-KP" Then
                                LSTR = Trim(Left(TxtRec!f3, A - 1))
                                A = Len(LSTR)
                                LEXHCODE = Left(LSTR, A - 3)
                                LMONTH = Right(LSTR, 3)
                                lyear = Year(LSCondate)
                                lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                                LSMaturity = DateValue(LSTRCONDATE)
                                If month(LSMaturity) < month(LSCondate) Then
                                    lyear = (Year(LSCondate) + 1)
                                    LSTRCONDATE = "01" & "/" & month(LSMaturity) & "/" & lyear
                                    LSMaturity = DateValue(LSTRCONDATE)
                                End If
                            ElseIf Right(TxtRec!f3, 4) = "-NxK" Or Right(TxtRec!f3, 4) = "-NxG" Then
                                    LEXHCODE = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                                    LMONTH = month(LSCondate) + 1
                                    lyear = Year(LSCondate)
                                    If LMONTH = 13 Then
                                        LMONTH = 1
                                        lyear = lyear + 1
                                    End If
                                    LMonthType = "N"
                            ElseIf LSTR = "01" Or LSTR = "02" Or LSTR = "03" Or LSTR = "04" _
                                    Or LSTR = "05" Or LSTR = "06" Or LSTR = "07" Or LSTR = "08" _
                                    Or LSTR = "09" Or LSTR = "10" Or LSTR = "11" Or LSTR = "12" Then
                                LEXHCODE = Trim(Left(TxtRec!f3, A - 1))
                                lyear = Year(LSCondate)
                                LMONTH = Right(TxtRec!f3, 2)
                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                            ElseIf Right(UCase(TxtRec!f3), 3) = "JAN" Or Right(UCase(TxtRec!f3), 3) = "FEB" Or Right(UCase(TxtRec!f3), 3) = "MAR" Or Right(UCase(TxtRec!f3), 3) = "APR" _
                                    Or Right(UCase(TxtRec!f3), 3) = "MAY" Or Right(UCase(TxtRec!f3), 3) = "JUN" Or Right(UCase(TxtRec!f3), 3) = "JUL" Or Right(UCase(TxtRec!f3), 3) = "AUG" _
                                    Or Right(UCase(TxtRec!f3), 3) = "SEP" Or Right(UCase(TxtRec!f3), 3) = "OCT" Or Right(UCase(TxtRec!f3), 3) = "NOV" Or Right(UCase(TxtRec!f3), 3) = "DEC" Then
                                LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 4))
                                lyear = Year(LSCondate)
                                LMONTH = Right(TxtRec!f3, 3)
                                If month(LSCondate) = 11 Or month(LSCondate) = 12 Then
                                    If LMONTH = "JAN" Or LMONTH = "FEB" Or LMONTH = "MAR" Then
                                        lyear = lyear + 1
                                    End If
                               End If
                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                            ElseIf Right(TxtRec!f3, 2) = "-K" Or Right(TxtRec!f3, 2) = "-G" Or Right(TxtRec!f3, 2) = "-k" Then
                                If Right(TxtRec!f3, 2) = "-G" And ((InStr(TxtRec!f3, "JAN-") <> 0 Or InStr(TxtRec!f3, "FEB-") <> 0 Or InStr(TxtRec!f3, "MAR-") <> 0 Or InStr(TxtRec!f3, "APR-") <> 0 _
                                    Or InStr(TxtRec!f3, "MAY-") <> 0 Or InStr(TxtRec!f3, "JUN-") <> 0 Or InStr(TxtRec!f3, "JUL-") <> 0 Or InStr(TxtRec!f3, "AUG-") <> 0 _
                                    Or InStr(TxtRec!f3, "SEP-") <> 0 Or InStr(TxtRec!f3, "OCT-") <> 0 Or InStr(TxtRec!f3, "NOV-") <> 0 Or InStr(TxtRec!f3, "DEC-") <> 0)) Then
                                    If Right(LSTR, 1) = "L" Then
                                        LEXHCODE = Trim(Left(LSTR, Len(LSTR) - 4))
                                        LMONTH = Left(Right(LSTR, 4), 3)
                                    Else
                                        LSTR = Left(TxtRec!f3, Len(TxtRec!f3) - 2)
                                        LEXHCODE = Left(LSTR, Len(LSTR) - 3)
                                        LMONTH = Right(LSTR, 3)
                                    End If
                                ElseIf Right(TxtRec!f3, 2) = "-NxG" Then
                                    LSTR = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                                    If Right(LSTR, 1) = "L" Then
                                      LEXHCODE = Trim(Left(LSTR, Len(LSTR) - 4))
                                      LMONTH = Left(Right(LSTR, 4), 3)
                                    Else
                                      LEXHCODE = Trim(Left(TxtRec!f3, A - 4))
                                      LMONTH = Left(Right(TxtRec!f3, 5), 3)
                                    End If
                                Else
                                    LEXHCODE = Trim(Left(TxtRec!f3, A - 1))
                                    LMONTH = month(LSCondate)
                                    LMonthType = "C"
                                End If
                                lyear = Year(LSCondate)
                                lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                LSMaturity = lday & "/" & LMONTH & "/" & lyear
                            ElseIf Right(TxtRec!f3, 1) = "L" Then
                                 LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 5))
                                 LMONTH = Left(Right(TxtRec!f3, 4), 3)
                               
                                 lyear = Year(LSCondate)
                               
                                LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                LSMaturity = DateValue(LSTRCONDATE)
                            Else
                                LEXHCODE = Trim(Left(TxtRec!f3, A - 1))
                                LSTRCONDATE = Right(TxtRec!f3, 3)
                                LCMONTH = Left(LSTRCONDATE, 1)
                                lyear = "20" & Right(LSTRCONDATE, 2)
                                LMONTH = Get_CMX_Month(Left(LSTRCONDATE, 1))
                                LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                LSMaturity = DateValue(LSTRCONDATE)
                            End If
                        Else
                            A = InStr(TxtRec!f3, "/")
                            If A <> 0 Then
                                LEXHCODE = Trim(Left(TxtRec!f3, A - 1))
                                LMONTH = Right(TxtRec!f3, 2)
                                lyear = Year(LSCondate)
                                LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                LSMaturity = DateValue(LSTRCONDATE)
                                If month(LSMaturity) < month(LSCondate) Then
                                    lyear = (Year(LSCondate) + 1)
                                    LSTRCONDATE = "01" & "/" & month(LSMaturity) & "/" & lyear
                                    LSMaturity = DateValue(LSTRCONDATE)
                                End If
                            ElseIf Right(TxtRec!f3, 1) = "m" Then
                                LSTR = Right(TxtRec!f3, 4)
                                If Left(LSTR, 3) = "JAN" Or Left(LSTR, 3) = "FEB" Or Left(LSTR, 3) = "MAR" Or Left(LSTR, 3) = "APR" _
                                    Or Left(LSTR, 3) = "MAY" Or Left(LSTR, 3) = "JUN" Or Left(LSTR, 3) = "JUL" Or Left(LSTR, 3) = "AUG" _
                                    Or Left(LSTR, 3) = "SEP" Or Left(LSTR, 3) = "OCT" Or Left(LSTR, 3) = "NOV" Or Left(LSTR, 3) = "DEC" Then
                                    
                                    LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 4))
                                    LMONTH = Left(LSTR, 3)
                                    lyear = Year(LSCondate)
    
                                    If month(LSCondate) = 11 Or month(LSCondate) = 12 Then
                                        If LMONTH = "JAN" Or LMONTH = "FEB" Or LMONTH = "MAR" Then
                                            lyear = lyear + 1
                                        End If
                                    End If
                                    lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                    LSMaturity = lday & "/" & LMONTH & "/" & lyear
                                    LSMaturity = DateValue(LSMaturity)
                                Else
                                    If Right(TxtRec!f3, 3) = "Nxm" Then
                                        LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 3))
                                        LMONTH = month(LSCondate)
                                        If LMONTH = 12 Then
                                            LMONTH = 1
                                        Else
                                            LMONTH = LMONTH + 1
                                        End If
                                        
                                        lyear = Year(LSCondate)
                                        lday = GET_DAYS(LMONTH, lyear, LSCondate)

                                        LSMaturity = lday & "/" & LMONTH & "/" & lyear
                                        LSMaturity = DateValue(LSMaturity)
                                    
                                    Else
                                        LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 1))
                                        LMONTH = month(LSCondate)
                                        lyear = Year(LSCondate)
                                    
                                        LSMaturity = "28" & "/" & LMONTH & "/" & lyear
                                        LSMaturity = DateValue(LSMaturity)
                                    End If
                                End If
                            Else
                                If InStr(TxtRec!f3, "BAJAJ-AUTO") = 0 And InStr(TxtRec!f3, "MCDOWELL-N") = 0 And InStr(TxtRec!f3, "NAM-INDIA") = 0 Then
                                    A = InStr(TxtRec!f3, "-")
                                End If
                                If A <> 0 Then
                                    A = Len(TxtRec!f3)
                                    If Right(TxtRec!f3, 2) = "22" Or Right(TxtRec!f3, 2) = "23" Then
                                        B = Len(TxtRec!f3)
                                        LEXHCODE = Trim(Left(TxtRec!f3, B - 5))
                                        LMONTH = Mid(TxtRec!f3, B - 4, 3)
                                    Else
                                        LEXHCODE = Trim(Left(TxtRec!f3, A - 3))
                                        LMONTH = Right(TxtRec!f3, 2)
                                    End If
                                    lyear = Year(LSCondate)
                                    LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
                                    LSMaturity = DateValue(LSTRCONDATE)
                                    If month(LSMaturity) < month(LSCondate) Then
                                        lyear = (Year(LSCondate) + 1)
                                        LSTRCONDATE = "01" & "/" & month(LSMaturity) & "/" & lyear
                                        LSMaturity = DateValue(LSTRCONDATE)
                                    End If
                               Else
                                    A = Len(TxtRec!f3)
                                    If (Right(TxtRec!f3, 3) <> "SEP" And Right(TxtRec!f3, 3) <> "DEC" And (Right(TxtRec!f3, 1) = "C" Or Right(TxtRec!f3, 1) = "P")) Then
                                        Call OPTION_ITEM(TxtRec!f3, Vexcelcolval)
                                        LSInstType = "OPT"
                                        LSMaturity = Vdate
                                    ElseIf A > 6 And (Left(Right(TxtRec!f3, 6), 1) = "C" Or Left(Right(TxtRec!f3, 6), 1) = "P") And (Left(TxtRec!f3, 5) = "NIFTY" Or Left(TxtRec!f3, 9) = "BANKNIFTY") Then
                                        Call OPTION_ITEM(TxtRec!f3, Vexcelcolval)
                                        LSInstType = "OPT"
                                        LSMaturity = Vdate
                                    Else
                                    
                                    

                                    If Right(TxtRec!f3, 1) = "2" Or Right(TxtRec!f3, 2) = "23" Or Right(TxtRec!f3, 2) = "24" Then
                                        If InStr(TxtRec!f3, "JAN") = 0 And InStr(TxtRec!f3, "FEB") = 0 And InStr(TxtRec!f3, "MAR") = 0 _
                                        And InStr(TxtRec!f3, "APR") = 0 And InStr(TxtRec!f3, "MAY") = 0 And InStr(TxtRec!f3, "JUN") = 0 _
                                        And InStr(TxtRec!f3, "JUL") = 0 And InStr(TxtRec!f3, "AUG") = 0 And InStr(TxtRec!f3, "SEP") = 0 _
                                        And InStr(TxtRec!f3, "OCT") = 0 And InStr(TxtRec!f3, "NOV") = 0 And InStr(TxtRec!f3, "DEC") = 0 Then
                                            B = Len(TxtRec!f3)
                                            lyear = Right(TxtRec!f3, 2)
                                            LCMONTH = Mid(TxtRec!f3, B - 2, 1)
                                            LMONTH = Get_CMX_Month(LCMONTH)
                                            LEXHCODE = Left(TxtRec!f3, B - 3)
                                        ElseIf IsNumeric(Right(TxtRec!f3, 1)) And Not IsNumeric(Left(Right(TxtRec!f3, 2), 1)) Then
                                            LEXHCODE = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                                            LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                            lyear = Year(LSCondate)
                                        Else
                                        
                                            If Right(TxtRec!f3, 4) = "2022" Or Right(TxtRec!f3, 4) = "2023" Then
                                                B = Len(TxtRec!f3)
                                                LEXHCODE = Trim(Left(TxtRec!f3, A - 9))
                                                LMONTH = Mid(TxtRec!f3, B - 6, 3)
                                           Else
                                                B = Len(TxtRec!f3)
                                                LEXHCODE = Trim(Left(TxtRec!f3, A - 5))
                                                LMONTH = Mid(TxtRec!f3, B - 4, 3)
                                           End If
                                        End If
                                    ElseIf InStr(TxtRec!f3, "_I") <> 0 Or InStr(TxtRec!f3, "_II") <> 0 Or InStr(TxtRec!f3, "_III") Or InStr(TxtRec!f3, "_IV") _
                                        Or InStr(TxtRec!f3, "_V") <> 0 Or InStr(TxtRec!f3, "_VI") <> 0 Or InStr(TxtRec!f3, "_VII") Or InStr(TxtRec!f3, "_VIII") _
                                        Or InStr(TxtRec!f3, "_IX") <> 0 Or InStr(TxtRec!f3, "_X") <> 0 Or InStr(TxtRec!f3, "_XI") Or InStr(TxtRec!f3, "_XII") Then
                                        A = InStr(TxtRec!f3, "_")
                                        LEXHCODE = Left(TxtRec!f3, A - 1)
                                        LSTR2 = Right(TxtRec!f3, Len(TxtRec!f3) - A + 1)
                                        If Right(LSTR2, 2) = "_I" Or Right(LSTR2, 2) = "_V" Or Right(LSTR2, 2) = "_X" Then ' 1,5,10
                                            A = 2
                                            LSTR = Right(LSTR2, 1)
                                        ElseIf Right(LSTR2, 3) = "_II" Or Right(LSTR2, 3) = "_VI" Or Right(LSTR2, 3) = "_IV" Or Right(LSTR2, 3) = "_XI" Or Right(LSTR2, 3) = "_IX" Then '2,4,6,9,11
                                            A = 3
                                            LSTR = Right(LSTR2, 2)
                                        ElseIf Right(LSTR2, 4) = "_III" Or Right(LSTR2, 4) = "_VII" Or Right(LSTR2, 4) = "_XII" Then '3,7,12
                                            A = 4
                                            LSTR = Right(LSTR2, 3)
                                        ElseIf Right(LSTR2, 5) = "_VIII" Then '8
                                            A = 5
                                            LSTR = Right(LSTR2, 4)
                                        End If

                                        
                                        LMONTH = Get_RMN_Month(LSTR)
                                    ElseIf InStr(TxtRec!f3, "_") <> 0 And InStr(TxtRec!f3, "M_M") = 0 And InStr(TxtRec!f3, "BAJAJ_") = 0 Then
                                            A = Len(TxtRec!f3)
                                            LEXHCODE = Left(TxtRec!f3, A - 4)
                                            LMONTH = Right(TxtRec!f3, 3)
                                    ElseIf LSTR = "01" Or LSTR = "02" Or LSTR = "03" Or LSTR = "04" _
                                        Or LSTR = "05" Or LSTR = "06" Or LSTR = "07" Or LSTR = "08" _
                                        Or LSTR = "09" Or LSTR = "10" Or LSTR = "11" Or LSTR = "12" Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 2))
                                            lyear = Year(LSCondate)
                                            LMONTH = Right(TxtRec!f3, 2)
                                    ElseIf InStr(TxtRec!f3, "JANUARY") <> 0 Or InStr(TxtRec!f3, "OCTOBER") <> 0 Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 7))
                                            lyear = Year(LSCondate)
                                            LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                    ElseIf InStr(TxtRec!f3, "FEBRUARY") <> 0 Or InStr(TxtRec!f3, "NOVEMBER") <> 0 Or InStr(TxtRec!f3, "DECEMBER") <> 0 Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 8))
                                            lyear = Year(LSCondate)
                                            LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                    ElseIf InStr(TxtRec!f3, "MARCH") <> 0 Or InStr(TxtRec!f3, "APRIL") <> 0 Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 5))
                                            lyear = Year(LSCondate)
                                            LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                    ElseIf InStr(TxtRec!f3, "MAY") <> 0 Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 3))
                                            lyear = Year(LSCondate)
                                            If Left(Right(TxtRec!f3, 4), 1) = " " Then
                                                LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                            Else
                                                LMONTH = Right(TxtRec!f3, 3)
                                            End If
                                    ElseIf InStr(TxtRec!f3, "JUNE") <> 0 Or InStr(TxtRec!f3, "JULY") <> 0 Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 4))
                                            lyear = Year(LSCondate)
                                            LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                    ElseIf InStr(TxtRec!f3, "SEPTEMBER") <> 0 Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 9))
                                            lyear = Year(LSCondate)
                                            LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                    ElseIf InStr(TxtRec!f3, "AUGUST") <> 0 Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 6))
                                            lyear = Year(LSCondate)
                                            LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                    ElseIf Right(TxtRec!f3, 4) = "FEB2" Or Right(TxtRec!f3, 4) = "MAR2" Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 4))
                                            lyear = Year(LSCondate)
                                            LMONTH = Left(Right(TxtRec!f3, 4), 3)
                                    ElseIf Right(TxtRec!f3, 1) = "k" Or Right(TxtRec!f3, 1) = "Q" Then
                                        'InStr(TxtRec!f3, "JANk") <> 0 Or InStr(TxtRec!f3, "FEBk") <> 0 Or InStr(TxtRec!f3, "MARk") <> 0 _
                                        'Or InStr(TxtRec!f3, "APRk") <> 0 Or InStr(TxtRec!f3, "MAYk") <> 0 Or InStr(TxtRec!f3, "JUNk") <> 0 _
                                        'Or InStr(TxtRec!f3, "JULk") <> 0 Or InStr(TxtRec!f3, "AUGk") <> 0 Or InStr(TxtRec!f3, "SEPk") <> 0 _
                                        'Or InStr(TxtRec!f3, "OCTk") <> 0 Or InStr(TxtRec!f3, "NOVk") <> 0 Or InStr(TxtRec!f3, "DECk") <> 0 Then
                                            LEXHCODE = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 4))
                                            lyear = Year(LSCondate)
                                            LMONTH = Right(TxtRec!f3, 4)
                                            LMONTH = Left(LMONTH, 3)
                                    Else
                                        If Left(TxtRec!f3, 3) = "BTC" Then
                                            LEXHCODE = Left(TxtRec!f3, 3)
                                            LMONTH = Mid(TxtRec!f3, 4, 3)
                                        Else
                                            LEXHCODE = Trim(Left(TxtRec!f3, A - 3))
                                            LMONTH = Right(TxtRec!f3, 3)
                                        End If
                                    End If
                                    
                                    lyear = Year(LSCondate)
                                    lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                                    LSMaturity = DateValue(LSTRCONDATE)
                                    If month(LSMaturity) < month(LSCondate) Then
                                        lyear = (Year(LSCondate) + 1)
                                        LSTRCONDATE = "01" & "/" & month(LSMaturity) & "/" & lyear
                                        LSMaturity = DateValue(LSTRCONDATE)
                                    End If
                                    End If
                                End If
                            End If
                        End If
                       ' If IsNumeric(TxtRec!F6) Then
                            LBQty = Val(TxtRec!f6)
                        'Else
                            If Right(TxtRec!f6, 1) = "K" Then
                                LBQty = Val(Left(TxtRec!f6, Len(TxtRec!f6) - 1)) * 1000
                            Else
                                LBQty = Val(TxtRec!f6)
                            End If
                        'End If

                        LBRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                        LSRate = LBRate
                        lsparty = LBrokerCode
                    'Case 72

                    Case 25
                        Call EXCEL25
                    End Select
                    If lexceltype = 10 Or lexceltype = 17 Then
                        LLOT = 1
                        If lexceltype = 17 Then
                            mysql = "SELECT EXID,ITEMID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND ITEMNAME  ='" & LEXHCODE & "'"
                        Else
                            mysql = "SELECT EXID,ITEMID,ITEMCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND (ITEMCODE='" & LEXHCODE & "' OR ITALIAS_1='" & LEXHCODE & "' OR ITALIAS_2='" & LEXHCODE & "' OR ITALIAS_3='" & LEXHCODE & "' OR ITALIAS_4='" & LEXHCODE & "' OR ITALIAS_5='" & LEXHCODE & "')"
                        End If
                        Set TRec = Nothing: Set TRec = New ADODB.Recordset
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            mysql = "SELECT ITEMCODE,EXCODE,LOT FROM CONTRACTMASTER WHERE EX_SYMBOL ='" & LEXHCODE & "'"
                            Set TRec = Nothing:
                            Set TRec = New ADODB.Recordset
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If TRec.EOF Then
                                If Right(TxtRec!F10, 1) = "K" Then LSExCode = "NSE"
                                LSItemCode = Create_ItemMast(LEXHCODE, LEXHCODE, LEXHCODE, LLOT, LSExCode, LSEXID)
                                LSItemid = Get_ITEMID(LSItemCode)
                                LSEXID = Get_ExID(LSExCode)
                            Else
                                LSExCode = TRec!excode
                                LSItemCode = TRec!ITEMCODE
                                LSEXID = Get_ExID(LSExCode)
                                LLOT = TRec!lot
                                LSItemCode = Create_ItemMast(LSItemCode, LSItemCode, LEXHCODE, LLOT, LSExCode, LSEXID)
                                LSItemid = Get_ITEMID(LSItemCode)
                            End If
                        Else
                            LSExCode = TRec!EXCHANGECODE
                            LSItemCode = TRec!ITEMCODE
                            LLOT = TRec!lot
                            LSEXID = TRec!EXID
                            LSItemid = TRec!itemid
                        End If
                        If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                        If A = 0 Then
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            mysql = "SELECT SAUDAID,SAUDACODE,MATURITY FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND ITEMID=" & LSItemid & " AND INSTTYPE='FUT'"
                            mysql = mysql & " AND MATURITY ='" & Format(LSMaturity, "YYYY/MM/DD") & " 'ORDER BY MATURITY"
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then
                                LSSaudaCode = TRec!saudacode
                                LSMaturity = TRec!MATURITY
                                LSSaudaID = TRec!SAUDAID
                            Else
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                mysql = "SELECT SAUDACODE,MATURITY FROM SCRIPTMASTER WHERE ITEMCODE='" & LSItemCode & "' AND EXCODE='" & LSExCode & "' AND INSTTYPE='FUT'"
                                mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' ORDER BY MATURITY "
                                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                                If Not TRec.EOF Then
                                    LSMaturity = TRec!MATURITY
                                    LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                Else
                                    If LSExCode = "CMX" Then
                                        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                    Else
                                        MsgBox "Please Import New Contracts " & LSItemCode & ""
                                        Cnn.RollbackTrans
                                        CNNERR = False
                                        Exit Sub
                                    End If
                                End If
                                LSSaudaID = Get_SaudaID(LSSaudaCode)
                            End If
                        Else
                            Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
                            mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'FUT'" & ",'',0"
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then
                                LSSaudaCode = TRec!saudacode
                                LSMaturity = TRec!MATURITY
                                LSSaudaID = TRec!SAUDAID
                            Else
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                mysql = "SELECT SAUDACODE,MATURITY FROM SCRIPTMASTER WHERE ITEMCODE='" & LSItemCode & "' AND INSTTYPE='" & LSInstType & "'"
                                mysql = mysql & " AND MONTH(MATURITY)=" & month(LSMaturity) & " AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                                If Not TRec.EOF Then
                                    LSMaturity = TRec!MATURITY
                                    LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                Else
                                    LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                End If
                                LSSaudaID = Get_SaudaID(LSSaudaCode)
                            End If
                        End If
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                            'GoTo EFlag_Next
                        End If
                        If LBQty <> 0 Then
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                            MSPARTY = Get_ACCT_EX(LSEXID, lsparty)
                            'MsgBox LSParty & " " & MSParty
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            mysql = "SELECT BROKER FROM EXBROKCLIENT WHERE COMPCODE =" & GCompCode & " AND CLIENT ='" & mbparty & "'"
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then MSPARTY = TRec!BROKER
                            If LenB(MSPARTY) < 1 Then
                                Call Get_ExDetail(LSExCode)
                                MSPARTY = LExCont
                            End If
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND  ROWNO1='" & LOConNo & "' AND FILETYPE ='" & lexceltype & "' AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                            Cnn.Execute mysql
                            'If Chk_TradeNo(LSSaudaCode, LOConNo, LSCondate) = False Then
                            If InStr(LBillExId, str(LSEXID)) = 0 Then
                                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            MCount = MCount + 1:
                            LNoTrd = LNoTrd + 1
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & LSSaudaCode
                            DoEvents
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                            'End If
                        End If
                    ElseIf (lexceltype = 11 Or lexceltype = 12) Then
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, False, 1)
                        If LenB(LSItemCode) < 1 Then
                            LMsgBox = "Could not create new Item/Script " & LEXHCODE & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        Call Get_Sauda_Details(LEXHCODE, False, True, LSCondate, 1)
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                            'GoTo EFlag_Next
                        End If
                        If LBQty <> 0 Then
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                            MSPARTY = lsparty
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND  ROWNO1='" & LOConNo & "' AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                            Cnn.Execute mysql
                            MCount = MCount + 1:
                            If InStr(LBillExId, str(LSEXID)) = 0 Then
                                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            LNoTrd = LNoTrd + 1
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                            DoEvents
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    ElseIf lexceltype = 20 Or lexceltype = 16 Or lexceltype = 21 Then
                        LLOT = 1
                        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                        If LenB(LSItemCode) < 1 Then
                            LMsgBox = "Could not create new Item/Script " & LEXHCODE & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        If lexceltype = 21 Then
                            mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",'" & Format(LSMaturity, "YYYY/MM/DD") & "',0,0,'" & LSInstType & " ','" & LSOptType & "'," & LSStrike & ""
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        Else
                            mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        End If
                        If Not TRec.EOF Then
                            LSSaudaCode = TRec!saudacode
                            LSMaturity = TRec!MATURITY
                            LSSaudaID = TRec!SAUDAID
                        Else
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            mysql = "SELECT SAUDACODE,MATURITY FROM SCRIPTMASTER WHERE ITEMCODE='" & LSItemCode & "' AND EXCODE='" & LSExCode & "'"
                            If LSInstType <> "FUT" Then
                                mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                                mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                            Else
                                mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                            End If
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then
                                LSSaudaCode = TRec!saudacode
                                LSMaturity = TRec!MATURITY
                                If LenB(LSItemCode) <> 0 Then LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                            Else
                                MsgBox " Please Import New Contract" & LSItemCode & " " & LSMaturity & ""
                                Cnn.RollbackTrans
                                Exit Sub
                            End If
                            LSSaudaID = Get_SaudaID(LSSaudaCode)
                        End If
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        LSSaudaID = Get_SaudaID(LSSaudaCode)
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                            'GoTo EFlag_Next
                        End If
                        
                        If LBQty <> 0 Then
                            mbparty = Get_ACCT_EX(LSEXID, lbparty)
                            MSPARTY = Get_ACCT_EX(LSEXID, lsparty)
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            If LenB(MSPARTY) < 1 Then
                                LMsgBox = " Broker does Not Exist " & lsparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                                'LContime = Time
                            MCount = MCount + 1:
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            If InStr(LBillExId, str(LSEXID)) = 0 Then
                                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            LNoTrd = LNoTrd + 1
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                            DoEvents
                            'LOConNo = Trim(Str(MCount)):
                            Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    ElseIf lexceltype = 25 Or lexceltype = 29 Or lexceltype = 37 Or lexceltype = 38 Or lexceltype = 39 Or lexceltype = 40 Or lexceltype = 28 Then
                        LLOT = 1
                        LEx_Symbol = LEXHCODE
                        If lexceltype = 41 Then
                            mysql = "SELECT EXID,ITEMID ,ITEMCODE,EXCHANGECODE,LOT,EXHCODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND EXHCODE  ='" & LEXHCODE & "'"
                        ElseIf lexceltype = 37 Or lexceltype = 45 Then
                            mysql = "SELECT EXID,ITEMID ,ITEMCODE,EXCHANGECODE,LOT,EXHCODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND ITEMNAME   ='" & LEXHCODE & "'"
                        Else
                            mysql = "SELECT EXID,ITEMID ,ITEMCODE,EXCHANGECODE,LOT,EXHCODE FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND (ITEMCODE ='" & LEXHCODE & "' OR ITALIAS_1='" & LEXHCODE & "' OR ITALIAS_2='" & LEXHCODE & "' OR ITALIAS_3='" & LEXHCODE & "' OR ITALIAS_4='" & LEXHCODE & "' OR ITALIAS_5='" & LEXHCODE & "')"
                        End If
                        Set TRec = Nothing: Set TRec = New ADODB.Recordset
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            mysql = "SELECT ITEMCODE,EXCODE,LOT FROM CONTRACTMASTER WHERE EX_SYMBOL ='" & LEXHCODE & "'"
                            Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If TRec.EOF Then
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & ""
                                ImportIssues (LMsgBox)

                                GoTo EFlag_Next
                            Else
                                LSExCode = TRec!excode:     LSItemCode = TRec!ITEMCODE
                                LEx_Symbol = LEXHCODE:      LSEXID = Get_ExID(LSExCode)
                                LLOT = TRec!lot
                                LSItemCode = Create_ItemMast(LSItemCode, LSItemCode, LEXHCODE, LLOT, LSExCode, LSEXID)
                                LSItemid = Get_ITEMID(LSItemCode)
                            End If
                        Else
                            LSExCode = TRec!EXCHANGECODE:   LSItemCode = TRec!ITEMCODE
                            LEx_Symbol = TRec!EXHCODE:      LSEXID = TRec!EXID
                            LSItemid = TRec!itemid:          LLOT = TRec!lot
                        End If
                        If LenB(LSItemCode) < 1 Then GoTo EFlag_Next
                        
                        If LSExCode = "MCX" Then
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            mysql = "select reflot from itemmast where compcode= '" & GCompCode & "'  and itemcode = '" & LSItemCode & "' "
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then
                                If TRec!REFLOT <> 0 And (GUniqClientId = "1193BUL" Or GUniqClientId = "SVM-KHJ") Then
                                    LBQty = LBQty * TRec!REFLOT
                                End If
                            End If
                        End If
                        If LMonthType = "M" Then
                            Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
                            If LSInstType = "FUT" Then
                                mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                            Else
                                mysql = "SELECT SAUDACODE ,SAUDAID,MATURITY FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MATURITY='" & Format(LSMaturity, "YYYY.MM/DD") & "'"
                                mysql = mysql & "AND INSTTYPE ='OPT' AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE = " & LSStrike & ""
                            End If
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec.EOF Then
                                    LSSaudaCode = TRec!saudacode
                                    LSMaturity = TRec!MATURITY
                                    LSSaudaID = TRec!SAUDAID
                                Else
                                    Set TRec = Nothing
                                    Set TRec = New ADODB.Recordset
                                    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                                    If LSInstType <> "FUT" Then
                                        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                                        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                                    Else
                                        mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                                    End If
                                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                                    If Not TRec.EOF Then
                                        LSMaturity = TRec!MATURITY
                                        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                    Else
                                        'MsgBox "Please Import/Create New Item/Script " & LExhCode & " " & LSMaturity
                                        'GoTo EFlag_Next
                                        If LSInstType = "FUT" Then
                                            LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                                LSSaudaCode = LSExCode & " " & LSSaudaCode
                                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                                    LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                                    ImportIssues (LMsgBox)
                                                    GoTo EFlag_Next
                                                End If
                                            End If
                                        Else
                                            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                            ImportIssues (LMsgBox)
                                            GoTo EFlag_Next
                                        End If
                                        'LEXID = Get_ExID(LSExCode)
                                        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                                    End If
                                    LSSaudaID = Get_SaudaID(LSSaudaCode)
                                End If
                        Else
                            If LMonthType = "C" Then
                                mysql = "SELECT TOP 1 SAUDACODE,MATURITY,SAUDAID FROM SAUDAMAST WHERE INSTTYPE ='FUT'  AND ITEMID=" & LSItemid & " AND MATURITY>='" & Format(LSCondate, "YYYY/MM/DD") & "' ORDER BY MATURITY "
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If TRec.EOF Then
                                    Set TRec = Nothing
                                    Set TRec = New ADODB.Recordset
                                    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                                    mysql = mysql & " AND INSTTYPE='FUT' AND MATURITY>='" & Format(LSCondate, "YYYY/MM/DD") & "' ORDER BY MATURITY "
                                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                                    If TRec.EOF Then
                                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    Else
                                        LSMaturity = TRec!MATURITY
                                        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                    End If
                                Else
                                    LSSaudaCode = TRec!saudacode
                                    LSMaturity = TRec!MATURITY
                                    LSSaudaID = TRec!SAUDAID
                                End If
                            Else
                                mysql = "SELECT MATURITY FROM SCRIPTMASTER  WHERE INSTTYPE ='FUT'  AND  EX_SYMBOL= '" & LEx_Symbol & "' AND EXCODE ='" & LSExCode & "' AND MATURITY>='" & Format((LSCondate - 5), "YYYY/MM/DD") & "' ORDER BY MATURITY "
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If TRec.EOF Then
                                    mysql = "SELECT SAUDACODE,SAUDAID,MATURITY FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND INSTTYPE ='FUT'  AND ITEMCODE ='" & LSItemCode & "' AND EXCODE ='" & LSExCode & "' AND MATURITY>='" & Format((LSCondate - 5), "YYYY/MM/DD") & "' ORDER BY MATURITY"
                                    Set TRec = Nothing
                                    Set TRec = New ADODB.Recordset
                                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                    If Not TRec.EOF Then
                                        TRec.MoveNext
                                        If Not TRec.EOF Then
                                            LSSaudaCode = TRec!saudacode
                                            LSMaturity = TRec!MATURITY
                                        Else
                                            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity
                                            ImportIssues (LMsgBox)
                                            GoTo EFlag_Next
                                        End If
                                    Else
                                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    End If
                                Else
                                    TRec.MoveNext
                                    If TRec.EOF Then
                                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    Else
                                        LSMaturity = TRec!MATURITY
                                        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                    End If
                                End If
                            End If
                            If LenB(LSSaudaCode) < 1 Then
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            LSSaudaID = Get_SaudaID(LSSaudaCode)
                        End If
                        If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                        If lexceltype = 41 Then
                            Call Get_ExDetail(LSExCode)
                            lsparty = LExCont
                        End If
                        
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                        End If
                        
                        If LBQty <> 0 Or LSQty <> 0 Then
                            If (lexceltype = 29 And LSInstType = "OPT") Or (Right(TxtRec!f3, 1) = "L" And Right(TxtRec!f3, 4) <> "JULL" And Right(TxtRec!f3, 3) <> "JUL" And LSExCode = "NSE") Then
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                mysql = "SELECT REFLOT FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND SAUDACODE ='" & LSSaudaCode & "'"
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec.EOF Then
                                    LBQty = LBQty * TRec!REFLOT
                                End If
                            End If
                            
                            If (lexceltype = 29 And LSExCode = "CMX" And GUniqClientId = "BTY-DEL") Then
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                mysql = "SELECT REFLOT FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND SAUDACODE ='" & LSSaudaCode & "'"
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec.EOF Then
                                    LBRate = LBRate * TRec!REFLOT
                                    LSRate = LSRate * TRec!REFLOT
                                End If
                            End If
                            
                            If (lexceltype = 28 And LSInstType = "FUT") Then
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                mysql = "SELECT LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND ITEMCODE ='" & LSItemCode & "'"
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec.EOF Then
                                    LLOT = TRec!lot
                                    If LBQty <> 0 Then
                                        LBQty = LBQty / TRec!lot
                                    End If
                                    If LSQty <> 0 Then
                                        LSQty = LSQty / TRec!lot
                                    End If
                                End If
                            End If
                            
                            If lexceltype = 29 Then
                                mbparty = lbparty
                            Else
                                mbparty = Get_ACCT_EX(LSEXID, lbparty)
                            End If
                            If LenB(mbparty) < 1 Then
                                mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                                If LenB(mbparty) > 1 Then
                                    If LSExCode = "RACE" Then
                                        mysql = "UPDATE ACCOUNTM SET PTYHEAD =1 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & mbparty & "'"
                                        Cnn.Execute mysql
                                    Else
                                        mysql = "UPDATE ACCOUNTM SET PTYHEAD =2 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & mbparty & "'"
                                        Cnn.Execute mysql
                                    End If
                                End If
                            End If
                            MSPARTY = lsparty
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            mysql = "SELECT BROKER FROM EXBROKCLIENT WHERE COMPCODE =" & GCompCode & " AND CLIENT ='" & mbparty & "'"
                            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                            If Not TRec.EOF Then MSPARTY = TRec!BROKER
                            If LenB(MSPARTY) < 1 Then
                                Call Get_ExDetail(LSExCode)
                                MSPARTY = LExCont
                            End If
                            
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            If LenB(MSPARTY) < 1 Then
                                LMsgBox = " Broker does Not Exist " & lsparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            
                            If lexceltype <> 28 Then
                                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                                Cnn.Execute mysql
                            End If
                            
                            MCount = Get_Max_ConNo(LSCondate, 0)
                            MCount = MCount + 1:
                            LNoTrd = LNoTrd + 1
                            If InStr(LBillExId, str(LSEXID)) = 0 Then
                                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            
                            If TxtRec.Fields.Count > 8 Then
                                GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                            End If
                            
                            DoEvents
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                                                      
                            If LBQty > 0 Then
                                If lexceltype = 28 Then
                                    LPtyContype = "B"
                                    Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LBRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                                Else
                                    Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                                End If
                            End If
                           
                            If lexceltype = 28 And LSQty > 0 Then  '>>> sACHIN***
                                MCount = Get_Max_ConNo(LSCondate, 0)
                                MCount = MCount + 1:
                                LNoTrd = LNoTrd + 1
                                LPtyContype = "S"
                                Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LSQty, LSRate, LSRate, MSPARTY, LCONTIME2, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                            End If
                        End If
                    ElseIf lexceltype = 2 Or lexceltype = 6 Or lexceltype = 7 Or lexceltype = 15 Or lexceltype = 30 Or lexceltype = 31 Or lexceltype = 32 Or lexceltype = 1 Then
                        LLOT = 1
                        If lexceltype = 1 Or lexceltype = 15 Then
                            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                        Else
                            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, False, 1)
                        End If
                        If LenB(LSItemCode) < 1 Then
                            LMsgBox = "Could not create new Item/Script " & LEXHCODE & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        Call Get_Sauda_Details(LEXHCODE, False, True, LSCondate, 1)
                        If LenB(LSSaudaCode) = 0 Then GoTo EFlag_Next
                        If LConType = "B" Then
                            LPtyContype = "B"
                        Else
                            LPtyContype = "S"
                        End If
                        If (lexceltype = 32 Or lfiletype = 14) And LSExCode = "NSE" Then
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            mysql = "SELECT REFLOT FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND SAUDACODE ='" & LSSaudaCode & "'"
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec.EOF Then
                                LBQty = LBQty * TRec!REFLOT
                            End If
                        End If
                        LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                        LBQty = Abs(LBQty)
                        If LSCondate > LSMaturity Then
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                        End If
                        
                        If LBQty <> 0 Then
                            mbparty = Get_ACCT_EX(LSEXID, lbparty)
                            MSPARTY = Get_ACCT_EX(LSEXID, lsparty)
                            If LenB(mbparty) < 1 Then
                                LMsgBox = " Client does Not Exist " & lbparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            If LenB(MSPARTY) < 1 Then
                                LMsgBox = " Broker does Not Exist " & lsparty & ""
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            End If
                            If InStr(LBillExId, str(LSEXID)) = 0 Then
                                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            LNoTrd = LNoTrd + 1
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            
                            DoEvents
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            MCount = MCount + 1
                            LOConNo = Trim(str(MCount)):
                            Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If
EFlag_Next:
                    TxtRec.MoveNext
                Wend
                LMsgBox = " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
                ImportIssues (LMsgBox)
        End If
    End If
Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number

    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub


Sub Save_AllTrade_Excel_1_10(lexceltype As Integer)
Dim LIFLAG As Boolean:          Dim lbparty As String:          Dim lsparty As String:          Dim LBQty As Double
Dim LSQty As Double:            Dim LBRate As Double:           Dim LSRate As Double:           Dim ldate As Date
Dim ltradedt As Date:           Dim TxtPath As String:          Dim LFileName As String:        Dim MCount As Long
Dim LConType As String:         Dim LPtyContype As String:      Dim LSConSno As Long:           Dim LQTY As Double
Dim LRATE As Double:            Dim LContime As String:         Dim LOrdNo As String:           Dim LOrdTime As String:
Dim LSCondate As Date:          Dim LOConNo As String:          Dim StrDateLen As Integer:      Dim LSTRDATE As String:
Dim LMONTH As String:           Dim lyear As String:            Dim LClient As String:          Dim mparty As String:
Dim mbparty As String:          Dim MSPARTY As String:          Dim TRec As ADODB.Recordset:
Dim LUserId As String:          Dim LPartyName As String:       Dim LEXHCODE As String:         Dim LSTRCONDATE  As String
Dim A As Integer:               Dim LFieldName As String:       Dim fld As ADODB.Field:         Dim LEx_Symbol  As String
Dim LMFLPath As String:         Dim B As Integer:               Dim LSTR As String:
Dim LStrMonth As String:        Dim lday As Integer:            Dim LAcExCode As String:        Dim C As Integer
    
    On Error GoTo err1
    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    Call GET_JCnn("\" & LFolderName & "\;")
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
        LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
    End If
    Set LFileSystemObject = Nothing
                
    MSPARTY = LBrokerCode
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                ldate = LSCondate
                If MsgBox("Are you Sure to Delete Trades of  " & LSCondate & " of File Type  " & lexceltype & "", vbQuestion + vbYesNo, "Confirm") = vbYes Then
                    Cnn.Execute "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE = '" & Format(LSCondate, "yyyy/MM/dd") & "' AND DATAIMPORT = 1 AND FILETYPE='" & Trim(str(lexceltype)) & "'"
                End If
                LNoTrd = 0
                MCount = Get_Max_ConNo(LSCondate, 0)
                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LSOptType = vbNullString:     LSStrike = 0:                 LLOT = 0
                    LBQty = 0:                    LSQty = 0:                    LBRate = 0:                   LSRate = 0
                    LSSaudaID = 0:                LSItemid = 0:                 LSExCode = vbNullString:      LSEXID = 0
                    
                    If IsNull(TxtRec!F1) Then GoTo EFlag_Next
                    Select Case lexceltype
                    Case 1
                        If Not IsNull(TxtRec!F5) Then
                            LSTRCONDATE = TxtRec!F5
                            If Not IsDate(LSTRCONDATE) Then GoTo EFlag_Next
                            LSCondate = DateValue(LSTRCONDATE)
                        Else
                            If Not IsNull(TxtRec!F9) Then
                                LSTRCONDATE = TxtRec!F9
                                If Not IsDate(LSTRCONDATE) Then GoTo EFlag_Next
                                LSCondate = DateValue(LSTRCONDATE)
                            Else
                                GoTo EFlag_Next
                            End If
                        End If
                        lbparty = Trim(IIf(IsNull(TxtRec!F1), vbNullString, (TxtRec!F1))):      LEXHCODE = Trim(IIf(IsNull(TxtRec!F2), vbNullString, TxtRec!F2))
                        LSMaturity = DateValue(TxtRec!f3):                                      LBQty = Val(IIf(IsNull(TxtRec!F4), 0, TxtRec!F4))
                        LBRate = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):                     lsparty = lbparty
                        LSQty = Val(IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)):                      LSRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10))
                    Case 2
                        lbparty = Trim(IIf(IsNull(TxtRec!F1), vbNullString, (TxtRec!F1))):
                        If Not IsNull(TxtRec!F1) Then LSTRCONDATE = IIf(IsNull(TxtRec!F2), vbNullString, TxtRec!F2)
                        If Not IsDate(LSTRCONDATE) Then GoTo EFlag_Next
                        LSCondate = DateValue(TxtRec!F2)
                        LConType = Left$(TxtRec!f3, 1)
                        LEXHCODE = Trim(IIf(IsNull(TxtRec!F4), vbNullString, TxtRec!F4)):
                        LSMaturity = DateValue(TxtRec!F5)
                        LBQty = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6))
                        LBRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                        LSInstType = "FUT"
                    Case 6
                        LSCondate = DateValue(TxtRec!F1)
                        lsparty = Trim$(IIf(IsNull(TxtRec!F2), vbNullString, (TxtRec!F2))):
                        LEXHCODE = Trim(IIf(IsNull(TxtRec!f3), vbNullString, TxtRec!f3))
                        LSMaturity = DateValue(TxtRec!F4)
                        LBQty = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
                        If LBQty > 0 Then
                            LConType = "B"
                        Else
                            LConType = "S"
                            LBQty = Abs(LBQty)
                        End If
                        LBRate = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):
                        LSRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                        lbparty = Trim(IIf(IsNull(TxtRec!F8), vbNullString, (TxtRec!F8))):
                        If Not IsNull(TxtRec!F10) Then
                            If IsNumeric(TxtRec!F10) Then
                                If Val(TxtRec!F10) <> 0 Then
                                    LSInstType = "OPT": LSOptType = Left$(TxtRec!F9, 2): LSStrike = Val(TxtRec!F10 & vbNullString)
                                End If
                            End If
                        End If
                    Case 7
                        LSCondate = DateValue(TxtRec!F1)
                        LEXHCODE = Trim(IIf(IsNull(TxtRec!F2), vbNullString, TxtRec!F2))
                        LSMaturity = DateValue(TxtRec!f3)
                        lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
                        LConType = TxtRec!F5
                        LBQty = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6))
                        LBRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
                        LSRate = LBRate
                        lsparty = Trim(IIf(IsNull(TxtRec!F8), vbNullString, (TxtRec!F8)))
                    End Select
                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, False, 1)
                    If LenB(LSSaudaCode) < 1 Then
                        LMsgBox = " Please Create Item/Script " & LEXHCODE & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    Call Get_Sauda_Details(LEXHCODE, False, True, LSCondate, 1)
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    If LSCondate > LSMaturity Then
                        LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                        ImportIssues (LMsgBox)
                    End If
                    If LBQty <> 0 Then
                        mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                        MSPARTY = Get_ACCT_EX(LSEXID, lsparty)
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT BROKER FROM EXBROKCLIENT WHERE COMPCODE =" & GCompCode & " AND CLIENT ='" & mbparty & "'"
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TRec.EOF Then MSPARTY = TRec!BROKER
                        If LenB(MSPARTY) < 1 Then
                            Call Get_ExDetail(LSExCode)
                            MSPARTY = LExCont
                        End If
                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LSEXID)
                        End If
                        MCount = MCount + 1:
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                        Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                    End If
EFlag_Next:
                TxtRec.MoveNext
            Wend
                    End If
    End If
Next
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
     
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Private Sub Get_Item_Details(ByVal LIEx_Symbol As String, ByVal LIItemCode As String, ByVal LIItemName As String, ByVal LIExCode As String, ByVal LILot As Double, NewItem As Boolean, NewItem2 As Boolean, LIType As Integer)

    Dim TRec As ADODB.Recordset
    Dim LCItemCode As String
    LSItemCode = vbNullString:    LSItemid = 0:    LSEXID = 0
    If NewItem = True Then
        LCItemCode = Create_CItemMast(LIEx_Symbol, LIItemCode, LIItemCode, LILot, LIExCode)
    End If
    If LIType = 1 Then 'EX SYMBOL
        mysql = "EXEC GET_ITEMREC " & GCompCode & ",'" & LIEx_Symbol & "','" & LSExCode & "'"
    ElseIf LIType = 2 Then ' ITEMCODE
        mysql = "EXEC GET_ITEMREC2 " & GCompCode & ",'" & LIEx_Symbol & "','" & LSExCode & "'"
    Else ' ITEMNAME
        mysql = "EXEC GET_ITEMREC3 " & GCompCode & ",'" & LIEx_Symbol & "','" & LSExCode & "'"
    End If
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    
    If TRec.EOF Then
        If NewItem2 = True Then
            mysql = "EXEC GET_CONTRACTMASTERREC '" & LSExCode & "','" & LIEx_Symbol & "'"
            'MYSQL = "SELECT ITEMCODE,EXCODE,LOT,EX_SYMBOL FROM CONTRACTMASTER WHERE EX_SYMBOL ='" & LIEx_Symbol & "' and EXCODE  ='" & LSExCode & "'"
            Set TRec = Nothing:
            Set TRec = New ADODB.Recordset
            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
            If TRec.EOF Then
                If NewItem = True Then
                    LCItemCode = Create_CItemMast(LIItemCode, LIItemName, LIEx_Symbol, LLOT, LSExCode)
                End If
                If LenB(LSExCode) > 0 Then
                    LSEXID = Get_ExID(LSExCode)
                    If LSEXID <> 0 Then
                        If LSExCode = "CMX" Then
                            If UCase(LIEx_Symbol) = "GOLD" Or UCase(LIEx_Symbol) = "SILVER" Or UCase(LIEx_Symbol) = "COPPER" Or UCase(LIEx_Symbol) = "CRUDEOIL" Or UCase(LIEx_Symbol) = "NATURALGAS" Or UCase(LIEx_Symbol) = "NATURAL GAS" Then
                                LIEx_Symbol = LSExCode + " " + LIEx_Symbol
                            End If
                        End If
                        LSItemCode = Create_ItemMast(LIEx_Symbol, LIEx_Symbol, LIEx_Symbol, 1, LSExCode, LSEXID)
                        LSItemid = Get_ITEMID(LSItemCode)
                    End If
                End If
                'MsgBox "Please Import new Item  " & LIEx_Symbol & ""
            Else
                LSExCode = TRec!excode:            LSEXID = Get_ExID(LSExCode)
                LSItemCode = TRec!ITEMCODE:        LLOT = TRec!lot
                LSEx_Symbol = LIEx_Symbol
                LSItemCode = Create_ItemMast(LSItemCode, LSItemCode, LIEx_Symbol, LLOT, LSExCode, LSEXID)
                LSItemid = Get_ITEMID(LSItemCode)
            End If
        End If
    Else
        LSExCode = TRec!EXCHANGECODE:   LSItemCode = TRec!ITEMCODE
        LLOT = TRec!lot:                LSEXID = TRec!EXID:          LSItemid = TRec!itemid
        LSEx_Symbol = TRec!EXHCODE
    End If
End Sub

Private Sub Get_Sauda_Details(ByVal LIEx_Symbol As String, NewSauda As Boolean, NewSauda2 As Boolean, LIConDate As Date, LIType As Integer)
    Dim LSSauda As String
    Dim TRec As ADODB.Recordset
    If LIType = 1 Then
        If NewSauda = True Then
            LSSauda = Create_SSaudaMast(LIEx_Symbol, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSItemCode)
        End If

        LSSaudaCode = Get_SaudaMaster(LSEXID, LSItemid, LSMaturity, LSInstType, LSOptType, LSStrike)
          If NewSauda2 = True And LenB(LSSaudaCode) < 1 Then
            LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
        End If
        If LenB(LSSaudaCode) < 1 Then Exit Sub
        LSSaudaID = Get_SaudaID(LSSaudaCode)
    ElseIf LIType = 2 Then
        Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
        LSSaudaCode = vbNullString
        mysql = "SELECT TOP 1 SAUDACODE,SAUDAID ,MATURITY,NOCODE FROM SAUDAMAST WHERE  ITEMID =" & LSItemid & " "
        mysql = mysql & " and INSTTYPE='FUT' AND EXID =" & LSEXID & " AND MATURITY>='" & Format(LIConDate, "YYYY/MM/DD") & "' ORDER BY MATURITY"
       
        Set TRec = Nothing: Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not TRec.EOF Then
            LSSaudaCode = TRec!saudacode:   LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
        End If
        If LenB(LSSaudaCode) < 1 Then
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT TOP 1 MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
            mysql = mysql & " AND INSTTYPE='FUT' AND MATURITY>='" & Format(LIConDate, "yyyy/mm/dd") & "' ORDER BY MATURITY "
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            If Not TRec.EOF Then
                LSMaturity = TRec!MATURITY
                LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                LSSaudaID = Get_SaudaID(LSSaudaCode)
            Else
                LMsgBox = "Please Import new contracts  for " & LSItemCode & ""
                ImportIssues (LMsgBox)
            End If
        End If
    ElseIf LIType = 3 Then
        Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
        LSSaudaCode = vbNullString
        mysql = "SELECT TOP 1 SAUDACODE,SAUDAID ,MATURITY,NOCODE FROM SAUDAMAST WHERE  ITEMID =" & LSItemid & " "
        mysql = mysql & " AND EXID =" & LSEXID & " AND  MATURITY>='" & Format(LIConDate, "YYYY/MM/DD") & "' ORDER BY MATURITY"
        Set TRec = Nothing: Set TRec = New ADODB.Recordset
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not TRec.EOF Then
            
            LSSaudaCode = TRec!saudacode:   LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
        End If
        If LenB(LSSaudaCode) < 1 Then
            Set TRec = Nothing
            Set TRec = New ADODB.Recordset
            mysql = "SELECT TOP 1 MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
            mysql = mysql & " AND INSTTYPE='FUT' AND MATURITY>='" & Format(LIConDate, "yyyy/mm/dd") & "' ORDER BY MATURITY "
            TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            If Not TRec.EOF Then
                LSMaturity = TRec!MATURITY
                LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                LSSaudaID = Get_SaudaID(LSSaudaCode)
            Else
                LMsgBox = "Please Import new contracts  for " & LSItemCode & ""
                ImportIssues (LMsgBox)
            End If
        End If
        
    End If
End Sub
'Function re_create_REC() As ADODB.Recordset
'
'
'End Function

Sub Save_All_MTrade_Excel(lexceltype As Integer)

Dim LIFLAG As Boolean:          Dim lbparty As String:          Dim lsparty As String:          Dim LBQty As Double
Dim LSQty As Double:            Dim LBRate As Double:           Dim LSRate As Double:           Dim ldate As Date
Dim ltradedt As Date:           Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String
Dim MCount As Long:             Dim LConType As String:         Dim LSPtyContype As String
Dim LSConSno As Long:           Dim LSInstType As String:       Dim LContime As String:         Dim LOrdNo As String
Dim LOrdTime As String:         Dim LSTR As String:             Dim B As Integer:               Dim LMFLPath As String:
Dim LSCondate As Date:          Dim LSMaturity As Date:         Dim LOConNo As String:          Dim C As Integer
Dim StrDateLen As Integer:      Dim LSTRDATE As String:         Dim LMONTH As String:           Dim lyear As String
Dim LClient As String:          Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String
Dim TRec As ADODB.Recordset:    Dim LLOT As Double:             Dim LUserId As String:          Dim LPartyName As String
Dim LEXHCODE As String:         Dim LSItemName As String:       Dim LSTRCONDATE  As String:     Dim A As Integer
Dim LFieldName As String:       Dim LEx_Symbol  As String:      Dim LCMONTH As String:          Dim LSSaudaID As Long:
Dim LStrMonth As String:        Dim lday As Integer:            Dim LAcExCode As String:
Dim TempRec1 As ADODB.Recordset

'Dim LMFLPath As String

'Dim LTradeDt As Date
'Dim TxtPath As String:          Dim LFileName As String
On Error GoTo err1
    Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
    Call GET_JCnn("\" & LFolderName & "\;")
    
    Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
    If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
        LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
    End If
    Set LFileSystemObject = Nothing
                
    MSPARTY = LBrokerCode
    Cnn.BeginTrans
    CNNERR = True:
    For ltradedt = vcDTP1.Value To vcDTP2.Value
        TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV"
        LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
        If Not FileExist(LFileName) Then
            LMsgBox = LFileName & "  file not found" ', vbCritical
            ImportIssues (LMsgBox)
        Else
            If lexceltype = 25 Then
                LMFLPath = App.Path & "\" & LFolderName & "\"
                Call Create_Schema_Excel25(LMFLPath, TxtPath)
            End If
            
            Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
            TxtRec.Open "Select * from " & TxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
            If Not TxtRec.EOF Then
                
                TxtRec.MoveFirst
                TxtRec.MoveNext
                If UCase(Trim(TxtRec!F4)) = "POSITION" Then
                    Set TempRec1 = Nothing
                    Set TempRec1 = TxtRec.Clone
                    TempRec1.MoveFirst
                    TempRec1.MoveNext
                
                    Set TxtRec = Nothing
                    Set TxtRec = New ADODB.Recordset
                    TxtRec.Fields.Append "f1", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f2", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f3", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f4", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f5", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f6", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f7", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f8", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f9", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f10", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f11", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f12", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f13", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f14", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f15", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f16", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f17", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f18", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f19", adVarChar, 100, adFldIsNullable
                    TxtRec.Fields.Append "f20", adVarChar, 100, adFldIsNullable
                    TxtRec.Open , , adOpenKeyset, adLockOptimistic
    
                    TempRec1.MoveNext
                    While Not TempRec1.EOF
                        TxtRec.AddNew
                        TxtRec.Fields(0).Value = TempRec1!F1
                        TxtRec.Fields(1).Value = TempRec1!F2
                        TxtRec.Fields(2).Value = TempRec1!f3
                        TxtRec.Fields(3).Value = TempRec1!F5
                        TxtRec.Fields(4).Value = TempRec1!f6
                        TxtRec.Fields(5).Value = TempRec1!F7
                        TxtRec.Fields(6).Value = TempRec1!F8
                        TxtRec.Fields(7).Value = TempRec1!F9
                        TxtRec.Fields(8).Value = TempRec1!F10
                        TxtRec.Fields(9).Value = TempRec1!f11
                        TxtRec.Fields(10).Value = TempRec1!f12
                        TxtRec.Fields(11).Value = TempRec1!F13
                        TxtRec.Fields(12).Value = TempRec1!F14
                        TxtRec.Fields(13).Value = TempRec1!F15
                        TxtRec.Fields(14).Value = TempRec1!f16
                        TxtRec.Fields(15).Value = TempRec1!F17
                        TxtRec.Fields(16).Value = TempRec1!F18
                        TxtRec.Fields(17).Value = TempRec1!f19
                        TxtRec.Fields(18).Value = TempRec1!F20
                        TxtRec.Fields(19).Value = TempRec1!F21
                        TxtRec.Update
                        TempRec1.MoveNext
                    Wend
                End If
            
            
                FlagDataTrf = True
                CNNERR = True
                TxtRec.MoveFirst
                LSCondate = DateValue(ltradedt)
                ldate = LSCondate
                LNoTrd = 0
                MCount = Get_Max_ConNo(LSCondate, 0)
                
                While Not TxtRec.EOF
                    lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString
                    LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
                    LOrdTime = vbNullString:      LSOptType = vbNullString:      LSStrike = 0:                  LLOT = 0:
                    LBQty = 0:                    LSQty = 0:                    LBRate = 0:                   LSRate = 0
                    LSSaudaID = 0:                 LSItemid = 0: LSEXID = 0
                    LSExCode = vbNullString
                                        
                    If lexceltype = 65 Or lexceltype = 67 Then
                        If IsNull(TxtRec!F7) Then GoTo EFlag_Next
                        If Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s") Then GoTo EFlag_Next
                        LOConNo = TxtRec!F1
                        LOrdNo = (TxtRec!f3 & vbNullString)
                        If GUniqClientId = "VIP-GWA" Then
                            lbparty = "7" & Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
                        Else
                            lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
                        End If
                        LPartyName = lbparty & " " & TxtRec!F5
                        LSTRCONDATE = Left$(TxtRec!f6, 10)
                        LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
                        LSPtyContype = UCase(Left(TxtRec!F7, 1))
                        If Right(TxtRec!F10, 1) = "K" Then
                            LBQty = Val(Left(TxtRec!F10, Len(TxtRec!F10) - 1)) * 1000
                        Else
                            LBQty = Val(TxtRec!F10)
                        End If
                        LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11))
                        LSRate = LBRate
                        lsparty = LBrokerCode
                        Select Case lexceltype
                        Case 65
                            LMonthType = "M"
                            A = InStr(TxtRec!F9, "_")
                            If A = 0 Then
                                LSTR = UCase(Right(TxtRec!F9, 3))
                                If Left(LSTR, 3) = "JAN" Or Left(LSTR, 3) = "FEB" Or Left(LSTR, 3) = "MAR" Or Left(LSTR, 3) = "APR" _
                                Or Left(LSTR, 3) = "MAY" Or Left(LSTR, 3) = "JUN" Or Left(LSTR, 3) = "JUL" Or Left(LSTR, 3) = "AUG" _
                                Or Left(LSTR, 3) = "SEP" Or Left(LSTR, 3) = "OCT" Or Left(LSTR, 3) = "NOV" Or Left(LSTR, 3) = "DEC" Then
                                    A = Len(TxtRec!F9):                                    LEXHCODE = Left(TxtRec!F9, A - 3)
                                    LMONTH = Left(LSTR, 3):                                lyear = Year(LSCondate)
                                    LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear:       LSMaturity = DateValue(LSTRCONDATE)
                                End If
                            Else
                                If Left(TxtRec!F9, 3) = "M_M" Then
                                    LSTR = Right(TxtRec!F9, 3)
                                    A = Len(TxtRec!F9):                                    LEXHCODE = Left(TxtRec!F9, A - 3)
                                    LMONTH = Left(LSTR, 3):                                lyear = Year(LSCondate)
                                    LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear:       LSMaturity = DateValue(LSTRCONDATE)
                                Else
                                    LSTR = Right(TxtRec!F9, 2)
                                    If Left(LSTR, 3) = "01" Or Left(LSTR, 3) = "02" Or Left(LSTR, 3) = "03" Or Left(LSTR, 3) = "04" _
                                    Or Left(LSTR, 3) = "05" Or Left(LSTR, 3) = "06" Or Left(LSTR, 3) = "07" Or Left(LSTR, 3) = "08" _
                                    Or Left(LSTR, 3) = "09" Or Left(LSTR, 3) = "10" Or Left(LSTR, 3) = "11" Or Left(LSTR, 3) = "12" Then
                                        LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                        lyear = Year(LSCondate)
                                        LMONTH = Right(TxtRec!F9, 2)
                                        LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                    Else
                                        If Right(TxtRec!F9, 5) = "MARCH" Then
                                            LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                            lyear = Year(LSCondate)
                                            LSTR = Right(TxtRec!F9, 5)
                                            LMONTH = Left(LSTR, 3)
                                            LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                        ElseIf Right(TxtRec!F9, 3) = "FEB" Or Right(TxtRec!F9, 3) = "JAN" Or Right(TxtRec!F9, 3) = "DEC" Then
                                            LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                            lyear = Year(LSCondate)
                                            LMONTH = Right(TxtRec!F9, 3)
                                            LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                        End If
                                    End If
                                End If
                            End If
                            If month(LSMaturity) < month(LSCondate) Then
                                lyear = Year(LSCondate) + 1
                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                            End If
                        Case 67
                        
                            LMonthType = "M"
                            If Right(TxtRec!F9, 2) = "01" Or Right(TxtRec!F9, 2) = "02" Or Right(TxtRec!F9, 2) = "03" Or Right(TxtRec!F9, 2) = "04" _
                            Or Right(TxtRec!F9, 2) = "05" Or Right(TxtRec!F9, 2) = "06" Or Right(TxtRec!F9, 2) = "07" Or Right(TxtRec!F9, 2) = "08" _
                            Or Right(TxtRec!F9, 2) = "09" Or Right(TxtRec!F9, 2) = "10" Or Right(TxtRec!F9, 2) = "11" Or Right(TxtRec!F9, 2) = "12" Then
                                    LSTR = (TxtRec!F9)
                                    A = Len(LSTR)
                                    LEXHCODE = Trim(Left(LSTR, A - 2))
                                    lyear = Year(LSCondate)
                                    LMONTH = Right(LSTR, 2)
                                    lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                    LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear & "")
                            
                            ElseIf Right(TxtRec!F9, 3) = "-KP" Or Right(TxtRec!F9, 2) = "-K" Then
                                A = Len(TxtRec!F9)
                                LSTR = Left(TxtRec!F9, A - 3)
                                If Left(TxtRec!F9, 3) = "SGX" Then
                                    LMONTH = "DEC"
                                    A = InStr(TxtRec!F9, "-")
                                    LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                    lyear = Year(LSCondate)
                                    LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                Else
                                    A = Len(LSTR)
                                    LEXHCODE = Trim(Left(LSTR, A - 3))
                                    lyear = Year(LSCondate)
                                    LMONTH = Right(LSTR, 3)
                                    
                                    
                                    If month(LSCondate) > LMONTH Then
                                        lyear = lyear + 1
                                    End If
                                    lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                    
                                    'lday = Str(Day(DateSerial(LYEAR, LMONTH + 1, 1) - 1))

                                    LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear & "")
                                End If
                            ElseIf Right(TxtRec!F9, 2) = "-E" Or Right(TxtRec!F9, 4) = "-NxE" Then
                                A = Len(TxtRec!F9)
                                
                                If Right(TxtRec!F9, 2) = "-E" Then
                                    LSTR = Left(TxtRec!F9, A - 2)
                                    
                                    If Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "MAR" Or Right(LSTR, 3) = "APR" _
                                    Or Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" _
                                    Or Right(LSTR, 3) = "SEP" Or Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then
                                        A = Len(LSTR)
                                        LEXHCODE = Left(LSTR, A - 3)
                                        LMONTH = Right(LSTR, 3)
                                        LMonthType = "M"
                                    Else
                                        A = Len(LSTR)
                                        LEXHCODE = LSTR
                                        LMONTH = month(LSCondate)
                                        LMonthType = "C"
                                    End If
                                    lyear = Year(LSCondate)
                                    LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                    
                                Else
                                    LSTR = Left(TxtRec!F9, A - 4)
                                    A = Len(LSTR)
                                    LEXHCODE = LSTR
                                    lyear = Year(LSCondate)
                                    LMONTH = month(LSCondate)
                                    LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                    LMonthType = "N"
                                End If
                            ElseIf Right(TxtRec!F9, 1) = "k" Or Right(TxtRec!F9, 1) = "m" Or Right(TxtRec!F9, 1) = "M" Or Right(TxtRec!F9, 3) = "NxM" Then
                                LSTR = Left(TxtRec!F9, Len(TxtRec!F9) - 1)
                               
                                A = Len(TxtRec!F9)
                                If Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "MAR" Or Right(LSTR, 3) = "APR" _
                                    Or Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" _
                                    Or Right(LSTR, 3) = "SEP" Or Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then
                                    
                                    LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                    lyear = Year(LSCondate)
                                    LMONTH = Right(LEXHCODE, 3)
                                    
                                    
                                    lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                    LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear & "")
                                    LEXHCODE = Trim(Left(TxtRec!F9, A - 4))
                                ElseIf InStr(TxtRec!F9, "Z21") <> 0 Or InStr(TxtRec!F9, "G22") <> 0 Or InStr(TxtRec!F9, "F22") <> 0 Or _
                                InStr(TxtRec!F9, "H22") <> 0 Or InStr(TxtRec!F9, "J22") <> 0 Or InStr(TxtRec!F9, "K22") <> 0 Or _
                                InStr(TxtRec!F9, "M22") <> 0 Or InStr(TxtRec!F9, "N22") <> 0 Or InStr(TxtRec!F9, "Q22") <> 0 Or _
                                InStr(TxtRec!F9, "U22") <> 0 Or InStr(TxtRec!F9, "V22") <> 0 Or InStr(TxtRec!F9, "X22") <> 0 Then
                                    
                                    LEXHCODE = Trim(Left(TxtRec!F9, A - 4))
                                    lyear = Mid(TxtRec!F9, A - 2, 2)
                                    LSTR = Mid(TxtRec!F9, A - 3, 1)
                                    LMONTH = Get_CMX_Month(LSTR)
                                    LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                Else
                                    If Right(TxtRec!F9, 4) = "-NxM" Or Right(TxtRec!F9, 4) = "-nxm" Or Right(TxtRec!F9, 2) = "-M" Then
                                        If Right(TxtRec!F9, 2) = "-M" Then
                                            LSTR = Left(TxtRec!F9, Len(TxtRec!F9) - 2)
                                            If Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "MAR" Or Right(LSTR, 3) = "APR" _
                                                Or Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" _
                                                Or Right(LSTR, 3) = "SEP" Or Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then
                                                A = Len(LSTR)
                                                LEXHCODE = Trim(Left(LSTR, A - 3))
                                                LMONTH = Right(LSTR, 3)
                                                lyear = Year(LSCondate)
                                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                                LMonthType = "C"
                                            Else
                                                LEXHCODE = Trim(Left(TxtRec!F9, A - 2))
                                                A = Len(TxtRec!F9)
                                                LMONTH = month(LSCondate)
                                                lyear = Year(LSCondate)
                                                lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                                LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear & "")
                                                LMonthType = "C"
                                            End If
                                        Else
                                            LSTR = Left(TxtRec!F9, Len(TxtRec!F9) - 4)
                                            If Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "MAR" Or Right(LSTR, 3) = "APR" _
                                                Or Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" _
                                                Or Right(LSTR, 3) = "SEP" Or Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then
                                                A = Len(LSTR)
                                                LEXHCODE = Trim(Left(LSTR, A - 3))
                                                LMONTH = Right(LSTR, 3)
                                                lyear = Year(LSCondate)
                                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                                                LMonthType = "N"
                                            Else
                                        
                                                LEXHCODE = Trim(Left(TxtRec!F9, A - 4))
                                                A = Len(TxtRec!F9)
                                                LMONTH = month(LSCondate)
                                                lday = Day(LSCondate)
                                                If lday > 10 Then
                                                    If LMONTH = 12 Then
                                                        lyear = Year(LSCondate) + 1
                                                    Else
                                                        lyear = Year(LSCondate)
                                                    End If
                                                    LMONTH = Mid(LSCondate, 4, 2) + 1
                                                End If
                                                If LMONTH = 13 Then
                                                    LMONTH = 1
                                                End If
                                                lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                                LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear & "")
                                                LMonthType = "M"
                                            End If
                                        End If
                                    ElseIf Right(TxtRec!F9, 3) = "Nxm" Then
                                        LEXHCODE = Trim(Left(TxtRec!F9, A - 3))
                                        A = Len(TxtRec!F9)
                                        LMONTH = month(LSCondate)
                                        lyear = Year(LSCondate)
                                        If LMONTH = 12 Then
                                            LMONTH = 1
                                        Else
                                            LMONTH = Mid(LSCondate, 4, 2) + 1
                                        End If
                                        lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                        LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear & "")
                                        LMonthType = "N"
                                    Else
                                        LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                        A = Len(TxtRec!F9)
                                        LEXHCODE = Trim(Left(TxtRec!F9, A - 1))
                                        lyear = Year(LSCondate)
                                        LMONTH = Mid(LSCondate, 4, 2)
                                        If month(LSCondate) > Val(LMONTH) Then
                                            lyear = lyear + 1
                                        End If
                                        lday = GET_DAYS(LMONTH, lyear, LSCondate)
                                        LMonthType = "C"
                                       LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear & "")
                                    End If
                                End If
                            Else
                                A = Len(TxtRec!F9)
                                LEXHCODE = Trim(Left(TxtRec!F9, A - 3))
                                lyear = Year(LSCondate)
                                LMONTH = Right(TxtRec!F9, 2)
                                LSMaturity = DateValue("30/" & LMONTH & "/" & lyear & "")
                            End If
                            If month(LSMaturity) < month(LSCondate) Then
                                lyear = Year(LSCondate) + 1
                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                            End If
                            If LSMaturity < LSCondate Then
                                LSMaturity = LSMaturity + 5
                            End If
                        End Select
                    ElseIf lexceltype = 66 Then
                        If IsNull(TxtRec!F4) Then GoTo EFlag_Next
                        If TxtRec!F4 = "New" Or TxtRec!F4 = "Close" Then
                            LOConNo = TxtRec!F1:                                LOrdNo = (TxtRec!F1 & vbNullString)
                            LSTR = TxtRec!f6:                                   A = InStr(LSTR, ":")
                            lbparty = Left(TxtRec!f6, A - 1):                   LPartyName = Trim(TxtRec!f6)
                            LSTRCONDATE = Left$(TxtRec!F2, 10):                 LSCondate = DateValue(LSTRCONDATE)
                            LSPtyContype = UCase(Left(TxtRec!F5, 1)):           LBQty = Val(TxtRec!F7)
                            If TxtRec!F4 = "New" Then
                                LBRate = Val(TxtRec!F9):
                            Else
                                LBRate = Val(TxtRec!F10):
                            End If
                            
                            LSRate = LBRate
                            lsparty = LBrokerCode:                              LSTR = TxtRec!F8
                            A = InStr(LSTR, " "):                               LEXHCODE = Left(LSTR, A - 1)
                            lyear = Year(LSCondate)
                            If Right(TxtRec!F8, 3) = "Jan" Or Right(TxtRec!F8, 3) = "Feb" Or Right(TxtRec!F8, 3) = "Mar" Or Right(TxtRec!F8, 3) = "Apr" Or _
                             Right(TxtRec!F8, 3) = "May" Or Right(TxtRec!F8, 3) = "Jun" Or Right(TxtRec!F8, 3) = "Jul" Or Right(TxtRec!F8, 3) = "Aug" Or _
                             Right(TxtRec!F8, 3) = "Sep" Or Right(TxtRec!F8, 3) = "Oct" Or Right(TxtRec!F8, 3) = "Nov" Or Right(TxtRec!F8, 3) = "Dec" Then
                                LMONTH = Right(TxtRec!F8, 3):
                            ElseIf Right(TxtRec!F8, 5) = "March" Then
                                LMONTH = "Mar"
                            Else
                                LMsgBox = TxtRec!F9
                                ImportIssues (LMsgBox)
                            End If
                            LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                            If month(LSMaturity) < month(LSCondate) Then
                                lyear = Year(LSCondate) + 1
                                LSMaturity = DateValue("28/" & LMONTH & "/" & lyear & "")
                            End If
                            LMonthType = "M"
                        End If
                    End If
                    If LenB(LEXHCODE) < 1 Then
                        LMsgBox = "Could not import " & TxtRec!F9
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                    If lexceltype = 65 Or lexceltype = 66 Or lexceltype = 67 Then
                        LLOT = 1
                        LSExCode = vbNullString
                        If lexceltype = 67 Then
                            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 2)
                        Else
                            Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 3)
                        End If
                        
                        If LenB(LSItemCode) < 1 Then
                            LMsgBox = "Could not find New Item.Script " & LEXHCODE & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        If LMonthType = "M" Then
                            Set TRec = Nothing:                            Set TRec = New ADODB.Recordset
                            If LSInstType = "FUT" Then
                                mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                            Else
                                mysql = "SELECT SAUDACODE ,SAUDAID,MATURITY FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "'"
                                mysql = mysql & "  AND INSTTYPE ='OPT' AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE = " & LSStrike & ""
                            End If
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If Not TRec.EOF Then
                                LSSaudaCode = TRec!saudacode
                                LSMaturity = TRec!MATURITY
                                LSSaudaID = TRec!SAUDAID
                            Else
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                                If LSInstType <> "FUT" Then
                                    mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                                    mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                                Else
                                    mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                                End If
                                TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                                If Not TRec.EOF Then
                                    LSMaturity = TRec!MATURITY
                                    LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                Else
                                    If LSInstType = "FUT" Then
                                        LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                        If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                            LSSaudaCode = LSExCode & " " & LSSaudaCode
                                            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                                LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                                ImportIssues (LMsgBox)
                                                GoTo EFlag_Next
                                            End If
                                        End If
                                    Else
                                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    End If
                                    Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                                End If
                                LSSaudaID = Get_SaudaID(LSSaudaCode)
                            End If
                        Else
                            If LMonthType = "C" Then
                                mysql = "SELECT TOP 1 SAUDACODE,MATURITY,SAUDAID FROM SAUDAMAST WHERE INSTTYPE ='FUT'  AND ITEMID=" & LSItemid & " AND MATURITY>='" & Format(LSCondate, "YYYY/MM/DD") & "' ORDER BY MATURITY "
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If TRec.EOF Then
                                    Set TRec = Nothing
                                    Set TRec = New ADODB.Recordset
                                    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                                    mysql = mysql & " AND INSTTYPE='FUT' AND MATURITY>='" & Format(LSCondate, "YYYY/MM/DD") & "' ORDER BY MATURITY "
                                    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                                    If TRec.EOF Then
                                        If LSInstType = "FUT" Then
                                            LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                                LSSaudaCode = LSExCode & " " & LSSaudaCode
                                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                                    LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                                    ImportIssues (LMsgBox)
                                                    GoTo EFlag_Next
                                                End If
                                            End If
                                        Else
                                            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                            ImportIssues (LMsgBox)
                                            GoTo EFlag_Next
                                        End If
                                    Else
                                        LSMaturity = TRec!MATURITY
                                        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                    End If
                                Else
                                    LSSaudaCode = TRec!saudacode
                                    LSMaturity = TRec!MATURITY
                                    LSSaudaID = TRec!SAUDAID
                                End If
                            Else
                                mysql = "SELECT MATURITY FROM SCRIPTMASTER  WHERE INSTTYPE ='FUT'  AND  EX_SYMBOL= '" & LSEx_Symbol & "' AND EXCODE ='" & LSExCode & "' AND MATURITY>=(Convert(datetime, '" & Format((LSCondate), "YYYY/MM/DD") & "')-5) ORDER BY MATURITY "
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If TRec.EOF Then
                                    mysql = "SELECT SAUDACODE,SAUDAID,MATURITY FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND INSTTYPE ='FUT'  AND ITEMCODE ='" & LSItemCode & "' AND EXCODE ='" & LSExCode & "' AND MATURITY>=(Convert(datetime, '" & Format((LSCondate), "YYYY/MM/DD") & "')-5) ORDER BY MATURITY "
                                    Set TRec = Nothing
                                    Set TRec = New ADODB.Recordset
                                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                    If Not TRec.EOF Then
                                        TRec.MoveNext
                                        If Not TRec.EOF Then
                                            LSSaudaCode = TRec!saudacode
                                            LSMaturity = TRec!MATURITY
                                            LSSaudaID = TRec!SAUDAID
                                        Else
                                            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " Next Month Maturity " & LSOptType & " " & LSStrike & ""
                                            ImportIssues (LMsgBox)
                                            GoTo EFlag_Next
                                        End If
                                    Else
                                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    End If
                                Else
                                    TRec.MoveNext
                                    If TRec.EOF Then
                                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    Else
                                        LSMaturity = TRec!MATURITY
                                        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                        mysql = "SELECT SAUDACODE,MATURITY,SAUDAID FROM SAUDAMAST WHERE compcode = " & GCompCode & "  and SAUDACODE = '" & LSSaudaCode & "' "
                                        Set TRec = Nothing
                                        Set TRec = New ADODB.Recordset
                                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                        If Not TRec.EOF Then
                                            LSMaturity = TRec!MATURITY
                                            LSSaudaID = TRec!SAUDAID
                                        Else
                                            GoTo EFlag_Next
                                        End If
                                        
                                        
                                    End If
                                End If
                            End If
                        End If
                     End If
                     
                    If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
                    If LSCondate > LSMaturity Then
                        If Day(LSCondate) > 25 Then
                            mysql = "SELECT MATURITY FROM SCRIPTMASTER  WHERE INSTTYPE ='FUT'  AND  EX_SYMBOL= '" & LSEx_Symbol & "' AND EXCODE ='" & LSExCode & "' AND MATURITY>=(Convert(datetime, '" & Format((LSCondate), "YYYY/MM/DD") & "')-5) ORDER BY MATURITY "
                            Set TRec = Nothing
                            Set TRec = New ADODB.Recordset
                            TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                            If TRec.EOF Then
                                mysql = "SELECT SAUDACODE,SAUDAID,MATURITY FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND INSTTYPE ='FUT'  AND ITEMCODE ='" & LSItemCode & "' AND EXCODE ='" & LSExCode & "' AND MATURITY>=(Convert(datetime, '" & Format((LSCondate), "YYYY/MM/DD") & "')-5) ORDER BY MATURITY "
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec.EOF Then
                                    TRec.MoveNext
                                    If Not TRec.EOF Then
                                        LSSaudaCode = TRec!saudacode
                                        LSMaturity = TRec!MATURITY
                                        LSSaudaID = TRec!SAUDAID
                                    Else
                                        LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " Next Month Maturity " & LSOptType & " " & LSStrike & ""
                                        ImportIssues (LMsgBox)
                                        GoTo EFlag_Next
                                    End If
                                End If
                          Else
                            TRec.MoveNext
                            If TRec.EOF Then
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity
                                ImportIssues (LMsgBox)
                                GoTo EFlag_Next
                            Else
                                LSMaturity = TRec!MATURITY
                                LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                                mysql = "SELECT SAUDACODE,MATURITY,SAUDAID FROM SAUDAMAST WHERE compcode = " & GCompCode & "  and SAUDACODE = '" & LSSaudaCode & "' "
                                Set TRec = Nothing
                                Set TRec = New ADODB.Recordset
                                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                                If Not TRec.EOF Then
                                    LSMaturity = TRec!MATURITY
                                    LSSaudaID = TRec!SAUDAID
                                Else
                                    GoTo EFlag_Next
                                End If
                            End If
                          End If
                        Else
                            LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                            ImportIssues (LMsgBox)
                        End If
                    End If
                    If LBQty <> 0 Then
                        LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                        mbparty = Get_ACCT_EX(LSEXID, lbparty)
                        If LenB(mbparty) < 1 Then
                            If GUniqClientId = "2148MUM" Then
                                mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, False)
                            Else
                                mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                            End If
                        End If
                        MSPARTY = lsparty
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "SELECT BROKER FROM EXBROKCLIENT WHERE COMPCODE =" & GCompCode & " AND CLIENT ='" & mbparty & "'"
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TRec.EOF Then MSPARTY = TRec!BROKER
                        If LenB(MSPARTY) < 1 Then
                            Call Get_ExDetail(LSExCode)
                            MSPARTY = LExCont
                        End If
                        
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        If LenB(MSPARTY) < 1 Then
                            LMsgBox = " Broker does Not Exist " & lsparty & ""
                            ImportIssues (LMsgBox)
                            GoTo EFlag_Next
                        End If
                        mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                        Cnn.Execute mysql
                        MCount = Get_Max_ConNo(CDate(LSCondate), 0): MCount = MCount + 1:
                        'MCount = MCount + 1:
                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                            LBillExId = LBillExId & str(LSEXID)
                        End If
                        If lminbilldate > LSCondate Then lminbilldate = LSCondate
                        LNoTrd = LNoTrd + 1
                        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F8
                        DoEvents
                        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                        Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                    End If
EFlag_Next:
                    TxtRec.MoveNext
                Wend
                'MsgBox "No of Trades imported " & LNoTrd & ""
                LMsgBox = " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
                ImportIssues (LMsgBox)
            End If
        End If
    Next ltradedt
    Cnn.CommitTrans
    CNNERR = False
    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number
    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Sub OPTION_ITEM(LExhCode1 As String, Vexcelcolval As String)
'>>>>>>>> CASE 38

            Dim Vday As Integer
            Dim Vmonth As String
            Dim Vrate As Double
            Dim Vlastchar As String
            Dim mstr As String
            
                            
            '>>>>>>>>> temp
            Vexcelcolval = "":            Vitemcode = "":            Vday = 0:            Vmonth = "":            Vrate = 0:
            Vlastchar = "":            Vdate = "01/01/1900":
            
            Vexcelcolval = LExhCode1
            If Left(Right(Vexcelcolval, 6), 1) = "C" Or Left(Right(Vexcelcolval, 6), 1) = "P" Then
                mstr = Right(Vexcelcolval, 6)
                LSOptType = Left(mstr, 1) + "E"
                Vmonth = Right(mstr, 3)
                Vday = Mid(mstr, 2, 2)
                If Vmonth = "JAN" Or Vmonth = "JN" Then
                    Vdate = CStr(Vday) + "/01/" + CStr(Year(Date))
                ElseIf Vmonth = "FEB" Or Vmonth = "FB" Then
                    Vdate = CStr(Vday) + "/02/" + CStr(Year(Date))
                ElseIf Vmonth = "MAR" Or Vmonth = "MR" Then
                    Vdate = CStr(Vday) + "/03/" + CStr(Year(Date))
                ElseIf Vmonth = "APR" Or Vmonth = "AP" Then
                    Vdate = CStr(Vday) + "/04/" + CStr(Year(Date))
                ElseIf Vmonth = "MAY" Or Vmonth = "MY" Then
                    Vdate = CStr(Vday) + "/05/" + CStr(Year(Date))
                ElseIf Vmonth = "JUN" Or (Vmonth = "JN" And month(Now) = 6 And Day(Now) >= 1 And Day(Now) <= 27) Then
                    Vdate = CStr(Vday) + "/06/" + CStr(Year(Date))
                ElseIf Vmonth = "JUL" Or (Vmonth = "JL" And month(Now) = 6 And Day(Now) > 27) Or (Vmonth = "JL" And month(Now) = 7) Then
                    Vdate = CStr(Vday) + "/07/" + CStr(Year(Date))
                ElseIf Vmonth = "AUG" Or Vmonth = "AG" Then
                    Vdate = CStr(Vday) + "/08/" + CStr(Year(Date))
                ElseIf Vmonth = "SEP" Or Vmonth = "SP" Then
                    Vdate = CStr(Vday) + "/09/" + CStr(Year(Date))
                ElseIf Vmonth = "OCT" Or Vmonth = "CT" Then
                    Vdate = CStr(Vday) + "/10/" + CStr(Year(Date))
                ElseIf Vmonth = "NOV" Or Vmonth = "NV" Then
                    Vdate = CStr(Vday) + "/11/" + CStr(Year(Date))
                ElseIf Vmonth = "DEC" Or Vmonth = "DC" Then
                    Vdate = CStr(Vday) + "/12/" + CStr(Year(Date))
                End If
                LMONTH = Vmonth
                If Left(Vexcelcolval, 5) = "NIFTY" Then
                    Vitemcode = "NIFTY"
                    Vrate = Mid(Vexcelcolval, 6, 5)
                Else
                    Vitemcode = "BANKNIFTY"
                    Vrate = Mid(Vexcelcolval, 10, 5)
                End If
                LSStrike = Vrate
                LEXHCODE = Vitemcode
            Else
                If IsNumeric(Right(Mid(Vexcelcolval, 1, 4), 1)) Then
                    Vitemcode = Left(Vexcelcolval, 3)
                Else
                    Vitemcode = Left(Vexcelcolval, 4)
                End If
                LEXHCODE = Vitemcode
    
                Vexcelcolval = Replace(Vexcelcolval, Vitemcode, "")
                Vlastchar = Right(Vexcelcolval, 1)
                Vexcelcolval = Mid(Vexcelcolval, 1, Len(Vexcelcolval) - 1)
                        
                If IsNumeric(Left(Vexcelcolval, 2)) Then  '>>> 2 char day
                    Vday = Left(Vexcelcolval, 2)
                    Vexcelcolval = Mid(Vexcelcolval, 3, Len(Vexcelcolval))
                    mstr = Left(Vexcelcolval, 3)
                    If InStr(mstr, "JAN") = 0 And InStr(mstr, "FEB") = 0 And InStr(mstr, "MAR") = 0 And _
                        InStr(mstr, "APR") = 0 And InStr(mstr, "MAY") = 0 And InStr(mstr, "JUN") = 0 And _
                        InStr(mstr, "JUL") = 0 And InStr(mstr, "AUG") = 0 And InStr(mstr, "SEP") = 0 And _
                        InStr(mstr, "OCT") = 0 And InStr(mstr, "NOV") = 0 And InStr(mstr, "DEC") = 0 Then
                        Vmonth = UCase(Left(Vexcelcolval, 2)) '>>> 2 char month like JA, FE, MA ...
                        Vexcelcolval = Mid(Vexcelcolval, 3, Len(Vexcelcolval))
                    Else
                        Vmonth = UCase(Left(Vexcelcolval, 3)) '>>> 3 char month like JAN, FEB, MAR ...
                        Vexcelcolval = Mid(Vexcelcolval, 4, Len(Vexcelcolval))
                    End If
                Else
                    Vday = Left(Vexcelcolval, 1)  '>>> 1 char day
                    Vexcelcolval = Mid(Vexcelcolval, 2, Len(Vexcelcolval))
                    Vmonth = UCase(Left(Vexcelcolval, 3)) '>>> 3 char month like JAN, FEB, MAR ...
                    Vexcelcolval = Mid(Vexcelcolval, 4, Len(Vexcelcolval))
                End If
                                
                Vrate = Vexcelcolval
                If Vmonth = "JAN" Or Vmonth = "JN" Then
                    Vdate = CStr(Vday) + "/01/" + CStr(Year(Date))
                ElseIf Vmonth = "FEB" Or Vmonth = "FB" Then
                    Vdate = CStr(Vday) + "/02/" + CStr(Year(Date))
                ElseIf Vmonth = "MAR" Or Vmonth = "MR" Then
                    Vdate = CStr(Vday) + "/03/" + CStr(Year(Date))
                ElseIf Vmonth = "APR" Or Vmonth = "AP" Then
                    Vdate = CStr(Vday) + "/04/" + CStr(Year(Date))
                ElseIf Vmonth = "MAY" Or Vmonth = "MY" Then
                    Vdate = CStr(Vday) + "/05/" + CStr(Year(Date))
                ElseIf Vmonth = "JUN" Or (Vmonth = "JN" And month(Now) = 6 And Day(Now) >= 1 And Day(Now) <= 27) Then
                    Vdate = CStr(Vday) + "/06/" + CStr(Year(Date))
                ElseIf Vmonth = "JUL" Or (Vmonth = "JL" And month(Now) = 6 And Day(Now) > 27) Or (Vmonth = "JL" And month(Now) = 7) Then
                    Vdate = CStr(Vday) + "/07/" + CStr(Year(Date))
                ElseIf Vmonth = "AUG" Or Vmonth = "AG" Then
                    Vdate = CStr(Vday) + "/08/" + CStr(Year(Date))
                ElseIf Vmonth = "SEP" Or Vmonth = "SP" Then
                    Vdate = CStr(Vday) + "/09/" + CStr(Year(Date))
                ElseIf Vmonth = "OCT" Or Vmonth = "CT" Then
                    Vdate = CStr(Vday) + "/10/" + CStr(Year(Date))
                ElseIf Vmonth = "NOV" Or Vmonth = "NV" Then
                    Vdate = CStr(Vday) + "/11/" + CStr(Year(Date))
                ElseIf Vmonth = "DEC" Or Vmonth = "DC" Then
                    Vdate = CStr(Vday) + "/12/" + CStr(Year(Date))
                End If
                
                LSOptType = Vlastchar + "E"
                LSStrike = Vrate
                LMONTH = Vmonth
                LSTRCONDATE = Vdate
                '>>>>>>>>> temp end
          End If
End Sub
Sub EXCEL_38(Optional LClientCode As String)
    Dim TRec As ADODB.Recordset
    Dim mysql As String
    Dim lday As Integer
    Dim MLEN As Integer: Dim larr() As String
    Dim LSTR2 As String
    
    Dim LInstType As String
    LSExCode = vbNullString
    LOConNo = TxtRec!F1:                        LOrdNo = (TxtRec!f3 & vbNullString)
    lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
    
    
    If Len(LClientCode) > 1 Then
        lbparty = LClientCode
   Else
        If InStr(lbparty, " ") Then
            lbparty = Replace(lbparty, " ", vbNullString)
        End If
   End If

    LPartyName = lbparty & " " & TxtRec!F5:                     LSTRCONDATE = Left$(TxtRec!f6, 10)
    LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
    LSPtyContype = UCase(Left(TxtRec!F7, 1))
    DoEvents

    If InStr(1, TxtRec!F9, "^") <= 0 Then
        A = Len(TxtRec!F9)
        If Right(TxtRec!F9, 4) = "DEC2" Or Right(TxtRec!F9, 4) = "JAN2" Then
            LSTR = Right(TxtRec!F9, 4)
            LEXHCODE = Left$(TxtRec!F9, A - 4)
        Else
            LSTR = Right(TxtRec!F9, 5)
            LEXHCODE = Left$(TxtRec!F9, A - 3)
        End If
    End If

    If TxtRec!F20 = "USD" Then
        LSExCode = "CMX"
        If TxtRec!F9 = "ALUMINIUM" Or TxtRec!F9 = "COPPER" Or (Left(TxtRec!F9, 1) = "X" And Right(TxtRec!F9, 3) = "USD") Then
            LSTRCONDATE = GFinEnd
            LEXHCODE = "LCMX " + TxtRec!F9
        ElseIf Right(TxtRec!F9, 2) <> "24" And Right(TxtRec!F9, 2) <> "23" Then
            LMONTH = Right(TxtRec!F9, 3)
            If Right(TxtRec!F9, 1) = "Q" Or Right(TxtRec!F9, 1) = "m" Or Right(TxtRec!F9, 1) = "J" Or Right(TxtRec!F9, 1) = "K" Then
                LSTR = Left(TxtRec!F9, Len(TxtRec!F9) - 1)
                If Right(TxtRec!F9, 1) = "m" Then
                    LMONTH = Left(Right(LSTR, 3), 1)
                    lyear = "20" + Right(LSTR, 2)
                    LEXHCODE = "CMX " + Left$(LSTR, Len(LSTR) - 3)
                    LMONTH = Get_CMX_Month(Left(LMONTH, 1))
                ElseIf Right(TxtRec!F9, 1) = "J" Or Right(TxtRec!F9, 1) = "K" Then
                    LMONTH = Mid(TxtRec!F9, InStr(TxtRec!F9, "-") + 1, 3)
                    If LMONTH = "JAN" Or LMONTH = "FEB" Or LMONTH = "MAR" Or LMONTH = "APR" Or _
                        LMONTH = "MAY" Or LMONTH = "JUN" Or LMONTH = "JUL" Or LMONTH = "AUG" Or _
                        LMONTH = "SEP" Or LMONTH = "OCT" Or LMONTH = "NOV" Or LMONTH = "DEC" Then
                        lyear = Year(LSCondate)
                        LSTR = Left(TxtRec!F9, InStr(TxtRec!F9, "-") - 1)
                        
                        If InStr(TxtRec!F9, "GC-") <> 0 Then
                            LEXHCODE = "CMX GC"
                        ElseIf InStr(TxtRec!F9, "SI-") <> 0 Then
                            LEXHCODE = "CMX SI"
                        ElseIf InStr(TxtRec!F9, "DINR-") <> 0 Then
                            LEXHCODE = "CMX DINR"
                        ElseIf InStr(TxtRec!F9, "HG-") <> 0 Then
                            LEXHCODE = "CMX HG"
                        ElseIf InStr(TxtRec!F9, "CL-") <> 0 Then
                            LEXHCODE = "CMX CL"
                        Else
                            LEXHCODE = "CMX " + LSTR
                        End If
                    Else
                        LMONTH = Left(Right(LSTR, 3), 1)
                        LMONTH = Get_CMX_Month(Left(LMONTH, 1))
                        lyear = Year(LSCondate)
                        LSTR = Left(TxtRec!F9, InStr(TxtRec!F9, "-") - 1)
                        If InStr(TxtRec!F9, "GC-") <> 0 Then
                            LEXHCODE = "CMX GC"
                        ElseIf InStr(TxtRec!F9, "SI-") <> 0 Then
                            LEXHCODE = "CMX SI"
                        ElseIf InStr(TxtRec!F9, "DINR-") <> 0 Then
                            LEXHCODE = "CMX DINR"
                        ElseIf InStr(TxtRec!F9, "HG-") <> 0 Then
                            LEXHCODE = "CMX HG"
                        ElseIf InStr(TxtRec!F9, "CL-") <> 0 Then
                            LEXHCODE = "CMX CL"
                        Else
                            LEXHCODE = "CMX " + LSTR
                        End If
                        
                    End If

                    LSOptType = ""
                    LInstType = "FUT"
                Else
                    LMONTH = Right(LSTR, 3)
                    lyear = Year(LSCondate)
                    LEXHCODE = "CMX " + Left$(LSTR, Len(LSTR) - 3)
                End If
            ElseIf LMONTH = "JAN" Or LMONTH = "FEB" Or LMONTH = "MAR" Or LMONTH = "APR" Or _
                LMONTH = "MAY" Or LMONTH = "JUN" Or LMONTH = "JUL" Or LMONTH = "AUG" Or _
                LMONTH = "SEP" Or LMONTH = "OCT" Or LMONTH = "NOV" Or LMONTH = "DEC" Then
                lyear = Year(LSCondate)
                LEXHCODE = "CMX " + Left$(TxtRec!F9, A - 3)
            Else
                If InStr(LSTR, "01") <> 0 Or InStr(LSTR, "02") <> 0 Or InStr(LSTR, "03") <> 0 Or _
                    InStr(LSTR, "04") <> 0 Or InStr(LSTR, "05") <> 0 Or InStr(LSTR, "06") <> 0 Or _
                    InStr(LSTR, "07") <> 0 Or InStr(LSTR, "08") <> 0 Or InStr(LSTR, "09") <> 0 Or _
                    InStr(LSTR, "10") <> 0 Or InStr(LSTR, "11") <> 0 Or InStr(LSTR, "12") <> 0 Then
                    LMONTH = Right(LSTR, 2)
                ElseIf InStr(TxtRec!F9, "-") <> 0 Then
                    A = InStr(TxtRec!F9, "-")
                    LEXHCODE = Left(TxtRec!F9, A - 1)
                    LSInstType = "OPT"
                    LSTR = Mid(TxtRec!F9, A + 1, 1)
                    LMONTH = Get_CMX_Month(Left(LSTR, 1))
                    lyear = Mid(TxtRec!F9, A + 2, 2)
                    If Mid(TxtRec!F9, A + 4, 1) = "C" Then
                        LSOptType = "CE"
                    Else
                        LSOptType = "PE"
                    End If
                    LSStrike = Right(TxtRec!F9, Len(TxtRec!F9) - (A + 4))
                    lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    Vdate = DateValue(LSTRCONDATE)
                    Vitemcode = LEXHCODE
                    LMONTH = Get_CMX_Month(Left(LSTR, 1))
                End If
                If InStr(TxtRec!F9, "-") = 0 And InStr(TxtRec!F9, " ") = 0 Then
                    LEXHCODE = "CMX " + TxtRec!F9
                    LSTRCONDATE = GFinEnd
                Else
                    LSTR = Right(TxtRec!F9, 3)
                    lyear = Year(LSCondate)
                    LEXHCODE = "CMX " + Left$(TxtRec!F9, A - 3)
                End If
            End If
        ElseIf InStr(1, TxtRec!F9, "^") > 0 Then
            larr = Split(TxtRec!F9, "^")
            LSTR = larr(0)
            LEXHCODE = larr(0)
            lday = larr(1)
            LMONTH = larr(2)
            lyear = larr(3)
        ElseIf Right(TxtRec!F9, 2) = "24" Or Right(TxtRec!F9, 2) = "23" Then
            If InStr(TxtRec!F9, "JAN") <> 0 Or InStr(TxtRec!F9, "FEB") <> 0 Or InStr(TxtRec!F9, "MAR") <> 0 Or InStr(TxtRec!F9, "APR") <> 0 Or _
                InStr(TxtRec!F9, "MAY") <> 0 Or InStr(TxtRec!F9, "JUN") <> 0 Or InStr(TxtRec!F9, "JUL") <> 0 Or InStr(TxtRec!F9, "AUG") <> 0 Or _
                InStr(TxtRec!F9, "SEP") <> 0 Or InStr(TxtRec!F9, "OCT") <> 0 Or InStr(TxtRec!F9, "NOV") <> 0 Or InStr(TxtRec!F9, "DEC") <> 0 Then
            
                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 5)
                LMONTH = Left(Right(TxtRec!F9, 5), 3)
                lyear = Right(TxtRec!F9, 2)
            ElseIf InStr(TxtRec!F9, "-") = 0 Then
                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 3)
                LSTR = Right(TxtRec!F9, 3)
                LMONTH = Get_CMX_Month(Left(LSTR, 1))
                lyear = Right(LSTR, 2)
            Else
                A = InStr(TxtRec!F9, "-")
                LEXHCODE = "CMX " + Left(TxtRec!F9, A - 1)
                LSTR = Mid(TxtRec!F9, A + 1, 5)
                If Len(LSTR) = 3 Then
                    LMONTH = Get_CMX_Month(Left(LSTR, 1))
                    lyear = Right(LSTR, 2)
                Else
                    LMONTH = Left(LSTR, 3)
                    lyear = Right(LSTR, 2)
                End If
            End If

             LSInstType = "FUT"

        ElseIf InStr(TxtRec!F9, "-") <> 0 Then
            A = InStr(TxtRec!F9, "-")
            LEXHCODE = Left(TxtRec!F9, A - 1)
            LSInstType = "OPT"
            LSTR = Mid(TxtRec!F9, A + 1, 1)
            LMONTH = Get_CMX_Month(Left(LSTR, 1))
            lyear = Mid(TxtRec!F9, A + 2, 2)
            If Mid(TxtRec!F9, A + 4, 1) = "C" Then
                LSOptType = "CE"
            Else
                LSOptType = "PE"
            End If
            LSStrike = Right(TxtRec!F9, Len(TxtRec!F9) - (A + 4))
            lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
            LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
            Vdate = DateValue(LSTRCONDATE)
            Vitemcode = LEXHCODE
        Else
            LSTR = Right(TxtRec!F9, 5)
            LMONTH = Left(LSTR, 3)
            If LMONTH = "JAN" Or LMONTH = "FEB" Or LMONTH = "MAR" Or LMONTH = "APR" Or _
            LMONTH = "MAY" Or LMONTH = "JUN" Or LMONTH = "JUL" Or LMONTH = "AUG" Or _
            LMONTH = "SEP" Or LMONTH = "OCT" Or LMONTH = "NOV" Or LMONTH = "DEC" Then
                LSTR = Right(TxtRec!F9, 5)
                LMONTH = Left(LSTR, 3)
                lyear = "20" & Right(LSTR, 2)
                LEXHCODE = Left$(TxtRec!F9, A - 6)
            Else
                If LMONTH = "SEP" Then
                    LSTR = Right(TxtRec!F9, 5)
                    LMONTH = Left(LSTR, 3)
                    lyear = "20" & Right(LSTR, 2)
                    LEXHCODE = Left$(TxtRec!F9, A - 6)
                Else
                    If InStr(TxtRec!F9, "-") <> 0 Then
                        LSTR = Right(TxtRec!F9, 4)
                    
                        LMONTH = Get_CMX_Month(Left(LSTR, 1))
                        lyear = "20" & Right(LSTR, 2)
                        LEXHCODE = Left$(TxtRec!F9, A - 4)
                    Else
                        LSTR = Right(TxtRec!F9, 3)
                    
                        LMONTH = Get_CMX_Month(Left(LSTR, 1))
                        lyear = "20" & Right(LSTR, 2)
                        LEXHCODE = Left$(TxtRec!F9, A - 3)
                        LSExCode = "CMX"
                    End If
                End If
            End If
        End If
    Else
        If InStr(1, TxtRec!F9, "^") > 0 Then
            larr = Split(TxtRec!F9, "^")
            LEXHCODE = larr(0)
            If InStr(TxtRec!F9, "M_M") = 0 And InStr(TxtRec!F9, "L_T") = 0 Then
                LSTR = TxtRec!F9
                A = InStr(TxtRec!F9, "_")
                If A <> 0 Then
                    LEXHCODE = Left(TxtRec!F9, A - 1)
                Else
                    LEXHCODE = larr(0)
                End If
            Else
                LEXHCODE = larr(0)
                A = InStr(TxtRec!F9, "M_M")
                If A <> 0 Then
                    LEXHCODE = Left(TxtRec!F9, 3)
                End If

                A = InStr(TxtRec!F9, "M_MFIN")
                If A <> 0 Then
                    LEXHCODE = Left(TxtRec!F9, 6)
                End If
            End If
            If (IsNumeric(Right(LEXHCODE, 2)) Or (Right(LEXHCODE, 1) = "O" And IsNumeric(Left(Right(LEXHCODE, 3), 2)))) And LEXHCODE <> "GUARSEED10" And LEXHCODE <> "GUAR10" And LEXHCODE <> "GUAR10O" Then

                If Right(LEXHCODE, 1) = "O" And IsNumeric(Left(Right(LEXHCODE, 3), 2)) Then
                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 1)
                End If
                
                If Left(Right(LEXHCODE, 3), 1) = "P" Or Left(Right(LEXHCODE, 3), 1) = "C" Then
                    lday = Right(LEXHCODE, 2)
                    LMONTH = larr(2)
                    lyear = larr(3)

                    LSInstType = "OPT"
                    LSStrike = Left(Right(LEXHCODE, 8), 5)
                    If Left(Right(LEXHCODE, 3), 1) = "C" Then
                        LSOptType = "CE"
                    Else
                        LSOptType = "PE"
                    End If
                    lday = Right(LEXHCODE, 2)
                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 8)
                    

                    
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    Vdate = DateValue(LSTRCONDATE)
                    Vitemcode = LEXHCODE
                    
                End If
            Else
                LSTR = larr(0)
                lday = larr(1)
                LMONTH = larr(2)
                lyear = larr(3)
                If Right(LSTR, 1) = "_" Then
                    LSTR = Left(LSTR, Len(LSTR) - 1)
                End If
          End If
            
        ElseIf TxtRec!F9 = "SGXNIFTYN" Then
            LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 1)
            LMonthType = "C":
            LMONTH = month(LSCondate)
            lyear = Year(LSCondate)
        
        ElseIf (Right(TxtRec!F9, 1) = "C" Or Right(TxtRec!F9, 1) = "P") And (InStr(TxtRec!F9, "I") <> 0 Or InStr(TxtRec!F9, "II") <> 0 Or InStr(TxtRec!F9, "III") Or InStr(TxtRec!F9, "IV") _
            Or InStr(TxtRec!F9, "V") <> 0 Or InStr(TxtRec!F9, "VI") <> 0 Or InStr(TxtRec!F9, "VII") Or InStr(TxtRec!F9, "VIII") _
            Or InStr(TxtRec!F9, "IX") <> 0 Or InStr(TxtRec!F9, "X") <> 0 Or InStr(TxtRec!F9, "XI") Or InStr(TxtRec!F9, "XII")) Then
            A = InStr(TxtRec!F9, "_")
            Vitemcode = Left(TxtRec!F9, A - 1)
            MLEN = Len(TxtRec!F9)
            LSInstType = "OPT"
            If Mid(TxtRec!F9, A + 3, 4) = "VIII" Then
                LSTR = Mid(TxtRec!F9, A + 3, 4)
                LMONTH = Get_RMN_Month(LSTR)
                LSStrike = Mid(TxtRec!F9, A + 7, MLEN - (A + 7))
            ElseIf Mid(TxtRec!F9, A + 3, 3) = "III" Or Mid(TxtRec!F9, A + 3, 3) = "VII" Or Mid(TxtRec!F9, A + 3, 3) = "XII" Then
                LSTR = Mid(TxtRec!F9, A + 3, 3)
                LMONTH = Get_RMN_Month(LSTR)
                LSStrike = Mid(TxtRec!F9, A + 6, MLEN - (A + 6))
            ElseIf Mid(TxtRec!F9, A + 3, 2) = "II" Or Mid(TxtRec!F9, A + 3, 2) = "VI" Or Mid(TxtRec!F9, A + 3, 2) = "IV" Or Mid(TxtRec!F9, A + 3, 2) = "IX" Or Mid(TxtRec!F9, A + 3, 2) = "XI" Then
                LSTR = Mid(TxtRec!F9, A + 3, 2)
                LMONTH = Get_RMN_Month(LSTR)
                LSStrike = Mid(TxtRec!F9, A + 5, MLEN - (A + 5))
            ElseIf Mid(TxtRec!F9, A + 3, 1) = "I" Or Mid(TxtRec!F9, A + 3, 1) = "V" Or Mid(TxtRec!F9, A + 3, 1) = "X" Then
                LSTR = Mid(TxtRec!F9, A + 3, 1)
                LMONTH = Get_RMN_Month(LSTR)
                LSStrike = Mid(TxtRec!F9, A + 4, MLEN - (A + 4))
            End If
            If Right(TxtRec!F9, 1) = "C" Then
                LSOptType = "CE"
            Else
                LSOptType = "PE"
            End If
            lday = Mid(TxtRec!F9, A + 1, 2)
            lyear = Year(LSCondate)
            LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
            Vdate = DateValue(LSTRCONDATE)

        ElseIf InStr(TxtRec!F9, "_I") <> 0 Or InStr(TxtRec!F9, "_II") <> 0 Or InStr(TxtRec!F9, "_III") Or InStr(TxtRec!F9, "_IV") _
            Or InStr(TxtRec!F9, "_V") <> 0 Or InStr(TxtRec!F9, "_VI") <> 0 Or InStr(TxtRec!F9, "_VII") Or InStr(TxtRec!F9, "_VIII") _
            Or InStr(TxtRec!F9, "_IX") <> 0 Or InStr(TxtRec!F9, "_X") <> 0 Or InStr(TxtRec!F9, "_XI") Or InStr(TxtRec!F9, "_XII") Then
            
            If Right(TxtRec!F9, 1) = "Q" Then
                LSTR2 = Left(TxtRec!F9, Len(TxtRec!F9) - 1)
                
                If Right(LSTR2, 2) = "_I" Or Right(LSTR2, 2) = "_V" Or Right(LSTR2, 2) = "_X" Then ' 1,5,10
                    A = 2
                    LSTR = Right(LSTR2, 1)
                ElseIf Right(LSTR2, 3) = "_II" Or Right(LSTR2, 3) = "_VI" Or Right(LSTR2, 3) = "_IV" Or Right(LSTR2, 3) = "_XI" Or Right(LSTR2, 3) = "_IX" Then '2,4,6,9,11
                    A = 3
                    LSTR = Right(LSTR2, 2)
                ElseIf Right(LSTR2, 4) = "_III" Or Right(LSTR2, 4) = "_VII" Or Right(LSTR2, 4) = "_XII" Then '3,7,12
                    A = 4
                    LSTR = Right(LSTR2, 3)
                ElseIf Right(LSTR2, 5) = "_VIII" Then '8
                    A = 5
                    LSTR = Right(LSTR2, 4)
                End If

                LEXHCODE = Left(LSTR2, Len(LSTR2) - A)
                LMONTH = Get_RMN_Month(LSTR)

            Else
                If Right(TxtRec!F9, 2) = "_I" Or Right(TxtRec!F9, 2) = "_V" Or Right(TxtRec!F9, 2) = "_X" Then ' 1,5,10
                    A = 2
                    LSTR = Right(TxtRec!F9, 1)
                ElseIf Right(TxtRec!F9, 3) = "_II" Or Right(TxtRec!F9, 3) = "_VI" Or Right(TxtRec!F9, 3) = "_IV" Or Right(TxtRec!F9, 3) = "_XI" Or Right(TxtRec!F9, 3) = "_IX" Then '2,4,6,9,11
                    A = 3
                    LSTR = Right(TxtRec!F9, 2)
                ElseIf Right(TxtRec!F9, 4) = "_III" Or Right(TxtRec!F9, 4) = "_VII" Or Right(TxtRec!F9, 4) = "_XII" Then '3,7,12
                    A = 4
                    LSTR = Right(TxtRec!F9, 3)
                ElseIf Right(TxtRec!F9, 5) = "_VIII" Then '8
                    A = 5
                    LSTR = Right(TxtRec!F9, 4)
                End If

                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - A)
                LMONTH = Get_RMN_Month(LSTR)
            End If
            lyear = Year(LSCondate)
            
        ElseIf LEXHCODE = "SGXNIFTY" Then
            LSTR = Right(TxtRec!F9, 3)
            LMONTH = Get_CMX_Month(Left(LSTR, 1))
            lyear = Year(LSCondate)
        ElseIf Right(TxtRec!F9, 13) = "SILVERMINIZ22" Or Right(TxtRec!F9, 9) = "SILVERZ22" Then
            LMONTH = "DEC"
            lyear = "2022"
            If Right(TxtRec!F9, 9) = "SILVERZ22" Then
                LEXHCODE = "SILVER"
            Else
                LEXHCODE = "SILVERMINI"
            End If
        ElseIf Right(TxtRec!F9, 2) = "24" Or Right(TxtRec!F9, 2) = "23" Or Right(TxtRec!F9, 1) = "2" Then
            
            If Right(TxtRec!F9, 4) = "JAN2" Or Right(TxtRec!F9, 4) = "FEB2" Or Right(TxtRec!F9, 4) = "MAR2" Or Right(TxtRec!F9, 4) = "APR2" Or _
               Right(TxtRec!F9, 4) = "MAY2" Or Right(TxtRec!F9, 4) = "JUN2" Or Right(TxtRec!F9, 4) = "JUL2" Or Right(TxtRec!F9, 4) = "AUG2" Or _
               Right(TxtRec!F9, 4) = "SEP2" Or Right(TxtRec!F9, 4) = "OCT2" Or Right(TxtRec!F9, 4) = "NOV2" Or Right(TxtRec!F9, 4) = "DEC2" Then
                LMONTH = Left(Right(TxtRec!F9, 4), 3)
                lyear = Year(LSCondate)
                LEXHCODE = Left$(TxtRec!F9, A - 4)
            Else
                LMONTH = Left(Right(TxtRec!F9, 5), 3)
                lyear = "20" + Right(TxtRec!F9, 2)
                If LMONTH = "JAN" Or LMONTH = "FEB" Or LMONTH = "MAR" Or LMONTH = "APR" Or _
                    LMONTH = "MAY" Or LMONTH = "JUN" Or LMONTH = "JUL" Or LMONTH = "AUG" Or _
                    LMONTH = "SEP" Or LMONTH = "OCT" Or LMONTH = "NOV" Or LMONTH = "DEC" Then
                    lyear = Year(LSCondate)
                    If Left(Right(TxtRec!F9, 6), 1) = "_" Or Left(Right(TxtRec!F9, 6), 1) = "-" Then
                        LEXHCODE = Left$(TxtRec!F9, A - 6)
                    Else
                        LEXHCODE = Left$(TxtRec!F9, A - 5)
                    End If
                ElseIf UCase(Left(Right(TxtRec!F9, 6), 3)) = "INR" Then
                        LMONTH = Left(Right(TxtRec!F9, 3), 1)
                        LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 6)
                        lyear = Year(LSCondate)
                        LMONTH = Get_CMX_Month(LMONTH)
                        
                End If
            End If
        ElseIf Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "FAB" Or Right(LSTR, 3) = "MAR" Or Right(LSTR, 3) = "APR" Or _
            Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" Or _
            Right(LSTR, 3) = "SEP" Or Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then

            
            If InStr(TxtRec!F9, "-") <> 0 Or InStr(TxtRec!F9, "_") <> 0 Then
                If Left(TxtRec!F9, 3) <> "M_M" Then
                    A = InStr(TxtRec!F9, "-")
                    If A = 0 Then A = InStr(TxtRec!F9, "_")
                    LEXHCODE = Left(TxtRec!F9, A - 1)
                    LMONTH = Right(LSTR, 3)
                    
                    lyear = Year(LSCondate)
                 Else
                    LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 3)
                    LMONTH = Right(TxtRec!F9, 3)
                    lyear = Year(LSCondate)
                 End If
            Else
                If IsNumeric(Left(Right(TxtRec!F9, 5), 1)) And IsNumeric(Left(Right(TxtRec!F9, 7), 1)) And (Left(Right(TxtRec!F9, 6), 1) = "C" Or Left(Right(TxtRec!F9, 6), 1) = "P") Then
                    LSInstType = "OPT"
                    LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 6)
                    If Left(LEXHCODE, 5) = "NIFTY" Then
                        LSStrike = Mid(LEXHCODE, 6, Len(LEXHCODE) - 5)
                        LEXHCODE = "NIFTY"
                    Else
                        LSStrike = Mid(LEXHCODE, 6, Len(LEXHCODE) - 9)
                        LEXHCODE = "BANKNIFTY"
                    End If
                    lday = Left(LSTR, 2)
                    LMONTH = Right(LSTR, 3)
                    lyear = Year(LSCondate)
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                    Vdate = DateValue(LSTRCONDATE)
                    Vitemcode = LEXHCODE
                    If Left(Right(TxtRec!F9, 6), 1) = "C" Then
                        LSOptType = "CE"
                    Else
                        LSOptType = "PE"
                    End If
                Else
                    If Left(Right(TxtRec!F9, 4), 1) = " " Then
                        LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 4)
                        LMONTH = Right(LSTR, 3)
                        lyear = Year(LSCondate)
                    Else
                        LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 3)
                        LMONTH = Right(TxtRec!F9, 3)
                        lyear = Year(LSCondate)
                    End If
                    If LMONTH = "FAB" Then
                        LMONTH = "FEB"
                    End If
                End If
            End If
        Else
            LSTR = Right(TxtRec!F9, 4)
            If Right(TxtRec!F9, 1) = "2" And Left(Right(TxtRec!F9, 3), 1) <> "/" Then
                LMONTH = Left(LSTR, 3)
                LEXHCODE = Left$(TxtRec!F9, A - 4)
            ElseIf Right(TxtRec!F9, 1) = "k" Or (Right(TxtRec!F9, 1) = "1" And Left(Right(TxtRec!F9, 3), 1) <> "-") Then
                If Right(TxtRec!F9, 3) = " 31" Then
                    LMONTH = Left(Right(TxtRec!F9, 6), 3)
                    LEXHCODE = Left$(TxtRec!F9, Len(TxtRec!F9) - 7)
                Else
                    LMONTH = Left(LSTR, 3)
                    LEXHCODE = Left$(TxtRec!F9, A - 4)
                    If (LEXHCODE = "SILVERMINI" Or LEXHCODE = "GOLDMINI") Then
                        LEXHCODE = LEXHCODE + "1"
                    End If
                End If
                lyear = Year(LSCondate)
            ElseIf Right(TxtRec!F9, 1) = "m" Or Right(TxtRec!F9, 3) = "Nxm" Or Right(TxtRec!F9, 1) = "M" Or Right(TxtRec!F9, 3) = "NxM" Then

                If Left(TxtRec!F9, 6) <> "MARUTI" And (InStr(TxtRec!F9, "JAN") <> 0 Or InStr(TxtRec!F9, "FEB") <> 0 Or InStr(TxtRec!F9, "MAR") <> 0 Or InStr(TxtRec!F9, "APR") <> 0 Or _
                    InStr(TxtRec!F9, "MAY") <> 0 Or InStr(TxtRec!F9, "JUN") <> 0 Or InStr(TxtRec!F9, "JUL") <> 0 Or InStr(TxtRec!F9, "AUG") <> 0 Or _
                    InStr(TxtRec!F9, "SEP") <> 0 Or InStr(TxtRec!F9, "OCT") <> 0 Or InStr(TxtRec!F9, "NOV") <> 0 Or InStr(TxtRec!F9, "DEC") <> 0) Then
                    LSTR = Left(TxtRec!F9, Len(TxtRec!F9) - 1)
                    LMONTH = Right(LSTR, 3)
                    LEXHCODE = Left(LSTR, Len(LSTR) - 3)
                    lyear = Year(LSCondate)
                    lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                    LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                Else
                    If Right(TxtRec!F9, 3) = "Nxm" Or Right(TxtRec!F9, 3) = "NxM" Then
                        If Right(TxtRec!F9, 4) = "-NxM" Then
                            LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 4)
                        Else
                            LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 3)
                        End If
                        LMonthType = "N":
                        LMONTH = month(LSCondate)

                        lyear = Year(LSCondate)
                        lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                        LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                    Else
                        If Right(TxtRec!F9, 2) = "-M" Then
                            LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 2)
                        Else
                            LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 1)
                        End If
                        LMonthType = "C":
                        LMONTH = month(LSCondate)
                        lyear = Year(LSCondate)
                        lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                        LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                    End If
                End If
            ElseIf Right(TxtRec!F9, 2) = "-G" Or Right(TxtRec!F9, 4) = "-NxG" Or Right(TxtRec!F9, 2) = "-K" Or Right(TxtRec!F9, 4) = "-NxK" Then
                If Right(TxtRec!F9, 4) = "-NxG" Or Right(TxtRec!F9, 4) = "-NxK" Then
                    LSTR = Left(TxtRec!F9, Len(TxtRec!F9) - 4)
                Else
                    LSTR = Left(TxtRec!F9, Len(TxtRec!F9) - 2)
                End If
                A = Len(LSTR)
                If Right(LSTR, 4) = "AUGL" Then
                    LMONTH = "AUG"
                    LEXHCODE = Left$(LSTR, A - 4)
                ElseIf Right(LSTR, 4) = "SEPL" Then
                    LMONTH = "SEP"
                    LEXHCODE = Left$(LSTR, A - 4)
                ElseIf Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "MAR" Or _
                    Right(LSTR, 3) = "APR" Or Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or _
                    Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" Or Right(LSTR, 3) = "SEP" Or _
                    Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then
                
                    LMONTH = Right(LSTR, 3)
                    LEXHCODE = Left$(LSTR, A - 3)
                Else
                    If Right(TxtRec!F9, 4) = "-NxG" Or Right(TxtRec!F9, 4) = "-NxK" Then
                        LMonthType = "N":
                        LMONTH = month(LSCondate) + 1
                        LEXHCODE = LSTR
                    Else
                        LMonthType = "C":
                        LMONTH = month(LSCondate)
                        LEXHCODE = LSTR
                    End If
                End If
                lyear = Year(LSCondate)
            ElseIf LSTR = "SEPP" Or LSTR = "JANN" Or LSTR = "MARR" Or LSTR = "NOVV" Or LSTR = "MAYY" Or LSTR = "OCT" Then
                LMONTH = Left(LSTR, 3)
                LEXHCODE = Left$(TxtRec!F9, A - 4)
            ElseIf LSTR = "JUNE" Or LSTR = "JULY" Then
                LMONTH = Left(LSTR, 3)
                LEXHCODE = Left$(TxtRec!F9, A - 4)
                lyear = Year(LSCondate)
        Else
            If Right(TxtRec!F9, 3) <> "SEP" And Right(TxtRec!F9, 3) <> "DEC" And (Right(TxtRec!F9, 1) = "C" Or Right(TxtRec!F9, 1) = "P") Then
                Call OPTION_ITEM(TxtRec!F9, Vexcelcolval)
                LSInstType = "OPT"
            ElseIf InStr(TxtRec!F9, "JAN") <> 0 Or InStr(TxtRec!F9, "FEB") <> 0 Or InStr(TxtRec!F9, "MAR") <> 0 Or _
                    InStr(TxtRec!F9, "APR") <> 0 Or InStr(TxtRec!F9, "MAY") <> 0 Or InStr(TxtRec!F9, "JUN") <> 0 Or _
                    InStr(TxtRec!F9, "JUL") <> 0 Or InStr(TxtRec!F9, "AUG") <> 0 Or InStr(TxtRec!F9, "SEP") <> 0 Or _
                    InStr(TxtRec!F9, "OCT") <> 0 Or InStr(TxtRec!F9, "NOV") <> 0 Or InStr(TxtRec!F9, "DEC") <> 0 Then
                    
                        LSTR = Right(TxtRec!F9, 2)
                        If IsNumeric(LSTR) Then
                            If InStr(TxtRec!F9, "-") <> 0 Then
                                A = InStr(TxtRec!F9, "-")
                                LEXHCODE = Left(TxtRec!F9, A - 1)
                                LMONTH = Mid(TxtRec!F9, A + 1, 3)
                                lday = Right(TxtRec!F9, 2)
                                lyear = Year(LSCondate)
                               
                                LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                                LSMaturity = DateValue(LSTRCONDATE)
                            ElseIf InStr(TxtRec!F9, "/") <> 0 Then
                                A = InStr(TxtRec!F9, "/")
                                LEXHCODE = Left(TxtRec!F9, A - 1)
                                LMONTH = Right(TxtRec!F9, 2)
                                lyear = Year(LSCondate)
                            End If
                       ElseIf Right(TxtRec!F9, 1) = "Q" Or Right(TxtRec!F9, 1) = "_" Or (Right(TxtRec!F9, 1) = "L" And Right(TxtRec!F9, 3) <> "JUL") Then
                                LMONTH = Left(Right(TxtRec!F9, 4), 3)
                                If (Right(TxtRec!F9, 1) = "L" And Right(TxtRec!F9, 3) <> "JUL") Then
                                    LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 5)
                                Else
                                    LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 4)
                                 End If
                                
                                
                                lyear = Year(LSCondate)
                                lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                               
                                LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                                LSMaturity = DateValue(LSTRCONDATE)
                       ElseIf Right(TxtRec!F9, 4) = "-INR" Then
                                A = InStr(TxtRec!F9, "-INR")
                                LMONTH = Mid(TxtRec!F9, A - 3, 3)
                                LEXHCODE = Left(TxtRec!F9, Len(TxtRec!F9) - 7)
                                
                                lyear = Year(LSCondate)
                                lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                               
                                LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                                LSMaturity = DateValue(LSTRCONDATE)
                        ElseIf Right(TxtRec!F9, 2) = "CE" Or Right(TxtRec!F9, 2) = "PE" Then
                            LSInstType = "OPT"
                            A = InStr(TxtRec!F9, "22")
                            If A = 0 Then
                                A = InStr(TxtRec!F9, "23")
                                lyear = "2023"
                            Else
                                lyear = "2022"
                            End If
                            LEXHCODE = Left(TxtRec!F9, A - 1)
                            lyear = Year(LSCondate)
                            LMONTH = Mid(TxtRec!F9, A + 2, 3)
                            MLEN = Len(TxtRec!F9) - (A + 6)
                            LSStrike = Mid(TxtRec!F9, A + 5, MLEN)
                            lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                            LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
                            Vdate = DateValue(LSTRCONDATE)
                            Vitemcode = LEXHCODE
                            If Right(TxtRec!F9, 2) = "CE" Then
                                LSOptType = "CE"
                            Else
                                LSOptType = "PE"
                            End If
                            LMonthType = "M"
                        Else
                            LEXHCODE = Mid(LSTR, 1, A - 3): LMonthType = "M":
                            LMONTH = Right(LSTR, 3): lyear = Year(LSCondate)
                            lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                            LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                            LSMaturity = DateValue(LSTRCONDATE)
                       End If
            
            Else
                If Right(TxtRec!F9, 1) = "1" Then
                    LSTR = Left(Right(TxtRec!F9, 4), 3)
                Else
                    LSTR = Right(TxtRec!F9, 3)
                End If
                If LSTR = "-AN" Or LSTR = "xAN" Then
                    A = Len(TxtRec!F9)
                    LSTR = Left(TxtRec!F9, A - 3)
                    If Right(LSTR, 3) = "JAN" Or Right(LSTR, 3) = "FEB" Or Right(LSTR, 3) = "MAR" Or Right(LSTR, 3) = "APR" _
                        Or Right(LSTR, 3) = "MAY" Or Right(LSTR, 3) = "JUN" Or Right(LSTR, 3) = "JUL" Or Right(LSTR, 3) = "AUG" _
                        Or Right(LSTR, 3) = "SEP" Or Right(LSTR, 3) = "OCT" Or Right(LSTR, 3) = "NOV" Or Right(LSTR, 3) = "DEC" Then
                        A = Len(LSTR)
                        LEXHCODE = Mid(LSTR, 1, A - 3): LMonthType = "M":
                        LMONTH = Right(LSTR, 3): lyear = Year(LSCondate)
                        lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                        LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                        LSMaturity = DateValue(LSTRCONDATE):
                    Else
                        If Left(TxtRec!F9, 3) = "SGX" Then  '>>> in reference to discuss with Umesh on date 20 NOV 2021 11:15AM
                            If Right(UCase(TxtRec!F9), 3) = "-AN" Then
                                LEXHCODE = Left(TxtRec!F9, 3)
                                LMonthType = "C":
                                LMONTH = month(LSCondate): lyear = Year(LSCondate)
                        ElseIf Right(UCase(TxtRec!F9), 5) = "-NxAN" Or Right(UCase(TxtRec!F9), 5) = "-NXAN" Then
                                LEXHCODE = Mid(TxtRec!F9, 1, A - 5):
                                If month(LSCondate) = 12 Then
                                    LMONTH = 1
                                    lyear = Year(LSCondate) + 1
                                Else
                                    LMONTH = month(LSCondate) + 1
                                    lyear = Year(LSCondate)
                                End If
                                LSTR = UCase(Left(MonthName(LMONTH), 3))
                        End If
                                
                                lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                                LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear:
                                LSMaturity = DateValue(LSTRCONDATE):
                            Else
                            
                                If Right(TxtRec!F9, 4) = "NxAN" Then
                                    LEXHCODE = Mid(TxtRec!F9, 1, A - 5): LMonthType = "N":
                                    LMONTH = month(LSCondate): lyear = Year(LSCondate)
                                    lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                                Else
                                    LEXHCODE = Mid(TxtRec!F9, 1, A - 3): LMonthType = "C":
                                    LMONTH = month(LSCondate): lyear = Year(LSCondate)
                                    lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
                                End If
                            End If
                        End If

                    ElseIf LSTR = "INR" Then
                        LMONTH = Right(LEXHCODE, 3)
                        If Left$(Right(TxtRec!F9, 4), 1) = "_" Then
                            LEXHCODE = Left$(TxtRec!F9, A - 4)
                        Else
                            LEXHCODE = "BTC"
                        End If
                    Else
                        If InStr(TxtRec!F9, "/") = 0 Then
                            If Right(TxtRec!F9, 1) = "Q" Then
                                LSTR = Left(TxtRec!F9, Len(TxtRec!F9) - 1)
                                LMONTH = Right(LSTR, 3)
                                If Left$(Right(LSTR, 4), 1) = "_" Then
                                    LEXHCODE = Left$(TxtRec!F9, A - 4)
                                Else
                                    LEXHCODE = Left$(LSTR, Len(LSTR) - 3)
                                End If
                            ElseIf InStr(TxtRec!F9, "-") <> 0 Then
                                LMONTH = Right(TxtRec!F9, 3)
                                LEXHCODE = Left$(TxtRec!F9, A - 4)
                            Else
                                If TxtRec!F9 = "AMAZON" Then
                                    LMONTH = month(GFinEnd)
                                    lyear = Year(GFinEnd)
                                    LEXHCODE = TxtRec!F9
                                Else
                                    If Right(TxtRec!F9, 1) = "1" Then
                                        LMONTH = Left(Right(TxtRec!F9, 4), 3)
                                    Else
                                        LMONTH = Right(TxtRec!F9, 3)
                                    End If
                                    If Left$(Right(TxtRec!F9, 4), 1) = "_" Then
                                        LEXHCODE = Left$(TxtRec!F9, A - 4)
                                    Else
                                        If Right(TxtRec!F9, 1) = "1" Then
                                            LEXHCODE = Left$(TxtRec!F9, A - 4)
                                        Else
                                            LEXHCODE = Left$(TxtRec!F9, A - 3)
                                        End If
                                    End If
                                End If
                           End If
                        Else
                            LMONTH = Right(TxtRec!F9, 2)
                            If Left$(Right(TxtRec!F9, 4), 1) = "_" Then
                                LEXHCODE = Left$(TxtRec!F9, A - 4)
                            Else
                                LEXHCODE = Left$(TxtRec!F9, A - 3)
                            End If
                        
                        End If
                    End If
                End If
                lyear = Year(LSCondate)
            End If
        End If
            '-----------
    End If
        
    If Not IsDate(LSTRCONDATE) Then
        lday = GET_DAYS(LMONTH, str(lyear), DateValue(LSCondate))
        If month(LSCondate) > Val(LMONTH) Then
            lyear = lyear + 1
        End If

        
        If LMONTH = "02" Or LMONTH = "2" Then
            If (lyear) Mod 4 <> 0 Then '>>>not leep year
                If lday > 28 Then
                    lday = "28"
                End If
            End If
        End If
        
        LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear & "")
                    
        LSTRCONDATE = lday & "/" & LMONTH & "/" & lyear
        LSTRCONDATE = Replace(LSTRCONDATE, "//", "/")
    End If
    LSMaturity = DateValue(LSTRCONDATE)
    If LSOptType = "CE" Or LSOptType = "PE" Then
        LSMaturity = Vdate
        LEXHCODE = Vitemcode
    End If
    If month(LSMaturity) < month(LSCondate) And LSMaturity <> GFinEnd Then
        lyear = (Year(LSCondate) + 1)
        LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear
        LSTRCONDATE = Replace(LSTRCONDATE, "//", "/")
        LSMaturity = DateValue(LSTRCONDATE)
        LMONTH = month(LSMaturity)
    End If
    
    If Right(TxtRec!F10, 1) = "K" Then
        LBQty = Val(Left(TxtRec!F10, Len(TxtRec!F10) - 1)) * 1000
    Else
        LBQty = Val(TxtRec!F10)
    End If
    
    LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)):
    LSRate = LBRate
    lsparty = LBrokerCode
End Sub
Public Function getdate(Vmonth As String, Vday As Integer) As String

Dim Vdate As String

    If Vmonth = "JAN" Or Vmonth = "JA" Then
        Vdate = CStr(Vday) + "/01/" + CStr(Year(Date))
    ElseIf Vmonth = "FEB" Or Vmonth = "FE" Then
        Vdate = CStr(Vday) + "/02/" + CStr(Year(Date))
    ElseIf Vmonth = "MAR" Or Vmonth = "MA" Then
        Vdate = CStr(Vday) + "/03/" + CStr(Year(Date))
    ElseIf Vmonth = "APR" Or Vmonth = "AP" Then
        Vdate = CStr(Vday) + "/04/" + CStr(Year(Date))
    ElseIf Vmonth = "MAY" Or Vmonth = "MY" Then
        Vdate = CStr(Vday) + "/05/" + CStr(Year(Date))
    ElseIf Vmonth = "JUN" Or (Vmonth = "JN" And month(Now) = 6 And Day(Now) >= 1 And Day(Now) <= 27) Then
        Vdate = CStr(Vday) + "/06/" + CStr(Year(Date))
    ElseIf Vmonth = "JUL" Or (Vmonth = "JU" And month(Now) = 6 And Day(Now) > 27) Or (Vmonth = "JU" And month(Now) = 7) Then
        Vdate = CStr(Vday) + "/07/" + CStr(Year(Date))
    ElseIf Vmonth = "AUG" Or Vmonth = "AU" Then
        Vdate = CStr(Vday) + "/08/" + CStr(Year(Date))
    ElseIf Vmonth = "SEP" Or Vmonth = "SE" Then
        Vdate = CStr(Vday) + "/09/" + CStr(Year(Date))
    ElseIf Vmonth = "OCT" Or Vmonth = "OC" Then
        Vdate = CStr(Vday) + "/10/" + CStr(Year(Date))
    ElseIf Vmonth = "NOV" Or Vmonth = "NO" Then
        Vdate = CStr(Vday) + "/11/" + CStr(Year(Date))
    ElseIf Vmonth = "DEC" Or Vmonth = "DE" Then
        Vdate = CStr(Vday) + "/12/" + CStr(Year(Date))
    End If
    
    getdate = Vdate
    
End Function

Sub GetItem_Sauda_Detail(lexceltype As Integer, Optional LSExCode1 As String)

Dim TRec As ADODB.Recordset
Flag_GONext = False
            LLOT = 1
            If lexceltype = 41 Or lexceltype = 71 Then
                LSExCode = vbNullString
                Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
            ElseIf lexceltype = 45 Or lexceltype = 40 Or lexceltype = 47 Or lexceltype = 50 Then
                Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 3)
            ElseIf lexceltype = 60 Or lexceltype = 61 Or lexceltype = 62 Then
                Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
            Else
                Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 2)
            End If
            If LenB(LSItemCode) < 1 Then
                ImportIssues (LEXHCODE + " Script Missing")
                Flag_GONext = True: GoTo EFlag_Next
            End If
            If LMonthType = "M" Then
                Set TRec = Nothing: Set TRec = New ADODB.Recordset
                If LSInstType = "FUT" Or LSExCode <> "NSE" Then
                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                Else
                    mysql = "SELECT SAUDACODE ,SAUDAID,MATURITY FROM SAUDAMAST WHERE ITEMID =" & LSItemid & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE = " & LSStrike & ""
                End If
                TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not TRec.EOF Then
                    LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                Else
                    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                    If LSInstType <> "FUT" Then
                        If LSExCode = "NSE" Then
                             mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                        Else
                            mysql = mysql & " AND INSTTYPE='OPT' AND MONTH(MATURITY)=" & month(LSMaturity) & " AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                        End If
                        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                    Else
                        mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                    End If
                    Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                    If Not TRec.EOF Then
                        LSMaturity = TRec!MATURITY: LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                    Else
                        If LSInstType = "FUT" Then
                            LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                LSSaudaCode = LSExCode & " " & LSSaudaCode
                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                    LMsgBox = "Please Check Entry for " & LSSaudaCode & "": ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                                End If
                            End If
                        Else
                            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & "": ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                        End If
                        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                    End If
                    LSSaudaID = Get_SaudaID(LSSaudaCode)
                End If
            Else
                If LMonthType = "C" Then
                    mysql = "SELECT TOP 1 SAUDACODE,MATURITY,SAUDAID FROM SAUDAMAST WHERE INSTTYPE ='FUT'  AND ITEMID=" & LSItemid & " AND MATURITY>='" & Format(LSCondate, "YYYY/MM/DD") & "' ORDER BY MATURITY ": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If TRec.EOF Then
                        mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'  AND INSTTYPE='FUT' AND MATURITY>='" & Format(LSCondate, "YYYY/MM/DD") & "' ORDER BY MATURITY ": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If TRec.EOF Then
                            If LSInstType = "FUT" Then
                                LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                    LSSaudaCode = LSExCode & " " & LSSaudaCode
                                    If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                        LMsgBox = "Please Check Entry for " & LSSaudaCode & "": ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                                    End If
                                End If
                            Else
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & "": ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                            End If
                        Else
                            LSMaturity = TRec!MATURITY: LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                        End If
                    Else
                        LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                    End If
                Else
                    mysql = "SELECT MATURITY FROM SCRIPTMASTER  WHERE INSTTYPE ='FUT'  AND  EX_SYMBOL= '" & LSEx_Symbol & "' AND EXCODE ='" & LSExCode & "' AND MATURITY>=(Convert(datetime, '" & Format((LSCondate), "YYYY/MM/DD") & "')-5) ORDER BY MATURITY ": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If TRec.EOF Then
                        mysql = "SELECT SAUDACODE,SAUDAID,MATURITY FROM SAUDAMAST WHERE COMPCODE =" & GCompCode & " AND INSTTYPE ='FUT'  AND ITEMCODE ='" & LSItemCode & "' AND EXCODE ='" & LSExCode & "' AND MATURITY>=(Convert(datetime, '" & Format((LSCondate), "YYYY/MM/DD") & "')-5) ORDER BY MATURITY ": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If Not TRec.EOF Then
                            TRec.MoveNext
                            If Not TRec.EOF Then
                                LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY
                            Else
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " Next Month Maturity " & LSOptType & " " & LSStrike & "": ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                            End If
                        Else
                            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & "": ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                        End If
                    Else
                        TRec.MoveNext
                        If TRec.EOF Then
                            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity: ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                        Else
                            LSMaturity = TRec!MATURITY: LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                        End If
                    End If
                End If
                If LenB(LSSaudaCode) < 1 Then
                    LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity: ImportIssues (LMsgBox): Flag_GONext = True: GoTo EFlag_Next
                End If
                LSSaudaID = Get_SaudaID(LSSaudaCode)
            End If
            
EFlag_Next:


End Sub
Sub FILE_READ(LTxtPath As String, lqtylot As Integer)
On Error GoTo err1
Dim TempRec1 As ADODB.Recordset
Dim LMAPVAL As String
        
        Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset:
        TxtRec.Open "Select * from " & LTxtPath & "", Jcnn, adOpenStatic, adLockReadOnly, adCmdText
        
        If Not TxtRec.EOF Then
            TxtRec.MoveFirst
            TxtRec.MoveNext
            If UCase(Trim(TxtRec!F4)) = "POSITION" Then
                Set TempRec1 = Nothing
                Set TempRec1 = TxtRec.Clone
                TempRec1.MoveFirst
                TempRec1.MoveNext

                Set TxtRec = Nothing
                Set TxtRec = New ADODB.Recordset
                TxtRec.Fields.Append "f1", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f2", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f3", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f4", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f5", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f6", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f7", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f8", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f9", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f10", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f11", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f12", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f13", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f14", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f15", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f16", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f17", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f18", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f19", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f20", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f21", adVarChar, 100, adFldIsNullable
                TxtRec.Fields.Append "f22", adVarChar, 100, adFldIsNullable
                TxtRec.Open , , adOpenKeyset, adLockOptimistic

                TempRec1.MoveNext
                While Not TempRec1.EOF
                    TxtRec.AddNew
                    TxtRec.Fields(0).Value = TempRec1!F1
                    TxtRec.Fields(1).Value = TempRec1!F2
                    TxtRec.Fields(2).Value = TempRec1!f3
                    TxtRec.Fields(3).Value = TempRec1!F5
                    TxtRec.Fields(4).Value = TempRec1!f6
                    TxtRec.Fields(5).Value = TempRec1!F7
                    TxtRec.Fields(6).Value = TempRec1!F8
                    
                    TxtRec.Fields(7).Value = TempRec1!F9


                    If TempRec1!F21 = "USD" Or UCase(Right(LMAPVAL, 2)) = "-K" Or UCase(Right(LMAPVAL, 2)) = "-Q" Then
                        TxtRec.Fields(8).Value = TempRec1!F10
                    Else
                        TxtRec.Fields(8).Value = FILE_SYMBOL_MAPPING((TempRec1!F10 & ""), Left$((TempRec1!F7 & ""), 10), lqtylot)
                    End If
                    
                    TxtRec.Fields(9).Value = TempRec1!f11
                                        
                    TxtRec.Fields(10).Value = TempRec1!f12
                    TxtRec.Fields(11).Value = TempRec1!F13
                    TxtRec.Fields(12).Value = TempRec1!F14
                    TxtRec.Fields(13).Value = TempRec1!F15
                    TxtRec.Fields(14).Value = TempRec1!f16
                    TxtRec.Fields(15).Value = TempRec1!F17
                    TxtRec.Fields(16).Value = TempRec1!F18
                    TxtRec.Fields(17).Value = TempRec1!f19
                    TxtRec.Fields(18).Value = TempRec1!F20
                    TxtRec.Fields(19).Value = TempRec1!F21
                    TxtRec.Fields(20).Value = TempRec1!F21
                    TxtRec.Update
                    TempRec1.MoveNext
                Wend
            End If
        End If
err1:
If err.Number <> 0 Then
    MsgBox err.Description
End If


End Sub
Function FILE_SYMBOL_MAPPING(LMAPVAL As String, ldate As String, lqtylot As Integer) As String
On Error GoTo err1


    Dim MRec As ADODB.Recordset
    Dim LDT As Date
    Dim LYR As Integer
    Dim LDY As Integer
    Dim LTEMP As String
    
    FILE_SYMBOL_MAPPING = LMAPVAL
    If FILE_SYMBOL_MAPPING <> "" Then
        LDT = 0: LYR = 0
        If ldate <> "" Then
            LDT = DateValue(Right(ldate, 2) & "/" & Mid(ldate, 6, 2) & "/" & Left(ldate, 4))
            LYR = Year(LDT)
        End If

        '>>> REMOVE LAST CHAR (FILEMAPPING.TYPE=R1) IF "K" OR "Q"
        mysql = "SELECT ISNULL(MAPTO,'') AS 'MAPTO',VALUE FROM FILEMAPPING WITH(NOLOCK) WHERE TYPE='R1' order by id" 'ISNULL(MAPTO,'') =''
        Set MRec = Nothing: Set MRec = New ADODB.Recordset: MRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not MRec.EOF
            If Not (lqtylot = 1 And MRec!Value = "Q") Then
                If UCase(Right(LMAPVAL, 1)) = UCase(MRec!Value) Then
                    FILE_SYMBOL_MAPPING = Trim(Mid(LMAPVAL, 1, Len(LMAPVAL) - 1))
                    If UCase(Right(FILE_SYMBOL_MAPPING, 1)) = "-" Then
                        FILE_SYMBOL_MAPPING = Trim(Mid(FILE_SYMBOL_MAPPING, 1, Len(FILE_SYMBOL_MAPPING) - 1))
                    End If
                    Exit Do
                End If
            End If
            MRec.MoveNext
        Loop
        
        LMAPVAL = FILE_SYMBOL_MAPPING
        
        '>>> verify symbol format like SYMBOL-DDMMM or SYMBOL-MMMDD
        mysql = "SELECT ISNULL(MAPTO,'') AS 'MAPTO',VALUE FROM FILEMAPPING WITH(NOLOCK) WHERE TYPE='R6' order by id" ' WHERE VALUE LIKE '" & LMAPVAL & "'"
        Set MRec = Nothing: Set MRec = New ADODB.Recordset: MRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not MRec.EOF Then
            If Left(Right(LMAPVAL, 6), 1) = "-" Then
                '>> get symbol
                LTEMP = Left(LMAPVAL, InStr(1, LMAPVAL, "-") - 1)
                
                '>>> get remaining text (DDMMM OR MMMDD)
                LMAPVAL = Replace(LMAPVAL, LTEMP & "-", "")
                                                
                FILE_SYMBOL_MAPPING = LTEMP
                
                If IsNumeric(Left(LMAPVAL, 2)) Then '>>> DDMMM
                    LDY = Left(LMAPVAL, 2)
                    LTEMP = Replace(LMAPVAL, CStr(Left(LMAPVAL, 2)), "")
                ElseIf IsNumeric(Right(LMAPVAL, 2)) Then '>>> MMMDD
                    LDY = Right(LMAPVAL, 2)
                    LTEMP = Replace(LMAPVAL, CStr(Right(LMAPVAL, 2)), "")
                End If
                
                mysql = "SELECT ISNULL(MAPTO,'') AS 'MAPTO' FROM FILEMAPPING WITH(NOLOCK) WHERE TYPE='R3' AND VALUE = '" & LTEMP & "'"
                Set MRec = Nothing: Set MRec = New ADODB.Recordset: MRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                If Not MRec.EOF Then
                    '>>> FILE_SYMBOL_MAPPING = SYMBOL ^ DD ^ MM ^ YYYY
                    FILE_SYMBOL_MAPPING = FILE_SYMBOL_MAPPING & "^" & CStr(LDY) & "^" & MRec!mapto & "^" & CStr(LYR)
                    LMAPVAL = ""
                End If
            End If
        End If
                
        mysql = "SELECT ISNULL(MAPTO,'') AS 'MAPTO',VALUE FROM FILEMAPPING WITH(NOLOCK) WHERE TYPE='R3' order by id" ' WHERE VALUE LIKE '" & LMAPVAL & "'"
        Set MRec = Nothing: Set MRec = New ADODB.Recordset: MRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        Do While Not MRec.EOF
            If UCase(Right(LMAPVAL, 3)) = UCase(MRec!Value) Then
                If month(LDT) > MRec!mapto Then
                    LYR = LYR + 1
                End If
                LDY = Day(DateSerial(LYR, MRec!mapto + 1, 1) - 1)
            
                FILE_SYMBOL_MAPPING = Mid(LMAPVAL, 1, Len(LMAPVAL) - 3)
                
                If Right(FILE_SYMBOL_MAPPING, 1) = "-" Then
                    FILE_SYMBOL_MAPPING = Left(FILE_SYMBOL_MAPPING, Len(FILE_SYMBOL_MAPPING) - 1)
                End If
                
                FILE_SYMBOL_MAPPING = FILE_SYMBOL_MAPPING & "^" & CStr(LDY) & "^" & MRec!mapto & "^" & CStr(LYR)
                
                Exit Do
            ElseIf InStr(1, LMAPVAL, "/") > 0 Then
                LTEMP = Right(LMAPVAL, Len(LMAPVAL) - InStr(1, LMAPVAL, "/"))
                If month(LDT) > Val(LTEMP) Then
                    LYR = LYR + 1
                End If
                
                LDY = Day(DateSerial(LYR, MRec!mapto + 1, 1) - 1)
                
                FILE_SYMBOL_MAPPING = Mid(LMAPVAL, 1, InStr(1, LMAPVAL, "/") - 1) & "^" & CStr(LDY) & "^" & CStr(LTEMP) & "^" & CStr(LYR)
                
                Exit Do
            End If
            MRec.MoveNext
        Loop
    End If
    
    'If InStr(1, FILE_SYMBOL_MAPPING, "^") <= 0 Then
     '   LDY = Day(LDT)
     '   LTEMP = month(LDT)
     '   LYR = Year(LDT)
     '   FILE_SYMBOL_MAPPING = LMAPVAL & "^" & CStr(LDY) & "^" & CStr(LTEMP) & "^" & CStr(LYR)
   ' End If
    
    If InStr(1, FILE_SYMBOL_MAPPING, "^31^02") > 0 Or InStr(1, FILE_SYMBOL_MAPPING, "^30^02") > 0 Then
        FILE_SYMBOL_MAPPING = Replace(Replace(FILE_SYMBOL_MAPPING, "^31^02^", "^28^02^"), "30^02^", "^28^02^")
    End If
        
err1: If err.Number <> 0 Then
        FILE_SYMBOL_MAPPING = LMAPVAL
End If
End Function

Sub Save_AllTrade_Excel38(lexceltype As Integer, LClientCode As String, Optional lqtylot As Integer)
Dim LIFLAG As Boolean:          Dim LSQty As Double:          Dim ldate As Date: Dim ltradedt As Date:          Dim LOverwrite As Boolean:      Dim TxtPath As String:          Dim LFileName As String: Dim MCount As Long:            Dim LConType As String:         Dim LSConSno As Long:           Dim LQTY As Double:
Dim LRATE As Double:            Dim LContime As String:: Dim StrDateLen As Integer: Dim LClient As String:         Dim mparty As String:           Dim mbparty As String:          Dim MSPARTY As String:    Dim LLOT As Double:             Dim LUserId As String:
Dim LSItemName As String:       Dim LFieldName As String:      Dim fld As ADODB.Field:         Dim LCMONTH As String
Dim LMFLPath As String:         Dim B As Integer:              Dim LStrMonth As String:  Dim lday As Integer:            Dim LAcExCode As String:        Dim C As Integer
Dim LMXDate As Date:            Dim LSettleRate As Double:     Dim Vday As Integer:            Dim Vmonth As String: Dim Vrate As Double:           Dim Vlastchar As String:       Dim VYear As String:
Dim TRec As ADODB.Recordset:
Dim TempRec1 As ADODB.Recordset
Dim msexcode As String

On Error GoTo err1
Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset:
Call GET_JCnn("\" & LFolderName & "\;"): MSPARTY = LBrokerCode

Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
    LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
End If
Set LFileSystemObject = Nothing: Cnn.BeginTrans:   CNNERR = True:
For ltradedt = vcDTP1.Value To vcDTP2.Value
    LNoTrd = 0:
    
    TxtPath = CStr(Left$(ltradedt, 2)) & CStr(Mid(ltradedt, 4, 2)) & CStr(Year(ltradedt)) & ".CSV":
    LFileName = App.Path & "\" & LFolderName & "\" & TxtPath
    
    If Not FileExist(LFileName) Then
        LMsgBox = LFileName & "  file not found" ', vbCritical
        ImportIssues (LMsgBox)
    Else

        Call FILE_READ(TxtPath, lqtylot)

        FlagDataTrf = True: CNNERR = True
        TxtRec.MoveFirst: LSCondate = DateValue(ltradedt): ldate = LSCondate
        LNoTrd = 0:  MCount = Get_Max_ConNo(CDate(LSCondate), 0)
        While Not TxtRec.EOF
            lbparty = vbNullString:       lsparty = vbNullString:       LSItemName = vbNullString:    LEXHCODE = vbNullString:                    LOrdNo = vbNullString:        LUserId = vbNullString:       LContime = Time:              LSInstType = "FUT"
            LMONTH = "": lyear = "": LSMaturity = "01/01/1900"
            LOrdTime = vbNullString:      LSOptType = vbNullString:     LSStrike = 0:                 LLOT = 0:                    LBQty = 0:                    LSQty = 0:                    LBRate = 0:                   LSRate = 0
            LSSaudaID = 0:                LSItemid = 0: LSEx_Symbol = vbNullString:                    LMonthType = "M"
            Vexcelcolval = "":
            Vitemcode = "":                    Vday = 0:                    Vmonth = "":                    Vrate = 0:                    Vlastchar = "":                    Vdate = "01/01/1900"
            msexcode = "":
            If IsNull(TxtRec!F1) Then GoTo EFlag_Next
            If TxtRec.Fields.Count > 20 Then
                If TxtRec.Fields.Count > 21 Then
                    If (TxtRec!f22 = "[rollover close]" Or TxtRec!f22 = "[rollover open]") Then
                        GoTo EFlag_Next
                    End If
                End If
                If (Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s")) Or (IsNull(TxtRec!F7) Or (TxtRec!F21 = "[rollover close]" Or TxtRec!F14 = "Rollover" Or TxtRec!F21 = "[rollover open]")) Then
                    GoTo EFlag_Next
                Else
                    Call EXCEL_38(LClientCode)
                End If
            Else
                If (Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s")) Or (IsNull(TxtRec!F7)) Then
                    GoTo EFlag_Next
                Else
                    Call EXCEL_38(LClientCode)
                End If
            End If

            If LenB(LEXHCODE) < 1 Then
                LMsgBox = "Script Missing " & LEXHCODE: ImportIssues (LMsgBox)
                GoTo EFlag_Next
            End If
            'Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
            Call GetItem_Sauda_Detail(lexceltype, LSExCode)
            If Flag_GONext Then
                Flag_GONext = False
                'LMsgBox = "Something Weired ": ImportIssues (LMsgBox)
                GoTo EFlag_Next
            End If

            If LenB(LSSaudaCode) < 1 Then
                LMsgBox = "Contract Missing " & LSSaudaCode: ImportIssues (LMsgBox)
                GoTo EFlag_Next
            End If
            If LSCondate > LSMaturity Then
                LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired ": ImportIssues (LMsgBox)
            End If

             If LBQty <> 0 Then
                LLOT = Get_LotSize(LSItemid, LSSaudaID, LSEXID)
                If LSInstType = "OPT" Or (Right(TxtRec!F9, 1) = "L" And Right(TxtRec!F9, 4) <> "JULL" And LSExCode = "NSE") Or (Right(TxtRec!F9, 5) = "-JULL") Or (lqtylot = 1 And Right(TxtRec!F9, 1) <> "Q") Then
                    mysql = "SELECT REFLOT FROM SAUDAMAST WHERE SAUDAID=" & LSSaudaID & "": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                        LBQty = LBQty * TRec!REFLOT
                    End If
                End If
            End If
            mbparty = Get_ACCT_EX(LSEXID, lbparty)
            ''
            If LenB(mbparty) < 1 Then
                LPartyName = Replace(LPartyName, "'", "")
                If LNEWPARTY = "Y" Then
                    mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                Else
                    GoTo EFlag_Next
                End If
                LMsgBox = "New Party " & LPartyName
                ImportIssues (LMsgBox)
                If LenB(mbparty) > 1 Then
                    mysql = "UPDATE ACCOUNTM SET PTYHEAD =2 WHERE COMPCODE =" & GCompCode & " AND AC_CODE ='" & mbparty & "'": Cnn.Execute mysql
                Else
                    GoTo EFlag_Next
                End If
            End If
            
            MSPARTY = lsparty: mysql = "SELECT BROKER FROM EXBROKCLIENT WHERE COMPCODE =" & GCompCode & " AND CLIENT ='" & mbparty & "'": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
            If Not TRec.EOF Then MSPARTY = TRec!BROKER
                
            If LenB(MSPARTY) < 1 Then
                Call Get_ExDetail(LSExCode): MSPARTY = LExCont
            End If
                
            If LenB(mbparty) < 1 Then
                LMsgBox = " Client does Not Exist " & lbparty & "": ImportIssues (LMsgBox): GoTo EFlag_Next
            End If
                
            If LenB(MSPARTY) < 1 Then
                LMsgBox = " Broker does Not Exist " & lsparty & "": ImportIssues (LMsgBox): GoTo EFlag_Next
            End If
                
            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'": Cnn.Execute mysql
            MCount = Get_Max_ConNo(CDate(LSCondate), 0): MCount = MCount + 1:
                
            If InStr(LBillExId, str(LSEXID)) = 0 Then
                If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
            LNoTrd = LNoTrd + 1: GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
            DoEvents: LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
            Call Add_To_Ctr_D2(LSPtyContype, mbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)

EFlag_Next:
            TxtRec.MoveNext
        Wend
        LMsgBox = " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
        ImportIssues (LMsgBox)

        'Frame8.Visible = True
        'List1.Visible = True
        'MsgBox " No Of Trade:  " & LNoTrd & " Imported From Folder " & LFolderName & ""
    End If
  Next
    Cnn.CommitTrans:    CNNERR = False:    Exit Sub
err1:
    MsgBox err.Description, vbCritical, "Error Number : " & err.Number

    If CNNERR = True Then
        Cnn.RollbackTrans: CNNERR = False
    End If
End Sub

Sub Excel_109_insert(MCount As Long, LContime As String, lexceltype As Integer, lminbilldate As Date)

On Error GoTo err1
Dim LStrMonth As String
Dim TRec As Recordset: Dim mbparty As String

    If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
    If lexceltype = 131 Then
        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, False, 1)
    Else
        Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
    End If
    If LenB(LSItemCode) < 1 Then
        LMsgBox = "Item Missing " & LEXHCODE & ""
        ImportIssues (LMsgBox)
        GoTo EFlag_Next
    End If
    If LSExCode = "MCX" And (lexceltype = 109 Or lexceltype = 141 Or lexceltype = 124 Or lexceltype = 117 Or lexceltype = 138 Or lexceltype = 132) Or (GUniqClientId = "1193BUL" Or GUniqClientId = "SVM-KHG") Then
        LBQty = LBQty / LLOT
        'LBQty = IIf(IsNull(TxtRec!f8), 0, TxtRec!f8)
    End If
    If LSExCode = "MCX" And (GUniqClientId = "1193BUL" Or GUniqClientId = "SVM-KHJ") Then
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        mysql = "select reflot from itemmast where compcode= '" & GCompCode & "'  and itemcode = '" & LSItemCode & "' "
        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec.EOF Then
            If TRec!REFLOT <> 0 Then
                LBQty = LBQty * TRec!REFLOT
            End If
        End If
    End If

    If LSExCode = "NSE" And lexceltype = 130 And Right(TxtRec!F5, 3) = "Lot" Then
        LLOT = 0
        A = 1
        A = InStr(A, TxtRec!F4, " ")
        A = InStr(A + 1, TxtRec!F4, " ")
        LLOT = Val(Mid(TxtRec!F4, A + 1, Len(TxtRec!F4) - A))
        LBQty = LBQty * LLOT
    End If

    'mbparty = lbparty
    mbparty = Get_ACCT_EX(LSEXID, lbparty)
            ''
    If LenB(mbparty) < 1 Then
        LMsgBox = "New Party " & lbparty & " " & LPartyName & ""
        ImportIssues (LMsgBox)
        mbparty = NewParty(LSExCode, lbparty, LPartyName & " " & LSExCode, "", True)
        If LenB(mbparty) < 1 Then
            LMsgBox = " Please Create Account For  " & lbparty & ""
            ImportIssues (LMsgBox)
        End If
    End If

    Set TRec = Nothing
    Set TRec = New ADODB.Recordset

    'mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",'" & Format(LSMaturity, "yyyy/mm/dd") & "'," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
    If LSInstType <> "OPT" Then
        mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",'" & "" & "'," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    Else
        Set TRec = Nothing
        Set TRec = New ADODB.Recordset
        mysql = "SELECT SAUDACODE,MATURITY,SAUDAID FROM SAUDAMAST WHERE COMPCODE= " & GCompCode & " AND ITEMCODE ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    End If
    If Not TRec.EOF Then
       LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
    Else
       Set TRec = Nothing
       Set TRec = New ADODB.Recordset
       mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
       If LSInstType = "OPT" Then
           mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
           mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
       ElseIf LSInstType = "CSH" Then
            mysql = mysql & " AND INSTTYPE='CSH' "
       Else
           mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
       End If
       TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
       If Not TRec.EOF Then
           LSMaturity = TRec!MATURITY
           ''Check In Saudamast It Not Exists Then Add
            LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
       Else
           If LSInstType = "FUT" Then
                LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                    LSSaudaCode = LSExCode & " " & LSSaudaCode
                    If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                        LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                        ImportIssues (LMsgBox)
                        GoTo EFlag_Next
                    End If
                End If
            Else
                'LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                LSSaudaCode = Trim(LSItemCode) & " " & LSInstType & " " & LSOptType & " " & LSStrike & " " & Left$(CStr(Day(LSMaturity)), 2) & UCase(Left$(MonthName(Val(month(LSMaturity))), 3)) & Right$(Year(LSMaturity), 2)
                'lday = Left(LSMaturity, InStr(LSMaturity, "/") - 1)
                'LSSaudaCode = LSItemCode & " OPT" & LSOptType & " " & LSStrike & " " & LStrMonth & " " & LYEAR
                
            '    LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
             '   ImportIssues (LMsgBox)
              '  GoTo EFlag_Next
            End If
            Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
        End If
        LSSaudaID = Get_SaudaID(LSSaudaCode)
    End If
    
    If InStr(TxtRec!F5, "OPTION") <> 0 And LSInstType = "OPT" Then
        mysql = "SELECT REFLOT FROM SAUDAMAST WHERE SAUDAID=" & LSSaudaID & "": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        If Not TRec.EOF Then
            LBQty = LBQty * TRec!REFLOT
        End If
    End If
    
    
    Dim MSPARTY As String
    Dim LSConSno As Long
    Dim LUserId As String
    LUserId = ""
    If LSCondate > LSMaturity Then
        LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
        ImportIssues (LMsgBox)
    End If
    LSEXID = Get_ExID(LSExCode)
    'LExcelType = 109

    If LBQty <> 0 Then  'Or LSQty <> 0
        'LSPARTY = Get_ACCT_EX(LSEXID, LSPARTY)
        MSPARTY = lsparty
        'If LSRate = 0 Then
        '    MsgBox "Please Contact , Sauda Software"
        'End If
     '   mbparty = lbparty
     
        mysql = "SELECT BROKER FROM EXBROKCLIENT WHERE COMPCODE =" & GCompCode & " AND CLIENT ='" & mbparty & "'": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
        If Not TRec.EOF Then MSPARTY = TRec!BROKER

        If LenB(MSPARTY) < 1 Then
            Exit Sub
            'Call Get_ExDetail(LSExCode): MSPARTY = LExCont
        End If
     
        lbparty = mbparty
        If InStr(LBillExId, str(LSEXID)) = 0 Then
            If LenB(LBillExId) > 0 Then
                LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                If lexceltype <> 117 Then
                    MCount = MCount + 1:
                End If
                If lexceltype = 133 Or lexceltype = 134 Then
                    
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                    LNoTrd = LNoTrd + 1
                    
                    If LSPtyContype = "S" Then
                        If LSRate <> 0 Then
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND  ROWNO1='" & LOConNo & "' AND FILETYPE ='" & lexceltype & "' AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                            Cnn.Execute mysql
                        
                            Call Add_To_Ctr_D2("S", lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LSRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                        
                        If LBRate <> 0 Then
                            MCount = MCount + 1:
                            If LSRate <> 0 Then
                                LOConNo = Right(LOConNo, Len(LOConNo) - 1)
                            End If
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND  ROWNO1='" & LOConNo & "' AND FILETYPE ='" & lexceltype & "' AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                            Cnn.Execute mysql
                        
                            Call Add_To_Ctr_D2("B", lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LBRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If

                    Else
                        If LBRate <> 0 Then
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND  ROWNO1='" & LOConNo & "' AND FILETYPE ='" & lexceltype & "' AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                            Cnn.Execute mysql
                            Call Add_To_Ctr_D2("B", lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LBRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                        
                        If LSRate <> 0 Then
                            MCount = MCount + 1:
                            If LBRate <> 0 Then
                                LOConNo = Right(LOConNo, Len(LOConNo) - 1)
                            End If
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND  ROWNO1='" & LOConNo & "' AND FILETYPE ='" & lexceltype & "' AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
                            Cnn.Execute mysql
                            Call Add_To_Ctr_D2("S", lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LSRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                         End If
                    End If
                Else
                    If lexceltype = 130 Or lexceltype = 131 Or lexceltype = 133 Then
                        mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                        Cnn.Execute mysql
                    End If
                    If lexceltype = 132 Then
                        LOrdNo = LFolderName
                    End If
                    LNoTrd = LNoTrd + 1
                    GETMAIN.Label1.Caption = "Trade No " & LNoTrd
                    DoEvents
                    LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                    Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            End If
       End If
End If
EFlag_Next:

err1:
If err.Number <> 0 Then
    MsgBox err.Description
End If



End Sub
Sub EXCEL_109(MCount As Long, lexceltype As Integer)
    Dim TRec As ADODB.Recordset
    Dim mysql As String
    Dim LContime As String
    Dim A As Integer
    Dim B As Integer
    Dim C As Integer
    Dim LSTR As String
    
    LSExCode = vbNullString
    'LOConNo = TxtRec!F1:
    LOrdNo = LFolderName
    If lexceltype = 131 Then
        lbparty = TxtRec!F10
        If Val(TxtRec!F8) > 0 Then
            LSPtyContype = "B"
        Else
            LSPtyContype = "S"
        End If
        LBQty = IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)
        LBRate = IIf(IsNull(TxtRec!F9), 0, TxtRec!F9)
        LEXHCODE = TxtRec!F7
        LSTRCONDATE = TxtRec!F1 & "/" & TxtRec!F2 & "/" & TxtRec!f3
        LSCondate = DateValue(LSTRCONDATE)
        LSTRCONDATE = TxtRec!F4 & "/" & TxtRec!F5 & "/" & TxtRec!f6
        LSMaturity = DateValue(LSTRCONDATE)
        LPartyName = lbparty & " " & lbparty
    ElseIf lexceltype = 124 Then
        B = Len(TxtRec!f3)
        A = InStr(TxtRec!f3, "(")
        A = InStr(A + 1, TxtRec!f3, "(")
        If LClientCode = "" Then
            lbparty = Mid(TxtRec!f3, A + 1, B - A - 1)
        Else
            lbparty = LClientCode
        End If
        A = InStr(TxtRec!f3, "(")
        LPartyName = Left(TxtRec!f3, A - 1)
        LSPtyContype = UCase(Left(TxtRec!f6, 1))
        LSTRCONDATE = Left$(TxtRec!F14, 10)
        LSCondate = DateValue(Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 2) & "/20" & Right(LSTRCONDATE, 2))
        A = InStr(TxtRec!F4, " ")
        If InStr(TxtRec!F4, " CE ") <> 0 Or InStr(TxtRec!F4, " PE ") <> 0 Then
            A = InStr(TxtRec!F4, " ")
            B = InStr(A + 1, TxtRec!F4, " ")
            C = InStr(B + 1, TxtRec!F4, " ")
            LSStrike = Mid(TxtRec!F4, A + 1, B - A)
            LSOptType = Trim(Mid(TxtRec!F4, B + 1, C - B))
            LEXHCODE = Left(TxtRec!F4, A - 1)
            LSTRCONDATE = Right(TxtRec!F4, 9)
            LSTRCONDATE = DateValue(Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/20" & Right(LSTRCONDATE, 2))
            LSMaturity = DateValue(LSTRCONDATE)
            LSInstType = "OPT"
        Else
            LEXHCODE = Left(TxtRec!F4, A - 1)
            LSTRCONDATE = Mid(TxtRec!F4, A + 1, 9)
            LSTRCONDATE = DateValue(Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/20" & Right(LSTRCONDATE, 2))
            LSMaturity = DateValue(LSTRCONDATE)
        End If
        If Right(TxtRec!F8, 1) = "K" Then
            LBQty = Val(Left(TxtRec!F8, Len(TxtRec!F8) - 1)) * 1000
        Else
            LBQty = Val(TxtRec!F8)
        End If
        LBRate = IIf(IsNull(TxtRec!F9), 0, TxtRec!F9)
        LBRate = Val(LBRate)
        LContime = Right(TxtRec!F14, 8)
    Else
        If LClientCode = "" Then
            lbparty = Trim(IIf(IsNull(TxtRec!F2), vbNullString, (TxtRec!F2))):
            If InStr(lbparty, " ") Then
                lbparty = Replace(lbparty, " ", vbNullString)
            End If
        Else
            lbparty = LClientCode
        End If
        LSTRCONDATE = Left$(TxtRec!f11, 10)
        LSPtyContype = UCase(Left(TxtRec!F7, 1))
        LSCondate = DateValue(LSTRCONDATE)
        
        If TxtRec!F2 = "EQUITY" Then
            LEXHCODE = TxtRec!f3 + " "
        Else: LEXHCODE = TxtRec!f3
        End If
        LSMaturity = DateValue(Left(TxtRec!F4, 2) & "/" & Mid(TxtRec!F4, 4, 3) & "/20" & Right(TxtRec!F4, 2))
        If Right(TxtRec!F9, 1) = "K" Then
            LBQty = Val(Left(TxtRec!F9, Len(TxtRec!F9) - 1)) * 1000
        Else
            LBQty = Val(TxtRec!F9)
        End If
        LBRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)):
        LContime = Right(TxtRec!f12, 8)
        LPartyName = lbparty & " " & lbparty
    End If
    
    LSRate = LBRate
    DoEvents

    lsparty = LBrokerCode
    
    
    Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)

End Sub

Public Function GET_DAYS(LMONTH As String, lpyear As String, LSCondate As Date)
Dim lday As Integer
If LMONTH = "JAN" Or LMONTH = "Jan" Then
        LMONTH = 1
ElseIf LMONTH = "FEB" Or LMONTH = "Feb" Then
        LMONTH = 2
ElseIf LMONTH = "MAR" Or LMONTH = "Mar" Then
        LMONTH = 3
ElseIf LMONTH = "APR" Or LMONTH = "Apr" Then
        LMONTH = 4
ElseIf LMONTH = "MAY" Or LMONTH = "May" Then
        LMONTH = 5
ElseIf LMONTH = "JUN" Or LMONTH = "Jun" Then
        LMONTH = 6
ElseIf LMONTH = "JUL" Or LMONTH = "Jul" Then
        LMONTH = 7
ElseIf LMONTH = "AUG" Or LMONTH = "Aug" Then
        LMONTH = 8
ElseIf LMONTH = "SEP" Or LMONTH = "Sep" Then
        LMONTH = 9
ElseIf LMONTH = "OCT" Or LMONTH = "Oct" Then
        LMONTH = 10
ElseIf LMONTH = "NOV" Or LMONTH = "Nov" Then
        LMONTH = 11
ElseIf LMONTH = "DEC" Or LMONTH = "Dec" Then
        LMONTH = 12
End If
If LMONTH >= 1 And LMONTH <= 4 Then
    If month(LSCondate) > Val(LMONTH) Then
        lpyear = lyear + 1
    End If
End If

GET_DAYS = Day(DateSerial(lpyear, LMONTH + 1, 1) - 1)


End Function



Sub Excel_110_insert(MCount As Long, LContime As String, lexceltype As Integer)

On Error GoTo err1

Dim TRec As Recordset: Dim mbparty As String

    If LenB(LEXHCODE) < 1 Then GoTo EFlag_Next
    
    
    Dim MSPARTY As String
    Dim LSConSno As Long
    Dim LUserId As String
    LUserId = ""
    If LSCondate > LSMaturity Then
        LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
        ImportIssues (LMsgBox)
    End If
    LSEXID = Get_ExID(LSExCode)

    If LBQty <> 0 Then  'Or LSQty <> 0
        mbparty = Get_ACCT_EX(LSEXID, lbparty)
        MSPARTY = lsparty
        If LenB(mbparty) < 1 Then
            LMsgBox = " Client does Not Exist " & lbparty & ""
            ImportIssues (LMsgBox)
            GoTo EFlag_Next
        End If
        If LenB(MSPARTY) < 1 Then
            LMsgBox = " Broker does Not Exist " & lsparty & ""
            ImportIssues (LMsgBox)
            GoTo EFlag_Next
        End If
        
        If InStr(LBillExId, str(LSEXID)) = 0 Then
            If LenB(LBillExId) > 0 Then
                LBillExId = LBillExId & ","
                LBillExId = LBillExId & str(LSEXID)
            End If
            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                MCount = MCount + 1:
                LNoTrd = LNoTrd + 1
                GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
                DoEvents
                LOConNo = str(MCount)
           
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            End If
        End If

EFlag_Next:

err1: If err.Number <> 0 Then
    MsgBox err.Description
End If

End Sub
Sub EXCEL_110(MCount As Long, lexceltype As Integer)
    Dim TRec As ADODB.Recordset
    Dim mysql As String
    Dim LContime As String
    Dim ltradedt As Date
    
    LSExCode = vbNullString
    If lexceltype = 110 Then
        LOConNo = TxtRec!f3:
        LSTRCONDATE = Left$(TxtRec!F1, 10)
        LSTR = TxtRec!F2
    Else
        LOConNo = TxtRec!F2:
        LSTRCONDATE = Left$(TxtRec!f3, 10)
        LSTR = TxtRec!F1
    End If
    
    LSPtyContype = UCase(Left(TxtRec!F4, 1))
    
    LOrdNo = ""
    lbparty = LClientCode
    LPartyName = ""
    LSCondate = DateValue(Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 2) & "/" & Right(LSTRCONDATE, 4))
    
    DoEvents
    Dim mnocode As Integer
    
    A = InStr(LSTR, "MX1")
    If A <> 0 Then
        LEXHCODE = Left(LSTR, A - 2)
        mnocode = 1
    End If
    
    A = InStr(LSTR, "MX2")
    If A <> 0 Then
        LEXHCODE = Left(LSTR, A - 2)
        mnocode = 2
    End If
    
    A = InStr(LSTR, "NE1")
    If A <> 0 Then
        LEXHCODE = Left(LSTR, A - 2)
        mnocode = 1
    End If
    
    A = InStr(LSTR, "NE2")
    If A <> 0 Then
        LEXHCODE = Left(LSTR, A - 2)
        mnocode = 2
    End If
    
    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset


    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT  TOP 1 SAUDACODE ,maturity,saudaid FROM SAUDAMAST WHERE COMPCODE = '" & GCompCode & "' AND NOCODE = '" & mnocode & "' AND MATURITY >= '" & Format(LSCondate, "YYYY/MM/DD") & "'  AND ITEMCODE = '" & LSItemCode & "'"
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    Set TRec = Nothing: Set TRec = New ADODB.Recordset
    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
    If Not TRec.EOF Then
        LSSaudaCode = TRec!saudacode:   LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
    Else

    End If
    A = InStr(TxtRec!f6, "/")
    If A <> 0 Then
        LBQty = Val(Left(TxtRec!f6, A - 1))
    Else
        LBQty = Val(TxtRec!f6)
    End If
    LBRate = Val(IIf(IsNull(TxtRec!F7), 0, TxtRec!F7)):
    LSRate = LBRate
    lsparty = LBrokerCode
    
    LContime = Right(TxtRec!F1, 5)
    If LSSaudaID > 0 Then
        Call Excel_110_insert(MCount, LContime, lexceltype)
    End If
End Sub
Sub ImportIssues(LMsg As String)

    Dim iloop As Integer
    
    For iloop = 0 To List1.ListCount
        If LMsg = List1.List(iloop) Then
            LMsg = ""
            Exit For
        End If
    Next
    If LMsg <> "" Then
        List1.AddItem (LMsg)
    End If
    
End Sub
Sub ARK_TRD_SingleFile(LSCondate As Date, MOPEN As String, Optional lclientid As String, Optional lsparty As String)

Dim LBQty As Double
Dim LSQty As Double
Dim LContime As String
Dim lday As Integer
Dim ltradedt As Date
Dim MSPARTY As String: Dim mbparty As String
Dim MCount As Integer
Dim LSConSno As Long
Dim TRec As ADODB.Recordset
Dim LUserId As String

LSExCode = ""
LNoTrd = LNoTrd + 1
LBQty = 0: LSQty = 0

If Not IsDate(TxtRec!F1) Then Exit Sub


 
    
'    If (Left(TxtRec!f4, 3) <> "MCX" And Left(TxtRec!f4, 8) <> "Energies" And Left(TxtRec!f4, 5) <> "Spots" And Left(TxtRec!f4, 7) <> "Indices" And Left(TxtRec!f4, 9) <> "US Stocks" And Left(TxtRec!f4, 6) <> "Crypto" And Left(TxtRec!f4, 6) <> "DINR" And Left(TxtRec!f4, 6) <> "Metals" And Left(TxtRec!f4, 5) <> "CBOPT" And Left(TxtRec!f4, 6) <> "Metals Spot" And Left(TxtRec!f4, 3) <> "NSE" And Left(TxtRec!f4, 3) <> "Nse" And Left(TxtRec!f4, 5) <> "NCDEX") Then
'        Exit Sub
'    End If
'    If Not IsNull(TxtRec!F20) Then
'        If Left(TxtRec!F20, 13) = "carry forward" Then
'            Exit Sub
'        End If
'    End If
'    If MOPEN = "C" Then
'        If Left(TxtRec!F22, 19) = "Expiry Manual Close" Then
'            Exit Sub
'        End If
'    End If
'
'    If Left(TxtRec!f4, 11) = "Metals Spot" Or Left(TxtRec!f4, 5) = "Spots" Then
'        LSExCode = "SPOT"
'    Else
'        LSExCode = Left(TxtRec!f4, 3)
'    End If
'
'    'LSExCode = Left(TxtRec!F4, 3)
'    If LSExCode = "NCD" Then
'        LSExCode = "NCDX"
'    End If
'    If LSExCode = "DIN" Then
'        LSExCode = "DINR"
'    End If
'    If LSExCode = "US " Then
'        LSExCode = "USS"
'    End If
'   If LSExCode = "Ene" Then
'        LSExCode = "ENERGY"
'    End If
'
'    If Left(TxtRec!f4, 4) = "Nse" Then
'        LSExCode = "NSE"
'    End If
'
'
'    If LSExCode = "Met" Or InStr(TxtRec!f3, "USDINR") Then
'        LSExCode = "CMX"
'    End If


LSItemCode = ""
If MOPEN = "G" Then
    If Mid(TxtRec!F4, 4, 1) = "/" Then Exit Sub
    lbparty = lclientid
    LPartyName = lbparty
    MSPARTY = lsparty
    A = InStr(TxtRec!F1, "MCX")
    If A <> 0 And Left(TxtRec!F1, 3) <> "MCX" Then
        LSExCode = "MCX"
        If InStr(TxtRec!F1, "June") <> 0 Or InStr(TxtRec!F1, "July") <> 0 Then
            LSItemCode = Left(TxtRec!F1, A - 2)
            LMONTH = Left(Right(TxtRec!F1, 4), 3)
        Else
            LSItemCode = Left(TxtRec!F1, A - 2)
            LMONTH = Right(TxtRec!F1, 3)
        End If
        lyear = Year(LSCondate)
    Else
        A = InStr(TxtRec!F1, "/")
        If A <> 0 Then
            A = InStr(TxtRec!F1, "INR")
            If A <> 0 Then
                LSItemCode = Left(TxtRec!F1, A - 2)
                LMONTH = Right(Trim(TxtRec!F1), 2)
                lyear = Year(LSCondate)
            End If
        Else
            LSExCode = "NCDX"
            A = InStr(TxtRec!F1, "INR")
            If A <> 0 Then
                LSItemCode = Left(TxtRec!F1, A - 2)
                LMONTH = Right(Trim(LSItemCode), 4)
                LMONTH = Left(Trim(LMONTH), 3)
                LSItemCode = Trim(Left(LSItemCode, Len(Trim(LSItemCode)) - 4))
                lyear = Year(LSCondate)
            Else
                If InStr(TxtRec!F1, "June") <> 0 Or InStr(TxtRec!F1, "July") <> 0 Then
                    LSItemCode = Left(TxtRec!F1, Len(TxtRec!F1) - 5)
                    LMONTH = Right(TxtRec!F1, 4)
                    LMONTH = Left(LMONTH, 3)
                Else
                    LSItemCode = Left(TxtRec!F1, Len(TxtRec!F1) - 4)
                    LMONTH = Right(TxtRec!F1, 3)
                End If
                lyear = Year(LSCondate)
                LSExCode = ""
            End If
        End If
    End If
    
    LContime = "" 'Mid(TxtRec!f7, 12, 8)
    LOConNo = TxtRec!F2
    LSPtyContype = Left(TxtRec!F4, 1)
    LBQty = TxtRec!F5
    LBRate = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
    LSRate = LBRate
   
Else
    LContime = ""
    If GUniqClientId = "PRM-MUM" Then
        If Left(TxtRec!f6, 1) <> "B" And Left(TxtRec!f6, 1) <> "S" Then Exit Sub
        LSCondate = DateValue(Left(TxtRec!F7, 10))
        LSPtyContype = Left(TxtRec!f6, 1)
    Else
        If MOPEN = "S" Then
            If Left(TxtRec!f12, 1) <> "B" And Left(TxtRec!f12, 1) <> "S" Then Exit Sub
            LSCondate = DateValue(Left(TxtRec!f6, 10))
            LSPtyContype = Left(TxtRec!f12, 1)
        Else
            If MOPEN = "C" Then
                If Left(TxtRec!f11, 1) <> "B" And Left(TxtRec!f11, 1) <> "S" Then Exit Sub
                LSPtyContype = Left(TxtRec!f11, 1)
                LSCondate = DateValue(Left(TxtRec!f6, 10))
            Else
                If Left(TxtRec!f6, 1) <> "B" And Left(TxtRec!f6, 1) <> "S" Then Exit Sub
                LSPtyContype = Left(TxtRec!f6, 1)
                LSCondate = DateValue(Left(TxtRec!F7, 10))
            End If
            
            LSPtyContype = Left(LSPtyContype, 1)
        End If
    End If

    A = InStr(TxtRec!F1, ":")
    lbparty = Left(TxtRec!F1, A - 1)
    LPartyName = (TxtRec!F2 & vbNullString):
    lday = 0

    If LSExCode = "MCX" Then
        A = InStr(TxtRec!f3, "GOLDTEST")
        If A <> 0 Then
            Exit Sub
        End If
        A = InStr(TxtRec!f3, "MCX.b")
        If A <> 0 Then
        End If
        A = InStr(TxtRec!f3, "MCX")
        LSItemCode = Left(TxtRec!f3, A - 2)
        LMONTH = Mid(TxtRec!f3, A + 4, 3)
        lyear = Year(LSCondate)
    
    ElseIf LSExCode = "CBO" Then
        A = InStr(TxtRec!f3, "Dollars")
        If A = 0 Then
              A = InStr(TxtRec!f3, "INR")
              If A <> 0 Then
                   If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
                        LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                        LMONTH = Left(Right(Trim(LSItemCode), 4), 3)
                        LSItemCode = Left(LSItemCode, Len(LSItemCode) - 5)
                    Else
                        If InStr(TxtRec!f3, "January") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 7), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 8)
                        ElseIf InStr(TxtRec!f3, "Febuary") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 7), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 8)
                        ElseIf InStr(TxtRec!f3, "March") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 5), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 6)
                        ElseIf InStr(TxtRec!f3, "April") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 5), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 6)
                        ElseIf InStr(TxtRec!f3, "May") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 3), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 4)
                        ElseIf InStr(TxtRec!f3, "August") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 6), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 7)
                        ElseIf InStr(TxtRec!f3, "September") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 9), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 10)
                        ElseIf InStr(TxtRec!f3, "October") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 7), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 8)
                        ElseIf InStr(TxtRec!f3, "November") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 8), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 9)
                        ElseIf InStr(TxtRec!f3, "December") <> 0 Then
                            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                            LMONTH = Left(Right(Trim(LSItemCode), 8), 3)
                            LSItemCode = Left(LSItemCode, Len(LSItemCode) - 9)
                        End If
                        lyear = Year(LSCondate)
                      End If
                Else
                    If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
                        LSItemCode = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 4))
                          LMONTH = Left(Right(Trim(TxtRec!f3), 4), 3)
                 
                         lyear = Year(LSCondate)
                    Else
                          LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                        LMONTH = Left(Right(Trim(TxtRec!f3), 3), 3)
                                                 lyear = Year(LSCondate)
                      End If
                End If
       Else
            LSExCode = "CMX"
            A = InStr(TxtRec!f3, "Dollars")
            If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
                LSItemCode = Left(TxtRec!f3, A - 1)
                LMONTH = Left(Right(Trim(LSItemCode), 4), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 5)
                lyear = Year(LSCondate)
            Else
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 3), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 5)
                lyear = Year(LSCondate)
            End If
       End If
    ElseIf LSExCode = "SPOT" Or LSExCode = "Cry" Or LSExCode = "USS" Then
        LSItemCode = Trim(TxtRec!f3)
        LMONTH = month(GFinEnd)
        lyear = Year(GFinEnd)
        lday = Day(GFinEnd)
    
    ElseIf LSExCode = "CMX" Then
        If InStr(TxtRec!f3, "JUNE") <> 0 Or InStr(TxtRec!f3, "JULY") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 5)
            LMONTH = Left(Right(TxtRec!f3, 4), 3)
        Else
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
            LMONTH = Right(TxtRec!f3, 3)
        End If
        lyear = Year(LSCondate)
    ElseIf LSExCode = "NSE" Or LSExCode = "Nse" Or LSExCode = "DINR" Or LSExCode = "IND" Or LSExCode = "ENERGY" Then
        If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Or InStr(TxtRec!f3, "JUNE") <> 0 Or InStr(TxtRec!f3, "JULY") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 5)
            LMONTH = Left(Right(TxtRec!f3, 4), 3)
        Else
            If InStr(TxtRec!f3, "APRIL") <> 0 Then
            A = InStr(TxtRec!f3, "APRIL")
                LSItemCode = Left(TxtRec!f3, A - 1)
                LMONTH = "APR"
            Else
              LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                LMONTH = Right(TxtRec!f3, 3)
            End If
        End If
        lyear = Year(LSCondate)
    ElseIf LSExCode = "NCDX" Then
        If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 5)
            LMONTH = Left(Right(TxtRec!f3, 4), 3)
        ElseIf InStr(TxtRec!f3, "SEPTEBER") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 8)
            LMONTH = Left(Right(TxtRec!f3, 8), 3)
        ElseIf InStr(TxtRec!f3, "September") <> 0 Or InStr(TxtRec!f3, "SEPTEMBER") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 9)
            LMONTH = Left(Right(TxtRec!f3, 9), 3)
        Else
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
            LMONTH = Right(TxtRec!f3, 3)
        End If
        lyear = Year(LSCondate)
    Else
        A = InStr(TxtRec!f3, "MCX")
        If A <> 0 Then
            LSItemCode = Left(TxtRec!f3, A - 2)
            LMONTH = Mid(TxtRec!f3, A + 4, 3)
        Else
            If InStr(TxtRec!f3, "January") <> 0 Or InStr(TxtRec!f3, "Febuary") <> 0 Or InStr(TxtRec!f3, "October") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 8)
                LMONTH = Left(Right(TxtRec!f3, 7), 3)
            ElseIf InStr(TxtRec!f3, "August") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 7)
                LMONTH = Left(Right(TxtRec!f3, 6), 3)
            ElseIf InStr(TxtRec!f3, "March") <> 0 Or InStr(TxtRec!f3, "April") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 6)
                LMONTH = Left(Right(TxtRec!f3, 5), 3)
            ElseIf InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 5)
                LMONTH = Left(Right(TxtRec!f3, 4), 3)
            ElseIf InStr(TxtRec!f3, "September") <> 0 Or InStr(TxtRec!f3, "November") <> 0 Or InStr(TxtRec!f3, "December") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 9)
                LMONTH = Left(Right(TxtRec!f3, 8), 3)
            ElseIf InStr(TxtRec!f3, "May") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                LMONTH = Right(TxtRec!f3, 3)
            End If
        End If
        lyear = Year(LSCondate)
    End If
    

    LOConNo = TxtRec!F5
    
    If GUniqClientId = "PRM-MUM" Then
        If MOPEN = "C" Then
            LBQty = TxtRec!F9
            LBRate = IIf(IsNull(TxtRec!F13), 0, TxtRec!F13)
        Else
            LBQty = TxtRec!F8
            LBRate = IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)
        End If
   Else
        If MOPEN = "C" Then
            If LSPtyContype = "B" Then
                LSPtyContype = "S"
            Else
                LSPtyContype = "B"
            End If
            LBQty = TxtRec!F8
            LBRate = IIf(IsNull(TxtRec!F13), 0, TxtRec!F13)
        ElseIf MOPEN = "S" Then
            LBQty = TxtRec!F7
            LBRate = IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)
        ElseIf MOPEN = "O" Then
            LBQty = TxtRec!F8
            LBRate = IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)
        End If
    End If
    LSRate = LBRate
End If

If lday = 0 Then
    lday = GET_DAYS(LMONTH, lyear, LSCondate)
End If
                    
LSTRCONDATE = DateValue(lday & "/" & LMONTH & "/" & lyear)
LSMaturity = DateValue(LSTRCONDATE)

                    If month(LSMaturity) < month(LSCondate) Then
                        lyear = (Year(LSCondate) + 1)
                        LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                    End If
                    LMonthType = "M"
                    If (LBQty = 0 And LSQty = 0) Then Exit Sub
                    LOrdNo = ""
                    LSTRCONDATE = ltradedt
                    LContime = "" 'IIf(IsNull(TxtRec!F1), "", Right(TxtRec!F1, 5))
                    LEXHCODE = LSItemCode
                    lsparty = LBrokerCode
                    MSPARTY = LBrokerCode
                    If LenB(LEXHCODE) < 1 Then Exit Sub
                    
                    If Len(LSExCode) < 1 Then
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                    
                        mysql = "SELECT EXCHANGECODE FROM ITEMMAST WHERE  COMPCODE = '" & GCompCode & "' AND ITEMCODE = '" & LEXHCODE & "' "
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            LSExCode = "NCDX"
                        Else
                            LSExCode = TRec!EXCHANGECODE
                        End If
                    End If

                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                    If LenB(LSItemCode) < 1 Then Exit Sub
                    If (GUniqClientId = "1193BUL" Or GUniqClientId = "SVM-KHJ") And LSExCode = "MCX" And MOPEN <> "G" Then
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "select reflot from itemmast where compcode= '" & GCompCode & "'  and (itemcode = '" & LEXHCODE & "' OR ITALIAS_1 = '" & LEXHCODE & "') "
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TRec.EOF Then
                            LBQty = IIf(IsNull(LBQty), 0, LBQty * TRec!REFLOT)
                            'Else
                             '   LBQty = IIf(IsNull(TxtRec!f8), 0, TxtRec!f8 * TRec!REFLOT)
                            'End If
                        End If
                    End If

                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset

                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                       LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                    Else
                       Set TRec = Nothing
                       Set TRec = New ADODB.Recordset
                       mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                       If LSInstType <> "FUT" Then
                           mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                           mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                       Else
                           mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                       End If
                       TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                       If Not TRec.EOF Then
                           LSMaturity = TRec!MATURITY
                           LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                       Else
                           If LSInstType = "FUT" Then
                                LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                    LSSaudaCode = LSExCode & " " & LSSaudaCode
                                    If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                        LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                        ImportIssues (LMsgBox)
                                        Exit Sub
                                    End If
                                End If
                            Else
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                ImportIssues (LMsgBox)
                                Exit Sub
                            End If
                            Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                        End If
                    End If
                    LSSaudaID = Get_SaudaID(LSSaudaCode)

                    If LenB(LSSaudaCode) < 1 Then Exit Sub
                    If LSCondate > LSMaturity Then
                       LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                       ImportIssues (LMsgBox)
                   End If
                   LSEXID = Get_ExID(LSExCode)

                    If LBQty <> 0 Or LSQty <> 0 Then
                      '  lbparty = Left(LPartyName, 6)
                        mbparty = Get_ACCT_EX(LSEXID, lbparty)
                        If LenB(mbparty) < 1 Then
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                        End If
                        MSPARTY = lsparty
                        lbparty = mbparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            Exit Sub
                        End If

                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then
                                LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            DoEvents

                            If LBQty = 0 Then LBQty = LSQty
                            MCount = MCount + 1:
                            'LOConNo = MCount
                            
                            ''
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                            Cnn.Execute mysql
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If


End Sub

Sub ARK_TRD(LSCondate As Date, MOPEN As String, Optional lclientid As String, Optional lsparty As String)

On Error GoTo err1
Dim LBQty As Double
Dim LSQty As Double
Dim LContime As String
Dim lday As Integer
Dim ltradedt As Date
Dim MSPARTY As String: Dim mbparty As String
Dim MCount As Integer
Dim LSConSno As Long
Dim TRec As ADODB.Recordset
Dim LUserId As String

LSExCode = ""
LNoTrd = LNoTrd + 1
LBQty = 0: LSQty = 0

If IsNull(TxtRec!F5) Then Exit Sub
If IsNull(TxtRec!f6) Then Exit Sub

 If GUniqClientId = "PRM-MUM" Then
    
    If (Left(TxtRec!F4, 3) <> "MCX" And Left(TxtRec!F4, 8) <> "Energies" And Left(TxtRec!F4, 5) <> "Spots" And Left(TxtRec!F4, 7) <> "Indices" And Left(TxtRec!F4, 9) <> "US Stocks" And Left(TxtRec!F4, 6) <> "Crypto" And Left(TxtRec!F4, 6) <> "DINR" And Left(TxtRec!F4, 6) <> "Metals" And Left(TxtRec!F4, 5) <> "CBOPT" And Left(TxtRec!F4, 6) <> "Metals Spot" And Left(TxtRec!F4, 3) <> "NSE" And Left(TxtRec!F4, 3) <> "Nse" And Left(TxtRec!F4, 5) <> "NCDEX") Then
        Exit Sub
    End If
    'If Not IsNull(TxtRec!F20) Then
     '   If Left(TxtRec!F20, 13) = "carry forward" Then
      '      Exit Sub
       ' End If
    'End If
    If MOPEN = "C" Then
        If Left(TxtRec!f22, 19) = "Expiry Manual Close" Then
            Exit Sub
        End If
    End If
    
    If Left(TxtRec!F4, 11) = "Metals Spot" Or Left(TxtRec!F4, 5) = "Spots" Then
        LSExCode = "SPOT"
    Else
        LSExCode = Left(TxtRec!F4, 3)
    End If
    
    'LSExCode = Left(TxtRec!F4, 3)
    If LSExCode = "NCD" Then
        LSExCode = "NCDX"
    End If
    If LSExCode = "DIN" Then
        LSExCode = "DINR"
    End If
    If LSExCode = "US " Then
        LSExCode = "USS"
    End If
   If LSExCode = "Ene" Then
        LSExCode = "ENERGY"
    End If
    
    If Left(TxtRec!F4, 4) = "Nse" Then
        LSExCode = "NSE"
    End If
        
    
    If LSExCode = "Met" Or InStr(TxtRec!f3, "USDINR") Then
        LSExCode = "CMX"
    End If
Else

    If Left(TxtRec!F4, 3) = "NSE" Or Left(TxtRec!F4, 3) = "Nse" Then
        LSExCode = "NSE"
    End If
    If Left(TxtRec!F4, 3) = "MCX" Or (Trim(TxtRec!F4) = "ALUMNIUM") Then
        LSExCode = "MCX"
    End If
End If

LSItemCode = ""
If MOPEN = "G" Then
    If Mid(TxtRec!F4, 4, 1) = "/" Then Exit Sub
    lbparty = lclientid
    LPartyName = lbparty
    MSPARTY = lsparty
    A = InStr(TxtRec!F1, "MCX")
    If A <> 0 And Left(TxtRec!F1, 3) <> "MCX" Then
        LSExCode = "MCX"
        If InStr(TxtRec!F1, "June") <> 0 Or InStr(TxtRec!F1, "July") <> 0 Then
            LSItemCode = Left(TxtRec!F1, A - 2)
            LMONTH = Left(Right(TxtRec!F1, 4), 3)
        Else
            LSItemCode = Left(TxtRec!F1, A - 2)
            LMONTH = Right(TxtRec!F1, 3)
        End If
        lyear = Year(LSCondate)
    Else
        A = InStr(TxtRec!F1, "/")
        If A <> 0 Then
            A = InStr(TxtRec!F1, "INR")
            If A <> 0 Then
                LSItemCode = Left(TxtRec!F1, A - 2)
                LMONTH = Right(Trim(TxtRec!F1), 2)
                lyear = Year(LSCondate)
            End If
        Else
            LSExCode = "NCDX"
            A = InStr(TxtRec!F1, "INR")
            If A <> 0 Then
                LSItemCode = Left(TxtRec!F1, A - 2)
                LMONTH = Right(Trim(LSItemCode), 4)
                LMONTH = Left(Trim(LMONTH), 3)
                LSItemCode = Trim(Left(LSItemCode, Len(Trim(LSItemCode)) - 4))
                lyear = Year(LSCondate)
            Else
                If InStr(TxtRec!F1, "June") <> 0 Or InStr(TxtRec!F1, "July") <> 0 Then
                    LSItemCode = Left(TxtRec!F1, Len(TxtRec!F1) - 5)
                    LMONTH = Right(TxtRec!F1, 4)
                    LMONTH = Left(LMONTH, 3)
                Else
                    LSItemCode = Left(TxtRec!F1, Len(TxtRec!F1) - 4)
                    LMONTH = Right(TxtRec!F1, 3)
                End If
                lyear = Year(LSCondate)
                LSExCode = ""
            End If
        End If
    End If
    
    LContime = "" 'Mid(TxtRec!f7, 12, 8)
    LOConNo = TxtRec!F2
    LSPtyContype = Left(TxtRec!F4, 1)
    LBQty = TxtRec!F5
    LBRate = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
    LSRate = LBRate
   
Else
    LContime = ""
    If GUniqClientId = "PRM-MUM" Then
        If Left(TxtRec!f6, 1) <> "B" And Left(TxtRec!f6, 1) <> "S" Then Exit Sub
        LSCondate = DateValue(Left(TxtRec!F7, 10))
        LSPtyContype = Left(TxtRec!f6, 1)
    Else
        If MOPEN = "S" Then
            If Left(TxtRec!f12, 1) <> "B" And Left(TxtRec!f12, 1) <> "S" Then Exit Sub
            LSCondate = DateValue(Left(TxtRec!f6, 10))
            LSPtyContype = Left(TxtRec!f12, 1)
        Else
            If MOPEN = "C" Then
                If Left(TxtRec!f11, 1) <> "B" And Left(TxtRec!f11, 1) <> "S" Then Exit Sub
                LSPtyContype = Left(TxtRec!f11, 1)
                LSCondate = DateValue(Left(TxtRec!f6, 10))
            Else
                If Left(TxtRec!f6, 1) <> "B" And Left(TxtRec!f6, 1) <> "S" Then Exit Sub
                LSPtyContype = Left(TxtRec!f6, 1)
                LSCondate = DateValue(Left(TxtRec!F7, 10))
            End If
            
            LSPtyContype = Left(LSPtyContype, 1)
        End If
    End If

    A = InStr(TxtRec!F1, ":")
    lbparty = Left(TxtRec!F1, A - 1)
    LPartyName = (TxtRec!F2 & vbNullString):
    lday = 0

    If LSExCode = "MCX" Then
        A = InStr(TxtRec!f3, "GOLDTEST")
        If A <> 0 Then
            Exit Sub
        End If
        A = InStr(TxtRec!f3, "MCX.b")
        If A <> 0 Then
        End If
        A = InStr(TxtRec!f3, "MCX")
        LSItemCode = Left(TxtRec!f3, A - 2)
        LMONTH = Mid(TxtRec!f3, A + 4, 3)
        If LMONTH = "APL" Then
            LMONTH = "APR"
        End If
        lyear = Year(LSCondate)
    
    ElseIf LSExCode = "CBO" Then
        A = InStr(TxtRec!f3, "Dollars")
        If A = 0 Then
            A = InStr(TxtRec!f3, "INR")
            If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                LMONTH = Left(Right(Trim(LSItemCode), 4), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 5)
            ElseIf InStr(TxtRec!f3, "January") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 7), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 8)
            ElseIf InStr(TxtRec!f3, "Febuary") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 7), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 8)
            ElseIf InStr(TxtRec!f3, "March") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 5), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 6)
            ElseIf InStr(TxtRec!f3, "April") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 5), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 6)
            ElseIf InStr(TxtRec!f3, "May") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 3), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 4)
            ElseIf InStr(TxtRec!f3, "August") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 6), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 7)
            ElseIf InStr(TxtRec!f3, "September") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 9), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 10)
            ElseIf InStr(TxtRec!f3, "October") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 7), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 8)
            ElseIf InStr(TxtRec!f3, "November") <> 0 Or InStr(TxtRec!f3, "NOV") <> 0 Then
                If A = 0 Then
                    LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 8)
                    LMONTH = Left(Right(Trim(TxtRec!f3), 8), 3)
                ElseIf InStr(TxtRec!f3, "NOV") <> 0 Then
                    LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                    LMONTH = Right(Trim(LSItemCode), 3)
                    LSItemCode = Left(LSItemCode, 3)
                End If
            ElseIf InStr(TxtRec!f3, "December") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 8), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 9)
            ElseIf InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
                LSItemCode = Trim(Left(TxtRec!f3, Len(TxtRec!f3) - 4))
                LMONTH = Left(Right(Trim(TxtRec!f3), 4), 3)
            Else
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(TxtRec!f3), 3), 3)
            End If
            lyear = Year(LSCondate)
       Else
            LSExCode = "CMX"
            A = InStr(TxtRec!f3, "Dollars")
            If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
                LSItemCode = Left(TxtRec!f3, A - 1)
                LMONTH = Left(Right(Trim(LSItemCode), 4), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 5)
                lyear = Year(LSCondate)
            Else
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 3)
                LMONTH = Left(Right(Trim(LSItemCode), 3), 3)
                LSItemCode = Left(LSItemCode, Len(LSItemCode) - 5)
                lyear = Year(LSCondate)
            End If
       End If
    ElseIf LSExCode = "SPOT" Or LSExCode = "Cry" Or LSExCode = "USS" Then
        LSItemCode = Trim(TxtRec!f3)
        LMONTH = month(GFinEnd)
        lyear = Year(GFinEnd)
        lday = Day(GFinEnd)
    
    ElseIf LSExCode = "CMX" Then
        If InStr(TxtRec!f3, "JUNE") <> 0 Or InStr(TxtRec!f3, "JULY") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 5)
            LMONTH = Left(Right(TxtRec!f3, 4), 3)
        Else
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
            LMONTH = Right(TxtRec!f3, 3)
        End If
        lyear = Year(LSCondate)
    ElseIf LSExCode = "NSE" Or LSExCode = "Nse" Or LSExCode = "DINR" Or LSExCode = "IND" Or LSExCode = "ENERGY" Then
        If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Or InStr(TxtRec!f3, "JUNE") <> 0 Or InStr(TxtRec!f3, "JULY") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 5)
            LMONTH = Left(Right(TxtRec!f3, 4), 3)
        Else
            If InStr(TxtRec!f3, "APRIL") <> 0 Then
            A = InStr(TxtRec!f3, "APRIL")
                LSItemCode = Left(TxtRec!f3, A - 1)
                LMONTH = "APR"
            Else
              LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                LMONTH = Right(TxtRec!f3, 3)
            End If
        End If
        lyear = Year(LSCondate)
    ElseIf LSExCode = "NCDX" Then
        If InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 5)
            LMONTH = Left(Right(TxtRec!f3, 4), 3)
        ElseIf InStr(TxtRec!f3, "SEPTEBER") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 8)
            LMONTH = Left(Right(TxtRec!f3, 8), 3)
        ElseIf InStr(TxtRec!f3, "September") <> 0 Or InStr(TxtRec!f3, "SEPTEMBER") <> 0 Then
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 9)
            LMONTH = Left(Right(TxtRec!f3, 9), 3)
        Else
            LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
            LMONTH = Right(TxtRec!f3, 3)
        End If
        lyear = Year(LSCondate)
    Else
        A = InStr(TxtRec!f3, "MCX")
        If A <> 0 Then
            LSItemCode = Left(TxtRec!f3, A - 2)
            LMONTH = Mid(TxtRec!f3, A + 4, 3)
        Else
            If InStr(TxtRec!f3, "January") <> 0 Or InStr(TxtRec!f3, "Febuary") <> 0 Or InStr(TxtRec!f3, "October") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 8)
                LMONTH = Left(Right(TxtRec!f3, 7), 3)
            ElseIf InStr(TxtRec!f3, "August") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 7)
                LMONTH = Left(Right(TxtRec!f3, 6), 3)
            ElseIf InStr(TxtRec!f3, "March") <> 0 Or InStr(TxtRec!f3, "April") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 6)
                LMONTH = Left(Right(TxtRec!f3, 5), 3)
            ElseIf InStr(TxtRec!f3, "June") <> 0 Or InStr(TxtRec!f3, "July") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 5)
                LMONTH = Left(Right(TxtRec!f3, 4), 3)
            ElseIf InStr(TxtRec!f3, "September") <> 0 Or InStr(TxtRec!f3, "November") <> 0 Or InStr(TxtRec!f3, "December") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 9)
                LMONTH = Left(Right(TxtRec!f3, 8), 3)
            ElseIf InStr(TxtRec!f3, "May") <> 0 Then
                LSItemCode = Left(TxtRec!f3, Len(TxtRec!f3) - 4)
                LMONTH = Right(TxtRec!f3, 3)
            End If
        End If
        lyear = Year(LSCondate)
    End If
    

    LOConNo = TxtRec!F5
    
    If GUniqClientId = "PRM-MUM" Then
        If MOPEN = "C" Then
            LBQty = TxtRec!F9
            LBRate = IIf(IsNull(TxtRec!F13), 0, TxtRec!F13)
        Else
            LBQty = TxtRec!F8
            LBRate = IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)
        End If
   Else
        If MOPEN = "C" Then
            If LSPtyContype = "B" Then
                LSPtyContype = "S"
            Else
                LSPtyContype = "B"
            End If
            LBQty = TxtRec!F8
            LBRate = IIf(IsNull(TxtRec!F13), 0, TxtRec!F13)
        ElseIf MOPEN = "S" Then
            LBQty = TxtRec!F7
            LBRate = IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)
        ElseIf MOPEN = "O" Then
            LBQty = TxtRec!F8
            LBRate = IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)
        End If
    End If
    LSRate = LBRate
End If

If lday = 0 Then
    lday = GET_DAYS(LMONTH, lyear, LSCondate)
End If
                    
LSTRCONDATE = DateValue(lday & "/" & LMONTH & "/" & lyear)
LSMaturity = DateValue(LSTRCONDATE)

                    If month(LSMaturity) < month(LSCondate) Then
                        lyear = (Year(LSCondate) + 1)
                        LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear
                        LSMaturity = DateValue(LSTRCONDATE)
                    End If
                    LMonthType = "M"
                    If (LBQty = 0 And LSQty = 0) Then Exit Sub
                    LOrdNo = ""
                    LSTRCONDATE = ltradedt
                    LContime = "" 'IIf(IsNull(TxtRec!F1), "", Right(TxtRec!F1, 5))
                    LEXHCODE = LSItemCode
                    lsparty = LBrokerCode
                    MSPARTY = LBrokerCode
                    If LenB(LEXHCODE) < 1 Then Exit Sub
                    
                    If Len(LSExCode) < 1 Then
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                    
                        mysql = "SELECT EXCHANGECODE FROM ITEMMAST WHERE  COMPCODE = '" & GCompCode & "' AND ITEMCODE = '" & LEXHCODE & "' "
                        TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                        If TRec.EOF Then
                            LSExCode = "NCDX"
                        Else
                            LSExCode = TRec!EXCHANGECODE
                        End If
                    End If

                    Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
                    If LenB(LSItemCode) < 1 Then Exit Sub
                    If (GUniqClientId = "1193BUL" Or GUniqClientId = "SVM-KHJ") And LSExCode = "MCX" And MOPEN <> "G" Then
                        Set TRec = Nothing
                        Set TRec = New ADODB.Recordset
                        mysql = "select reflot from itemmast where compcode= '" & GCompCode & "'  and (itemcode = '" & LEXHCODE & "' OR ITALIAS_1 = '" & LEXHCODE & "') "
                        TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                        If Not TRec.EOF Then
                            LBQty = IIf(IsNull(LBQty), 0, LBQty * TRec!REFLOT)
                            'Else
                             '   LBQty = IIf(IsNull(TxtRec!f8), 0, TxtRec!f8 * TRec!REFLOT)
                            'End If
                        End If
                    End If

                    Set TRec = Nothing
                    Set TRec = New ADODB.Recordset

                    mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
                    TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    If Not TRec.EOF Then
                       LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
                    Else
                       Set TRec = Nothing
                       Set TRec = New ADODB.Recordset
                       mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                       If LSInstType <> "FUT" Then
                           mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                           mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                       Else
                           mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                       End If
                       TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
                       If Not TRec.EOF Then
                           LSMaturity = TRec!MATURITY
                           LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
                       Else
                           If LSInstType = "FUT" Then
                                LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
                                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                    LSSaudaCode = LSExCode & " " & LSSaudaCode
                                    If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                                        LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                                        ImportIssues (LMsgBox)
                                        Exit Sub
                                    End If
                                End If
                            Else
                                LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
                                ImportIssues (LMsgBox)
                                Exit Sub
                            End If
0                            Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
                        End If
                    End If
                    LSSaudaID = Get_SaudaID(LSSaudaCode)

                    If LenB(LSSaudaCode) < 1 Then Exit Sub
                    If LSCondate > LSMaturity Then
                       LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
                       ImportIssues (LMsgBox)
                   End If
                   LSEXID = Get_ExID(LSExCode)

                    If LBQty <> 0 Or LSQty <> 0 Then
                      '  lbparty = Left(LPartyName, 6)
                        mbparty = Get_ACCT_EX(LSEXID, lbparty)
                        If LenB(mbparty) < 1 Then
                            mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
                        End If
                        MSPARTY = lsparty
                        lbparty = mbparty
                        If LenB(mbparty) < 1 Then
                            LMsgBox = " Client does Not Exist " & lbparty & ""
                            ImportIssues (LMsgBox)
                            Exit Sub
                        End If

                        If InStr(LBillExId, str(LSEXID)) = 0 Then
                            If LenB(LBillExId) > 0 Then
                                LBillExId = LBillExId & ","
                                LBillExId = LBillExId & str(LSEXID)
                            End If
                            If lminbilldate > LSCondate Then lminbilldate = LSCondate
                            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
                            DoEvents

                            If LBQty = 0 Then LBQty = LSQty
                            MCount = MCount + 1:
                            'LOConNo = MCount
                            
                            ''
                            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                            Cnn.Execute mysql
                            LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                            Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                        End If
                    End If

err1: If err.Number <> 0 Then
    MsgBox err.Description
End If

End Sub



Sub EXCEL_114(MCount As Long, lexceltype As Integer, ltradedt As Date)
    Dim TRec As ADODB.Recordset
    Dim mysql As String
    Dim LContime As String
    Dim LSTR As String
    Dim A As Integer
    Dim B As Integer
    Dim C As Integer
    Dim LSEXCCODE As String
    
    If Not IsNumeric(TxtRec!F9) Then Exit Sub
    LSExCode = vbNullString
    'LOConNo = TxtRec!F1:
    LOrdNo = LFolderName
    If lexceltype = 114 Then
        If LClientCode = "" Then
            lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
        Else
            lbparty = LClientCode
        End If
        LSPtyContype = UCase(Left(TxtRec!f6, 1))
    Else
        If LClientCode = "" Then
            lbparty = Trim(IIf(IsNull(TxtRec!F9), vbNullString, (TxtRec!F9))):
        Else
            lbparty = LClientCode
        End If
        If TxtRec!f11 = 1 Then
            LSPtyContype = "B"
        Else
            LSPtyContype = "S"
        End If
        ltradedt = DateValue(TxtRec!F20)
    End If
    LPartyName = lbparty
    LSCondate = ltradedt
    
    
    DoEvents
    LSTR = TxtRec!F7
    A = InStr(LSTR, "EQ")
    If TxtRec!F2 = "EQUITY" Then
        'LEXHCODE = Left(TxtRec!F7, Len(TxtRec!F7) - 3)
        LEXHCODE = TxtRec!F7 + " EQ"
        LSExCode = "EQ"
        LSMaturity = GFinEnd
        LSInstType = "CSH"
    ElseIf TxtRec!F1 = "BSE" Then
        LEXHCODE = TxtRec!F7
        LSExCode = "BEQ"
        LSMaturity = GFinEnd
        LSInstType = "CSH"
    ElseIf Left(TxtRec!F4, 2) = "EQ" Then
        LEXHCODE = TxtRec!f3
        LSExCode = "EQ"
        LSMaturity = GFinEnd
        LSInstType = "CSH"
    Else
        LSExCode = "NSE"
        A = InStr(LSTR, "-CE")
        If A = 0 Then
            A = InStr(LSTR, "-PE")
        End If
        If A <> 0 Then
            A = InStr(LSTR, "-")
            LEXHCODE = Left(LSTR, A - 1)
            If LEXHCODE = "MCDOWELL" Then
                LEXHCODE = Left(LSTR, A + 1)
                LSTRCONDATE = Mid(LSTR, A + 3, 7)
                LSTRCONDATE = Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/20" & Mid(LSTRCONDATE, 6, 2)
                LSMaturity = DateValue(LSTRCONDATE)
                A = InStr(A + 3, LSTR, "-")
                B = InStr(A + 3, LSTR, "-")
                LSStrike = Mid(LSTR, A + 1, Len(LSTR) - (A + 3))
            Else
                LEXHCODE = Left(LSTR, A - 1)
                LSTRCONDATE = Mid(LSTR, A + 1, 7)
                LSTRCONDATE = Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/20" & Mid(LSTRCONDATE, 6, 2)
                LSMaturity = DateValue(LSTRCONDATE)
                A = InStr(A + 1, LSTR, "-")
                B = InStr(A + 1, LSTR, "-")
                LSStrike = Mid(LSTR, A + 1, B - A - 1)
            End If

            
            LSInstType = "OPT"
            LSOptType = Right(LSTR, 2)

        Else
            LSInstType = "FUT"
            LEXHCODE = Left(LSTR, Len(TxtRec!F7) - 8)
            LSTR = Right(LSTR, 7)
            LSMaturity = DateValue(Left(LSTR, 2) & "/" & Mid(LSTR, 3, 3) & "/20" & Right(LSTR, 2))
        End If
    End If
    
    If lexceltype = 114 Then
        If Right(TxtRec!F9, 1) = "K" Then
            LBQty = Val(Left(TxtRec!F9, Len(TxtRec!F9) - 1)) * 1000
        Else
            LBQty = Val(TxtRec!F9)
        End If
        LBRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)):
        LOConNo = TxtRec!f12
    Else
        LBQty = Val(TxtRec!f12)
        LBRate = Val(IIf(IsNull(TxtRec!F13), 0, TxtRec!F13)):
        LOConNo = TxtRec!F1
    End If
    
    LSRate = LBRate
    lsparty = LBrokerCode
    
    MCount = LOConNo
    If Not IsNull(TxtRec!F20) Then
         LContime = Right(TxtRec!F20, 8)
    End If
    Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)
End Sub



Function proc_46()


'                            A = InStr(TxtRec!f9, "-")
 '                           A = InStr(UCase(TxtRec!f9), "-MX")
  '                          If A <> 0 Then
   '                             If Right(UCase(TxtRec!f9), 4) = "-MX2" Then
    '                                If Left(TxtRec!f9, 4) = "GOLD" Or Left(TxtRec!f9, 6) = "SILVER" Then
     '                                   LMonthType = "C": LEXHCODE = Left(TxtRec!f9, A - 1)
      '                              Else
       '                                 LMonthType = "N": LEXHCODE = Left(TxtRec!f9, A - 1)
        '                            End If
         '                       Else
          '                          LMonthType = "C": LEXHCODE = Left(TxtRec!f9, A - 1)
           '                     End If
            '                Else
             '                   A = InStr(TxtRec!f9, "-")
              '                  'If A = InStr(A + 1, TxtRec!F9, "-") Then
               '                 If Left(TxtRec!f9, 5) = "MCDOW" Or Left(TxtRec!f9, 6) = "BAJAJ-" Then
                '                    A = InStr(A + 1, TxtRec!f9, "-"): LEXHCODE = Left(TxtRec!f9, A - 1)
                 '                   B = Len(TxtRec!f9): LMONTH = Mid(TxtRec!f9, A + 1, B - A)
                  '              Else
                   '                 LEXHCODE = Left(TxtRec!f9, A - 1): B = Len(TxtRec!f9): C = InStr(UCase(TxtRec!f9), "-IDX")
                    '                If C <> 0 Then
                     '                   LMONTH = Mid(TxtRec!f9, A + 4, B - A)
                      '              Else
                       '                 LMONTH = Mid(TxtRec!f9, A + 1, B - A)
                        '            End If
                         '       End If
                          '      LYEAR = "2021": LSTRCONDATE = "28" & "/" & LMONTH & "/" & LYEAR: LSMaturity = DateValue(LSTRCONDATE)
                           '     If month(LSMaturity) < month(LSCondate) Then
                            '        LYEAR = (Year(LSCondate) + 1): LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & LYEAR: LSMaturity = DateValue(LSTRCONDATE)
                             '   End If
'                                LMonthType = "M"
 '                           End If
        End Function




Function proc_52()

'                        LSExCode = vbNullString
 '                       If IsNull(TxtRec!F1) Then GoTo EFlag_Next
  '                      If Not IsNumeric(TxtRec!f18) Then GoTo EFlag_Next
   '                     LOConNo = TxtRec!f3:                        LOrdNo = (TxtRec!F4 & vbNullString)
    '                    LSTRCONDATE = Left$(TxtRec!f9, 8): LSTRCONDATE = Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 5, 2) & "/" & Left(LSTRCONDATE, 4)
     '                   LSCondate = DateValue(LSTRCONDATE): lcontime = Right(TxtRec!f9, Len(TxtRec!f9) - 9): LSPtyContype = UCase(Left(TxtRec!f16, 1))
      '                  LBQty = Val(TxtRec!f18): LBRate = Val(TxtRec!f20): LSRate = LBRate
       '                 If GUniqClientId = "AARNAV2" Then
        '                    lbparty = (TxtRec!F22 & vbNullString):
         '                   LPartyName = lbparty & " "
          '              Else
           '                 lbparty = (TxtRec!F30 & vbNullString):
            '                LPartyName = lbparty & " "
             '           End If
              '          A = InStr(TxtRec!F13, "-")
'                        If A = 0 Then
 '                           LEXHCODE = TxtRec!F13
  '                      Else
   '                         LEXHCODE = Left(TxtRec!F13, A - 1)
    '                    End If
     '                   If InStr(TxtRec!F14, "-") Then
      '                      LSTRCONDATE = Left(TxtRec!F14, 2) & "/" & Mid(TxtRec!F14, 4, 3) & "/20" & Right(TxtRec!F14, 2)
       '                 ElseIf InStr(TxtRec!F14, "/") Then
        '                    LSTRCONDATE = TxtRec!F14
         '               Else
          '                  LSTRCONDATE = Left(TxtRec!F14, 2) & "/" & Mid(TxtRec!F14, 3, 3) & "/" & Right(TxtRec!F14, 4)
           '             End If
            '            If Not IsDate(LSTRCONDATE) Then
             '               LMsgBox = LSTRCONDATE & " " & TxtRec!F14 & "": ImportIssues (LMsgBox)
              '          End If
               '         LSMaturity = DateValue(LSTRCONDATE):   LSExCode = TxtRec!F11: LSEXID = Get_ExID(LSExCode)
                '        If LSEXID = 0 Then
                 '           LMsgBox = "Exchange not Defined Please Create Exchnage": ImportIssues (LMsgBox): GoTo EFlag_Next
'                        End If
 '                       If GUniqClientId = "AARNAV2" Then
  '                          LSTR = LSExCode & " " & LEXHCODE
   '                     Else
    '                        LSTR = LEXHCODE
     '                   End If
      '                  LLOT = 1
       '                 mysql = "SELECT ITEMCODE,ITEMID,LOT FROM ITEMMAST WHERE EXID =" & LSEXID & " AND ITEMCODE ='" & LSTR & "'": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
        '                If TRec.EOF Then
         '                   LMsgBox = "Creating new Itemcode " & LSTR & " " & LSExCode & " " & LSEXID & ""
          '                  ImportIssues (LMsgBox): Call PInsert_ItemMast(LSTR, LSTR, 1, LEXHCODE, LSExCode, vbNullString, vbNullString, 1, vbNullString, "Y", "Y", "Y", DateValue(GFinBegin), LSEXID)
           '                 LSItemid = Get_ITEMID(LSTR): LSItemCode = LSTR
            '            Else
             '               LSItemCode = TRec!itemcode: LSItemid = TRec!itemid: LLOT = TRec!LOT
              '          End If
               '         If LSItemid = 0 Then
                '            LMsgBox = "Item not Defined Please Create Item " & LSTR & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                 '       End If
                  '      mysql = "SELECT SAUDACODE,SAUDAID FROM SAUDAMAST WHERE ITEMID  =" & LSItemid & " AND MATURITY  ='" & Format(LSMaturity, "YYYY/MM/DD") & "'": Set TRec = Nothing: Set TRec = New ADODB.Recordset: TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                   '     If TRec.EOF Then
                    '        LSTR = LSItemCode & " " & Left(LSMaturity, 2) & " " & Left(MonthName(month(LSMaturity)), 3) & " " & Str(Year(LSMaturity))
'                            Call PInsert_Saudamast(LSTR, LSTR, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
 '                           LSSaudaID = Get_SaudaID(LSTR): LSSaudaCode = LSTR
  '                      Else
   '                         LSSaudaCode = TRec!saudacode: LSSaudaID = TRec!SAUDAID
    '                    End If
     '                   If LSSaudaID = 0 Then
      '                      LMsgBox = "Contract  not Defined Please Create new contract " & LSTR & LEXHCODE & "": ImportIssues (LMsgBox): GoTo EFlag_Next
       '                 End If
        '                LUserId = TxtRec!F2: lsparty = LExCont
'
End Function


Function EXCEL41()
'                        LSExCode = vbNullString
 '                       If IsNull(TxtRec!F5) Then GoTo EFlag_Next
  '                      If Not IsNumeric(TxtRec!F5) Then GoTo EFlag_Next
   ''                     LSTR = Right(TxtRec!f3, 3):
     '                   If LSTR = "FUT" Then
      '                      LSInstType = "FUT":                            LSTR = Right(TxtRec!f3, 8):
       '                     LStrMonth = Mid(LSTR, 3, 3):                   LYEAR = Val("20" & Left(LSTR, 2))
        '                    A = Len(TxtRec!f3):                            LEXHCODE = Mid(TxtRec!f3, 1, A - 8)
         '                   LSMaturity = DateValue("20/" & LStrMonth & "/" & LYEAR)
          '              Else
           '                 LSInstType = "OPT": A = InStr(TxtRec!f3, "2"): LSTR = Mid(TxtRec!f3, A, Len(TxtRec!f3)): LEXHCODE = Left(TxtRec!f3, A - 1)
            '                LSOptType = Right(LSTR, 2): LYEAR = Val("20" & Left(LSTR, 2)): LMONTH = Val(Mid(LSTR, 3, 1)): LDAY = Val(Mid(LSTR, 4, 2))
             '               LSMaturity = DateValue(LDAY & "/" & LMONTH & "/" & LYEAR): LSStrike = Val(Mid(LSTR, 6, Len(LSTR) - 2))
              '          End If
               '         LOConNo = Trim(TxtRec!f8): LOrdNo = (TxtRec!f10 & vbNullString): LSCondate = DateValue(Left(TxtRec!F7, 10))
                '        lcontime = Mid(TxtRec!F7, 11, Len(TxtRec!F7)):  LSPtyContype = UCase(Left(TxtRec!F4, 1))
                 '       LBQty = Val(TxtRec!F5): LBRate = Val(TxtRec!f6): lbparty = Trim(IIf(IsNull(TxtRec!F11), vbNullString, (TxtRec!F11))):
                  '      LPartyName = lbparty: LSRate = LBRate: LOrdNo = Trim(TxtRec!f10)
                   '     DoEvents
End Function




Function EXCEL25()
'                        If IsNull(TxtRec!F7) Then GoTo EFlag_Next
 '                       lsparty = LBrokerCode
  '                      If Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s") Then GoTo EFlag_Next
   '                     LOConNo = TxtRec!F1:                        LOrdNo = (TxtRec!f3 & vbNullString)
    '                    LPartyName = TxtRec!F5:                     LSTRCONDATE = Left$(TxtRec!f6, 10)
     '                   lcontime = Right(TxtRec!f6, Len(TxtRec!f6) - 11)
      '                  lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
       ''                 LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
         '               LPtyContype = UCase(Left(TxtRec!F7, 1))
            '            A = InStr(TxtRec!f9, "-")
          '              If LSExCode = "REAL" Then A = 0
           '             If A = 0 Then
                    '        If Left(TxtRec!f9, 4) = "GOLD" Then
             '                   LEXHCODE = "GOLD-" & Right(TxtRec!f9, 5)
              '                  LYEAR = Year(LSCondate)
               '                 LCMONTH = Mid(TxtRec!f9, 5, 3)
                '                LSTRCONDATE = "28" & "/" & Mid(TxtRec!f9, 5, 3) & "/" & LYEAR
                 '               LSMaturity = DateValue(LSTRCONDATE)
                  '              If month(LSMaturity) < month(LSCondate) Then
                   '                 LYEAR = (Year(LSCondate) + 1)
                                    'LSTRCONDATE = "01" & "/" & month(LSMaturity) & "/" & LYEAR
'                                    LSMaturity = DateValue(LSTRCONDATE)
 '                               End If
  '                          Else
   ''                             LEXHCODE = Left$(TxtRec!f9, Len(TxtRec!f9) - 3)
     '                           LSTRCONDATE = Right$(TxtRec!f9, 3)
      '                          LCMONTH = Left(LSTRCONDATE, 1)
       '                         LYEAR = "20" & Right(LSTRCONDATE, 2)
        ''                        LMONTH = Get_CMX_Month(Left(LSTRCONDATE, 1))
          '                      LSTRCONDATE = "28" & "/" & LMONTH & "/" & LYEAR
           '                     LSMaturity = DateValue(LSTRCONDATE)
            '                End If
             '           Else
              '              LEXHCODE = Trim(Left(TxtRec!f9, A - 1))
               '             LSTRCONDATE = Right(TxtRec!f9, 3)
                '            LCMONTH = Left(LSTRCONDATE, 1)
                 '           LYEAR = "20" & Right(LSTRCONDATE, 2)
                  '          LMONTH = Get_CMX_Month(Left(LSTRCONDATE, 1))
                   '         LSTRCONDATE = "28" & "/" & LMONTH & "/" & LYEAR
                    '        LSMaturity = DateValue(LSTRCONDATE)
                     '   End If
                      '  If Right(TxtRec!f10, 1) = "K" Then
'                            LBQty = Val(Left(TxtRec!f10, Len(TxtRec!f10) - 1)) * 1000
 '                       Else
  ''                          LBQty = Val(TxtRec!f10)
    '                    End If
     '                   LBRate = Val(IIf(IsNull(TxtRec!F11), 0, TxtRec!F11)):
      '                  LSRate = LBRate
       '                 'LSParty = LExCont
'
End Function

Sub EXCEL_116(MCount As Long, lexceltype As Integer, ltradedt As Date, LClientCode As String)
    Dim TRec As ADODB.Recordset
    Dim mysql As String
    Dim LContime As String
    Dim LSTR As String
    Dim LSTR2 As String
    Dim A As Integer
    Dim B As Integer
    Dim C As Integer
    Dim lday As Integer
    Dim LSEXCCODE As String
    Dim mbparty As String
    LContime = ""
    
    If lexceltype = 116 Then
        LOrdNo = LFolderName
        If Not IsNumeric(TxtRec!F1) Then Exit Sub
        LSExCode = vbNullString
        'LOConNo = TxtRec!F1:
        If LClientCode = "" Then
            lbparty = Trim(IIf(IsNull(TxtRec!F1), vbNullString, (TxtRec!F4))):
        Else
            lbparty = LClientCode
        End If
        LSCondate = DateValue(TxtRec!F5)
        LSTR = TxtRec!F2
        A = InStr(LSTR, "MCX")
        If A <> 0 Then
        'LEXHCODE = Left(TxtRec!F7, Len(TxtRec!F7) - 3)
            A = InStr(LSTR, "|")
            LEXHCODE = Left(LSTR, A - 1)
            LSExCode = "MCX"
            LSTR = Mid(LSTR, A + 1, 9)
            LSMaturity = DateValue(Left(LSTR, 2) & "/" & Mid(LSTR, 3, 3) & "/" & Right(LSTR, 4))
            LSInstType = "FUT"
        End If
        LSTR = TxtRec!F2
        A = InStr(LSTR, "NSE")
        If A <> 0 Then
        'LEXHCODE = Left(TxtRec!F7, Len(TxtRec!F7) - 3)
            A = InStr(LSTR, "|")
            LEXHCODE = Left(LSTR, A - 1)
            LSExCode = "NSE"
            LSTR = Mid(LSTR, A + 1, 9)
            LSMaturity = DateValue(Left(LSTR, 2) & "/" & Mid(LSTR, 3, 3) & "/" & Right(LSTR, 4))
            LSInstType = "FUT"
        End If
      
        LBQty = Val(TxtRec!f3)
        LBRate = Val(IIf(IsNull(TxtRec!F4), 0, TxtRec!F4)):
        LOConNo = Trim(TxtRec!F1)
        If LBQty < 0 Then
            LBQty = LBQty * -1
            LSPtyContype = "S"
        Else
            LSPtyContype = "B"
        End If
        LSRate = LBRate
    ElseIf lexceltype = 130 Or lexceltype = 131 Then ' money ocean

        LSTRCONDATE = Left(TxtRec!F8, 10)
        LSCondate = DateValue(LSTRCONDATE)
        

        lbparty = Trim(TxtRec!f3)
        A = InStr(TxtRec!F2, ":")
        lbparty = Left(TxtRec!F2, A - 1)
        LPartyName = Trim(Mid(TxtRec!F2, A + 1, Len(TxtRec!F2) - A)) & " " & lbparty
        LSTR = TxtRec!F5
        LSInstType = "FUT"
        LSExCode = Left(TxtRec!F5, 3)
            If lexceltype = "131" Or TxtRec!F5 = "Commodities" Or TxtRec!F5 = "Spots" Or InStr(TxtRec!F5, "Comex") Or InStr(TxtRec!F5, "Crypto") Or InStr(TxtRec!F5, "DINR") Or InStr(TxtRec!F5, "Stocks") Or InStr(TxtRec!F5, "Metals") Or InStr(TxtRec!F5, "Energies") Or InStr(TxtRec!F5, "Nymex") Or InStr(TxtRec!F5, "Indices") Then
                LSExCode = "CMX"
            ElseIf InStr(TxtRec!F5, "NSE OPTION") Or InStr(TxtRec!F5, "NIFTY OPTION") Then
                LSExCode = "NSE"
                LSInstType = "OPT"
            ElseIf LSExCode = "Oth" Or LSExCode = "SGX" Or InStr(TxtRec!F5, "NSE") Or InStr(TxtRec!F5, "SGX NIFTY") Then
                LSExCode = "NSE"
            ElseIf LSExCode = "MCX" Or LSExCode = "ALU" Then
                LSExCode = "MCX"
            ElseIf TxtRec!F5 = "NCDEX" Then
                LSExCode = "NCDX"
            Else
                MsgBox "Parent Exchange Missing"
            End If


            A = InStr(TxtRec!F4, LSExCode)
            
            If InStr(UCase(TxtRec!F4), " JAN") <> 0 Or Right(UCase(TxtRec!F4), 3) = "JAN" Then
                A = InStr(UCase(TxtRec!F4), "JAN")
            ElseIf InStr(UCase(TxtRec!F4), " FEB") <> 0 Or Right(UCase(TxtRec!F4), 3) = "FEB" Then
                A = InStr(UCase(TxtRec!F4), "FEB")
            ElseIf (InStr(UCase(TxtRec!F4), " MAR") <> 0 Or Right(UCase(TxtRec!F4), 3) = "MAR") And (Left(TxtRec!F4, 6) <> "MARICO" And Left(TxtRec!F4, 6) <> "MARUTI") Then
                A = InStr(UCase(TxtRec!F4), "MAR")
            ElseIf InStr(UCase(TxtRec!F4), " APR") <> 0 Or Right(UCase(TxtRec!F4), 3) = "APR" Then
                A = InStr(UCase(TxtRec!F4), "APR")
            ElseIf InStr(UCase(TxtRec!F4), " MAY") <> 0 Or Right(UCase(TxtRec!F4), 3) = "MAY" Then
                A = InStr(UCase(TxtRec!F4), "MAY")
            ElseIf InStr(UCase(TxtRec!F4), " JUN") <> 0 Or Right(UCase(TxtRec!F4), 3) = "JUN" Then
                A = InStr(UCase(TxtRec!F4), "JUN")
            ElseIf InStr(UCase(TxtRec!F4), " JUL") <> 0 Or Right(UCase(TxtRec!F4), 3) = "JUL" Then
                A = InStr(UCase(TxtRec!F4), "JUL")
            ElseIf InStr(UCase(TxtRec!F4), " AUG") <> 0 Or Right(UCase(TxtRec!F4), 3) = "AUG" Then
                A = InStr(UCase(TxtRec!F4), "AUG")
            ElseIf InStr(UCase(TxtRec!F4), " SEP") <> 0 Or Right(UCase(TxtRec!F4), 3) = "SEP" Then
                A = InStr(UCase(TxtRec!F4), "SEP")
            ElseIf InStr(UCase(TxtRec!F4), " OCT") <> 0 Or Right(UCase(TxtRec!F4), 3) = "OCT" Then
                A = InStr(UCase(TxtRec!F4), "OCT")
            ElseIf InStr(UCase(TxtRec!F4), " NOV") <> 0 Or Right(UCase(TxtRec!F4), 3) = "NOV" Then
                A = InStr(UCase(TxtRec!F4), "NOV")
            ElseIf InStr(UCase(TxtRec!F4), " DEC") <> 0 Or Right(UCase(TxtRec!F4), 3) = "DEC" Then
                A = InStr(UCase(TxtRec!F4), "DEC")
            ElseIf A = 0 Then
                A = 999
            End If
            If A = 999 Then
                LEXHCODE = TxtRec!F4
                LSMaturity = GFinEnd
            Else
                B = InStr(TxtRec!F4, LSExCode)
                If B <> 0 Then
                    LEXHCODE = Trim(Left(TxtRec!F4, B - 2))
                Else
                    LEXHCODE = Trim(Left(TxtRec!F4, A - 1))
                End If
                If InStr(TxtRec!F4, ":MCX:") = 0 Then
                    LMONTH = Mid(TxtRec!F4, A, 3)
                Else
                    LMONTH = Right(TxtRec!F4, 3)
                End If
                lyear = str(Year(LSCondate))
                lday = GET_DAYS(LMONTH, lyear, ltradedt)
                LSMaturity = DateValue(Left(lday, 2) & "/" & LMONTH & "/" & Right(lyear, 4))
            End If
            
            'If A <> 0 Then
            '    LEXHCODE = Trim(Left(TxtRec!f4, A - 1))
            '    LMONTH = Left(Trim(Right(TxtRec!f4, 4)), 3)
            'Else
            '    If Right(TxtRec!f4, 6) = "(20/4)" Then
            '        LEXHCODE = Trim(Left(TxtRec!f4, Len(TxtRec!f4) - 10))
            '        LMONTH = Left(Trim(Right(TxtRec!f4, 10)), 3)
            '    Else
            '        LEXHCODE = Trim(Left(TxtRec!f4, Len(TxtRec!f4) - 4))
            '        LMONTH = Left(Trim(Right(TxtRec!f4, 4)), 3)
            '    End If
            'End If
            'if LEXHCODE
            
            'mbparty = NewParty(LSExCode, lbparty, lbparty & " " & LSExCode, "", True)
            'If LenB(mbparty) < 1 Then
            '    LMsgBox = " Please Create Account For  " & lbparty & ""
            '    ImportIssues (LMsgBox)
            'End If
            'lbparty = mbparty
            If LSInstType = "OPT" Then
                If Right(TxtRec!F4, 1) = "P" Then
                    LSOptType = "PE"
                Else
                    LSOptType = "CE"
                End If
                If Left(TxtRec!F4, 3) = "NIY" Then
                    LEXHCODE = "NIFTY"
                    If IsNumeric(Mid(TxtRec!F4, 4, 2)) Then
                       lday = Mid(TxtRec!F4, 4, 2)
                       LMONTH = Mid(TxtRec!F4, 6, 3)
                       LSStrike = Mid(TxtRec!F4, 9, 5)
                   Else
                        lday = Mid(TxtRec!F4, 4, 1)
                       LMONTH = Mid(TxtRec!F4, 5, 3)
                       LSStrike = Mid(TxtRec!F4, 8, 5)
                   End If
                Else
                    LEXHCODE = "BANKNIFTY"
                    lday = Mid(TxtRec!F4, 5, 2)
                    If Mid(TxtRec!F4, 7, 4) = "AUGP" Then
                        LMONTH = Mid(TxtRec!F4, 7, 3)
                        LSStrike = Mid(TxtRec!F4, 11, 5)
                     Else
                        LMONTH = Mid(TxtRec!F4, 7, 3)
                        LSStrike = Mid(TxtRec!F4, 10, 5)
                     
                     End If
                End If
                lyear = str(Year(LSCondate))
                
                
                LSMaturity = DateValue(Left(lday, 2) & "/" & LMONTH & "/" & Right(lyear, 4))
                LMONTH = month(LSMaturity)
                If month(LSCondate) > LMONTH Then
                      lyear = lyear + 1
                      LSMaturity = DateValue(Left(lday, 2) & "/" & LMONTH & "/" & Right(lyear, 4))
                End If
                
            End If


            LSPtyContype = Left(TxtRec!F7, 1)
            LBQty = TxtRec!F9
             LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)):
            LOConNo = TxtRec!f6
            LSRate = LBRate
            LContime = ""
    ElseIf lexceltype = 132 Then ' goldmine

        LSTRCONDATE = Left(TxtRec!F13, 10)
        LSCondate = DateValue(LSTRCONDATE)

        lbparty = Trim(TxtRec!f3)
        A = InStr(TxtRec!f3, "(")
        B = InStr(TxtRec!f3, ")")
        C = InStr(A + 1, TxtRec!f3, "(")
        If C > 0 Then
            A = C
            B = InStr(C + 1, TxtRec!f3, ")")
        End If
        LSExCode = ""
        LPartyName = Left(TxtRec!f3, A - 1)
        lbparty = Mid(TxtRec!f3, A + 1, B - A - 1)
        LPartyName = LPartyName & lbparty
        A = 0
        LSInstType = "FUT"
        LEXHCODE = Left(TxtRec!F4, Len(TxtRec!F4) - 10)
        If Right(Trim(LEXHCODE), 3) = " CE" Or Right(Trim(LEXHCODE), 3) = " PE" Then
            LSInstType = "OPT"
            LSOptType = Right(Trim(LEXHCODE), 2)
            LSTR = Mid(LEXHCODE, InStr(LEXHCODE, " ") + 1, Len(LEXHCODE) - InStr(LEXHCODE, " "))
            LEXHCODE = Left(LEXHCODE, InStr(LEXHCODE, " ") - 1)
            LSStrike = Left(LSTR, InStr(LSTR, " ") - 1)
        End If
        
        LSPtyContype = Left(TxtRec!F5, 1)
        LBQty = Val(TxtRec!F8)
        LBRate = Val(IIf(IsNull(TxtRec!F9), 0, Val(TxtRec!F9))):
        LSRate = LBRate
        LContime = TxtRec!F2

        
        LOConNo = MCount + 1
        LSTRCONDATE = Right(TxtRec!F4, 9)
        LSMaturity = DateValue(Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 3, 3) & "/" & Right(LSTRCONDATE, 4))
    
    ElseIf lexceltype = 133 Then ' vertex

        LSTRCONDATE = Left(TxtRec!F1, 10)
        LSCondate = DateValue(LSTRCONDATE)

        A = InStr(TxtRec!F5, "(")
        B = InStr(TxtRec!F5, ")")
        lbparty = Left(TxtRec!F5, A - 1)
        LPartyName = Mid(TxtRec!F5, A + 1, B - A - 1)
        LSExCode = ""
        

        If InStr(TxtRec!F8, "MCX") <> 0 Then
            LSExCode = "MCX"
            LMONTH = Right(Left(TxtRec!F8, Len(TxtRec!F8) - 4), 3)
            LEXHCODE = Left(TxtRec!F8, Len(TxtRec!F8) - 8)
        Else
            LSExCode = "NSE"
            LMONTH = Right(TxtRec!F8, 3)
            LEXHCODE = Left(TxtRec!F8, Len(TxtRec!F8) - 4)
        End If
            
        lyear = str(Year(LSCondate))
        lday = GET_DAYS(LMONTH, lyear, ltradedt)
        LSMaturity = DateValue(Left(lday, 2) & "/" & LMONTH & "/" & Right(lyear, 4))
        LSInstType = "FUT"
        LSPtyContype = Left(TxtRec!f6, 1)
        LBQty = TxtRec!F7
        If LSPtyContype = "B" Then
            LBRate = Val(IIf(IsNull(TxtRec!F9), 0, TxtRec!F9)):
            LSRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)):
        Else
            LSRate = Val(IIf(IsNull(TxtRec!F9), 0, TxtRec!F9)):
            LBRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)):
        End If
        LOConNo = TxtRec!F2
        LContime = Right(TxtRec!F1, 5)
        
    ElseIf lexceltype = 134 Then ' vertex New

        LSTRCONDATE = Left(TxtRec!F2, 10)
        LSCondate = DateValue(LSTRCONDATE)

        A = InStr(TxtRec!f6, ":")
        lbparty = Left(TxtRec!f6, A - 1)
        LPartyName = Mid(TxtRec!f6, A + 1, Len(TxtRec!f6) - A)
        LSExCode = ""


        If InStr(TxtRec!F8, "MCX") <> 0 Then
            LSExCode = "MCX"
            A = InStr(TxtRec!F8, "MCX")
            LMONTH = Left(Trim(Right(TxtRec!F8, 4)), 3)
            LEXHCODE = Left(TxtRec!F8, A - 2)
        Else
            LSExCode = "NSE"
            LMONTH = Right(TxtRec!F8, 3)
            LEXHCODE = Left(TxtRec!F8, Len(TxtRec!F8) - 4)
        End If
            
        lyear = str(Year(LSCondate))
        lday = GET_DAYS(LMONTH, lyear, ltradedt)
        LSMaturity = DateValue(Left(lday, 2) & "/" & LMONTH & "/" & Right(lyear, 4))
        LSInstType = "FUT"
        LSPtyContype = Left(TxtRec!F5, 1)
        LBQty = TxtRec!F7
        If LSPtyContype = "B" Then
            If TxtRec!F4 = "Close" Then
                LBRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)):
                LSRate = 0
            Else
                LBRate = Val(IIf(IsNull(TxtRec!F9), 0, TxtRec!F9)):
                LSRate = 0
            End If
        Else
            If TxtRec!F4 = "Close" Then
                LSRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10)):
                LBRate = 0
            Else
                LSRate = Val(IIf(IsNull(TxtRec!F9), 0, TxtRec!F9)):
                LBRate = 0
            End If
        End If
        LOConNo = TxtRec!F1
        LContime = Right(TxtRec!F2, 5)
            

    ElseIf lexceltype = 114 Then
        If LClientCode = "" Then
            lbparty = Trim(IIf(IsNull(TxtRec!F9), vbNullString, (TxtRec!F9))):
        Else
            lbparty = LClientCode
        End If
        LSPtyContype = UCase(Left(TxtRec!f6, 1))
    ElseIf lexceltype = 138 Then ' SKYLINE

        If Left(UCase(TxtRec!F5), 1) <> "B" And Left(UCase(TxtRec!F5), 1) <> "S" Then Exit Sub

        LSTRCONDATE = Mid(TxtRec!F14, 1, 2) + "/" + Mid(TxtRec!F14, 4, 2) + "/" + Mid(TxtRec!F14, 7, 4)
        LSCondate = DateValue(LSTRCONDATE)

        lbparty = Trim(TxtRec!F1)
        
        LSExCode = ""
        LPartyName = lbparty & " " & lbparty
        LSInstType = "FUT"
    
        LEXHCODE = TxtRec!F2
        LSTR = Right(TxtRec!F2, 2)
        
        LSTR2 = Left(LEXHCODE, Len(LEXHCODE) - 2)
        If (Left(LSTR, 2) = "CE" Or Left(LSTR, 2) = "PE") And IsNumeric(Right(LSTR2, 1)) Then
           
            If IsNumeric(Right(LSTR2, 1)) Then
                LSInstType = "OPT"
                LSOptType = Left(LSTR, 2)
               
                If IsNumeric(Right(LSTR2, 5)) Then
                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 7)
                    LSStrike = Right(LSTR2, 5)
                ElseIf IsNumeric(Right(LSTR2, 4)) Then
                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 6)
                    LSStrike = Right(LSTR2, 4)
                ElseIf IsNumeric(Right(LSTR2, 3)) Then
                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 5)
                    LSStrike = Right(LSTR2, 3)
                ElseIf IsNumeric(Right(LSTR2, 2)) Then
                    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 4)
                    LSStrike = Right(LSTR2, 2)
                End If
            End If

        End If
        LSPtyContype = Left(UCase(TxtRec!F5), 1)
        LBQty = Val(TxtRec!F4)
        LBRate = Val(IIf(IsNull(TxtRec!F7), 0, Val(TxtRec!F7))):
        LSRate = LBRate
        LContime = Right(TxtRec!F14, 8)

        
        LOConNo = MCount + 1
        LSTRCONDATE = Right(TxtRec!f3, 11)
        LSMaturity = DateValue(Left(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 4, 3) & "/20" & Right(LSTRCONDATE, 2))
    ElseIf lexceltype = 117 Then
        If TxtRec!f3 = "B" Or TxtRec!f3 = "S" Then
            LSPtyContype = Val(TxtRec!f3)
            LSTRCONDATE = Left(TxtRec!F2, 10)
            LSCondate = DateValue(LSTRCONDATE)
            lbparty = LClientCode
            LSTR = TxtRec!F5
            LSExCode = ""
            A = InStr(TxtRec!F5, "MCX")
            If A <> 0 Then
                LSExCode = "MCX"
                LSTR = Left(LSTR, A - 1)
            End If
            LEXHCODE = Trim(Left(LSTR, Len(LSTR) - 4))
            LMONTH = Trim(Right(LSTR, 4))
            'LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 4)
            lyear = str(Year(LSCondate))
            
            lday = GET_DAYS(LMONTH, lyear, ltradedt)
            LSMaturity = DateValue(Left(lday, 2) & "/" & LMONTH & "/" & Right(lyear, 4))
            LSInstType = "FUT"
            
            LBQty = TxtRec!F4
            LBRate = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):
            LOConNo = TxtRec!F1
            LSRate = LBRate
        Else
            LSTRCONDATE = Left(TxtRec!F1, 8)
            LSTRCONDATE = Right(LSTRCONDATE, 2) + "/" + Mid(LSTRCONDATE, 4, 2) + "/20" + Left(LSTRCONDATE, 2)
            LSCondate = DateValue(LSTRCONDATE)
            lbparty = LClientCode
            LSTR = TxtRec!F4
            LSExCode = ""
            A = InStr(TxtRec!F4, "MCX")
            If A <> 0 Then
                LSExCode = "MCX"
                LSTR = Trim(Left(LSTR, A - 1))
            End If
            LEXHCODE = Trim(Left(LSTR, Len(LSTR) - 4))
            LMONTH = Trim(Right(LSTR, 4))
            'LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 4)
            lyear = str(Year(LSCondate))

            lday = GET_DAYS(LMONTH, lyear, ltradedt)
            LSMaturity = DateValue(Left(lday, 2) & "/" & LMONTH & "/" & Right(lyear, 4))
            LSInstType = "FUT"
            LSPtyContype = TxtRec!f6
            LBQty = TxtRec!F5
            LBRate = Val(IIf(IsNull(TxtRec!F8), 0, TxtRec!F8)):
            LOConNo = TxtRec!f3
            LSRate = LBRate
        End If
    Else
        If LClientCode = "" Then
            lbparty = Trim(IIf(IsNull(TxtRec!F9), vbNullString, (TxtRec!F9))):
        Else
            lbparty = LClientCode
        End If
         LSRate = LBRate
       ' ltradedt = DateValue(TxtRec!F5)
    End If
    If Len(LPartyName) <= 0 Then
        LPartyName = lbparty
    End If
    lsparty = LBrokerCode
    
    'mbparty = NewParty(LSExCode, lbparty, LPartyName & " " & LSExCode, "", True)

    'MCount = LOConNo
    Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)
    DoEvents
    If lexceltype = 117 And TxtRec!f3 <> "B" And TxtRec!f3 <> "S" Then
        A = Len(Trim(LOConNo))
        LSTR = Left(Trim(str(LOConNo)), 1)
        If A = 7 Then
            LSTR = LSTR + "000000"
        ElseIf A = 8 Then
            LSTR = LSTR + "0000000"
        ElseIf A = 6 Then
            LSTR = LSTR + "00000"
        Else
            LSTR = LSTR + "0000"
        End If
        
        MCount = LOConNo - Val(LSTR)
        LSTRCONDATE = Left(TxtRec!F7, 8)
        LSTRCONDATE = Right(LSTRCONDATE, 2) + "/" + Mid(LSTRCONDATE, 4, 2) + "/20" + Left(LSTRCONDATE, 2)
        LSCondate = DateValue(LSTRCONDATE)
        If LSPtyContype = "B" Then
            LSPtyContype = "S"
        Else
            LSPtyContype = "B"
        End If
        LBRate = Val(IIf(IsNull(TxtRec!F9), 0, TxtRec!F9))
        LSRate = LBRate
        Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)
    End If
    
End Sub
Sub NEWARK(LSCondate As Date, MOPEN As String, Optional lclientid As String, Optional lsparty As String)
Dim LBQty As Double
Dim LSQty As Double
Dim LContime As String
Dim lday As Integer
Dim ltradedt As Date
Dim MSPARTY As String: Dim mbparty As String
Dim MCount As Integer
Dim LSConSno As Long
Dim TRec As ADODB.Recordset
Dim LUserId As String
Dim txteqrec As New ADODB.Recordset


LSExCode = ""
LBQty = 0: LSQty = 0

If MOPEN = "5" Then
    If IsNull(TxtRec!f11) Then Exit Sub
    If TxtRec!f11 <> "B" And TxtRec!f11 <> "S" Then Exit Sub
    
    
    '''
        LEXHCODE = UCase(Replace(TxtRec!F5, "LTD", "%"))
        LEXHCODE = UCase(Replace(LEXHCODE, "Limited", "%"))
        LEXHCODE = UCase(Replace(LEXHCODE, "LIMITED", "%"))
                        
        Set txteqrec = Nothing: Set txteqrec = New ADODB.Recordset
        txteqrec.Open "Select * from EQUITY WHERE upper(name) like '" & LEXHCODE & "'", Cnn, adOpenForwardOnly, adLockReadOnly
        If Not txteqrec.EOF Then
            LEXHCODE = txteqrec!symbol + " EQ"
        End If

    LSPtyContype = Left(TxtRec!f11, 1)
    LSExCode = "EQ"
    'LEXHCODE = TxtRec!F5 + " EQ"
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT ITEMCODE FROM CONTRACTMASTER WHERE EXCODE = '" & LSExCode & "' AND ITEMNAME = '" & LEXHCODE & "' "
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        LEXHCODE = TRec!ITEMCODE
    End If
    
   
    LOConNo = TxtRec!F15
    LSMaturity = GFinEnd
    LBQty = Abs(TxtRec!f19)
    LBRate = IIf(IsNull(TxtRec!F20), 0, TxtRec!F20)
    lbparty = TxtRec!F17
    LPartyName = lbparty & " " & lbparty
    LContime = TxtRec!f16
    MSPARTY = lsparty
    LSRate = LBRate
    LMonthType = "M"
    LSInstType = "CSH"
ElseIf MOPEN = "137" Then
    If IsNull(TxtRec!f11) Then Exit Sub
    If TxtRec!F9 <> "BUY" And TxtRec!F9 <> "SELL" Then Exit Sub
    
    LSExCode = TxtRec!F1
    lbparty = TxtRec!f3
    LPartyName = lbparty & " " & lbparty
    LEXHCODE = TxtRec!F4
    LSPtyContype = Left(TxtRec!F9, 1)
    LOConNo = TxtRec!F15
    LSMaturity = TxtRec!F5
    LBQty = Abs(TxtRec!F10)
    LBRate = TxtRec!f12
    LSRate = LBRate
    LContime = Right(TxtRec!f16, 8)
    LMonthType = "M"
    LSInstType = "FUT"

ElseIf MOPEN = "135" Then
    If IsNull(TxtRec!F10) Then Exit Sub
    lbparty = TxtRec!F2
    LOConNo = TxtRec!F4

    If MOPEN = "4" Then
        If TxtRec!F10 <> "Buy" And TxtRec!F10 <> "Sell" Then Exit Sub
        LEXHCODE = TxtRec!F8
        LSPtyContype = Left(TxtRec!F10, 1)
        If InStr(TxtRec!F7, ":") = 0 Then
            LSExCode = TxtRec!F7
        Else
            A = InStr(TxtRec!F7, ":")
            LSExCode = Left(TxtRec!F7, A - 1)
        End If
        If LSExCode = "DGCX" Or LSExCode = "CME" Then LSExCode = "CMX"
        
        LSMaturity = TxtRec!F9
        LBQty = Abs(TxtRec!f11)
        LBRate = IIf(IsNull(TxtRec!f12), 0, TxtRec!f12)
        
        LPartyName = lbparty & " " & lbparty
        LContime = ""
        MSPARTY = lsparty
        LSRate = LBRate
        LMonthType = "M"
        LSInstType = "FUT"
   Else
        If TxtRec!F17 <> "Buy" And TxtRec!F17 <> "Sell" Then Exit Sub
        If InStr(TxtRec!f11, ":") = 0 Then
            LSExCode = TxtRec!f11
        Else
            A = InStr(TxtRec!f11, ":")
            LSExCode = Left(TxtRec!f11, A - 1)
        End If
        If LSExCode = "DGCX" Or LSExCode = "CME" Then LSExCode = "CMX"
        LEXHCODE = TxtRec!F13
        LSMaturity = TxtRec!F14
        If Left(TxtRec!F15, 3) = "FUT" Then
            LSInstType = "FUT"
            LSStrike = 0
            LSOptType = ""
        Else
            LSInstType = "OPT"
            LSStrike = TxtRec!f22
            LSOptType = TxtRec!f16
        End If
        LSPtyContype = Left(TxtRec!F17, 1)
        LOConNo = Trim(str(TxtRec!f3)) + Trim(str(TxtRec!F4))
        LBQty = Abs(TxtRec!f19)
        LBRate = IIf(IsNull(TxtRec!F21), 0, TxtRec!F21)
        lbparty = TxtRec!f25
        LPartyName = lbparty & " " & lbparty
        LContime = ""
        MSPARTY = lsparty
        LSRate = LBRate
   End If
ElseIf MOPEN = "136" Then
    lbparty = lclientid
    LPartyName = lclientid
    LOConNo = TxtRec!f11
    If TxtRec!F7 <> "buy" And TxtRec!F7 <> "sell" Then Exit Sub
    
    LSPtyContype = UCase(Left(TxtRec!F7, 1))
    LSExCode = IIf(TxtRec!F5 <> "CDS", TxtRec!F4, "FX")
    LSMaturity = TxtRec!F14
    LBQty = Abs(TxtRec!F9)
    LBRate = TxtRec!F10
    LContime = Right(TxtRec!F13, 8)
    MSPARTY = lsparty
    LSRate = LBRate
    LMonthType = "M"
    LSInstType = "FUT"
    LSTR = Right(TxtRec!F14, 2) + UCase(Left(MonthName(month(TxtRec!F14)), 3))
    If InStr(TxtRec!F1, LSTR) = 0 Then
            LSTR = Right(TxtRec!F14, 2) + Trim(str(month(TxtRec!F14))) + IIf(Len(Trim(str(Day(TxtRec!F14)))) = 1, "0" + Trim(str(Day(TxtRec!F14))), Trim(str(Day(TxtRec!F14))))
            A = InStr(TxtRec!F1, LSTR)
        LEXHCODE = Left(TxtRec!F1, A - 1)
        LSTR = Mid(TxtRec!F1, A + Len(LSTR), Len(TxtRec!F1) - (A + Len(LSTR)) + 1)
        If Right(TxtRec!F1, 2) = "CE" Or Right(TxtRec!F1, 2) = "PE" Then
            LSStrike = Val(Left(LSTR, Len(LSTR) - 2))
            LSInstType = "OPT"
            LSOptType = Right(TxtRec!F1, 2)
        End If
    Else
        A = InStr(TxtRec!F1, LSTR)
        LEXHCODE = Left(TxtRec!F1, A - 1)
        LSTR = Mid(TxtRec!F1, A, Len(TxtRec!F1))
        LSInstType = "FUT"
        LSStrike = 0
        LSOptType = ""
        If Right(TxtRec!F1, 2) = "CE" Or Right(TxtRec!F1, 2) = "PE" Then
            LSStrike = Val(Mid(LSTR, 6, Len(TxtRec!F1) - 7))
            LSInstType = "OPT"
            LSOptType = Right(TxtRec!F1, 2)
        End If
    End If

Else
    If InStr(TxtRec!f11, ":") = 0 Then
         LSExCode = TxtRec!f11
    Else
      A = InStr(TxtRec!f11, ":")
      LSExCode = Left(TxtRec!f11, A - 1)
    End If
    LEXHCODE = TxtRec!F13
    If LSExCode <> "CQG" Then
        If TxtRec!F17 <> "Buy" And TxtRec!F17 <> "Sell" Then Exit Sub
    Else
        If TxtRec!f16 <> "Buy" And TxtRec!f16 <> "Sell" Then Exit Sub
    End If

    If LSExCode = "DGCX" Or TxtRec!f11 = "CQG" Then
        LSExCode = "CMX"
        If TxtRec!f11 = "CQG" Then
            LEXHCODE = TxtRec!F13
            LSMaturity = DateValue(TxtRec!F14)
            If Left(TxtRec!F15, 3) = "OPT" Then
                LSInstType = "OPT"
                LSStrike = TxtRec!F21
                LSOptType = TxtRec!f27
            End If
        Else
            A = InStr(TxtRec!F13, "-")
            If A = 0 Then
             LEXHCODE = TxtRec!F13
                
            Else
              LEXHCODE = Left(TxtRec!F13, A - 1)
              End If
            LSMaturity = DateValue(TxtRec!F14)
        End If
    ElseIf Left(LSExCode, 3) = "CME" Then
        LSExCode = "CMX"
        LSMaturity = DateValue(TxtRec!F14)
    ElseIf Left(LSExCode, 3) = "NSE" Then
        LSExCode = "NSE"
        LSMaturity = DateValue(TxtRec!F14)
    ElseIf Left(LSExCode, 3) = "SGX" Then
        LSExCode = "CMX"
        LEXHCODE = "SGXNIFTY"
        lyear = Year(LSCondate)
        LMONTH = Get_CMX_Month(Mid(TxtRec!F13, 3, 1))
        LSMaturity = DateValue(TxtRec!F14)
        'lstrcondate =
    Else
        LSMaturity = DateValue(TxtRec!F14)
    End If
    If TxtRec!f11 = "CQG" Then
        LBQty = TxtRec!F18
        LBRate = IIf(IsNull(TxtRec!F20), 0, TxtRec!F20)
        lbparty = TxtRec!f22
        LPartyName = TxtRec!f22
        LSPtyContype = Left(TxtRec!f16, 1)
    Else
        LBQty = TxtRec!f19
        LBRate = IIf(IsNull(TxtRec!F21), 0, TxtRec!F21)
        lbparty = TxtRec!f25
        LPartyName = TxtRec!f25
        LSPtyContype = Left(TxtRec!F17, 1)
    End If
    If Len(lclientid) > 0 Then
        lbparty = lclientid
        LPartyName = lclientid
    End If
    If MOPEN = "3" Then
        LOConNo = TxtRec!f3
    Else
        LOConNo = TxtRec!F4
    End If

    
    LContime = ""
    LOrdNo = ""
    MSPARTY = lsparty
    LSRate = LBRate
    LMonthType = "M"
    If TxtRec!f11 <> "CQG" Then
        If Left(TxtRec!F15, 3) = "OPT" Then
            LSInstType = "OPT"
            LSStrike = TxtRec!f22
            LSOptType = TxtRec!f16
        Else
            LSInstType = "FUT"
        End If
    End If
End If


Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
If LenB(LSItemCode) < 1 Then
    ImportIssues (LEXHCODE + " Script Missing")
    Exit Sub
End If

Set TRec = Nothing
Set TRec = New ADODB.Recordset
mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
If Not TRec.EOF And LSInstType <> "OPT" Then
    LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
Else
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
    If LSInstType <> "FUT" Then
        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE = '" & LSInstType & "' "
        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
    Else
        mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
    End If
    
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        LSMaturity = TRec!MATURITY
        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
    Else
        If LSInstType = "FUT" Then
            LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                LSSaudaCode = LSExCode & " " & LSSaudaCode
                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                    LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                    ImportIssues (LMsgBox)
                    Exit Sub
                End If
            End If
            Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
        Else
            LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
            'LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
            'ImportIssues (LMsgBox)
            'Exit Sub
        End If
        
    End If
End If
LSSaudaID = Get_SaudaID(LSSaudaCode)

If LenB(LSSaudaCode) < 1 Then Exit Sub
If LSCondate > LSMaturity Then
    LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
    ImportIssues (LMsgBox)
End If
LSEXID = Get_ExID(LSExCode)

If LBQty <> 0 Or LSQty <> 0 Then
    mbparty = Get_ACCT_EX(LSEXID, lbparty)
    If LenB(mbparty) < 1 Then
        mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
    End If
    lsparty = LBrokerCode
    MSPARTY = lsparty
    
    lbparty = mbparty
    If LenB(mbparty) < 1 Then
        LMsgBox = " Client does Not Exist " & lbparty & ""
        ImportIssues (LMsgBox)
        Exit Sub
    End If

    If InStr(LBillExId, str(LSEXID)) = 0 Then
        If LenB(LBillExId) > 0 Then
            LBillExId = LBillExId & ","
            LBillExId = LBillExId & str(LSEXID)
        End If
        If lminbilldate > LSCondate Then lminbilldate = LSCondate
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
            DoEvents
            
            If LBQty = 0 Then LBQty = LSQty
                MCount = MCount + 1:
                LNoTrd = LNoTrd + 1
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND EXCODE = '" & LSExCode & "' AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                Cnn.Execute mysql
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            End If
        End If
End Sub


Sub EXCEL_120(LSCondate As Date, MOPEN As String, Optional lclientid As String, Optional lsparty As String)
Dim LBQty As Double
Dim LSQty As Double
Dim LContime As String
Dim lday As Integer
Dim ltradedt As Date
Dim MSPARTY As String: Dim mbparty As String
Dim MCount As Integer
Dim LSConSno As Long
Dim TRec As ADODB.Recordset
Dim LUserId As String
Dim txteqrec As New ADODB.Recordset
lexceltype = 120

LSExCode = ""
LNoTrd = LNoTrd + 1
LBQty = 0: LSQty = 0
If IsNull(TxtRec!F7) Or IsNull(TxtRec!F2) Then Exit Sub
'If TxtRec!F7 <> "B" And TxtRec!F7 <> "S" Then Exit Sub
'If TxtRec!F4 = "B/F" Or TxtRec!F4 = "C/F" Then Exit Sub
'If Mid(TxtRec!F1, 4, 2) <> "PE" And Mid(TxtRec!F1, 4, 2) <> "CE" Then Exit Sub

LSExCode = "MCX"
If TxtRec!F7 <> "PE" And TxtRec!F7 <> "CE" Then Exit Sub

If TxtRec!F7 = "PE" Or TxtRec!F7 = "CE" Then
    If Trim(TxtRec!F4) <> "CRUDEOIL" Then Exit Sub
    LSInstType = "OPT"
    LSStrike = TxtRec!f6
    LEXHCODE = TxtRec!F4
    LSOptType = TxtRec!F7
    LSMaturity = TxtRec!F5
    LSMaturity = DateValue(LSMaturity)
    LBQty = Abs(Val(TxtRec!f11))
    LBRate = IIf(IsNull(TxtRec!f12), 0, TxtRec!f12)
    LOConNo = TxtRec!F2
    If LSRate = 0 Then
        LSRate = 0.01
    End If
   
ElseIf Mid(TxtRec!F1, 4, 2) = "PE" Or Mid(TxtRec!F1, 4, 2) = "CE" Then
    LSInstType = "OPT"
    If Trim(TxtRec!F4) <> "CRUDEOIL" Then Exit Sub
    
    A = InStr(TxtRec!F1, "2022")
    If A = 0 Then
        A = InStr(TxtRec!F1, "2023")
    End If
    LEXHCODE = TxtRec!F4
    LSStrike = Mid(TxtRec!F1, A + 5, Len(TxtRec!F1) - A - 4)
    LSOptType = Mid(TxtRec!F1, 4, 2)
    LSTRCONDATE = Mid(TxtRec!F1, A - 5, 9)
    LSMaturity = Left(LSTRCONDATE, 2) + "/" + Mid(LSTRCONDATE, 3, 3) + "/" + Right(LSTRCONDATE, 4)
    LSMaturity = DateValue(LSMaturity)
    LSCondate = DateValue(Left(TxtRec!f6, 10))
    LSPtyContype = Left(TxtRec!F7, 1)
    LBQty = TxtRec!F8
    LBRate = IIf(IsNull(TxtRec!F9), 0, TxtRec!F9)
    If IsNumeric(TxtRec!F5) Then
        LOConNo = TxtRec!F5
    Else
        LOConNo = Val(Mid(TxtRec!F5, 3, 8))
    End If
    If LSRate = 0 Then
        LSRate = 0.01
    End If
Else
    LSInstType = "FUT"
    LSTRCONDATE = TxtRec!F1
    LSMaturity = TxtRec!F5
    LSMaturity = DateValue(LSMaturity)
    
    LSCondate = DateValue(LSTRCONDATE)
    LBQty = Abs(Val(TxtRec!F10))
    LBRate = IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)
    LOConNo = TxtRec!F2

    If LSRate = 0 Then
        LSRate = 0.01
    End If
End If
If Val(TxtRec!f11) > 0 Then
    LSPtyContype = "B"
Else
    LSPtyContype = "S"
End If
lbparty = lclientid
If IsNull(TxtRec!F9) Then
    LContime = ""
Else
    LContime = TxtRec!F9
End If
    


MSPARTY = lsparty
LSRate = LBRate
LMonthType = "M"

Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
If LenB(LSItemCode) < 1 Then Exit Sub

''''

Set TRec = Nothing
Set TRec = New ADODB.Recordset
mysql = "select lot from itemmast where compcode= '" & GCompCode & "'  and (itemcode = '" & LEXHCODE & "' OR ITALIAS_1 = '" & LEXHCODE & "') "
TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
If Not TRec.EOF Then
    LBQty = IIf(IsNull(LBQty), 0, LBQty / TRec!lot)
End If


Set TRec = Nothing
Set TRec = New ADODB.Recordset
mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
If Not TRec.EOF And LSInstType <> "OPT" Then
    LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
Else
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
    If LSInstType <> "FUT" Then
        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE = '" & LSInstType & "' "
        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
    Else
        mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
    End If
    
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        LSMaturity = TRec!MATURITY
        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
    Else
        If LSInstType = "FUT" Then
            LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                LSSaudaCode = LSExCode & " " & LSSaudaCode
                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                    LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                    ImportIssues (LMsgBox)
                    Exit Sub
                End If
            End If
        Else
            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
            ImportIssues (LMsgBox)
            Exit Sub
        End If
        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
    End If
End If
LSSaudaID = Get_SaudaID(LSSaudaCode)

If LenB(LSSaudaCode) < 1 Then Exit Sub
If LSCondate > LSMaturity Then
    LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
    ImportIssues (LMsgBox)
End If
LSEXID = Get_ExID(LSExCode)

If LBQty <> 0 Or LSQty <> 0 Then
    mbparty = Get_ACCT_EX(LSEXID, lbparty)
    If LenB(mbparty) < 1 Then
        mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
    End If
    lsparty = LBrokerCode
    MSPARTY = lsparty
    
    lbparty = mbparty
    If LenB(mbparty) < 1 Then
        LMsgBox = " Client does Not Exist " & lbparty & ""
        ImportIssues (LMsgBox)
        Exit Sub
    End If

    If InStr(LBillExId, str(LSEXID)) = 0 Then
        If LenB(LBillExId) > 0 Then
            LBillExId = LBillExId & ","
            LBillExId = LBillExId & str(LSEXID)
        End If
        If lminbilldate > LSCondate Then lminbilldate = LSCondate
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
            DoEvents
            
            If LBQty = 0 Then LBQty = LSQty
                MCount = MCount + 1:

                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            End If
        End If
End Sub
Sub SAUDA_STD(LSCondate As Date, MOPEN As String, lclientid As String, LPartyName As String)
Dim LBQty As Double
Dim LSQty As Double
Dim LContime As String
Dim lday As Integer
Dim ltradedt As Date
Dim MSPARTY As String: Dim mbparty As String
Dim MCount As Integer
Dim LSConSno As Long
Dim TRec As ADODB.Recordset
Dim LUserId As String
Dim txteqrec As New ADODB.Recordset

LSExCode = ""
LNoTrd = LNoTrd + 1
LBQty = 0: LSQty = 0
If IsNull(TxtRec!F7) And IsNull(TxtRec!F8) Then Exit Sub
If TxtRec!F7 = "Buy" Then Exit Sub
If Not IsNumeric(TxtRec!F7) And Not IsNumeric(TxtRec!F8) Then Exit Sub

MSPARTY = lsparty

If IsNull(TxtRec!F7) Then
    LBQty = TxtRec!F8
    LBRate = TxtRec!F9
    LSPtyContype = "S"
Else
    LBQty = TxtRec!F7
    LBRate = TxtRec!F9
    LSPtyContype = "B"
End If
LSTR = Trim(Right(TxtRec!F1, 7))
LEXHCODE = Trim(Left(TxtRec!F1, Len(TxtRec!F1) - 7))
lday = Left(LSTR, Len(LSTR) - 5)
LMONTH = Left(Right(LSTR, 5), 3)
lyear = "20" + Right(LSTR, 2)
LSTR = lday & "/" & LMONTH & "/" & lyear
LSMaturity = DateValue(LSTR)

lbparty = lclientid
LSExCode = ""
LSInstType = "FUT"

LContime = ""
LOrdNo = ""
LSRate = LBRate
LMonthType = "M"

'Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)


Set TRec = Nothing
Set TRec = New ADODB.Recordset
mysql = "select ITEMID,EXHCODE,EXCHANGECODE,ITEMCODE,EXHCODE from itemmast where compcode= '" & GCompCode & "'  and (itemcode = '" & LEXHCODE & "' OR EXHCODE = '" & LEXHCODE & "') "
TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
If Not TRec.EOF Then
    LSItemCode = TRec!ITEMCODE
    LSExCode = TRec!EXCHANGECODE
    LSEx_Symbol = TRec!EXHCODE
    LSItemid = TRec!itemid
Else
    LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & ""
    ImportIssues (LMsgBox)
    Exit Sub
End If

If LenB(LSItemCode) < 1 Then Exit Sub

Set TRec = Nothing
Set TRec = New ADODB.Recordset
mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
If Not TRec.EOF And LSInstType <> "OPT" Then
    LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
Else
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
    If LSInstType <> "FUT" Then
        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE = '" & LSInstType & "' "
        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
    Else
        mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
    End If
    
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        LSMaturity = TRec!MATURITY
        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
    Else
        If LSInstType = "FUT" Then
            LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                LSSaudaCode = LSExCode & " " & LSSaudaCode
                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                    LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                    ImportIssues (LMsgBox)
                    Exit Sub
                End If
            End If
        Else
            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
            ImportIssues (LMsgBox)
            Exit Sub
        End If
        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
    End If
End If
LSSaudaID = Get_SaudaID(LSSaudaCode)

If LenB(LSSaudaCode) < 1 Then Exit Sub
If LSCondate > LSMaturity Then
    LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
    ImportIssues (LMsgBox)
End If
LSEXID = Get_ExID(LSExCode)

If LBQty <> 0 Or LSQty <> 0 Then
    mbparty = Get_ACCT_EX(LSEXID, lbparty)
    If LenB(mbparty) < 1 Then
        mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
    End If
    lsparty = LBrokerCode
    MSPARTY = lsparty
    
    lbparty = mbparty
    If LenB(mbparty) < 1 Then
        LMsgBox = " Client does Not Exist " & lbparty & ""
        ImportIssues (LMsgBox)
        Exit Sub
    End If

    If InStr(LBillExId, str(LSEXID)) = 0 Then
        If LenB(LBillExId) > 0 Then
            LBillExId = LBillExId & ","
            LBillExId = LBillExId & str(LSEXID)
        End If
        If lminbilldate > LSCondate Then lminbilldate = LSCondate
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
            DoEvents
            
            If LBQty = 0 Then LBQty = LSQty
                MCount = Get_Max_ConNo(LSCondate, 0)
                MCount = MCount + 1:
                LOConNo = MCount
                
                'mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND EXCODE = '" & LSExCode & "' AND CONDATE= '" & Format(LSCondate, "YYYY/MM/DD") & "' AND ROWNO1 ='" & LOConNo & "'"
                'Cnn.Execute mysql
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            End If
        End If
End Sub




Sub EXCEL_122(LSCondate As Date, MOPEN As String, Optional lclientid As String, Optional lsparty As String)
Dim LBQty As Double
Dim LSQty As Double
Dim LContime As String
Dim lday As String
Dim LSTR As String
Dim ltradedt As Date
Dim MSPARTY As String: Dim mbparty As String
Dim LPartyName As String
Dim MCount As Integer
Dim LSConSno As Long
Dim TRec As ADODB.Recordset
Dim LUserId As String
Dim txteqrec As New ADODB.Recordset
Dim lyear As String
LSExCode = ""
LNoTrd = LNoTrd + 1
LBQty = 0: LSQty = 0
If IsNull(TxtRec!F2) Then Exit Sub
If Left(TxtRec!F4, 1) <> "B" And Left(TxtRec!F4, 1) <> "S" Then Exit Sub
If TxtRec!F4 = "B/F" Or TxtRec!F4 = "C/F" Then Exit Sub

lexceltype = "122"
LSExCode = "MCX"

lclientid = Replace(TxtRec!F2, "'", "")
LSExCode = Left(TxtRec!f3, 3)
If LSExCode = "SGX" Then
    LSExCode = "NSE"
End If
If Left(TxtRec!f3, 4) = "MINI" Then
    LSExCode = "MCX"
End If
If Left(TxtRec!f3, 6) = "OTHERS" Then
    LSExCode = "NSE"
End If


LSTR = Mid(TxtRec!f3, 5, Len(TxtRec!f3) - 3)
If Left(TxtRec!f3, 6) = "OTHERS" Then
    LEXHCODE = Trim(Mid(TxtRec!f3, 8, Len(TxtRec!f3) - 7))
    LEXHCODE = Left(LEXHCODE, Len(LEXHCODE) - 7)
Else
    LEXHCODE = Trim(Mid(LSTR, 1, Len(LSTR) - 7))
End If
LMONTH = Left(Right(LSTR, 6), 3)
lday = Right(LSTR, 2)
LSPtyContype = Left(TxtRec!F4, 1)
LSInstType = "FUT"
lbparty = lclientid
LPartyName = lbparty & " " & lbparty
LBQty = TxtRec!F5
LBRate = IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)
LContime = Right(Replace(TxtRec!F1, "'", ""), 5)
lyear = Trim(str(Year(LSCondate)))
If InStr(UCase(LMONTH), "JAN") <> 0 Or InStr(UCase(LMONTH), "FEB") <> 0 Or InStr(UCase(LMONTH), "MAR") <> 0 Then
    If month(LSCondate) > Val(LMONTH) Then
        lyear = lyear + 1
    End If
End If
LSTRCONDATE = lday + "/" + LMONTH + "/" + lyear
LSMaturity = DateValue(lday + "/" + LMONTH + "/" + lyear)
LMONTH = month(LSMaturity)

LSMaturity = DateValue(lday + "/" + LMONTH + "/" + lyear)
LSTRCONDATE = Left$(Replace(TxtRec!F1, "'", ""), 10)
LSCondate = DateValue(LSTRCONDATE)
MSPARTY = lsparty

LSRate = LBRate
LMonthType = "M"

Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
If LenB(LSItemCode) < 1 Then Exit Sub

Set TRec = Nothing
Set TRec = New ADODB.Recordset
mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
If Not TRec.EOF And LSInstType <> "OPT" Then
    LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
Else
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
    If LSInstType <> "FUT" Then
        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE = '" & LSInstType & "' "
        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
    Else
        mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
    End If
    
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        LSMaturity = TRec!MATURITY
        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
    Else
        If LSInstType = "FUT" Then
            LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                LSSaudaCode = LSExCode & " " & LSSaudaCode
                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                    LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                    ImportIssues (LMsgBox)
                    Exit Sub
                End If
            End If
        Else
            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
            ImportIssues (LMsgBox)
            Exit Sub
        End If
        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
    End If
End If
LSSaudaID = Get_SaudaID(LSSaudaCode)

If LenB(LSSaudaCode) < 1 Then Exit Sub
If LSCondate > LSMaturity Then
    LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
    ImportIssues (LMsgBox)
End If
LSEXID = Get_ExID(LSExCode)

If LBQty <> 0 Or LSQty <> 0 Then
    mbparty = Get_ACCT_EX(LSEXID, lbparty)
    If LenB(mbparty) < 1 Then
        mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
    End If
    lsparty = LBrokerCode
    MSPARTY = lsparty
    
    lbparty = mbparty
    If LenB(mbparty) < 1 Then
        LMsgBox = " Client does Not Exist " & lbparty & ""
        ImportIssues (LMsgBox)
        Exit Sub
    End If

    If InStr(LBillExId, str(LSEXID)) = 0 Then
        If LenB(LBillExId) > 0 Then
            LBillExId = LBillExId & ","
            LBillExId = LBillExId & str(LSEXID)
        End If
        If lminbilldate > LSCondate Then lminbilldate = LSCondate
            GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
            DoEvents
            
            If LBQty = 0 Then LBQty = LSQty
                MCount = MCount + 1:
                LOConNo = Get_Max_ConNo(LSCondate, 0)
                LOConNo = LOConNo + 1
                LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                Call Add_To_Ctr_D2(LSPtyContype, lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            End If
        End If
End Sub



Sub EXCEL_123(LSCondate As Date, MOPEN As String, Optional lclientid As String, Optional lsparty As String, Optional lexceltype As Integer)
Dim LBQty As Double
Dim LSQty As Double
Dim LContime As String
Dim lday As Integer
Dim LSTR As String
Dim ltradedt As Date
Dim MSPARTY As String: Dim mbparty As String
Dim LPartyName As String
Dim MCount As Integer
Dim LSConSno As Long
Dim TRec As ADODB.Recordset
Dim LUserId As String
Dim txteqrec As New ADODB.Recordset
Dim lyear As String
Dim LSCONDATE2 As Date
Dim LCONTIME2 As String
LSExCode = ""
LNoTrd = LNoTrd + 1
LBQty = 0: LSQty = 0
If lexceltype = 125 Then
    LSExCode = "NSE"
    LSInstType = "OPT"
    LSTRCONDATE = Left$(TxtRec!F1, 10)
    LSCondate = DateValue(LSTRCONDATE)
    A = InStr(TxtRec!f6, "O")
    If A = 0 Then Exit Sub
    LEXHCODE = Left(TxtRec!f6, A - 1)
    LSMaturity = DateValue(TxtRec!F10)
    LSStrike = TxtRec!F8
    If Left(TxtRec!F9, 1) = "C" Then
        LSOptType = "CE"
    Else
        LSOptType = "PE"
    End If
    LSPtyContype = TxtRec!f11
    LBQty = Abs(TxtRec!F20)
    LBRate = TxtRec!F21
    LOConNo = TxtRec!f16
    LContime = TxtRec!F17
    LSQty = LBQty
    LSRate = LBRate
    lbparty = TxtRec!F18
    LPartyName = lbparty & " " & lbparty
Else
    If IsNull(TxtRec!F7) Or IsNull(TxtRec!F2) Then Exit Sub

    If IsDate(TxtRec!F1) Then
    
        If Left(TxtRec!f6, 1) <> "B" And Left(TxtRec!f6, 1) <> "S" Then Exit Sub
        LSTRCONDATE = Left$(TxtRec!F1, 10)
        LSTRCONDATE = Mid(TxtRec!F1, 7, 2) + "/" + Mid(TxtRec!F1, 4, 2) + "/" + "20" + Left(TxtRec!F1, 2)
        LSCondate = DateValue(LSTRCONDATE)
        If InStr(TxtRec!F4, "JAN") <> 0 Then
            A = InStr(TxtRec!F4, "JAN")
            LMONTH = "JAN"
        ElseIf InStr(TxtRec!F4, "FEB") <> 0 Then
            A = InStr(TxtRec!F4, "FEB")
            LMONTH = "FEB"
        ElseIf InStr(TxtRec!F4, "MAR") <> 0 Then
            A = InStr(TxtRec!F4, "MAR")
            LMONTH = "MAR"
        ElseIf InStr(TxtRec!F4, "APR") <> 0 Then
            A = InStr(TxtRec!F4, "APR")
            LMONTH = "APR"
        ElseIf InStr(TxtRec!F4, "MAY") <> 0 Then
            A = InStr(TxtRec!F4, "MAY")
            LMONTH = "MAY"
        ElseIf InStr(TxtRec!F4, "JUN") <> 0 Then
            A = InStr(TxtRec!F4, "JUN")
            LMONTH = "JUN"
        ElseIf InStr(TxtRec!F4, "JUL") <> 0 Then
            A = InStr(TxtRec!F4, "JUL")
            LMONTH = "JUL"
        ElseIf InStr(TxtRec!F4, "AUG") <> 0 Then
            A = InStr(TxtRec!F4, "AUG")
            LMONTH = "AUG"
        ElseIf InStr(TxtRec!F4, "SEP") <> 0 Then
            A = InStr(TxtRec!F4, "SEP")
            LMONTH = "SEP"
        ElseIf InStr(TxtRec!F4, "OCT") <> 0 Then
            A = InStr(TxtRec!F4, "OCT")
            LMONTH = "OCT"
        ElseIf InStr(TxtRec!F4, "NOV") <> 0 Then
            A = InStr(TxtRec!F4, "NOV")
            LMONTH = "NOV"
        ElseIf InStr(TxtRec!F4, "DEC") <> 0 Then
            A = InStr(TxtRec!F4, "DEC")
            LMONTH = "DEC"
        End If
        LEXHCODE = Mid(TxtRec!F4, 1, A - 1)
        LSPtyContype = Left(TxtRec!f6, 1)
        If LSPtyContype = "S" Then
            LSQty = TxtRec!F5
            LSRate = TxtRec!F8
            LBQty = LSQty
            LBRate = TxtRec!F9
        Else
            LBQty = TxtRec!F5
            LBRate = TxtRec!F8
            LSQty = LSQty
            LSRate = TxtRec!F9
        End If
        LContime = Right(TxtRec!F1, 8)
        LSTRCONDATE = Mid(TxtRec!F7, 7, 2) + "/" + Mid(TxtRec!F7, 4, 2) + "/" + "20" + Left(TxtRec!F7, 2)
        LSCONDATE2 = DateValue(LSTRCONDATE)
        LCONTIME2 = Right(TxtRec!F7, 8)
        LOConNo = TxtRec!f3
        lyear = Trim(str(Year(LSCondate)))
        lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
        LSMaturity = DateValue(str(lday) & "/" & LMONTH & "/" & lyear)
    Else
        LEXHCODE = Mid(TxtRec!F4, 1, A - 1)
    End If
    lbparty = lclientid
    LPartyName = lbparty & " " & lbparty
    lexceltype = "123"
    LSExCode = "MCX"
    LSInstType = "FUT"
    MSPARTY = lsparty
    LMonthType = "M"
End If
Call Get_Item_Details(LEXHCODE, LEXHCODE, LEXHCODE, LSExCode, 1, False, True, 1)
If LenB(LSItemCode) < 1 Then Exit Sub

Set TRec = Nothing
Set TRec = New ADODB.Recordset
mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
If Not TRec.EOF And LSInstType <> "OPT" Then
    LSSaudaCode = TRec!saudacode: LSMaturity = TRec!MATURITY: LSSaudaID = TRec!SAUDAID
Else
    Set TRec = Nothing
    Set TRec = New ADODB.Recordset
    mysql = "SELECT MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LSEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
    If LSInstType <> "FUT" Then
        mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE = '" & LSInstType & "' "
        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
    Else
        mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
    End If
    
    TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
    If Not TRec.EOF Then
        LSMaturity = TRec!MATURITY
        LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
    Else
        If LSInstType = "FUT" Then
            LSSaudaCode = Trim(LSItemCode) & " " & month(LSMaturity) & " " & Year(LSMaturity)
            If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                LSSaudaCode = LSExCode & " " & LSSaudaCode
                If Duplicate_Sauda_Chk(LSSaudaCode) = True Then
                    LMsgBox = "Please Check Entry for " & LSSaudaCode & ""
                    ImportIssues (LMsgBox)
                    Exit Sub
                End If
            End If
        Else
            LMsgBox = "Please Import/Create New Item/Script " & LEXHCODE & " " & LSMaturity & " " & LSOptType & " " & LSStrike & ""
            ImportIssues (LMsgBox)
            Exit Sub
        End If
        Call PInsert_Saudamast(LSSaudaCode, LSSaudaCode, LSItemCode, LSMaturity, 1, 1, 0, LSInstType, LSOptType, LSStrike, LSExCode, 1, LSEXID, LSItemid)
    End If
End If
LSSaudaID = Get_SaudaID(LSSaudaCode)

If LenB(LSSaudaCode) < 1 Then Exit Sub
If LSCondate > LSMaturity Then
    LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
    ImportIssues (LMsgBox)
End If
LSEXID = Get_ExID(LSExCode)

If LBQty <> 0 Or LSQty <> 0 Then
    mbparty = Get_ACCT_EX(LSEXID, lbparty)
    If LenB(mbparty) < 1 Then
        mbparty = NewParty(LSExCode, lbparty, LPartyName, lbparty, True)
    End If
    lsparty = LBrokerCode
    MSPARTY = lsparty
    
    lbparty = mbparty
    If LenB(mbparty) < 1 Then
        LMsgBox = " Client does Not Exist " & lbparty & ""
        ImportIssues (LMsgBox)
        Exit Sub
    End If

    If InStr(LBillExId, str(LSEXID)) = 0 Then
        If LenB(LBillExId) > 0 Then
            LBillExId = LBillExId & ","
            LBillExId = LBillExId & str(LSEXID)
        End If
        If lminbilldate > LSCondate Then lminbilldate = LSCondate
        
        GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " "
        DoEvents
        
        MCount = MCount + 1:
        'LOConNo = Get_Max_ConNo(LSCondate, 0)
        'LOConNo = LOConNo + 1
        LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)

        If LSPtyContype = "S" Then
            mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND  ROWNO1='" & LOConNo & "' AND FILETYPE ='" & lexceltype & "' AND CONDATE ='" & Format(LSCondate, "YYYY/MM/DD") & "'"
            Cnn.Execute mysql
            Call Add_To_Ctr_D2("S", lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LSQty, LSRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            If lexceltype = 123 Then
                LOConNo = Right(LOConNo, Len(LOConNo) - 1)
                mysql = "DELETE FROM CTR_D WHERE COMPCODE =" & GCompCode & " AND  ROWNO1='" & LOConNo & "' AND FILETYPE ='" & lexceltype & "' AND CONDATE ='" & Format(LSCONDATE2, "YYYY/MM/DD") & "'"
                Cnn.Execute mysql
                Call Add_To_Ctr_D2("B", lbparty, LSConSno, LSCONDATE2, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LBRate, MSPARTY, LCONTIME2, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            End If
        Else
            Call Add_To_Ctr_D2("B", lbparty, LSConSno, LSCondate, LOConNo, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LBRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            If lexceltype = 123 Then
                Call Add_To_Ctr_D2("S", lbparty, LSConSno, LSCONDATE2, LOConNo, LSSaudaCode, LSItemCode, mbparty, LSQty, LSRate, LSRate, MSPARTY, LCONTIME2, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
            End If
        End If
   End If
End If
End Sub




'FUNC EXCEL_49
 '                   Case 49
  '                      If IsNull(TxtRec!F1) Then GoTo EFlag_Next
   '                     If IsNull(TxtRec!f11) Then GoTo EFlag_Next
    '                    If Not IsNumeric(TxtRec!F10) Then GoTo EFlag_Next
     '                   LOConNo = TxtRec!F1: LOrdNo = (TxtRec!f3 & vbNullString): LSTRCONDATE = Left$(TxtRec!f6, 10)
      '                  LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
       '                 LContime = Right(TxtRec!f6, 8): LSPtyContype = UCase(Left(TxtRec!f7, 1))
        '                If Right(TxtRec!F10, 1) = "K" Then
         '                   LBQty = Val(Left(TxtRec!F10, Len(TxtRec!F10) - 1)) * 1000
          '              Else
           '                 LBQty = Val(TxtRec!F10)
            '            End If
             '           LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)): LSRate = LBRate: lbparty = (TxtRec!F4 & vbNullString):
              '          If LenB(lbparty) < 1 Then
               '             LMsgBox = "Comment Blant for Trade No " & LOConNo & "": ImportIssues (LMsgBox): GoTo EFlag_Next
                '        End If
                 '       LPartyName = lbparty & " " & (TxtRec!F5 & vbNullString): A = Len(TxtRec!F9)
                  '      LEXHCODE = Trim(Left(TxtRec!F9, Len(TxtRec!F9) - 3)):   LMONTH = Right(TxtRec!F9, 3): lyear = Year(LSCondate)
                   '     LSTRCONDATE = "28" & "/" & LMONTH & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                    '    If month(LSMaturity) < month(LSCondate) Then
                     '       lyear = (Year(LSCondate) + 1): LSTRCONDATE = "28" & "/" & month(LSMaturity) & "/" & lyear: LSMaturity = DateValue(LSTRCONDATE)
                      '  End If
                       ' LMonthType = "M":                        lsparty = LBrokerCode



'FUNC EXCEL_30_32
                 '   Case 30, 32
                 '       LSCondate = DateValue(TxtRec!F1)
                 '       LEXHCODE = Trim(IIf(IsNull(TxtRec!F2), vbNullString, TxtRec!F2))
                 '       LSMaturity = DateValue(TxtRec!f3)
                 '       lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
                 '       LConType = Left(TxtRec!F5, 1)
                 '       LBQty = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6))
                 '       LBRate = Val(IIf(IsNull(TxtRec!f7), 0, TxtRec!f7)):
                 '       LSRate = LBRate
                 '       lsparty = Trim(IIf(IsNull(TxtRec!F8), vbNullString, (TxtRec!F8)))
                 '       If Not IsNull(TxtRec!F10) Then
                 '           If IsNumeric(TxtRec!F10) Then
                 '               If Val(TxtRec!F10) <> 0 Then
                 '                   LSInstType = "OPT": LSOptType = Left$(TxtRec!F9, 2): LSStrike = Val(TxtRec!F10 & vbNullString)
                 '               End If
                 '           End If
                 '       End If
                 '       If LSCondate > DateValue(Date) Then
                 '           LMsgBox = "Pls Check Trade Date " & LSCondate & ""
                 '           ImportIssues (LMsgBox)
                 '           GoTo EFlag_Next
                 '       End If
                 '       If LSCondate > LSMaturity Then
                 '           LMsgBox = "Pls Check Maturity Date " & LEXHCODE & " " & LSMaturity & ""
                 '           ImportIssues (LMsgBox)
                 '           GoTo EFlag_Next
                 '       End If



'FUNC EXCEL_22
              '      ElseIf lexceltype = 22 Then
               ''         LLOT = 1
                 '       mysql = "SELECT ITEMID,EXID,ITEMCODE,EXHCODE,EXCHANGECODE,LOT FROM ITEMMAST WHERE COMPCODE =" & GCompCode & " AND (ITEMCODE ='" & LEXHCODE & "' OR ITALIAS_1='" & LEXHCODE & "' OR ITALIAS_2='" & LEXHCODE & "' OR ITALIAS_3='" & LEXHCODE & "' OR ITALIAS_4='" & LEXHCODE & "' OR ITALIAS_5='" & LEXHCODE & "') AND EXCHANGECODE='" & LSExCode & "' "
                  '      Set TRec = Nothing: Set TRec = New ADODB.Recordset
                   '     TRec.Open mysql, Cnn, adOpenForwardOnly, adLockReadOnly
                    '    If TRec.EOF Then
                     '       MsgBox "Please Create New Commodity  " & LEXHCODE & ""
                      '      Cnn.RollbackTrans
'                            CNNERR = False
 '                           Exit Sub
  '                      Else
   '                         LSExCode = TRec!EXCHANGECODE
    '                        LSItemCode = TRec!ITEMCODE
     '                       LEx_Symbol = TRec!EXHCODE
      '                      LSEXID = TRec!EXID
       '                     LSItemid = TRec!itemid
        '                    LLOT = TRec!lot
         '               End If
          '              Set TRec = Nothing
           '             Set TRec = New ADODB.Recordset
            '            mysql = "EXEC GET_SAUDAREC " & GCompCode & "," & LSItemid & ",''," & month(LSMaturity) & "," & Year(LSMaturity) & ",'" & LSInstType & "','" & LSOptType & "'," & LSStrike & ""
             '           TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
              '          If Not TRec.EOF Then
               '             LSSaudaCode = TRec!saudacode
                '            LSMaturity = TRec!MATURITY
                 '           LSSaudaID = TRec!SAUDAID
                  '      Else
                   '         Set TRec = Nothing
                    '        Set TRec = New ADODB.Recordset
                     '       mysql = "SELECT SAUDACODE,MATURITY FROM SCRIPTMASTER WHERE EX_SYMBOL ='" & LEx_Symbol & "' AND EXCODE='" & LSExCode & "'"
                      '      If LSInstType <> "FUT" Then
                       '         mysql = mysql & " AND MATURITY='" & Format(LSMaturity, "YYYY/MM/DD") & "' AND INSTTYPE ='OPT' "
                        '        mysql = mysql & " AND OPTTYPE='" & LSOptType & "' AND STRIKEPRICE =" & LSStrike & ""
                         '   Else
                          '      mysql = mysql & " AND INSTTYPE='FUT' AND MONTH(MATURITY)=" & month(LSMaturity) & "AND YEAR(MATURITY)=" & Year(LSMaturity) & ""
                           ' End If
                            'TRec.Open mysql, Cnn, adOpenStatic, adLockReadOnly
'                            I f Not TRec.EOF Then
 '                               LSSaudaCode = TRec!saudacode
  '                              LSMaturity = TRec!MATURITY
   '                             If LenB(LSItemCode) <> 0 Then LSSaudaCode = Create_SaudaMast(LSItemCode, LSMaturity, LSExCode, LSInstType, LSOptType, LSStrike, LSEXID, LSItemid)
    '                        Else
     '                           MsgBox " Please Import New Contract" & LSItemCode & " " & LSMaturity & ""
      '                          Cnn.RollbackTrans
       '                         Exit Sub
        '                    End If
         '                   LSSaudaID = Get_SaudaID(LSSaudaCode)
          '              End If
           '             If LenB(LSSaudaCode) < 1 Then GoTo EFlag_Next
            '            If LSCondate > LSMaturity Then
             '               LMsgBox = "Pls Check Trade " & LSSaudaCode & " is already expired "
              '              ImportIssues (LMsgBox)
               '             'GoTo EFlag_Next
                '        End If
                 '
                  '      If LBQty <> 0 Then
'                            mbparty = Get_ACCT_EX(LSEXID, lbparty)
 '                           If LenB(mbparty) < 1 Then
  '                              LMsgBox = " Client does Not Exist " & lbparty & ""
   '                             ImportIssues (LMsgBox)
    '                            GoTo EFlag_Next
     '                       End If
      '                      MCount = MCount + 1:
       '                     If InStr(LBillExId, str(LSEXID)) = 0 Then
        '                        If LenB(LBillExId) > 0 Then LBillExId = LBillExId & ","
         '                       LBillExId = LBillExId & str(LSEXID)
          '                  End If
           '                 If lminbilldate > LSCondate Then lminbilldate = LSCondate
            '                LNoTrd = LNoTrd + 1
             '               GETMAIN.Label1.Caption = "Trade No " & LNoTrd & " " & TxtRec!F9
              '              DoEvents
               '             LSConSno = Get_ConSNo(LSCondate, LSSaudaCode, LSItemCode, LSExCode, LSSaudaID, LSItemid, LSEXID)
                '            Call Add_To_Ctr_D2(LPtyContype, lbparty, LSConSno, LSCondate, MCount, LSSaudaCode, LSItemCode, mbparty, LBQty, LBRate, LSRate, MSPARTY, LContime, LOrdNo, LUserId, LOConNo, LSExCode, LLOT, 1, LOrdTime, LSInstType, LSOptType, LSStrike, Trim(str(lexceltype)), "Y", LSEXID, LSItemid, LSSaudaID)
                 '       End If


Sub PARTYBRKSHARE()

Dim TxtPath As String
Dim LFileName As String
Dim txteqrec As New ADODB.Recordset
On Error GoTo err1
Set TxtRec = Nothing: Set TxtRec = New ADODB.Recordset
Call GET_JCnn("\" & "MCX" & "\;")


Set LFileSystemObject = CreateObject("Scripting.FileSystemObject")
If Not LFileSystemObject.FolderExists(App.Path & "\" & LFolderName) Then
    LFileSystemObject.CreateFolder (App.Path & "\" & LFolderName)
End If
Set LFileSystemObject = Nothing
TxtPath = "PARTYBRKSHR.CSV"
LFileName = App.Path & "\MCX\" & TxtPath
If Not FileExist(LFileName) Then
    Set txteqrec = Nothing: Set txteqrec = New ADODB.Recordset
    txteqrec.Open "Select * from " & TxtPath, Jcnn, adOpenStatic, adLockReadOnly, adCmdText
    If txteqrec.EOF() Then
        Exit Sub
    End If
End If
'********************

Cnn.BeginTrans
CNNERR = True:

err1: If err.Number <> 0 Then
    MsgBox err.Description
End If


End Sub



'Function case17()
'Case 17
'If IsNull(TxtRec!F1) Then GoTo EFlag_Next
'If Not IsNumeric(TxtRec!f9) Then GoTo EFlag_Next
'LContime = TxtRec!F13 & vbNullString
''lbparty = (TxtRec!F1 & vbNullString)
'LPartyName = lbparty & (TxtRec!F2 & vbNullString)
'LEXHCODE = (TxtRec!F4 & vbNullString)
'LSMaturity = DateValue(TxtRec!F5)
'LConType = Left(TxtRec!F8, 1)
'LPtyContype = LConType
'LBQty = Val(IIf(IsNull(TxtRec!f9), 0, TxtRec!f9))
'LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)):
'LSRate = LBRate
'lsparty = LBrokerCode
'LOConNo = MCount




Sub EXCEL_139(MCount As Long, lexceltype As Integer, ltradedt As Date, LClientCode As String)
    Dim TRec As ADODB.Recordset
    Dim mysql As String
    Dim LContime As String
    Dim LSTR As String
    Dim LSTR2 As String
    Dim A As Integer
    Dim B As Integer
    Dim C As Integer
    Dim lday As Integer
    Dim LSEXCCODE As String
    Dim mbparty As String
    Dim MSPARTY As String

    LContime = ""
    
    lsparty = LBrokerCode
    MSPARTY = lsparty
    
    LOrdNo = LFolderName
    LSExCode = TxtRec!f3
    If LClientCode = "" Then
        lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
    Else
        lbparty = LClientCode
    End If
    LPartyName = lbparty & " " & lbparty
    If TxtRec!F18 = "Trader" Then
        If LSExCode = "MCX" Then
            LBQty = Val(TxtRec!F7)
        Else
            LBQty = Val(TxtRec!F8)
        End If
        LBRate = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5)):
        LSCondate = DateValue(TxtRec!F14)
        LEXHCODE = Left(TxtRec!F2, Len(TxtRec!F2) - 8)
        LMONTH = Right(Left(TxtRec!F2, Len(TxtRec!F2) - 3), 3)
        'lyear = "20" + Right(Left(TxtRec!f2, Len(TxtRec!f2) - 6), 2)
        lyear = Year(LSCondate)
        lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
        LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
        LSPtyContype = "B"
        LSRate = LBRate
        LOConNo = Get_Max_ConNo(DateValue(LSCondate), 0)
        Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)
    End If
    If LClientCode = "" Then
        lbparty = Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))):
    Else
        lbparty = LClientCode
    End If
    LPartyName = lbparty & " " & lbparty
    If TxtRec!f19 = "Trader" Then
        If LSExCode = "MCX" Then
            LBQty = Val(TxtRec!F7)
        Else
            LBQty = Val(TxtRec!F8)
        End If
        LBRate = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):
        LSCondate = DateValue(TxtRec!F15)
        LEXHCODE = Left(TxtRec!F2, Len(TxtRec!F2) - 8)
        LMONTH = Right(Left(TxtRec!F2, Len(TxtRec!F2) - 3), 3)
        lyear = Year(LSCondate)
        'lyear = "20" + Right(Left(TxtRec!f2, Len(TxtRec!f2) - 6), 2)
        lday = GET_DAYS(LMONTH, lyear, DateValue(LSCondate))
        LSMaturity = DateValue(lday & "/" & LMONTH & "/" & lyear)
        LSPtyContype = "S"
        LSRate = LBRate
        LOConNo = Get_Max_ConNo(DateValue(LSCondate), 0)
        Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)
    End If
    DoEvents
   
End Sub



'FUNCTION 3949
 '                   Case 39, 42
  '                      LSExCode = vbNullString
   '                     If IsNull(TxtRec!F7) Then GoTo EFlag_Next
    '                    If Not (Left(TxtRec!F7, 1) = "b" Or Left(TxtRec!F7, 1) = "s") Then GoTo EFlag_Next
     '                   LOConNo = TxtRec!F1: LOrdNo = (TxtRec!f3 & vbNullString)
      '                  LPartyName = TxtRec!F5: LSTRCONDATE = Left$(TxtRec!f6, 10)
       '                 lbparty = Right(Trim(IIf(IsNull(TxtRec!F4), vbNullString, (TxtRec!F4))), 6):
        '                LSCondate = DateValue(Right(LSTRCONDATE, 2) & "/" & Mid(LSTRCONDATE, 6, 2) & "/" & Left(LSTRCONDATE, 4))
         '               LSPtyContype = UCase(Left(TxtRec!F7, 1)): lyear = Val("20" & Right(TxtRec!f9, 2)):   LSTR = Right(TxtRec!f9, 3)
          '
           '             If lexceltype = 39 Then
            '                LMONTH = Get_CMX_Month(Left(LSTR, 1)): LSMaturity = DateValue(TxtRec!F20): A = InStr(TxtRec!f9, "-")
             '               If A = 0 Then
              '                  A = InStr(TxtRec!f9, "-R")
               '                 If Left(TxtRec!f9, 4) = "GOLD" Then
                '                    LEXHCODE = "GOLD"
                 '               ElseIf Left(TxtRec!f9, 5) = "CRUDE" Then
                  '                  LEXHCODE = "CRUDEOIL"
                   '             ElseIf Left(TxtRec!f9, 6) = "SILVER" Then
                    '                LEXHCODE = "SILVER"
                     '           ElseIf Left(TxtRec!f9, 6) = "NICKEL" Then
                      '              LEXHCODE = "NICKEL"
                       '         ElseIf Left(TxtRec!f9, 2) = "NG" Then
                        '            LEXHCODE = "NATURALGAS"
                         '       Else
                          '          LEXHCODE = Left(TxtRec!f9, A - 1)
                           '     End If
                            'Else
                             '   If Left(TxtRec!f9, 4) = "GOLD" Then
                              '      LEXHCODE = "GOLD"
'                                ElseIf Left(TxtRec!f9, 5) = "CRUDE" Then
 '                                   LEXHCODE = "CRUDEOIL"
  '                              ElseIf Left(TxtRec!f9, 6) = "SILVER" Then
   '                                 LEXHCODE = "SILVER"
    '                            ElseIf Left(TxtRec!f9, 6) = "NICKEL" Then
     '                               LEXHCODE = "NICKEL"
      '                          ElseIf Left(TxtRec!f9, 2) = "NG" Then
       ''                             LEXHCODE = "NATURALGAS"
         '                       Else
          '                          LEXHCODE = Left(TxtRec!f9, (A - 1))
           '                     End If
            '                End If
             '           ElseIf lexceltype = 42 Then
              '              A = InStr(TxtRec!f9, "-")
               '             If A = 0 Then
                '                A = InStr(TxtRec!f9, "/")
                 '               If Left(TxtRec!f9, 6) = "SILVER" Then
                  '                  LEXHCODE = "SILVERM"
                   ''             ElseIf Left(TxtRec!f9, 4) = "GOLD" Then
                     '               LEXHCODE = "GOLDM"
                      '          End If
                       '     Else
                        '        B = InStr(TxtRec!f9, "/")
                         '       If B <> 0 Then
                          '          If Left(TxtRec!f9, 6) = "SILVER" Then
                           '             LEXHCODE = "SILVERM"
                            '        ElseIf Left(TxtRec!f9, 4) = "GOLD" Then
                             '           LEXHCODE = "GOLDM"
                              '      End If
                               ' Else
'                                    LEXHCODE = Left(TxtRec!f9, A - 1)
 '                               End If
  '                          End If
   '                     End If
    '                        If Right(TxtRec!f10, 1) = "K" Then
     '                       LBQty = Val(Left(TxtRec!f10, Len(TxtRec!f10) - 1)) * 1000
      '                  Else
       '                     LBQty = Val(TxtRec!f10)
        '                End If
         '               LBRate = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)):
          '              LSRate = LBRate
           '             lsparty = LExCont




Sub EXCEL_140(MCount As Long, lexceltype As Integer, ltradedt As Date, LClientCode As String)
    Dim TRec As ADODB.Recordset
    Dim mysql As String
    Dim LContime As String
    Dim LSTR As String
    Dim LSTR2 As String
    Dim A As Integer
    Dim B As Integer
    Dim C As Integer
    Dim lday As Integer
    Dim LSEXCCODE As String
    Dim mbparty As String
    Dim MSPARTY As String
    Dim MBal As Double

    LContime = ""
    LSExCode = "NSE"
    If IsNumeric(TxtRec!F2) Then
        A = InStr(TxtRec!F1, "-")
        If A = 0 Then Exit Sub
   
        lbparty = Left(TxtRec!F1, A - 1)
        LPartyName = Mid(TxtRec!F1, A + 1, Len(TxtRec!F1) - A)
        mbparty = NewParty(LSExCode, lbparty, LPartyName & " " & LSExCode, "", True)
   
        MBal = TxtRec!F2
        mysql = "UPDATE ACCOUNTM SET OP_BAL = " & MBal & " WHERE AC_CODE = '" & mbparty & "' "
        Cnn.Execute mysql
    ElseIf IsNumeric(TxtRec!f3) And IsNumeric(TxtRec!F7) Then
        A = InStr(TxtRec!F1, "-")
        If A = 0 Then Exit Sub
        lbparty = Left(TxtRec!F1, A - 1)
        LEXHCODE = TxtRec!F2
        LSMaturity = DateValue("26/10/2023")
    
        LBRate = TxtRec!F7
        LBQty = TxtRec!f3
        If LBQty > 0 Then
            LSPtyContype = "B"
        Else
            LSPtyContype = "S"
        End If
        LBQty = Abs(LBQty)
        lsparty = LBrokerCode
        MSPARTY = lsparty
        LOrdNo = LFolderName
        LSCondate = ltradedt
        LSRate = LBRate
        LOConNo = Get_Max_ConNo(DateValue(LSCondate), 0)
        Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)
    Else
        Exit Sub
    End If
    
    DoEvents
   
End Sub

Sub EXCEL_141(MCount As Long, lexceltype As Integer, ltradedt As Date, LClientCode As String)
    Dim TRec As ADODB.Recordset
    Dim mysql As String
    Dim LContime As String
    Dim LSTR As String
    Dim LSTR2 As String
    Dim A As Integer
    Dim B As Integer
    Dim C As Integer
    Dim lday As Integer
    Dim LSEXCCODE As String
    Dim mbparty As String
    Dim MSPARTY As String

    LContime = ""
    
    lsparty = LBrokerCode
    MSPARTY = lsparty
    
    LOrdNo = LFolderName
    LSExCode = "MCX"
    
    LSCondate = DateValue(TxtRec!F1)
    LSMaturity = DateValue(TxtRec!f3)
    lbparty = Trim(IIf(IsNull(TxtRec!F8), vbNullString, (TxtRec!F8))):
    LPartyName = lbparty & " " & lbparty
    LEXHCODE = Trim(IIf(IsNull(TxtRec!F2), vbNullString, TxtRec!F2))
    If IsNumeric(TxtRec!F5) Then ' Sale Record
        LBRate = Val(IIf(IsNull(TxtRec!F5), 0, TxtRec!F5))
        LBQty = Val(IIf(IsNull(TxtRec!f6), 0, TxtRec!f6)):
        LSPtyContype = "S"
        LSRate = LBRate
        LOConNo = Get_Max_ConNo(DateValue(LSCondate), 0)
        Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)
    End If

    lbparty = Trim(IIf(IsNull(TxtRec!F8), vbNullString, (TxtRec!F8))):
    LPartyName = lbparty & " " & lbparty
    If IsNumeric(TxtRec!F10) Then ' Buy Record
        LBRate = Val(IIf(IsNull(TxtRec!F10), 0, TxtRec!F10))
        LBQty = Val(IIf(IsNull(TxtRec!f11), 0, TxtRec!f11)):
        LSPtyContype = "B"
        LSRate = LBRate
        LOConNo = Get_Max_ConNo(DateValue(LSCondate), 0)
        Call Excel_109_insert(MCount, LContime, lexceltype, lminbilldate)
    End If
    DoEvents
End Sub
